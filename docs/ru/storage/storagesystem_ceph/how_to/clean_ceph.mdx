---
weight: 62
sourceSHA: 6c72abd503ba410aca04462fa2567480d600311e0101ca3f8859b5ca902d02c5
---

# Очистка распределенного хранилища

Если вам необходимо удалить кластер rook-ceph и развернуть новый, следуйте этому документу для последовательной очистки ресурсов, связанных с услугой распределенного хранилища.

## Предостережения

Перед очисткой rook-ceph убедитесь, что все ресурсы PVC и PV, использующие хранилище Ceph, были удалены.

## Процедура

<Steps>
  ### Удаление VolumeSnapshotClasses

  1. Удалите VolumeSnapshotClasses.

     ```
     kubectl delete VolumeSnapshotClass csi-cephfs-snapshotclass csi-rbd-snapshotclass
     ```

  2. Убедитесь, что VolumeSnapshotClasses были очищены.

     ```
     kubectl get VolumeSnapshotClass | grep csi-cephfs-snapshotclass
     kubectl get VolumeSnapshotClass | grep csi-rbd-snapshotclass
     ```

     Когда команды не выдают никаких результатов, это означает, что очистка завершена.

  ### Удаление StorageClasses

  1. Перейдите в **Управление платформой**.

  2. В левой навигационной панели нажмите **Управление хранилищем** > **Storage Classes**.

  3. Нажмите ⋮ > **Удалить** и удалите все StorageClasses, которые используют решения для хранилища Ceph.

  ### Удаление пулов хранения

  Этот шаг должен быть выполнен после завершения предыдущего шага.

  1. Перейдите в **Управление платформой**.

  2. В левой навигационной панели нажмите **Управление хранилищем** > **Распределенное хранилище**.

  3. В области **Пул хранилища** нажмите ⋮ > **Удалить** и удалите все пулы хранения по одному. Когда в области пула хранения отображается **Нет пулов хранения**, это означает, что удаление пулов хранения прошло успешно.

  4. (Некоторые) Если режим кластера **Расширенный**, вам также необходимо выполнить следующую команду на основном узле кластера, чтобы удалить созданные встроенные пулы хранения.

     ```
     kubectl -n rook-ceph delete cephblockpool -l cpaas.io/builtin=true
     ```

     Ответ:

     ```
     cephblockpool.ceph.rook.io "builtin-mgr" удален
     ```

  ### Удаление ceph-cluster

  Этот шаг должен быть выполнен после завершения предыдущего шага.

  1. Обновите ceph-cluster и включите политику очистки.

     ```
     kubectl -n rook-ceph patch cephcluster ceph-cluster --type merge -p '{"spec":{"cleanupPolicy":{"confirmation":"yes-really-destroy-data"}}}'
     ```

  2. Удалите ceph-cluster.

     ```
     kubectl delete cephcluster ceph-cluster -n rook-ceph
     ```

  3. Удалите задания, выполняющие очистку.

     ```
     kubectl delete jobs --all -n rook-ceph
     ```

  4. Убедитесь, что очистка ceph-cluster завершена.

     ```
     kubectl get cephcluster  -n rook-ceph | grep ceph-cluster
     ```

     Когда эта команда не дает никаких результатов, это означает, что очистка завершена.

  ### Удаление rook-operator

  Этот шаг должен быть выполнен после завершения предыдущего шага.

  1. Удалите rook-operator.

     ```
     kubectl -n rook-ceph delete subscriptions.operators.coreos.com rook-operator
     ```

  2. Убедитесь, что очистка rook-operator завершена.

     ```
     kubectl get subscriptions.operators.coreos.com -n rook-ceph | grep rook-operator
     ```

     Когда эта команда не дает никаких результатов, это означает, что очистка завершена.

  3. Убедитесь, что все ConfigMaps были очищены.

     ```
     kubectl get configmap -n rook-ceph
     ```

     Когда эта команда не дает никаких результатов, это означает, что очистка завершена. Если есть результаты, выполните следующую команду для очистки, заменив `<configmap>` на фактическое значение.

     ```
     kubectl -n rook-ceph patch configmap <configmap> --type merge -p '{"metadata":{"finalizers": []}}'
     ```

  4. Убедитесь, что все Secrets были очищены.

     ```
     kubectl get secret -n rook-ceph
     ```

     Когда эта команда не дает никаких результатов, это означает, что очистка завершена. Если есть результаты, выполните следующую команду для очистки, заменив `<secret>` на фактическое значение.

     ```
     kubectl -n rook-ceph patch secrets <secret> --type merge -p '{"metadata":{"finalizers": []}}'
     ```

  5. Убедитесь, что очистка rook-ceph завершена.

     ```
     kubectl get all -n rook-ceph
     ```

     Когда эта команда не дает никаких результатов, это означает, что очистка завершена.

  ### Выполнение скрипта очистки

  После завершения вышеуказанных шагов это означает, что ресурсы, связанные с Kubernetes и Ceph, были очищены. Далее необходимо очистить любые остатки rook-ceph на хосте.

  #### Скрипт очистки

  Содержимое скрипта очистки clean-rook.sh следующее:

  <details>
    <summary>Нажмите, чтобы просмотреть</summary>

    ```shell
    #!/bin/bash

    DISK="$1"

    if [ ! -n "$DISK" ]
    then
       echo "необходимо ввести блок устройства"
       exit
    else
       echo "вы уверены, что хотите очистить устройство: $DISK ? да/нет"
       read ANSWER
       case $ANSWER in
         [Yy]*)
         echo "вы ввели y или Y !"
         ;;
         [Nn]*)
         echo "вы ввели "$ANSWER
         exit
         ;;
       esac
    fi

    echo "очистка /var/lib/rook"
    rm -rf /var/lib/rook


    echo "очистка блокового устройства"

    # Восстановите таблицу разделов и добавьте раздел с помощью fdisk, не удаляйте пустые строки между ними
    echo "g
    n



    w" | sudo fdisk $DISK


    # Сбросьте диск в новое, подходящее состояние (zap-all важен, потому что MBR должен быть очищен)
    # Вам придется выполнить этот шаг для всех дисков.
    sgdisk --zap-all $DISK

    # Очистка HDD с помощью dd
    dd if=/dev/zero of="$DISK" bs=1M count=100 oflag=direct,dsync


    # Очистка таких дисков, как SSD, с помощью blkdiscard вместо dd
    blkdiscard $DISK

    # Эти шаги необходимо выполнять только один раз на каждом узле
    # Если rook устанавливает OSD с помощью ceph-volume, демонтаж оставляет некоторые устройства, которые блокируют диски.
    ls /dev/mapper/ceph-* | xargs -I% -- dmsetup remove %

    # Настройка ceph-volume может оставить директории ceph-<UUID> в /dev (необходимый беспорядок)
    rm -rf /dev/ceph-*
    ```
  </details>

  #### Предостережения

  Скрипт очистки зависит от команды sgdisk, поэтому перед выполнением скрипта очистки убедитесь, что она установлена.

  - Команда установки для Ubuntu: `sudo apt install gdisk`
  - Команда установки для RedHat или CentOS: `sudo yum install gdisk`

  #### Процедура

  <Steps>
    1. Выполните скрипт очистки clean-rook.sh на каждой машине в бизнес-кластере, где развернуто распределенное хранилище.

       ```
       sh clean-rook.sh /dev/[device_name]
       ```

       Пример: `sh clean-rook.sh /dev/vdb`

       При выполнении вас попросят подтвердить, действительно ли хотите очистить устройство. Если вы согласны, введите yes, чтобы начать очистку.

    2. Используйте команду `lsblk -f`, чтобы проверить информацию о разделе. Когда столбец `FSTYPE` в результате этой команды пуст, это означает, что очистка завершена.
  </Steps>
</Steps>
