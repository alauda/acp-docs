---
weight: 62
sourceSHA: 6c72abd503ba410aca04462fa2567480d600311e0101ca3f8859b5ca902d02c5
---

# Очистка распределенного хранилища

Если вам необходимо удалить кластер rook-ceph и развернуть новый, следуйте этому документу, чтобы последовательно очистить ресурсы, связанные с сервисом распределенного хранения.

## Предостережения

Перед очисткой rook-ceph убедитесь, что все ресурсы PVC и PV, использующие хранилище Ceph, были удалены.

## Процедура

<Steps>
  ### Удаление VolumeSnapshotClasses

  1. Удалите VolumeSnapshotClasses.

     ```
     kubectl delete VolumeSnapshotClass csi-cephfs-snapshotclass csi-rbd-snapshotclass
     ```

  2. Убедитесь, что VolumeSnapshotClasses были очищены.

     ```
     kubectl get VolumeSnapshotClass | grep csi-cephfs-snapshotclass
     kubectl get VolumeSnapshotClass | grep csi-rbd-snapshotclass
     ```

     Когда эти команды не дают вывода, это указывает на завершение очистки.

  ### Удаление StorageClasses

  1. Перейдите в **Управление платформой**.

  2. В левой боковой панели нажмите **Управление хранилищем** > **Storage Classes**.

  3. Нажмите ⋮ > **Удалить** и удалите все StorageClasses, которые используют решения для хранения Ceph.

  ### Удаление Storage Pools

  Этот шаг следует выполнять после завершения предыдущего шага.

  1. Перейдите в **Управление платформой**.

  2. В левой боковой панели нажмите **Управление хранилищем** > **Распределенное хранилище**.

  3. В области **Storage Pool** нажмите ⋮ > **Удалить** и удалите все пулы хранения один за другим. Когда область пулов хранения показывает **Нет пулов хранения**, это указывает на успешное удаление пулов хранения.

  4. (По желанию) Если режим кластера **Расширенный**, вам также нужно выполнить следующую команду на узле Master кластера, чтобы удалить созданные встроенные пулы хранения.

     ```
     kubectl -n rook-ceph delete cephblockpool -l cpaas.io/builtin=true
     ```

     Ответ:

     ```
     cephblockpool.ceph.rook.io "builtin-mgr" удален
     ```

  ### Удаление ceph-cluster

  Этот шаг следует выполнять после завершения предыдущего шага.

  1. Обновите ceph-cluster и включите политику очистки.

     ```
     kubectl -n rook-ceph patch cephcluster ceph-cluster --type merge -p '{"spec":{"cleanupPolicy":{"confirmation":"yes-really-destroy-data"}}}'
     ```

  2. Удалите ceph-cluster.

     ```
     kubectl delete cephcluster ceph-cluster -n rook-ceph
     ```

  3. Удалите задания, выполняющие очистку.

     ```
     kubectl delete jobs --all -n rook-ceph
     ```

  4. Убедитесь, что очистка ceph-cluster завершена.

     ```
     kubectl get cephcluster  -n rook-ceph | grep ceph-cluster
     ```

     Когда эта команда ничего не выводит, это указывает на завершение очистки.

  ### Удаление rook-operator

  Этот шаг следует выполнять после завершения предыдущего шага.

  1. Удалите rook-operator.

     ```
     kubectl -n rook-ceph delete subscriptions.operators.coreos.com rook-operator
     ```

  2. Убедитесь, что очистка rook-operator завершена.

     ```
     kubectl get subscriptions.operators.coreos.com -n rook-ceph | grep rook-operator
     ```

     Когда эта команда ничего не выводит, это указывает на завершение очистки.

  3. Убедитесь, что все ConfigMaps были очищены.

     ```
     kubectl get configmap -n rook-ceph
     ```

     Когда эта команда ничего не выводит, это указывает на завершение очистки. Если есть результаты вывода, выполните следующую команду для очистки, заменив `<configmap>` на фактический вывод.

     ```
     kubectl -n rook-ceph patch configmap <configmap> --type merge -p '{"metadata":{"finalizers": []}}'
     ```

  4. Убедитесь, что все Secrets были очищены.

     ```
     kubectl get secret -n rook-ceph
     ```

     Когда эта команда ничего не выводит, это указывает на завершение очистки. Если есть результаты вывода, выполните следующую команду для очистки, заменив `<secret>` на фактический вывод.

     ```
     kubectl -n rook-ceph patch secrets <secret> --type merge -p '{"metadata":{"finalizers": []}}'
     ```

  5. Убедитесь, что очистка rook-ceph завершена.

     ```
     kubectl get all -n rook-ceph
     ```

     Когда эта команда ничего не выводит, это указывает на завершение очистки.

  ### Выполнение скрипта очистки

  После выполнения вышеуказанных шагов это указывает на то, что ресурсы, связанные с Kubernetes и Ceph, были очищены. Далее необходимо очистить любые остатки rook-ceph на хосте.

  #### Скрипт очистки

  Содержимое скрипта очистки clean-rook.sh следующее:

  <details>
    <summary>Нажмите, чтобы просмотреть</summary>

    ```shell
    #!/bin/bash

    DISK="$1"

    if [ ! -n "$DISK" ]
    then
       echo "вы должны ввести блочное устройство"
       exit
    else
       echo "вы уверены, что хотите очистить устройство: $DISK ? да/нет"
       read ANSWER
       case $ANSWER in
         [Yy]*)
         echo "вы ввели y или Y !"
         ;;
         [Nn]*)
         echo "вы ввели "$ANSWER
         exit
         ;;
       esac
    fi

    echo "очистка /var/lib/rook"
    rm -rf /var/lib/rook


    echo "очистка блочного устройства"

    # Восстановите таблицу разделов и добавьте раздел с помощью fdisk, не удаляйте пустые строки между
    echo "g
    n



    w" | sudo fdisk $DISK


    # Сбросьте диск в новое, пригодное состояние (запользуйте zap-all, потому что MBR должен быть чистым)
    # Вам нужно выполнить этот шаг для всех дисков.
    sgdisk --zap-all $DISK

    # Очистите HDD с помощью dd
    dd if=/dev/zero of="$DISK" bs=1M count=100 oflag=direct,dsync


    # Очистите такие диски, как SSD, с помощью blkdiscard вместо dd
    blkdiscard $DISK

    # Эти шаги нужно выполнить только один раз на каждом узле
    # Если rook настраивает OSD с помощью ceph-volume, разборка оставляет некоторые устройства, которые блокируют диски.
    ls /dev/mapper/ceph-* | xargs -I% -- dmsetup remove %

    # ceph-volume setup может оставить директории ceph-<UUID> в /dev (ненужный беспорядок)
    rm -rf /dev/ceph-*
    ```
  </details>

  #### Предостережения

  Скрипт очистки зависит от команды sgdisk, поэтому убедитесь, что она установлена перед выполнением скрипта очистки.

  - Команда установки для Ubuntu: `sudo apt install gdisk`
  - Команда установки для RedHat или CentOS: `sudo yum install gdisk`

  #### Процедура

  <Steps>
    1. Выполните скрипт очистки clean-rook.sh на каждом узле в бизнес-кластере, где развернуто распределенное хранение.

       ```
       sh clean-rook.sh /dev/[device_name]
       ```

       Пример: `sh clean-rook.sh /dev/vdb`

       При выполнении вам будет предложено подтвердить, действительно ли хотите очистить устройство. Если подтвердите, введите yes, чтобы начать очистку.

    2. Используйте команду `lsblk -f`, чтобы проверить информацию о разделе. Когда столбец `FSTYPE` в выводе этой команды пуст, это указывает на завершение очистки.
  </Steps>
</Steps>
