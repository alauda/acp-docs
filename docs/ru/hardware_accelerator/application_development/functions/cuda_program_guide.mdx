---
weight: 10
sourceSHA: 62ac4864acf6be679497bb771c8946999fa6766c22ec33d5ba234f85ccf2c498
---

# Совместимость драйвера и среды выполнения CUDA

## Кратко

Nvidia требует:

1. **Версия драйвера всегда должна быть ≥ Версия среды выполнения**
2. NVIDIA официально гарантирует **1 версию назад совместимости** (например, драйвер CUDA 12.x поддерживает среду выполнения 12.x и 11.x, но 10.x может не поддерживаться полностью)

Решение Hami/Gpu-manager требует:

1. **Версия драйвера всегда должна быть ≥ Версия среды выполнения**
2. NVIDIA официально гарантирует **1 версию назад совместимости** (например, драйвер CUDA 12.x поддерживает среду выполнения 12.x и 11.x, но 10.x может не поддерживаться полностью)
3. базовая версия ≥ Версия среды выполнения
4. Основная версия среды выполнения = Основная версия драйвера = Основная версия базовой

## Иерархическая архитектура и основные концепции

![cuda rt](../../../../en/hardware_accelerator/application_development/assets/cuda-arti.png "Слой среды выполнения драйвера CUDA")

### 1. Слой API среды выполнения CUDA

#### Техническое позиционирование

1. **Функциональная область**: Предоставляет высокоуровневые абстрактные интерфейсы для разработчиков, инкапсулируя основные операции GPU (выделение памяти, управление потоками, запуск ядер и т.д.)
2. **Связывание версий**: Определяется версией инструментария CUDA, используемой во время сборки (например, CUDA 12.0.1)

#### Методы обнаружения версии

```bash
# Обнаружение окружения Python (рекомендуемый приоритетный метод)
pip list | grep cuda
conda list |grep cuda 
# Пример вывода: cu121  # cu121 указывает на окружение CUDA 12.1

# Обнаружение библиотек среды выполнения на уровне системы
find / -name "libcudart*"
# cudart означает среду выполнения CUDA
# Пример вывода:
/usr/local/cuda-12.4/targets/x86_64-linux/lib/libcudart.so.12
/usr/local/cuda-12.4/targets/x86_64-linux/lib/libcudart.so.12.4.127
Указывает на CUDA 12.4
```

Если вы обнаружите несколько версий библиотек, вам следует проверить, какая версия используется вашей программой, например, PATH, LD_LIBRARY_PATH или другие настройки программы.

```bash
env |grep PATH
# Пример вывода:
LIBRARY_PATH=/usr/local/cuda/lib64/stubs
LD_LIBRARY_PATH=/usr/local/nvidia/lib:/usr/local/nvidia/lib64
PATH=/go/bin:/usr/local/go/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
# это означает, что ваша программа CUDA использует первую библиотеку по порядку пути
```

### 2. Слой API драйвера CUDA

#### Техническое позиционирование

1. **Функциональная область**: Низкоуровневый интерфейс, непосредственно взаимодействующий с аппаратным обеспечением GPU, обрабатывающий перевод инструкций и планирование аппаратных ресурсов
2. **Связывание версий**: Определяется версией драйвера NVIDIA, следуя спецификации SemVer

#### Методы обнаружения версии

```bash
nvidia-smi
# Пример вывода:
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 550.144.03             Версия драйвера: 550.144.03     Версия CUDA: 12.4     |
|-----------------------------------------+------------------------+----------------------+
| Имя GPU                 Постоянство-M | Bus-Id          Disp.A | Нестабильная некорр. ECC |
| Вентилятор  Темп   Производительность          Потребление/Макс. |           Использование памяти | Использование GPU  Вычисл. М. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  NVIDIA A30                     Выкл |   00000000:00:0B.0 Выкл |                    0 |
| N/A   31C    P0             28W /  165W |   10195MiB /  24576MiB |      0%      По умолчанию |
|                                         |                        |             Отключено |
+-----------------------------------------+------------------------+----------------------+
```

## Матрица совместимости версий и ограничения

### Физическое развертывание GPU - Основные принципы совместимости

Сначала обратитесь к официальному заявлению NVIDIA, **базовые ограничения**:

1. **Версия драйвера всегда должна быть ≥ Версия среды выполнения**
2. NVIDIA официально гарантирует **1 версию назад совместимости** (например, драйвер CUDA 12.x поддерживает среду выполнения 11.x)
3. Совместимость между двумя основными версиями (например, драйвер 12.x с средой выполнения 10.x) не поддерживается официально и не рекомендуется

При развертывании программы CUDA, пожалуйста, соблюдайте базовые ограничения.

#### Формальные правила

```diff
+ Обязательно: Версия драйвера ≥ Версия среды выполнения
+ Рекомендуется: Основная версия драйвера - Основная версия среды выполнения ≤ 1
- Заблокировано: Версия драйвера < Версия среды выполнения → Может вызвать CUDA_ERROR_UNKNOWN(999)
- Нестабильно: Основная версия драйвера - Основная версия среды выполнения > 1 → Приложение может работать некорректно
```

### Улучшения сценариев виртуализации (HAMI/GPU-Manager)

При использовании решений виртуальных GPU, таких как GPU-Manager или HAMI, **в дополнение к базовым ограничениям**, вы должны соблюдать **дополнительные ограничения**:

#### Требования к версиям

```text
1. Базовая версия виртуальных GPU ≥ Версия среды выполнения
2. Основная версия среды выполнения = Основная версия драйвера = Основная версия базовой
```

**Особое примечание для GPU-Manager**:
Мы реализовали частичную совместимость между 1 основной версией (например, базовая 12.4 поддерживает vLLM 11.8). Однако это требует корректировок для каждого приложения и должно анализироваться индивидуально.

## Лучшие практики развертывания

### Рекомендуемая стратегия

• Применяйте более новые версии CUDA (например, CUDA 12.x) как для драйвера, так и для среды выполнения при планировании нового кластера GPU.

### Альтернативные решения для устаревших систем

#### 1. Физическое планирование GPU или полное распределение карты GPU-Manager

Полное распределение карты обеспечивает родственную совместимость, эквивалентную физическому доступу к GPU.
GPU-Manager может использовать режим полной карты, когда вы устанавливаете tencent.com/vcuda-core на 100, умноженное на положительное целое число, например 100, 200, 300.

```yaml
resources:
  limits:
    tencent.com/vcuda-core: "100"
```

#### 2. Стратегия маркировки узлов

Маркируйте узлы в зависимости от поддерживаемых версий драйвера CUDA:

```yaml
node_labels:
  cuda-major-version: "12"
  cuda-minor-version: "4"
```

это означает, что ваш узел имеет CUDA 12.4.

Настройте аффинность планирования в развертываниях:
вы можете установить основную и минорную версии CUDA в зависимости от потребностей вашей программы в среде выполнения CUDA.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cuda-app
spec:
  template:
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: cuda-major-version
                operator: In
                values: ["12"]
              - key: cuda-minor-version
                operator: Gt
                values: ["2"]
```

#### 3. Обновление версии среды выполнения

Устаревшие среды выполнения CUDA могут иметь уязвимости безопасности (CVE) и не поддерживать новые функции GPU. Приоритизируйте обновления до CUDA 12.x.

NVIDIA рекомендует обновить обе версии.
![upgrade both](../../../../en/hardware_accelerator/application_development/assets/upgradeboth.png "обновить обе")

## Справочник по устранению неполадок

### Общие коды ошибок

| Код ошибки                             | Описание                                           | Рекомендуемое действие                               |
| -------------------------------------- | ----------------------------------------------------- | ------------------------------------------------ |
| CUDA\_ERROR\_INVALID\_IMAGE            | Несовместимость драйвера и среды выполнения                        | Совместите версию драйвера с версией CUDA контейнера |
| CUDA\_ERROR\_ILLEGAL\_ADDRESS          | Нарушение виртуальной памяти (обычно при несоответствии версий) | Проверьте ограничения среды выполнения и базовые           |
| CUDA\_ERROR\_UNSUPPORTED\_PTX\_VERSION | Несоответствие набора инструкций PTX                          | Перекомпилируйте с явным указанием -arch=sm\_xx             |

---
