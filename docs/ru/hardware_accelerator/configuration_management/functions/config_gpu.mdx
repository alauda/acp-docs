---
weight: 10
sourceSHA: d24caf15a573d79d3681b3f2f53f252b95be53e5be79480ff1711b172d08ec88
---

# Настройка аппаратного ускорителя на узлах GPU

С увеличением объема бизнес-данных, особенно в таких сценариях, как искусственный интеллект и анализ данных, вы можете захотеть использовать возможности GPU в вашем самостоятельно построенном бизнес-кластере для ускорения обработки данных. В дополнение к подготовке ресурсов GPU для узлов кластера, необходимо также выполнить настройку GPU.

В данном решении узлы в кластере, которые имеют вычислительные возможности GPU, обозначаются как **GPU узлы**.

**Примечание**: Если не указано иное, шаги операции будут применимы к обоим типам узлов. Для вопросов, связанных с установкой драйверов, обратитесь к [официальной документации по установке NVIDIA](https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html).

## Предварительные условия

Ресурсы GPU были подготовлены на операционном узле, который относится к узлу GPU, упомянутому в этом разделе.

## <span> Установить драйвер GPU </span>

**Уведомление: Если узел GPU использует плагин NVIDIA MPS, убедитесь, что архитектура GPU узла - Volta или новее (Volta/Turing/Ampere/Hopper и т. д.), и драйвер поддерживает версию CUDA 11.5 или новее.**

### Получение адреса загрузки драйвера

1. Войдите на узел GPU и выполните команду `lspci |grep -i NVIDIA`, чтобы проверить модель GPU узла.

   В следующем примере модель GPU - Tesla T4.

   ```
   lspci | grep NVIDIA
   00:08.0 3D controller: NVIDIA Corporation TU104GL [Tesla T4] (rev a1)
   ```

2. Перейдите на [официальный сайт NVIDIA](https://www.nvidia.cn/), чтобы получить ссылку на загрузку драйвера.

   1. Нажмите на **Drivers** в верхней навигационной панели на главной странице.

   2. Заполните необходимые данные для загрузки драйвера в соответствии с моделью узла GPU.

   3. Нажмите на **Search**.

   4. Нажмите на **Download**.

   5. Щелкните правой кнопкой на **Download** > **Copy Link Address**, чтобы скопировать ссылку для загрузки драйвера.

3. Выполните следующие команды на узле GPU, чтобы создать каталог `/home/gpu` и загрузить файл драйвера в этот каталог.

   ```
   # Создать каталог /home/gpu
   mkdir -p /home/gpu
   cd /home/gpu/
   # Загрузить файл драйвера в каталог /home/gpu, пример: wget https://cn.download.nvidia.com/tesla/515.65.01/NVIDIA-Linux-x86_64-515.65.01.run
   wget <Адрес загрузки драйвера>
   # Проверьте, что файл драйвера был загружен успешно, Если возвращается название файла драйвера (например: NVIDIA-Linux-x86_64-515.65.01.run), это указывает, что загрузка прошла успешно
   ls <Название файла драйвера>
   ```

### Установка драйвера

1. Выполните следующую команду на узле GPU, чтобы установить пакеты gcc и kernel-devel, соответствующие текущей операционной системе.

   ```
   sudo yum install dkms gcc  kernel-devel-$(uname -r) -y
   ```

2. Выполните следующие команды, чтобы установить драйвер GPU.

   ```
   chmod a+x /home/gpu/<Название файла драйвера>
   /home/gpu/<Название файла драйвера> --dkms
   ```

3. После установки выполните команду `nvidia-smi`. Если возвращается информация о GPU, аналогичная следующему примеру, это указывает на то, что установка драйвера прошла успешно.

   ```
   # nvidia-smi
   Tue Sep 13 01:31:33 2022     
   +-----------------------------------------------------------------------------+
   | NVIDIA-SMI 515.65.01    Версия драйвера: 515.65.01    Версия CUDA: 11.7     |
   +-------------------------------+-----------------------+---------------------+
   | Имя GPU        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
   | Fan  Temp  Perf  Pwr:Usage/Cap|         Использование Памяти | GPU-Util  Compute M. |
   |                               |                      |               MIG M. |
   |===============================+======================+======================|
   |   0  Tesla T4            Off  | 00000000:00:08.0 Off |                    0 |
   | N/A   55C    P0    28W /  70W |      2MiB / 15360MiB |      5%      Default |
   |                               |                      |                  N/A |
   +-------------------------------+-----------------------+---------------------+
                                                                                   
   +-----------------------------------------------------------------------------+
   | Процессы:                                                                  |
   |  GPU   GI   CI        PID   Тип   Имя процесса                  Использование Памяти |
   |        ID   ID                                                   |
   |=============================================================================|
   |  Нет запущенных процессов                                                 |
   +-----------------------------------------------------------------------------+
   ```

### Установка среды выполнения контейнеров NVIDIA

1. На **Узле GPU** добавьте репозиторий yum NVIDIA.

   ```bash
   distribution=$(. /etc/os-release;echo $ID$VERSION_ID) && curl -s -L https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.repo | sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo
   yum makecache -y
   ```

   Когда появляется сообщение "Metadata cache created.", это указывает на то, что добавление прошло успешно.

2. Установите NVIDIA Container Runtime.

   ```bash
   yum install nvidia-container-toolkit -y
   ```

   Когда появляется сообщение `Complete!`, это означает, что установка прошла успешно.

3. Настройте Runtime по умолчанию.
   Добавьте следующую конфигурацию в файл.

   - Containerd: Измените файл `/etc/containerd/config.toml`.

     ```
     [plugins]
      [plugins."io.containerd.grpc.v1.cri"]
        [plugins."io.containerd.grpc.v1.cri".containerd]
     ...
           default_runtime_name = "nvidia"
     ...
             [plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
     ...
               [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
                 runtime_type = "io.containerd.runc.v2"
                 runtime_engine = ""
                 runtime_root = ""
                 privileged_without_host_devices = false
                 base_runtime_spec = ""
                 [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
                   SystemdCgroup = true
               [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.nvidia]
                 privileged_without_host_devices = false
                 runtime_engine = ""
                 runtime_root = ""
                 runtime_type = "io.containerd.runc.v1"
                 [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.nvidia.options]
                   BinaryName = "/usr/bin/nvidia-container-runtime"
                   SystemdCgroup = true
     ...
     ```

   - Docker: Измените файл `/etc/docker/daemon.json`.
     ```
      {
      ...
          "default-runtime": "nvidia",
          "runtimes": {
          "nvidia": {
              "path": "/usr/bin/nvidia-container-runtime"
              }
          },
      ...
      }
     ```

4. Перезапустите Containerd / Docker.

   - Containerd

     ```
     systemctl restart containerd   #Перезапуск

     crictl info |grep Runtime  #Проверка
     ```

   - Docker

     ```
     systemctl restart docker   #Перезапуск

     docker info |grep Runtime  #Проверка
     ```

## Конфигурация физического GPU

### Развертывание плагина физического GPU на GPU бизнес-кластере

На управляющем интерфейсе кластера GPU выполните следующие действия:

1. В каталоге в левой боковой панели выберите подкатегорию "Cluster Plugins", нажмите для развертывания "ACP GPU Device Plugin" и откройте опцию "pGPU";

2. Вкладка "Nodes", выберите узлы, где необходимо развернуть физический GPU, затем нажмите на "Label and Taint Manager", добавьте "device label" и выберите "pGPU", затем щелкните ОК;

3. На вкладке "Pods" проверьте рабочий статус группы контейнеров, соответствующей nvidia-device-plugin-ds, чтобы убедиться, что все работает на заданных узлах.

## Конфигурация NVIDIA MPS (поддержка драйвера версия cuda должна быть >= 11.5)

### Развертывание плагина NVIDIA MPS на GPU бизнес-кластере

#### На управляющем интерфейсе кластера GPU выполните следующие действия:

1. В каталоге в левой боковой панели выберите подкатегорию "Cluster Plugins", нажмите для развертывания "ACP GPU Device Plugin" и откройте опцию "MPS";

2. Вкладка "Nodes", выберите узлы, где необходимо развернуть физический GPU, затем нажмите на "Label and Taint Manager", добавьте "device label" и выберите "MPS", затем щелкните ОК;

3. На вкладке "Pods" проверьте рабочий статус группы контейнеров, соответствующей nvidia-mps-device-plugin-daemonset, чтобы убедиться, что все работает на заданных узлах.

### Настройка kube-scheduler (kubernetes >= 1.23)

1. На **Контрольном узле бизнес-кластера** проверьте, правильно ли планировщик ссылается на политику планирования.

   ```
   cat /etc/kubernetes/manifests/kube-scheduler.yaml
   ```

   проверьте, есть ли опция –config и значение равно /etc/kubernetes/scheduler-config.yaml, как

   ```yaml
   apiVersion: v1
   kind: Pod
   metadata:
     creationTimestamp: null
     labels:
       component: kube-scheduler
      tier: control-plane
     name: kube-scheduler
     namespace: kube-system
   spec:
     containers:
     - command:
       - kube-scheduler
       - --config=/etc/kubernetes/scheduler-config.yaml
   ```

**Примечание**: Указанные выше параметры и значения являются значениями по умолчанию платформы. Если вы изменили их, пожалуйста, верните к значениям по умолчанию. Исходные пользовательские настройки можно скопировать в файл политики планирования.

2. Проверьте конфигурацию файла политики планирования.

   1. Выполните команду: `kubectl describe service kubernetes -n default |grep Endpoints`.

      ```
      Ожидаемый эффектEndpoints:         192.168.130.240:6443
      ```

   2. Замените содержимое файла `/etc/kubernetes/scheduler-config.yaml` на всех мастер-узлах на следующее содержимое, где `${kube-apiserver}` должен быть заменен на вывод первого шага.

      ```
      apiVersion: kubescheduler.config.k8s.io/v1beta2
      kind: KubeSchedulerConfiguration
      clientConnection:
        kubeconfig: /etc/kubernetes/scheduler.conf
      extenders:
      - enableHTTPS: true
        filterVerb: predicates
        managedResources:
        - ignoredByScheduler: false
          name: nvidia.com/mps-core
        nodeCacheCapable: false
        urlPrefix: https://${kube-apiserver}/api/v1/namespaces/kube-system/services/nvidia-mps-scheduler-plugin/proxy/scheduler
        tlsConfig:
          insecure: false
          certFile: /etc/kubernetes/pki/apiserver-kubelet-client.crt
          keyFile: /etc/kubernetes/pki/apiserver-kubelet-client.key
          caFile: /etc/kubernetes/pki/ca.crt
      ```

      если в schedule-config.yaml уже существуют extenders, тогда добавьте yaml в конец

      ```
      - enableHTTPS: true
        filterVerb: predicates
        managedResources:
        - ignoredByScheduler: false
          name: nvidia.com/mps-core
        nodeCacheCapable: false
        urlPrefix: https://${kube-apiserver}/api/v1/namespaces/kube-system/services/nvidia-mps-scheduler-plugin/proxy/scheduler
        tlsConfig:
          insecure: false
          certFile: /etc/kubernetes/pki/apiserver-kubelet-client.crt
          keyFile: /etc/kubernetes/pki/apiserver-kubelet-client.key
          caFile: /etc/kubernetes/pki/ca.crt
      ```

3. Выполните следующую команду, чтобы получить идентификатор контейнера:

   - Containerd: Выполните `crictl ps |grep kube-scheduler`, вывод будет следующим, где первый столбец - это идентификатор контейнера.

     ```
     1d113ccf1c1a9       03c72176d0f15       2 seconds ago       Running             kube-scheduler              3                   ecd054bbdd465       kube-scheduler-192.168.176.47
     ```

   - Docker: Запустите `docker ps |grep kube-scheduler`, вывод будет следующим, где первый столбец - это идентификатор контейнера.

     ```
     30528a45a118   d8a9fef7349c    "kube-scheduler --au..."   37 minutes ago   Up 37 minutes     k8s_kube-scheduler_kube-scheduler-192.168.130.240_kube-system_3e9f7007b38f4deb6ffd1c7587621009_28
     ```

4. Перезапустите контейнер Containerd/Docker, используя идентификатор контейнера, полученный на предыдущем шаге.

   - Containerd

     ```
     crictl stop <Идентификатор контейнера>
     ```

5. Перезапустите Kubelet.

   ```
   systemctl restart kubelet
   ```

## Конфигурация GPU-менеджера

### Настройка kube-scheduler (kubernetes >= 1.23)

1. На **Контрольном узле бизнес-кластера** проверьте, правильно ли планировщик ссылается на политику планирования.

   ```
   cat /etc/kubernetes/manifests/kube-scheduler.yaml
   ```

   проверьте, есть ли опция –config и значение равно /etc/kubernetes/scheduler-config.yaml, как

   ```yaml
   apiVersion: v1
   kind: Pod
   metadata:
     creationTimestamp: null
     labels:
       component: kube-scheduler
      tier: control-plane
     name: kube-scheduler
     namespace: kube-system
   spec:
     containers:
     - command:
       - kube-scheduler
       - --config=/etc/kubernetes/scheduler-config.yaml
   ```

**Примечание**: Указанные выше параметры и значения являются значениями по умолчанию платформы. Если вы изменили их, пожалуйста, верните к значениям по умолчанию. Исходные пользовательские настройки можно скопировать в файл политики планирования.

2. Проверьте конфигурацию файла политики планирования.

   1. Выполните команду: `kubectl describe service kubernetes -n default |grep Endpoints`.

      ```
      Ожидаемый эффектEndpoints:         192.168.130.240:6443
      ```

   2. Замените содержимое файла `/etc/kubernetes/scheduler-config.yaml` на всех мастер-узлах на следующее содержимое, где `${kube-apiserver}` должен быть заменен на вывод первого шага.

      ```
      apiVersion: kubescheduler.config.k8s.io/v1beta2
      kind: KubeSchedulerConfiguration
      clientConnection:
        kubeconfig: /etc/kubernetes/scheduler.conf
      extenders:
      - enableHTTPS: true
        filterVerb: predicates
        managedResources:
        - ignoredByScheduler: false
          name: tencent.com/vcuda-core
        nodeCacheCapable: false
        urlPrefix: https://${kube-apiserver}/api/v1/namespaces/kube-system/services/gpu-quota-admission/proxy/scheduler
        tlsConfig:
          insecure: false
          certFile: /etc/kubernetes/pki/apiserver-kubelet-client.crt
          keyFile: /etc/kubernetes/pki/apiserver-kubelet-client.key
          caFile: /etc/kubernetes/pki/ca.crt
      ```

3. Выполните следующую команду, чтобы получить идентификатор контейнера:

   - Containerd: Выполните `crictl ps |grep kube-scheduler`, вывод будет следующим, где первый столбец - это идентификатор контейнера.

     ```
     1d113ccf1c1a9       03c72176d0f15       2 seconds ago       Running             kube-scheduler              3                   ecd054bbdd465       kube-scheduler-192.168.176.47
     ```

   - Docker: Запустите `docker ps |grep kube-scheduler`, вывод будет следующим, где первый столбец - это идентификатор контейнера.

     ```
     30528a45a118   d8a9fef7349c    "kube-scheduler --au..."   37 minutes ago   Up 37 minutes     k8s_kube-scheduler_kube-scheduler-192.168.130.240_kube-system_3e9f7007b38f4deb6ffd1c7587621009_28
     ```

4. Перезапустите контейнер Containerd/Docker, используя идентификатор контейнера, полученный на предыдущем шаге.

   - Containerd

     ```
     crictl stop <Идентификатор контейнера>
     ```

5. Перезапустите Kubelet.

   ```
   systemctl restart kubelet
   ```

### Развертывание плагина GPU-менеджера на GPU бизнес-кластере

На управляющем интерфейсе кластера GPU выполните следующие действия:

1. В каталоге в левой боковой панели выберите подкатегорию "Cluster Plugins", нажмите для развертывания "ACP GPU Device Plugin" и откройте опцию "GPU-Manager";

2. Вкладка "Nodes", выберите узлы, где необходимо развернуть физический GPU, затем нажмите на "Label and Taint Manager", добавьте "device label" и выберите "vGPU", затем щелкните ОК;

3. На вкладке "Pods" проверьте рабочий статус группы контейнеров, соответствующей gpu-manager-daemonset, чтобы убедиться, что все работает на заданных узлах.

## Проверка результатов

Метод 1: Проверьте, доступны ли ресурсы GPU на узлах GPU, выполнив следующую команду на контрольном узле бизнес-кластера:

```
kubectl get node  ${nodeName} -o=jsonpath='{.status.allocatable}' 
```

Метод 2: Разверните GPU приложение на платформе, указав необходимое количество ресурсов GPU. После развертывания выполните exec на Pod и выполните следующую команду:

```
# nvidia-smi
Tue Sep 13 01:31:33 2022     
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 515.65.01    Версия драйвера: 515.65.01    Версия CUDA: 11.7     |
+-------------------------------+-----------------------+---------------------+
| Имя GPU        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Использование Памяти | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  Tesla T4            Off  | 00000000:00:08.0 Off |                    0 |
| N/A   55C    P0    28W /  70W |      2MiB / 15360MiB |      5%      Default |
|                               |                      |                  N/A |
+-------------------------------+-----------------------+---------------------+
                                                                                
+-----------------------------------------------------------------------------+
| Процессы:                                                                  |
|  GPU   GI   CI        PID   Тип   Имя процесса                  Использование Памяти |
|        ID   ID                                                   |
|=============================================================================|
|  Нет запущенных процессов                                                 |
+-----------------------------------------------------------------------------+
```

Проверьте, правильно ли извлечена информация о GPU.
