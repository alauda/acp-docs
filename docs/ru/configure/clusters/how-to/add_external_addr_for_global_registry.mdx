---
weight: 20
title: Добавление внешнего адреса для встроенного реестра
sourceSHA: 01d895a6ffb5058edcfdfb3404af14c6e6d70b3f73aeffbb9cf29897db011a54
---

# Добавление внешнего адреса для встроенного реестра

## Обзор

Когда кластер `global` использует реестр `Platform Built-in`, кластеры рабочих нагрузок, как правило, также используют этот реестр для загрузки образов. Реестр не только обслуживает компоненты внутри кластера `global`, но и должен быть доступен для узлов кластера рабочих нагрузок.

В некоторых ситуациях узлы кластера рабочих нагрузок не могут напрямую получить доступ к адресу реестра кластера `global` - например, когда кластер `global` находится в частном дата-центре, а кластеры рабочих нагрузок - в общественных облаках или на периферийных площадках.

Этот руководств объясняет, как настроить внешний доступный адрес для стандартного реестра платформы, чтобы кластеры рабочих нагрузок могли загружать образы.

## Предварительные условия

Прежде чем начать, подготовьте следующее:

- Доменное имя, доступное узлам кластера рабочих нагрузок
- IP-адрес, на который указывает доменное имя
- Действительный SSL-сертификат для доменного имени

<Directive type="warning" title="ПРЕДУПРЕЖДЕНИЕ">
  - Доменное имя должно отличаться от адреса доступа к платформе
  - Убедитесь, что IP-адрес домена может перенаправлять трафик на все узлы контрольной плоскости кластера `global`
</Directive>

## Процедура

### Настройка сертификата и правил маршрутизации для реестра платформы

1. Скопируйте действительный сертификат домена на любой узел контрольной плоскости кластера `global`.

2. Создайте секрет TLS с сертификатом домена:

   ```
   kubectl create secret tls registry-address.tls --cert=<имя_файла_сертификата> --key=<имя_файла_ключа> -n kube-system
   ```

   Пример:

   ```
   kubectl create secret tls registry-address.tls --cert=custom.crt --key=custom.key -n kube-system
   ```

   **Примечание**: После создания сертификата следите за датой его истечения в секрете **registry-address.tls** в пространстве имен **kube-system** кластера `global`. Замените сертификат перед его истечением.

3. Создайте правила ingress на любом узле контрольной плоскости кластера `global`:

   ```
   REGISTRY_DOMAIN_NAME=<www.registry.com> # Замените на ваше доступное доменное имя
   cat << EOF | kubectl create -f -
   apiVersion: networking.k8s.io/v1
   kind: Ingress
   metadata:
     annotations:
       nginx.ingress.kubernetes.io/backend-protocol: HTTPS
     name: registry-address
     namespace: kube-system
     labels:
       service_name: registry
   spec:
     rules:
       - host: $REGISTRY_DOMAIN_NAME
         http:
           paths:
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/_catalog
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/.+/tags/list
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/.+/manifests/[A-Za-z0-9_+.-:]+
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/.+/blobls/[A-Za-z0-9-:]+
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/.+/blobls/uploads/[A-Za-z0-9-:]+
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /auth/token
               pathType: ImplementationSpecific
     tls:
       - secretName: registry-address.tls
         hosts:
           - $REGISTRY_DOMAIN_NAME
   EOF
   ```

   Ответ, похожий на `... создано`, указывает на успешное создание ingress.

4. Проверьте, существует ли ресурс службы реестра:

   ```
   kubectl -n kube-system get svc | grep registry
   ```

   Если служба не существует, создайте её с помощью:

   ```
   cat << EOF | kubectl create -f -
   apiVersion: v1
   kind: Service
   metadata:
     labels:
       name: registry
       service_name: registry
     name: registry
     namespace: kube-system
   spec:
     ports:
       - protocol: TCP
         port: 443
         targetPort: 60080
     selector:
       component: registry
     type: ClusterIP
   EOF
   ```

5. Проверьте конфигурацию, загрузив образ из реестра, используя доменное имя:

   ```
   crictl pull <домен-реестра>/automation/qaimages:helloworld
   ```

   Или

   ```
   docker pull <домен-реестра>/automation/qaimages:helloworld
   ```
