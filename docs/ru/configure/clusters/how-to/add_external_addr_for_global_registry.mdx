---
weight: 20
title: Добавление внешнего адреса для встроенного реестра
sourceSHA: 01d895a6ffb5058edcfdfb3404af14c6e6d70b3f73aeffbb9cf29897db011a54
---

# Добавление внешнего адреса для встроенного реестра

## Обзор

Когда кластер `global` использует реестр `Platform Built-in`, рабочие кластеры, как правило, также используют этот реестр для загрузки образов. Реестр обслуживает не только компоненты внутри кластера `global`, но также должен быть доступен для узлов рабочих кластеров.

В некоторых сценариях узлы рабочих кластеров не могут напрямую получить доступ к адресу реестра кластера `global` — например, когда кластер `global` находится в частном дата-центре, в то время как рабочие кластеры находятся в публичных облаках или крайних средах.

Этот справочник объясняет, как настроить внешний доступный адрес для реестра по умолчанию платформы, чтобы позволить рабочим кластерам загружать образы.

## Предварительные условия

Перед началом работы подготовьте следующее:

- Доменное имя, доступное узлам рабочего кластера
- IP-адрес, на который указывает доменное имя
- Действующий SSL-сертификат для доменного имени

<Directive type="warning" title="ПРЕДУПРЕЖДЕНИЕ">
  - Доменное имя должно отличаться от адреса доступа к платформе
  - Убедитесь, что IP-адрес домена может перенаправлять трафик ко всем узлам управления кластера `global`
</Directive>

## Процедура

### Настройка сертификата и правил маршрутизации для реестра платформы

1. Скопируйте действующий сертификат домена на любой узел управления кластера `global`.

2. Создайте секрет TLS с сертификатом домена:

   ```
   kubectl create secret tls registry-address.tls --cert=<certificate-filename> --key=<key-filename> -n kube-system
   ```

   Пример:

   ```
   kubectl create secret tls registry-address.tls --cert=custom.crt --key=custom.key -n kube-system
   ```

   **Примечание**: После создания сертификата следите за датой истечения срока действия секрета **registry-address.tls** в пространстве имен **kube-system** кластера `global`. Замените сертификат до его истечения.

3. Создайте правила ingress на любом узле управления кластера `global`:

   ```
   REGISTRY_DOMAIN_NAME=<www.registry.com> # Замените на ваше доступное доменное имя
   cat << EOF | kubectl create -f -
   apiVersion: networking.k8s.io/v1
   kind: Ingress
   metadata:
     annotations:
       nginx.ingress.kubernetes.io/backend-protocol: HTTPS
     name: registry-address
     namespace: kube-system
     labels:
       service_name: registry
   spec:
     rules:
       - host: $REGISTRY_DOMAIN_NAME
         http:
           paths:
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/_catalog
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/.+/tags/list
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/.+/manifests/[A-Za-z0-9_+.-:]+
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/.+/blobls/[A-Za-z0-9-:]+
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /v2/.+/blobls/uploads/[A-Za-z0-9-:]+
               pathType: ImplementationSpecific
             - backend:
                 service:
                   name: registry
                   port:
                     number: 443
               path: /auth/token
               pathType: ImplementationSpecific
     tls:
       - secretName: registry-address.tls
         hosts:
           - $REGISTRY_DOMAIN_NAME
   EOF
   ```

   Ответ, похожий на `... создано`, указывает на успешное создание ingress.

4. Проверьте, существует ли ресурс Registry Service:

   ```
   kubectl -n kube-system get svc | grep registry
   ```

   Если сервис не существует, создайте его с помощью:

   ```
   cat << EOF | kubectl create -f -
   apiVersion: v1
   kind: Service
   metadata:
     labels:
       name: registry
       service_name: registry
     name: registry
     namespace: kube-system
   spec:
     ports:
       - protocol: TCP
         port: 443
         targetPort: 60080
     selector:
       component: registry
     type: ClusterIP
   EOF
   ```

5. Протестируйте конфигурацию, загрузив образ из реестра с использованием доменного имени:

   ```
   crictl pull <registry-domain-name>/automation/qaimages:helloworld
   ```

   Или

   ```
   docker pull <registry-domain-name>/automation/qaimages:helloworld
   ```
