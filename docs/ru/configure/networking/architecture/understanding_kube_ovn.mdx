---
weight: 10
sourceSHA: 2a4af49cd3068424248ed6e4ae9736899e9c100de6062e666acfd63f8efd4ab1
---

# Понимание Kube-OVN

Этот документ описывает общую архитектуру Kube-OVN, функциональность каждого компонента и то, как они взаимодействуют друг с другом.

В целом, Kube-OVN служит мостом между Kubernetes и OVN, сочетая проверенные технологии SDN с облачными решениями.
Это означает, что Kube-OVN не только реализует сетевые спецификации в Kubernetes, такие как CNI, Service и NetworkPolicy,
но также приносит множество возможностей домена SDN в облачную среду, таких как логические коммутаторы, логические маршрутизаторы, VPC,
шлюзы, QoS, ACL и зеркалирование трафика.

Kube-OVN также поддерживает хорошую открытость для интеграции с множеством технологических решений, таких как Cilium, Submariner, Prometheus, KubeVirt и др.

Компоненты Kube-OVN можно broadly разделить на три категории.

- Компоненты Upstream OVN/OVS.
- Основной контроллер и агент.
- Инструменты мониторинга, эксплуатации и обслуживания, а также расширенные компоненты.

![](../assets/kube-ovn-architecture.png)

## Компоненты Upstream OVN/OVS

Этот тип компонентов поступает из сообщества OVN/OVS с конкретными модификациями для сценариев использования Kube-OVN.
OVN/OVS сам по себе является зрелой системой SDN для управления виртуальными машинами и контейнерами,
и мы настоятельно рекомендуем пользователям, заинтересованным в реализации Kube-OVN, сначала прочитать [ovn-architecture(7)](https://www.mankier.com/7/ovn-architecture)
для понимания того, что такое OVN и как с ним интегрироваться.
Kube-OVN использует интерфейс северного направления OVN для создания и координации виртуальных сетей и отображения сетевых концепций в Kubernetes.

Все компоненты, связанные с OVN/OVS, были упакованы в образы и готовы к запуску в Kubernetes.

### ovn-central

Развертывание `ovn-central` запускает компоненты контрольной плоскости OVN, включая `ovn-nb`, `ovn-sb` и `ovn-northd`.

- `ovn-nb`: Сохраняет конфигурацию виртуальной сети и предоставляет API для управления виртуальной сетью. `kube-ovn-controller` в основном взаимодействует с `ovn-nb` для настройки виртуальной сети.
- `ovn-sb`: Содержит логическую таблицу потоков, сгенерированную из логической сети `ovn-nb`, а также фактическое состояние физической сети каждого узла.
- `ovn-northd`: переводит виртуальную сеть `ovn-nb` в логическую таблицу потоков в `ovn-sb`.

Несколько экземпляров `ovn-central` будут синхронизировать данные через протокол Raft для обеспечения высокой доступности.

### ovs-ovn

`ovs-ovn` работает как DaemonSet на каждом узле, с `openvswitch`, `ovsdb` и `ovn-controller`, работающими внутри Pod.
Эти компоненты действуют как агенты для `ovn-central`, переводя логические таблицы потоков в реальные сетевые конфигурации.

## Основной контроллер и агент

Эта часть является основным компонентом Kube-OVN, служащим мостом между OVN и Kubernetes, соединяя две системы и переводя сетевые концепции между ними.
Большинство основных функций реализованы в этих компонентах.

### kube-ovn-controller

Этот компонент выполняет перевод всех ресурсов в Kubernetes в ресурсы OVN и действует как контрольная плоскость для всей системы Kube-OVN.
`kube-ovn-controller` отслеживает события всех ресурсов, связанных с сетевой функциональностью, и обновляет логическую сеть
внутри OVN на основе изменений ресурсов. Основные ресурсы, за которыми ведется наблюдение, включают:

Pod, Service, Endpoint, Node, NetworkPolicy, VPC, Subnet, Vlan, ProviderNetwork.

В качестве примера события Pod, `kube-ovn-controller` отслеживает событие создания Pod, выделяет адрес через встроенную функцию IPAM в памяти,
и вызывает `ovn-central` для создания логических портов, статических маршрутов и возможных правил ACL.
Затем `kube-ovn-controller` записывает назначенный адрес и информацию о подсети, такую как CIDR, шлюз, маршрут и т. д., в аннотацию Pod.
Эта аннотация затем считывается `kube-ovn-cni` и используется для настройки локальной сети.

### kube-ovn-cni

Этот компонент работает на каждом узле как DaemonSet, реализует интерфейс CNI и управляет локальным OVS для настройки локальной сети.

Этот DaemonSet копирует двоичный файл `kube-ovn` на каждую машину как инструмент для взаимодействия между `kubelet` и `kube-ovn-cni`.
Этот двоичный файл отправляет соответствующий запрос CNI в `kube-ovn-cni` для дальнейшей обработки.
Двоичный файл будет скопирован в директорию `/opt/cni/bin` по умолчанию.

`kube-ovn-cni` будет настраивать конкретную сеть для выполнения соответствующих операций с трафиком,
и основные задачи включают:

1. Настройка `ovn-controller` и `vswitchd`.
2. Обработка запросов CNI Add/Del:
   1. Создание или удаление пары veth и связывание или отвязывание с портами OVS.
   2. Настройка портов OVS.
   3. Обновление правил iptables/ipset/route на хосте.
3. Динамическое обновление QoS сети.
4. Создание и настройка сетевого интерфейса `ovn0` для подключения контейнерной сети и сети хоста.
5. Настройка сетевого интерфейса хоста для реализации Vlan/Underlay/EIP.
6. Динамическая настройка шлюзов между кластерами.

## Инструменты мониторинга, эксплуатации и обслуживания и расширенные компоненты

Эти компоненты предоставляют инструменты мониторинга, диагностики, эксплуатации и внешние интерфейсы для расширения основных сетевых возможностей Kube-OVN
и упрощения повседневных операций и обслуживания.

### kube-ovn-speaker

Этот компонент является DaemonSet, работающим на определенных помеченных узлах, который публикует маршруты во внешнюю сеть,
позволяя внешнему доступу к контейнеру напрямую через IP Pod.

### kube-ovn-pinger

Этот компонент является DaemonSet, работающим на каждом узле для сбора информации о состоянии OVS, качестве сети узла, задержке сети и т. д.

### kube-ovn-monitor

Этот компонент собирает информацию о состоянии OVN и метрики мониторинга.

### kubectl-ko

Этот компонент является плагином kubectl, который может быстро выполнять общие операции.
