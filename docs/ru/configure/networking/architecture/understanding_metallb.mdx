---
weight: 20
sourceSHA: 15046bf85cea7adde0bc1029081b5d916d7e4a985242c000ec28d440c158acf5
---

# Понимание MetalLB

## Терминология

| Термин            | Описание                                                                                                                                                                                                                                                                                                                                                     |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **VIP**           | Виртуальный IP-адрес (VIP) — это IP-адрес, назначаемый MetalLB для внутренней маршрутизации типа LoadBalancer, обеспечивающий единый точку доступа для внешнего трафика к сервисам внутри кластера.                                                                                                                                                       |
| **ARP**           | Протокол разрешения адресов (ARP) используется для сопоставления IP-адресов сетевого уровня с MAC-адресами канального уровня.                                                                                                                                                                                                                                           |
| **GARP**          | Безвозмездный ARP (GARP) — это специальный запрос ARP, используемый для информирования других узлов в сети о связывании IP-адреса с MAC-адресом. В отличие от обычных запросов ARP, GARP не ждет ответов, а активно отправляет информацию по сети.                                                                                                   |
| **ARP Responder** | Компонент MetalLB, отвечающий на запросы ARP, сопоставляя VIP с MAC-адресом узла. Когда узел должен взаимодействовать с VIP, он отправляет запросы ARP для получения MAC-адреса, соответствующего VIP. Каждый доступный узел имеет ARP Responder, который отвечает на эти запросы, сопоставляя VIP с MAC-адресом узла. |
| **Controller**    | Компонент MetalLB, который динамически выделяет VIP из внешнего пула адресов для внутренней маршрутизации типа LoadBalancer. Контроллер отслеживает события создания и удаления внутренних маршрутов в кластере, чтобы выделять или освобождать VIP по мере необходимости.                                                                                                   |
| **Speaker**       | Компонент MetalLB, который определяет, на основе политик или алгоритмов, должны ли узлы размещать VIP и отправлять GARP. Он обеспечивает определенный уровень баланса между узлами, и когда узел становится недоступным, другие узлы могут взять на себя VIP и отправить GARP, тем самым достигая высокой доступности.                                                           |

## Принципы высокой доступности в MetalLB

![](../assets/metallbfix.png)

По умолчанию платформа использует режим ARP MetalLB, а конкретный процесс реализации и принципы следующие:

- Компонент Controller MetalLB выбирает IP-адрес из внешнего пула адресов и выделяет его для внутренней маршрутизации типа LoadBalancer в качестве VIP.

- MetalLB выбирает доступный узел в качестве лидера для размещения VIP на основе [алгоритма](#vip), который затем перенаправляет трафик.

- Компонент Speaker на этом узле активно отправляет GARP, устанавливая сопоставление между VIP и MAC-адресом на всех узлах.

  - Узлы в одной подсети, узнав о сопоставлении между VIP и MAC-адресом доступного узла, будут напрямую взаимодействовать с этим узлом при доступе к VIP.

  - Узлы в разных подсетях сначала маршрутизируют трафик к шлюзу своей подсети, который затем перенаправляет трафик к узлу, размещающему VIP.

- Когда этот узел сталкивается с отказом, MetalLB выбирает другого лидера для размещения VIP. Затем отправляет GARP для обновления MAC-адреса Service IP, тем самым обеспечивая высокую доступность.

- При достижении узла Kube-Proxy перенаправляет трафик к соответствующему Pod.

## Алгоритм выбора узлов-хостов VIP\{#vip}

Выбор "лидера" (узла, который будет рекламировать IP) для данного IP балансировщика нагрузки является статeless и работает следующим образом:

- каждый speaker собирает список потенциальных анонсирующих для данного IP, учитывая активные speakers, политику внешнего трафика, активные конечные точки, селекторы узлов и другие факторы.
- каждый speaker выполняет те же вычисления: он получает отсортированный список хешей элементов "узел+VIP" и анонсирует сервис, если он является первым элементом списка.

Это устраняет необходимость в хранении информации о том, какой speaker отвечает за анонсирование данного IP.

Для получения более подробной информации о том, как работает MetalLB, пожалуйста, обратитесь к [документации MetalLB](https://metallb.io/).
