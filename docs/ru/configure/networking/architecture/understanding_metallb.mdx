---
weight: 20
sourceSHA: afd269ed9067da769d994e121c8b93ba5fb21d2a84407245a255193a30ebba76
---

# Понимание MetalLB

## Терминология

| Термин            | Описание                                                                                                                                                                                                                                                                                                                                                   |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **VIP**           | Виртуальный IP-адрес (VIP) — это IP-адрес, назначаемый MetalLB для внутренней маршрутизации типа LoadBalancer, предоставляя единый доступ к службам кластера для внешнего трафика.                                                                                                                                                                       |
| **ARP**           | Протокол разрешения адресов (ARP) используется для сопоставления IP-адресов сетевого уровня с MAC-адресами канального уровня.                                                                                                                                                                                                                               |
| **GARP**          | Безусловный ARP (GARP) — это специальный запрос ARP, используемый для информирования других узлов в сети о связывании IP-адреса с MAC-адресом. В отличие от обычных запросов ARP, GARP не ждет ответов, а активно отправляет информацию по сети.                                                                                                                    |
| **ARP Responder** | Компонент MetalLB, отвечающий на запросы ARP, сопоставляя VIP с MAC-адресом узла. Когда узел нуждается в коммуникации с VIP, он отправляет запросы ARP для получения MAC-адреса, соответствующего VIP. Каждый доступный узел имеет ARP Responder, который отвечает на эти запросы, сопоставляя VIP с MAC-адресом узла. |
| **Controller**    | Компонент MetalLB, который динамически выделяет VIP из пула внешних адресов для внутренней маршрутизации типа LoadBalancer. Контроллер слушает события создания и удаления внутренних маршрутов в кластере, чтобы выделять или освобождать VIP по мере необходимости.                                                                                              |
| **Speaker**       | Компонент MetalLB, который определяет, на каких узлах должны находиться VIP и отправлять GARP на основе политик или алгоритмов. Он обеспечивает определенный уровень баланса между узлами, и когда узел становится недоступным, другие узлы могут взять на себя VIP и отправить GARP, тем самым достигая высокой доступности.                              |

## Принципы высокой доступности в MetalLB

![](../../../../en/configure/networking/assets/metallbfix.png)

По умолчанию платформа использует режим ARP MetalLB, а конкретный процесс реализации и принципы таковы:

- Компонент Controller MetalLB выбирает IP-адрес из пула внешних адресов и выделяет его для внутренней маршрутизации типа LoadBalancer в качестве VIP.

- MetalLB выбирает доступный узел для размещения VIP на основе [алгоритма](#vip), который затем пересылает трафик.

- Компонент Speaker на этом узле активно отправляет GARP, устанавливая соответствие между VIP и MAC-адресом по всем узлам.

  - Узлы в одной подсети, узнав о соответствии между VIP и MAC-адресом доступного узла, будут напрямую связываться с этим узлом при доступе к VIP.

  - Узлы в разных подсетях сначала будут направлять трафик к шлюзу своей подсети, который затем пересылает трафик к узлу, на котором находится VIP.

- Когда этот узел сталкивается с отказом, MetalLB выбирает другой доступный узел для размещения VIP, обеспечивая таким образом высокую доступность.

- По достижении узла Kube-Proxy пересылает трафик в соответствующий Pod.

## Алгоритм MetalLB для выбора узлов-хостов VIP\{#vip}

MetalLB хэширует все доступные узлы, соответствующие пулу внешних адресов с VIP, и сортирует их по определенному алгоритму, выбирая первый доступный узел в качестве хоста для VIP.

## Пулы внешних адресов и количество узлов

Создайте пул внешних адресов и добавьте доступные узлы. Все доступные узлы поддерживают **резервную** связь, что означает, что только узел, на котором находится VIP, может пересылать трафик, требуя от него обработки всего трафика для VIP в пуле внешних адресов.

### Формула расчета

Формула: **Количество внешних адресных пулов = ceil(n-vip / n-node)**, где ceil округляет вверх.

**Примечание**: Если используются виртуальные машины, количество виртуальных машин = Количество внешних адресных пулов \* n. Здесь n должно быть больше 2, с максимальным допустимым числом отказов в 1 узел.

- n-vip: представляет собой количество VIP.

- n-node: представляет собой количество VIP, которые один узел может обрабатывать.

### Пример применения

Если у компании есть 10 VIP, и каждый доступный узел может обрабатывать 5 VIP, позволяя на один узел отказа, то как должна компания спланировать количество внешних адресных пулов и доступных узлов?

**Анализ**:

Потребуется всего два внешних адресных пула и четыре доступных узла.

- Каждый доступный узел может обрабатывать максимум 5 VIP, что означает, что один внешний адресный пул может вместить 5 VIP, поэтому для 10 VIP потребуется два внешних адресных пула.

- Позволяя на один узел отказа, каждый пул адресов должен включать один узел, на котором находится VIP, и один резервный узел, что приводит к необходимости двух доступных узлов для каждого из двух внешних адресных пулов.
