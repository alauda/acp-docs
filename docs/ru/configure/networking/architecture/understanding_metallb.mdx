---
weight: 20
sourceSHA: b6cb973a8e9e2631d6cd12e071d884c305e0a3a63063692c57913edca2e26cd9
---

# Понимание MetalLB

## Терминология

| Термин             | Описание                                                                                                                                                                                                                                                                                                                                                     |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **VIP**            | Виртуальный IP-адрес (VIP) — это IP-адрес, назначенный MetalLB для внутренней маршрутизации типа LoadBalancer, предоставляющий единый пункт доступа для внешнего трафика к сервисам внутри кластера.                                                                                                                                                       |
| **ARP**            | Протокол разрешения адресов (ARP) используется для сопоставления IP-адресов сетевого уровня с MAC-адресами канального уровня.                                                                                                                                                                                                                                           |
| **GARP**           | Безвозмездный ARP (GARP) — это специальный запрос ARP, используемый для информирования других узлов в сети о привязке IP-адреса к MAC-адресу. В отличие от обычных запросов ARP, GARP не дожидается ответов, а активно отправляет информацию по сети.                                                                                                   |
| **ARP Respondere** | Компонент MetalLB, отвечающий на запросы ARP, сопоставляя VIP с MAC-адресом узла. Когда узел должен связаться с VIP, он отправляет запросы ARP для получения MAC-адреса, соответствующего VIP. Каждый доступный узел имеет ARP Respondere, который отвечает на эти запросы, сопоставляя VIP с MAC-адресом узла. |
| **Controller**     | Компонент MetalLB, который динамически выделяет VIP из внешнего пула адресов для внутренней маршрутизации типа LoadBalancer. Контроллер отслеживает события создания и удаления внутренних маршрутов в кластере, чтобы выделить или освободить VIP по мере необходимости.                                                                                                   |
| **Speaker**        | Компонент MetalLB, который определяет, на основе политик или алгоритмов, должны ли узлы размещать VIP и отправлять GARP. Это обеспечивает определенный уровень баланса среди узлов, и когда узел становится недоступным, другие узлы могут взять на себя VIP и отправить GARP, обеспечивая тем самым высокую доступность.                                                           |

## Принципы высокой доступности в MetalLB

![](../assets/metallbfix.png)

По умолчанию платформа использует режим ARP MetalLB, а конкретный процесс реализации и принципы следующие:

- Компонент Контроллера MetalLB выбирает IP-адрес из внешнего пула адресов и выделяет его для внутренней маршрутизации типа LoadBalancer в качестве VIP.

- MetalLB выбирает доступный узел для размещения VIP на основе [алгоритма](#vip), который затем перенаправляет трафик.

- Компонент Speaker на этом узле активно отправляет GARP, устанавливая сопоставление между VIP и MAC-адресом на всех узлах.

  - Узлы в одной подсети, узнав сопоставление между VIP и MAC-адресом доступного узла, будут напрямую связываться с этим узлом при доступе к VIP.

  - Узлы в разных подсетях сначала направят трафик к шлюзу своей подсети, который затем перенаправит трафик к узлу, который размещает VIP.

- Когда этот узел выходит из строя, MetalLB выбирает другой доступный узел для размещения VIP, обеспечивая тем самым высокую доступность.

- По достижении узла Kube-Proxy перенаправляет трафик к соответствующему Pod.

## Алгоритм MetalLB для выбора узлов-хостов VIP\{#vip}

MetalLB хеширует все доступные узлы, соответствующие внешнему пулу адресов с VIP, и сортирует их согласно определенному алгоритму, выбирая первый доступный узел в качестве хоста для VIP.

## Внешние Пулы Адресов и Количество Узлов

Создайте внешний пул адресов и добавьте доступные узлы. Все доступные узлы поддерживают **резервную** связь, что означает, что только узел, размещающий VIP, может перенаправлять трафик, что требует от него обработки всего трафика для VIP в внешнем пуле адресов.

### Формула расчета

Формула: **Количество внешних пулов адресов = ceil(n-vip / n-node)**, где ceil округляет вверх.

**Примечание**: Если используются виртуальные машины, то количество виртуальных машин = Количество внешних пулов адресов \* n. Здесь n должно быть больше 2, допускается максимальная одна ошибка узла.

- n-vip: Обозначает количество VIP.

- n-node: Обозначает количество VIP, которое может обрабатывать один узел.

### Пример применения

Если у компании есть 10 VIP, и каждый доступный узел может обрабатывать 5 VIP, допускается одна ошибка узла, как компания должна спланировать количество внешних пулов адресов и доступных узлов?

**Анализ**:

В итоге необходимо создать два внешних пула адресов и четыре доступных узла.

- Каждый доступный узел может обрабатывать максимум 5 VIP, что означает, что один внешний пул адресов может вместить 5 VIP, поэтому для 10 VIP требуется два внешних пула адресов.

- Допуская одну ошибку узла, каждый пул адресов должен включать один узел, размещающий VIP, и один резервный узел, что приводит к двум доступным узлам для каждого из двух внешних пулов адресов.

## Дополнительные ресурсы

- [Создание внешнего пула IP-адресов](../functions/create_metallb.mdx)
- [Создание BGP-соседей](../functions/create_bgppeer.mdx)
