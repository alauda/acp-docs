---
weight: 15
sourceSHA: c6957ded1bf58bf1c782408dc25584722be89b163a6f59f5379f3dff62eba4ed
---

# Создание пула внешних IP-адресов

Пул внешних IP-адресов — это набор IP-адресов, который MetalLB использует для получения IP-адресов внешнего доступа для маршрутов внутреннего типа LoadBalancer.

## Предварительные требования

Если вам необходимо использовать пул внешних IP-адресов типа BGP, обратитесь к администратору для активации соответствующих функций.

## Ограничения и условия

IP-ресурсы для внешнего адреса должны соответствовать следующим условиям:

- Пул внешних адресов должен быть связан на уровне 2 (L2) с доступными узлами.

- IP-адреса должны быть использованы платформой и не могут включать IP-адреса, которые уже используются физической сетью, такие как IP-адреса шлюза.

- Не должно быть пересечений с сетями, используемыми кластером, включая Cluster CIDR, Service CIDR, подсети и т.д.

- В среде с двойным стеком убедитесь, что одновременно существуют как IPv4, так и IPv6 адреса в одном пуле внешних адресов, и их количество больше 0. В противном случае внутренние маршруты типа LoadBalancer с двойным стеком не смогут получить адреса внешнего доступа.

- В среде IPv6 DNS узлов должен поддерживать IPv6; в противном случае плагин MetalLB не сможет быть успешно задействован.

## Установка плагина MetalLB

Использование пула внешних адресов зависит от плагина MetalLB.

1. Перейдите в **Управление платформой**.

2. В левой панели навигации нажмите **Управление кластерами** > **Кластер**.

3. Нажмите на ***Имя кластера***, где будет развернут плагин.

4. На вкладке **Плагины** нажмите на **MetalLB** справа от ⋮ > **Развернуть**.

5. Дождитесь, пока статус развертывания не покажет **Развертывание успешно**, чтобы завершить установку.

## Пример пользовательского ресурса IPAddressPool (CR)

```yaml
# ippool-with-L2advertisement.yaml
kind: IPAddressPool
apiVersion: metallb.io/v1beta1
metadata:
  name: test-ippool
  namespace: metallb-system
spec:
  addresses:
    - 13.1.1.1/24
  avoidBuggyIPs: true
---
kind: L2Advertisement
apiVersion: metallb.io/v1beta1
metadata:
  name: test-ippool
  namespace: metallb-system
spec:
  ipAddressPools:
    - test-ippool #[!code callout]
  nodeSelectors:
    - matchLabels: {}
      matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
            - 192.168.66.210
```

Режим BGP:

```yaml
# ippool-with-bgpadvertisement.yaml
kind: IPAddressPool
apiVersion: metallb.io/v1beta1
metadata:
  name: test-pool-bgp
  namespace: metallb-system
spec:
  addresses:
    - 4.4.4.3/23
  avoidBuggyIPs: true
---
kind: BGPAdvertisement
apiVersion: metallb.io/v1beta1
metadata:
  name: test-pool-bgp
  namespace: metallb-system
spec:
  ipAddressPools:
    - test-pool-bgp
  nodeSelectors:
    - matchLabels:
        alertmanager: "true"
  peers:
    - test-bgp-example
```

<Callouts>
  1. Ссылка на пул IP.
</Callouts>

:::info
Q: Что такое `L2Advertisement`?

A:

1. `L2Advertisement` — это пользовательский ресурс (CRD), предоставляемый MetalLB для управления тем, какие адреса из пула IP-адресов должны транслироваться через ARP (IPv4) или NDP (IPv6) в режиме Layer 2.

Q: Какова цель `L2Advertisement`?

A:

1. Указание, какие IP-адреса в IPAddressPool транслировать по L2 (ARP/NDP объявления);

2. Управление поведением трансляции для предотвращения конфликтов IP или трансляций между сегментами;

3. Ограничение диапазона трансляции в средах с несколькими NIC и сетями.

Короче говоря, это говорит MetalLB: какие IP-адреса могут транслироваться и кому (например, каким узлам).

Без определения `L2Advertisement` в режиме Layer2 MetalLB не будет транслировать никакие адреса.

Q: Что такое `BGPAdvertisement` в MetalLB?

A:

`BGPAdvertisement` — это определение пользовательского ресурса Kubernetes (CRD), используемое в [MetalLB](https://metallb.io/), реализации балансировщика нагрузки для кластеров Kubernetes на «голом» оборудовании. Оно управляет тем, как диапазоны IP-адресов (определенные в `IPAddressPool`) транслируются во внешние сети через BGP (протокол пограничного шлюза).

Q: Почему `BGPAdvertisement` важно?

A:

В режиме BGP MetalLB контроллер взаимодействует с внешними маршрутизаторами, используя BGP, и транслирует IP-адреса, назначенные объектам `Service` Kubernetes. Ресурс `BGPAdvertisement` позволяет вам:

- Управлять тем, какие пулы адресов транслируются

- Настраивать параметры объявления маршрутов, такие как:

  - Аггрегация маршрутов

  - Сообщества BGP

  - Локальные предпочтения (приоритет BGP)

Без определения `BGPAdvertisement` MetalLB не будет транслировать никакие адреса, даже если вы настроили BGP-соседей.
:::

## Создание пула внешних IP-адресов с помощью веб-консоли

1. Перейдите в **Управление платформой**.

2. В левой панели навигации нажмите **Управление сетью** > **Пул внешних IP-адресов**.

3. Нажмите **Создать пул внешних IP-адресов**.

4. Ознакомьтесь с следующими инструкциями для настройки некоторых параметров.

   | Параметр           | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
   | ------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Тип**            | <ul><li>L2: связь и пересылка на основе MAC-адресов, подходит для небольших или локальных сетей, которые требуют простого и быстрого переключения на уровне 2, с преимуществами простой настройки и низкой задержки.</li><li>BGP (Alpha): маршрутизация и пересылка на основе IP-адресов, использует протокол BGP для обмена маршрутной информацией, подходит для крупных сетей, требующих сложной маршрутизации через несколько автономных систем, с преимуществами высокой масштабируемости и надежности.</li></ul>                                                                                                                                                                                                                                                                                                                                                 |
   | **IP-ресурсы**    | Поддерживает ввод в форматах CIDR и диапазона IP. Нажмите **Добавить**, чтобы поддерживать несколько записей, примеры:<br />**CIDR**: `192.168.1.1/24`.<br />**Диапазон IP**: `192.168.2.1` \~ `192.168.2.255`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | **Доступные узлы** | В режиме L2 доступные узлы — это те, которые используются для переноса всего VIP-трафика; в режиме BGP доступные узлы — это те, которые используют VIP, устанавливают BGP-соединения с соседями и анонсируют маршруты наружу. <ul><li><b>Имя узла</b>: выберите доступные узлы на основе имен узлов.</li><li><b>Выбор меток</b>: выберите доступные узлы на основе меток.</li><li><b>Показать детали узла</b>: просмотреть окончательные доступные узлы в формате списка.</li></ul><b>Примечание</b>: <ul><li>При использовании типа BGP доступными узлами являются узлы следующего перехода; убедитесь, что выбранные доступные узлы являются подмножеством [Узлы BGP-соединений](./create_bgppeer.mdx).</li><li>Вы можете настроить либо выбор меток, либо имя узла отдельно, чтобы выбрать доступные узлы; если обе настройки заданы одновременно, окончательные доступные узлы будут пересечением обоих.</li></ul> |
   | **BGP-соседи**     | Выберите BGP-соседей; пожалуйста, обратитесь к [BGP-соседям](./create_bgppeer.mdx) для конкретных настроек.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |

5. Нажмите **Создать**.

## Создание пула внешних IP-адресов с помощью CLI

```shell
kubectl apply -f ippool-with-L2advertisement.yaml -f ippool-with-bgpadvertisement.yaml
```

## Просмотр политики оповещения

1. Перейдите в **Управление платформой**.

2. В левой панели навигации нажмите **Управление сетью** > **Пул внешних IP-адресов**.

3. Нажмите **Просмотреть политику оповещения** в правом верхнем углу страницы, чтобы просмотреть общую политику оповещения для MetalLB.
