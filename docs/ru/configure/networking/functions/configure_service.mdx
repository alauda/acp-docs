---
weight: 10
sourceSHA: 7868d5f492eb297507d23d913f88f1ed65788df47f15074169abf1e057fd0a49
---

# Создание сервисов

В Kubernetes сервис — это способ экспонирования сетевого приложения, которое работает как один или несколько подов в вашем кластере.

## Зачем нужен сервис

1. У подов есть свои собственные IP-адреса, но:

   - IP-адреса подов нестабильны (они меняются, если под пересоздается).

   - Прямой доступ к подам становится ненадежным.

2. Сервис решает эту проблему, предоставляя:

   - Стабильный IP-адрес и DNS-имя.

   - Автоматическое распределение нагрузки на соответствующие поды.

## Пример сервиса типа ClusterIP:

```shell
# simple-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  type: ClusterIP # [!code callout]
  selector: # [!code callout]
    app.kubernetes.io/name: MyApp
  ports:
    - protocol: TCP
      port: 80 # [!code callout]
      targetPort: 80 # [!code callout]
```

<Callouts>
  1. Доступные значения типов и их поведение: `ClusterIP`, `NodePort`, `LoadBalancer`, `ExternalName`
  2. Набор подов, на которые нацелен сервис, обычно определяется селектором, который вы задаете.
  3. Порт `Service`.
  4. Привязка `targetPort` сервиса к `containerPort` пода. Кроме того, вы можете ссылаться на `port.name` в контейнере пода.
</Callouts>

## Безголовые сервисы

Иногда вам не нужно распределение нагрузки и один IP-адрес сервиса. В этом случае вы можете создать так называемые безголовые сервисы:

```yaml
spec:
  clusterIP: None
```

Безголовые сервисы полезны, когда:

- Вы хотите обнаружить индивидуальные IP-адреса подов, а не только один IP-адрес сервиса.

- Вам нужны прямые соединения с каждым подом (например, для баз данных, таких как Cassandra или StatefulSets).

- Вы используете StatefulSets, где каждый под должен иметь стабильное DNS-имя.

## Создание сервиса с помощью веб-консоли

1. Перейдите в **Container Platform**.

2. В левой навигационной панели нажмите **Network** > **Services**.

3. Нажмите **Create Service**.

4. Ознакомьтесь с следующими инструкциями для настройки соответствующих параметров.

   | Параметр               | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
   | ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Виртуальный IP-адрес** | Если включено, для этого сервиса будет выделен ClusterIP, который можно использовать для обнаружения сервиса внутри кластера.<br />Если отключено, будет создан безголовый сервис, который обычно используется **StatefulSet**.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
   | **Тип**                | <ul><li>**ClusterIP**: Экспонирует сервис на внутреннем IP кластера. Выбор этого значения делает сервис доступным только изнутри кластера. </li><li>**NodePort**: Экспонирует сервис на IP каждого узла на статическом порту (NodePort). </li><li>**ExternalName**: Соответствует содержимому поля externalName (например, имени хоста api.foo.bar.example). </li><li>**LoadBalancer**: Экспонирует сервис внешне с использованием внешнего балансировщика нагрузки. Kubernetes не предлагает напрямую компонент балансировки нагрузки; вы должны предоставить его или интегрировать ваш кластер Kubernetes с облачным провайдером.</li></ul>                                                                                                                                                                                                                                                    |
   | **Целевой компонент**  | <ul><li>**Workload**: Сервис будет перенаправлять запросы на **определенную** нагрузку, которая соответствует меткам, таким как `project.cpaas.io/name: projectname` и `service.cpaas.io/name: deployment-name`.</li><br /><li>**Virtualization**: Сервис будет перенаправлять запросы на **определенную** виртуальную машину или группу виртуальных машин.</li><br /><li>**Label Selector**: Сервис будет перенаправлять запросы на **определенный тип** нагрузки с указанными метками, например, `environment: release`.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                            |
   | **Порт**               | Используется для настройки сопоставления портов для этого сервиса. В следующем примере другие поды внутри кластера могут вызывать этот сервис через виртуальный IP (если включен) и TCP-порт *80*; запросы доступа будут перенаправлены на внешне экспонируемый TCP-порт *6379* или *redis* подов целевого компонента.<ul><li>**Протокол**: Протокол, используемый сервисом, поддерживаемые протоколы включают: `TCP`, `UDP`, `HTTP`, `HTTP2`, `HTTPS`, `gRPC`.</li><li>**Порт сервиса**: Номер порта сервиса, экспонируемого сервисом внутри кластера, то есть Port, например, *80*.</li><li>**Порт контейнера**: Номер (или имя) целевого порта, к которому сопоставляется порт сервиса, то есть targetPort, например, *6379* или *redis*.</li><li>**Имя порта сервиса**: Будет сгенерировано автоматически. Формат: `<protocol>-<service port>-<container port>`, например: *tcp-80-6379* или *tcp-80-redis*.</li></ul> |
   | **Сессия аффинити**    | Аффинити сессии на основе IP-адреса источника (ClientIP). Если включено, все запросы доступа с одного и того же IP-адреса будут обрабатываться на одном и том же сервере во время балансировки нагрузки, что гарантирует, что запросы от одного и того же клиента перенаправляются на один и тот же сервер для обработки.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |

5. Нажмите **Create**.

## Создание сервиса с помощью CLI

```shell
kubectl apply -f simple-service.yaml
```

Создайте сервис на основе существующего ресурса развертывания `my-app`.

```shell
kubectl expose deployment my-app \
  --port=80 \
  --target-port=8080 \
  --name=test-service \
  --type=NodePort \
  -n p1-1
```

## Пример: Доступ к приложению внутри кластера

```yaml
# access-internal-demo.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.25
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-clusterip
spec:
  type: ClusterIP
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80
```

1. Примените этот YAML:

```shell
kubectl apply -f access-internal-demo.yaml
```

2. Запустите другой под:

```shell
kubectl run test-pod --rm -it --image=busybox -- /bin/sh
```

3. Доступ к сервису `nginx-clusterip` в поде `test-pod`:

```shell
wget -qO- http://nginx-clusterip
# или используя DNS-записи, созданные автоматически Kubernetes: <service-name>.<namespace>.svc.cluster.local
wget -qO- http://nginx-clusterip.default.svc.cluster.local
```

Вы должны увидеть HTML-ответ с текстом, подобным "Welcome to nginx!".

## Пример: Доступ к приложению вне кластера

```yaml
# access-external-demo.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.25
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-nodeport
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30080
```

1. Примените этот YAML:

```shell
kubectl apply -f access-external-demo.yaml
```

2. Проверка подов:

```shell
kubectl get pods -l app=nginx -o wide
```

3. curl сервис:

```shell
curl http://{NodeIP}:{nodePort}
```

Вы должны увидеть HTML-ответ с текстом, подобным "Welcome to nginx!".

Конечно, также возможно получить доступ к приложению извне кластера, создав сервис типа LoadBalancer.

**Примечание**: Пожалуйста, настройте сервис LoadBalancer заранее.

```yaml
# access-external-demo-with-loadbalancer.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.25
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-lb-service
spec:
  type: LoadBalancer
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80
```

1. Примените этот YAML:

```shell
kubectl apply -f access-external-demo-with-loadbalancer.yaml
```

2. Получите внешний IP-адрес:

```shell
kubectl get svc nginx-lb-service
```

```shell
NAME            TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)        AGE
nginx-service   LoadBalancer   10.0.2.57        34.122.45.100   80:30005/TCP   30s
```

`EXTERNAL-IP` — это адрес, по которому вы получаете доступ из вашего браузера.

```shell
curl http://34.122.45.100
```

Вы должны увидеть HTML-ответ с текстом, подобным "Welcome to nginx!".

Если EXTERNAL-IP находится в состоянии `pending`, сервис Loadbalancer в данный момент не развернут в кластере.

## Пример: Сервис типа ExternalName

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-external-service
  namespace: default
spec:
  type: ExternalName
  externalName: example.com
```

1. Примените этот YAML:

```shell
kubectl apply -f external-service.yaml
```

2. Попробуйте разрешить внутри пода в кластере:

```shell
kubectl run test-pod --rm -it --image=busybox -- sh
```

затем:

```shell
nslookup my-external-service.default.svc.cluster.local
```

Вы увидите, что он разрешается в `example.com`.

## Аннотации сервиса типа LoadBalancer \{#loadbalancer\_type\_service\_annotation}

### Кластер AWS EKS

Для подробных объяснений аннотаций сервиса LoadBalancer EKS, пожалуйста, обратитесь к [Документации по использованию аннотаций](https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.5/guide/service/annotations/) .

| Ключ                                                          | Значение                                                                                                                                                             | Описание                                                                                                                                                                 |
| ------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| service.beta.kubernetes.io/aws-load-balancer-type            | external: Используйте официальный контроллер AWS LoadBalancer.                                                                                                     | Указывает контроллер для типа LoadBalancer.<br /><br /><b>Примечание</b>: Пожалуйста, заранее свяжитесь с администратором платформы для развертывания контроллера AWS LoadBalancer. |
| service.beta.kubernetes.io/aws-load-balancer-nlb-target-type | <ul><li>instance: Трафик будет отправляться на поды через NodePort.</li><li>ip: Трафик направляется непосредственно на поды (кластер должен использовать Amazon VPC CNI).</li></ul> | Указывает, как трафик достигает подов.                                                                                                                                     |
| service.beta.kubernetes.io/aws-load-balancer-scheme          | <ul><li>internal: Частная сеть.</li><li>internet-facing: Публичная сеть.</li></ul>                                                                                 | Указывает, следует ли использовать частную сеть или публичную сеть.                                                                                                     |
| service.beta.kubernetes.io/aws-load-balancer-ip-address-type | <ul><li>ipv4</li><li>dualstack</li></ul>                                                                                                                          | Указывает поддерживаемый стек IP-адресов.                                                                                                                                   |

### Кластер Huawei Cloud CCE

Для подробных объяснений аннотаций сервиса LoadBalancer CCE, пожалуйста, обратитесь к [Документации по использованию аннотаций](https://support.huaweicloud.com/intl/zh-cn/usermanual-cce/cce_10_0385.html) .

| Ключ                            | Значение                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Описание                                                                                                                                                                                                                       |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| kubernetes.io/elb.id           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Заполните ID облачного балансировщика нагрузки, необходимо использовать существующий облачный балансировщик нагрузки.                                                                                                                                              |
| kubernetes.io/elb.autocreate   | Пример: `{"type":"public","bandwidth_name":"cce-bandwidth-1551163379627","bandwidth_chargemode":"bandwidth","bandwidth_size":5,"bandwidth_sharetype":"PER","eip_type":"5_bgp","available_zone":["cn-north-4b"],"l4_flavor_name":"L4_flavor.elb.s1.small"}`<br /><br /><b>Примечание</b>: Пожалуйста, сначала прочитайте [Инструкции по заполнению](https://support.huaweicloud.com/intl/zh-cn/usermanual-cce/cce_10_0385.html#section8) и при необходимости скорректируйте параметры примера. | Новый облачный балансировщик нагрузки будет создан.                                                                                                                                                                                            |
| kubernetes.io/elb.subnet-id    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | ID подсети, в которой находится кластер. Когда версия Kubernetes 1.11.7-r0 или ниже, это поле должно быть заполнено при создании нового облачного балансировщика нагрузки.                                                          |
| kubernetes.io/elb.class        | <ul><li>union: Совместное балансирование нагрузки.</li><li>performance: Эксклюзивное балансирование нагрузки, поддерживается только в версиях Kubernetes 1.17 и выше.</li></ul>                                                                                                                                                                                                                                                                                                                | Указывает тип нового облачного балансировщика нагрузки, который будет создан, пожалуйста, обратитесь к [Различиям между эксклюзивным и совместным эластичным балансированием нагрузки](https://support.huaweicloud.com/intl/zh-cn/productdesc-elb/elb_pro_0004.html). |
| kubernetes.io/elb.enterpriseID |                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Указывает проект предприятия, к которому принадлежит новый облачный балансировщик нагрузки.                                                                                                                                          |

### Кластер Azure AKS

Для подробных объяснений аннотаций сервиса LoadBalancer AKS, пожалуйста, обратитесь к [Документации по использованию аннотаций](https://cloud-provider-azure.sigs.k8s.io/topics/loadbalancer/#loadbalancer-annotations) .

| Ключ                                                     | Значение                                                                   | Описание                                                     |
| ------------------------------------------------------- | ------------------------------------------------------------------------- | ------------------------------------------------------------- |
| service.beta.kubernetes.io/azure-load-balancer-internal | <ul><li>true: Частная сеть.</li><li>false: Публичная сеть.</li></ul> | Указывает, следует ли использовать частную сеть или публичную сеть. |

### Кластер Google GKE

Для подробных объяснений аннотаций сервиса LoadBalancer GKE, пожалуйста, обратитесь к [Документации по использованию аннотаций](https://cloud.google.com/kubernetes-engine/docs/concepts/service-load-balancer-parameters?hl=zh-cn) .

| Ключ                                  | Значение    | Описание                                                                                   |
| -------------------------------------- | ----------- | ----------------------------------------------------------------------------------------- |
| networking.gke.io/load-balancer-type   | Internal    | Указывает на использование частной сети.                                                 |
| loud.google.com/l4-rbs                 | enabled     | По умолчанию публичный. Если этот параметр настроен, трафик будет направлен непосредственно на поды. |
