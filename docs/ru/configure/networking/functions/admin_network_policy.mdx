---
weight: 19
sourceSHA: 1fbb737f06126b1b5cbd4984a63f9d4a51fff76ecd50382b6e3da7bc28a1d214
---

# Создание сетевых политик администратора

:::info
Платформа теперь предоставляет два различных интерфейса для сетевых политик кластера. Старый интерфейс поддерживается по соображениям совместимости, в то время как новый более гибкий и предоставляет встроенный редактор YAML. Мы рекомендуем использовать новую версию.

Пожалуйста, свяжитесь с администратором платформы, чтобы включить `cluster-network-policy` и `cluster-network-policy-next` feature-gate для доступа к новому интерфейсу.
:::

Новая сетевая политика кластера принимает стандартный дизайн [Admin Network Policy](https://network-policy-api.sigs.k8s.io/api-overview/) сообщества Kubernetes, предоставляя более гибкие методы конфигурации и богатые варианты конфигурации.

Когда применяется несколько сетевых политик, они следуют строгому порядку приоритета: Политика сетевого администратора имеет приоритет над Политикой сети, которая, в свою очередь, имеет приоритет над Базовой политикой сетевого администратора.

Процедура следующая：

<img src="../assets/anp-banp-model.svg" width="864" />

## Примечания

- Только Kube-OVN CNI поддерживает сетевые политики администратора.

- В сетевом режиме Kube-OVN эта функция находится на уровне зрелости Alpha.

- В кластере может существовать только одна базовая сетевая политика администратора.

AdminNetworkPolicy

```yaml
# example-anp.yaml
apiVersion: policy.networking.k8s.io/v1alpha1
kind: AdminNetworkPolicy
metadata:
  name: example-anp
spec:
  priority: 3 #[!code callout]
  subject: #[!code callout]
    pods:
      namespaceSelector:
        matchLabels: {}
      podSelector:
        matchLabels:
          pod-template-hash: 55f66dd67d
  ingress:
    - name: ingress1
      action: Allow #[!code callout]
      ports:
        - portNumber:
            protocol: TCP
            port: 8090
      from: #[!code callout]
        - pods:
            namespaceSelector:
              matchLabels: {}
            podSelector:
              matchLabels:
                pod-template-hash: 55c84b59bb
  egress:
    - name: egress1
      action: Allow
      ports:
        - portNumber:
            protocol: TCP
            port: 8080
      to: #[!code callout]
        - networks:
            - 10.1.1.1/23
```

<Callouts>
  1. Чем меньше число, тем выше приоритет.
  2. `subject`: может быть указано не более одного селектора пространства имен или селектора пода.
  3. `action`: Доступные значения: Allow, Deny и Pass.
     Allow для разрешения доступа к трафику, Deny для отказа в доступе к трафику, Pass для разрешения трафика и пропуска последующих сетевых политик кластера низкого приоритета, продолжая обрабатывать трафик другими политиками (NetworkPolicy и BaselineAdminNetworkpolicy).
  4. Доступные значения: Селектор пространства имен, Селектор пода.
  5. Доступные значения: Селектор пространства имен, Селектор пода, Селектор узла, IP-блок.
</Callouts>

BaselineAdminNetworkpolicy:

```yaml
# default.yaml
apiVersion: policy.networking.k8s.io/v1alpha1
kind: BaselineAdminNetworkPolicy
metadata:
  name: default # [!code callout]
spec:
  subject:
    pods:
      namespaceSelector:
        matchLabels: {}
      podSelector:
        matchLabels:
          pod-template-hash: 55c84b59bb
  ingress:
    - name: ingress1
      action: Allow
      ports:
        - portNumber:
            protocol: TCP
            port: 8888
      from:
        - pods:
            namespaceSelector:
              matchLabels: {}
            podSelector:
              matchLabels:
                pod-template-hash: 55f66dd67d
  egress:
    - name: egress1
      action: Allow # [!code callout]
      ports:
        - portNumber:
            protocol: TCP
            port: 8080
      to:
        - networks:
            - 3.3.3.3/23
```

<Callouts>
  1. В кластере может быть создана только одна базовая сетевая политика администратора с metadata.name=`default`.
  2. Доступные значения: Allow, Deny.
</Callouts>

## Создание AdminNetworkPolicy или BaselineAdminNetworkPolicy с помощью веб-консоли

1. Перейдите в **Управление платформой**.

2. В левой навигационной панели нажмите **Сеть** > **Сетевые политики кластера**.

3. Нажмите **Создать сетевые политики администратора** или **Настроить базовую сетевую политику администратора**.

4. Следуйте приведенным ниже инструкциям, чтобы завершить соответствующую конфигурацию.

   <table>
     <thead>
       <tr>
         <th>Область</th>
         <th colSpan={2}>Параметр</th>
         <th>Описание</th>
       </tr>
     </thead>

     <tbody>
       <tr>
         <td rowSpan={2}>Основная информация</td>
         <td colSpan={2}>Имя</td>
         <td>Имя сетевой политики администратора или базовой сетевой политики администратора.</td>
       </tr>

       <tr>
         <td colSpan={2}>Приоритет</td>
         <td>Определяет порядок, в котором политики оцениваются и применяются. Меньшие числовые значения указывают на более высокий приоритет.
         <br /><b>Примечание:</b> Базовая сетевая политика администратора не имеет приоритета.</td>
       </tr>

       <tr>
         <td rowSpan={4}>Целевой под</td>
         <td colSpan={2}>Селектор пространства имен</td>
         <td>Введите метки целевых пространств имен в формате ключ-значение. Если не указано, политика будет применяться ко всем пространствам имен в текущем кластере. При указании политика будет применяться только к подам в пространствах имен, соответствующих этим селекторам.</td>
       </tr>

       <tr>
         <td colSpan={2}>Предварительный просмотр целевых подов, на которые влияет текущая политика</td>
         <td>Нажмите <b>Предварительный просмотр</b>, чтобы увидеть целевые поды, на которые влияет эта сетевая политика.</td>
       </tr>

       <tr>
         <td colSpan={2}>Селектор пода</td>
         <td>Введите метки целевых подов в формате ключ-значение. Если не указано, политика будет применяться ко всем подам в текущем пространстве имен.</td>
       </tr>

       <tr>
         <td colSpan={2}>Предварительный просмотр целевых подов, на которые влияет текущая политика</td>
         <td>Нажмите <b>Предварительный просмотр</b>, чтобы увидеть целевые поды, на которые влияет эта сетевая политика.</td>
       </tr>

       <tr>
         <td rowSpan={4}>Ingress</td>
         <td colSpan={2}>Действие трафика</td>
         <td>Указывает, как обрабатывать входящий трафик к целевым подам. Имеет три режима: <b>Allow</b> (разрешает трафик), <b>Deny</b> (блокирует трафик) и <b>Pass</b> (пропускает все сетевые политики администратора низкого приоритета, позволяя трафику обрабатываться политикой сети, или, если политика сети не существует, базовой сетевой политикой администратора).
         <br /><b>Примечание:</b> Базовая сетевая политика администратора не имеет действия <b>Pass</b>.</td>
       </tr>

       <tr>
         <td rowSpan={2}>Правило<br /><br /><b>Описание</b>: Если в правиле добавлено несколько источников, между ними существует логическое <b>ИЛИ</b>.</td>
         <td>Селектор пода</td>
         <td>Соответствует пространствам имен или подам с указанными метками в кластере; только соответствующие поды могут получить доступ к целевому поду. Вы можете нажать <b>Предварительный просмотр</b>, чтобы увидеть поды, на которые влияет текущее правило. <ul><li>Если настроены как селекторы пространства имен, так и подов, будет взято их пересечение, что означает, что поды с указанными метками будут выбраны из указанных пространств имен.</li><li>Если этот пункт не настроен, все поды во всех пространствах имен кластера могут получить доступ к целевому поду по умолчанию.</li></ul></td>
       </tr>

       {" "}

       <tr>
         <td>Селектор пространства имен</td>

         <td>
           Соответствует подам с указанными метками в текущем пространстве имен; только
           соответствующие поды могут получить доступ к целевому поду. Вы можете нажать <b>Предварительный просмотр</b>, чтобы
           увидеть поды, на которые влияет текущее правило. Если этот пункт не
           настроен, все поды в текущем пространстве имен могут получить доступ к
           целевому поду по умолчанию.
         </td>
       </tr>

       <tr>
         <td colSpan={2}>Порты</td>
         <td>Соответствует трафику по указанным протоколам и портам; вы можете добавить числовые порты или имена портов на подах. Если этот пункт не настроен, будут соответствовать все порты.</td>
       </tr>

       <tr>
         <td rowSpan={4}>Egress</td>
         <td rowSpan={3}>Правило<br /><br /><b>Описание</b>: Если в правиле добавлено несколько источников, между ними существует логическое <b>ИЛИ</b>.</td>
         <td>Селектор узла</td>
         <td>Указывает, к каким IP-адресам узлов целевые поды могут получить доступ. Вы можете выбрать узлы по их меткам, чтобы контролировать, какие IP-адреса узлов доступны из подов.</td>
       </tr>

       <tr>
         <td>Диапазон IP</td>
         <td>Укажите диапазоны CIDR, к которым целевые поды могут подключаться. Если этот пункт не настроен, целевые поды могут подключаться к любому IP по умолчанию.</td>
       </tr>

       <tr>
         <td>Другие параметры</td>
         <td>Аналогично параметрам Ingress, с теми же вариантами конфигурации и поведением.</td>
       </tr>
     </tbody>
   </table>

## Создание AdminNetworkPolicy или BaselineAdminNetworkPolicy с помощью CLI

```shell
kubectl apply -f example-anp.yaml -f default.yaml
```

## Дополнительные ресурсы

- [Настройка сетевых политик кластера](./cluster_net_policy.mdx)
