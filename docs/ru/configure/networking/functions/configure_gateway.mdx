---
weight: 12
sourceSHA: beb2db2efc954f954c8a59ddfeb329458a5ea5003949683a0e7473123ea2a901
---

# Настройка шлюза

Входной шлюз (Gateway) — это экземпляр, развернутый из класса шлюза. Он создает слушателей для захвата внешнего трафика на указанных доменных именах и портах. Вместе с правилами маршрутизации он может направлять указанный внешний трафик на соответствующие экземпляры бэкенда.

Создайте входной шлюз, чтобы обеспечить более детальное распределение сетевых ресурсов.

## Терминология

| Название ресурса       | Обзор                                                                                                                                                                                                                                                                                                                                                          | Инструкции по использованию                                                                |
| ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------- |
| **Класс шлюза**        | В стандартной документации API шлюза класс шлюза определяется как шаблон для создания шлюзов. Разные шаблоны могут создавать входные шлюзы для различных бизнес-сценариев, что облегчает быстрое управление трафиком.                                                                                                                             | Платформа включает в себя специализированные классы шлюзов.                                  |
| **Входной шлюз**      | Входной шлюз соответствует конкретным экземплярам ресурсов, и пользователи могут эксклюзивно использовать все ресурсы прослушивания и вычисления этого входного шлюза. Это конфигурация правил маршрутизации, действительная для слушателя. Когда внешний трафик обнаруживается шлюзом, он будет распределен на экземпляры бэкенда в соответствии с правилами маршрутизации. | Его можно рассматривать как экземпляр балансировщика нагрузки.                                     |
| **Правило маршрута**   | Правила маршрутизации определяют ряд рекомендаций для распределения трафика от шлюза к сервисам. В настоящее время стандартные поддерживаемые типы правил маршрутизации в API шлюза включают HTTPRoute, TCPRoute, UDPRoute и т. д.                                                                                                                                           | Платформа в настоящее время поддерживает прослушивание протоколов HTTP, HTTPS, TCP и UDP. |

## Предварительные условия

Администратор платформы должен убедиться, что кластер поддерживает внутреннюю маршрутизацию типа LoadBalancer. Для кластеров публичного облака должен быть установлен контроллер службы LoadBalancer. В кластерах, не относящихся к публичному облаку, платформа предоставляет функцию пула внешних адресов, которая позволяет внутренней маршрутизации типа LoadBalancer автоматически получать IP-адрес из пула внешних адресов для внешнего доступа после завершения конфигурации.

## Пример шлюза и пользовательского ресурса Alb2 (CR)

```yaml
# demo-gateway.yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  namespace: k-1
  name: test
  annotations:
    cpaas.io/display-name: ces
    listeners.cpaas.io/creationTimestamp: '["2025-05-26T02:05:56.135Z"]'
    listeners.cpaas.io/display-name: '[""]'
  labels:
    alb.cpaas.io/alb-ref: test-o93q7
spec:
  gatewayClassName: exclusive-gateway # [!code callout]
  listeners:
    - allowedRoutes:
        namespaces:
          from: All
      name: gateway-metric
      protocol: TCP
      port: 11782
---
apiVersion: crd.alauda.io/v2beta1
kind: ALB2
metadata:
  namespace: k-1
  name: test-o93q7 # [!code callout]
spec:
  type: nginx
  config:
    enableAlb: false
    networkMode: container
    resources:
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 200m
        memory: 256Mi
    vip:
      enableLbSvc: true
      lbSvcAnnotations: {}
    gateway:
      mode: standalone
      name: test # [!code callout] # [!code callout]
```

<Callouts>
  1. См. введение в класс шлюза ниже.
  2. Имя `alb2` формируется как `{gatewayName}-{random}`.
  3. Имя `gateway`.
</Callouts>

## Создание шлюза с помощью веб-консоли

1. Перейдите в **Платформу контейнеров**.

2. В левой навигационной панели нажмите **Сеть** > **Входной шлюз**.

3. Нажмите **Создать входной шлюз**.

4. Ознакомьтесь с приведенными ниже инструкциями для настройки конкретных параметров.

   | Параметр                       | Описание                                                                                                                                                                                                                                                                                                            |
   | ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Имя**                        | Имя входного шлюза.                                                                                                                                                                                                                                                                                       |
   | **Класс шлюза**               | Класс шлюза определяет поведение шлюза, аналогично концепции классов хранения (StorageClasses); это ресурс кластера. <br />**Специальный**: Входной шлюз будет соответствовать конкретному экземпляру ресурса, и пользователь сможет использовать все ресурсы прослушивания и вычисления этого шлюза. |
   | **Спецификация**               | Вы можете выбрать рекомендуемый сценарий использования в зависимости от ваших потребностей или настроить лимиты ресурсов.                                                                                                                                                                                                                    |
   | **Адрес доступа**              | Адрес входного шлюза, который по умолчанию получается автоматически.                                                                                                                                                                                                                                        |
   | **Аннотация внутренней маршрутизации** | Используется для объявления конфигурации или возможностей для внутренней маршрутизации типа LoadBalancer. Для получения конкретной информации об аннотациях обратитесь к [инструкциям по аннотациям внутренней маршрутизации типа LoadBalancer](./configure_service.mdx#loadbalancer_type_service_annotation).                                             |

5. Нажмите **Создать**.

## Создание шлюза с помощью CLI

```shell
kubectl apply -f demo-gateway.yaml
```

## Просмотр ресурсов, созданных платформой

После создания входного шлюза платформа автоматически создает множество ресурсов. Не удаляйте ресурсы ниже.

<table>
  <thead>
    <tr>
      <th>Созданные по умолчанию ресурсы</th>
      <th>Имя</th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>Ресурс типа ALB2</td>
      <td><i>name-lb-random</i></td>
    </tr>

    <tr>
      <td>Развертывание</td>
      <td><i>name-lb-random</i></td>
    </tr>

    <tr>
      <td>Внутренняя маршрутизация</td>
      <td><ul><li><i>name-lb-random</i></li><li><i>name-lb-random-lb-random</i></li></ul></td>
    </tr>

    <tr>
      <td>Словарь конфигурации</td>
      <td><ul><li><i>name-lb-random-port-info</i></li><li><i>name-lb-random</i></li></ul></td>
    </tr>

    <tr>
      <td>Служебная учетная запись</td>
      <td><i>name-lb-random-serviceaccount</i></td>
    </tr>
  </tbody>
</table>

## Обновление шлюзов

:::note
Обновление входного шлюза приведет к прерыванию обслуживания на 3-5 минут. Пожалуйста, выберите подходящее время для этой операции.
:::

## Обновление шлюза с помощью веб-консоли

1. Перейдите на **Платформу контейнеров**.

2. В левой навигационной панели нажмите **Сеть** > **Входной шлюз**.

3. Нажмите ⋮ > **Обновить**.

4. Обновите конфигурацию входного шлюза по мере необходимости.

   **Примечание**: Пожалуйста, разумно устанавливайте спецификации в зависимости от бизнес-требований.

5. Нажмите **Обновить**.

## Добавление слушателя

Мониторинг трафика по указанным доменным именам и его перенаправление на экземпляры бэкенда в соответствии с привязанными правилами маршрутизации.

### Предварительные условия

- Если вам нужно мониторить протокол HTTP, пожалуйста, заранее свяжитесь с администратором для подготовки **доменного имени**.

- Если вам нужно мониторить протокол HTTPS, пожалуйста, заранее свяжитесь с администратором для подготовки **доменного имени** и **сертификата**.

## Добавление слушателя с помощью веб-консоли

1. В левой навигационной панели нажмите **Сеть** > **Входной шлюз**.

2. Нажмите ***Имя входного шлюза***.

3. Нажмите **Добавить слушателя**.

4. Ознакомьтесь с приведенными ниже инструкциями для настройки конкретных параметров.

   | Параметр                      | Описание                                                                                                                                                                                                                                                                                                                                                                                                                |
   | ------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Протокол и порт слушателя** | В настоящее время поддерживает мониторинг протоколов HTTP, HTTPS, TCP и UDP, и вы можете самостоятельно ввести порт для мониторинга, например: `80`. <br /><br />**Примечание**:<br /><ul><li>Когда порты одинаковы, типы слушателей HTTP, HTTPS и TCP не могут сосуществовать; вы можете выбрать только один из протоколов.</li><li>При использовании протокола HTTP или HTTPS, если порты одинаковы, доменные имена должны быть разными.</li></ul> |
   | **Доменное имя**                | Выберите доступное доменное имя в текущем пространстве имен, используемое для мониторинга сетевого трафика, обращающегося к этому доменному имени. <br />**Подсказка**: Протоколы TCP и UDP не поддерживают выбор доменных имен.                                                                                                                                                                                                                         |

5. Нажмите **Создать**.

## Добавление слушателя с помощью CLI

```shell
kubectl patch gateway test \
  -n k-1 \
  --type=merge \
  -p '{
    "metadata": {
      "annotations": {
        "listeners.cpaas.io/creationTimestamp": "[\"2025-05-26T02:05:56.135Z\",\"2025-05-26T03:33:52.431Z\"]",
        "listeners.cpaas.io/display-name": "[\"\",\"\" ]"
      }
    },
    "spec": {
      "listeners": [
        {
          "allowedRoutes": {
            "namespaces": {
              "from": "All"
            }
          },
          "name": "gateway-metric",
          "protocol": "TCP",
          "port": 11782
        },
        {
          "allowedRoutes": {
            "namespaces": {
              "from": "All"
            }
          },
          "name": "demo-listener",
          "protocol": "HTTP",
          "port": 8088,
          "hostname": "developer.test.cn"
        }
      ]
    }
  }'
```

## Создание правил маршрутизации

Правила маршрутизации предоставляют политики маршрутизации для входящего трафика, аналогично входящим правилам (Kubernetes Ingress). Они открывают сетевой трафик, контролируемый шлюзом, для внутренней маршрутизации кластера (Kubernetes Service), облегчая стратегии маршрутизации. Ключевое отличие заключается в том, что они нацелены на разные объекты сервиса: входящие правила обслуживают контроллер Ingress, в то время как правила маршрутизации обслуживают шлюз Ingress.

После настройки прослушивания в шлюзе Ingress шлюз будет в реальном времени контролировать трафик с указанных доменов и портов. Правила маршрутизации могут перенаправлять входящий трафик на экземпляры бэкенда по мере необходимости.

## Пример пользовательского ресурса HTTPRoute (CR)

```yaml
# example-httproute.yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute # [!code callout]
metadata:
  namespace: k-1
  name: example-http-route
  annotations:
    cpaas.io/display-name: ""
spec:
  hostnames:
    - developer.test.cn
  parentRefs:
    - kind: Gateway
      namespace: k-1
      name: test
      sectionName: demo-listener # [!code callout]
  rules:
    - matches:
        - path:
            type: Exact
            value: "/demo"
      filters: []
      backendRefs:
        - kind: Service
          name: test-service
          namespace: k-1
          port: 80
          weight: 100
```

<Callouts>
  1. Доступные типы: `HTTPRoute`, `TCPRoute`, `UDPRoute`.
  2. Имя слушателя `Gateway`.
</Callouts>

:::note

Если для объекта **Path** в правиле маршрутизации типа HTTPRoute нет соответствующего правила, будет автоматически добавлено правило соответствия с режимом PathPrefix и значением /.

:::

## Создание маршрута с помощью веб-консоли

1. Перейдите на **Платформу контейнеров**.

2. В левой навигационной панели нажмите **Сеть** > **Правила маршрутизации**.

3. Нажмите **Создать правило маршрутизации**.

4. Следуйте инструкциям ниже для настройки некоторых параметров.

   | Параметр               | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
   | ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
   | **Тип маршрута**        | В настоящее время поддерживаемые типы маршрутов: HTTPRoute, TCPRoute, UDPRoute.<br />**Совет:** HTTPRoute поддерживает публикацию на слушатели протоколов HTTP и HTTPS.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
   | **Публикация на слушателе** | В левом выборочном окне выберите созданный **Ingress Gateway**, а в правом выборочном окне выберите созданный **Слушатель**. Платформа опубликует созданные правила маршрутизации на слушателе ниже, позволяя шлюзу перенаправлять захваченный трафик на указанные экземпляры бэкенда.<br /><br />**Примечание:** Нельзя публиковать правила маршрутизации на слушателе, который находится на порту **11782** или уже смонтировал маршруты TCP или UDP.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
   | **Совпадение**          | Вы можете добавить одно или несколько правил совпадения для захвата трафика, соответствующего требованиям. Например, **захватить трафик с указанным путем**, **захватить трафик с указанным методом** и т. д.<br /><br />**Примечание:** <ul><li>Нажмите **Добавить**; при добавлении нескольких правил маршрутизации связь между правилами — 'AND', и все правила должны совпадать, чтобы быть эффективными.</li><li>Нажмите **Добавить совпадение**; при добавлении нескольких групп правил маршрутизации связь между группами — 'OR', и любое совпадение группы может быть эффективным.</li><li>TCPRoute и UDPRoute не поддерживают настройку правил совпадения.</li><li>Когда объект совпадения — **path**, и метод совпадения — **Exact** или **PathPrefix**, введенное **значение** должно начинаться с "/" и не должно содержать такие символы, как "//", "/./", "/../", "%2f", "%2F", "#", "/..", "/." и т. д.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                          |
   | **Действие**            | Вы можете добавить одно или несколько действий для обработки захваченного трафика. <ul><li>Заголовок: Заголовок HTTP-сообщения содержит много метаданных, которые предоставляют дополнительную информацию о запросе или ответе. Изменяя поля заголовка, сервер может повлиять на то, как обрабатываются запрос и ответ.</li><li>Перенаправление: Соответствующий URL будет обработан указанным образом, после чего запрос будет инициирован снова.</li><li>Перезапись: Соответствующий URL будет обработан указанным образом, после чего запрос будет перенаправлен на другой путь ресурса или имя файла.</li></ul><br /><br />**Примечание:** <ul><li>Нажмите **Добавить**; при добавлении нескольких правил действий платформа выполнит все действия в порядке, основанном на отображаемой последовательности правил.</li><li>TCPRoute и UDPRoute не поддерживают настройку правил действий.</li><li>В рамках одного и того же правила маршрутизации не может быть нескольких действий типа **Header** с одинаковым **значением**.</li><li>В рамках одного и того же правила маршрутизации может существовать только один тип либо **Redirect**, либо **Rewrite**, и только один режим либо **FullPath**, либо **PrefixPath**.</li><li>Если вы хотите использовать операцию **PrefixPath**, сначала добавьте правило совпадения режима **PathPrefix**.</li></ul> |
   | **Экземпляр бэкенда**    | После того как правило вступит в силу, оно будет перенаправлено на экземпляр бэкенда в соответствии с выбранными внутренними маршрутами и портами в текущем пространстве имен. Вы также можете установить веса, при этом более высокие значения веса приводят к более высокой вероятности опроса.<br />**Совет:** Процент рядом с весом указывает вероятность перенаправления на этот экземпляр, рассчитываемую как отношение текущего значения веса к сумме всех значений веса.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |

5. Нажмите **Создать**.

## Создание маршрута с помощью CLI

```shell
kubectl apply -f example-httproute.yaml
```
