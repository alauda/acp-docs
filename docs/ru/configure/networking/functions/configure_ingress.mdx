---
weight: 11
sourceSHA: a6edad2d85caac14964d3a16ce2de8879cfbd9bf4e500294de2cbb7f97468b13
---

# Создание Ingress

Правила Ingress (Kubernetes Ingress) открывают HTTP/HTTPS маршруты из внешней среды к внутреннему маршрутизации (Kubernetes Service), что позволяет контролировать внешний доступ к вычислительным компонентам.

Создайте Ingress для управления внешним HTTP/HTTPS доступом к Service.

:::warning
При создании нескольких ingress в одном пространстве имен разные ingress **НЕ ДОЛЖНЫ** иметь одинаковые
**Домен**, **Протокол** и **Путь** (т.е. дублирующие точки доступа не допускаются).
:::

## Метод реализации

Правила Ingress зависят от реализации Ingress Controller, который отвечает за прослушивание изменений в Ingress и Service. После создания нового правила Ingress автоматически генерируется правило пересылки, соответствующее правилу Ingress, внутри Ingress Controller. Когда Ingress Controller получает запрос, он сопоставляет правило пересылки с правилом Ingress и распределяет трафик по указанным внутренним маршрутам, как показано на диаграмме ниже.

<img src="../assets/netrelationship.png" width="500" />

:::note
Для протокола HTTP Ingress поддерживает только 80 порт в качестве внешнего порта. Для протокола HTTPS Ingress поддерживает только 443 порт в качестве внешнего порта. Балансировщик нагрузки платформы автоматически добавит порты 80 и 443 для прослушивания.
:::

### Быстрый старт \{#ingress\_nginx\_controller}

Далее мы будем использовать общественную версию Ingress-NGINX, чтобы продемонстрировать, как получить доступ к вашему приложению с помощью контроллера NGINX.

1. разверните контроллер `Ingress-NGINX`.

```shell
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.2/deploy/static/provider/cloud/deploy.yaml
```

Следующие ресурсы автоматически создаются после использования этой команды:

| Вид                       | Имя                             | Описание                                                               |
| ------------------------- | -------------------------------- | ----------------------------------------------------------------------- |
| `Namespace`               | `ingress-nginx`                  | Ресурсы для изоляции контроллеров                                       |
| `ServiceAccount`          | `ingress-nginx`                  | Учетная запись сервиса для контроллера                                   |
| `ClusterRole`             | `ingress-nginx`                  | Разрешения на уровне кластера                                           |
| `ClusterRoleBinding`      | `ingress-nginx`                  | Привязка ClusterRole к SA                                               |
| `ConfigMap`               | `ingress-nginx-controller`       | Настройка поведения контроллера (например, уровни журналирования, тайм-аут прокси и т.д.) |
| `ValidatingWebhookConfig` | `ingress-nginx-admission`        | Вебхук для проверки законности конфигурации Ingress (необязательно)    |
| `Service` (TCP/UDP)       | `ingress-nginx-controller`       | Тип по умолчанию - `LoadBalancer`, его можно изменить на `NodePort`.    |
| `Deployment`              | `ingress-nginx-controller`       |                                                                       |
| `Pod`                     | `ingress-nginx-controller-xxx`   |                                                                       |
| `Role`/`RoleBinding`      | admission 相关                     | Поддержка вебхука                                                     |
| `Job`                     | `ingress-nginx-admission-create` | Регистрация вебхука                                                  |

Если вы хотите изменить адрес реестра по умолчанию, вы можете использовать `curl` для загрузки файла YAML, изменить его, а затем применить файл YAML.

```shell
curl -O https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.2/deploy/static/provider/cloud/deploy.yaml
```

Ожидание запуска Pod `ingress-nginx-controller-xxx`

2. Локальное тестирование

   - Создание простого веб-сервера и связанного сервиса:

     ```shell
     kubectl create deployment demo --image=nginx --port=80
     kubectl expose deployment demo
     ```

   - Создание ресурса ingress. В этом примере используется хост, который сопоставляется с `localhost`:

     ```shell
     kubectl create ingress demo-localhost --class=nginx \
       --rule="demo.local/*=demo:80"
     ```

   - Перенаправление локального порта на контроллер ingress:

     ```shell
     kubectl port-forward --namespace=ingress-nginx service/ingress-nginx-controller 8080:80
     ```

   - Доступ к вашему развертыванию с помощью curl:

     ```shell
     curl --resolve demo.local:8080:127.0.0.1 http://demo.local:8080
     ```

     **Примечание**: Этот параметр временно разрешает доменное имя demo.local в IP 127.0.0.1 и используется на порту 8080. Когда вы посещаете [http://demo.local:8080](http://demo.local:8080), вы на самом деле посещаете [http://127.0.0.1:8080](http://127.0.0.1:8080).
     С другой стороны, вам следует настроить `hosts`:

     ```shell
     echo "127.0.0.1 demo.local" | sudo tee -a /etc/hosts
     ```

     В конечном итоге вы должны увидеть HTML-ответ, содержащий текст вроде "Welcome to nginx!".

     Затем вы можете получить доступ к сайту `http://demo.local:8080/`.

:::info
Тип по умолчанию для `ingress-nginx-controller` - `LoadBalancer`. Если поле `EXTERNAL-IP` отображает `pending`, это означает, что ваш кластер Kubernetes не смог предоставить балансировщик нагрузки.

Если вы интегрируетесь с поставщиком, который поддерживает указание IP-адреса(ов) балансировщика нагрузки для сервиса через (специфические для поставщика) [аннотации](./configure_service.mdx#loadbalancer_type_service_annotation), вам следует переключиться на это.
:::

3. Онлайн тестирование

Когда ваш `ingress-nginx-controller` (сервис типа LoadBalancer) имеет `EXTERNAL-IP`, вы можете создать ресурс ingress. Следующий пример предполагает, что вы настроили DNS-запись для `www.developer.io`:

```shell
kubectl create ingress demo --class=nginx \
  --rule="www.developer.io/*=demo:80"
```

Вы можете получить доступ к `http://www.developer.io`, чтобы увидеть тот же вывод.

## Предварительные требования

- В текущем пространстве имен должен быть доступный **Service**.

- Пожалуйста, подтвердите с администратором, что для проекта, связанного с текущим пространством имен, был выделен используемый доменное имя.

- Для доступа к домену через HTTPS вам сначала нужно сохранить сертификат HTTPS в виде TLS-секрета.

## Пример Ingress:

```yaml
# nginx-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-ingress
  namespace: k-1
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: / #[!code callout]
spec:
  ingressClassName: nginx #[!code callout]
  rules:
    - host: demo.local #[!code callout]
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: nginx-service
                port:
                  number: 80
```

<Callouts>
  1. Чтобы увидеть больше конфигураций, пожалуйста, обратитесь к
     [nginx-configuration](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/).
  2. Использование контроллера `ingress-nginx`.
  3. Если вы хотите запустить ingress локально, сначала настройте `hosts`.
</Callouts>

## Создание Ingress с помощью веб-консоли

1. Получите доступ к **Платформе контейнеров**.

2. В левой навигационной панели нажмите **Сеть** > **Ingress**.

3. Нажмите **Создать Ingress**.

4. Ознакомьтесь с инструкциями ниже, чтобы настроить определенные параметры.

   | Параметр                   | Описание                                                                                                                                                                                                                                                                                                               |
   | --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Класс Ingress**           | Ingress могут реализовываться различными контроллерами с разными именами `IngressClass`. Если на платформе доступно несколько контроллеров ingress, пользователь может выбрать, какой из них использовать с помощью этой опции.                                                                                                           |
   | **Доменное имя**             | Хосты могут быть точными совпадениями (например, `foo.bar.com`) или подстановочными знаками (например, `*.foo.com`). Доменные имена выделяются администратором платформы.                                                                                                                                                     |
   | **Сертификаты**            | TLS-секрет или сертификаты, выделенные администратором платформы.                                                                                                                                                                                                                                                           |
   | **Тип совпадения** и **Путь** | <ul><li>**Префикс**: Совпадает с префиксами путей, например, `/abcd` может совпадать с `/abcd/efg` или `/abcde`.</li><li>**Точный**: Совпадает с точными путями, например, `/abcd`.</li><li>**Специфично для реализации**: Если вы используете пользовательский контроллер Ingress для управления правилами Ingress, вы можете выбрать, чтобы контроллер решал.</li></ul> |
   | **Сервис**                 | Внешний трафик будет перенаправлен на этот сервис.                                                                                                                                                                                                                                                                       |
   | **Порт сервиса**            | Укажите, на какой порт сервиса будет перенаправлен трафик.                                                                                                                                                                                                                                                              |

5. Нажмите **Создать**.

## Создание Ingress с помощью CLI

```shell
kubectl apply -f nginx-ingress.yaml
```

:::note
Если у ingress нет класса Ingress, все экземпляры ALB, выделенные для этого проекта, будут обрабатывать этот ingress.
:::
