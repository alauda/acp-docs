---
weight: 17
sourceSHA: 6571fbfaff515ec9136d5c078d9521dcfd9fa1adba42430218f8e5f933b167b0
---

# Настройка подсетей

## Правила распределения IP

:::note
Если проекту или пространству имен назначено несколько подсетей, IP-адрес будет случайным образом выбран из одной из подсетей.
:::

- Распределение по проекту:

  - Если проект не привязан к подсети, Pods во всех пространствах имен под этим проектом могут использовать только IP-адреса из подсети по умолчанию. Если в подсети по умолчанию недостаточно IP-адресов, Pods не смогут запуститься.
  - Если проект привязан к подсети, Pods во всех пространствах имен под этим проектом могут использовать только IP-адреса из этой конкретной подсети.

- Распределение по пространству имен:

  - Если пространство имен не привязано к подсети, Pods в этом пространстве имен могут использовать только IP-адреса из подсети по умолчанию. Если в подсети по умолчанию недостаточно IP-адресов, Pods не смогут запуститься.
  - Если пространство имен привязано к подсети, Pods в этом пространстве имен могут использовать только IP-адреса из этой конкретной подсети.

## Сеть Calico

Создание подсетей в сети Calico для достижения более тонкой градации сетевой изоляции ресурсов внутри кластера.

### Ограничения и ограничения

В среде кластера IPv6 подсети, созданные в сети Calico, по умолчанию используют инкапсуляцию VXLAN. Порты, необходимые для инкапсуляции VXLAN, отличаются от портов инкапсуляции IPIP. Вам необходимо убедиться, что UDP-порт 4789 открыт.

### Пример пользовательского ресурса подсети (CR) с сетью Calico

```yaml
# test-calico-subnet.yaml
apiVersion: kubeovn.io/v1
kind: Subnet
metadata:
  name: test-calico
spec:
  cidrBlock: 10.1.1.1/24
  default: false #[!code callout]
  ipipMode: Always #[!code callout]
  natOutgoing: true #[!code callout]
  private: false
  protocol: Dual
  v4blockSize: 30
```

<Callouts>
  1. Когда `default` истинно, используйте инкапсуляцию VXLAN.
  2. См. параметры режима инкапсуляции и параметры протокола инкапсуляции.
  3. См. параметры NAT для исходящего трафика.
</Callouts>

### Создание подсети в сети Calico с использованием веб-консоли

1. Перейдите в **Управление платформой**.

2. В левой навигационной панели нажмите **Управление сетью** > **Подсети**.

3. Нажмите **Создать подсеть**.

4. Ознакомьтесь с следующими инструкциями для настройки соответствующих параметров.

   | Параметр                  | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
   | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
   | **CIDR**                   | После назначения подсети проекту или пространству имен контейнерные группы в пространстве имен будут случайным образом использовать IP-адреса в этом CIDR для связи.<br />**Примечание**: Для соответствия между CIDR и BlockSize см. [Содержимое справки](#1).                                                                                                                                                                                                                                     |
   | **Протокол инкапсуляции** | Выберите протокол инкапсуляции. **IPIP** не поддерживается в режиме двойного стека.<ul><li>**IPIP**: Реализует межсегментную связь с использованием протокола IPIP.</li><li>**VXLAN (Alpha)**: Реализует межсегментную связь с использованием протокола VXLAN.</li><li>**Без инкапсуляции**: Прямое соединение через маршрутизацию.</li></ul>                                                                                                                                                               |
   | **Режим инкапсуляции**     | Когда протокол инкапсуляции **IPIP** или **VXLAN**, режим инкапсуляции должен быть установлен, по умолчанию **Всегда**.<br /><ul><li>**Всегда**: Всегда включать IPIP / VXLAN туннели.</li><li>**Между подсетями**: Включать IPIP / VXLAN туннели только когда хост находится в разных подсетях; прямое соединение через маршрутизацию, когда хост находится в одной подсети.</li></ul>                                                                                                                                     |
   | **NAT для исходящего трафика**   | Выберите, нужно ли включить NAT для исходящего трафика (Преобразование сетевых адресов), который включен по умолчанию.<br />Он в основном используется для установки адресов доступа, открытых для внешней сети, когда контейнерная группа подсети обращается к внешней сети.<br />Когда NAT для исходящего трафика включен, IP-адрес хоста будет использоваться в качестве адреса доступа для текущей контейнерной группы подсети; когда не включен, IP-адреса контейнерных групп в подсети будут напрямую открыты для внешней сети. |

5. Нажмите **Подтвердить**.

6. На странице деталей подсети выберите **Действия** > **Назначить проект** / **Назначить пространство имен**.

7. Завершите настройку и нажмите **Назначить**.

### Создание подсети в сети Calico с использованием CLI

```shell
kubectl apply -f test-calico-subnet.yaml
```

### Содержимое справки \{#1}

Динамическое соответствие между CIDR и blockSize показано в таблице ниже.

| CIDR            | Размер blockSize | Количество хостов | Размер одного пула IP |
| --------------- | -------------- | --------------- | ------------------------ |
| `prefix<=16`    | 26             | 1024+           | 64                       |
| `16<prefix<=19` | 27             | 256\~1024       | 32                       |
| `prefix=20`     | 28             | 256             | 16                       |
| `prefix=21`     | 29             | 256             | 8                        |
| `prefix=22`     | 30             | 256             | 4                        |
| `prefix=23`     | 30             | 128             | 4                        |
| `prefix=24`     | 30             | 64              | 4                        |
| `prefix=25`     | 30             | 32              | 4                        |
| `prefix=26`     | 31             | 32              | 2                        |
| `prefix=27`     | 31             | 16              | 2                        |
| `prefix=28`     | 31             | 8               | 2                        |
| `prefix=29`     | 31             | 4               | 2                        |
| `prefix=30`     | 31             | 2               | 2                        |
| `prefix=31`     | 31             | 1               | 2                        |

:::note
Конфигурации подсетей с префиксами больше 31 не поддерживаются.
:::

## Сеть Kube-OVN

Создание подсети в сети Kube-OVN Overlay для достижения более тонкой сетевой изоляции ресурсов в кластере.

:::note
Платформа имеет встроенную подсеть **join** для связи между узлами и Pods; пожалуйста, избегайте конфликтов в сетевых сегментах между **join** и вновь созданными подсетями.
:::

### Пример пользовательского ресурса подсети (CR) с сетью Kube-OVN Overlay \{#kube-ovn\_overlay\_network}

```yaml
# test-overlay-subnet.yaml
apiVersion: kubeovn.io/v1
kind: Subnet
metadata:
  name: test-overlay-subnet
spec:
  default: false
  protocol: Dual
  cidrBlock: 10.1.0.0/23
  natOutgoing: true #[!code callout]
  excludeIps: #[!code callout]
    - 10.1.1.2
  gatewayType: distributed #[!code callout]
  gatewayNode: "" #[!code callout]
  private: false
  enableEcmp: false #[!code callout]
```

<Callouts>
  1. См. параметры NAT для исходящего трафика.
  2. См. параметры зарезервированных IP.
  3. См. параметры типа шлюза. Доступные значения: `distributed` или `centralized`.
  4. См. параметры узлов шлюза.
  5. См. параметры ECMP. При условии, что вы свяжетесь с администратором для включения функции.
</Callouts>

### Создание подсети в сети Kube-OVN Overlay с использованием веб-консоли

1. Перейдите в **Управление платформой**.

2. В левой навигационной панели нажмите **Управление сетью** > **Подсеть**.

3. Нажмите **Создать подсеть**.

4. Ознакомьтесь с следующими инструкциями для настройки соответствующих параметров.

   | Параметр                | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
   | ------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Сетевой сегмент**      | После назначения подсети проекту или пространству имен IP-адреса в этом сегменте будут случайным образом выделены для использования Pods.                                                                                                                                                                                                                                                                                                                                                                                                                   |
   | **Зарезервированный IP**          | Набор зарезервированных IP не будет автоматически выделен. Например, он может использоваться в качестве IP-адреса для **фиксированного IP** вычислительных компонентов.                                                                                                                                                                                                                                                                                                                                                                                                |
   | **Тип шлюза**         | Выберите тип шлюза для подсети для управления исходящим трафиком. <br />- **Распределенный**: Каждый узел в кластере может действовать как выходной узел для Pods на текущем узле, обеспечивая распределенный выход. <br />- **Централизованный**: Все Pods в кластере используют один или несколько конкретных узлов в качестве выходных узлов, что облегчает внешний аудит и контроль брандмауэра. Установка нескольких централизованных **узлов шлюза** может обеспечить высокую доступность.                                                                                     |
   | **ECMP (Alpha)**         | При выборе **Централизованного** шлюза можно использовать функцию ECMP. По умолчанию шлюз работает в режиме мастер-слейв, только мастер-шлюз обрабатывает трафик. При включении ECMP (маршрутизация с равными затратами) исходящий трафик будет маршрутизироваться через несколько равных по стоимости путей ко всем доступным узлам шлюза, тем самым увеличивая общую пропускную способность шлюза. <br /><br />**Примечание**: Пожалуйста, заранее включите функции, связанные с ECMP.                                                                             |
   | **Узлы шлюза**        | При использовании **Централизованного** шлюза выберите один или несколько конкретных узлов в качестве узлов шлюза.                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
   | **NAT для исходящего трафика** | Выберите, нужно ли включить NAT для исходящего трафика (Преобразование сетевых адресов). По умолчанию он включен. <br />Он в основном используется для установки адреса доступа, открытого для внешней сети, когда Pods в подсети обращаются к интернету. <br />Когда NAT для исходящего трафика включен, IP-адрес хоста будет использоваться в качестве адреса доступа для Pods в текущей подсети; когда не включен, IP-адреса Pods в подсети будут напрямую открыты для внешней сети. В этом случае рекомендуется использовать централизованный шлюз. |

5. Нажмите **Подтвердить**.

6. На странице деталей подсети выберите **Действия** > **Назначить проект** / **Пространство имен**.

7. Завершите настройку и нажмите **Назначить**.

### Создание подсети в сети Kube-OVN Overlay с использованием CLI

```shell
kubectl apply -f test-overlay-subnet.yaml
```

### Подсеть \{#kube\_ovn\_underlay\_network}

Создание подсетей в сети Kube-OVN Underlay не только позволяет более тонко изолировать ресурсы, но и обеспечивает лучший опыт работы.

:::info
Сетевая контейнерная сеть в Kube-OVN Underlay требует поддержки со стороны физической сети. Пожалуйста, ознакомьтесь с лучшими практиками [Подготовка физической сети Kube-OVN Underlay](../how_to/kubeovn_underlay_py.mdx), чтобы обеспечить сетевую связность.
:::

### Инструкции по использованию

Общий процесс создания подсетей в сети Kube-OVN Underlay: Добавить сетевой мост > Добавить VLAN > Создать подсеть.

<Callouts>
  1. Имя сетевой карты по умолчанию.
  2. Настроить сетевую карту по узлу.
</Callouts>

### Добавление сетевого моста с использованием веб-консоли (необязательно) \{#kube-ovn\_underlay\_bridge\_network}

```yaml
# test-provider-network.yaml
kind: ProviderNetwork
apiVersion: kubeovn.io/v1
metadata:
  name: test-provider-network
spec:
  defaultInterface: eth1 #[!code callout]
  customInterfaces: #[!code callout]
    - interface: eth2
      nodes:
        - node1
  excludeNodes:
    - node2
```

<Callouts>
  1. Имя сетевой карты по умолчанию.
  2. Настроить сетевую карту по узлу.
</Callouts>

Сетевой мост относится к мосту, и после привязки сетевой карты к мосту он может пересылать трафик контейнерной сети, обеспечивая взаимосвязь с физической сетью.

Процедура:

1. Перейдите в **Управление платформой**.

2. В левой навигационной панели нажмите **Управление сетью** > **Сетевой мост**.

3. Нажмите **Добавить сетевой мост**.

4. Настройте соответствующие параметры на основе следующих инструкций.

   **Примечание**:

   - *Целевой Pod* относится ко всем Pods, запланированным на текущем узле, или Pods в пространствах имен, привязанных к конкретным подсетям, запланированным на текущем узле. Это зависит от области подсети под сетевым мостом.

   - Узлы в подсети Underlay должны иметь несколько сетевых карт, и сетевая карта, используемая сетевым мостом, должна быть исключительно назначена для Underlay и не может нести другой трафик, такой как SSH. Например, если сетевой мост имеет три узла, планирующих использовать eth0, eth0, eth1 исключительно для Underlay, то сетевую карту по умолчанию можно установить как eth0, а сетевую карту для третьего узла можно установить как eth1.

   | Параметр                          | Описание                                                                                                                                                                                                                                                                                                                      |
   | ---------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Имя сетевой карты по умолчанию**      | По умолчанию целевой Pod будет использовать это в качестве сетевой карты моста для взаимосвязи с физической сетью.                                                                                                                                                                                                            |
   | **Настроить сетевую карту по узлу** | Целевые Pods на настроенных узлах будут соединяться с указанной сетевой картой вместо сетевой карты по умолчанию.                                                                                                                                                                                                           |
   | **Исключить узлы**                  | Когда узлы исключены, все Pods, запланированные на эти узлы, не будут соединяться с какой-либо сетевой картой на этих узлах.<br /><br />**Примечание**: Pods на исключенных узлах не смогут взаимодействовать с физической сетью или межузловыми контейнерными сетями, и следует избегать планирования связанных Pods на эти узлы. |

5. Нажмите **Добавить**.

### Добавление сетевого моста с использованием CLI

```shell
kubectl apply -f test-provider-network.yaml
```

### Добавление VLAN с использованием веб-консоли (необязательно)

```yaml
# test-vlan.yaml
kind: Vlan
apiVersion: kubeovn.io/v1
metadata:
  name: test-vlan
spec:
  id: 0 #[!code callout]
  provider: test-provider-network #[!code callout]
```

<Callouts>
  1. VLAN ID.
  2. Ссылка на сетевой мост.
</Callouts>

Платформа имеет предварительно настроенную виртуальную локальную сеть **ovn-vlan**, которая будет подключена к сетевому мосту **provider**. Вы также можете настроить новую VLAN для подключения к другим сетевым мостам, тем самым достигая сетевой изоляции между VLAN.

Процедура:

1. Перейдите в **Управление платформой**.

2. В левой навигационной панели нажмите **Управление сетью** > **VLAN**.

3. Нажмите **Добавить VLAN**.

4. Настройте соответствующие параметры на основе следующих инструкций.

   | Параметр          | Описание                                                                                      |
   | ------------------ | ------------------------------------------------------------------------------------------------ |
   | **VLAN ID**        | Уникальный идентификатор для этой VLAN, который будет использоваться для различения различных виртуальных локальных сетей. |
   | **Сетевой мост** | VLAN будет подключен к этому сетевому мосту для взаимосвязи с физической сетью.   |

5. Нажмите **Добавить**.

### Добавление VLAN с использованием CLI

```shell
kubectl apply -f test-vlan.yaml
```

### Пример пользовательского ресурса подсети (CR) с сетью Kube-OVN Underlay

```yaml
# test-underlay-network.yaml
apiVersion: kubeovn.io/v1
kind: Subnet
metadata:
  name: test-underlay-network
spec:
  default: false
  protocol: Dual
  cidrBlock: 11.1.0.0/23
  gateway: 11.1.0.1
  excludeIps:
    - 11.1.0.3
  private: false
  allowSubnets: []
  vlan: test-vlan #[!code callout]
  enableEcmp: false
```

<Callouts>
  1. Ссылка на VLAN.
</Callouts>

### Создание подсети в сети Kube-OVN Underlay с использованием веб-консоли

:::note
Платформа также предварительно настраивает подсеть **join** для связи между узлами и Pods в режиме Overlay. Эта подсеть не будет использоваться в режиме Underlay, поэтому крайне важно избегать конфликтов IP-сегментов между **join** и другими подсетями.
:::

Процедура:

1. Перейдите в **Управление платформой**.

2. В левой навигационной панели нажмите **Управление сетью** > **Подсеть**.

3. Нажмите **Создать подсеть**.

4. Настройте соответствующие параметры на основе следующих инструкций.

   | Параметр       | Описание                                                                                                                                 |
   | --------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
   | **VLAN**        | VLAN, к которой принадлежит подсеть.                                                                                                       |
   | **Подсеть**      | После назначения подсети проекту или пространству имен IP-адреса в физической подсети будут случайным образом выделены для использования Pods.            |
   | **Шлюз**     | Физический шлюз в вышеуказанной подсети.                                                                                               |
   | **Зарезервированный IP** | Указанный зарезервированный IP не будет автоматически назначен. Например, он может использоваться в качестве IP для **фиксированного IP** вычислительного компонента. |

5. Нажмите **Подтвердить**.

6. На странице деталей подсети выберите **Действие** > **Назначить проект** / **Пространство имен**.

7. Завершите настройку и нажмите **Назначить**.

### Создание подсети в сети Kube-OVN Underlay с использованием CLI

```shell
kubectl apply -f test-underlay-network.yaml
```

### Связанные операции

Когда в кластере существуют как подсети Underlay, так и Overlay, вы можете настроить [Автоматическую взаимосвязь между подсетями Underlay и Overlay](../how_to/underlay_overlay_st.mdx) по мере необходимости.

## Управление подсетями

### Обновление шлюза с использованием веб-консоли

Это включает в себя изменение метода исходящего трафика, узлов шлюза и конфигурации NAT.

1. Перейдите в **Управление платформой**.

2. В левой боковой панели нажмите **Управление сетью** > **Подсети**.

3. Нажмите на имя подсети.

4. Выберите **Действие** > **Обновить шлюз**.

5. Обновите конфигурации параметров; для получения подробной информации обратитесь к [Описание параметров](#kube-ovn_overlay_network).

6. Нажмите **ОК**.

### Обновление шлюза с использованием CLI

```shell
kubectl patch subnet test-overlay-subnet --type=json -p='[
  {"op": "replace", "path": "/spec/gatewayType", "value": "centralized"},
  {"op": "replace", "path": "/spec/gatewayNode", "value": "192.168.66.210"},
  {"op": "replace", "path": "/spec/natOutgoing", "value": true},
  {"op": "replace", "path": "/spec/enableEcmp", "value": true}
]'
```

### Обновление зарезервированных IP с использованием веб-консоли

IP-адрес шлюза не может быть удален из зарезервированных IP, в то время как другие зарезервированные IP могут быть свободно отредактированы, удалены или добавлены.

1. Перейдите в **Управление платформой**.

2. В левой боковой панели нажмите **Управление сетью** > **Подсети**.

3. Нажмите на имя подсети.

4. Выберите **Действие** > **Обновить зарезервированный IP**.

5. После завершения обновлений нажмите **Обновить**.

### Обновление зарезервированных IP с использованием CLI

```shell
kubectl patch subnet test-overlay-subnet --type=json -p='[
  {
    "op": "replace",
    "path": "/spec/excludeIps",
    "value": ["10.1.0.1", "10.1.1.2", "10.1.1.4"]
  }
]'
```

### Назначение проектов с использованием веб-консоли \{#kube\_ovn\_assign\_projects}

Назначение подсетей конкретным проектам помогает командам лучше управлять и изолировать сетевой трафик для различных проектов, обеспечивая, чтобы каждый проект имел достаточные сетевые ресурсы.

1. Перейдите в **Управление платформой**.

2. В левой боковой панели нажмите **Управление сетью** > **Подсети**.

3. Нажмите на имя подсети.

4. Выберите **Действие** > **Назначить проект**.

5. После добавления или удаления проектов нажмите **Назначить**.

### Назначение проектов с использованием CLI

```shell
kubectl patch subnet test-overlay-subnet --type=json -p='[
  {
    "op": "replace",
    "path": "/spec/namespaceSelectors",
    "value": [
      {
        "matchLabels": {
          "cpaas.io/project": "cong"
        }
      }
    ]
  }
]'
```

### Назначение пространств имен с использованием веб-консоли \{#kube\_ovn\_assign\_namespaces}

Назначение подсетей конкретным пространствам имен позволяет более тонко изолировать сеть.

**Примечание**: Процесс назначения перестроит шлюз, и исходящие пакеты данных будут отброшены! Пожалуйста, убедитесь, что в данный момент никакие бизнес-приложения не обращаются к внешним кластерам.

1. Перейдите в **Управление платформой**.

2. В левой боковой панели нажмите **Управление сетью** > **Подсети**.

3. Нажмите на имя подсети.

4. Выберите **Действие** > **Назначить пространство имен**.

5. После добавления или удаления пространств имен нажмите **Назначить**.

### Назначение пространств имен с использованием CLI

```shell
kubectl patch subnet test-overlay-subnet --type=json -p='[
  {
    "op": "replace",
    "path": "/spec/namespaces",
    "value": ["cert-manager"]
  }
]'
```

### Расширение подсетей с использованием веб-консоли

Когда диапазон зарезервированных IP подсети достигает своего предела использования или вот-вот исчерпается, его можно расширить на основе исходного диапазона подсети без влияния на нормальную работу существующих служб.

1. Перейдите в **Управление платформой**.

2. В левой боковой панели нажмите **Управление сетью** > **Подсети**.

3. Нажмите на имя подсети.

4. Выберите **Действие** > **Расширить подсеть**.

5. Завершите настройку и нажмите **Обновить**.

### Расширение подсетей с использованием CLI

```shell
kubectl patch subnet test-overlay-subnet --type=json -p='[
  {
    "op": "replace",
    "path": "/spec/cidrBlock",
    "value": "10.1.0.0/22"
  }
]'
```

### Управление сетями Calico

Поддержка назначения проектов и пространств имен; для получения подробной информации, пожалуйста, обратитесь к [назначению проектов](#kube_ovn_assign_projects) и [назначению пространств имен](#kube_ovn_assign_namespaces).

### Удаление подсети с использованием веб-консоли

:::note

- Когда подсеть удаляется, если все еще существуют контейнерные группы, использующие IP-адреса в пределах подсети, контейнерные группы могут продолжать работать, и IP-адреса останутся неизменными, но они не смогут взаимодействовать по сети. Контейнерные группы могут быть восстановлены для использования IP-адресов в подсети по умолчанию или назначить новую подсеть пространству имен, в котором находятся контейнерные группы, для использования.

- Подсеть по умолчанию не может быть удалена.
  :::

1. Перейдите в **Управление платформой**.

2. В левой навигационной панели нажмите **Управление сетью** > **Подсети**.

3. Нажмите ⋮ > **Удалить** и продолжите удаление.

### Удаление подсети с использованием CLI

```shell
kubectl delete subnet test-overlay-subnet
```
