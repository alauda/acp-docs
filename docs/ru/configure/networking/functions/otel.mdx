---
weight: 30
sourceSHA: 3276640d783e3f6f3b96a0d97e981a7b413e9536b0d2e8a837138d8c7d7f1795
---

# OTel

OpenTelemetry (OTel) — это проект с открытым исходным кодом, направленный на предоставление нейтрального по отношению к поставщику стандарта для сбора, обработки и экспорта телеметрических данных в распределенных системах, таких как архитектуры микросервисов. Он помогает разработчикам более легко анализировать производительность и поведение программного обеспечения, тем самым упрощая диагностику и решение проблем приложений.

## Терминология

| Термин                          | Объяснение                                                                                                                                                                                                                                                                                                                                                                                                                |
| ------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Trace**                       | Данные, отправляемые на OTel-сервер, которые представляют собой коллекцию связанных событий или операций, используемых для отслеживания потока запросов в распределенных системах; каждый Trace состоит из нескольких Span.                                                                                                                                                                                                                             |
| **Span**                        | Независимая операция или событие внутри Trace, которое включает время начала, продолжительность и другую соответствующую информацию.                                                                                                                                                                                                                                                                                                       |
| **OTel Server**                 | OTel-сервер, способный принимать и хранить данные Trace, такие как Jaeger, Prometheus и др.                                                                                                                                                                                                                                                                                                                               |
| **Jaeger**                      | Система распределенного трассирования с открытым исходным кодом, используемая для мониторинга и устранения неполадок в архитектурах микросервисов, поддерживающая интеграцию с OpenTelemetry.                                                                                                                                                                                                                                                                  |
| **Attributes**                  | Пары ключ-значение, прикрепленные к Trace или Span для предоставления дополнительной контекстной информации. Это включает атрибуты ресурсов и атрибуты Span; см. [Attributes](#attri) для получения дополнительной информации.                                                                                                                                                                                                                            |
| **Sampler**                     | Компонент стратегии, который определяет, следует ли отбирать и сообщать о Trace. Можно настраивать различные стратегии выборки, такие как полное выборка, пропорциональная выборка и др.                                                                                                                                                                                                                                             |
| **ALB (Another Load Balancer)** | Программное или аппаратное устройство, которое распределяет сетевые запросы между доступными узлами в кластере; балансировщик нагрузки (ALB), используемый на платформе, представляет собой программный балансировщик нагрузки уровня 7, который можно настроить для мониторинга трафика с помощью OTel. ALB поддерживает отправку Trace на указанный Collector и позволяет использовать различные стратегии выборки; также поддерживает настройку относительно того, следует ли отправлять Trace на уровне Ingress. |
| **FT (Frontend)**               | Конфигурация порта для ALB, указывающая конфигурации на уровне порта.                                                                                                                                                                                                                                                                                                                                                      |
| **Rule**                        | Правила маршрутизации на порту (FT), используемые для сопоставления конкретных маршрутов.                                                                                                                                                                                                                                                                                                                                                              |
| **HotROD (Rides on Demand)**    | Пример приложения, предоставляемый Jaeger для демонстрации использования распределенного трассирования; см. [Hot R.O.D. - Rides on Demand](https://github.com/jaegertracing/jaeger/tree/main/examples/hotrod) для получения дополнительных сведений.                                                                                                                                                                                                        |
| **hotrod-with-proxy**           | Указывает адреса внутренних микросервисов HotROD через переменные окружения; см. [hotrod-with-proxy](https://github.com/woodgear/hotrod-with-proxy/blob/master/services/frontend/best_eta.go#L53) для получения дополнительных сведений.                                                                                                                                                                                          |

## Предварительные требования

- **Убедитесь, что существует работающий ALB**: Создайте или используйте существующий ALB, где имя ALB заменяется на `<otel-alb>` в этом документе. Для инструкций по созданию ALB см. [Creating Load Balancer](../how_to/create_loadbalancer.mdx).

- **Убедитесь, что есть адрес сервера отчетности данных OTel**: Этот адрес с этого момента будет обозначен как `<jaeger-server>`.

## Шаги

### Обновление конфигурации ALB

1. На главном узле кластера используйте инструмент CLI, чтобы выполнить следующую команду для редактирования конфигурации ALB.

   ```
   kubectl edit alb2 -n cpaas-system <otel-alb> # Замените <otel-alb> фактическим именем ALB
   ```

2. Добавьте следующие поля в раздел `spec.config`.

   ```yaml
   otel:
     enable: true
     exporter:
       collector:
         address: "<jaeger-server>" # Замените <jaeger-server> фактическим адресом сервера отчетности данных OTel
         request_timeout: 1000
   ```

   Пример конфигурации после завершения:

   ```yaml
   spec:
     address: 192.168.1.1
     config:
       otel:
        enable: true
        exporter:
          collector:
            address: "http://jaeger.default.svc.cluster.local:4318"
            request_timeout: 1000
       antiAffinityKey: system
       defaultSSLCert: cpaas-system/cpaas-system
       defaultSSLStrategy: Both
       gateway:
       ...
   type: nginx
   ```

3. Выполните следующую команду, чтобы сохранить обновления. После обновления ALB по умолчанию будет включен OpenTelemetry, и вся информация о запросах Trace будет отправлена на сервер Jaeger.

   ```
   :wq
   ```

## Связанные операции

### Настройка OTel в Ingress

- **Включение или отключение OTel в Ingress**

  Настраивая, следует ли включать OTel в Ingress, вы можете лучше отслеживать и отлаживать поток запросов приложений, выявляя узкие места производительности или ошибки, отслеживая запросы, когда они переходят между различными службами.

  **Шаги**

  Добавьте следующую конфигурацию в поле metadata.annotations Ingress:

  ```
  nginx.ingress.kubernetes.io/enable-opentelemetry: "true"
  ```

  Объяснение параметра:

  - **nginx.ingress.kubernetes.io/enable-opentelemetry**: При установке в `true` указывает на то, что контроллер Ingress включает функциональность OpenTelemetry при обработке запросов через этот Ingress, что означает, что информация о запросах Trace будет собираться и отправляться. При установке в `false` или удалении этой аннотации это означает, что информация о запросах Trace не будет собираться или отправляться.

- **Включение или отключение доверия OTel в Ingress**

  Доверие OTel определяет, доверяет ли Ingress и использует информацию Trace (например, идентификатор трассировки) из входящих запросов.

  **Шаги**

  Добавьте следующую конфигурацию в поле metadata.annotations Ingress:

  ```
  nginx.ingress.kubernetes.io/opentelemetry-trust-incoming-span: "true"
  ```

  Объяснение параметра:

  - **nginx.ingress.kubernetes.io/opentelemetry-trust-incoming-span**: При установке в `true` контроллер Ingress продолжает использовать уже существующую информацию Trace, что помогает поддерживать согласованность в кросс-сервисном трассировании, позволяя полностью проследить и проанализировать всю цепочку запросов в системе распределенного трассирования. При установке в `false` будет сгенерирована новая информация трассировки для запроса, что может привести к тому, что запрос будет рассматриваться как часть новой цепи трассировок после входа в Ingress, прерывая непрерывность кросс-сервисного трассирования.

- **Добавление различных конфигураций OTel в Ingress**

  Эта конфигурация позволяет вам настраивать поведение OTel и методологию экспорта данных для различных ресурсов Ingress, позволяя тонкую настройку стратегии трассировки или целей каждой службы.

  **Шаги**

  Добавьте следующую конфигурацию в поле metadata.annotations Ingress:

  ```yaml
  apiVersion: networking.k8s.io/v1
  kind: Ingress
  metadata:
    annotations:
      alb.ingress.cpaas.io/otel: >
       {
          "enable": true,
          "exporter": {
              "collector": {
                  "address": "<jaeger-server>", # Замените <jaeger-server> фактическим адресом сервера отчетности данных OTel, например, "address": "http://128.0.0.1:4318"
                  "request_timeout": 1000
              }
          }
       }
  ```

  Объяснение параметра:

  - **exporter**: Указывает, как собранные данные Trace отправляются на OTel Collector (сервер отчетности данных OTel).
  - **address**: Указывает адрес OTel Collector.
  - **request\_timeout**: Указывает тайм-аут запроса.

### Использование OTel в приложениях

Следующая конфигурация показывает полную структуру конфигурации OTel, которую можно использовать для определения того, как включить и использовать функции OTel в приложениях.

На главном узле кластера используйте инструмент CLI, чтобы выполнить следующую команду для получения полной структуры конфигурации OTel.

```
kubectl get crd alaudaloadbalancer2.crd.alauda.io -o json|jq ".spec.versions[2].schema.openAPIV3Schema.properties.spec.properties.config.properties.otel"
```

Результат:

```
{
    "otel": {
        "enable": true
    }
    "exporter": {
        "collector": {
            "address": ""
          },
    },
    "flags": { 
        "hide_upstream_attrs": false
        "notrust_incoming_span": false
        "report_http_request_header": false
        "report_http_response_header": false
    },
    "sampler": {
        "name": "", 
        "options": {
            "fraction": ""
            "parent_name": ""
          },
      },
 }
```

Объяснение параметров:

| Параметр                                | Описание                                                                                      |
| ---------------------------------------- | ------------------------------------------------------------------------------------------------ |
| **otel.enable**                          | Нужно ли включать функциональность OTel.                                                            |
| **exporter.collector.address**           | Адрес сервера отчетности данных OTel, поддерживающий http/https-протоколы и доменные имена. |
| **flags.hide\_upstream\_attrs**          | Нужно ли сообщать информацию о правилах верхнего уровня.                                              |
| **flag.notrust\_incoming\_span**         | Нужно ли доверять и использовать информацию Trace OTel (например, идентификатор трассировки) из входящих запросов.     |
| **flags.report\_http\_request\_header**  | Нужно ли сообщать заголовки запросов.                                                               |
| **flags.report\_http\_response\_header** | Нужно ли сообщать заголовки ответов.                                                              |
| **sampler.name**                         | Имя стратегии выборки; см. [Sampling Strategies](#sampoli) для подробностей.                         |
| **sampler.options.fraction**             | Уровень выборки.                                                                                   |
| **sampler.options.parent\_name**         | Родительская стратегия для стратегий выборки parent\_base.                                        |

### Унаследование

По умолчанию, если ALB настраивает определенные параметры OTel, а FT не настроен, FT унаследует параметры от ALB как свою собственную конфигурацию; то есть FT унаследует конфигурацию ALB, в то время как Rule может наследовать конфигурации как от ALB, так и от FT.

- **ALB**: Конфигурация в ALB, как правило, глобальна и по умолчанию. Вы можете настраивать глобальные параметры, такие как адреса Collector, здесь, которые затем будут унаследованы более низкими уровнями FT и Rule.

- **FT**: FT может унаследовать конфигурации от ALB, что означает, что некоторые параметры OTel, которые не настроены на FT, будут использовать конфигурацию от ALB. Тем не менее, FT также может быть дополнительно уточнен; например, вы можете выбрать выборочное включение или отключение OTel на FT, не затрагивая другие FT или глобальные настройки ALB.

- **Rule**: Rule может унаследовать конфигурации как от ALB, так и от FT. Однако Rule также может быть уточнен; например, конкретное правило может не доверять входящей информации Trace OTel или изменить стратегии выборки.

**Шаги**

Настроив поле `spec.config.otel` в YAML-файлах ALB, FT и Rule, можно добавить конфигурации, связанные с OTel.

## Дополнительные заметки

### Стратегии выборки \{#sampoli}

| Параметр         | Объяснение                                                                                                                                                                                                                                                                                                                |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **always on**     | Всегда сообщать все данные трассировки.                                                                                                                                                                                                                                                                                            |
| **always off**    | Никогда не сообщать данные трассировки.                                                                                                                                                                                                                                                                                                 |
| **traceid-ratio** | Определяет, следует ли сообщать в зависимости от `traceid`. Формат `traceparent` — это `xx-traceid-xx-flag`, где первые 16 символов `traceid` представляют собой 32-битное шестнадцатеричное целое число. Если это целое число меньше, чем `fraction`, умноженное на 4294967295 (т. е. (2^32-1)), оно будет сообщено.                               |
| **parent-base**   | Определяет, следует ли сообщать в зависимости от части флага `traceparent` в запросе. Когда флаг равен 01, он будет сообщен; например: `curl -v "http://$ALB_IP/" -H 'traceparent: 00-xx-xx-01'`; когда флаг равен 02, он не будет сообщен; например: `curl -v "http://$ALB_IP/" -H 'traceparent: 00-xx-xx-02'`. |

### Атрибуты \{#attri}

- **Атрибуты ресурса**

  Эти атрибуты сообщаются по умолчанию.

  | Параметр               | Описание                         |
  | ----------------------- | ----------------------------------- |
  | **hostname**            | Имя хоста пода ALB         |
  | **service.name**        | Имя ALB                 |
  | **service.namespace**   | Пространство имен, в котором находится ALB |
  | **service.type**        | По умолчанию ALB                      |
  | **service.instance.id** | Имя пода ALB             |

- **Атрибуты Span**

  - Атрибуты, сообщаемые по умолчанию:

    | Параметр                      | Описание                                                          |
    | ------------------------------ | -------------------------------------------------------------------- |
    | **http.status\_code**         | Код статуса                                                          |
    | **http.request.resend\_count** | Количество повторных попыток                                                          |
    | **alb.rule.rule\_name**        | Имя правила, соответствующего этому запросу                         |
    | **alb.rule.source\_type**      | Тип правила, соответствующего этому запросу; в настоящее время только Ingress |
    | **alb.rule.source\_name**      | Имя Ingress                                              |
    | **alb.rule.source\_ns**        | Пространство имен, где находится Ingress                              |

  - Атрибуты, сообщаемые по умолчанию, но могут быть исключены, изменив поле flag.hide\_upstream\_attrs:

    | Параметр                  | Описание                                                              |
    | -------------------------- | ------------------------------------------------------------------------ |
    | **alb.upstream.svc\_name** | Имя службы (внутренний маршрут), на который перенаправляется трафик   |
    | **alb.upstream.svc\_ns**   | Пространство имен, где находится служба (внутренний маршрут), на которую перенаправляется трафик |
    | **alb.upstream.peer**      | IP-адрес и порт пода, на который перенаправляется трафик                    |

  - Атрибуты, не сообщаемые по умолчанию, но могут быть сообщены, изменив поле flag.report\_http\_request\_header:

    | Параметр                          | Описание    |
    | ---------------------------------- | -------------- |
    | `**http.request.header.<header>**` | Заголовок запроса |

  - Атрибуты, не сообщаемые по умолчанию, но могут быть сообщены, изменив поле flag.report\_http\_response\_header:

    | Параметр                           | Описание     |
    | ----------------------------------- | --------------- |
    | `**http.response.header.<header>**` | Заголовок ответа |

## Пример конфигурации

Следующая конфигурация YAML развертывает ALB и использует Jaeger в качестве сервера OTel, с Hotrod-proxy в качестве демонстрационного бэкенда. Настраивая правила Ingress, когда клиенты запрашивают ALB, трафик будет перенаправлен на HotROD. Кроме того, связь между внутренними микросервисами HotROD также проходит через ALB.

1. Сохраните следующий YAML в файле с именем all.yaml.

   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: hotrod
   spec:
     replicas: 1
     selector:
       matchLabels:
         service.cpaas.io/name: hotrod
         service_name: hotrod
     template:
       metadata:
         labels:
           service.cpaas.io/name: hotrod
           service_name: hotrod
       spec:
         containers:
           - name: hotrod
             env:
               - name: PROXY_PORT
                 value: "80"
               - name: PROXY_ADDR
                 value: "otel-alb.default.svc.cluster.local:"
               - name: OTEL_EXPORTER_OTLP_ENDPOINT
                 value: "http://jaeger.default.svc.cluster.local:4318"
             image: theseedoaa/hotrod-with-proxy:latest
             imagePullPolicy: IfNotPresent
             command: ["/bin/hotrod","all","-v"]
   ---
   apiVersion: networking.k8s.io/v1
   kind: Ingress
   metadata:
     name: hotrod-frontend
   spec:
     ingressClassName: otel-alb
     rules:
     - http:
         paths:
         - backend:
             service:
               name: hotrod
               port:
                 number: 8080
           path: /dispatch
           pathType: ImplementationSpecific
         - backend:
             service:
               name: hotrod
               port:
                 number: 8080
           path: /frontend
           pathType: ImplementationSpecific
   ---
   apiVersion: networking.k8s.io/v1
   kind: Ingress
   metadata:
     name: hotrod-customer
   spec:
     ingressClassName: otel-alb
     rules:
     - http:
         paths:
         - backend:
             service:
               name: hotrod
               port:
                 number: 8081
           path: /customer
           pathType: ImplementationSpecific
   ---
   apiVersion: networking.k8s.io/v1
   kind: Ingress
   metadata:
     name: hotrod-route
   spec:
     ingressClassName: otel-alb
     rules:
     - http:
         paths:
         - backend:
             service:
               name: hotrod
               port:
                 number: 8083
           path: /route
           pathType: ImplementationSpecific
   ---
   apiVersion: v1
   kind: Service
   metadata:
     name: hotrod
   spec:
     internalTrafficPolicy: Cluster
     ipFamilies:
       - IPv4
     ipFamilyPolicy: SingleStack
     ports:
       - name: frontend
         port: 8080
         protocol: TCP
         targetPort: 8080
       - name: customer
         port: 8081
         protocol: TCP
         targetPort: 8081
       - name: router
         port: 8083
         protocol: TCP
         targetPort: 8083
     selector:
       service_name: hotrod
     sessionAffinity: None
     type: ClusterIP
   ---
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: jaeger
   spec:
     replicas: 1
     selector:
       matchLabels:
         service.cpaas.io/name: jaeger
         service_name: jaeger
     template:
       metadata:
         labels:
           service.cpaas.io/name: jaeger
           service_name: jaeger
       spec:
         containers:
           - name: jaeger
             env:
              - name: LOG_LEVEL
                value: debug
             image: jaegertracing/all-in-one:1.58.1
             imagePullPolicy: IfNotPresent
         hostNetwork: true
         tolerations:
           - operator: Exists
   ---
   apiVersion: v1
   kind: Service
   metadata:
     name: jaeger
   spec:
     internalTrafficPolicy: Cluster
     ipFamilies:
       - IPv4
     ipFamilyPolicy: SingleStack
     ports:
       - name: http
         port: 4318
         protocol: TCP
         targetPort: 4318
     selector:
       service_name: jaeger
     sessionAffinity: None
     type: ClusterIP
   ---
   apiVersion: crd.alauda.io/v2
   kind: ALB2
   metadata:
     name: otel-alb
   spec:
     config:
       loadbalancerName: otel-alb
       otel:
         enable: true
         exporter:
           collector:
             address: "http://jaeger.default.svc.cluster.local:4318"
             request_timeout: 1000
       projects:
       - ALL_ALL
       replicas: 1
       resources:
         alb:
           limits:
             cpu: 200m
             memory: 2Gi
           requests:
             cpu: 50m
             memory: 128Mi
         limits:
           cpu: "1"
           memory: 1Gi
         requests:
           cpu: 50m
           memory: 128Mi
     type: nginx
   ```

2. В инструменте CLI выполните следующую команду для развертывания Jaeger, ALB, HotROD и всех необходимых CR для тестирования.

   ```
   kubectl apply ./all.yaml
   ```

3. <span id="jaeger">Выполните следующую команду для получения адреса доступа к Jaeger.</span>

   ```
   export JAEGER_IP=$(kubectl get po -A -o wide |grep jaeger | awk '{print $7}');echo "http://$JAEGER_IP:16686"
   ```

4. Выполните следующую команду для получения адреса доступа к otel-alb.

   ```
   export ALB_IP=$(kubectl get po -A -o wide|grep otel-alb | awk '{print $7}');echo $ALB_IP
   ```

5. Выполните следующую команду для отправки запроса на HotROD через ALB. Здесь ALB будет сообщать Trace на Jaeger.

   ```
   curl -v "http://<$ALB_IP>:80/dispatch?customer=567&nonse=" # Замените <$ALB_IP> в команде адресом доступа к otel-alb, полученным на предыдущих шагах
   ```

6. Откройте адрес доступа к Jaeger, полученный в [Шаге 3](#jaeger), чтобы просмотреть результаты.

![](../../../../en/configure/networking/assets/jaeger.png)

![](../../../../en/configure/networking/assets/trace.png)
