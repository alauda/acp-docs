---
weight: 10
sourceSHA: f6314780aa7dd66e7a504f22f77b2c7678d5e3710e6690b920737d0700e0d88d
---

# Аутентификация

## Основное понятие

### Что такое аутентификация

Аутентификация - это механизм, который выполняет проверку подлинности перед тем, как запрос достигнет фактической службы. Это позволяет вам обрабатывать аутентификацию на уровне ALB единообразно, без необходимости реализовывать логику аутентификации в каждом бэкенд-сервисе.

### Поддерживаемые методы аутентификации

ALB поддерживает два основных метода аутентификации:

1. **Перенаправленная аутентификация (внешняя аутентификация)**
   - Отправка запроса во внешний сервис аутентификации для проверки личности пользователя
   - Сценарии применения: Необходима сложная логика аутентификации, такая как OAuth, SSO и т. д.
   - Рабочий процесс:
     1. Запрос пользователя поступает в ALB
     2. ALB пересылает данные аутентификации во внешний сервис аутентификации
     3. Сервис аутентификации возвращает результат проверки
     4. На основе результата аутентификации решается, разрешить ли доступ к бэкенд-сервису

2. **Базовая аутентификация**
   - Простой механизм аутентификации на основе имени пользователя и пароля
   - Сценарии применения: Простое управление доступом, защита среды разработки
   - Рабочий процесс:
     1. Запрос пользователя поступает в ALB
     2. ALB проверяет имя пользователя и пароль в запросе
     3. Сравнивает с настроенной информацией аутентификации
     4. Если проверка прошла успешно, пересылает в бэкенд-сервис

### Методы настройки аутентификации

1. **Глобальная аутентификация**
   - Конфигурируется на уровне ALB, применяется ко всем сервисам
   - Настраивается в ALB или FT CR

2. **Аутентификация на уровне пути**
   - Конфигурируется для конкретного пути Ingress
   - Настраивается для конкретного правила
   - Может переопределять глобальную настройку аутентификации

3. **Отключение аутентификации**
   - Отключить аутентификацию для конкретного пути
   - Настраивается в Ingress с аннотацией: `alb.ingress.cpaas.io/auth-enable: "false"`
   - Настраивается в Правиле с CR

### Обработка результатов аутентификации

- Успех аутентификации: Запрос будет передан в бэкенд-сервис
- Ошибка аутентификации: Возвращается ошибка 401 неавторизованного
- Можно настроить поведение перенаправления после неудачи аутентификации (применимо к перенаправленной аутентификации)

## Быстрый старт

Настройка базовой аутентификации с ALB

### Развертывание ALB

```bash
cat <<EOF | kubectl apply -f -
apiVersion: crd.alauda.io/v2
kind: ALB2
metadata:
  name: auth
  namespace: cpaas-system
spec:
  config:
    networkMode: container
    projects:
    - ALL_ALL
    replicas: 1
    vip: 
      enableLbSvc: false
  type: nginx
EOF
export ALB_IP=$(kubectl get pods -n cpaas-system -l service_name=alb2-auth -o jsonpath='{.items[*].status.podIP}');echo $ALB_IP
```

### Настройка секрета и Ingress

```bash
# echo "Zm9vOiRhcHIxJHFJQ05aNjFRJDJpb29pSlZVQU1tcHJxMjU4L0NoUDE=" | base64 -d #  foo:$apr1$qICNZ61Q$2iooiJVUAMmprq258/ChP1
# openssl passwd -apr1 -salt qICNZ61Q bar # $apr1$qICNZ61Q$2iooiJVUAMmprq258/ChP1

kubectl apply -f - <<'END'
apiVersion: v1
kind: Secret
metadata:
  name: auth-file
type: Opaque
data:
  auth: Zm9vOiRhcHIxJHFJQ05aNjFRJDJpb29pSlZVQU1tcHJxMjU4L0NoUDE=
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: auth-file
  annotations:
    "nginx.ingress.kubernetes.io/auth-type": "basic"
    "nginx.ingress.kubernetes.io/auth-secret": "default/auth-file"
    "nginx.ingress.kubernetes.io/auth-secret-type": "auth-file"
spec:
  rules:
  - http:
      paths:
      - path: /app-file
        pathType: Prefix
        backend:
          service:
            name: app-server
            port:
              number: 80
END
```

### Проверка

```bash
# echo "Zm9vOiJhYXIi" | base64 -d # foo:bar
curl -v -X GET -H "Authorization: Basic Zm9vOmJhcg==" http://$ALB_IP:80/app-file # должно вернуть 200
# неверный пароль
curl -v -X GET -H "Authorization: Basic XXXXOmJhcg==" http://$ALB_IP:80/app-file # должно вернуть 401
```

## Связанные аннотации Ingress

Ingress-nginx определяет ряд аннотаций для настройки конкретных деталей процесса аутентификации. Ниже приведен список аннотаций, которые поддерживает ALB, где "v" указывает на поддержку, а "x" указывает на отсутствие поддержки.

|                                                                                                                                                        | support | type                | note                                                                                       |
| ------------------------------------------------------------------------------------------------------------------------------------------------------ | ------- | ------------------- | ------------------------------------------------------------------------------------------ |
| forward-auth                                                                                                                                           |         |                     | перенаправленная аутентификация через http-запрос                                           |
| nginx.ingress.kubernetes.io/auth-url                                                                                                                   | v       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-method                                                                                                                | v       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-signin                                                                                                                | v       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-signin-redirect-param                                                                                                 | v       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-response-headers                                                                                                      | v       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-proxy-set-headers                                                                                                     | v       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-request-redirect                                                                                                      | v       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-always-set-cookie                                                                                                     | v       | boolean             |                                                                                            |
| nginx.ingress.kubernetes.io/auth-snippet                                                                                                               | x       | string              |                                                                                            |
| basic-auth                                                                                                                                             |         |                     | аутентификация по имени пользователя и паролю                                                |
| nginx.ingress.kubernetes.io/auth-realm                                                                                                                 | v       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-secret                                                                                                                | v       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-secret-type                                                                                                           | v       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-type                                                                                                                  | -       | "basic" or "digest" | basic: поддерживается apr1 **digest: не поддерживается**                                   |
| auth-cache                                                                                                                                             |         |                     |                                                                                            |
| nginx.ingress.kubernetes.io/auth-cache-key                                                                                                             | x       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-cache-duration                                                                                                        | x       | string              |                                                                                            |
| auth-keepalive                                                                                                                                         |         |                     | поддерживать соединение при отправке запроса. Определите поведение keepalive через ряд аннотаций |
| nginx.ingress.kubernetes.io/auth-keepalive                                                                                                             | x       | number              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-keepalive-share-vars                                                                                                  | x       | "true" or "false"   |                                                                                            |
| nginx.ingress.kubernetes.io/auth-keepalive-requests                                                                                                    | x       | number              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-keepalive-timeout                                                                                                     | x       | number              |                                                                                            |
| [auth-tls](https://github.com/kubernetes/ingress-nginx/blob/main/docs/user-guide/nginx-configuration/annotations.md#client-certificate-authentication) |         |                     | когда запрос идет по https, дополнительно проверить сертификат.                            |
| nginx.ingress.kubernetes.io/auth-tls-secret                                                                                                            | x       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-tls-verify-depth                                                                                                      | x       | number              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-tls-verify-client                                                                                                     | x       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-tls-error-page                                                                                                        | x       | string              |                                                                                            |
| nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream                                                                                      | x       | "true" or "false"   |                                                                                            |
| nginx.ingress.kubernetes.io/auth-tls-match-cn                                                                                                          | x       | string              |                                                                                            |

## перенаправленная аутентификация

```mermaid
sequenceDiagram
client ->> alb: запрос клиента (cli-request)
alb ->> auth-server: запрос alb к auth-server (auth-request)
auth-server ->> alb: ответ auth-server 200 (auth-response)
alb ->> app: запрос приложения
app ->> alb: ответ приложения
alb ->> client: ответ клиента
```

Связанные аннотации:

- nginx.ingress.kubernetes.io/auth-url
- nginx.ingress.kubernetes.io/auth-method
- nginx.ingress.kubernetes.io/auth-signin
- nginx.ingress.kubernetes.io/auth-signin-redirect-param
- nginx.ingress.kubernetes.io/auth-response-headers
- nginx.ingress.kubernetes.io/auth-proxy-set-headers
- nginx.ingress.kubernetes.io/auth-request-redirect
- nginx.ingress.kubernetes.io/auth-always-set-cookie

Эти аннотации описывают изменения, внесенные в auth-request, app-request и cli-response на вышеприведенной диаграмме.

### Конструирование связанных аннотаций

#### auth-url

URL для auth-request, значение может быть переменной.

#### auth-method

Метод для auth-request.

#### auth-proxy-set-headers

Значение - это ссылка на ConfigMap в формате `ns/name`.
По умолчанию все заголовки из cli-request отправляются на auth-server. Дополнительные заголовки могут быть настроены через proxy\_set\_header. Следующие заголовки отправляются по умолчанию:

```
X-Original-URI          $request_uri;
X-Scheme                $pass_access_scheme;
X-Original-URL          $scheme://$http_host$request_uri;
X-Original-Method       $request_method;
X-Sent-From             "alb";
X-Real-IP               $remote_addr;
X-Forwarded-For         $proxy_add_x_forwarded_for;
X-Auth-Request-Redirect $request_uri;	
```

### Конструирование аннотаций, связанных с app-request

#### auth-response-headers

Значение - это строка, разделенная запятыми, позволяющая нам перенести определенные заголовки из auth-response в app-request.
пример:

```
nginx.ingress.kubernetes.io/auth-response-headers: Remote-User,Remote-Name
```

Когда ALB инициирует app-request, он включит Remote-User и Remote-Name из заголовков auth-response.

### Обработка cookie

auth-response и app-response могут устанавливать cookie. По умолчанию только в случае, если app-response.success, заголовок auth-response.set-cookie будет объединен с cli-response.set-cookie.

```mermaid
flowchart TD
    subgraph "не включено always-set-cookie"
        A[app-response.set-cookie] --> C{app-response.success?}
        B[auth-response.set-cookie] --> C
        C -->|Да| D[объединить cookie]
        C -->|Нет| E[использовать только app-response.set-cookie]
        D --> F[cli-response.set-cookie]
        E --> F
    end
    subgraph "включено always-set-cookie"
        G[app-response.set-cookie] --> I[объединить cookie]
        H[auth-response.set-cookie] --> I
        I --> J[cli-response.set-cookie]
    end
```

### Конфигурация перенаправления для аутентификационной подписи

Когда auth-server возвращает 401, мы можем установить заголовок перенаправления в cli-response, чтобы инструктировать браузер перенаправиться по URL, указанному в auth-signin, для проверки.

```mermaid
sequenceDiagram
client ->> alb: запрос клиента (cli-request)
alb ->> auth-server: запрос alb к auth-server (auth-request)
auth-server ->> alb: ответ auth-server не 200 (auth-response)
alb ->> client: в случае ошибки аутентификации, alb отвечает cli-response (с заголовком location для перенаправления)
```

#### auth-signin

Значение - это URL, указывающий заголовок location в cli-response.

#### auth-signin-redirect-param

Имя параметра запроса в signin-url, по умолчанию rd.
если signin-url не содержит указанное имя параметра `auth-signin-redirect-param`, alb автоматически добавит параметр. Значение параметра будет установлено в `$pass_access_scheme://$http_host$escaped_request_uri`, используется для записи оригинального URL запроса.

#### auth-request-redirect

Установите заголовок `x-auth-request-redirect` в auth-request.

## базовая аутентификация

базовая аутентификация - это процесс аутентификации, описанный в [RFC 7617](https://datatracker.ietf.org/doc/html/rfc7617).
Процесс взаимодействия выглядит следующим образом:

```mermaid
sequenceDiagram
client ->> alb: запрос клиента (cli-request)
alb ->> alb : проверка имени пользователя и пароля в запросе
alb ->> client: cli-response
```

### auth-realm

[описание защищенной области](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/WWW-Authenticate#realm)
Это значение realm в заголовке `WWW-Authenticate` cli-response.
WWW-Authenticate: Basic realm="$realm"

### auth-type

Тип схемы аутентификации, в настоящее время поддерживает только базовую

### auth-secret

Секрет для имени пользователя и пароля, формат ns/name

### auth-secret-type

Секрет поддерживает два типа:

1. auth-file: данные секрета содержат только один ключ "auth", а его значение является строкой формата Apache htpasswd. например:
   ```
   data:
     auth: "user1:$apr1$xyz..."
   ```

2. auth-map: данные секрета каждая ключ представляет собой имя пользователя, а соответствующее значение - это хэш пароля (без имени пользователя в формате htpasswd). например:
   ```
   data:
     user1: "$apr1$xyz...."
     user2: "$apr1$abc...."
   ```

Примечание: В настоящее время поддерживаются только хэши паролей в формате htpasswd, сгенерированные с использованием алгоритма apr1.

## CR

ALB CR добавил параметры конфигурации, связанные с аутентификацией, которые можно настраивать на ALB/Frontend/Rule CRs.
Во время выполнения ALB преобразует аннотации на Ingress в правила.

```yaml
auth:
  # Конфигурация базовой аутентификации
  basic:
    #  строка; соответствует nginx.ingress.kubernetes.io/auth-type: basic
    auth_type: "basic"
    #  строка; соответствует nginx.ingress.kubernetes.io/auth-realm
    realm: "Ограниченный доступ"  
    #  строка; соответствует nginx.ingress.kubernetes.io/auth-secret
    secret: "ns/name"
    #  строка; соответствует nginx.ingress.kubernetes.io/auth-secret-type
    secret_type: "auth-map|auth-file"
  # Конфигурация перенаправленной аутентификации
  forward:
    #  логическое значение; соответствует nginx.ingress.kubernetes.io/auth-always-set-cookie
    always_set_cookie: true
    #  строка; соответствует nginx.ingress.kubernetes.io/auth-proxy-set-headers
    auth_headers_cm_ref: "ns/name"
    #  строка; соответствует nginx.ingress.kubernetes.io/auth-request-redirect
    auth_request_redirect: "/login"
    #  строка; соответствует nginx.ingress.kubernetes.io/auth-method
    method: "GET"
    #  строка; соответствует nginx.ingress.kubernetes.io/auth-signin
    signin: "/signin"
    #  строка; соответствует nginx.ingress.kubernetes.io/auth-signin-redirect-param
    signin_redirect_param: "redirect_to"
    #  []строка; соответствует nginx.ingress.kubernetes.io/auth-response-headers
    upstream_headers:
      - "X-User-ID" 
      - "X-User-Name"
      - "X-User-Email"
    #  строка; соответствует nginx.ingress.kubernetes.io/auth-url
    url: "http://auth-service/validate"
```

Аутентификация поддерживает конфигурацию на:

- Alb CR's `.spec.config.auth`
- Frontend CR's `.spec.config.auth`
- Rule CR's `.spec.config.auth`

Порядок наследования: Alb > Frontend > Rule. Если дочерний cr не настроен, будет использована конфигурация родительского cr.

## Специальные аннотации Ingress ALB

В процессе обработки Ingress, ALB определяет приоритет на основе префикса аннотации. Приоритет от высокого к низкому:

- `index.$rule_index-$path_index.alb.ingress.cpaas.io`
- `alb.ingress.cpaas.io`
- `nginx.ingress.kubernetes.io`

Это может решить проблему совместимости с ingress-nginx и указать конфигурацию аутентификации на конкретном пути Ingress.

### Auth-Enable

```yaml
alb.ingress.cpaas.io/auth-enable: "false"
```

Новая аннотация, добавленная ALB, используется для указания, следует ли включать функциональность аутентификации для Ingress.

## Другие особенности, связанные с аутентификацией Ingress-Nginx

### Глобальная аутентификация

В ingress-nginx вы можете установить глобальную аутентификацию через ConfigMap. Это эквивалентно настройке аутентификации для всех Ingress. В ALB вы можете настроить аутентификацию на ALB2 и FT CRs. Подлежащие им правила будут наследовать эти конфигурации.

### Нет-авторизованных-локаций

В ALB вы можете отключить функцию аутентификации этого Ingress, настроив аннотацию: `alb.ingress.cpaas.io/auth-enable: "false"` на Ingress.

## Примечание: Несовместимые части с Ingress-Nginx

1. Не поддерживает auth-keepalive
2. Не поддерживает auth-snippet
3. Не поддерживает auth-cache
4. Не поддерживает auth-tls
5. Basic-auth поддерживает только базовую, не поддерживает digest
6. Базовая аутентификация поддерживает только алгоритм apr1, не поддерживает bcrypt sha256 и т. д.

## Устранение неисправностей

1. Проверьте журнал контейнера Nginx pod ALB
2. Проверьте заголовок `X-ALB-ERR-REASON` в ответе
