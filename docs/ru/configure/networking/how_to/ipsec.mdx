---
weight: 30
sourceSHA: 432dfa4a5a5d24b26cca9c4bc6b9c4a5166245cc8b1787839f7d77d03c5c24fd
---

# Kube-OVN Overlay Network Поддерживает Шифрование IPsec

Этот документ предоставляет подробное руководство по включению и отключению шифрованного трафика туннелей IPsec в сети Kube-OVN Overlay. Поскольку трафик туннелей OVN передается через физические маршрутизаторы и коммутаторы, которые могут находиться в ненадежных публичных сетях или подвержены атакам, включение шифрования IPsec может эффективно предотвратить мониторинг и подделку данных трафика.

## Терминология

| Термин    | Объяснение                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **IPsec** | Протокол и технология, используемые для защиты и проверки данных, передаваемых через интернет. Он обеспечивает безопасную связь на уровне IP и в основном используется для создания виртуальных частных сетей (VPN) и защиты передачи IP-пакетов. IPsec обеспечивает безопасность данных в первую очередь с помощью следующих методов: <ul><li>**Шифрование данных**: С помощью технологий шифрования IPsec может гарантировать, что данные не будут украдены или изменены во время передачи. Распространенные алгоритмы шифрования включают AES, 3DES и т.д.</li><li>**Проверка целостности данных**: IPsec использует хеш-функции (такие как SHA-1, SHA-256) для проверки целостности данных, гарантируя, что данные не были изменены во время передачи.</li><li>**Аутентификация**: IPsec может проверять личность обеих сторон, участвующих в общении, с помощью различных методов (таких как предварительно разделенные ключи, цифровые сертификаты), чтобы предотвратить несанкционированный доступ.</li><li>**Управление ключами**: IPsec использует протокол обмена ключами в интернете (IKE) для согласования и управления шифровальными ключами.</li></ul> |

## Примечания

- Включение IPsec может вызвать несколько секунд прерывания сети.

- Если версия ядра 3.10.0-1160.el7.x86\_64, включение функции IPsec в Kube-OVN может столкнуться с проблемами совместимости.

## Предварительные условия

Пожалуйста, выполните следующую команду, чтобы проверить, поддерживает ли текущее ядро операционной системы модули, связанные с IPsec. Если вывод показывает, что все модули, связанные с XFRM, равны `y` или `m`, это указывает на поддержку IPsec.

```
cat /boot/config-$(uname -r) | grep CONFIG_XFRM
```

Вывод:

```
CONFIG_XFRM_ALGO=y
CONFIG_XFRM_USER=y
CONFIG_XFRM_SUB_POLICY=y
CONFIG_XFRM_MIGRATE=y
CONFIG_XFRM_STATISTICS=y
CONFIG_XFRM_IPCOMP=m
```

## Шаги

**Примечание**: Если не указано иное, следующие команды должны выполняться в инструменте CLI на узле Master кластера.

### Включить IPsec

1. Измените файл конфигурации kube-ovn-controller.

   1. Выполните следующую команду, чтобы отредактировать YAML файл конфигурации kube-ovn-controller.

      ```
      kubectl edit deploy kube-ovn-controller -n kube-system
      ```

   2. Измените указанные поля в соответствии со следующими инструкциями.

      ```yaml
      spec:
        template:
          spec:
            containers:
              - args:
                - --enable-ovn-ipsec=true  # Добавьте это поле
                securityContext:
                  runAsUser: 0  # Измените значение на 0
      ```

      Объяснения полей:

      - **spec.template.spec.containers\[0].args**: Добавьте `- --enable-ovn-ipsec=true` под это поле.
      - **spec.template.spec.containers\[0].securityContext.runAsUser**: Измените значение этого поля на 0.

   3. Сохраните изменения.

2. Измените файл конфигурации kube-ovn-cni.

   1. Выполните следующую команду, чтобы отредактировать YAML файл конфигурации kube-ovn-cni.

      ```
      kubectl edit ds kube-ovn-cni -n kube-system
      ```
   2. Измените указанные поля в соответствии со следующими инструкциями.

      ```yaml
      spec:
        template:
          spec:
            containers:
            - args:
              - --enable-ovn-ipsec=true  # Добавьте это поле
              volumeMounts:  # Добавьте путь монтирования, смонтируйте том с именем ovs-ipsec-keys в контейнер
                - mountPath: /etc/ovs_ipsec_keys
                  name: ovs-ipsec-keys
            volumes:  # Добавьте том с именем ovs-ipsec-keys типа hostPath
              - name: ovs-ipsec-keys
                hostPath:
                  path: /etc/origin/ovs_ipsec_keys
      ```

      Объяснения полей:

      - **spec.template.spec.containers\[0].args**: Добавьте `- --enable-ovn-ipsec=true` под это поле.
      - **spec.template.spec.containers\[0].volumeMounts**: Добавьте путь монтирования и смонтируйте том с именем ovs-ipsec-keys в контейнер.
      - **spec.template.spec.volumes**: Добавьте том с именем ovs-ipsec-keys типа hostPath под это поле.
   3. Сохраните изменения.

3. Проверьте, была ли функция успешно включена.

   1. Выполните следующую команду, чтобы войти в Pod kube-ovn-cni.

      ```
      kubectl exec -it -n kube-system $(kubectl get pods -n kube-system -l app=kube-ovn-cni -o=jsonpath='{.items[0].metadata.name}') -- /bin/bash
      ```

   2. Выполните следующую команду, чтобы проверить количество соединений Security Associations. Если количество соединений равно (число узлов - 1), это указывает на успешное включение.

      ```
      ipsec status | grep "Security"
      ```

      Вывод:

      ```
      Security Associations (2 up, 0 connecting):  # Поскольку в этом кластере 3 узла, вы можете увидеть, что количество соединений равно 2
      ```

### Отключить IPsec

1. Измените файл конфигурации kube-ovn-controller.

   1. Выполните следующую команду, чтобы отредактировать YAML файл конфигурации kube-ovn-controller.

      ```
      kubectl edit deploy kube-ovn-controller -n kube-system
      ```

   2. Измените указанные поля в соответствии со следующими инструкциями.

      ```yaml
      spec:
        template:
          spec:
            containers:
              - args:
                - --enable-ovn-ipsec=false  # Измените на false
                securityContext:
                  runAsUser: 65534  # Измените значение на 65534
      ```

      Объяснения полей:

      - **spec.template.spec.containers\[0].args**: Измените значение этого поля `enable-ovn-ipsec` на false.
      - **spec.template.spec.containers\[0].securityContext.runAsUser**: Измените значение этого поля на 65534.

   3. Сохраните изменения.

2. Измените файл конфигурации kube-ovn-cni.

   1. Выполните следующую команду, чтобы отредактировать YAML файл конфигурации kube-ovn-cni.

      ```
      kubectl edit ds kube-ovn-cni -n kube-system
      ```

   2. Измените указанные поля в соответствии со следующими инструкциями.

      - Конфигурация до изменения

        ```yaml
        spec:
          template:
            spec:
              containers:
              - args:
                - --enable-ovn-ipsec=true # Измените на false
                volumeMounts: # Удалите путь монтирования с именем ovs-ipsec-keys
                  - mountPath: /etc/ovs_ipsec_keys
                    name: ovs-ipsec-keys
              volumes: # Удалите том с именем ovs-ipsec-keys, тип hostPath
                - name: ovs-ipsec-keys
                  hostPath:
                    path: /etc/origin/ovs_ipsec_keys
        ```

        Объяснения полей:

        - **spec.template.spec.containers\[0].args**: Измените значение этого поля `enable-ovn-ipsec` на false.
        - **spec.template.spec.containers\[0].volumeMounts**: Удалите путь монтирования с именем ovs-ipsec-keys под это поле.
        - **spec.template.spec.volumes**: Удалите том с именем ovs-ipsec-keys, тип hostPath под это поле.

      - Конфигурация после изменения

        ```yaml
        spec:
          template:
            spec:
              containers:
              - args:
                - --enable-ovn-ipsec=false
                volumeMounts:
              volumes:
        ```

   3. Сохраните изменения.

3. Проверьте, была ли функция успешно отключена.

   1. Выполните следующую команду, чтобы войти в Pod kube-ovn-cni.

      ```
      kubectl exec -it -n kube-system $(kubectl get pods -n kube-system -l app=kube-ovn-cni -o=jsonpath='{.items[0].metadata.name}') -- /bin/bash
      ```

   2. Выполните следующую команду, чтобы проверить статус соединения. Если нет вывода, это указывает на успешное отключение.

      ```
      ipsec status
      ```
