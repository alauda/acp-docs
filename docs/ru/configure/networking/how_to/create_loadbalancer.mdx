---
weight: 20
sourceSHA: 79522d32394e57ec97da15a5d38932798969c81482ecb17ac92601f1710bc9d5
---

# Настройка балансировщика нагрузки

Балансировщик нагрузки — это служба, которая распределяет трафик между контейнерными экземплярами. Используя функционал балансировки нагрузки, он автоматически распределяет входящий трафик для вычислительных компонентов и пересылает его на контейнерные экземпляры этих компонентов. Балансировка нагрузки может улучшить отказоустойчивость вычислительных компонентов, масштабировать внешнюю сервисную способность этих компонентов и повысить доступность приложений.

Администраторы платформы могут создавать однопойнтовые или высокодоступные балансировщики нагрузки для любого кластера на платформе и единообразно управлять и распределять ресурсы балансировщика нагрузки. Например, балансировка нагрузки может быть назначена проектам, что гарантирует, что только пользователи с соответствующими разрешениями проекта могут использовать балансировку нагрузки.

Пожалуйста, обратитесь к таблице ниже для объяснений связанных концепций в этом разделе.

| Параметр            | Описание                                                                                                                                                                                                                                 |
|---------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Балансировщик нагрузки** | Программное или аппаратное устройство, которое распределяет сетевые запросы между доступными узлами в кластере. Используемый в платформе балансировщик нагрузки - это программный балансировщик нагрузки на уровне 7.                                  |
| **VIP**            | Виртуальный IP-адрес (Virtual IP Address) — это IP-адрес, который не соответствует конкретному компьютеру или конкретной сетевой карте. Когда балансировщик нагрузки является высокодоступным, адрес доступа должен быть VIP. |

## Предварительные требования

Высокая доступность **балансировщика нагрузки** требует наличия VIP. Пожалуйста, обратитесь к [Настройка VIP](../how_to/deploy_high_available_vip_for_alb.mdx).

## Пример пользовательского ресурса ALB2 (CR)

```yaml
# test-alb.yaml
apiVersion: crd.alauda.io/v2beta1
kind: ALB2
metadata:
  name: alb-demo
  namespace: cpaas-system
  annotations:
    cpaas.io/display-name: ""
spec:
  address: 192.168.66.215
  config:
    vip: #[!code callout]
      enableLbSvc: false
      lbSvcAnnotations: {}
    networkMode: host #[!code callout]
    enablePortProject: false #[!code callout]
    nodeSelector:
      cpu-model.node.kubevirt.io/Nehalem: "true"
    projects: #[!code callout]
      - ALL_ALL
    replicas: 1
    resources: #[!code callout]
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 200m
        memory: 256Mi
  type: nginx
```

<Callouts>
  1. Когда `enableLbSvc` установлено в true, будет создана внутренняя служба типа LoadBalancer для адреса доступа балансировщика нагрузки.
     `lbSvcAnnotations` Справка по конфигурации аннотаций службы типа LoadBalancer.
  2. Проверьте конфигурацию режима сети ниже.
  3. Проверьте метод распределения ресурсов ниже.
  4. Проверьте назначенный проект ниже.
  5. Проверьте спецификацию ниже.
</Callouts>

## Создание балансировщика нагрузки с помощью веб-консоли.

1. Перейдите в **Управление платформой**.

2. В левой боковой панели нажмите **Управление сетью** > **Балансировщик нагрузки**.

3. Нажмите **Создать балансировщик нагрузки**.

4. Следуйте инструкциям ниже, чтобы завершить настройку сети.

   | Параметр                                    | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   |---------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | **Режим сети**                             | <ul><li>**Режим сети хоста**: На одном узле допускается развертывание только одной реплики балансировщика нагрузки, при этом несколько служб используют один ALB, что приводит к лучшей сетевой производительности.</li><li>**Режим сети контейнера**: На одном узле можно развернуть несколько реплик балансировщика нагрузки, чтобы удовлетворить требования отдельных ALB для каждой службы, с немного сниженной сетевой производительностью.</li></ul>                                                                                                                                                                                                                                                                                                          |
   | **Служба и аннотации (Alpha)** | <ul><li>**Служба**: При включении будет создана внутренняя служба типа LoadBalancer для адреса доступа балансировщика нагрузки. Перед использованием убедитесь, что текущий кластер поддерживает службу типа LoadBalancer. Вы можете реализовать встроенную службу типа LoadBalancer платформы; при отключении необходимо настроить [Пул внешних адресов](../functions/create_metallb.mdx) для балансировщика нагрузки.</li><li>**Аннотации**: Используется для декларации конфигурации или возможностей маршрутизации типа Internal LoadBalancer; для подробностей смотрите [Аннотации для маршрутизации типа Internal LoadBalancer](../functions/configure_service.mdx#loadbalancer_type_service_annotation).</li></ul> |
   | **Адрес доступа**                           | Адрес доступа для балансировки нагрузки, т.е. адрес службы экземпляра балансировщика нагрузки. После успешного создания балансировщика нагрузки можно получить доступ через этот адрес. <ul><li>В режиме сети хоста, пожалуйста, заполните в соответствии с фактическими условиями; это может быть доменное имя или IP-адрес (внутренний IP, внешний IP, VIP).</li><li>В режиме сети контейнера он будет получен автоматически.</li></ul>                                                                                                                                                                                                                                                 |

5. Выполните инструкции ниже, чтобы завершить настройку ресурсов.

   | Параметр                      | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
   |-------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | **Спецификация**              | Пожалуйста, разумно установите спецификации в соответствии с требованиями бизнеса. Вы также можете обратиться к [Как правильно распределить ресурсы CPU и памяти](../how_to/decide_performance_selection.mdx) за справкой.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
   | **Тип развертывания**          | <ul><li>**Однопунктный**: Группа контейнеров балансировщика нагрузки развертывается на одном узле, что может привести к риску недоступности балансировщика нагрузки в случае сбоя машины.</li><li>**Высокая доступность**: Несколько групп контейнеров балансировщика нагрузки развертываются по соответствующему количеству узлов, обычно 3. Это удовлетворяет потребности в балансировке нагрузки больших объемов бизнеса, обеспечивая в то же время возможности экстренного восстановления после аварии.</li></ul>                                                                                                                                                                                                                                                   |
   | **Реплики**                   | Количество реплик — это количество групп контейнеров для балансировщика нагрузки.<br />**Совет**: Для обеспечения высокой доступности балансировщика нагрузки рекомендуется, чтобы количество реплик было не менее 3.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
   | **Ярлыки узлов**              | Фильтровать узлы по ярлыкам для развертывания балансировщика нагрузки.<br />**Совет**: <ul><li>Рекомендуется, чтобы количество узлов, соответствующих требованиям, было больше, чем количество реплик балансировщика нагрузки.</li><li>Ярлык с одинаковым ключом может выбрать только один (если выбрано несколько, доступные хосты не будут найдены).</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | **Метод распределения ресурсов** | <ul><li>**Экземпляр**: Для проектов можно предоставить любой порт в диапазоне от 1 до 65535, на котором экземпляр балансировщика нагрузки может осуществлять прослушивание.</li><li>**Порт (Alpha)**: Только порты в указанном диапазоне могут быть выделены для использования проектами. Этот метод позволяет более точно контролировать ресурсы, когда ресурсы портов ограничены.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
   | **Назначенный проект**         | <ul><li>Когда **Метод распределения ресурсов** установлен в значение **Экземпляр**, балансировщик нагрузки может быть выделен для всех проектов, связанных с текущим кластером, или для указанных проектов. В выделенных проектах все Pods во всех пространствах имен могут получать запросы, распределяемые балансировщиком нагрузки. <ul><li>**Все проекты**: Выделяет балансировщик нагрузки для использования всеми проектами, связанными с текущим кластером.</li><li>**Определенные проекты (Alpha)**: Нажмите выпадающее меню под **Определенные проекты** и нажмите на чекбокс слева от имени проекта, чтобы выбрать один или несколько проектов для выделения балансировщика нагрузки для этих указанных проектов.<br />**Совет**: Вы можете отфильтровать проекты, введя имена проектов в выпадающем меню.</li><li>**Не выделять (Alpha)**: Временно не выделять ни один проект. После создания балансировщика нагрузки вы можете использовать операцию **Обновить проект**, чтобы обновить параметры распределения проекта для созданного балансировщика нагрузки.</li></ul></li><li>Когда **Метод распределения ресурсов** установлен в значение **Порт**, данный пункт не нужно настраивать. Пожалуйста, вручную выделите информацию о порте после создания балансировщика нагрузки.</li></ul> |

6. Нажмите **Создать**. Процесс создания займет некоторое время; пожалуйста, потерпите.

## Создание балансировщика нагрузки с помощью CLI.

```shell
kubectl apply -f test-alb.yaml -n cpaas-system
```

## Обновление балансировщика нагрузки с помощью веб-консоли

:::note
Обновление балансировщика нагрузки приведет к прерыванию службы на 3-5 минут. Пожалуйста, выберите подходящее время для этой операции!
:::

1. Перейдите в **Управление платформой**.

2. В левой боковой панели нажмите **Управление сетью** > **Балансировщик нагрузки**.

3. Нажмите ⋮ > **Обновить**.

4. Обновите сетевую и ресурсную конфигурацию по мере необходимости.

   - Пожалуйста, разумно установите спецификации в соответствии с требованиями бизнеса. Вы также можете обратиться к соответствующим [Как правильно распределить ресурсы CPU и памяти](../how_to/decide_performance_selection.mdx) за справкой.

   - **Внутренняя маршрутизация** поддерживает обновление только из состояния **Отключено** в состояние **Включено**.

5. Нажмите **Обновить**.

## Удаление балансировщика нагрузки с помощью веб-консоли

:::note
После удаления балансировщика нагрузки связанные порты и правила также будут удалены и не могут быть восстановлены.
:::

1. Перейдите в **Управление платформой**.

2. В левой боковой панели нажмите **Управление сетью** > **Балансировщик нагрузки**.

3. Нажмите ⋮ > **Удалить** и подтвердите.

## Удаление балансировщика нагрузки с помощью CLI

```shell
kubectl delete alb2 test-alb -n cpaas-system
```

## Настройка портов слушателя (Frontend)

Балансировщик нагрузки поддерживает получение запросов на подключение клиентов через порты слушателя и соответствующие протоколы, включая HTTPS, HTTP, gRPC, TCP и UDP.

## Предварительные требования

Если вам нужно добавить порт слушателя HTTPS, вам также следует обратиться к администратору, чтобы назначить TLS-сертификат текущему проекту для шифрования.

## Пример пользовательского ресурса Frontend (CR)

```yaml
# alb-frontend-demo.yaml
apiVersion: crd.alauda.io/v1
kind: Frontend
metadata:
  labels:
    alb2.cpaas.io/name: alb-demo # [!code callout]
  name: alb-demo-00080 # [!code callout]
  namespace: cpaas-system
spec:
  backendProtocol: "http"
  certificate_name: "" # [!code callout]
  port: 80
  protocol: http # [!code callout]
  serviceGroup: # [!code callout]
    services:
      - name: hello-world
        namespace: default
        port: 80
        weight: 100 # [!code callout]
```

<Callouts>
  1. Обязательно укажите экземпляр ALB, к которому принадлежит этот `Frontend`.
  2. Формат как `$alb_name-$port`.
  3. Формат как `$secret_ns/$secret_name`.
  4. Протокол этого `Frontend`.
     - `http|https|grpc|grpcs` для l7 прокси.
     - `tcp|udp` для l4 прокси.
  5. Для l4 прокси `serviceGroup` является обязательным. Для l7 прокси `serviceGroup` является необязательным. Когда запрос поступает, ALB сначала попытается сопоставить его с правилами, связанными с этим `Frontend`. Только если запрос не соответствует ни одному правилу, ALB затем перенаправит его на стандартную `serviceGroup`, указанную в конфигурации `Frontend`.
  6. Конфигурация `weight` применима к алгоритмам планирования Round Robin и Weighted Round Robin.
</Callouts>

:::note
ALB слушает входящие запросы и автоматически создает `Frontend` или правило. Поле `source` определяется следующим образом:

1. `spec.source.type` в настоящее время поддерживает только `ingress`.
2. `spec.source.name` — это имя ingress.
3. `spec.source.namespace` — это пространство имен ingress.

:::

## Создание портов слушателя (Frontend) с помощью веб-консоли

1. Перейдите в **Платформу контейнеров**.

2. В левой боковой панели нажмите **Сеть** > **Балансировка нагрузки**.

3. Нажмите на имя балансировщика нагрузки, чтобы перейти на страницу деталей.

4. Нажмите **Добавить порт слушателя**.

5. Ознакомьтесь с приведенными ниже инструкциями для настройки соответствующих параметров.

   | Параметр                  | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
   | -------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Протокол**               | Поддерживаемые протоколы включают HTTPS, HTTP, gRPC, TCP и UDP. При выборе HTTPS необходимо добавить сертификат; добавление сертификата является необязательным для протокола gRPC. <br /><br />**Примечание**: <br /><ul><li>При выборе протокола gRPC протокол обратной связи по умолчанию устанавливается в gRPC, который не поддерживает сохранение сеансов.</li><li>Если сертификат установлен для протокола gRPC, балансировщик нагрузки разгружает сертификат gRPC и перенаправляет нешифрованный трафик gRPC на бэкенд-сервис.</li><li>Если используется кластер Google GKE, балансировщик нагрузки одного и того же **типа сетевого контейнера** не может одновременно иметь как TCP, так и UDP порты слушателя.</li></ul> |
   | **Группа внутренней маршрутизации** | - Когда алгоритм балансировки нагрузки установлен на **Round Robin (RR)**, трафик будет распределяться по внутренним маршрутизационным портам в порядке группы внутренней маршрутизации. <br />- Когда алгоритм балансировки нагрузки установлен на **Weighted Round Robin (WRR)**, внутренние маршруты с более высокими значениями веса имеют более высокую вероятность быть выбранными; трафик будет распределяться по внутренним маршрутизационным портам на основе настроенного **веса**. <br />**Совет**: Расчет вероятности — это отношение текущего значения веса к сумме всех значений веса.                                                                                                             |
   | **Сохранение сеансов**    | Всегда перенаправляйте определенные запросы на бэкенд-сервис, соответствующий вышеупомянутой группе внутренней маршрутизации. <br /><br />Определенные запросы включают (выберите один):<ul><li>Хэш исходного адреса: Все запросы с одного IP-адреса. <br />**Примечание**: В публичных облачных средах исходный адрес часто меняется, что может привести к тому, что запросы от одного и того же клиента будут иметь разные исходные IP-адреса в разное время, что приведет к тому, что техника хэширования исходного адреса не достигнет ожидаемого эффекта.</li><li>Ключ cookie: Запросы, которые содержат указанный cookie.</li><li>Имя заголовка: Запросы, которые содержат указанный заголовок.</li></ul>                               |
   | **Протокол бэкенда**       | Протокол, используемый для перенаправления трафика на бэкенд-сервисы. Например, если перенаправление на бэкенд Kubernetes или dex сервисы, необходимо выбрать протокол HTTPS.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

6. Нажмите **ОК**.

## Создание портов слушателя (Frontend) с помощью CLI

```shell
kubectl apply -f alb-frontend-demo.yaml -n cpaas-system
```

## Последующие действия

Для трафика с портов HTTP, gRPC и HTTPS, помимо стандартной группы внутренней маршрутизации, вы можете установить более разнообразные правила соответствия бэкенд-сервисов [правила](#alb_add_rule). Балансировщик нагрузки сначала сопоставит соответствующий бэкенд-сервис в соответствии с установленными правилами; если сопоставление правила не удастся, он затем сопоставит бэкенд-сервисы, соответствующие вышеупомянутой группе внутренней маршрутизации.

## Связанные операции

Вы можете нажать на значок ⋮ с правой стороны страницы списка или нажать **Действия** в правом верхнем углу страницы деталей, чтобы обновить стандартный маршрут или удалить порт слушателя по мере необходимости.

:::note
Если метод распределения ресурсов балансировщика нагрузки установлен на **Порт**, только администраторы могут удалять связанные порты слушателя в представлении **Управление платформой**.
:::

# Настройка правил \{#alb\_rule}

Добавьте правила перенаправления для портов слушателя протоколов HTTPS, HTTP и gRPC. Балансировщик нагрузки будет сопоставлять бэкенд-сервисы на основе этих правил.

:::note
Правила перенаправления не могут быть добавлены для протоколов TCP и UDP.
:::

## Пример пользовательского ресурса правила \{#alb\_add\_rule}

```yaml
# alb-rule-demo.yaml
apiVersion: crd.alauda.io/v1
kind: Rule
metadata:
  labels:
    alb2.cpaas.io/frontend: alb-demo-00080 # [!code callout]
    alb2.cpaas.io/name: alb-demo #[!code callout]
  name: alb-demo-00080-test
  namespace: cpaas-system
spec:
  backendProtocol: "" #[!code callout]
  certificate_name: "" #[!code callout]
  dslx:
    - type: METHOD
      values:
        - - EQ
          - POST
    - type: URL
      values:
        - - STARTS_WITH
          - /app-a
        - - STARTS_WITH
          - /app-b
    - type: PARAM
      key: group
      values:
        - - EQ
          - vip
    - type: HOST
      values:
        - - ENDS_WITH
          - .app.com
    - type: HEADER
      key: LOCATION
      values:
        - - IN
          - east-1
          - east-2
    - type: COOKIE
      key: uid
      values:
        - - EXIST
    - type: SRC_IP
      values:
        - - RANGE
          - "1.1.1.1"
          - "1.1.1.100"
  enableCORS: false
  priority: 4 #[!code callout]
  serviceGroup: #[!code callout]
    services:
      - name: hello-world
        namespace: default
        port: 80
        weight: 100
```

<Callouts>
  1. Обязательно укажите `Frontend`, к которому принадлежит это правило.
  2. Обязательно укажите ALB, к которому принадлежит это правило.
  3. Как и `Frontend`.
  4. Как и `Frontend`.
  5. Чем меньше число, тем выше приоритет.
  6. Как и `Frontend`.
</Callouts>

### dslx

dslx — это язык, специфичный для домена, который используется для описания критериев соответствия.

Например, нижеуказанное правило соответствует запросу, который удовлетворяет всем следующим критериям:

- URL начинается с /app-a или /app-b
- Метод — POST
- Параметр URL с группой — vip
- Хост — \*.app.com
- Заголовок LOCATION — east-1 или east-2
- Существует cookie с именем uid
- Исходные IP-адреса находятся в диапазоне 1.1.1.1-1.1.1.100

```yaml
dslx:
  - type: METHOD
    values:
      - - EQ
        - POST
  - type: URL
    values:
      - - STARTS_WITH
        - /app-a
      - - STARTS_WITH
        - /app-b
  - type: PARAM
    key: group
    values:
      - - EQ
        - vip
  - type: HOST
    values:
      - - ENDS_WITH
        - .app.com
  - type: HEADER
    key: LOCATION
    values:
      - - IN
        - east-1
        - east-2
  - type: COOKIE
    key: uid
    values:
      - - EXIST
  - type: SRC_IP
    values:
      - - RANGE
        - "1.1.1.1"
        - "1.1.1.100"
```

## Создание правила с помощью веб-консоли

1. Перейдите в **Платформу контейнеров**.

2. Нажмите **Сеть** > **Балансировка нагрузки** в левой боковой панели.

3. Нажмите на имя балансировщика нагрузки.

4. Нажмите на имя порта слушателя.

5. Нажмите **Добавить правило**.

6. Ознакомьтесь с приведенными ниже описаниями для настройки соответствующих параметров.

   | Параметр                                | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
   | ---------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Группа внутреннего маршрута**                 | - Когда алгоритм балансировки нагрузки выбирает **Round Robin (RR)**, входящий трафик будет распределяться по портам внутренних маршрутов в порядке группы внутренних маршрутов.<br />- Когда алгоритм балансировки нагрузки выбирает **Weighted Round Robin (WRR)**, чем выше значение веса внутреннего маршрута, тем выше вероятность его выбора, и входящий трафик будет распределяться по портам внутренних маршрутов в соответствии с вероятностью, рассчитанной на основе настроенного **веса**.<br />**Совет**: Метод расчета вероятности — это отношение текущего значения веса к сумме всех значений веса.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
   | **Правило**                                 | Относится к критериям, по которым балансировщик нагрузки сопоставляет бэкенд-сервисы, включая индикаторы правил и их значения. Связь между различными индикаторами правил — это 'и'.<br /><ul><li>Имя домена: Поддерживает добавление **подстановочных доменов** и **точных доменных имен**. В случаях равного приоритета для одного и того же правила, если существуют как подстановочные, так и точные конфигурации доменных имен, правило перенаправления с точным доменным именем будет иметь приоритет.</li><li>URL: **RegEx** соответствует регулярным выражениям URL, начинающимся с `/`; **StartsWith** соответствует префиксам URL, начинающимся с `/`.</li><li>IP: **Равно** соответствует конкретному IP-адресу; **Диапазон** соответствует диапазону IP-адресов.</li><li>Заголовок: В дополнение к вводу ключа заголовка также необходимо установить правила соответствия. **Равно** соответствует конкретному значению заголовка; **Диапазон** соответствует диапазону значения заголовка; **RegEx** соответствует регулярному выражению заголовка.</li><li>Cookie: В дополнение к вводу ключа cookie также необходимо установить правила соответствия. **Равно** соответствует конкретному значению cookie.</li><li>Параметр URL: В правилах соответствия **Равно** соответствует конкретному параметру URL; **Диапазон** соответствует диапазону параметра URL.</li><li>Имя службы: Имя службы относится к имени службы, использующей протокол gRPC. При использовании протокола gRPC этот пункт можно настроить, что позволяет перенаправлять трафик на соответствующую службу на основе предоставленного имени службы, например: `/helloworld.Greeter`.</li></ul> |
   | **Сохранение сеансов**                  | Всегда перенаправляет определенные входящие запросы на бэкенд-сервисы, соответствующие вышеупомянутой группе внутренних маршрутов.<br />Определенные входящие запросы относятся к (выберите один):<ul><li>Хэш исходного адреса: Все входящие запросы, происходящие с одного IP-адреса.</li><li>Ключ cookie: Входящие запросы, содержащие указанный cookie.</li><li>Имя заголовка: Входящие запросы, содержащие указанный заголовок.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
   | **Перезапись URL**                          | Перезаписывает запрашиваемый адрес на адрес бэкенд-сервиса платформы. Эта функция требует настройки правила **StartsWith** для URL, и адрес перезаписи (rewrite-target) должен начинаться с */*. <br /><br />Например: После установки доменного имени на *bar.example.com* и начального пути URL на `/`, включив функциональность **Перезапись URL** и установив адрес перезаписи на */test*. Доступ к *bar.example.com* будет перезаписан на *bar.example.com/test*.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
   | **Протокол бэкенда**                     | Протокол, используемый для перенаправления входящего трафика на бэкенд-сервис. Например: Если перенаправление на бэкенд-сервис Kubernetes или dex, выберите протокол HTTPS.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
   | **Перенаправление**                          | Перенаправляет входящий трафик на новый адрес перенаправления, а не на бэкенд-сервисы, соответствующие группе внутренних маршрутов.<br />Например: Когда страница по исходному адресу доступа обновляется или изменяется, чтобы избежать получения пользователями страницы с ошибкой 404 или 503, трафик можно перенаправить на новый адрес с помощью конфигурации.<ul><li>HTTP-код состояния: Код состояния, представляемый пользователю браузером перед перенаправлением на новый адрес.</li><li>Адрес перенаправления: При вводе относительного адреса (например, */index.html*) цель перенаправленного трафика будет *адрес балансировщика нагрузки/index.html*; при вводе абсолютного адреса (например, *[https://www.example.com](https://www.example.com)*), цель перенаправленного трафика будет введенный адрес.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
   | **Приоритет правила**                        | Приоритет сопоставления правил: существует 10 уровней от 1 до 10, где 1 — самый высокий приоритет, а приоритет по умолчанию — 5.<br />Когда два или более правила удовлетворяют одновременно, выбирается правило с более высоким приоритетом; если приоритет одинаковый, система использует правило сопоставления по умолчанию.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | **Кросс-доменные ресурсы (CORS)** | CORS (Кросс-доменные ресурсы) — это механизм, который использует дополнительные HTTP-заголовки, чтобы указать браузеру, что веб-приложение, работающее на одном источнике (домене), может получать доступ к определенным ресурсам с другого сервера другого источника. Когда ресурс запрашивает другой ресурс, который находится на сервере с другим доменом, протоколом или портом, чем его собственный, он инициирует кросс-доменный HTTP-запрос.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
   | **Разрешенные источники**                      | Используется для указания источников, которым разрешен доступ. <ul><li>**\***: Разрешает запросы с любого источника.</li><li>**Имя домена**: Разрешает запросы с текущего домена.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
   | **Разрешенные заголовки**                      | Используется для указания заголовков HTTP-запросов, разрешенных в CORS (Кросс-доменные ресурсы), чтобы избежать ненужных предварительных запросов и повысить эффективность запросов. Примеры записей следующие:<br /><br />**Примечание**: Другие часто используемые или пользовательские заголовки запросов не будут перечислены здесь; пожалуйста, заполняйте в соответствии с фактическими условиями.<br /><br /><ul><li>**Origin**: Указывает источник запроса, т.е. домен, отправляющий запрос.</li><li>**Authorization**: Используется для указания информации об авторизации для запроса, обычно для идентификации, такой как базовая аутентификация или токен.</li><li>**Content-Type**: Используется для указания типа содержимого запроса/ответа, такого как application/json, application/x-www-form-urlencoded и т.д.</li><li>**Accept**: Используется для указания типов содержимого, которые клиент может принимать, обычно используется, когда клиент надеется получить ответ определенного типа.</li></ul><br />                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

7. Нажмите **Добавить**.

## Создание правила с помощью CLI

```shell
kubectl apply -f alb-rule-demo.yaml -n cpaas-system
```

## Логи и мониторинг

Сочетая визуализированные логи и данные мониторинга, можно быстро выявить и решить проблемы или сбои с балансировщиком нагрузки.

## Просмотр логов

1. Перейдите в **Управление платформой**.

2. В левой боковой панели нажмите **Управление сетью** > **Балансировщик нагрузки**.

3. Нажмите на ***Имя балансировщика нагрузки***.

4. На вкладке **Логи** просмотрите логи работы балансировщика нагрузки с точки зрения контейнера.

## Метрики мониторинга

:::note
Кластер, в котором находится балансировщик нагрузки, должен развернуть службы мониторинга.
:::

1. Перейдите в **Управление платформой**.

2. В левой боковой панели нажмите **Управление сетью** > **Балансировщик нагрузки**.

3. Нажмите на ***Имя балансировщика нагрузки***.

4. На вкладке **Мониторинг** просмотрите информацию о тенденциях метрик балансировщика нагрузки с точки зрения узла.

   - **Уровень использования**: Текущая загрузка CPU и памяти балансировщика нагрузки на текущем узле.

   - **Пропускная способность**: Общий входящий и исходящий трафик экземпляра балансировщика нагрузки.

## Дополнительные ресурсы

- [Мониторинг ALB](./monitor_request_metrics.mdx)
