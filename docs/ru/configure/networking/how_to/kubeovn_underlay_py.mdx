---
weight: 10
sourceSHA: eab0bf350dc823001ffbff2090044548508e2129405701542c787652f8d4904e
---

# Подготовка физической сети под Kube-OVN Underlay

Контейнерная сеть в режиме передачи Kube-OVN Underlay зависит от поддержки физической сети. Перед развертыванием сети Kube-OVN Underlay, пожалуйста, сотрудничайте с сетевым администратором для планирования и завершения соответствующих конфигураций физической сети заранее, обеспечивая сетевое подключение.

## Инструкции по использованию

Kube-OVN Underlay требует развертывания с несколькими сетевыми интерфейсными картами (NIC), и подсеть Underlay должна эксклюзивно использовать одну NIC. На этой NIC не должно быть других типов трафика, таких как SSH; они должны использовать другие NIC.

Перед использованием убедитесь, что сервер узла имеет как минимум **двойную NIC** среду, и рекомендуется, чтобы скорость NIC составила **как минимум 10 Гбит/с или выше** (например, 10 Гбит/с, 25 Гбит/с, 40 Гбит/с).

- NIC Один: NIC с маршрут по умолчанию, настроенный с IP-адресом, соединённый с интерфейсом внешнего коммутатора, который настроен в режиме Access.

- NIC Два: NIC без маршрута по умолчанию и без настроенного IP-адреса, соединённый с интерфейсом внешнего коммутатора, который настроен в режиме Trunk. Подсеть Underlay эксклюзивно использует NIC Два.

![](../../../../en/configure/networking/assets/ovnunderlay.png)

## Объяснение терминологии

VLAN (Виртуальная локальная сеть) — это технология, которая логически делит локальную сеть на несколько сегментов (или меньших LAN) для облегчения обмена данными для виртуальных рабочих групп.

Появление технологии VLAN позволяет администраторам логически сегментировать различных пользователей в одной и той же физической локальной сети в отдельные эфирные домены в зависимости от фактических потребностей приложения. Каждая VLAN включает группу рабочих станций с похожими требованиями и обладает теми же свойствами, что и физически сформированная LAN. Поскольку VLAN логически разделены, а не физически, рабочие станции в одной и той же VLAN не ограничены одной физической площадью; они могут находиться на различных физических сегментах LAN.

Основные преимущества VLAN включают:

- Сегментация портов. Даже на одном коммутаторе порты в разных VLAN не могут обмениваться данными. Физический коммутатор может функционировать как несколько логических коммутаторов. Это обычно используется для контроля взаимного доступа между различными отделами и площадками в сети.

- Сетевая безопасность. Разные VLAN не могут общаться напрямую, что устраняет небезопасность эфирной информации. Эфирный и одноадресный трафик в рамках VLAN не будут пересылаться в другие VLAN, помогая контролировать трафик, снижать инвестиции в оборудование, упрощать управление сетью и повышать сетевую безопасность.

- Гибкое управление. При изменении сетевой принадлежности пользователя нет необходимости в замене портов или кабелей; достаточно изменить конфигурацию программного обеспечения.

## Требования к среде

В режиме Underlay Kube-OVN соединяет физическую NIC с OVS и отправляет пакеты напрямую на внешний через эту физическую NIC. Возможности пересылки L2/L3 зависят от устройств underlying network. Соответствующий шлюз, VLAN и политики безопасности должны быть предварительно настроены на устройствах underlying network.

- **Требования к конфигурации сети**

  - Kube-OVN проверяет соединение шлюза через протокол ICMP при запуске контейнеров; underlying gateway должен отвечать на ICMP-запросы.

  - Для трафика доступа к сервисам Pods в первую очередь будут отправлять пакеты на шлюз, который должен иметь возможность пересылать пакеты обратно в локальную подсеть.

  - Когда коммутатор или мост имеет активированную функцию Hairpin, **Hairpin должен быть отключен**. Если использовать среду виртуальной машины VMware, установите **Net.ReversePathFwdCheckPromisc** на хосте VMware в **1**, и Hairpin не нужно отключать.

  - Сетевой адаптер для моста **не может** быть **Linux Bridge**.

  - Режимы объединения NIC поддерживают Режим 0 (balance-rr), Режим 1 (active-backup), Режим 4 (802.3ad), Режим 6 (balance-alb), с рекомендацией использовать 0 или 1. Другие режимы объединения не тестировались; пожалуйста, используйте их с осторожностью.

- **Требования к конфигурации уровня IaaS (Виртуализация)**

  - Для сред OpenStack VM необходимо отключить **PortSecurity** для соответствующего сетевого порта.

  - Для сети vSwitch от VMware все значения **MAC Address Changes**, **Forged Transmits** и **Promiscuous Mode Operation** должны быть установлены на **Accept**.

  - Для публичных облаков, таких как AWS, GCE и Alibaba Cloud, сети в режиме Underlay не поддерживаются из-за отсутствия возможностей для определения MAC-адресов пользователями.

## Пример конфигурации

Узлы в этом примере — это физические машины с двумя NIC. NIC Один — это NIC с маршрутом по умолчанию; NIC Два — это NIC без маршрута по умолчанию и без настроенного IP-адреса, которая эксклюзивно используется для подсети Underlay. NIC Два соединен с внешним коммутатором.

- Со стороны коммутатора интерфейс, соединенный с NIC Два, должен быть настроен в режиме Trunk, позволяя соответствующим VLAN проходить.

- Настройте адрес шлюза подсети кластера на соответствующем интерфейсе vlan-interface. Если требуется работа в двух стековом режиме, адрес IPv6 шлюза также может быть настроен одновременно.

- Если шлюз находится за брандмауэром, необходимо разрешить доступ для узлов к сети cluster-cidr.

- Для серверов NIC конфигурации не требуется.

### Конфигурация коммутатора

Настройте интерфейс VLAN:

```
#
interface Vlan-interface74
  ip address 192.168.74.254 255.255.255.0   //IPv4 адрес шлюза
  ipv6 address 2074::192:168:74:254/64  //IPv6 адрес шлюза
#
```

Настройте интерфейс, соединенный с NIC Два:

```
#
interface Ten-GigabitEthernet1/0/19
  port link mode bridge
  port link-type trunk  // Настройте интерфейс в режим Trunk
  undo port trunk permit vlan 1
  port trunk permit vlan 74  // Разрешите соответствующему VLAN проходить
#
```

### Проверка сетевого соединения

Проверьте, может ли NIC Два обмениваться данными с адресом шлюза:

```
ip link add ens224.74 link ens224 type vlan id 74  // Имя NIC - ens224, а ID VLAN - 74
ip link set ens224.74 up
ip addr add 192.168.74.200/24 dev ens224.74  // Выберите тестовый адрес в подсети Underlay, здесь это 192.168.74.200/24
ping 192.168.74.254  // Если удается пинговать шлюз, это подтверждает, что физическая среда соответствует требованиям развертывания
ip addr del 192.168.74.200/24 dev ens224.74  // Удалите тестовый адрес после проверки
ip link del ens224.74  // Удалите подинтерфейс после проверки
```

### Конфигурация платформы

В левом навигационном меню нажмите **Управление кластером > Кластер**, затем нажмите **Создать кластер**. Для конкретных шагов конфигурации, пожалуйста, обратитесь к документу [Создать кластер](), с конфигурацией контейнерной сети, показанной на изображении ниже.

**Примечание**: Подсеть Join не имеет практического значения в среде Underlay и в основном служит для создания Overlay подсети позже, обеспечивая диапазон IP-адресов, необходимый для связи между узлами и группами контейнеров.

![](../../../../en/configure/networking/assets/ovnunderlayexample.png)
