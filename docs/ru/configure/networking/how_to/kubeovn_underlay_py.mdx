---
weight: 10
sourceSHA: eab0bf350dc823001ffbff2090044548508e2129405701542c787652f8d4904e
---

# Подготовка физической сети Kube-OVN Underlay

Сетевая инфраструктура контейнеров в режиме Kube-OVN Underlay зависит от поддержки физической сети. Прежде чем развертывать сеть Kube-OVN Underlay, пожалуйста, совместно с администратором сети запланируйте и завершите соответствующие конфигурации физической сети заранее, чтобы обеспечить подключение к сети.

## Инструкции по эксплуатации

Kube-OVN Underlay требует развертывания с несколькими сетевыми интерфейсными картами (NIC), и подсеть Underlay должна использовать исключительно одну NIC. На этой NIC не должно быть других типов трафика, таких как SSH; они должны использовать другие NIC.

Перед использованием убедитесь, что сервер узла имеет как минимум среду с **двумя NIC** и рекомендуется, чтобы скорость NIC была **не менее 10 Гбит/с или выше** (например, 10 Гбит/с, 25 Гбит/с, 40 Гбит/с).

- NIC Один: NIC с маршрутом по умолчанию, сконфигурированная с IP-адресом, соединённая с интерфейсом внешнего коммутатора в режиме доступа.

- NIC Два: NIC без маршрута по умолчанию и не сконфигурированная с IP-адресом, соединённая с интерфейсом внешнего коммутатора в режиме транка. Подсеть Underlay использует исключительно NIC Два.

![](../../../../en/configure/networking/assets/ovnunderlay.png)

## Объяснение терминологии

VLAN (виртуальная локальная сеть) — это технология, которая логически разделяет локальную сеть на несколько сегментов (или меньших LAN) для облегчения обмена данными для виртуальных рабочих групп.

Появление технологии VLAN позволяет администраторам логически сегментировать различных пользователей внутри одной физической локальной сети на отдельные домены передачи широковещательной информации на основе реальных потребностей приложений. Каждая VLAN включает в себя группу компьютерных рабочих мест с похожими требованиями и обладает теми же свойствами, что и физически сформированная LAN. Поскольку VLAN логически разделены, а не физически, рабочие станции в одной VLAN не ограничены одной физической областью; они могут находиться в разных физических сегментах LAN.

Основные преимущества VLAN включают:

- Сегментация портов. Даже на одном коммутаторе порты в разных VLAN не могут связываться друг с другом. Физический коммутатор может функционировать как несколько логических коммутаторов. Это обычно используется для контроля взаимного доступа между различными отделами и площадками в сети.

- Сетевая безопасность. Разные VLAN не могут общаться напрямую, устраняя небезопасность широковещательной информации. Широковещательный и уникастный трафик в пределах VLAN не будет переадресован в другие VLAN, что помогает контролировать трафик, снижать инвестиции в оборудование, упрощать управление сетью и улучшать безопасность сети.

- Гибкое управление. При изменении сетевого статуса пользователя нет необходимости заменять порты или кабели; нужно лишь изменить конфигурацию программного обеспечения.

## Требования к окружающей среде

В режиме Underlay Kube-OVN соединяет физическую NIC с OVS и отправляет пакеты непосредственно наружу через эту физическую NIC. Возможности пересылки L2/L3 зависят от устройства сети. Соответствующие шлюз, VLAN и политики безопасности должны быть предварительно настроены на устройствах сети.

- **Требования к конфигурации сети**

  - Kube-OVN проверяет связь с шлюзом через протокол ICMP при запуске контейнеров; подлежащий шлюз должен реагировать на ICMP-запросы.

  - Для трафика доступа к сервису Pods сначала отправляют пакеты шлюзу, который должен иметь возможность перенаправлять пакеты обратно в локальную подсеть.

  - Когда у коммутатора или моста включена функция Hairpin, **Hairpin должен быть отключен**. Если используется среда виртуальных машин VMware, установите **Net.ReversePathFwdCheckPromisc** на хосте VMware на **1**, и Hairpin не нужно отключать.

  - Соединяющая NIC **не может** быть **Linux Bridge**.

  - Режимы объединения NIC поддерживают Mode 0 (balance-rr), Mode 1 (active-backup), Mode 4 (802.3ad), Mode 6 (balance-alb), рекомендуется использовать 0 или 1. Другие режимы объединения не были протестированы; используйте их с осторожностью.

- **Требования к конфигурации слоя IaaS (виртуализация)**

  - Для виртуальных машин в среде OpenStack необходимо отключить **PortSecurity** для соответствующего сетевого порта.

  - Для сетей vSwitch VMware параметры **MAC Address Changes**, **Forged Transmits** и **Promiscuous Mode Operation** должны быть установлены на **Accept**.

  - Для облачных сервисов, таких как AWS, GCE и Alibaba Cloud, сети в режиме Underlay не могут быть поддержаны из-за отсутствия возможностей пользовательских MAC-адресов.

## Пример конфигурации

Узлы в этом примере — это физические машины с двумя NIC. NIC Один — это NIC с маршрутом по умолчанию; NIC Два — это NIC без маршрута по умолчанию, не сконфигурированная с IP-адресом, используется исключительно для подсети Underlay. NIC Два соединен с внешним коммутатором.

- Со стороны коммутатора интерфейс, подключенный к NIC Два, должен быть настроен в режиме транка, позволяя соответствующим VLAN проходить.

- Настройте адрес шлюза подсети кластера на соответствующем vlan-interface. Если требуется поддержка двойного стека, также можно одновременно настроить адрес шлюза IPv6.

- Если шлюз находится за брандмауэром, необходимо разрешить доступ от узлов к сети cluster-cidr.

- Конфигурация для NIC сервера не требуется.

### Конфигурация коммутатора

Настройка VLAN интерфейса:

```
#
interface Vlan-interface74
  ip address 192.168.74.254 255.255.255.0   //IPv4 адрес шлюза
  ipv6 address 2074::192:168:74:254/64  //IPv6 адрес шлюза
#
```

Настройте интерфейс, подключенный к NIC Два:

```
#
interface Ten-GigabitEthernet1/0/19
  port link mode bridge
  port link-type trunk  // Настройте интерфейс в режиме транка
  undo port trunk permit vlan 1
  port trunk permit vlan 74  // Разрешите проход соответствующей VLAN
#
```

### Проверка сетевой связности

Проверьте, может ли NIC Два связаться с адресом шлюза:

```
ip link add ens224.74 link ens224 type vlan id 74  // Имя NIC - ens224, а ID VLAN - 74
ip link set ens224.74 up
ip addr add 192.168.74.200/24 dev ens224.74  // Выбор тестового адреса в подсети Underlay, здесь - 192.168.74.200/24
ping 192.168.74.254  // Если пинг шлюза успешен, это подтверждает, что физическая среда соответствует требованиям развертывания
ip addr del 192.168.74.200/24 dev ens224.74  // Удалите тестовый адрес после завершения теста
ip link del ens224.74  // Удалите подс-interface после тестирования
```

### Конфигурация платформы

В левом навигационном меню нажмите **Управление кластерами > Кластер**, затем нажмите **Создать кластер**. Для конкретных шагов конфигурации обратитесь к документу [Создание кластера](), с показанными ниже настройками сетевой контейнера.

**Примечание**: Подсеть Join не имеет практического значения в среде Underlay и в основном служит для создания подсети Overlay позже, предоставляя диапазон IP-адресов, необходимых для связи между узлами и контейнерными группами.

![](../../../../en/configure/networking/assets/ovnunderlayexample.png)
