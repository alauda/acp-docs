---
weight: 20
sourceSHA: af86fa9f4b100c66be68217ff6b7c6139b7ee27dc15522bd506827c55b019521
---

# Сеть Calico поддерживает шифрование WireGuard

Calico поддерживает шифрование WireGuard как для трафика IPv4, так и для IPv6, которое можно настроить независимо через параметры в ресурсе FelixConfiguration.

## Статус установки

### Обычная установка

| Операционная система                     | Версия ядра                            |
| ---------------------------------------- | -------------------------------------- |
| Linux                                    | 5.6 и выше установлены по умолчанию   |
| Ubuntu 20.04                             | 5.4.0-135-generic                      |
| Kylin Linux Advanced Server V10 - SP3  | 4.19.90-52.22.v2207.ky10.x86\_64      |

### Не установлено по умолчанию

| Операционная система                     | Версия ядра                           |
| ---------------------------------------- | ------------------------------------- |
| openEuler                                | 4.18.0-147.5.2.13.h996.eulerosv2r10.x86\_64 |
| CentOS 7                                 | 3.10.0-1160.el7.x86\_64                |
| Redhat 8.7                               | 4.18.0-425.3.1.el8.x86\_64             |
| Kylin Linux Advanced Server V10 - SP2   | 4.19.90-24.4.v2101.ky10.x86\_64        |
| Kylin Linux Advanced Server V10 - SP1   | 4.19.90-23.8.v2101.ky10.x86\_64        |
| Kylin Linux Advanced Server V10          | 4.19.90-11.ky10.x86\_64                |

## Терминология

| Термин                | Объяснение                                                        |
| --------------------- | ----------------------------------------------------------------- |
| **wireguardEnabled**   | Включить шифрование для трафика IPv4 через сеть IPv4 Underlay.  |
| **wireguardEnabledV6** | Включить шифрование для трафика IPv6 через сеть IPv6 Underlay.  |

## Замечания

1. При использовании плагина сети Calico убедитесь, что параметр `natOutgoing` установлен в `true`, чтобы поддерживать шифрование WireGuard. По умолчанию этот параметр правильно настраивается для подсети Calico при создании кластера, поэтому дополнительная настройка не требуется.

2. WireGuard поддерживает шифрование как для трафика IPv4, так и для IPv6; если необходимо зашифровать оба типа трафика, настройка должна быть выполнена отдельно. Для получения подробной информации о настройке параметров обратитесь к [Документации конфигурации Felix](https://docs.tigera.io/calico/latest/reference/resources/felixconfig#felix-configuration-definition), настроив параметры `wireguardEnabled` и `wireguardEnabledV6`.

3. Если WireGuard не установлен по умолчанию, обратитесь к [Руководству по установке WireGuard](https://www.wireguard.com/install/) для ручной установки, хотя могут быть случаи, когда ручная установка модуля WireGuard завершается неудачей.

4. Трафик между контейнерами на разных узлах будет зашифрован, включая сетевой трафик от одного хоста к другому; однако связь между Pod'ами на одном узле и трафик между Pod'ом и его хост-узлом не будет зашифрован.

## Предварительные требования

- WireGuard должен быть установлен на всех узлах кластера заранее. Для получения подробной информации обратитесь к [Документации по установке WireGuard](https://www.wireguard.com/install/). Узлы без установленного WireGuard не поддерживают шифрование.

## Шаги

1. Включите или отключите шифрование IPv4 и IPv6.

   **Примечание**: Следующие команды необходимо выполнять в инструменте CLI на узле Master, где находится узел.

   - Включить только шифрование IPv4

     ```
     kubectl patch felixconfiguration default --type='merge' -p '{"spec":{"wireguardEnabled":true}}'
     ```

   - Включить только шифрование IPv6

     ```
     kubectl patch felixconfiguration default --type='merge' -p '{"spec":{"wireguardEnabledV6":true}}'
     ```

   - Включить шифрование как для IPv4, так и для IPv6

     ```
     kubectl patch felixconfiguration default --type='merge' -p '{"spec":{"wireguardEnabled":true,"wireguardEnabledV6":true}}'
     ```

   - Отключить шифрование как для IPv4, так и для IPv6

     - Метод 1: Выполните команду в инструменте CLI, чтобы отключить шифрование.

       ```
       kubectl patch felixconfiguration default --type='merge' -p '{"spec":{"wireguardEnabled":false,"wireguardEnabledV6":false}}'
       ```

     - Метод 2: Измените конфигурационный файл felixconfiguration, чтобы отключить шифрование.

       1. Выполните следующую команду, чтобы открыть конфигурационный файл felixconfiguration.

          ```
          kubectl get felixconfiguration -o yaml default
          ```

       2. Установите параметры `wireguardEnabled` и `wireguardEnabledV6` в false, чтобы отключить шифрование WireGuard.

          ```yaml
          apiVersion: crd.projectcalico.org/v1
          kind: FelixConfiguration
          metadata:
            annotations:
              projectcalico.org/metadata: '{"uid":"f5facabd-8304-46d6-81c1-f1816235b487","creationTimestamp":"2024-08-06T03:46:51Z"}'
            generation: 2
            name: default
            resourceVersion: "890216"
          spec:
            bpfLogLevel: ""
            floatingIPs: Disabled
            logSeverityScreen: Info
            reportingInterval: 0s
            wireguardEnabled: false        # Измените на true, чтобы включить шифрование IPv4
            wireguardEnabledV6: false     # Измените на true, чтобы включить шифрование IPv6
          ```

2. После завершения настройки шифрования WireGuard в Calico выполните следующую команду, чтобы подтвердить статус шифрования WireGuard. Если шифрование как для IPv4, так и для IPv6 включено, наличие `wireguardPublicKey` или `wireguardPublicKeyV6` в поле `Status` указывает на успешную активацию; если шифрование как для IPv4, так и для IPv6 отключено, эти поля не будут содержать `wireguardPublicKey` или `wireguardPublicKeyV6`, что указывает на успешную деактивацию.

   ```
   calicoctl get node <NODE-NAME> -o yaml # Замените <NODE-NAME> на имя узла.
   ```

   Результат:

   ```
   Status:
       wireguardPublicKey: L/MUP9+Yxx/xxxxxxxxxxxx/xxxxxxxxxx =
   ```

## Проверка результата

В этом документе используется верификация трафика IPv4 в качестве примера; верификация трафика IPv6 аналогична IPv4 и не будет повторена здесь.

### Верификация трафика IPv4

1. После настройки шифрования WireGuard проверьте информацию о маршрутизации, где трафик между узлами предпочитает использовать интерфейс wireguard.cali для пересылки сообщений.

   ```bash
   root@test:~# ip rule   # Просмотр текущих правил маршрутизации
        0: from all lookup local
        99:  not from all fwmark 0x100000/0x100000 lookup 1    # Для всех пакетов, не помеченных как 0x100000, используйте таблицу маршрутизации 1 для поиска маршрута
        32766:  from all lookup main
        32767 :  from all lookup default
    
   root@test:~# ip route show table 1    # Отобразить маршруты для таблицы 1.
       10.3.138.0 dev wireguard.cali scope link
       10.3.138.0/26 dev wireguard.cali scope link
       throw 10.3.231.192
       10.3.236.128 dev wireguard.cali scope link     # Трафик для достижения IP-адреса 10.3.236.128 будет отправлен через интерфейс wireguard.cali
       10.3.236.128/26 dev wireguard.cali scope link
       throw 10.10.10.124/30
       10.10.10.200/30 dev wireguard.cali scope link
       throw 10.10.20.124/30
       10.10.20.200/30 dev wireguard.cali scope link
       throw
       10.13.138.0 dev wireguard.cali scope link
       10.13.138.0/26 dev wireguard.cali scope link
       throw 10.13.231.192/26
       10.13.236.128 dev wireguard.cali scope link
       10.13.236.128/26 dev wireguard.cali scope link

   root@test:~# ip r get 10.10.10.202    # Путь маршрутизации от текущего узла к целевому IP-адресу 10.10.10.202
       10.10.10.202 dev wireguard.cali table 1 src 10.10.10.127 uid 0  cache   # При доступе к целевому IP-адресу 10.10.10.202 из текущего узла пакет будет отправлен через интерфейс wireguard.cali, используя таблицу маршрутизации 1, а адрес источника будет установлен в 10.10.10.127

   root@test:~# ip route    # Показать основную таблицу маршрутизации
       default via 192.168.128.1 dev eth0 proto static
       10.3.138.0/26 via 10.3.138.0 dev vxlan.
       blackhole 10.3.231.193
       10.3.231.194
       10.3.231.195
       10.3.231.196
       10.3.231.197
       3.231.192/26 proto 80
       dev cali8dcd31cIdOO scope link
       dev cali3012b5b29b scope link
       dev calibeefea2ff87 scope link
       dev cali2b27d5e4053 scope link
       dev cali1a35dbdd639 scope link
       calico on link
   ```

2. Перехватите пакеты на узле, чтобы наблюдать за межузловым трафиком.

   ```bash
   root@test:~# ip a s wireguard.cali    # Просмотр подробной информации о сетевом интерфейсе wireguard.cali
       30: wireguard.cali: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1440 qdisc noqueue state UNKNOWN group default qlen 1000
       link/none
       inet 10.10.10.127/32 scope global wireguard.cali   # IP-адрес, назначенный интерфейсу wireguard.cali, равен 10.10.10.127
       valid_lft forever preferred_lft forever

   root@test:~# tcpdump -i wireguard.cali -nnve icmp   # Перехват и отображение ICMP-пакетов через wireguard.cali
       tcpdump: listening on wireguard.cali, link-type RAW (Raw IP), capture size 262144 bytes
       08:58:36.987559 ip: (tos 0x0, ttl 63, id 29731, offset 0, flags [DF], proto ICMP (1), length 84)
       10.10.10.125 > 10.10.10.202: ICMP echo request, id 1110, seq 0, length 64
       08:58:36.988683 ip: (tos 0x0, ttl 63, id 1800, offset 0, flags [none], proto ICMP (1), length 84)
       10.10.10.202 > 10.10.10.125: ICMP echo reply, id 1110, seq 0, length 64
       2 packets captured
       2 packets received by filter
       0 packets dropped by kernel
   ```

3. Тестирование показывает, что трафик типа IPv4 передается через интерфейс wireguard.cali.
