---
weight: 20
sourceSHA: 47e0e33c1efa2ad760b6dd27fba6cc902381096d04e5a8a74f322d30a3003121
---

# Сеть Calico поддерживает шифрование WireGuard

Calico поддерживает шифрование WireGuard как для IPv4, так и для IPv6 трафика, которое можно включить независимо с помощью параметров в ресурсе FelixConfiguration.

## Статус установки

### Установка по умолчанию

| Операционная система                      | Версия ядра                               |
| ----------------------------------------- | ----------------------------------------- |
| Linux                                     | 5.6 и выше установлены по умолчанию      |
| Ubuntu 20.04                              | 5.4.0-135-generic                        |
| Kylin Linux Advanced Server V10 - SP3    | 4.19.90-52.22.v2207.ky10.x86\_64        |

### Не установлено по умолчанию

| Операционная система                      | Версия ядра                                  |
| ----------------------------------------- | --------------------------------------------- |
| openEuler                                 | 4.18.0-147.5.2.13.h996.eulerosv2r10.x86\_64 |
| CentOS 7                                  | 3.10.0-1160.el7.x86\_64                      |
| Redhat 8.7                                | 4.18.0-425.3.1.el8.x86\_64                   |
| Kylin Linux Advanced Server V10 - SP2    | 4.19.90-24.4.v2101.ky10.x86\_64              |
| Kylin Linux Advanced Server V10 - SP1    | 4.19.90-23.8.v2101.ky10.x86\_64              |
| Kylin Linux Advanced Server V10           | 4.19.90-11.ky10.x86\_64                      |

## Терминология

| Термин                   | Объяснение                                                        |
| ------------------------ | ----------------------------------------------------------------- |
| **wireguardEnabled**     | Включить шифрование для IPv4 трафика через сеть IPv4 Underlay.  |
| **wireguardEnabledV6**   | Включить шифрование для IPv6 трафика через сеть IPv6 Underlay.  |

## Примечания

1. При использовании плагина сети Calico убедитесь, что параметр `natOutgoing` установлен в `true`, чтобы поддерживать шифрование WireGuard. По умолчанию этот параметр правильно настроен для подсети Calico при создании кластера, не требуя дополнительной конфигурации.

2. WireGuard поддерживает шифрование как для IPv4, так и для IPv6 трафика; если вам нужно зашифровать оба типа трафика, конфигурация должна быть выполнена отдельно. Для подробной настройки параметров обратитесь к [Документации по конфигурации Felix](https://docs.tigera.io/calico/latest/reference/resources/felixconfig#felix-configuration-definition), настроив параметры `wireguardEnabled` и `wireguardEnabledV6`.

3. Если WireGuard не установлен по умолчанию, обратитесь к [Руководству по установке WireGuard](https://www.wireguard.com/install/) для ручной установки, хотя могут быть случаи, когда ручная установка модуля WireGuard не удалась.

4. Трафик между контейнерами на разных узлах будет зашифрован, включая сетевой трафик от одного хоста к другому; однако связь между Pods на одном узле и трафик между Pod и его узлом-хостом не будут зашифрованы.

## Предварительные требования

- WireGuard должен быть установлен на всех узлах кластера заранее. Для получения подробной информации обратитесь к [Документации по установке WireGuard](https://www.wireguard.com/install/). Узлы без установленного WireGuard не поддерживают шифрование.

## Шаги

1. Включите или отключите шифрование IPv4 и IPv6.

   **Примечание**: Следующие команды должны быть выполнены в инструменте CLI на главном узле, где находится узел.

   - Включить только шифрование IPv4

     ```
     kubectl patch felixconfiguration default --type='merge' -p '{"spec":{"wireguardEnabled":true}}'
     ```

   - Включить только шифрование IPv6

     ```
     kubectl patch felixconfiguration default --type='merge' -p '{"spec":{"wireguardEnabledV6":true}}'
     ```

   - Включить шифрование как для IPv4, так и для IPv6

     ```
     kubectl patch felixconfiguration default --type='merge' -p '{"spec":{"wireguardEnabled":true,"wireguardEnabledV6":true}}'
     ```

   - Отключить шифрование как для IPv4, так и для IPv6

     - Метод 1: Выполните команду в инструменте CLI, чтобы отключить шифрование.

       ```
       kubectl patch felixconfiguration default --type='merge' -p '{"spec":{"wireguardEnabled":false,"wireguardEnabledV6":false}}'
       ```

     - Метод 2: Измените файл конфигурации felixconfiguration, чтобы отключить шифрование.

       1. Выполните следующую команду, чтобы открыть файл конфигурации felixconfiguration.

          ```
          kubectl get felixconfiguration -o yaml default
          ```

       2. Установите параметры `wireguardEnabled` и `wireguardEnabledV6` в false, чтобы отключить шифрование WireGuard.

          ```yaml
          apiVersion: crd.projectcalico.org/v1
          kind: FelixConfiguration
          metadata:
            annotations:
              projectcalico.org/metadata: '{"uid":"f5facabd-8304-46d6-81c1-f1816235b487","creationTimestamp":"2024-08-06T03:46:51Z"}'
            generation: 2
            name: default
            resourceVersion: "890216"
          spec:
            bpfLogLevel: ""
            floatingIPs: Disabled
            logSeverityScreen: Info
            reportingInterval: 0s
            wireguardEnabled: false        # Измените на true, чтобы включить шифрование IPv4
            wireguardEnabledV6: false     # Измените на true, чтобы включить шифрование IPv6
          ```

2. После завершения конфигурации шифрования Calico WireGuard выполните следующую команду, чтобы подтвердить статус шифрования WireGuard. Если шифрование IPv4 и IPv6 включено, наличие `wireguardPublicKey` или `wireguardPublicKeyV6` в поле `Status` указывает на успешную активацию; если шифрование IPv4 и IPv6 отключено, эти поля не будут содержать `wireguardPublicKey` или `wireguardPublicKeyV6`, что указывает на успешное отключение.

   ```
   calicoctl get node <NODE-NAME> -o yaml # Замените <NODE-NAME> на имя узла.
   ```

   Вывод:

   ```
   Status:
       wireguardPublicKey: L/MUP9+Yxx/xxxxxxxxxxxx/xxxxxxxxxx =
   ```

## Проверка результата

В этом документе используется проверка трафика IPv4 в качестве примера; проверка трафика IPv6 аналогична проверке IPv4 и не будет повторяться здесь.

### Проверка трафика IPv4

1. После настройки шифрования WireGuard проверьте информацию о маршрутизации, где трафик между узлами предпочтительно использует интерфейс wireguard.cali для пересылки сообщений.

   ```bash
   root@test:~# ip rule   # Просмотреть текущие правила маршрутизации
        0: from all lookup local
        99:  not from all fwmark 0x100000/0x100000 lookup 1    # Для всех пакетов, не помеченных как 0x100000, используйте таблицу маршрутизации 1 для поиска маршрутизации
        32766:  from all lookup main
        32767 :  from all lookup default
    
   root@test:~# ip route show table 1    # Отобразить записи маршрутизации для таблицы 1.
       10.3.138.0 dev wireguard.cali scope link
       10.3.138.0/26 dev wireguard.cali scope link
       throw 10.3.231.192
       10.3.236.128 dev wireguard.cali scope link     # Трафик для достижения IP-адреса 10.3.236.128 будет отправлен через интерфейс wireguard.cali
       10.3.236.128/26 dev wireguard.cali scope link
       throw 10.10.10.124/30
       10.10.10.200/30 dev wireguard.cali scope link
       throw 10.10.20.124/30
       10.10.20.200/30 dev wireguard.cali scope link
       throw
       10.13.138.0 dev wireguard.cali scope link
       10.13.138.0/26 dev wireguard.cali scope link
       throw 10.13.231.192/26
       10.13.236.128 dev wireguard.cali scope link
       10.13.236.128/26 dev wireguard.cali scope link

   root@test:~# ip r get 10.10.10.202    # Маршрут от текущего узла к целевому IP-адресу 10.10.10.202
       10.10.10.202 dev wireguard.cali table 1 src 10.10.10.127 uid 0  cache   # При доступе к целевому IP-адресу 10.10.10.202 с текущего узла пакет будет отправлен через интерфейс wireguard.cali, используя таблицу маршрутизации 1, а исходный адрес будет установлен на 10.10.10.127

   root@test:~# ip route    # Показать основную таблицу маршрутизации
       default via 192.168.128.1 dev eth0 proto static
       10.3.138.0/26 via 10.3.138.0 dev vxlan.
       blackhole 10.3.231.193
       10.3.231.194
       10.3.231.195
       10.3.231.196
       10.3.231.197
       3.231.192/26 proto 80
       dev cali8dcd31cIdOO scope link
       dev cali3012b5b29b scope link
       dev calibeefea2ff87 scope link
       dev cali2b27d5e4053 scope link
       dev cali1a35dbdd639 scope link
       calico on link
   ```

2. Захватите пакеты на узле, чтобы наблюдать за трафиком между узлами.

   ```bash
   root@test:~# ip a s wireguard.cali    # Просмотреть подробную информацию о сетевом интерфейсе wireguard.cali
       30: wireguard.cali: <POINTOPOINT,NOARP,UP,LOWER_UP> mtu 1440 qdisc noqueue state UNKNOWN group default qlen 1000
       link/none
       inet 10.10.10.127/32 scope global wireguard.cali   # IP-адрес, назначенный интерфейсу wireguard.cali, составляет 10.10.10.127
       valid_lft forever preferred_lft forever

   root@test:~# tcpdump -i wireguard.cali -nnve icmp   # Захват и отображение ICMP-пакетов через wireguard.cali
       tcpdump: listening on wireguard.cali, link-type RAW (Raw IP), capture size 262144 bytes
       08:58:36.987559 ip: (tos 0x0, ttl 63, id 29731, offset 0, flags [DF], proto ICMP (1), length 84)
       10.10.10.125 > 10.10.10.202: ICMP echo request, id 1110, seq 0, length 64
       08:58:36.988683 ip: (tos 0x0, ttl 63, id 1800, offset 0, flags [none], proto ICMP (1), length 84)
       10.10.10.202 > 10.10.10.125: ICMP echo reply, id 1110, seq 0, length 64
       2 packets captured
       2 packets received by filter
       0 packets dropped by kernel
   ```

3. Тестирование показывает, что трафик типа IPv4 пересылается через интерфейс wireguard.cali.
