---
weight: 20
sourceSHA: f86a2c65fd9b031b1e3f85204723146d2d9a0a8e4ccc5b3e6d5ecc55853af9f1
---

:::tip

Эта статья направит разработчиков на то, как интегрировать методы **получения TraceID** и **добавления TraceID в журналы приложений** в код приложения, что подходит для разработчиков бэкенда с некоторым опытом разработки.

:::

# Бизнес-журнал, связанный с TraceID

## Фон

- Для правильной ассоциации нескольких автоматически отправленных спанов (разные модули/узлы/сервисы, вызванные в рамках одного запроса) в единую трассу, заголовки HTTP-запросов сервиса будут включать TraceID и другую информацию, используемую для ассоциации трассы.

- Трасса представляет собой процесс вызова одного запроса, а TraceID — это уникальный идентификатор, идентифицирующий этот запрос. С помощью TraceID в журналах трассировка может быть связана с журналами приложения.

Основываясь на вышеизложенном фоне, эта статья объяснит, как получить TraceID из заголовков HTTP-запросов и добавить его в журналы приложений, что позволит вам точно запрашивать данные журнала на платформе с помощью TraceID.

## Добавление TraceID в журналы приложений Java

:::tip

- Следующие примеры основаны на фреймворке **Spring Boot** и используют **Log4j** и **Logback** для иллюстрации.

- Ваше приложение должно соответствовать следующим предварительным требованиям:

  - Тип и версия библиотеки журналирования должны соответствовать следующим требованиям:

    | Библиотека для журналирования | Требования к версии |
    | ------------------------------ | ------------------- |
    | **Log4j 1**                   | 1.2+                |
    | **Log4j 2**                   | 2.7+                |
    | **Logback**                   | 1.0+                |

  - В приложение был внедрен Java Agent.

:::

**Метод 1: Настройка `logging.pattern.level`**

Измените параметр `logging.pattern.level` в конфигурации вашего приложения следующим образом:

```
logging.pattern.level = trace_id=%mdc{trace_id}
```

**Метод 2: Настройка `CONSOLE_LOG_PATTERN`**

1. Измените файл конфигурации logback следующим образом.

   :::tip

   Консольный вывод используется в качестве примера, где `%X{trace_id}` указывает значение ключа `trace_id`, извлеченного из MDC.

   :::

   ```xml
   <property name="CONSOLE_LOG_PATTERN"
       value="${CONSOLE_LOG_PATTERN:-%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} [trace_id=%X{trace_id}] %clr(${LOG_LEVEL_PATTERN:-%5p}) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}"/>
   ```

2. В классе, где необходимо выводить логи, добавьте аннотацию `@Slf4j` и используйте объект лога для вывода логов, как показано ниже:

   ```java
   @RestController
   @Slf4j
   public class ProviderController {

       @GetMapping("/hello")
       public String hello(HttpServletRequest request) {
           log.info("request /hello");
           return "hello world";
       }
   }
   ```

## Добавление TraceID в журналы приложений Python

1. В коде приложения добавьте следующий код для извлечения TraceID из заголовков запроса. Пример кода приведен ниже и может быть скорректирован по мере необходимости:

   :::tip

   Функция **getForwardHeaders** извлекает трассировочную информацию из заголовков запроса, где значение `x-b3-traceid` — это TraceID.

   :::

   ```python
      def getForwardHeaders(request):
          headers = {}
          incoming_headers = [
              'x-request-id',  # Все приложения должны передавать x-request-id для журналов доступа и согласованных решений по трассировке/выборке журналов
              'x-b3-traceid',  # Заголовок трассировки B3, совместимый с конфигурациями Zipkin, OpenCensusAgent и Stackdriver
              'x-b3-spanid',
              'x-b3-parentspanid',
              'x-b3-sampled',
              'x-b3-flags',
          ]
          for ihdr in incoming_headers:
              val = request.headers.get(ihdr)
              if val is not None:
                  headers[ihdr] = val

          return headers
   ```

2. В коде приложения добавьте следующий код, чтобы включить полученный TraceID в логи. Пример кода приведен ниже и может быть скорректирован по мере необходимости:

   ```
   headers = getForwardHeaders(request)
   tracing_section = ' [%(x-b3-traceid)s,%(x-b3-spanid)s] ' % headers
   logging.info(tracing_section + "Oops, unexpected error happens.")
   ```

## Метод проверки

1. Нажмите на **Tracing** в левой панели навигации.

2. В критериях запроса выберите TraceID, введите TraceID для запроса и нажмите **Add to query**.

3. В представленных данных трассировки ниже нажмите **View Log** рядом с TraceID.

4. На странице **Log Query** отметьте **Contain Trace ID**; система будет отображать только данные журнала, содержащие TraceID.
