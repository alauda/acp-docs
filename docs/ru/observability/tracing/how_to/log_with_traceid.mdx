---
weight: 20
sourceSHA: f86a2c65fd9b031b1e3f85204723146d2d9a0a8e4ccc5b3e6d5ecc55853af9f1
---

:::tip

Эта статья поможет разработчикам освоить методы получения **TraceID** и **добавления TraceID в журналы приложения** в исходном коде приложения, подходящая для разработчиков бэкенда с некоторым опытом разработки.

:::

# Бизнес-журнал, связанный с TraceID

## Предпосылки

- Для правильной ассоциации нескольких автоматически отправленных спанов (разные модули/узлы/сервисы, вызванные во время одного запроса) в едином трассировочном запросе, HTTP-заголовки запроса сервиса будут включать TraceID и другую информацию, используемую для ассоциации трассировки.

- Трассировка представляет собой процесс вызова одного запроса, а TraceID – это уникальный идентификатор, идентифицирующий этот запрос. С помощью TraceID в журналах можно ассоциировать трассировку с журналами приложения.

Основываясь на вышеизложенных предпосылках, эта статья объяснит, как получить TraceID из HTTP-заголовков запроса и добавить его в журналы приложения, что позволит вам точно запрашивать данные журнала на платформе, используя TraceID.

## Добавление TraceID в журналы Java-приложения

:::tip

- Следующие примеры основаны на фреймворке **Spring Boot** и используют **Log4j** и **Logback** для иллюстрации.

- Ваше приложение должно соответствовать следующим предварительным условиям:

  - Тип и версия библиотеки ведения журналов должны соответствовать следующим требованиям:

    | Библиотека ведения журналов | Требование к версии |
    | ---------------------------- | ------------------- |
    | **Log4j 1**                 | 1.2+                |
    | **Log4j 2**                 | 2.7+                |
    | **Logback**                 | 1.0+                |

  - Приложение должно быть интегрировано с Java Agent.

:::

**Метод 1: Настройка `logging.pattern.level`**

Измените параметр `logging.pattern.level` в конфигурации вашего приложения следующим образом:

```
logging.pattern.level = trace_id=%mdc{trace_id}
```

**Метод 2: Настройка `CONSOLE_LOG_PATTERN`**

1. Измените файл конфигурации logback следующим образом.

   :::tip

   Здесь используется консольный вывод в качестве примера, где `%X{trace_id}` указывает значение ключа `trace_id`, полученного из MDC.

   :::

   ```xml
   <property name="CONSOLE_LOG_PATTERN"
       value="${CONSOLE_LOG_PATTERN:-%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} [trace_id=%X{trace_id}] %clr(${LOG_LEVEL_PATTERN:-%5p}) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}"/>
   ```

2. В классе, где необходимо выводить журналы, добавьте аннотацию `@Slf4j` и используйте объект журнала для вывода журналов, как показано ниже:

   ```java
   @RestController
   @Slf4j
   public class ProviderController {

       @GetMapping("/hello")
       public String hello(HttpServletRequest request) {
           log.info("request /hello");
           return "hello world";
       }
   }
   ```

## Добавление TraceID в журналы Python-приложения

1. В коде приложения добавьте следующий код для получения TraceID из заголовков запроса. Пример кода приведен ниже, его можно настроить по мере необходимости:

   :::tip

   Функция **getForwardHeaders** извлекает информацию трассировки из заголовков запроса, где значение `x-b3-traceid` является TraceID.

   :::

   ```python
      def getForwardHeaders(request):
          headers = {}
          incoming_headers = [
              'x-request-id',  # Все приложения должны передавать x-request-id для ведения журналов доступа и согласованной трассировки/решений по выбору журналов
              'x-b3-traceid',  # B3 заголовок трассировки, совместим с конфигурациями Zipkin, OpenCensusAgent и Stackdriver
              'x-b3-spanid',
              'x-b3-parentspanid',
              'x-b3-sampled',
              'x-b3-flags',
          ]
          for ihdr in incoming_headers:
              val = request.headers.get(ihdr)
              if val is not None:
                  headers[ihdr] = val

          return headers
   ```

2. В коде приложения добавьте следующий код для включения полученного TraceID в журналы. Пример кода приведен ниже, его можно настроить по мере необходимости:

   ```
   headers = getForwardHeaders(request)
   tracing_section = ' [%(x-b3-traceid)s,%(x-b3-spanid)s] ' % headers
   logging.info(tracing_section + "Oops, unexpected error happens.")
   ```

## Метод верификации

1. Щелкните на **Tracing** в левой боковой панели.

2. В критериях запроса выберите TraceID, введите TraceID для запроса и нажмите **Добавить в запрос**.

3. В отображаемых данных трассировки ниже нажмите **Просмотр журнала** рядом с TraceID.

4. На странице **Запрос журнала** установите флажок **Содержит Trace ID**; система будет отображать только те данные журналов, которые содержат TraceID.
