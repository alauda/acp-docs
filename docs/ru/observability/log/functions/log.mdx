---
weight: 20
sourceSHA: 6b985e1ba266fda02ad65e3a93f125dbaa50d954edee128020d7e8cb3e9b9a48
---

# Логи

## Анализ запросов логов

В панели анализа запросов логов центра операций вы можете просматривать стандартные выводные (stdout) логи учетной записи в рамках ее разрешений, включая системные логи, логи продукта, логи Kubernetes и логи приложений. С помощью этих логов вы можете получить представление об эксплуатации ресурсов.

- **Системные логи**: Логи с узлов хоста, такие как: dmesg, syslog/messages, secure и т. д.
- **Логи продукта**: Логи собственных компонентов платформы и сторонних компонентов, интегрированных с платформой, такие как: Container-Platform, Platform-Center, DevOps, Service-Mesh и т. д.
- **Логи Kubernetes**: Логи от связанных с контейнерной оркестрацией компонентов Kubernetes, а также логи, сгенерированные kubelet, kubeproxy и docker, такие как: docker, kube-apiserver, kube-controller-manager, etcd и т. д.
- **Логи приложений**: Логи бизнес-приложений, включая текстовые логи и стандартные выходные логи.

Условия запросов логов поддерживают фильтрацию логов в пределах указанного диапазона времени (либо выбранного, либо настраиваемого), и отображают результаты запроса через графики и стандартный вывод.

:::warning
Из соображений производительности платформа может отображать максимум 10 000 логов одновременно. Если объем логов на платформе слишком велик за определенный период времени, пожалуйста, сузьте временной диапазон запроса и выполняйте запросы логов поэтапно.
:::

### Поиск логов

1. В левом навигационном меню нажмите **Центр операций** > **Логи** > **Анализ запросов логов**.

2. Выберите указанный тип логов, условия запроса, введите ключевые слова содержимого логов, которые вы хотите получить, и затем нажмите **Поиск**.

:::tip

- Разные **Типы логов** позволяют использовать разные выбираемые условия запроса.

- Вы можете выбрать или ввести несколько тегов условий запроса; условия запроса для разных типов ресурсов находятся в AND-соотношении. Некоторые теги условий запроса поддерживают множественный выбор; пожалуйста, убедитесь, что вы нажали клавишу `Enter` после выбора, чтобы подтвердить параметры.

- Условия поиска содержимого логов поддерживают нечеткий поиск; например, условие поиска `pod = nginx` может извлечь логи для `nginx-1`, `nginx-2`.

- Условия поиска по содержимому логов используются только для получения ваших ключевых слов логов и поддерживают использование параметров `AND` и `OR` для ассоциативных запросов. Однако обратите внимание, что нельзя использовать параметры `AND` и `OR` одновременно в одном запросе.

- Гистограмма показывает общее количество логов в текущем временном диапазоне запроса и количество логов в разные временные точки. Нажмите на столбец в графике, чтобы просмотреть логи в временном интервале между этим столбцом и следующим.

:::

### Экспорт данных логов

Страница может отображать максимум 10 000 записей логов. Когда количество извлеченных логов слишком велико, вы можете использовать функцию экспорта логов, чтобы просмотреть до 1 миллиона записей логов.

1. Нажмите кнопку **Экспорт** в правом верхнем углу гистограммы и настройте следующие параметры в всплывающем диалоговом окне экспорта логов.

   - **Область**: Диапазон экспорта логов, вы можете выбрать **Текущая страница** или **Все результаты**.
     - **Текущая страница**: Экспортировать только результаты запроса на текущей странице, до 1 000 записей.
     - **Все результаты**: Экспортировать все данные логов, соответствующие текущим условиям запроса, до 1 миллиона записей.

   - **Поля**: Отображаемые поля логов. Вы можете выбрать, какую информацию поля отображать в экспортируемом файле логов, нажав на флажок рядом с именем поля.

     **Примечание**: Разные типы логов имеют разные выбираемые поля отображения, пожалуйста, выберите в соответствии с вашими реальными потребностями.

   - **Формат**: Формат экспорта файла логов, поддерживающий `txt` или `csv`. Платформа экспортирует в сжатом формате `gzip`.

2. Нажмите **Экспорт**, и браузер сразу скачавает сжатый файл на ваш локальный компьютер.

### Просмотр контекста логов

1. Дважды щелкните область содержимого логов, и текущее диалоговое окно отобразит 5 логов до и после текущего времени печати логов, помогая персоналу по эксплуатации и обслуживанию лучше понять причины, по которым были сгенерированы текущие логи ресурсами.

2. Вы можете настроить отображаемые поля контекста логов или экспортировать контекст логов. При экспорте контекста логов нет необходимости выбирать **Область**; нажав кнопку **Экспорт**, вы сразу скачаете файл контекста логов на ваш локальный компьютер через браузер.

## Управление временем хранения логов приложений

Когда проектная политика не установлена, время хранения логов приложений на платформе определяется `Временем хранения логов приложения` плагина **Log Storage**, установленного на **Хранилище кластеров**, выбранном при установке **ACP Log Collector** в кластер, где находятся приложения.

Вы можете различать время хранения **Логов приложений** на платформе, добавляя и управляя проектными политиками логов.

:::tip
Проектные политики применяются только к **Логам приложений** под конкретным проектом. После установки проектной политики время хранения всех логов приложений под этим проектом будет следовать проектной политике.
:::

### Администратор платформы устанавливает политики хранения

1. В левом навигационном меню нажмите **Центр операций** > **Логи** > **Управление политиками**.

2. Нажмите **Добавить проектную политику**.

3. Нажмите выпадающее меню для **Проект** и выберите проект.

4. Установите **Время хранения логов**.

   - Используйте кнопки `-`/`+` по обеим сторонам счетчика, чтобы уменьшить/увеличить дни хранения, или введите значение непосредственно в счетчике. Платформа позволяет устанавливать диапазон времени хранения от 1 до 30 дней.
   - Если введенное значение является десятичным, оно будет округлено до целого; если введенное значение меньше 1, оно будет округлено до 1, и кнопка `-` не будет активна; если введенное значение превышает 30, оно будет округлено до 30, и кнопка `+` не будет активна.

5. Нажмите **Добавить**.

### Администратор проекта устанавливает политики хранения

1. Перейдите на страницу деталей текущего проекта.

2. Нажмите кнопку редактирования рядом с полем политики логов, чтобы включить политику логов в всплывающем окне.

3. Установите **Время хранения логов**.

- Используйте кнопки `-`/`+` по обеим сторонам счетчика, чтобы уменьшить/увеличить дни хранения, или введите значение напрямую в счетчике. Платформа позволяет устанавливать диапазон времени хранения от 1 до 30 дней.
- Если введенное значение является десятичным, оно будет округлено до целого; если введенное значение меньше 1, оно будет округлено до 1, и кнопка `-` не будет активна; если введенное значение превышает 30, оно будет округлено до 30, и кнопка `+` не будет активна.

### Установить политики хранения через CLI

1. Войдите в кластер `global` и выполните следующую команду:

```bash
kubectl edit project <Имя проекта>
```

2. Измените yaml в соответствии с примером ниже, сохраните и отправьте.

```yaml
apiVersion: auth.alauda.io/v1
kind: Project
metadata:
  annotations:
    cpaas.io/creator: mschen1@alauda.io
    cpaas.io/description: ""
    cpaas.io/display-name: ""
    cpaas.io/operator: leizhuc
    cpaas.io/project.esPolicyLastEnabledTimestamp: "2025-02-18T09:53:54Z"
    cpaas.io/updated-at: "2025-02-18T09:53:54Z"
creationTimestamp: "2025-02-13T08:19:11Z"
finalizers:
- namespace
generation: 1
labels:
  cpaas.io/project: bookinfo
  cpaas.io/project.esIndicesKeepDays: "7" # Длительность хранения логов приложения под проектом
  cpaas.io/project.esPolicyEnabled: "true" # Включить проектную политику
  cpaas.io/project.id: "95447321"
  cpaas.io/project.level: "1"
  cpaas.io/project.parent: ""
name: bookinfo
### Дополнительная информация yaml, не связанная с изменением, опущена.
```

## Настроить частичное отсутствие логов приложений в сборе

Если вам нужно только просмотреть **Логи в реальном времени** определенных приложений в кластере, не желая хранить эти логи (коллектор отбросит соответствующие логи), вы можете обратиться к этому разделу, чтобы установить область остановки сбора логов (кластер, пространство имен, Pod) для тонкой настройки сбора логов приложений.

### Остановить сбор всех логов приложений в кластере

Вы можете обновить **Параметры конфигурации** **ACP Log Collector** кластера, чтобы отключить переключатель сбора **Логов приложений**, тем самым равномерно обновляя диапазон сбора логов для этого кластера. Как только переключатель сбора определенного типа логов отключен, он перестанет собирать все логи этого типа в текущем кластере.

### Остановить сбор логов приложений в конкретном пространстве имен

Вы можете отключить переключатель сбора логов для этого пространства имен, добавив метку `cpaas.io/log.mute=true` к указанному пространству имен, тем самым остановив сбор всех стандартных выходных логов и файловых логов для всех Pod в этом пространстве имен.

Дополнительные методы конфигурации таковы:

- **Метод командной строки**: После входа в любую управляющую ноду кластера выполните следующую команду, чтобы обновить метку пространства имен.

  ```bash
  kubectl label namespace <Имя пространства имен> cpaas.io/log.mute=true
  ```

- **Метод интерфейсной операции**: В представлении **Управление проектом** обновите метку пространства имен.

  1. В списке проектов представления **Управление проектом** нажмите на ***Имя проекта***, в котором находится пространство имен.

  2. В левом навигационном меню нажмите **Пространства имен**.

  3. Нажмите на ***Имя пространства имен***, метка которого должна быть обновлена.

  4. На вкладке **Детали** нажмите кнопку операции справа от **Меток**.

  5. Добавьте метку (Ключ: `cpaas.io/log.mute`, Значение: `true`) или измените значение существующей метки, затем нажмите **Обновить**.

### Остановить сбор логов Pod

Вы можете отключить переключатель сбора логов для указанного Pod, добавив метку `cpaas.io/log.mute=true`, тем самым остановив сбор стандартных выходных логов и файловых логов для этого Pod.

После входа в любую управляющую ноду кластера выполните следующую команду, чтобы обновить метку Pod.

```bash
kubectl label pod <Имя Pod> -n <Имя пространства имен> cpaas.io/log.mute=true
```

**Примечание**: Если Pod принадлежит вычислительному компоненту (Workload), вы можете обновить метки вычислительного компонента (Deployment, StatefulSet, DaemonSet, Job, CronJob), чтобы равномерно обновить метки всех Pod под вычислительным компонентом, и метки не будут потеряны даже после воссоздания Pod.

Вы можете обновить метки вычислительного компонента следующим образом.

1. В представлении продукта **Container Platform** нажмите на верхнюю навигацию, чтобы переключиться на пространство имен, где находится Pod.

2. В левом навигационном меню нажмите **Вычислительные компоненты** > ***Тип вычислительного компонента, к которому принадлежит Pod***.

3. Нажмите кнопку операции справа от вычислительного компонента, который нужно обновить > **Обновить**.

4. Нажмите **YAML** в правом верхнем углу, чтобы переключиться в режим редактирования YAML.

5. В поле **spec.template.labels** добавьте метку `cpaas.io/log.mute: 'true'`.

   Пример выглядит следующим образом:

   ```yaml
   spec:
     template:
       metadata:
         namespace: tuhao-test
         creationTimestamp: null
         labels:
           app: spilo
           cpaas.io/log.mute: 'true'
           cluster-name: acid-minimal-cluster
           role: exporter
           middleware.instance/name: acid-minimal-cluster
           middleware.instance/type: PostgreSQL
   ```

6. Нажмите **Обновить**.
