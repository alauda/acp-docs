---
weight: 10
sourceSHA: cc069a033cf791ffdc68fb02ca2906a8842d3ad3a7820b1cf3033e89cb01c887
---

# Резервное копирование и восстановление данных мониторинга Prometheus

## Обзор функции

Данные мониторинга Prometheus хранятся в формате TSDB (база данных временных рядов), поддерживая функции резервного копирования и восстановления. Данные мониторинга хранятся в определенном каталоге внутри контейнера Prometheus (указано в конфигурации `storage.tsdb.path`, по умолчанию равной `/prometheus`).

```yaml
template:
    spec:
      containers:
        - args:
            - '--storage.tsdb.path=/prometheus'     # Директория для хранения данных мониторинга в контейнере Prometheus
```

## Сценарии использования

- Сохранение исторических данных мониторинга во время миграции системы
- Предотвращение потери данных из-за неожиданных инцидентов
- Миграция данных мониторинга на новый экземпляр Prometheus

## Предварительные требования

- Плагин ACP Monitoring с Prometheus установлен (имя вычислительного компонента - `prometheus-kube-prometheus-0`, а тип - `StatefulSet`)
- Административные привилегии для кластера
- Убедитесь, что в целевом месте хранения достаточно места

## Процедуры выполнения операций

### Резервное копирование данных

Перед началом резервного копирования обратите внимание: Когда Prometheus хранит данные мониторинга, он сначала помещает собранные данные в кэш, а затем периодически записывает их в директорию хранения. Следующие методы резервного копирования используют директорию хранения в качестве источника данных, поэтому они не включают данные в кэше на момент резервного копирования.

#### Метод 1: Резервное копирование директории хранения (рекомендуется)

1. Используйте команду kubectl cp для резервного копирования:

```bash
kubectl cp -n cpaas-system prometheus-kube-prometheus-0-0:/prometheus -c prometheus <target storage path>
```

2. Резервное копирование из хранилища (в зависимости от типа хранилища, выбранного во время установки):

- **LocalVolume**: Скопируйте из директории `/cpaas/monitoring/prometheus`
- **PV**: Скопируйте из директории монтирования PV (рекомендуется установить политику **persistentVolumeReclaimPolicy** PV на `Retain`)
- **StorageClass**: Скопируйте из директории монтирования PV

#### Метод 2: Резервное копирование с помощью снимка

1. Включите Admin API:

```bash
kubectl edit -n cpaas-system prometheus kube-prometheus-0
```

Добавьте следующую конфигурацию:

```yaml
spec: 
  enableAdminAPI: true
```

**Примечание**: После обновления и сохранения конфигурации Pod Prometheus (имя Pod'а: prometheus-kube-prometheus-0-0) будет перезапущен. Подождите, пока все Pod'ы не перейдут в состояние Running, перед тем как продолжать с последующими операциями.

2. Создайте снимок:

```bash
curl -XPOST <Prometheus Pod IP>:9090/api/v1/admin/tsdb/snapshot
```

### Восстановление данных

1. Скопируйте резервные данные в контейнер Prometheus:

```bash
kubectl cp ./prometheus-backup cpaas-system/prometheus-kube-prometheus-0-0:/prometheus/
```

2. Переместите данные в указанную директорию:

```bash
kubectl exec -it -n cpaas-system prometheus-kube-prometheus-0-0 -c prometheus sh
mv /prometheus/prometheus-backup/* /prometheus/
```

**Упрощение**: Когда тип хранилища - **LocalVolume** во время установки плагина, просто скопируйте резервные данные напрямую в директорию `/cpaas/monitoring/prometheus/prometheus-db/` на узле, где установлен плагин.

## Результаты операций

- После завершения резервного копирования полные данные мониторинга в формате TSDB можно увидеть в целевой директории хранения
- После завершения восстановления Prometheus автоматически загрузит исторические данные мониторинга

## Узнать больше

### Описание формата данных TSDB

Пример структуры данных формата TSDB:

```
├── 01FXP317QBANGAX1XQAXCJK9DB
│   ├── chunks
│   │   └── 000001
│   ├── index
│   ├── meta.json
│   └── tombstones
├── chunks_head
│   ├── 000022
│   └── 000023
├── queries.active
└── wal
    ├── 00000020
    ├── 00000021
    ├── 00000022
    ├── 00000023
    └── checkpoint.00000019
        └── 00000000
```

### Соображения по резервному копированию данных

- Резервные данные не включают данные, находящиеся в кэше на момент резервного копирования
- Рекомендуется регулярно выполнять резервное копирование данных
- При использовании хранилища PV рекомендуется установить **persistentVolumeReclaimPolicy** на `Retain`

## Следующие процедуры

- Проверьте, были ли данные мониторинга правильно восстановлены
- Регулярно планируйте резервное копирование данных
- Если используется метод резервного копирования с помощью снимка, вы можете отключить Admin API
