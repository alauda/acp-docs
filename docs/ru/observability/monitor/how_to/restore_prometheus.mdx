---
weight: 10
sourceSHA: cc069a033cf791ffdc68fb02ca2906a8842d3ad3a7820b1cf3033e89cb01c887
---

# Резервное копирование и восстановление данных мониторинга Prometheus

## Обзор функции

Данные мониторинга Prometheus хранятся в формате TSDB (База данных временных рядов), поддерживающую функции резервного копирования и восстановления. Данные мониторинга хранятся по заданному пути в контейнере Prometheus (определяется конфигурацией `storage.tsdb.path`, по умолчанию равной `/prometheus`).

```yaml
template:
    spec:
      containers:
        - args:
            - '--storage.tsdb.path=/prometheus'     # Каталог для хранения данных мониторинга в контейнере Prometheus
```

## Сценарии использования

- Сохранение исторических данных мониторинга во время миграции системы
- Предотвращение потери данных из-за непредвиденных инцидентов
- Миграция данных мониторинга на новый экземпляр Prometheus

## Предварительные условия

- Плагин ACP Monitoring с Prometheus установлен (название вычислительного компонента — `prometheus-kube-prometheus-0`, тип — `StatefulSet`)
- Административные привилегии для кластера
- Убедитесь, что на целевом месте хранения достаточно места

## Процедуры выполнения

### Резервное копирование данных

Перед началом резервного копирования обратите внимание: Когда Prometheus сохраняет данные мониторинга, он сначала помещает собранные данные в кэш, а затем периодически записывает их в каталог хранения. Следующие методы резервного копирования используют каталог хранения в качестве источника данных, поэтому они не включают данные из кэша в момент резервного копирования.

#### Метод 1: Резервное копирование каталога хранения (рекомендуется)

1. Используйте команду kubectl cp для резервного копирования:

```bash
kubectl cp -n cpaas-system prometheus-kube-prometheus-0-0:/prometheus -c prometheus <путь к целевому хранилищу>
```

2. Резервное копирование из хранилища (в зависимости от типа хранилища, выбранного во время установки):

- **LocalVolume**: Копировать из каталога `/cpaas/monitoring/prometheus`
- **PV**: Копировать из каталога монтирования PV (рекомендуется установить **persistentVolumeReclaimPolicy** PV в значение `Retain`)
- **StorageClass**: Копировать из каталога монтирования PV

#### Метод 2: Резервное копирование с помощью снимка

1. Включите Admin API:

```bash
kubectl edit -n cpaas-system prometheus kube-prometheus-0
```

Добавьте конфигурацию:

```yaml
spec: 
  enableAdminAPI: true
```

**Примечание**: После обновления и сохранения конфигурации Pod Prometheus (имя Pod: prometheus-kube-prometheus-0-0) будет перезапущен. Дождитесь, пока все Pods перейдут в состояние Running, прежде чем продолжать последующие операции.

2. Создайте снимок:

```bash
curl -XPOST <IP-адрес Pod Prometheus>:9090/api/v1/admin/tsdb/snapshot
```

### Восстановление данных

1. Скопируйте резервные данные в контейнер Prometheus:

```bash
kubectl cp ./prometheus-backup cpaas-system/prometheus-kube-prometheus-0-0:/prometheus/
```

2. Переместите данные в указанный каталог:

```bash
kubectl exec -it -n cpaas-system prometheus-kube-prometheus-0-0 -c prometheus sh
mv /prometheus/prometheus-backup/* /prometheus/
```

**Упрощение**: Когда тип хранения **LocalVolume** во время установки плагина, просто скопируйте резервные данные напрямую в каталог `/cpaas/monitoring/prometheus/prometheus-db/` узла, на котором установлен плагин.

## Результаты операций

- После завершения резервного копирования полные данные мониторинга в формате TSDB можно увидеть по целевому пути хранилища
- После завершения восстановления Prometheus автоматически загрузит исторические данные мониторинга

## Узнайте больше

### Описание формата данных TSDB

Пример структуры данных формата TSDB:

```
├── 01FXP317QBANGAX1XQAXCJK9DB
│   ├── chunks
│   │   └── 000001
│   ├── index
│   ├── meta.json
│   └── tombstones
├── chunks_head
│   ├── 000022
│   └── 000023
├── queries.active
└── wal
    ├── 00000020
    ├── 00000021
    ├── 00000022
    ├── 00000023
    └── checkpoint.00000019
        └── 00000000
```

### Учетные записи резервного копирования данных

- Резервные данные не включают кэшированные данные на момент резервного копирования
- Рекомендуется регулярно выполнять резервное копирование данных
- При использовании PV-хранилища рекомендуется установить **persistentVolumeReclaimPolicy** в значение `Retain`

## Следующие шаги

- Проверьте, правильно ли восстановлены данные мониторинга
- Регулярно планируйте резервные копии данных
- Если используется метод резервного копирования с помощью снимка, вы можете отключить Admin API
