---
weight: 30
sourceSHA: a4f4c5f980fff964c2672fee6fd1ebefeba2afb4df453c352a191b65be5d6db6
---

# Управление уведомлениями

## Обзор функции

С помощью уведомлений вы можете интегрировать возможности мониторинга и оповещения платформы для своевременной отправки предварительной информации уведомления получателям, напоминая соответствующему персоналу о необходимости предпринять меры для решения проблем или предотвращения сбоев.

## Ключевые функции

- **Сервер уведомлений**: Сервер уведомлений предоставляет услуги по отправке уведомлений контактным группам на платформе, таким как сервер электронной почты.
- **Контактная группа уведомлений**: Контактная группа уведомлений — это набор получателей уведомлений с аналогичными логическими характеристиками, что может уменьшить вашу нагрузку по обслуживанию, позволяя классифицировать единицы, получающие сообщения уведомлений.
- **Шаблон уведомлений**: Шаблон уведомлений — это стандартизированная структура, состоящая из пользовательского контента, переменных контента и параметров формата контента. Он используется для стандартизации содержания и формата сообщений об оповещениях для стратегий уведомлений. Например, персонализация темы и содержания уведомлений по электронной почте.
- **Правило уведомлений**: Правило уведомлений — это набор правил, определяющих, как отправлять сообщения уведомлений конкретным контактам. Обязательно используйте правило уведомлений для случаев, таких как оповещения, инспекции и аутентификация входа, которые требуют уведомления внешних служб.

## Сервер уведомлений

Сервер уведомлений предоставляет услуги по отправке сообщений уведомлений получателям на платформе. В настоящее время платформа поддерживает следующие серверы уведомлений:

- **Сервер корпоративного коммуникационного инструмента**: Поддерживает интеграцию с WeChat Work, DingTalk и встроенными приложениями Feishu для отправки уведомлений отдельным лицам.
- **Сервер электронной почты**: Отправляет уведомления по электронной почте с использованием сервера электронной почты.
- **Сервер типа Webhook**: Поддерживает интеграцию с корпоративными ботами WeChat, ботами DingTalk, ботами Feishu или отправку WebHooks на ваш назначенный сервер.

:::warning
Можно добавить только один сервер корпоративного коммуникационного инструмента.
:::

### Сервер корпоративного коммуникационного инструмента

**WeChat Work**

1. Настройте параметры сервера уведомлений согласно приведенному ниже примеру. После заполнения параметров переключитесь на кластер `global` в **Управление кластерами** > **Управление ресурсами** и создайте объект ресурса.

   ```yaml
   # Методы получения corpId, corpSecret, agentId WeChat Work можно найти в официальной документации: https://developer.work.weixin.qq.com/document/path/90665
   apiVersion: v1
   kind: Secret
   type: NotificationServer
   metadata:
     labels:
       cpaas.io/notification.server.type: CorpWeChat
       cpaas.io/notification.server.category: Corp
     name: platform-corp-wechat-server
     namespace: cpaas-system
   data:
     displayNameZh: 企业微信            # Китайское отображение имени сервера по умолчанию закодировано в base64
     displayNameEn: WeChat             # Английское отображение имени сервера по умолчанию закодировано в base64
     corpId:                           # Корпоративный ID, закодированный в base64 по умолчанию
     corpSecret:                       # Секрет приложения, закодированный в base64 по умолчанию
     agentId:                          # ID корпоративного приложения, закодированный в base64 по умолчанию
   ```

2. После создания необходимо обновить **WeChat Work ID** пользователя в **Управление ролями пользователей** > **Управление пользователями** на платформе или в **Личной информации** пользователя, чтобы обеспечить нормальное получение сообщений.

**DingTalk**

1. Настройте параметры сервера уведомлений согласно приведенному ниже примеру. После заполнения параметров переключитесь на кластер `global` в **Управление кластерами** > **Управление ресурсами** и создайте объект ресурса.

   ```yaml
   # Метод получения appKey, appSecret, agentId DingTalk: https://open-dev.dingtalk.com/fe/app#/corp/app
   apiVersion: v1
   kind: Secret
   type: NotificationServer
   metadata:
     labels:
       cpaas.io/notification.server.type: CorpDingTalk
       cpaas.io/notification.server.category: Corp
     name: platform-corp-dingtalk-server
     namespace: cpaas-system
   data:
     displayNameZh: 钉钉                # Китайское отображение имени сервера по умолчанию закодировано в base64
     displayNameEn: DingTalk           # Английское отображение имени сервера по умолчанию закодировано в base64
     appKey:                           # Ключ приложения, закодированный в base64 по умолчанию
     appSecret:                        # Секрет приложения, закодированный в base64 по умолчанию
     agentId:                          # agent_id приложения, закодированный в base64 по умолчанию
   ```

2. После создания необходимо обновить **DingTalk ID** пользователя в **Управление ролями пользователей** > **Управление пользователями** на платформе или в **Личной информации** пользователя, чтобы обеспечить нормальное получение сообщений.

**Feishu**

1. Настройте параметры сервера уведомлений согласно приведенному ниже примеру. После заполнения параметров переключитесь на кластер `global` в **Управление кластерами** > **Управление ресурсами** и создайте объект ресурса.

   ```yaml
   # Методы получения appId, appSecret Feishu: https://open.feishu.cn/app/
   apiVersion: v1
   kind: Secret
   type: NotificationServer
   metadata:
     labels:
       cpaas.io/notification.server.type: CorpFeishu
       cpaas.io/notification.server.category: Corp
     name: platform-corp-feishu-server
     namespace: cpaas-system
   data:
     displayNameZh: 飞书                 # Китайское отображение имени сервера по умолчанию закодировано в base64
     displayNameEn: Feishu             # Английское отображение имени сервера по умолчанию закодировано в base64
     appId:                            # ID приложения, закодированный в base64 по умолчанию
     appSecret:                        # Секрет приложения, закодированный в base64 по умолчанию
   ```

2. После создания необходимо обновить **Feishu ID** пользователя в **Управление ролями пользователей** > **Управление пользователями** на платформе или в **Личной информации** пользователя, чтобы обеспечить нормальное получение сообщений.

### Сервер электронной почты

1. В левой боковой панели нажмите **Настройки платформы** > **Сервер уведомлений**.

2. Нажмите **Настроить сейчас**.

3. Ознакомьтесь со следующими инструкциями для настройки соответствующих параметров.

   | Параметр                 | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
   | ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
   | **Адрес службы**         | Адрес сервера уведомлений, поддерживающего протокол SMTP, например, `smtp.yeah.net`.                                                                                                                                                                                                                                                                                                                                                                              |
   | **Порт**                  | Номер порта для сервера уведомлений. Когда установлен флажок **Использовать SSL**, необходимо ввести номер порта SSL.                                                                                                                                                                                                                                                                                                                                                           |
   | **Конфигурация сервера**  | **Использовать SSL**: Secure Socket Layer (SSL) — это стандартная технология безопасности. Переключатель SSL используется для управления тем, необходимо ли устанавливать зашифрованное соединение между сервером и клиентом.<br />**Пропустить небезопасную проверку**: Переключатель insecureSkipVerify используется для управления тем, необходимо ли проверять сертификат клиента и имя хоста сервера. Если включено, сертификаты и соответствие между именем хоста в сертификате и именем хоста сервера не будут проверяться. |
   | **Электронная почта отправителя** | Электронная почта отправителя на сервере уведомлений, используемая для отправки уведомлений по электронной почте.                                                                                                                                                                                                                                                                                                                                                                             |
   | **Включить аутентификацию** | Если требуется аутентификация, пожалуйста, настройте имя пользователя и код авторизации для сервера электронной почты.                                                                                                                                                                                                                                                                                                                                                                |

4. Нажмите **ОК**.

### Сервер типа Webhook

Поддерживает интеграцию с корпоративными ботами WeChat, ботами DingTalk, ботами Feishu или отправку HTTP запросов на ваш назначенный сервер Webhook.

**Групповой бот корпоративного WeChat**

1. В левой боковой панели нажмите **Управление кластерами** > **Кластер**.

2. Нажмите кнопку операции рядом с кластером `global` > **CLI Tool**.

3. Выполните следующую команду на главном узле кластера `global`:

   ```bash
   kubectl patch secret -n cpaas-system platform-wechat-server -p '{"data":{"enable":"dHJ1ZQo="}}'
   ```

   **Совет**: `dHJ1ZQo=` — это закодированное в base64 значение true; для отключения замените `dHJ1ZQo=` на `ZmFsc2UK`, что является закодированным в base64 значением false.

**Групповой бот DingTalk**

1. В левой боковой панели нажмите **Управление кластерами** > **Кластер**.

2. Нажмите кнопку операции рядом с кластером `global` > **CLI Tool**.

3. Выполните следующую команду на главном узле кластера `global`:

   ```bash
   kubectl patch secret -n cpaas-system platform-dingtalk-server -p '{"data":{"enable":"dHJ1ZQo="}}'
   ```

   **Совет**: `dHJ1ZQo=` — это закодированное в base64 значение true; для отключения замените `dHJ1ZQo=` на `ZmFsc2UK`, что является закодированным в base64 значением false.

**Групповой бот Feishu**

1. В левой боковой панели нажмите **Управление кластерами** > **Кластер**.

2. Нажмите кнопку операции рядом с кластером `global` > **CLI Tool**.

3. Выполните следующую команду на главном узле кластера `global`:

   ```bash
   kubectl patch secret -n cpaas-system platform-feishu-server -p '{"data":{"enable":"dHJ1ZQo="}}'
   ```

   **Совет**: `dHJ1ZQo=` — это закодированное в base64 значение true; для отключения замените `dHJ1ZQo=` на `ZmFsc2UK`, что является закодированным в base64 значением false.

**Webhook сервер**

1. В левой боковой панели нажмите **Управление кластерами** > **Кластер**.

2. Нажмите кнопку операции рядом с кластером `global` > **CLI Tool**.

3. Выполните следующую команду на главном узле кластера `global`:

   ```bash
   kubectl patch secret -n cpaas-system platform-webhook-server -p '{"data":{"enable":"dHJ1ZQo="}}'
   ```

   **Совет**: `dHJ1ZQo=` — это закодированное в base64 значение true; для отключения замените `dHJ1ZQo=` на `ZmFsc2UK`, что является закодированным в base64 значением false.

## Контактная группа для уведомлений \{#recipient}

Контактная группа для уведомлений — это набор получателей уведомлений с аналогичными логическими характеристиками. Например, вы можете установить команду обслуживания в качестве контактной группы для уведомлений для упрощения выбора и управления при настройке стратегий уведомлений.

:::info

1. Платформа поддерживает различные серверы уведомлений, и соответствующие параметры настройки типов уведомлений будут отображаться на основе конфигурации сервера уведомлений.
2. Если вам необходимо использовать сервер типа Webhook в качестве получателя уведомлений, необходимо настроить соответствующий URL в контактной группе уведомлений.

:::

1. В левой боковой панели нажмите **Центр операций** > **Уведомления**.

2. Переключитесь на вкладку **Контактная группа уведомлений**.

3. Нажмите **Создать контактную группу уведомлений** и настройте соответствующие параметры согласно приведённым ниже инструкциям.

   | Параметр                                                            | Описание                                                                                                                                                                                                             |
   | -------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Электронная почта**                                               | Добавьте электронную почту в контактную группу уведомлений. Платформа будет отправлять уведомления на эту электронную почту и на все адреса электронной почты в группе.                                           |
   | **Webhook URL/Бот WeChat/Бот DingTalk/Бот Feishu**                 | Пожалуйста, заполните соответствующий URL метода уведомлений в зависимости от настроенного сервера уведомлений. После настройки контакты в этой группе будут уведомлены с помощью этого метода.                    |
   | **Настройка контактов**                                             | Нажмите **Добавить контакт**, чтобы добавить существующих пользователей платформы в контактную группу. Убедитесь в точности контактной информации выбранных контактов (телефон, электронная почта, интерфейсный колбек), чтобы избежать пропуска уведомлений. |

4. Нажмите **Добавить**.

## Шаблон уведомлений \{#template}

Шаблон уведомлений — это стандартизированная структура, состоящая из пользовательского контента, переменных контента и параметров формата контента. Он используется для стандартизации содержания и формата сообщений оповещений для стратегий уведомлений.

Администраторы платформы или персонал операций могут устанавливать шаблоны уведомлений для персонализации содержимого и формата сообщений уведомлений в зависимости от различных методов уведомлений, что помогает пользователям быстро получать критическую информацию об оповещениях и повышать оперативную эффективность.

:::info
Платформа поддерживает различные серверы уведомлений, и соответствующие шаблоны типов уведомлений будут отображаться в соответствии с конфигурацией сервера уведомлений. Если сервер уведомлений не настроен, соответствующие шаблоны уведомлений по умолчанию отображаться не будут.
:::

### Создание шаблона уведомлений

1. В левой боковой панели нажмите **Центр операций** > **Уведомления**.

2. Переключитесь на вкладку **Шаблон уведомлений**.

3. Нажмите **Создать шаблон уведомлений**.

4. В разделе **Основная информация** настройте следующие параметры.

   | Параметр        | Описание                                                                                                                                                                                                                                                                                                                    |
   | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
   | **Тип сообщения** | Выберите тип сообщения в зависимости от цели уведомления.<br />**Сообщение об оповещении**: Отправляет сообщения об оповещениях, вызванные правилами оповещений, совместно с функциональностью оповещения платформы;<br />**Сообщение об исключении компонента**: Отправляет уведомления, вызванные исключениями в определенных компонентах. |

5. В разделе **Настройка шаблона** укажите различные типы шаблонов для конфигурации переменных и параметров форматирования содержимого.

:::info

1. Содержимое шаблона может состоять только из переменных, имен переменных отображения и специальных языков разметки форматирования, поддерживаемых платформой. Переменные и другие элементы могут быть свободно комбинированы, если они соответствуют синтаксическим правилам.
2. В шаблоне могут использоваться только переменные, поддерживаемые платформой. Вы можете изменить имена переменных отображения и форматы содержимого, но не можете изменять саму переменную. Смотрите [Справочные переменные](#varibales) и [Специальный язык разметки форматирования в электронной почте](#email).
3. Платформа предоставляет содержимое шаблона уведомлений по умолчанию для различных типов уведомлений на основе фактических операционных сценариев, что может удовлетворить большинство потребностей в настройке сообщений уведомлений. Если нет особых требований, вы можете напрямую использовать содержимое шаблона по умолчанию.

:::

6. Нажмите **Создать**.

### Справочные переменные \{#varibales}

Переменные — это ключи меток или аннотаций в сообщениях уведомления (NotificationMessage), отформатированные как `{{.labelKey}}`. Чтобы облегчить пользователям получение ключевой информации, переменным можно назначать пользовательские имена отображения; например: `Уровень тревоги: {{ .externalLabels.severity }}`.

Когда правило уведомлений отправляет сообщения уведомлений пользователям на основе шаблона уведомлений, переменные в шаблоне будут ссылаться на соответствующие значения меток в сообщении уведомления (фактические данные мониторинга). В конечном итоге данные мониторинга будут отправлены пользователям в стандартизированном формате содержимого.

Платформа предоставляет следующие основные переменные по умолчанию:

| Имя для отображения      | Переменная                                                                    | Описание                                                                           |
| ----------------------- | --------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| **Статус тревоги**      | `{{ .externalLabels.status }}`                                              | Например: Оповещение.                                                              |
| **Уровень тревоги**     | `{{ .externalLabels.severity }}`                                            | Например: Критический.                                                              |
| **Кластер тревоги**     | `{{ .labels.alert_cluster }}`                                               | Например: Кластер 1, где произошло оповещение.                                    |
| **Объект тревоги**      | `{{ .externalLabels.object }}`                                              | Тип и имя ресурса, где произошло оповещение, например, узел 192.168.16.53. |
| **Имя правила**         | `{{ .labels.alert_resource }}`                                              | Имя правила тревоги, например, cpaas-node-rules.                                   |
| **Описание тревоги**    | `{{ .externalLabels.summary }}`                                             | Описание правила тревоги.                                                          |
| **Срабатывающее значение** | `{{ .externalLabels.currentValue }}`                                        | Мониторируемое значение, которое вызвало тревогу.                                 |
| **Время тревоги**       | `{{ dateFormatWithZone .startsAt "2006-01-02 15:04:05" "Asia/Chongqing" }}` | Время начала тревоги.                                                              |
| **Время восстановления** | `{{ dateFormatWithZone .endsAt "2006-01-02 15:04:05" "Asia/Chongqing" }}`   | Время окончания тревоги.                                                            |
| **Имя метрики**         | `{{ .labels.alert_indicator }}`                                             | Имя мониторинговой метрики.                                                      |

### Специальный язык разметки форматирования в электронной почте \{#email}

В уведомлениях по электронной почте общие HTML-теги формата и их инструкции приведены в таблице ниже:

| Элемент контента | Тег                                                                   | Описание                                     |
| ---------------- | --------------------------------------------------------------------- | --------------------------------------------- |
| **Текст**        | -                                                                     | Поддерживает ввод текстового содержимого на китайском/английском. |
| **Шрифт**        | `<font color="#FF0000">Установите цвет шрифта</font>`<br />`<b>Жирный шрифт</b>` | Установите формат шрифта.                     |
| **Заголовок**    | `<h1>Заголовок 1 уровня</h1>`, поддерживает до h6 (заголовок 6).   | Установите уровень заголовка.                  |
| **Параграф**     | `<p>Параграф</p>`                                                    | Вставить обычный текст параграфа.             |
| **Цитата**       | `<q>Цитата</q>`                                                      | Вставить краткое цитированное содержимое.    |
| **Гиперссылка**   | `<a href="//www.example.com">Гиперссылка</a>`                       | Вставить гиперссылку.                         |

## Правило уведомлений \{#notification}

Правило уведомлений — это совокупность правил, определяющих, как отправлять сообщения уведомлений конкретным контактам. Обязательно используйте стратегии уведомлений для случаев, требующих уведомления внешних служб, таких как оповещения, инспекции и аутентификация входа.

:::info
Платформа поддерживает различные серверы уведомлений, и режимы уведомлений, соответствующие типам уведомлений, будут отображаться в зависимости от конфигурации сервера уведомлений. Если сервер уведомлений не настроен, соответствующие режимы уведомлений по умолчанию отображаться не будут.
:::

### Предварительные условия

Чтобы использовать **Сервер корпоративного коммуникационного инструмента** для уведомления контактов, пользователи должны сначала обновить информацию о контактах в **Личной информации**, введя свой `WeChat Work ID`.

### Процедуры операций

1. В левой боковой панели нажмите **Центр операций** > **Уведомления**.

2. Нажмите **Создать правило уведомления** и настройте соответствующие параметры согласно следующим инструкциям.

   | Параметр                      | Описание                                                                                                                                                                                                                                                                                                 |
   | ------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Контактная группа уведомлений** | Контактная группа уведомлений — это логический набор получателей уведомлений, которые платформа уведомит с использованием указанного метода уведомлений.                                                                                                                                                           |
   | **Получатели уведомлений**    | Выберите добавление одного или нескольких получателей уведомлений, и платформа будет отправлять уведомления в соответствии с контактными методами **Личной информации** получателей.                                                                                                                                          |
   | **Метод уведомления**        | Поддерживает несколько методов, включая **WeChat Work**, **DingTalk**, **Feishu**, **Групповой бот корпоративного WeChat**, **Групповой бот DingTalk**, **Групповой бот Feishu**, **Webhook URL**, и поддерживает несколько выборов.<br />**Примечание**: Некоторые параметры будут отображаться после настройки сервера уведомлений. |
   | **Шаблон уведомлений**      | Выберите шаблон уведомлений для отображения информации об уведомлениях.                                                                                                                                                                                                                                       |

3. Нажмите **Создать**.

## Настройка правила уведомлений для проектов

Стратегии уведомлений платформы, шаблоны уведомлений и контактные группы уведомлений изолированы по арендаторам. В качестве администратора проекта вы не сможете просматривать или использовать стратегии уведомлений, шаблоны уведомлений или контактные группы уведомлений, настроенные другими проектами или администраторами платформы. Поэтому вам необходимо обратиться к этому документу, чтобы настроить подходящие стратегии уведомлений для вашего проекта.

### Предварительные условия

1. Вы связались с администратором платформы для завершения настройки сервера уведомлений.

2. Если вам необходимо уведомлять через корпоративные коммуникационные инструменты, также необходимо убедиться, что уведомляемые контакты правильно настроили свои ID коммуникационных инструментов в **Личной информации**.

### Процедуры операций

1. В представлении **Управление проектом** нажмите ***Имя проекта***.

2. В левой боковой панели нажмите **Уведомления**.

3. Переключитесь на вкладку **Контактная группа уведомлений**, обратитесь к [Контактной группе уведомлений](#recipient), чтобы создать контактную группу уведомлений.

:::tip
Если вам не нужно управлять контактами уведомлений через контактную группу уведомлений или не нужно уведомлять сервер типа webhook, вы можете пропустить этот шаг.
:::

4. Переключитесь на вкладку **Шаблон уведомлений**, обратитесь к [Шаблону уведомлений](#template), чтобы создать шаблон уведомлений.

5. Переключитесь на вкладку **Правило уведомлений**, обратитесь к [Правилу уведомлений](#notification), чтобы создать правило уведомлений.
