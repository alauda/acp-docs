---
weight: 50
sourceSHA: fd927eba4ca7353ade0f40c2282be9a4a2e8f0bf8d650b3dd0c1cf3015a8fe69
---

# Управление зондом

## Обзор функций

Функция зонда платформы реализована на основе Blackbox Exporter, позволяя пользователям производить зондирование сети через ICMP, TCP или HTTP для быстрой идентификации неисправностей, возникающих на платформе.

В отличие от мониторинга в режиме "white-box", который опирается на различные метрики мониторинга, уже доступные на платформе, "blackbox" мониторинг сосредоточен на результатах. Когда мониторинг в режиме "white-box" не может охватить все факторы, влияющие на доступность услуг, мониторинг в режиме "blackbox" может быстро обнаруживать неисправности и выдавать оповещения на основе этих неисправностей. Например, если конечная точка API ненормальна, мониторинг в режиме "blackbox" может оперативно выявить такие проблемы для пользователей.

:::warning

Функция зондирования не поддерживает использование ICMP для обнаружения IPv6-адресов на узлах с версиями ядра 3.10 и ниже. Чтобы использовать этот сценарий, пожалуйста, обновите версию ядра на узле до 3.11 или выше.

:::

## Мониторинг Blackbox

Для создания элемента мониторинга "blackbox" вы можете выбрать метод зондирования ICMP, TCP или HTTP для периодического зондирования заданного целевого адреса.

### Предварительные условия

Компоненты мониторинга должны быть установлены в кластере, и компоненты мониторинга должны функционировать правильно.

### Процедура выполнения

1. В левой навигационной панели нажмите **Центр операций** > **Мониторинг** > **Мониторинг Blackbox**.

   **Совет**: Мониторинг blackbox является функцией на уровне кластера. Нажмите на верхнюю панель навигации для переключения между кластерами.

2. Нажмите **Создать элемент мониторинга Blackbox**.

3. Ознакомьтесь с следующими инструкциями для настройки соответствующих параметров.

   | Параметр                | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
   |-------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | **Метод зондирования**  | **ICMP**: Зондирует, отправляя ping на имя домена или IP-адрес, введенный в **Целевой адрес**, для проверки доступности сервера.<br />**TCP**: Зондирует бизнес-порт хоста, прослушивая `<domain:port>` или `<IP:port>`, указанные в **Целевом адресе**.<br />**HTTP**: Зондирует URL, введенный в **Целевой адрес**, для проверки доступности веб-сайта.<br /> **Совет**: Метод зондирования HTTP поддерживает только запросы GET по умолчанию; для запросов POST, пожалуйста, обратитесь к [Настройка модуля мониторинга BlackboxExporter](#Blackbox2). |
   | **Интервал зондирования** | Временной интервал для зондирования.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
   | **Целевой адрес**       | Целевой адрес для зондирования, максимум 128 символов.<br /> Формат ввода целевого адреса варьируется в зависимости от метода зондирования:<br /> **ICMP**: Имя домена или IP-адрес, например, `10.165.94.31`.<br /> **TCP**: `<domain:port>` или `<IP:port>`, например, `172.19.155.133:8765`.<br /> **HTTP**: URL, начинающийся с http или https, например, `http://alauda.cn/`.                                                                                                                                                          |

4. Нажмите **Создать**.

   После успешного создания вы сможете видеть последние результаты зондирования в реальном времени на странице списка, и на основе элементов мониторинга blackbox вы можете [создать политики оповещения](#Blackbox1). Когда обнаруживается неисправность, автоматически срабатывает оповещение, чтобы уведомить соответствующих лиц для решения проблемы.

:::warning

После успешного создания элементов мониторинга blackbox системе требуется около 5 минут для синхронизации конфигурации. В течение этого периода синхронизации зондирование не будет происходить, и результаты зондирования не могут быть просмотрены.

:::

## Оповещения Blackbox \{#Blackbox1}

### Предварительные условия

- Компоненты мониторинга должны быть установлены в кластере, и компоненты мониторинга должны функционировать правильно.

- Элемент мониторинга blackbox должен быть успешно создан, и система должна завершить синхронизацию конфигурации, чтобы результаты зондирования были видны на странице мониторинга blackbox.

### Процедура выполнения

1. В левой навигационной панели нажмите **Центр операций** > **Оповещения** > **Политики оповещения**.

   **Совет**: Политики оповещения являются функцией на уровне кластера. Нажмите на верхнюю панель навигации для переключения между кластерами. Пожалуйста, убедитесь, что вы переключены на кластер, где только что был настроен элемент мониторинга blackbox.

2. Нажмите **Создать политику оповещения**.

3. Ознакомьтесь с следующими инструкциями для настройки соответствующих параметров; для получения дополнительной информации о параметрах, пожалуйста, обратитесь к [Создать политики оповещения](./manage_alert.md#alert_ui).

- **Тип оповещения**: Пожалуйста, выберите **Ресурсное оповещение**.

- **Тип ресурса**: Пожалуйста, выберите **Кластер**.

- Нажмите **Добавить правило оповещения**.

  - **Тип оповещения**: Пожалуйста, выберите **Оповещение Blackbox**.

  - **Элемент мониторинга Blackbox**: Пожалуйста, выберите требуемый элемент мониторинга blackbox.

  - **Имя метрики**: Пожалуйста, выберите метрику, которую вы хотите мониторить и по которой хотите получать оповещения. Текущие поддерживаемые метрики платформой — **Состояние подключения** и **Код состояния HTTP**.

    - **Состояние подключения**: Эту метрику можно выбрать для всех элементов мониторинга blackbox, где триггерное условие **“!= 1”** указывает на то, что целевой адрес элемента мониторинга blackbox недоступен.

    - **Код состояния HTTP**: Эту метрику можно выбрать, когда метод зондирования выбранного элемента мониторинга blackbox — **HTTP**. Вы можете ввести положительное целое число из трех цифр в качестве значения для триггерного условия, например, если условие установлено на **“> 299”**, это означает, что оповещения срабатывают, когда коды ответа — 3XX, 4XX или 5XX.

  - **Политика уведомлений**: Пожалуйста, выберите вашу предварительно настроенную политику.

  - Нажмите **Добавить**.

4. Нажмите **Создать**. После отправки политики оповещения вы сможете увидеть эту политику оповещения в списке политик оповещения.

## Настройка модуля мониторинга BlackboxExporter \{#Blackbox2}

Вы также можете улучшить функциональность мониторинга blackbox, добавив настраиваемые модули мониторинга в файл конфигурации BlackboxExporter. Например, добавив модуль **http\_post\_2xx** в файл конфигурации, когда метод зондирования мониторинга blackbox установлен на `HTTP`, он сможет зондировать статусы POST-запросов.

Файл конфигурации для мониторинга blackbox находится в пространстве имен, где установлен компонент Prometheus кластера, с именем по умолчанию `cpaas-monitor-prometheus-blackbox-exporter`, которое можно изменить в зависимости от фактического имени.

:::tip
Этот файл конфигурации является ресурсом ConfigMap, связанным с пространством имен, который можно быстро просмотреть и обновить через функцию управления платформой **Управление кластером > Управление ресурсами**.
:::

### Процедура выполнения

1. Обновите файл конфигурации мониторинга blackbox, добавив настраиваемые модули мониторинга к **key** `modules`.

   В качестве примера добавления модуля **http\_post\_2xx**:

   ```yaml
     blackbox.yaml: |
       modules:           
         http_post_2xx:                    # Модуль зондирования HTTP POST                                  
           prober: http
           timeout: 5s
           http:
             method: POST                 # Метод запроса для зондирования
             headers:
               Content-Type: application/json
             body: '{}'                   # Содержимое тела, отправляемое с зондом
   ```

   Для полного примера YAML файла конфигурации мониторинга blackbox, пожалуйста, обратитесь к [Справочной информации](#Blackbox3).

2. Активируйте конфигурацию, выбрав один из следующих методов.

   - Перезапустите компонент Blackbox Exporter **cpaas-monitor-prometheus-blackbox-exporter**, удалив его Pod.

   - Выполните следующую команду, чтобы вызвать API перезагрузки и обновить файл конфигурации:

     ```bash
     curl -X POST -v <Pod IP>:9115/-/reload     
     ```

## Создание элементов мониторинга и оповещений Blackbox через CLI

### Предварительные условия

- Политики уведомлений должны быть настроены (если вы требуете автоматические уведомления об оповещениях).
- Целевой кластер должен иметь установленные компоненты мониторинга.

### Процедура выполнения

1. Создайте новый YAML файл конфигурации с именем `example-probe.yaml`.
2. Добавьте ресурс PrometheusRule в YAML файл и отправьте его. Следующий пример создаёт новую политику оповещения с именем `prometheus-liveness`:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: Probe
metadata:
  annotations:
    cpaas.io/creator: jhshi@alauda.io                    # Автор элемента зонда
    cpaas.io/updated-at: "2021-05-25T08:08:45Z"          # Время последнего обновления элемента зонда
    cpaas.io/display-name: "Prometheus prober"           # Описание элемента зонда
  creationTimestamp: "2021-05-10T02:04:33Z"              # Время создания элемента зонда
  labels:
    prometheus: kube-prometheus                          # Значение метки, используемое для имени prometheus
  name: prometheus-liveness                              # Имя элемента зонда
  namespace: cpaas-system                                # Пространство имен, используемое для пространства имен prometheus
spec:
  jobName: prometheus-liveness                           # Имя элемента зонда
  prober:
    url: cpaas-monitor-prometheus-blackbox-exporter:9115 # URL для метрик Blackbox, полученных из особенностей
  module: http_2xx                                       # Имя модуля элемента зонда
  targets:
    staticConfig:
      static:
      - http://www.prometheus.io                         # Целевой адрес элемента зонда
      labels:
        module: http_2xx                                 # Имя модуля элемента зонда
        prober: http                                     # Метод зондирования элемента зонда
  interval: 30s                                          # Интервал зондирования для элемента зонда
  scrapeTimeout: 10s   
```

3. Создайте новый YAML файл конфигурации с именем `example-alerting-rule.yaml`.
4. Добавьте ресурс PrometheusRule в YAML файл и отправьте его. Следующий пример создаёт новую политику оповещения с именем `policy`:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    alert.cpaas.io/cluster: global      # Имя кластера, в котором находится оповещение
    alert.cpaas.io/kind: Cluster        # Тип ресурса
    alert.cpaas.io/name: global         # Имя кластера, где находится элемент мониторинга blackbox
    alert.cpaas.io/namespace: cpaas-system  # Пространство имен, используемое для пространства имен prometheus, оставьте по умолчанию
    alert.cpaas.io/notifications: '["test"]'
    alert.cpaas.io/repeat-config: '{"Critical":"never","High":"5m","Medium":"5m","Low":"5m"}'
    alert.cpaas.io/rules.description: "{}"
    alert.cpaas.io/rules.disabled: "[]"
    alert.cpaas.io/subkind: ""
    cpaas.io/description: ""
    cpaas.io/display-name: policy      # Отображаемое имя политики оповещения
  labels:
    alert.cpaas.io/owner: System
    alert.cpaas.io/project: cpaas-system
    cpaas.io/source: Platform
    prometheus: kube-prometheus
    rule.cpaas.io/cluster: global
    rule.cpaas.io/name: policy
    rule.cpaas.io/namespace: cpaas-system
  name: policy
  namespace: cpaas-system
spec:
  groups:
    - name: general # Имя правил оповещения
      rules:
        - alert: cluster.blackbox.probe.success-y97ah-9833444d918cab96c43e9ab6efc172cf
          annotations:
            alert_current_value: "{{ $value }}"  # Текущее значение для уведомления, оставьте по умолчанию
          expr: max by (job, instance) (probe_success{job=~"test",
            instance=~"https://demo.at-servicecenter.com/"})!=1
            # Сценарий оповещения о доступности, убедитесь, что вы изменили имя элемента мониторинга blackbox и целевой адрес
          for: 30s # Длительность
          labels:
            alert_cluster: global # Имя кластера, в котором находится оповещение
            alert_for: 30s # Длительность
            alert_indicator: cluster.blackbox.probe.success  # Оставьте без изменений
            alert_indicator_aggregate_range: "0" # Оставьте без изменений
            alert_indicator_blackbox_instance: https://demo.at-servicecenter.com/ # Целевой адрес мониторинга blackbox
            alert_indicator_blackbox_name: test # Имя элемента мониторинга blackbox
            alert_indicator_comparison: "!="  # Оставьте конфигурацию без изменений для оповещений о доступности
            alert_indicator_query: ""  # Используется для оповещений о журнале, нет необходимости настраивать этот параметр
            alert_indicator_threshold: "1"  # Порог для правила оповещения, 1 указывает на доступность, оставьте без изменений
            alert_indicator_unit: ""  # Единица метрики правила оповещения
            alert_involved_object_kind: Cluster   # Оставьте без изменений для оповещений blackbox
            alert_involved_object_name: global   # Кластер, где находится элемент мониторинга blackbox
            alert_involved_object_namespace: ""  # Пространство имен объекта, к которому относится правило оповещения
            alert_name: cluster.blackbox.probe.success-y97ah  # Имя правила оповещения
            alert_namespace: cpaas-system  # Пространство имен, где находится правило оповещения
            alert_project: cpaas-system  # Имя проекта объекта, к которому относится правило оповещения
            alert_resource: policy # Имя политики оповещения, где находится правило оповещения
            alert_source: Platform # Тип данных для правила оповещения: Platform - данные платформы, Business - бизнес-данные
            severity: High # Уровень правила оповещения: Critical - катастрофа, High - серьезно, Medium - предупреждение, Low - совет
         - alert: cluster.blackbox.http.status.code-235el-99b0095b6b6669415043e14ae84f43bc
          annotations:
            alert_current_value: "{{ $value }}"
            alert_notifications: '["message"]'
          expr: max by(job, instance) (probe_http_status_code{job=~"test",
            instance=~"https://demo.at-servicecenter.com/"})>200
            # Сценарий оповещения по коду состояния HTTP, убедитесь, что вы изменили имя элемента мониторинга blackbox и целевой адрес
          for: 30s
          labels:
            alert_cluster: global
            alert_for: 30s
            alert_indicator: cluster.blackbox.http.status.code
            alert_indicator_aggregate_range: "0"
            alert_indicator_blackbox_instance: https://demo.at-servicecenter.com/
            alert_indicator_blackbox_name: test
            alert_indicator_comparison: ">" 
            alert_indicator_query: ""
            alert_indicator_threshold: "299" # Порог для правил оповещения, в сценариях оповещения по коду состояния HTTP это должно быть трехзначное число, например, состояния больше 299 (3XX, 4XX, 5XX) указывают на ошибку
            alert_indicator_unit: ""
            alert_involved_object_kind: Cluster
            alert_involved_object_name: global
            alert_involved_object_namespace: ""
            alert_involved_object_options: Single
            alert_name: cluster.blackbox.http.status.code-235el
            alert_namespace: cpaas-system
            alert_project: cpaas-system
            alert_resource: policy33
            alert_source: Platform
            severity: High
```

## Справочная информация \{#Blackbox3}

Полный пример файла конфигурации YAML для мониторинга blackbox выглядит следующим образом:

```yaml
apiVersion: v1
data:
  blackbox.yaml: |
    modules:
      http_2xx_example:               # Пример зондирования HTTP
        prober: http
        timeout: 5s                   # Время ожидания для зондирования
        http:
          valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]                   # Версия в возвращаемой информации, по умолчанию
          valid_status_codes: []  # По умолчанию 2xx                       # Диапазон допустимых кодов ответа; если возвращаемый код находится в этом диапазоне, это считается успешным зондом
          method: GET                 # Метод запроса
          headers:                    # Заголовки запроса
            Host: vhost.example.com
            Accept-Language: en-US
            Origin: example.com
          no_follow_redirects: false  # Указывает, разрешить ли перенаправления
          fail_if_ssl: false   
          fail_if_not_ssl: false
          fail_if_body_matches_regexp:
            - "Не удалось подключиться к базе данных"
          fail_if_body_not_matches_regexp:
            - "Скачайте последнюю версию здесь"
          fail_if_header_matches: # Проверяет, что не установлены никакие cookies
            - header: Set-Cookie
              allow_missing: true
              regexp: '.*'
          fail_if_header_not_matches:
            - header: Access-Control-Allow-Origin
              regexp: '(\*|example\.com)'
          tls_config:                  # Конфигурация TLS для запросов https
            insecure_skip_verify: false
          preferred_ip_protocol: "ip4" # по умолчанию "ip6"                 # Предпочитаемая версия протокола IP
          ip_protocol_fallback: false  # Нет возврата к "ip6"            
      http_post_2xx:                   # Пример зондирования HTTP с телом
        prober: http
        timeout: 5s
        http:
          method: POST                 # Метод запроса для зондирования
          headers:
            Content-Type: application/json
          body: '{"username":"admin","password":"123456"}'                   # Тело, передаваемое при зондировании
      http_basic_auth_example:         # Пример зондирования с именем пользователя и паролем
        prober: http
        timeout: 5s
        http:
          method: POST
          headers:
            Host: "login.example.com"
          basic_auth:                  # Имя пользователя и пароль для добавления во время зондирования
            username: "username"
            password: "mysecret"
      http_custom_ca_example:
        prober: http
        http:
          method: GET
          tls_config:                  # Указать корневой сертификат для использования во время зондирования
            ca_file: "/certs/my_cert.crt"
      http_gzip:
        prober: http
        http:
          method: GET
          compression: gzip            # Метод сжатия, используемый во время зондирования
      http_gzip_with_accept_encoding:
        prober: http
        http:
          method: GET
          compression: gzip
          headers:
            Accept-Encoding: gzip
      tls_connect:                     # Пример TCP зондирования
        prober: tcp
        timeout: 5s
        tcp:
          tls: true                    # Указывает, использовать ли TLS
      tcp_connect_example:
        prober: tcp
        timeout: 5s
      imap_starttls:                   # Пример конфигурации зондирования для IMAP почтовых серверов
        prober: tcp
        timeout: 5s
        tcp:
          query_response:
            - expect: "OK.*STARTTLS"
            - send: ". STARTTLS"
            - expect: "OK"
            - starttls: true
            - send: ". capability"
            - expect: "CAPABILITY IMAP4rev1"
      smtp_starttls:                   # Пример конфигурации зондирования для SMTP почтовых серверов
        prober: tcp
        timeout: 5s
        tcp:
          query_response:
            - expect: "^220 ([^ ]+) ESMTP (.+)$"
            - send: "EHLO prober\r"
            - expect: "^250-STARTTLS"
            - send: "STARTTLS\r"
            - expect: "^220"
            - starttls: true
            - send: "EHLO prober\r"
            - expect: "^250-AUTH"
            - send: "QUIT\r"
      irc_banner_example:
        prober: tcp
        timeout: 5s
        tcp:
          query_response:
            - send: "NICK prober"
            - send: "USER prober prober prober :prober"
            - expect: "PING :([^ ]+)"
              send: "PONG ${1}"
            - expect: "^:[^ ]+ 001"
      icmp_example:                    # Пример конфигурации для ICMP зондирования
        prober: icmp
        timeout: 5s
        icmp:
          preferred_ip_protocol: "ip4"
          source_ip_address: "127.0.0.1"
      dns_udp_example:                 # Пример DNS запросов с использованием UDP
        prober: dns
        timeout: 5s
        dns:
          query_name: "www.prometheus.io"                 # Доменное имя для разрешения
          query_type: "A"              # Тип, соответствующий доменному имени
          valid_rcodes:
          - NOERROR
          validate_answer_rrs:
            fail_if_matches_regexp:
            - ".*127.0.0.1"
            fail_if_all_match_regexp:
            - ".*127.0.0.1"
            fail_if_not_matches_regexp:
            - "www.prometheus.io.\t300\tIN\tA\t127.0.0.1"
            fail_if_none_matches_regexp:
            - "127.0.0.1"
          validate_authority_rrs:
            fail_if_matches_regexp:
            - ".*127.0.0.1"
          validate_additional_rrs:
            fail_if_matches_regexp:
            - ".*127.0.0.1"
      dns_soa:
        prober: dns
        dns:
          query_name: "prometheus.io"
          query_type: "SOA"
      dns_tcp_example:               # Пример DNS запросов с использованием TCP
        prober: dns
        dns:
          transport_protocol: "tcp" # по умолчанию "udp"
          preferred_ip_protocol: "ip4" # по умолчанию "ip6"
          query_name: "www.prometheus.io"
kind: ConfigMap
metadata:
  annotations:
    skip-sync: "true"
  labels:
    app.kubernetes.io/instance: cpaas-monitor
    app.kubernetes.io/managed-by: Tiller
    app.kubernetes.io/name: prometheus-blackbox-exporter
    helm.sh/chart: prometheus-blackbox-exporter-1.6.0
  name: cpaas-monitor-prometheus-blackbox-exporter
  namespace: cpaas-system
```
