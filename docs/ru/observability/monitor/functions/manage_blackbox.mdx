---
weight: 50
sourceSHA: fd927eba4ca7353ade0f40c2282be9a4a2e8f0bf8d650b3dd0c1cf3015a8fe69
---

# Управление probes

## Обзор функции

Функция probes платформы реализована на основе Blackbox Exporter, что позволяет пользователям проверять сеть через ICMP, TCP или HTTP для быстрого выявления неисправностей, происходящих на платформе.

В отличие от систем мониторинга "белого ящика", которые полагаются на различные метрики мониторинга, уже доступные на платформе, мониторинг "черного ящика" сосредоточен на результатах. Когда мониторинг "белого ящика" не может охватить все факторы, влияющие на доступность сервиса, мониторинг "черного ящика" может быстро обнаруживать неисправности и отправлять оповещения на основе этих неисправностей. Например, если точка API имеет аномалию, мониторинг "черного ящика" может немедленно выявить такие проблемы для пользователей.

:::warning

Функция probes не поддерживает использование ICMP для обнаружения IPv6-адресов на узлах с версиями ядра 3.10 и ниже. Чтобы использовать этот сценарий, пожалуйста, обновите версию ядра на узле до 3.11 или выше.

:::

## Мониторинг черного ящика

Для создания элемента мониторинга черного ящика вы можете выбрать метод проверки ICMP, TCP или HTTP для периодической проверки указанного целевого адреса.

### Предварительные условия

Мониторинговые компоненты должны быть установлены в кластере, и мониторинговые компоненты должны функционировать правильно.

### Процедуры выполнения

1. В левой навигационной панели нажмите **Центр операций** > **Мониторинг** > **Мониторинг черного ящика**.

   **Совет**: Мониторинг черного ящика является функцией на уровне кластера. Нажмите на верхнюю навигационную панель, чтобы переключаться между кластерами.

2. Нажмите **Создать элемент мониторинга черного ящика**.

3. Обратитесь к следующим инструкциям для настройки соответствующих параметров.

   | Параметр              | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
   | --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Метод проверки**    | **ICMP**: Проверяет доступность сервера, посылая ping на введенное в **Целевом адресе** доменное имя или IP-адрес. <br />**TCP**: Проверяет бизнес-порт узла, слушая на `<domain:port>` или `<IP:port>`, указанных в **Целевом адресе**. <br />**HTTP**: Проверяет URL, введенный в **Целевом адресе**, для проверки соединения с вебсайтом.<br /> **Совет**: Метод проверки HTTP по умолчанию поддерживает только GET-запросы; для POST-запросов, пожалуйста, обратитесь к [Настройке модуля мониторинга BlackboxExporter](#Blackbox2). |
   | **Интервал проверки** | Время интервала для проверки.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
   | **Целевой адрес**     | Целевой адрес для проверки, максимальная длина 128 символов. <br /> Формат ввода для целевого адреса варьируется в зависимости от метода проверки:<br /> **ICMP**: доменное имя или IP-адрес, например `10.165.94.31`. <br /> **TCP**: `<domain:port>` или `<IP:port>`, например `172.19.155.133:8765`. <br /> **HTTP**: URL, который начинается с http или https, например `http://alauda.cn/`.                                                                                                                                                                               |

4. Нажмите **Создать**.

   После успешного создания вы можете просматривать последние результаты проверки в реальном времени на странице списка, а на основе элементов мониторинга черного ящика вы можете [создать политики оповещения](#Blackbox1). При обнаружении неисправности будет автоматически вызвано оповещение для уведомления соответствующих лиц для решения проблемы.

:::warning

После успешного создания элементов мониторинга черного ящика система требует около 5 минут для синхронизации конфигурации. В течение этого периода синхронизации проверки не будут проводиться, и результаты проверки не могут быть просмотрены.

:::

## Оповещения черного ящика \{#Blackbox1}

### Предварительные условия

- Мониторинговые компоненты должны быть установлены в кластере, и мониторинговые компоненты должны функционировать правильно.

- Элемент мониторинга черного ящика должен быть успешно создан, и система должна завершить синхронизацию конфигурации, чтобы результаты проверки были видны на странице мониторинга черного ящика.

### Процедуры выполнения

1. В левой навигационной панели нажмите **Центр операций** > **Оповещения** > **Политики оповещения**.

   **Совет**: Политики оповещения являются функцией на уровне кластера. Нажмите на верхнюю навигационную панель, чтобы переключаться между кластерами. Пожалуйста, убедитесь, что вы переключились на кластер, где только что была сконфигурирована позиция мониторинга черного ящика.

2. Нажмите **Создать политику оповещения**.

3. Обратитесь к следующим инструкциям для настройки соответствующих параметров; для получения дополнительной информации о параметрах, пожалуйста, обратитесь к [Создание политик оповещения](./manage_alert.md#alert_ui).

- **Тип оповещения**: Пожалуйста, выберите **Ресурсное оповещение**.

- **Тип ресурса**: Пожалуйста, выберите **Кластер**.

- Нажмите **Добавить правило оповещения**.

  - **Тип оповещения**: Пожалуйста, выберите **Оповещение черного ящика**.

  - **Элемент мониторинга черного ящика**: Пожалуйста, выберите желаемый элемент мониторинга черного ящика.

  - **Имя метрики**: Пожалуйста, выберите метрику, которую вы хотите контролировать и для которой хотите получать оповещения. В настоящее время поддерживаемые платформой метрики это **Связь** и **Код состояния HTTP**.

    - **Связь**: Эта метрика может быть выбрана для всех элементов мониторинга черного ящика, где условие срабатывания **“!= 1”** указывает, что целевой адрес элемента мониторинга черного ящика недоступен.

    - **Код состояния HTTP**: Эта метрика может быть выбрана, когда методом проверки выбранного элемента мониторинга черного ящика является **HTTP**. Вы можете ввести положительное целое число из трех цифр в качестве значения для условия срабатывания, например, если условие установлено на **“> 299”**, это означает, что оповещения будут срабатывать, когда коды ответа равны 3XX, 4XX или 5XX.

  - **Политика уведомления**: Пожалуйста, выберите вашу заранее настроенную политику.

  - Нажмите **Добавить**.

4. Нажмите **Создать**. После отправки политики оповещения вы сможете увидеть эту политику в списке политик оповещения.

## Настройка модуля мониторинга BlackboxExporter \{#Blackbox2}

Вы также можете улучшить функциональность мониторинга "черного ящика", добавив настраиваемые модули мониторинга в конфигурационный файл BlackboxExporter. Например, добавив модуль **http_post_2xx** в конфигурационный файл, когда метод проверки мониторинга черного ящика установлен на `HTTP`, он будет способен проверять состояние методов POST-запросов.

Конфигурационный файл для мониторинга черного ящика находится в пространстве имен, где установлен компонент Prometheus кластера, с именем по умолчанию `cpaas-monitor-prometheus-blackbox-exporter`, которое может быть изменено при необходимости в зависимости от фактического имени.

:::tip
Этот конфигурационный файл является ресурсом ConfigMap, связанным с пространством имен, который можно быстро просмотреть и обновить через функцию управления платформой, **Управление кластером > Управление ресурсами**.
:::

### Процедуры выполнения

1. Обновите конфигурационный файл мониторинга черного ящика, добавив настраиваемые модули мониторинга в **ключ** `modules`.

   В качестве примера добавления модуля **http_post_2xx**:

   ```yaml
     blackbox.yaml: |
       modules:           
         http_post_2xx:                    # Модуль проверки HTTP POST                                  
           prober: http
           timeout: 5s
           http:
             method: POST                 # Метод запроса для проверки
             headers:
               Content-Type: application/json
             body: '{}'                   # Содержимое тела, отправляемое с проверкой
   ```

   Для полных YAML-примеров конфигурационного файла мониторинга черного ящика, пожалуйста, обратитесь к [Справочной информации](#Blackbox3).

2. Активируйте конфигурацию, выбрав один из следующих методов.

   - Перезапустите компонент Blackbox Exporter **cpaas-monitor-prometheus-blackbox-exporter**, удалив его Pod.

   - Выполните следующую команду для вызова API перезагрузки и обновления конфигурационного файла:

     ```bash
     curl -X POST -v <Pod IP>:9115/-/reload     
     ```

## Создание элементов мониторинга черного ящика и оповещений через CLI

### Предварительные условия

- Политики уведомления должны быть настроены (если вам требуются автоматические уведомления об оповещениях).
- Целевой кластер должен иметь установленные компоненты мониторинга.

### Процедуры выполнения

1. Создайте новый YAML конфигурационный файл с именем `example-probe.yaml`.
2. Добавьте ресурс PrometheusRule в YAML-файл и отправьте его. Следующий пример создает новую политику оповещения с именем `prometheus-liveness`:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: Probe
metadata:
  annotations:
    cpaas.io/creator: jhshi@alauda.io                    # Создатель элемента проверки
    cpaas.io/updated-at: "2021-05-25T08:08:45Z"          # Время последнего обновления элемента проверки
    cpaas.io/display-name: "Prometheus prober"           # Описание элемента проверки
  creationTimestamp: "2021-05-10T02:04:33Z"              # Время создания элемента проверки
  labels:
    prometheus: kube-prometheus                          # Значение метки, используемое для имени prometheus
  name: prometheus-liveness                              # Имя элемента проверки
  namespace: cpaas-system                                # Пространство имен, используемое для пространства имен prometheus
spec:
  jobName: prometheus-liveness                           # Имя элемента проверки
  prober:
    url: cpaas-monitor-prometheus-blackbox-exporter:9115 # URL для метрик черного ящика, получаемых из функций
  module: http_2xx                                       # Имя модуля элемента проверки
  targets:
    staticConfig:
      static:
      - http://www.prometheus.io                         # Целевой адрес элемента проверки
      labels:
        module: http_2xx                                 # Имя модуля элемента проверки
        prober: http                                     # Метод проверки элемента
  interval: 30s                                          # Интервал проверки элемента
  scrapeTimeout: 10s   
```

3. Создайте новый YAML конфигурационный файл с именем `example-alerting-rule.yaml`.
4. Добавьте ресурс PrometheusRule в YAML файл и отправьте его. Следующий пример создает новую политику оповещения с именем `policy`:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    alert.cpaas.io/cluster: global      # Имя кластера, где находится оповещение
    alert.cpaas.io/kind: Cluster        # Тип ресурса
    alert.cpaas.io/name: global         # Имя кластера, где находится элемент мониторинга черного ящика
    alert.cpaas.io/namespace: cpaas-system  # Пространство имен, используемое для пространства имен prometheus, сохранять по умолчанию
    alert.cpaas.io/notifications: '["test"]'
    alert.cpaas.io/repeat-config: '{"Critical":"never","High":"5m","Medium":"5m","Low":"5m"}'
    alert.cpaas.io/rules.description: "{}"
    alert.cpaas.io/rules.disabled: "[]"
    alert.cpaas.io/subkind: ""
    cpaas.io/description: ""
    cpaas.io/display-name: policy      # Отображаемое имя политики оповещения
  labels:
    alert.cpaas.io/owner: System
    alert.cpaas.io/project: cpaas-system
    cpaas.io/source: Platform
    prometheus: kube-prometheus
    rule.cpaas.io/cluster: global
    rule.cpaas.io/name: policy
    rule.cpaas.io/namespace: cpaas-system
  name: policy
  namespace: cpaas-system
spec:
  groups:
    - name: general # Название правил оповещения
      rules:
        - alert: cluster.blackbox.probe.success-y97ah-9833444d918cab96c43e9ab6efc172cf
          annotations:
            alert_current_value: "{{ $value }}"  # Текущая значение для уведомления, сохранять по умолчанию
          expr: max by (job, instance) (probe_success{job=~"test",
            instance=~"https://demo.at-servicecenter.com/"})!=1
            # Сценарий оповещения о доступности, обязательно измените имя элемента мониторинга черного ящика и целевой адрес
          for: 30s # Продолжительность
          labels:
            alert_cluster: global # Имя кластера, где находится оповещение
            alert_for: 30s # Продолжительность
            alert_indicator: cluster.blackbox.probe.success  # Сохранить без изменений
            alert_indicator_aggregate_range: "0" # Сохранить без изменений
            alert_indicator_blackbox_instance: https://demo.at-servicecenter.com/ # Целевой адрес мониторинга черного ящика
            alert_indicator_blackbox_name: test # Имя элемента мониторинга черного ящика
            alert_indicator_comparison: "!="  # Сохранить конфигурацию без изменений для оповещения о доступности
            alert_indicator_query: ""  # Используется для оповещений журнала, необходимость в данной параметре не требуется
            alert_indicator_threshold: "1"  # Порог для правила оповещения, 1 указывает на доступность, сохранить без изменений
            alert_indicator_unit: ""  # Единица метрик для правила оповещения
            alert_involved_object_kind: Cluster   # Сохранить без изменений для оповещений черного ящика
            alert_involved_object_name: global   # Кластер, где находится элемент мониторинга черного ящика
            alert_involved_object_namespace: ""  # Пространство имен объекта, к которому относится правило оповещения
            alert_name: cluster.blackbox.probe.success-y97ah  # Имя правила оповещения
            alert_namespace: cpaas-system  # Пространство имен, где располагается правило оповещения
            alert_project: cpaas-system  # Имя проекта объекта, к которому относится правило оповещения
            alert_resource: policy # Имя политики оповещения, к которой относится правило оповещения
            alert_source: Platform # Тип данных для правила оповещения: Platform - данные платформы, Business - бизнес-данные
            severity: High # Уровень правила оповещения: Critical - катастрофа, High - серьезное, Medium - предупреждение, Low - совет
         - alert: cluster.blackbox.http.status.code-235el-99b0095b6b6669415043e14ae84f43bc
          annotations:
            alert_current_value: "{{ $value }}"
            alert_notifications: '["message"]'
          expr: max by(job, instance) (probe_http_status_code{job=~"test",
            instance=~"https://demo.at-servicecenter.com/"})>200
            # Сценарий оповещения кодов состояния HTTP, обязательно измените имя элемента мониторинга черного ящика и целевой адрес
          for: 30s
          labels:
            alert_cluster: global
            alert_for: 30s
            alert_indicator: cluster.blackbox.http.status.code
            alert_indicator_aggregate_range: "0"
            alert_indicator_blackbox_instance: https://demo.at-servicecenter.com/
            alert_indicator_blackbox_name: test
            alert_indicator_comparison: ">" 
            alert_indicator_query: ""
            alert_indicator_threshold: "299" # Порог для правил оповещения, в сценариях оповещения кодов состояния HTTP должен быть трехзначным числом, например, статусы больше 299 (3XX, 4XX, 5XX) указывают на ошибку
            alert_indicator_unit: ""
            alert_involved_object_kind: Cluster
            alert_involved_object_name: global
            alert_involved_object_namespace: ""
            alert_involved_object_options: Single
            alert_name: cluster.blackbox.http.status.code-235el
            alert_namespace: cpaas-system
            alert_project: cpaas-system
            alert_resource: policy33
            alert_source: Platform
            severity: High
```

## Справочная информация \{#Blackbox3}

Полный пример YAML-конфигурационного файла для мониторинга черного ящика выглядит следующим образом:

```yaml
apiVersion: v1
data:
  blackbox.yaml: |
    modules:
      http_2xx_example:               # Пример проверки HTTP
        prober: http
        timeout: 5s                   # Таймаут для проверки
        http:
          valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]                   # Версия в возвращенной информации, обычно по умолчанию
          valid_status_codes: []  # По умолчанию 2xx                       # Диапазон допустимых кодов ответа; если возвращенный код попадает в этот диапазон, то он считается успешной проверкой
          method: GET                 # Метод запроса
          headers:                    # Заголовки запроса
            Host: vhost.example.com
            Accept-Language: en-US
            Origin: example.com
          no_follow_redirects: false  # Указывает разрешено ли перенаправление
          fail_if_ssl: false   
          fail_if_not_ssl: false
          fail_if_body_matches_regexp:
            - "Не удалось подключиться к базе данных"
          fail_if_body_not_matches_regexp:
            - "Скачайте последнюю версию здесь"
          fail_if_header_matches: # Проверяет, что не установлены cookie
            - header: Set-Cookie
              allow_missing: true
              regexp: '.*'
          fail_if_header_not_matches:
            - header: Access-Control-Allow-Origin
              regexp: '(\*|example\.com)'
          tls_config:                  # Конфигурация TLS для https-запросов
            insecure_skip_verify: false
          preferred_ip_protocol: "ip4" # по умолчанию "ip6"                 # Предпочтительная версия протокола IP
          ip_protocol_fallback: false  # Без возврата к "ip6"            
      http_post_2xx:                   # Пример проверки HTTP с телом
        prober: http
        timeout: 5s
        http:
          method: POST                 # Метод запроса для проверки
          headers:
            Content-Type: application/json
          body: '{"username":"admin","password":"123456"}'                   # Тело, отправляемое во время проверки
      http_basic_auth_example:         # Пример проверки с именем пользователя и паролем
        prober: http
        timeout: 5s
        http:
          method: POST
          headers:
            Host: "login.example.com"
          basic_auth:                  # Имя пользователя и пароль, добавляемые во время проверки
            username: "username"
            password: "mysecret"
      http_custom_ca_example:
        prober: http
        http:
          method: GET
          tls_config:                  # Укажите корневой сертификат, используемый при проверке
            ca_file: "/certs/my_cert.crt"
      http_gzip:
        prober: http
        http:
          method: GET
          compression: gzip            # Метод сжатия, используемый во время проверки
      http_gzip_with_accept_encoding:
        prober: http
        http:
          method: GET
          compression: gzip
          headers:
            Accept-Encoding: gzip
      tls_connect:                     # Пример TCP проверки
        prober: tcp
        timeout: 5s
        tcp:
          tls: true                    # Указывает использовать ли TLS
      tcp_connect_example:
        prober: tcp
        timeout: 5s
      imap_starttls:                   # Пример настройки проверки для IMAP почтовых серверов
        prober: tcp
        timeout: 5s
        tcp:
          query_response:
            - expect: "OK.*STARTTLS"
            - send: ". STARTTLS"
            - expect: "OK"
            - starttls: true
            - send: ". capability"
            - expect: "CAPABILITY IMAP4rev1"
      smtp_starttls:                   # Пример настройки проверки для SMTP почтовых серверов
        prober: tcp
        timeout: 5s
        tcp:
          query_response:
            - expect: "^220 ([^ ]+) ESMTP (.+)$"
            - send: "EHLO prober\r"
            - expect: "^250-STARTTLS"
            - send: "STARTTLS\r"
            - expect: "^220"
            - starttls: true
            - send: "EHLO prober\r"
            - expect: "^250-AUTH"
            - send: "QUIT\r"
      irc_banner_example:
        prober: tcp
        timeout: 5s
        tcp:
          query_response:
            - send: "NICK prober"
            - send: "USER prober prober prober :prober"
            - expect: "PING :([^ ]+)"
              send: "PONG ${1}"
            - expect: "^:[^ ]+ 001"
      icmp_example:                    # Пример конфигурации для ICMP проверки
        prober: icmp
        timeout: 5s
        icmp:
          preferred_ip_protocol: "ip4"
          source_ip_address: "127.0.0.1"
      dns_udp_example:                 # Пример DNS-запросов с использованием UDP
        prober: dns
        timeout: 5s
        dns:
          query_name: "www.prometheus.io"                 # Доменное имя для разрешения
          query_type: "A"              # Тип, соответствующий доменному имени
          valid_rcodes:
          - NOERROR
          validate_answer_rrs:
            fail_if_matches_regexp:
            - ".*127.0.0.1"
            fail_if_all_match_regexp:
            - ".*127.0.0.1"
            fail_if_not_matches_regexp:
            - "www.prometheus.io.\t300\tIN\tA\t127.0.0.1"
            fail_if_none_matches_regexp:
            - "127.0.0.1"
          validate_authority_rrs:
            fail_if_matches_regexp:
            - ".*127.0.0.1"
          validate_additional_rrs:
            fail_if_matches_regexp:
            - ".*127.0.0.1"
      dns_soa:
        prober: dns
        dns:
          query_name: "prometheus.io"
          query_type: "SOA"
      dns_tcp_example:               # Пример DNS-запросов с использованием TCP
        prober: dns
        dns:
          transport_protocol: "tcp" # по умолчанию "udp"
          preferred_ip_protocol: "ip4" # по умолчанию "ip6"
          query_name: "www.prometheus.io"
kind: ConfigMap
metadata:
  annotations:
    skip-sync: "true"
  labels:
    app.kubernetes.io/instance: cpaas-monitor
    app.kubernetes.io/managed-by: Tiller
    app.kubernetes.io/name: prometheus-blackbox-exporter
    helm.sh/chart: prometheus-blackbox-exporter-1.6.0
  name: cpaas-monitor-prometheus-blackbox-exporter
  namespace: cpaas-system
```
