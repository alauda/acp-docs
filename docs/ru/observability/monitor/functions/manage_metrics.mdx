---
weight: 10
sourceSHA: 86180698152a9da4e882f1a7ed50247cbf1aa32dea989fe635d3e0155fcb830f
---

# Управление метриками

Система мониторинга платформы основана на метриках, собранных Prometheus / VictoriaMetrics. Этот документ даст вам рекомендации по управлению этими метриками.

## Просмотр метрик, предоставляемых компонентами платформы

Метод мониторинга компонентов кластера внутри платформы заключается в извлечении метрик, предоставляемых через `ServiceMonitor`. Метрики на платформе доступны общедоступно через конечную точку `/metrics`. Вы можете просмотреть предоставленные метрики конкретного компонента на платформе, используя следующую команду:

```bash
curl -s http://<IP компонента>:<порт метрик компонента>/metrics | grep 'TYPE\|HELP'
```

Пример вывода:

```bash
# HELP controller_runtime_active_workers Число в данный момент используемых рабочих процессов на контроллер
# TYPE controller_runtime_active_workers gauge
# HELP controller_runtime_max_concurrent_reconciles Максимальное число одновременно выполняемых операций согласования на контроллер
# TYPE controller_runtime_max_concurrent_reconciles gauge
# HELP controller_runtime_reconcile_errors_total Общее число ошибок согласования на контроллер
# TYPE controller_runtime_reconcile_errors_total counter
# HELP controller_runtime_reconcile_time_seconds Длительность процесса согласования на контроллер
```

## Просмотр всех метрик, хранящихся Prometheus / VictoriaMetrics

Вы можете просмотреть список доступных метрик в кластере, чтобы помочь вам написать необходимый PromQL на основе этих метрик.

### Предварительные условия

1. Вы получили свой токен пользователя

2. Вы получили адрес платформы

### Процедуры

<Steps>
  Выполните следующую команду, чтобы получить список метрик, используя команду `curl`:

  ```bash
  curl -k -X 'GET' -H 'Authorization: Bearer <Ваш токен>' 'https://<Ваш адрес доступа к платформе>/v2/metrics/<Имя вашего кластера>/prometheus/label/__name__/values'
  ```

  Пример вывода:

  ```bash
  {
    "status": "success",
    "data": [
      "ALERTS",
    "ALERTS_FOR_STATE",
    "advanced_search_cached_resources_count",
    "alb_error",
    "alertmanager_alerts",
    "alertmanager_alerts_invalid_total",
    "alertmanager_alerts_received_total",
    "alertmanager_cluster_enabled"]
  }
  ```
</Steps>

## Просмотр всех встроенных метрик, определенных платформой

Чтобы упростить использование пользователями, платформа встроила большое количество часто используемых метрик. Вы можете напрямую использовать эти метрики при настройке оповещений или мониторинговых панелей, не определяя их самостоятельно. Далее вы познакомитесь с тем, как просматривать эти метрики.

### Предварительные условия

1. Вы получили свой токен пользователя

2. Вы получили адрес платформы

### Процедуры

<Steps>
  Выполните следующую команду, чтобы получить список метрик, используя команду `curl`:

  ```bash
  curl -k -X 'GET' -H 'Authorization: Bearer <Ваш токен>' 'https://<Ваш адрес доступа к платформе>/v2/metrics/<Имя вашего кластера>/indicators'
  ```

  Пример вывода:

  ```bash
  [
    {
    "alertEnabled": true, # [!code callout]
    "annotations": {
     "cn": "Загрузка ЦП контейнеров в вычислительном компоненте",
     "descriptionEN": "Загрузка ЦП для подов в рабочей нагрузке",
     "descriptionZH": "Загрузка ЦП контейнеров в вычислительном компоненте",
     "displayNameEN": "Загрузка ЦП подов",
     "displayNameZH": "Загрузка ЦП контейнеров в вычислительном компоненте",
     "en": "Загрузка ЦП для подов в рабочей нагрузке",
     "features": "SupportDashboard", # [!code callout]
     "summaryEN": "Уровень использования ЦП {{.externalLabels.comparison}}{{.externalLabels.threshold}} пода ({{.labels.pod}})",
     "summaryZH": "Уровень использования ЦП {{.externalLabels.comparison}}{{.externalLabels.threshold}} пода ({{.labels.pod}})"
    },
    "displayName": "Загрузка ЦП контейнеров в вычислительном компоненте",
    "kind": "workload",
    "multipleEnabled": true,  # [!code callout] 
    "name": "workload.pod.cpu.utilization",
    "query": "avg by (kind,name,namespace,pod) (avg by (kind,name,namespace,pod,container)(cpaas_advanced_container_cpu_usage_seconds_total_irate5m{kind=~\"{{.kind}}\",name=~\"{{.name}}\",namespace=~\"{{.namespace}}\",container!=\"\",container!=\"POD\"}) / avg by (kind,name,namespace,pod,container)(cpaas_advanced_kube_pod_container_resource_limits{kind=~\"{{.kind}}\",name=~\"{{.name}}\",namespace=~\"{{.namespace}}\",resource=\"cpu\"}))", # [!code callout]
    "summary": "Уровень использования ЦП {{.externalLabels.comparison}}{{.externalLabels.threshold}} пода ({{.labels.pod}})",
    "type": "metric",
    "unit": "%",
    "legend": "{{.namespace}}/{{.pod}}",
    "variables": [ # [!code callout] 
     "namespace",
     "name",
     "kind"
    ]
   }
  ]

  ```

  <Callouts>
    1. Поддерживает ли эта метрика конфигурацию оповещений
    2. Поддерживает ли эта метрика использование в мониторинговых панелях
    3. Поддерживает ли эта метрика использование при конфигурации оповещений для нескольких ресурсов
    4. Определенное для метрики выражение PromQL
    5. Переменные, которые могут быть использованы в выражении PromQL метрики
  </Callouts>
</Steps>

## Интеграция внешних метрик

Кроме встроенных метрик платформы, вы также можете интегрировать метрики, предоставляемые вашими приложениями или сторонними приложениями, через `ServiceMonitor` или `PodMonitor`. В этом разделе в качестве примера объяснения используется Elasticsearch Exporter, установленный в виде пода в том же кластере.

### Предварительные условия

Вы установили свое приложение и предоставили метрики через указанные интерфейсы. В этом документе мы предполагаем, что ваше приложение установлено в пространстве имен `cpaas-system` и предоставило конечную точку `http://<ip-elasticsearch-exporter>:9200/_prometheus/metrics`.

### Процедуры

<Steps>
  1. Создайте Сервис/Конечную точку для Экспортера для предоставления метрик

  ```yaml
  apiVersion: v1
  kind: Service
  metadata:
    labels:
      chart: elasticsearch
      service_name: cpaas-elasticsearch
    name: cpaas-elasticsearch
    namespace: cpaas-system
  spec:
    clusterIP: 10.105.125.99
    ports:
    - name: cpaas-elasticsearch
      port: 9200
      protocol: TCP
      targetPort: 9200
    selector:
      service_name: cpaas-elasticsearch
    sessionAffinity: None
    type: ClusterIP
  ```

  2. Создайте объект `ServiceMonitor`, чтобы описать метрики, предоставляемые вашим приложением:

  ```yaml
  apiVersion: monitoring.coreos.com/v1
  kind: ServiceMonitor
  metadata:
    labels:
      app: cpaas-monitor
      chart: cpaas-monitor
      heritage: Helm
      prometheus: kube-prometheus            # [!code callout]
      release: cpaas-monitor
    name: cpaas-elasticsearch-Exporter
    namespace: cpaas-system                  # [!code callout]
  spec:
    jobLabel: service_name                   # [!code callout]
    namespaceSelector:                       # [!code callout]
      any: true
    selector:                                # [!code callout]
      matchExpressions:
      - key: service_name
        operator: Exists
    endpoints:
    - port: cpaas-elasticsearch              # [!code callout] 
      path: /_prometheus/metrics             # [!code callout] 
      interval: 60s                          # [!code callout] 
      honorLabels: true
      basicAuth:                             # [!code callout] 
        password:
          key: ES_PASSWORD
          name: acp-config-secret
        username:
          key: ES_USER
          name: acp-config-secret
  ```

  <Callouts>
    1. К какому Prometheus должен быть синхронизирован ServiceMonitor; оператор будет отслеживать соответствующий ресурс ServiceMonitor на основе конфигурации serviceMonitorSelector CR Prometheus. Если метки ServiceMonitor не совпадают с конфигурацией serviceMonitorSelector CR Prometheus, этот ServiceMonitor не будет отслеживаться оператором.
    2. Оператор будет следить за тем, какие пространства имен ServiceMonitor на основе конфигурации serviceMonitorNamespaceSelector CR Prometheus; если ServiceMonitor не находится в serviceMonitorNamespaceSelector CR Prometheus, этот ServiceMonitor не будет отслеживаться оператором.
    3. Метрики, собранные Prometheus, добавят метку задания, значение которой будет равно значению метки службы, соответствующему jobLabel.
    4. ServiceMonitor сопоставляет соответствующий Сервис на основе конфигурации namespaceSelector.
    5. ServiceMonitor сопоставляет Сервис на основе конфигурации селектора.
    6. ServiceMonitor сопоставляет порт Сервиса на основе конфигурации порта.
    7. Путь доступа к Экспортеру, по умолчанию /metrics.
    8. Интервал, с которым Prometheus забирает метрики Экспортера.
    9. Если для доступа к пути Экспортера требуется аутентификация, необходимо добавить информацию об аутентификации; также поддерживаются токены bearer, tls аутентификация и другие методы.
  </Callouts>

  3. Проверьте, отслеживается ли ServiceMonitor Prometheus

  Доступ к пользовательскому интерфейсу компонента мониторинга, чтобы проверить, существует ли задание `cpaas-elasticsearch-exporter`.

  - Адрес пользовательского интерфейса Prometheus: `https://<Ваш адрес доступа к платформе>/clusters/<Имя кластера>/prometheus-0/targets`
  - Адрес пользовательского интерфейса VictoriaMetrics: `https://<Ваш адрес доступа к платформе>/clusters/<Имя кластера>/vmselect/vmui/?#/metrics`
</Steps>
