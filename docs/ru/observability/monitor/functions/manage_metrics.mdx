---
weight: 10
sourceSHA: 86180698152a9da4e882f1a7ed50247cbf1aa32dea989fe635d3e0155fcb830f
---

# Управление метриками

Система мониторинга платформы основана на метриках, собранных Prometheus / VictoriaMetrics. Этот документ поможет вам управлять этими метриками.

## Просмотр метрик, предоставляемых компонентами платформы

Метод мониторинга компонентов кластера в рамках платформы заключается в извлечении метрик, предоставленных через `ServiceMonitor`. Метрики в платформе доступны через общий интерфейс `/metrics`. Вы можете просмотреть предоставленные метрики конкретного компонента в платформе, используя следующую команду:

```bash
curl -s http://<IP компонента>:<Порт метрик компонента>/metrics | grep 'TYPE\|HELP'
```

Пример вывода:

```bash
# HELP controller_runtime_active_workers Количество текущих используемых работников на контроллер
# TYPE controller_runtime_active_workers gauge
# HELP controller_runtime_max_concurrent_reconciles Максимальное количество параллельных согласований на контроллер
# TYPE controller_runtime_max_concurrent_reconciles gauge
# HELP controller_runtime_reconcile_errors_total Общее количество ошибок согласования на контроллер
# TYPE controller_runtime_reconcile_errors_total counter
# HELP controller_runtime_reconcile_time_seconds Длительность времени на каждое согласование на контроллер
```

## Просмотр всех метрик, хранимых Prometheus / VictoriaMetrics

Вы можете просмотреть список доступных метрик в кластере, чтобы помочь вам написать необходимый PromQL на основе этих метрик.

### Предварительные условия

1. Вы получили ваш пользовательский токен.

2. Вы узнали адрес платформы.

### Процедуры

<Steps>
  Выполните следующую команду, чтобы получить список метрик с помощью команды `curl`:

  ```bash
  curl -k -X 'GET' -H 'Authorization: Bearer <Ваш токен>' 'https://<Ваш адрес доступа к платформе>/v2/metrics/<Ваше имя кластера>/prometheus/label/__name__/values'
  ```

  Пример вывода:

  ```bash
  {
    "status": "success",
    "data": [
      "ALERTS",
    "ALERTS_FOR_STATE",
    "advanced_search_cached_resources_count",
    "alb_error",
    "alertmanager_alerts",
    "alertmanager_alerts_invalid_total",
    "alertmanager_alerts_received_total",
    "alertmanager_cluster_enabled"]
  }
  ```
</Steps>

## Просмотр всех встроенных метрик, определенных платформой

Чтобы упростить использование для пользователей, платформа имеет большое количество часто используемых метрик. Вы можете напрямую использовать эти метрики при конфигурировании оповещений или мониторинговых панелей, не нуждаясь в их определении самостоятельно. Ниже представлено, как просмотреть эти метрики.

### Предварительные условия

1. Вы получили ваш пользовательский токен.

2. Вы узнали адрес платформы.

### Процедуры

<Steps>
  Выполните следующую команду, чтобы получить список метрик с помощью команды `curl`:

  ```bash
  curl -k -X 'GET' -H 'Authorization: Bearer <Ваш токен>' 'https://<Ваш адрес доступа к платформе>/v2/metrics/<Ваше имя кластера>/indicators'
  ```

  Пример вывода:

  ```bash
  [
    {
    "alertEnabled": true, # [!code callout]
    "annotations": {
     "cn": "Использование ЦП в контейнерах в вычислительном компоненте",
     "descriptionEN": "Использование ЦП для подов в рабочей负载",
     "descriptionZH": "Использование ЦП в контейнерах в вычислительном компоненте",
     "displayNameEN": "Использование ЦП подов",
     "displayNameZH": "Использование ЦП в контейнерах в вычислительном компоненте",
     "en": "Использование ЦП для подов в рабочей负载",
     "features": "SupportDashboard", # [!code callout]
     "summaryEN": "Уровень использования ЦП {{.externalLabels.comparison}}{{.externalLabels.threshold}} пода ({{.labels.pod}})",
     "summaryZH": "Уровень использования ЦП {{.externalLabels.comparison}}{{.externalLabels.threshold}} пода ({{.labels.pod}})"
    },
    "displayName": "Использование ЦП в контейнерах в вычислительном компоненте",
    "kind": "workload",
    "multipleEnabled": true,  # [!code callout] 
    "name": "workload.pod.cpu.utilization",
    "query": "avg by (kind,name,namespace,pod) (avg by (kind,name,namespace,pod,container)(cpaas_advanced_container_cpu_usage_seconds_total_irate5m{kind=~\"{{.kind}}\",name=~\"{{.name}}\",namespace=~\"{{.namespace}}\",container!=\"\",container!=\"POD\"}) / avg by (kind,name,namespace,pod,container)(cpaas_advanced_kube_pod_container_resource_limits{kind=~\"{{.kind}}\",name=~\"{{.name}}\",namespace=~\"{{.namespace}}\",resource=\"cpu\"}))", # [!code callout]
    "summary": "Уровень использования ЦП {{.externalLabels.comparison}}{{.externalLabels.threshold}} пода ({{.labels.pod}})",
    "type": "metric",
    "unit": "%",
    "legend": "{{.namespace}}/{{.pod}}",
    "variables": [ # [!code callout] 
     "namespace",
     "name",
     "kind"
    ]
   }
  ]

  ```

  <Callouts>
    1. Поддерживает ли эта метрика настройку оповещений
    2. Поддерживает ли эта метрика использование в мониторинговых панелях
    3. Поддерживает ли эта метрика использование при настройке оповещений для нескольких ресурсов
    4. Определенное выражение PromQL для метрики
    5. Переменные, которые могут использоваться в выражении PromQL метрики
  </Callouts>
</Steps>

## Интеграция внешних метрик

Кроме встроенных метрик платформы, вы также можете интегрировать метрики, предоставленные вашими приложениями или сторонними приложениями, через `ServiceMonitor` или `PodMonitor`. Этот раздел использует Elasticsearch Exporter, установленный в форме пода в том же кластере, в качестве примера для объяснения.

### Предварительные условия

Вы установили ваше приложение и предоставили метрики через указанные интерфейсы. В этом документе мы предполагаем, что ваше приложение установлено в пространстве имен `cpaas-system` и предоставило интерфейс `http://<elasticsearch-exporter-ip>:9200/_prometheus/metrics`.

### Процедуры

<Steps>
  1. Создайте Service/Endpoint для Exporter для предоставления метрик

  ```yaml
  apiVersion: v1
  kind: Service
  metadata:
    labels:
      chart: elasticsearch
      service_name: cpaas-elasticsearch
    name: cpaas-elasticsearch
    namespace: cpaas-system
  spec:
    clusterIP: 10.105.125.99
    ports:
    - name: cpaas-elasticsearch
      port: 9200
      protocol: TCP
      targetPort: 9200
    selector:
      service_name: cpaas-elasticsearch
    sessionAffinity: None
    type: ClusterIP
  ```

  2. Создайте объект `ServiceMonitor`, чтобы описать метрики, предоставляемые вашим приложением:

  ```yaml
  apiVersion: monitoring.coreos.com/v1
  kind: ServiceMonitor
  metadata:
    labels:
      app: cpaas-monitor
      chart: cpaas-monitor
      heritage: Helm
      prometheus: kube-prometheus            # [!code callout]
      release: cpaas-monitor
    name: cpaas-elasticsearch-Exporter
    namespace: cpaas-system                  # [!code callout]
  spec:
    jobLabel: service_name                   # [!code callout]
    namespaceSelector:                       # [!code callout]
      any: true
    selector:                                # [!code callout]
      matchExpressions:
      - key: service_name
        operator: Exists
    endpoints:
    - port: cpaas-elasticsearch              # [!code callout] 
      path: /_prometheus/metrics             # [!code callout] 
      interval: 60s                          # [!code callout] 
      honorLabels: true
      basicAuth:                             # [!code callout] 
        password:
          key: ES_PASSWORD
          name: acp-config-secret
        username:
          key: ES_USER
          name: acp-config-secret
  ```

  <Callouts>
    1. К какому Prometheus должен синхронизироваться ServiceMonitor; оператор будет следить за соответствующим ресурсом ServiceMonitor на основе конфигурации serviceMonitorSelector в Prometheus CR. Если метки ServiceMonitor не соответствуют конфигурации serviceMonitorSelector в Prometheus CR, этот ServiceMonitor не будет отслеживаться оператором.
    2. Оператор будет следить за теми пространствами имен ServiceMonitor, основываясь на конфигурации serviceMonitorNamespaceSelector в Prometheus CR; если ServiceMonitor находится не в serviceMonitorNamespaceSelector Prometheus CR, этот ServiceMonitor не будет отслеживаться оператором.
    3. Метрики, собранные Prometheus, добавляют метку задания, со значением, равным метке сервиса, соответствующей jobLabel.
    4. ServiceMonitor соответствует соответствующему Service на основе конфигурации namespaceSelector.
    5. ServiceMonitor соответствует Service на основе конфигурации селектора.
    6. ServiceMonitor соответствует порту Service на основе конфигурации порта.
    7. Путь доступа к Exporter, по умолчанию - /metrics.
    8. Интервал, с которым Prometheus извлекает метрики Exporter.
    9. Если для доступа к пути Exporter требуется аутентификация, необходимо добавить информацию об аутентификации; поддерживаются также токены доступа, tls-аутентификация и другие методы.
  </Callouts>

  3. Проверьте, отслеживается ли ServiceMonitor Prometheus

  Получите доступ к пользовательскому интерфейсу компонента мониторинга, чтобы проверить, существует ли задание `cpaas-elasticsearch-exporter`.

  - Адрес UI Prometheus: `https://<Ваш адрес доступа к платформе>/clusters/<Имя кластера>/prometheus-0/targets`
  - Адрес UI VictoriaMetrics: `https://<Ваш адрес доступа к платформе>/clusters/<Имя кластера>/vmselect/vmui/?#/metrics`
</Steps>
