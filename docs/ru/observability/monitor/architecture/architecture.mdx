---
weight: 20
sourceSHA: e679cd883d8ac207cc52b92f96405ba1745ecfbc086b63a97ca3f1241f7ab592
---

# Архитектура модуля мониторинга

![](../../../../en/observability/monitor/assets/visio_for_monitor.png)

## Общее описание архитектуры

Система мониторинга состоит из следующих основных функциональных модулей:

1. Система мониторинга
   - Сбор и хранение данных: Сбор и сохранение метрик мониторинга из нескольких источников
   - Запрос и визуализация данных: Предоставление гибких возможностей запроса и визуализации для данных мониторинга
2. Система оповещения
   - Управление правилами оповещения: Настройка и управление политиками оповещения
   - Срабатывание и уведомление: Оценка правил оповещения и отправка уведомлений
   - Статус оповещения в реальном времени: Предоставление актуального состояния текущего оповещения системы
3. Система уведомлений
   - Настройка уведомлений: Управление шаблонами уведомлений, контактными группами и политиками
   - Сервер уведомлений: Управление настройками различных каналов уведомлений

## Система мониторинга

### Сбор и хранение данных

1. Обязанности оператора Prometheus/VictoriaMetrics:
   - Загрузка и валидация конфигураций сбора мониторинга
   - Загрузка и валидация конфигураций правил оповещения
   - Синхронизация конфигураций с экземплярами Prometheus/VictoriaMetrics
2. Источники данных мониторинга:
   - Nevermore: Генерирует метрики, связанные с журналами
   - Warlock: Генерирует метрики, связанные с событиями
   - Prometheus/VictoriaMetrics: Обнаруживает и собирает метрики различных экспортеров через ServiceMonitor

### Запрос и визуализация данных

1. Процесс запроса данных мониторинга:
   - Браузер инициирует запрос (Путь: `/platform/monitoring.alauda.io/v1beta1`)
   - ALB перенаправляет запрос на компонент Courier
   - API Courier обрабатывает запрос:
     - Встроенные метрики: Получает PromQL через интерфейс индикаторов и выполняет запрос
     - Пользовательские метрики: Направляет PromQL непосредственно на компонент мониторинга
   - Панель мониторинга извлекает данные и отображает их

2. Процесс управления панелью мониторинга:
   - Пользователи получают доступ к ALB кластера `global` (Путь: `/kubernetes/cluster_name/apis/ait.alauda.io/v1alpha2/MonitorDashboard`)
   - ALB перенаправляет запрос на компонент Erebus
   - Erebus маршрутизирует запрос к целевому кластеру мониторинга
   - Компонент Warlock отвечает за:
     - Валидацию законности конфигурации панели мониторинга
     - Управление ресурсом CR MonitorDashboard

## Система оповещения

### Управление правилами оповещения

Процесс конфигурации правил оповещения:

1. Пользователи получают доступ к ALB кластера `global` (Путь: `/kubernetes/cluster_name/apis/monitoring.coreos.com/v1/prometheusrules`)
2. Запрос проходит через ALB -> Erebus -> kube-apiserver целевого кластера
3. Обязанности каждого компонента:
   - Оператор Prometheus/VictoriaMetrics:
     - Валидация законности правил оповещения
     - Управление CR PrometheusRule
   - Nevermore: Прослушивание и обработка метрик оповещения по журналам
   - Warlock: Прослушивание и обработка метрик оповещения по событиям

### Рабочий процесс обработки оповещений

1. Оценка оповещения:
   - PrometheusRule/VMRule определяет правила оповещения
   - Prometheus/VictoriaMetrics периодически оценивает правила
2. Уведомление об оповещении:
   - Оповещения отправляются в Alertmanager после срабатывания
   - Alertmanager -> ALB -> API Courier
   - API Courier отвечает за рассылку уведомлений
3. Хранение оповещений:
   - История оповещений хранится в ElasticSearch/ClickHouse

### Статус оповещения в реальном времени

1. Сбор статуса:
   - Courier кластера `global` генерирует метрики:
     - cpaas\_active\_alerts: Текущие активные оповещения
     - cpaas\_active\_silences: Текущие конфигурации тишины
   - Глобальный Prometheus собирает каждые 15 секунд
2. Отображение статуса:
   - Фронтэнд запрашивает и отображает статус в реальном времени через API Courier

## Система уведомлений

### Управление конфигурацией уведомлений

Процесс управления шаблонами уведомлений, контактными группами уведомлений и политиками уведомлений следующий:

1. Пользователи получают доступ к стандартному API кластера `global` через браузер
   - Путь доступа: `/apis/ait.alauda.io/v1beta1/namespaces/cpaas-system`
2. Управление связанными ресурсами:
   - Шаблон уведомлений: apiVersion: "ait.alauda.io/v1beta1", kind: "NotificationTemplate"
   - Контактная группа уведомлений: apiVersion: "ait.alauda.io/v1beta1", kind: "NotificationGroup"
   - Политика уведомлений: apiVersion: "ait.alauda.io/v1beta1", kind: "Notification"
3. Courier отвечает за:
   - Валидацию законности шаблонов уведомлений
   - Валидацию законности контактных групп уведомлений
   - Валидацию законности политик уведомлений

### Управление сервером уведомлений

1. Пользователи получают доступ к ALB кластера `global` через браузер
   - Путь доступа: `/kubernetes/global/api/v1/namespaces/cpaas-system/secrets`
2. Управление и отправка конфигураций сервера уведомлений
   - Имя ресурса: platform-email-server
3. Courier отвечает за:
   - Валидацию законности конфигурации сервера уведомлений
