---
weight: 30
sourceSHA: 0501ce7fe65c53dbd49863e7f35e77e97dc1f361463a206ea135ff5b35ea4830
---

# Обновление глобального кластера

<Term name="productShort" /> состоит из **глобального кластера** и одного или нескольких **рабочих кластеров**.  
Глобальный кластер **должен** быть обновлен перед любыми рабочими кластерами.

Этот документ проведет вас через процедуру обновления глобального кластера.

Если глобальный кластер настроен с решением **глобального DR (восстановление после катастроф)**, строго следуйте [процедуре глобального DR](#global_dr). В противном случае следуйте [Стандартной процедуре](#standard).

## Стандартная процедура \{#standard}

<Steps>
  ### Загрузка образов

  Скопируйте пакет обновления на **любой узел управляющей плоскости** глобального кластера. Извлеките пакет и выполните `cd` в извлеченный каталог.

  - Если глобальный кластер использует **встроенный реестр**, выполните:

    ```bash
    bash upgrade.sh --only-sync-image=true
    ```

  - Если глобальный кластер использует **внешний реестр**, вам также необходимо указать адрес реестра:

    ```bash
    bash upgrade.sh --only-sync-image=true --registry <registry-address> --username <username> --password <password>
    ```

  <Directive type="info" title="INFO">
    Загрузка образов обычно занимает около 2 часов, в зависимости от производительности вашей сети и диска.  
    Если ваша платформа использует глобальный DR, помните, что **резервный глобальный кластер также требует загрузки образов**, и планируйте ваше окно обслуживания соответственно.
  </Directive>

  ### Запуск обновления

  После завершения загрузки образов выполните следующую команду, чтобы начать процесс обновления:

  ```bash
  bash upgrade.sh --skip-sync-image
  ```

  Подождите, пока скрипт не завершится, прежде чем продолжить.

  ### Обновление глобального кластера

  1. Войдите в веб-консоль глобального кластера и переключитесь на вид **Администратор**.
  2. Перейдите в **Кластеры > Кластеры**.
  3. Нажмите на кластер `global`, чтобы открыть его детальный вид.
  4. Перейдите на вкладку **Функциональные компоненты**.
  5. Нажмите кнопку **Обновить**.

  Просмотрите доступные обновления компонентов, показанные в диалоговом окне, и подтвердите продолжение.

  <Directive type="info" title="INFO">
    Обновление версии Kubernetes является необязательным.  
    Однако, поскольку сбои в обслуживании могут произойти независимо от этого, мы рекомендуем включить обновление Kubernetes, чтобы избежать нескольких окон обслуживания.
  </Directive>
</Steps>

## Процедура глобального DR \{#global\_dr}

<Steps>
  ### Сравнение согласованности данных

  1. Следуйте вашим обычным процедурам инспекции глобального DR, чтобы убедиться, что данные в **резервном глобальном кластере** согласованы с **основным глобальным кластером**. Если обнаружены несоответствия, **свяжитесь с технической поддержкой** перед продолжением.
  2. На **обоих** кластерах выполните следующее, чтобы убедиться, что нет узлов `Machine`, находящихся в неработающем состоянии:

  ```bash
  kubectl get machines.platform.tkestack.io
  ```

  Если такие узлы существуют, свяжитесь с технической поддержкой для их устранения перед продолжением.

  ### Удаление плагина синхронизации etcd

  <Tabs>
    <Tab label="Обновление с 3.18">
      1. Получите доступ к веб-консоли **резервного глобального кластера** через его IP или VIP.
      2. Переключитесь на вид **Управление платформой**.
      3. Перейдите в **Каталог > Плагины кластера**.
      4. Выберите `global` из выпадающего списка кластеров.
      5. Найдите плагин **EtcdSync** и нажмите **Удалить**. Подождите, пока удаление не завершится.
    </Tab>

    <Tab label="Обновление с 3.16">
      Войдите в любой **узел управляющей плоскости** **основного глобального кластера**, затем выполните:

      ```bash
      helm3 del etcd-sync -n default 2> /dev/null
      helm3 del etcd-sync -n cpaas-system 2> /dev/null

      kubectl delete configmaps,secret -n kube-system etcd-master-mirror-cert etcd-slave-mirror-cert etcd-sync-env etcd-sync-ignore-text &> /dev/null

      kubectl delete deploy -n kube-system etcd-mirror-etcd-mirror &> /dev/null

      kubectl get pod -n kube-system | grep etcd-mirror  # Убедитесь, что нет оставшихся подов etcd-mirror
      ```
    </Tab>
  </Tabs>

  ### Обновление резервного глобального кластера

  Следуйте той же процедуре, как описано в разделе [Стандартная процедура](#standard), чтобы сначала обновить **резервный глобальный кластер**.

  ### Обновление основного глобального кластера

  После обновления резервного кластера следуйте той же [Стандартной процедуре](#standard), чтобы обновить **основной глобальный кластер**.

  ### Переустановка плагина синхронизации etcd

  Перед переустановкой убедитесь, что порт `2379` правильно перенаправлен с обоих VIP глобального кластера на их узлы управляющей плоскости.

  Для переустановки:

  1. Получите доступ к веб-консоли **резервного глобального кластера** через его IP или VIP.
  2. Переключитесь на вид **Администратор**.
  3. Перейдите в **Маркетплейс > Плагины кластера**.
  4. Выберите кластер `global`.
  5. Найдите **Alauda Container Platform etcd Synchronizer**, нажмите **Установить** и предоставьте необходимые параметры.

  Для проверки установки:

  ```bash
  kubectl get po -n cpaas-system -l app=etcd-sync  # Убедитесь, что под 1/1 работает

  kubectl logs -n cpaas-system $(kubectl get po -n cpaas-system -l app=etcd-sync --no-headers | awk '{print $1}' | head -1) | grep -i "Start Sync update"
  # Подождите, пока логи не содержат "Start Sync update"

  # Воссоздайте под, чтобы инициировать синхронизацию ресурсов с ownerReferences
  kubectl delete po -n cpaas-system $(kubectl get po -n cpaas-system -l app=etcd-sync --no-headers | awk '{print $1}' | head -1)
  ```

  ### Проверка статуса синхронизации

  Выполните следующее, чтобы проверить статус синхронизации:

  ```bash
  curl "$(kubectl get svc -n cpaas-system etcd-sync-monitor -ojsonpath='{.spec.clusterIP}')/check"
  ```

  **Объяснение вывода:**

  - `"LOCAL ETCD missed keys:"` – Ключи существуют в **основном кластере**, но отсутствуют в резервном. Это часто разрешается после перезапуска пода.
  - `"LOCAL ETCD surplus keys:"` – Ключи существуют в **резервном кластере**, но отсутствуют в основном. Просмотрите их с вашей командой операций перед удалением.
</Steps>
