---
weight: 15
sourceSHA: c2cd43f3c667b5ec26c2f56713f757c695ccf72bdab9ffff831f95210cc22643
---

# Установка через YAML

## Когда использовать этот метод?

**Рекомендуется для**:

- **Продвинутых пользователей** с опытом работы с Kubernetes, предпочитающих ручной подход.
- **Развертываний уровня производства**, требующих корпоративного хранилища (NAS, AWS S3, Ceph и т. д.).
- Сред, требующих **тонкой настройки** TLS, ingress.
- **Полной кастомизации YAML** для сложных конфигураций.

## Предварительные требования

- **Установите** плагин кластера **Alauda Container Platform Registry** на целевой кластер.
- **Доступ** к целевому кластеру Kubernetes с настроенным kubectl.
- **Права администратора кластера** для создания ресурсов с областью кластера.
- Получите зарегистрированный **домен** (например, registry.yourcompany.com) [Создать домен](/configure/networking/functions/create_domain.mdx)
- Обеспечьте действительное **NAS-хранилище** (например, NFS, GlusterFS и т. д.).
- (Необязательно) Обеспечьте действительное **S3-хранилище** (например, AWS S3, Ceph и т. д.). Если доступного S3-хранилища нет, разверните экземпляр MinIO (встроенный S3) в кластере [Развернуть MinIO](/storage/storagesystem_minio/installation.mdx).

## Установка Alauda Container Platform Registry через YAML

### Процедура

1. ​**Создайте файл конфигурации YAML**​​ с именем registry-plugin.yaml, используя следующий шаблон:

```yaml
apiVersion: cluster.alauda.io/v1alpha1
kind: ClusterPluginInstance
metadata:
  annotations:
    cpaas.io/display-name: internal-docker-registry
  labels:
    create-by: cluster-transformer
    manage-delete-by: cluster-transformer
    manage-update-by: cluster-transformer
  name: internal-docker-registry
spec:
  config:
    access:
      address: ""
      enabled: false
    fake:
      replicas: 2
    global:
      expose: false
      isIPv6: false
      replicas: 2
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 250m
          memory: 256Mi
    ingress:
      enabled: true
      hosts:
        - name: <YOUR-DOMAIN>   # [ТРЕБУЕТСЯ] Настройте домен
          tlsCert: <NAMESPACE>/<TLS-SECRET>  # [ТРЕБУЕТСЯ] Namespace/SecretName
      ingressClassName: "<INGRESS-CLASS-NAME>"  # [ТРЕБУЕТСЯ] IngressClassName
      insecure: false
    persistence:
      accessMode: ReadWriteMany
      nodes: ""
      path: <YOUR-HOSTPATH>  # [ТРЕБУЕТСЯ] Локальный путь для LocalVolume
      size: <STORAGE-SIZE>  # [ТРЕБУЕТСЯ] Размер хранилища (например, 10Gi)
      storageClass: <STORAGE-CLASS-NAME>  # [ТРЕБУЕТСЯ] Имя StorageClass
      type: StorageClass
    s3storage:
      bucket: <S3-BUCKET-NAME>             # [ТРЕБУЕТСЯ] Имя S3-бакета
      enabled: false                        # Установите false для локального хранилища
      env:
        REGISTRY_STORAGE_S3_SKIPVERIFY: false  # Установите true для самоподписанных сертификатов
      region: <S3-REGION>                        # Регион S3
      regionEndpoint: <S3-ENDPOINT>  # Конечная точка S3
      secretName: <S3-CREDENTIALS-SECRET>             # Секрет с учетными данными S3
    service:
      nodePort: ""
      type: ClusterIP
  pluginName: internal-docker-registry
```

2. **Настройте следующие поля**​​ в соответствии с вашей средой:

```yaml
spec:
  config:
    ingress:
      hosts:
        - name: "<YOUR-DOMAIN>"                # например, registry.your-company.com
          tlsCert: "<NAMESPACE>/<TLS-SECRET>"   # например, cpaas-system/tls-secret
      ingressClassName: "<INGRESS-CLASS-NAME>"  # например, cluster-alb-1
    persistence:
      size: "<STORAGE-SIZE>"                    # например, 10Gi
      storageClass: "<STORAGE-CLASS-NAME>"      # например, cpaas-system-storage
    s3storage:
      bucket: "<S3-BUCKET-NAME>"                # например, prod-registry
      region: "<S3-REGION>"                    # например, us-west-1
      regionEndpoint: "<S3-ENDPOINT>"          # например, https://s3.amazonaws.com
      secretName: "<S3-CREDENTIALS-SECRET>"     # Секрет, содержащий AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY
      env:
        REGISTRY_STORAGE_S3_SKIPVERIFY: "true"  # Установите "true" для самоподписанных сертификатов
```

3. **Как создать секрет**​​ для учетных данных S3:

```bash
kubectl create secret generic <S3-CREDENTIALS-SECRET> \
  --from-literal=access-key-id=<YOUR-S3-ACCESS-KEY-ID> \
  --from-literal=secret-access-key=<YOUR-S3-SECRET-ACCESS-KEY> \
  -n cpaas-system
```

Замените `<S3-CREDENTIALS-SECRET>` на имя вашего секрета с учетными данными S3.

4. ​​Примените конфигурацию​​ к вашему кластеру:

```bash
kubectl apply -f registry-plugin.yaml
```

### Справочник по конфигурации

#### Обязательные поля

| Параметр                              | Описание                                              | Пример значения               |
| -------------------------------------- | -------------------------------------------------------- | ----------------------------- |
| `spec.config.ingress.hosts[0].name`    | Пользовательский домен для доступа к реестру                        | `registry.yourcompany.com`    |
| `spec.config.ingress.hosts[0].tlsCert` | Ссылка на секрет с TLS-сертификатом (namespace/secret-name) | `cpaas-system/registry-tls`   |
| `spec.config.ingress.ingressClassName` | Имя класса ingress для реестра                      | `cluster-alb-1`               |
| `spec.config.persistence.size`         | Размер хранилища для реестра                            | `10Gi`                        |
| `spec.config.persistence.storageClass` | Имя StorageClass для реестра                       | `nfs-storage-sc`              |
| `spec.config.s3storage.bucket`         | Имя S3-бакета для хранения изображений                         | `prod-image-store`            |
| `spec.config.s3storage.region`         | Регион AWS для S3-хранилища                                | `us-west-1`                   |
| `spec.config.s3storage.regionEndpoint` | URL конечной точки S3-сервиса                                  | `https://s3.amazonaws.com`    |
| `spec.config.s3storage.secretName`     | Секрет, содержащий учетные данные S3                         | `s3-access-keys`              |

### Проверка

1. ​​Проверьте плагин:

```bash
kubectl get clusterplugininstances internal-docker-registry -o yaml
```

2. Проверьте поды реестра​​:

```bash
kubectl get pods -n cpaas-system -l app=internal-docker-registry
```

## Обновление/Удаление Alauda Container Platform Registry

### Обновление

Выполните следующую команду в глобальном кластере:

```bash
# <CLUSTER-NAME> - это кластер, в котором установлен плагин
kubectl edit -n cpaas-system \
  $(kubectl get moduleinfo -n cpaas-system -l cpaas.io/cluster-name=<CLUSTER-NAME>,cpaas.io/module-name=internal-docker-registry -o name)
```

### Удаление

Выполните следующую команду в глобальном кластере:

```bash
# <CLUSTER-NAME> - это кластер, в котором установлен плагин
kubectl get moduleinfo -n cpaas-system -l cpaas.io/cluster-name=<CLUSTER-NAME>,cpaas.io/module-name=internal-docker-registry -o name | xargs kubectl delete -n cpaas-system
```
