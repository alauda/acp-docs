---
weight: 40
i18n:
  title:
    en: CronJobs
    zh: 定时任务
title: CronJobs
sourceSHA: 29f46cf70a775c302e6b72ff3a0babde79223533dd1149d3b26a38f8bbfb60b1
---

# CronJobs

## Понимание CronJobs

Смотрите официальную документацию Kubernetes:

- [CronJobs](https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/)
- [Запуск автоматизированных задач с помощью CronJob](https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/)

**CronJob** определяет задачи, которые выполняются до завершения, а затем останавливаются. Они позволяют вам многократно запускать одну и ту же задачу в соответствии с расписанием.

**CronJob** — это тип контроллера нагрузки в Kubernetes. Вы можете создать CronJob через веб-консоль или CLI для периодического или повторяющегося выполнения непостоянной программы, такой как запланированные резервные копии, запланированные очистки или запланированные отправки электронной почты.

## Предпосылки

Получите адрес изображения. Изображения могут быть получены из репозитория изображений, интегрированного администратором платформы через цепочку инструментов, или из сторонних репозиториев изображений.

- Для изображений из интегрированного репозитория администратор обычно назначает репозиторий изображений вашему проекту, позволяя вам использовать изображения в нем. Если требуемый репозиторий изображений не найден, пожалуйста, свяжитесь с администратором для его выделения.

- Если вы используете сторонний репозиторий изображений, убедитесь, что изображения могут быть загружены непосредственно из него в текущем кластере.

## Пример файла YAML

```yaml
# example-cronjob.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello
spec:
  schedule: "* * * * *" 
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox:1.28
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
          restartPolicy: OnFailure
```

## Создание CronJobs с помощью CLI

```bash
kubectl apply -f example-cronjob.yaml
```

## Создание CronJobs с помощью веб-консоли

### Процедура - Настройка основной информации

1. **Платформа контейнеров**, перейдите в **Нагрузки** > **CronJobs** в боковом меню слева.

2. Нажмите **Создать CronJob**.

3. **Выберите** или **Введите** изображение и нажмите **Подтвердить**.

   **Примечание**: Фильтрация изображений доступна только при использовании изображений из интегрированного репозитория изображений платформы. Например, интегрированное имя проекта, такое как *containers (docker-registry-projectname)*, указывает на имя проекта платформы *projectname* и имя проекта репозитория изображений *containers*.

4. В разделе **Конфигурация Cron** настройте метод выполнения задачи и связанные параметры.

   **Тип выполнения**:

   - **Ручной**: Ручное выполнение требует явного ручного запуска для каждого выполнения задачи.
   - **Запланированный**: Запланированное выполнение требует настройки следующих параметров расписания:

     | **Параметр**          | **Описание**                                                                                                                                                                                                                                                                                                                                                                                                          |
     | :--------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
     | **Расписание**         | Определите расписание cron, используя [синтаксис Crontab](https://crontab.guru/). Контроллер CronJob рассчитывает следующее время выполнения на основе выбранного часового пояса. <br /><br />**Примечания**:<ul><li>Для кластеров Kubernetes \< v1.25: Выбор часового пояса не поддерживается; расписания ДОЛЖНЫ использовать UTC.</li><li>Для кластеров Kubernetes ≥ v1.25: Поддерживается учет часовых поясов (по умолчанию: местное время пользователя).</li></ul> |
     | **Политика конкуренции** | Укажите, как обрабатываются параллельные выполнения задач (`Разрешить`, `Запретить` или `Заменить` согласно [спецификации K8s](https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/#concurrency-policy)).                                                                                                                                                                                                                             |

   **Сохранение истории задач**:

   - Установите пределы хранения для завершенных задач:
     - **Исторические пределы**: Предел истории успешных задач (по умолчанию: 20)
     - **Неуспешные задачи**: Предел истории неуспешных задач\*\* (по умолчанию: 20)
   - Когда пределы хранения превышены, самые старые задачи сначала подвергаются сбору мусора.

5. В разделе **Конфигурация задачи** выберите тип задачи.
   CronJob управляет задачами, состоящими из Pods. Настройте шаблон задачи в зависимости от типа вашей нагрузки:

   | **Параметр**      | **Описание**                                                                                                                                                                                            |
   | :---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Тип задачи**     | Выберите режим завершения задачи (`Не параллельный`, `Параллельный с фиксированным количеством завершений` или `Индексионная задача` согласно [шаблонам Job K8s](https://kubernetes.io/docs/concepts/workloads/controllers/job/#job-patterns)). |
   | **Предельное количество повторных попыток** | Установите максимальное количество попыток повторного выполнения перед тем, как пометить задачу как неуспешную.                                                                                                                                                 |

### Процедура - Настройка Pod

- В разделе **Pod** смотрите [Создание развертывания - Настройка Pod](./deployment_create.mdx#configurepod)

### Процедура - Настройка контейнеров

- В разделе **Контейнер** смотрите [Создание развертывания - Настройка контейнеров](./deployment_create.mdx#configurecontainers)

### Создать

- Нажмите **Создать**.

## Выполнить немедленно

### Найдите ресурс CronJob

- **веб-консоль**: **Платформа контейнеров**, перейдите в **Нагрузки** > **CronJobs** в боковом меню слева.
- **CLI**:
  ```bash
  kubectl get cronjobs -n <namespace>
  ```

### Запустите ад-хок выполнение

- **веб-консоль**: **Выполнить немедленно**
  1. Нажмите на вертикальные многоточие (⋮) с правой стороны списка cronjob.
  2. Нажмите **Выполнить немедленно**. (В качестве альтернативы, на странице сведений о CronJob нажмите Действия в верхнем правом углу и выберите **Выполнить немедленно**).
- **CLI**:
  ```bash
  kubectl create job --from=cronjob/<cronjob-name> <job-name> -n <namespace>
  ```

### Проверьте детали задачи:

```bash
kubectl describe job/<job-name> -n <namespace>
kubectl logs job/<job-name> -n <namespace>
```

### Мониторинг статуса выполнения

| Статус        | Описание                                                                              |
| ------------- | ---------------------------------------------------------------------------------------- |
| **В ожидании**   | Задача создана, но еще не запланирована.                                          |
| **Выполняется**   | Задача Pod(ы) активно выполняется.                                                   |
| **Успешно** | Все Pods успешно завершили выполнение (код выхода 0).                   |
| **Неуспешно**    | По меньшей мере один Pod завершился с ошибкой (код выхода не равен нулю). |

## Удаление CronJobs

### Удаление CronJobs с помощью веб-консоли

1. **Платформа контейнеров**, перейдите в **Нагрузки** > **CronJobs**.
2. Найдите CronJobs, которые вы хотите удалить.
3. В выпадающем меню **Действия** нажмите кнопку **Удалить** и подтвердите.

### Удаление CronJobs с помощью CLI

```bash
kubectl delete cronjob <cronjob-name>
```
