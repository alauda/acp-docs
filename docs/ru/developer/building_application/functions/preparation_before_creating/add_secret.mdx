---
weight: 30
i18n:
  title:
    en: Configuring Secrets
    zh: 配置 Secrets
title: Настройка секретов
sourceSHA: 29d58813bfd1557c0a2d37971ec540cd4aaec8c1ed4356b5c1678923bbf8ddd2
---

# Настройка секретов

## Понимание секретов

В Kubernetes (k8s) секрет — это основной объект, предназначенный для хранения и управления конфиденциальной информацией, такой как пароли, OAuth токены, SSH ключи, TLS сертификаты и API ключи. Его основная цель — предотвратить прямое встраивание конфиденциальных данных в определения подов или образы контейнеров, тем самым повышая безопасность и портативность.

Секреты похожи на ConfigMaps, но специально предназначены для конфиденциальных данных. Они обычно кодируются в формате base64 для хранения и могут использоваться подами различными способами, включая монтирование в качестве томов или выставление в качестве переменных окружения.

### Характеристики использования

- **Повышенная безопасность**: По сравнению с конфигурационными картами в открытом виде (Kubernetes ConfigMap), секреты предлагают лучшую безопасность, храня конфиденциальную информацию с использованием кодирования Base64. Этот механизм, в сочетании с возможностью Kubernetes контролировать доступ, значительно снижает риск раскрытия данных.

- **Гибкость и управление**: Использование секретов предоставляет более безопасный и гибкий подход, чем жесткое кодирование конфиденциальной информации непосредственно в файлы определения подов или образы контейнеров. Это разделение упрощает управление и модификацию конфиденциальных данных без необходимости вносить изменения в код приложения или образы контейнеров.

### Поддерживаемые типы

Kubernetes поддерживает различные типы секретов, каждый из которых предназначен для конкретных случаев использования. Платформа обычно поддерживает следующие типы:

- **Opaque**: Секрет общего назначения, используемый для хранения произвольных пар ключ-значение конфиденциальных данных, таких как пароли или API ключи.

- **TLS**: Специально предназначен для хранения информации о сертификатах и закрытых ключах протокола TLS (Transport Layer Security), обычно используемого для HTTPS связи и безопасного входа.

- **SSH Key**: Используется для хранения закрытых ключей SSH, часто для безопасного доступа к репозиториям Git или другим сервисам с поддержкой SSH.

- **SSH Authentication (kubernetes.io/ssh-auth)**: Хранит информацию для аутентификации данных, передаваемых по протоколу SSH.

- **Username/Password (kubernetes.io/basic-auth)**: Используется для хранения учетных данных базовой аутентификации (имя пользователя и пароль).

- **Image Pull Secret (kubernetes.io/dockerconfigjson)**: Хранит строку аутентификации в формате JSON, необходимую для извлечения образов контейнеров из частных репозиториев образов (Docker Registry).

### Методы использования

Секреты могут использоваться приложениями внутри подов различными способами:

- **В качестве переменных окружения**: Конфиденциальные данные из секрета могут быть непосредственно внедрены в переменные окружения контейнера.

- **В качестве смонтированных файлов (том)**: Секреты могут быть смонтированы как файлы в томах пода, позволяя приложениям считывать конфиденциальные данные из указанного пути к файлу.

**Примечание**: Экземпляры подов в рабочих нагрузках могут ссылаться только на секреты в том же пространстве имен. Для более сложного использования и конфигураций YAML обратитесь к [официальной документации Kubernetes](https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets).

## Создание секрета типа Opaque

```shell
kubectl create secret generic my-secret \
  --from-literal=username=admin \
  --from-literal=password=Pa$$w0rd
```

YAML

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-secret
type: Opaque
data:
  username: YWRtaW4= # base64 от "admin"
  password: UGEkJHcwcmQ= # base64 от "Pa$$w0rd"
```

Вы можете декодировать их следующим образом:

```shell
echo YWRtaW4= | base64 --decode  # вывод: admin
```

## Создание секрета типа Docker registry

```shell
kubectl create secret docker-registry my-docker-creds \
  --docker-username=myuser \
  --docker-password=mypass \
  --docker-server=https://index.docker.io/v1/ \
  --docker-email=my@example.com
```

YAML

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-docker-creds
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJteXVzZXIiLCJwYXNzd29yZCI6Im15cGFzcyIsImVtYWlsIjoibXlAZXhhbXBsZS5jb20iLCJhdXRoIjoiYlhsMWMyVnlPbTE1Y0dGemN3PT0ifX19
```

K8s автоматически преобразует ваше имя пользователя, пароль, адрес электронной почты и информацию о сервере в стандартный формат входа Docker:

```json
{
  "auths": {
    "https://index.docker.io/v1/": {
      "username": "myuser",
      "password": "mypass",
      "email": "my@example.com",
      "auth": "bXl1c2VyOm15cGFzcw=="  # base64(username:password)
    }
  }
}
```

Этот JSON затем кодируется в base64 и используется как значение поля данных секрета.

Используйте его в поде:

```yaml
imagePullSecrets:
  - name: my-docker-creds
```

## Создание секрета типа Basic Auth

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: basic-auth-secret
type: kubernetes.io/basic-auth
stringData:
  username: myuser
  password: mypass
```

## Создание секрета типа SSH-Auth

Сценарий использования: Хранение приватных ключей SSH (например, для доступа к Git).

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: ssh-key-secret
type: kubernetes.io/ssh-auth
stringData:
  ssh-privatekey: |
    -----BEGIN OPENSSH PRIVATE KEY-----
    ...
    -----END OPENSSH PRIVATE KEY-----
```

## Создание секрета типа TLS

Сценарий использования: TLS сертификаты (используются Ingress, вебхуками и т.д.)

```shell
kubectl create secret tls tls-secret \
--cert=path/to/tls.crt \
--key=path/to/tls.key
```

YAML

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: tls-secret
type: kubernetes.io/tls
data:
  tls.crt: <base64>
  tls.key: <base64>
```

## Создание секрета с помощью веб-консоли

1. Перейдите в **Платформа контейнеров**.

2. В левой навигационной панели нажмите **Конфигурация** > **Секреты**.

3. Нажмите **Создать секрет**.

4. Настройте параметры.

   **Примечание**: В представлении формы чувствительные данные, такие как вводимое имя пользователя и пароль, будут автоматически закодированы в формате Base64 перед тем, как быть сохраненными в секрете. Преобразованные данные можно предварительно просмотреть в представлении YAML.

5. Нажмите **Создать**.

## Как использовать секрет в поде

### В качестве переменных окружения

```yaml
env:
  - name: DB_USERNAME
    valueFrom:
      secretKeyRef:
        name: my-secret
        key: username
```

Из секрета с именем `my-secret` возьмите значение с ключом `username` и присвойте его переменной окружения `DB_USERNAME`.

### В качестве смонтированных файлов (том)

```yaml
volumes:
  - name: secret-volume
    secret:
      secretName: my-secret

volumeMounts:
  - name: secret-volume
    mountPath: "/etc/secret"
```

## Последующие действия

При создании рабочих нагрузок для нативных приложений в том же пространстве имен вы можете ссылаться на уже созданные секреты.

## Операции

Вы можете нажать (⋮) на правой стороне страницы списка или нажать **Действия** в правом верхнем углу страницы сведений, чтобы при необходимости обновить или удалить секрет.

| Операция   | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Обновить** | После добавления или обновления секрета рабочие нагрузки, которые ссылались на этот секрет (или его конфигурационные элементы) через переменные окружения, должны иметь свои поды перестроенными, чтобы новая конфигурация вступила в силу.                                                                                                                                                                                                                                                                                             |
| **Удалить**  | <ul><li>После удаления секрета рабочие нагрузки, которые ссылались на этот секрет (или его конфигурационные элементы) через переменные окружения, могут быть затронуты из-за невозможности найти источник ссылки при перестройке подов.</li><li>Пожалуйста, не удаляйте секреты, автоматически сгенерированные платформой, так как это может предотвратить правильное функционирование платформы. Например: секреты типа service-account-token, содержащие информацию для аутентификации ресурсов пространства имен, и секреты в системных пространствах имен (таких как kube-system).</li></ul> |
