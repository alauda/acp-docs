---
weight: 100
sourceSHA: 2c551cd7314d3f777751daf446ec416d209f91027c18f3d5606b428f33c90c2b
---

# Проверка состояния

## Понимание проверок состояния

Смотрите официальную документацию Kubernetes:

- [Проверки живости, готовности и запуска](https://kubernetes.io/docs/concepts/configuration/liveness-readiness-startup-probes/)
- [Настройка проверок живости, готовности и запуска](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/)

> В Kubernetes проверки состояния, также известные как пробы, являются критически важным механизмом для обеспечения высокой доступности и устойчивости ваших приложений. Kubernetes использует эти пробы для определения состояния и готовности ваших Pod, позволяя системе предпринимать соответствующие действия, такие как перезапуск контейнеров или маршрутизация трафика. Без надлежащих проверок состояния Kubernetes не может надежно управлять жизненным циклом вашего приложения, что может привести к ухудшению обслуживания или сбоям.

Kubernetes предлагает три типа проб:

- `livenessProbe`: Определяет, работает ли контейнер. Если проверка живости не проходит, Kubernetes завершит работу Pod и перезапустит его в соответствии с политикой перезапуска.
- `readinessProbe`: Определяет, готов ли контейнер обслуживать трафик. Если проверка готовности не проходит, контроллер конечных точек удаляет Pod из списка конечных точек сервиса до тех пор, пока проверка не будет успешной.
- `startupProbe`: Специально проверяет, успешно ли запустилось приложение. Пробы живости и готовности не будут выполняться, пока проверка запуска не будет успешной. Это очень полезно для приложений с длительным временем запуска.

Правильная настройка этих проб имеет решающее значение для создания надежных и самовосстанавливающихся приложений на Kubernetes.

### Типы проб

Kubernetes поддерживает три механизма для реализации проб:

#### HTTP `GET` Действие

> Выполняет HTTP `GET` запрос к IP-адресу Pod на указанном порту и пути. Проверка считается успешной, если код ответа находится в диапазоне от 200 до 399.

- **Сценарии использования**: Веб-серверы, REST API или любое приложение, открывающее HTTP конечную точку.
- **Пример**:

```yaml
livenessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 15
  periodSeconds: 20
```

#### `exec` Действие

> Выполняет указанную команду внутри контейнера. Проверка успешна, если команда завершилась с кодом состояния 0.

- **Сценарии использования**: Приложения без HTTP конечных точек, проверка внутреннего состояния приложения или выполнение сложных проверок состояния, требующих специфических инструментов.

- **Пример**:

```yaml
readinessProbe:
  exec:
    command:
    - cat
    - /tmp/healthy
  initialDelaySeconds: 5
  periodSeconds: 5
```

#### TCP `Socket` Действие

> Пытается открыть TCP-сокет на IP-адресе контейнера и указанном порту. Проверка успешна, если TCP-соединение может быть установлено.

- **Сценарии использования**: Базы данных, очереди сообщений или любое приложение, которое общается через TCP-порт, но может не иметь HTTP конечной точки.

**Пример**:

```yaml
startupProbe:
  tcpSocket:
    port: 3306
  initialDelaySeconds: 5
  periodSeconds: 10
  failureThreshold: 30
```

### Лучшие практики

- **Живость** против **Готовности**:
  - **Живость**: Если ваше приложение не отвечает, лучше его перезапустить. Если оно не работает, Kubernetes перезапустит его.
  - **Готовность**: Если ваше приложение временно не может обслуживать трафик (например, подключение к базе данных), но может восстановиться без перезапуска, используйте проверку готовности. Это предотвращает маршрутизацию трафика к нездоровому экземпляру.
- **Проверки запуска для медленных приложений**: Используйте проверки запуска для приложений, которые требуют значительного времени для инициализации. Это предотвращает преждевременные перезапуски из-за неудач проверок живости или проблемы с маршрутизацией трафика из-за неудач проверок готовности во время запуска.
- **Легковесные пробы**: Убедитесь, что ваши конечные точки проб легковесны и выполняются быстро. Они не должны включать тяжелые вычисления или внешние зависимости (например, вызовы к базе данных), которые могут сделать саму проверку ненадежной.
- **Содержательные проверки**: Проверки проб должны действительно отражать состояние здоровья и готовности вашего приложения, а не просто то, работает ли процесс. Например, для веб-сервера проверьте, может ли он обслуживать базовую страницу, а не просто открыт ли порт.
- **Настройка initialDelaySeconds**: Установите initialDelaySeconds соответствующим образом, чтобы дать вашему приложению достаточно времени для запуска перед первой проверкой.
- **Настройка periodSeconds и failureThreshold**: Найдите баланс между необходимостью быстрой диагностики сбоев и избеганием ложных срабатываний. Слишком частые пробы или слишком низкий failureThreshold могут привести к ненужным перезапускам или состояниям "не готов".
- **Логи для отладки**: Убедитесь, что ваше приложение записывает четкие сообщения, связанные с вызовами конечных точек проверки состояния и внутренним состоянием, чтобы помочь в отладке сбоев проб.
- **Комбинирование проб**: Часто все три пробы (живость, готовность, запуск) используются вместе для эффективного управления жизненным циклом приложения.

<a id="healthcheckyamlexample" />

## Пример файла YAML

```yaml
spec:
  template:
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2 # Образ контейнера
        ports:
        - containerPort: 80 # Открытый порт контейнера
        startupProbe:
          httpGet:
            path: /startup-check
            port: 8080
          initialDelaySeconds: 0 # Обычно 0 для проверок запуска или очень маленькое значение
          periodSeconds: 5
          failureThreshold: 60 # Позволяет 60 * 5 = 300 секунд (5 минут) для запуска
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 5  # Задержка 5 секунд после запуска Pod перед проверкой
          periodSeconds: 10       # Проверка каждые 10 секунд
          timeoutSeconds: 5       # Таймаут через 5 секунд
          failureThreshold: 3     # Считать нездоровым после 3 последовательных сбоев
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
```

<a id="healthcheckparameters" />

## Параметры конфигурации проверок состояния с использованием веб-консоли

### Общие параметры

| **Параметры**        | **Описание**                                                                                                                                                  |
| :-------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Начальная задержка** | `initialDelaySeconds`: Период ожидания (в секундах) перед началом проверок. По умолчанию: `300`.                                                                            |
| **Период**            | `periodSeconds`: Интервал проверки (1-120с). По умолчанию: `60`.                                                                                                         |
| **Таймаут**           | `timeoutSeconds`: Длительность таймаута проверки (1-300с). По умолчанию: `30`.                                                                                                |
| **Порог успеха**      | `successThreshold`: Минимальное количество последовательных успешных проверок для обозначения здоровья. По умолчанию: `0`.                                                                                 |
| **Порог неудачи**     | `failureThreshold`: Максимальное количество последовательных неудач для инициирования действия:<br />- `0`: Отключает действия на основе неудач<br />- По умолчанию: `5` неудач → перезапуск контейнера. |

### Параметры, специфичные для протокола

| **Параметр**    | **Применимые протоколы** | **Описание**                                                                                                                                              |
| :--------------- | :----------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Протокол**     | HTTP/HTTPS               | Протокол проверки состояния                                                                                                                                        |
| **Порт**         | HTTP/HTTPS/TCP           | Целевой порт контейнера для проверки.                                                                                                                           |
| **Путь**         | HTTP/HTTPS               | Путь конечной точки (например, `/healthz`).                                                                                                                            |
| **HTTP Заголовки** | HTTP/HTTPS               | Пользовательские заголовки (Добавьте пары ключ-значение).                                                                                                                        |
| **Команда**      | EXEC                     | Команда проверки, выполняемая в контейнере (например, `sh -c "curl -I localhost:8080 \| grep OK"`).<br />**Примечание**: Экранируйте специальные символы и проверьте работоспособность команды. |

<a id="healthchecktroubleshooting" />

## Устранение неполадок сбоев проб

Когда статус Pod указывает на проблемы, связанные с пробами, вот как их устранить:

### **Проверьте события pod**

```bash
kubectl describe pod <pod-name>
```

Ищите события, связанные с неудачами LivenessProbe, ReadinessProbe или StartupProbe. Эти события часто содержат конкретные сообщения об ошибках (например, отказ в соединении, ошибка HTTP 500, код выхода команды).

### **Просмотр логов контейнера**

```bash
kubectl logs <pod-name> -c <container-name>
```

Изучите логи приложения, чтобы увидеть, есть ли ошибки или предупреждения в момент, когда проверка не прошла. Ваше приложение может записывать, почему его конечная точка состояния не отвечает должным образом.

### **Проверьте конечную точку проб вручную**

- **HTTP**: Если возможно, `kubectl exec -it <pod-name> -- curl <probe-path>:<probe-port>` или `wget` изнутри контейнера, чтобы увидеть фактический ответ.
- **Exec**: Запустите команду проверки вручную: `kubectl exec -it <pod-name> -- <command-from-probe>` и проверьте ее код выхода и вывод.
- **TCP**: Используйте `nc` (netcat) или `telnet` из другого Pod в той же сети или с хоста, если это разрешено, чтобы протестировать TCP-соединение: `kubectl exec -it <another-pod> -- nc -vz <pod-ip> <probe-port>`.

### **Проверьте конфигурацию проб**

- Дважды проверьте параметры проб (путь, порт, команда, задержки, пороги) в вашем YAML для Deployment/Pod. Распространенной ошибкой является неправильный порт или путь.

### **Проверьте код приложения**

- Убедитесь, что конечная точка проверки состояния вашего приложения правильно реализована и действительно отражает готовность/живость приложения. Иногда конечная точка может возвращать успех, даже когда само приложение сломано.

### **Ограничения ресурсов**

- Недостаток ресурсов CPU или памяти может привести к тому, что ваше приложение станет неотзывчивым, что приведет к сбоям проб. Проверьте использование ресурсов Pod (`kubectl top pod <pod-name>`) и подумайте о корректировке лимитов/запросов `resources`.

### **Сетевые проблемы**

- В редких случаях сетевые политики или проблемы CNI могут помешать пробам достичь контейнера. Проверьте сетевую связанность внутри кластера.
