---
weight: 120
sourceSHA: 39ddc9c2ecf56fb0c97e82c90d7fc955bb07be34c7e799e3a73a1c2e7e8e78f9
---

# Работа с Helm-чартами

## 1. Понимание Helm

Helm — это менеджер пакетов, который упрощает развертывание приложений и сервисов на кластерах Alauda Container Platform. Helm использует формат упаковки, называемый *чартами*. Helm-чарт — это набор файлов, описывающих ресурсы Kubernetes. Создание чарта в кластере генерирует экземпляр чарта, называемый *релизом*. Каждый раз, когда создается чарт или обновляется или откатывается релиз, создается инкрементальная ревизия.

### 1.1. Ключевые особенности

Helm предоставляет возможность:

- Искать большое количество чартов в репозиториях чартов
- Модифицировать существующие чарты
- Создавать собственные чарты с использованием ресурсов Kubernetes
- Упаковывать приложения и делиться ими в виде чартов

### 1.2. Каталог

Каталог построен на основе Helm и предоставляет комплексную платформу управления распределением чартов, расширяя ограничения инструмента Helm CLI. Платформа позволяет разработчикам более удобно управлять, развертывать и использовать чарты через удобный интерфейс.

#### Определения терминов

| Термин               | Определение                                                  | Примечания           |
| --------------------| ------------------------------------------------------------ | -------------------- |
| Каталог приложений   | Платформа единого управления для Helm-чартов               |                      |
| Helm-чарты          | Формат упаковки приложений                                   |                      |
| HelmRequest          | CRD. Определяет конфигурацию, необходимую для развертывания Helm-чарта | Шаблон приложения    |
| ChartRepo            | CRD. Соответствует репозиторию Helm-чартов                 | Шаблон репозитория   |
| Чарт                | CRD. Соответствует Helm-чартам                              | Шаблон               |

### 1.3 Понимание HelmRequest

В Alauda Container Platform развертывания Helm в основном управляются через пользовательский ресурс, называемый **HelmRequest**. Этот подход расширяет стандартную функциональность Helm и интегрирует ее в нативную модель ресурсов Kubernetes.

##### Различия между HelmRequest и Helm

Стандартный Helm использует команды CLI для управления релизами, в то время как Alauda Container Platform использует ресурсы HelmRequest для определения, развертывания и управления Helm-чартами. Ключевые различия включают:

1. **Декларативный против Императивного**: HelmRequest предоставляет декларативный подход к развертываниям Helm, в то время как традиционный Helm CLI является императивным.
2. **Нативный для Kubernetes**: HelmRequest — это пользовательский ресурс, непосредственно интегрированный с API Kubernetes.
3. **Непрерывная согласованность**: Captain постоянно отслеживает и согласовывает ресурсы HelmRequest с их желаемым состоянием.
4. **Поддержка нескольких кластеров**: HelmRequest поддерживает развертывания в нескольких кластерах через платформу.
5. **Интеграция функций платформы**: HelmRequest может быть интегрирован с другими функциями платформы, такими как ресурсы приложений.

##### Интеграция HelmRequest и приложения

Ресурсы HelmRequest и приложения имеют концептуальные сходства, и пользователи могут захотеть рассматривать их единообразно. Платформа предоставляет механизм для синхронизации HelmRequest как ресурсов приложений.

Пользователи могут пометить HelmRequest для развертывания как приложение, добавив следующую аннотацию:

```
alauda.io/create-app: "true"
```

Когда эта функция включена, интерфейс платформы отображает дополнительные поля и ссылки на соответствующую страницу приложения.

##### Рабочий процесс развертывания

Рабочий процесс развертывания чартов через HelmRequest включает:

1. **Пользователь** создает или обновляет ресурс HelmRequest
2. **HelmRequest** содержит ссылки на чарт и значения для применения
3. **Captain** обрабатывает HelmRequest и создает Helm Release
4. **Release** содержит развернутые ресурсы
5. **Metis** отслеживает HelmRequests с аннотациями приложений и синхронизирует их с приложениями
6. **Приложение** предоставляет единый обзор развернутых ресурсов

##### Определения компонентов

- **HelmRequest**: Определение пользовательского ресурса, описывающее желаемое развертывание Helm-чарта
- **Captain**: Контроллер, который обрабатывает ресурсы HelmRequest и управляет релизами Helm (исходный код доступен по адресу [https://github.com/alauda/captain](https://github.com/alauda/captain))
- **Release**: Развернутый экземпляр Helm-чарта
- **Charon**: Компонент, который отслеживает HelmRequests и создает соответствующие ресурсы приложений
- **Приложение**: Единое представление развернутых ресурсов, предоставляющее дополнительные возможности управления
- **Archon-api**: Компонент, отвечающий за определенные расширенные функции API в рамках платформы

## 2 Развертывание Helm-чартов как приложений через CLI

### 2.1 Обзор рабочего процесса

Подготовить чарт → Упаковать чарт → Получить токен API → Создать репозиторий чартов → Загрузить чарт → Загрузить связанные образы → Развернуть приложение → Обновить приложение → Удалить приложение → Удалить репозиторий чартов

### 2.2 Подготовка чарта

Helm использует формат упаковки, называемый чартами. Чарт — это набор файлов, описывающих ресурсы Kubernetes. Один чарт может использоваться для развертывания всего, от простого пода до сложного стека приложений.

Смотрите официальную документацию: [Документация Helm Charts](https://helm.sh/docs/topics/charts/)

Пример структуры каталога чарта:

```
nginx/
├── Chart.lock
├── Chart.yaml
├── README.md
├── charts/
│   └── common/
│       ├── Chart.yaml
│       ├── README.md
│       ├── templates/
│       │   ├── _affinities.tpl
│       │   ├── _capabilities.tpl
│       │   ├── _errors.tpl
│       │   ├── _images.tpl
│       │   ├── _ingress.tpl
│       │   ├── _labels.tpl
│       │   ├── _names.tpl
│       │   ├── _secrets.tpl
│       │   ├── _storage.tpl
│       │   ├── _tplvalues.tpl
│       │   ├── _utils.tpl
│       │   ├── _warnings.tpl
│       │   └── validations/
│       │       ├── _cassandra.tpl
│       │       ├── _mariadb.tpl
│       │       ├── _mongodb.tpl
│       │       ├── _postgresql.tpl
│       │       ├── _redis.tpl
│       │       └── _validations.tpl
│       └── values.yaml
├── ci/
│   ├── ct-values.yaml
│   └── values-with-ingress-metrics-and-serverblock.yaml
├── templates/
│   ├── NOTES.txt
│   ├── _helpers.tpl
│   ├── deployment.yaml
│   ├── extra-list.yaml
│   ├── health-ingress.yaml
│   ├── hpa.yaml
│   ├── ingress.yaml
│   ├── ldap-daemon-secrets.yaml
│   ├── pdb.yaml
│   ├── server-block-configmap.yaml
│   ├── serviceaccount.yaml
│   ├── servicemonitor.yaml
│   ├── svc.yaml
│   └── tls-secrets.yaml
├── values.descriptor.yaml
├── values.schema.json
└── values.yaml
```

Описание ключевых файлов:

- `values.descriptor.yaml` (необязательный): Работает с ACP UI для отображения удобных форм
- `values.schema.json` (необязательный): Проверяет содержимое values.yaml и отображает простой интерфейс
- `values.yaml` (обязательный): Определяет параметры развертывания чарта

### 2.3 Упаковка чарта

Используйте команду `helm package` для упаковки чарта:

```bash
helm package nginx
# Вывод: Успешно упакован чарт и сохранен в: /charts/nginx-8.8.0.tgz
```

### 2.4 Получение токена API

1. В **Alauda Container Platform** нажмите на аватар в правом верхнем углу => **Профиль**
2. Нажмите **Добавить токен API**
3. Введите соответствующее описание и оставшуюся действительность
4. Сохраните отображаемую информацию о токене (показывается только один раз)

### 2.5 Создание репозитория чартов

Создайте локальный репозиторий чартов через API:

```bash
curl -k --request POST \
--url https://$ACP_DOMAIN/catalog/v1/chartrepos \
--header 'Authorization:Bearer $API_TOKEN' \
--header 'Content-Type: application/json' \
--data '{
  "apiVersion": "v1",
  "kind": "ChartRepoCreate",
  "metadata": {
    "name": "test",
    "namespace": "cpaas-system"
  },
  "spec": {
    "chartRepo": {
      "apiVersion": "app.alauda.io/v1beta1",
      "kind": "ChartRepo",
      "metadata": {
        "name": "test",
        "namespace": "cpaas-system",
        "labels": {
          "project.cpaas.io/catalog": "true"
        }
      },
      "spec": {
        "type": "Local",
        "url": null,
        "source": null
      }
    }
  }
}'
```

### 2.6 Загрузка чарта

Загрузите упакованный чарт в репозиторий:

```bash
curl -k --request POST \
--url https://$ACP_DOMAIN/catalog/v1/chartrepos/cpaas-system/test/charts \
--header 'Authorization:Bearer $API_TOKEN' \
--data-binary @"/root/charts/nginx-8.8.0.tgz"
```

### 2.7 Загрузка связанных изображений

1. Скачайте изображение: `docker pull nginx`
2. Сохраните как tar-пакет: `docker save nginx > nginx.latest.tar`
3. Загрузите и отправьте в частный реестр:

```bash
docker load -i nginx.latest.tar
docker tag nginx:latest 192.168.80.8:30050/nginx:latest
docker push 192.168.80.8:30050/nginx:latest
```

### 2.8 Развертывание приложения

Создайте ресурс приложения через API:

```bash
curl -k --request POST \
--url https://$ACP_DOMAIN/acp/v1/kubernetes/$CLUSTER_NAME/namespaces/$NAMESPACE/applications \
--header 'Authorization:Bearer $API_TOKEN' \
--header 'Content-Type: application/json' \
--data '{
  "apiVersion": "app.k8s.io/v1beta1",
  "kind": "Application",
  "metadata": {
    "name": "test",
    "namespace": "catalog-ns",
    "annotations": {
      "app.cpaas.io/chart.source": "test/nginx",
      "app.cpaas.io/chart.version": "8.8.0",
      "app.cpaas.io/chart.values": "{\"image\":{\"pullPolicy\":\"IfNotPresent\"}}"
    },
    "labels": {
      "sync-from-helmrequest": "true"
    }
  }
}'
```

### 2.9 Обновление приложения

Обновите приложение с помощью PATCH-запроса:

```bash
curl -k --request PATCH \
--url https://$ACP_DOMAIN/acp/v1/kubernetes/$CLUSTER_NAME/namespaces/$NAMESPACE/applications/test \
--header 'Authorization:Bearer $API_TOKEN' \
--header 'Content-Type: application/merge-patch+json' \
--data '{
  "apiVersion": "app.k8s.io/v1beta1",
  "kind": "Application",
  "metadata": {
    "annotations": {
      "app.cpaas.io/chart.values": "{\"image\":{\"pullPolicy\":\"Always\"}}"
    }
  }
}'
```

### 2.10 Удаление приложения

Удалите ресурс приложения:

```bash
curl -k --request DELETE \
--url https://$ACP_DOMAIN/acp/v1/kubernetes/$CLUSTER_NAME/namespaces/$NAMESPACE/applications/test \
--header 'Authorization:Bearer $API_TOKEN'
```

### 2.11 Удаление репозитория чартов

```bash
curl -k --request DELETE \
--url https://$ACP_DOMAIN/apis/app.alauda.io/v1beta1/namespaces/cpaas-system/chartrepos/test \
--header 'Authorization:Bearer $API_TOKEN'
```

## 3. Развертывание Helm-чартов как приложений через UI

### 3.1 Обзор рабочего процесса

Добавить шаблоны в управляемые репозитории → Загрузить шаблоны → Управлять версиями шаблонов

### 3.2 Предварительные условия

Шаблонные репозитории добавляются администраторами платформы. Пожалуйста, свяжитесь с администратором платформы, чтобы получить доступные имена репозиториев шаблонов типа Chart или OCI Chart с правами **Управления**.

### 3.3 Добавление шаблонов в управляемые репозитории

1. Перейдите в **Каталог**.

2. В левой навигационной панели нажмите **Helm Charts**.

3. Нажмите **Добавить шаблон** в правом верхнем углу страницы и выберите репозиторий шаблонов на основе следующих параметров.

   | Параметр              | Описание                                                                                                                                                                                                                                                                                                      |
   | --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Репозиторий шаблонов** | Синхронизируйте шаблон непосредственно с репозиторием шаблонов типа Chart или OCI Chart с правами **Управления**. Владельцы проектов, назначенные этому **Репозиторию шаблонов**, могут напрямую использовать шаблон.                                                                                                       |
   | **Каталог шаблонов**  | Когда выбранный тип репозитория шаблонов — OCI Chart, необходимо выбрать или вручную ввести каталог для хранения Helm Chart. <br />**Примечание**: При ручном вводе нового каталога шаблонов платформа создаст этот каталог в репозитории шаблонов, но существует риск неудачи создания. |

4. Нажмите **Загрузить шаблон** и загрузите локальный шаблон в репозиторий.

5. Нажмите **Подтвердить**. Процесс загрузки шаблона может занять несколько минут, пожалуйста, наберитесь терпения.

   **Примечание**: Когда статус шаблона изменится с `Загрузка` на `Загрузка успешна`, это означает, что шаблон был успешно загружен.

6. Если загрузка не удалась, пожалуйста, устраните неполадки в соответствии с следующими подсказками.

   **Примечание**: Неправильный формат файла означает, что в загруженном сжатом пакете есть проблема с файлами, такие как отсутствие содержимого или неправильное форматирование.

### 3.4 Удаление конкретных версий шаблонов

Если версия шаблона больше не актуальна, ее можно удалить.

#### Шаги для выполнения

1. Перейдите в **Каталог**.

2. В левой навигационной панели нажмите **Helm Charts**.

3. Нажмите на карточку чарта, чтобы просмотреть детали.

4. Нажмите **Управлять версиями**.

5. Найдите шаблон, который больше не актуален, нажмите **Удалить** и подтвердите.

   После удаления версии соответствующее приложение не сможет быть обновлено.
