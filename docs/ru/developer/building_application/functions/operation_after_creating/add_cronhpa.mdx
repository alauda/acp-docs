---
weight: 40
sourceSHA: c84cad64889a2fbb324440d08863abc7826004c41f8efb5d539c954a9877b49a
---

# Настройка CronHPA

Для безличных приложений с периодическими колебаниями в бизнес-использовании, CronHPA (Cron Horizontal Pod Autoscaler) поддерживает регулирование количества подов на основе установленных вами временных политик, что позволяет оптимизировать использование ресурсов в соответствии с предсказуемыми бизнес-паттернами.

## Понимание Cron Horizontal Pod Autoscalers

Вы можете создать cron horizontal pod autoscaler, чтобы указать количество подов, которые вы хотите запустить в определенные моменты времени согласно расписанию, что позволяет подготовиться к предсказуемым паттернам трафика или сократить использование ресурсов в нерабочие часы.

После создания cron horizontal pod autoscaler платформа начинает отслеживать расписание и автоматически регулирует количество подов в указанные моменты времени. Это масштабирование на основе времени происходит независимо от метрик использования ресурсов, что делает его идеальным для приложений с известными паттернами использования.

CronHPA работает, определяя одно или несколько правил расписания, каждое из которых указывает время (в формате crontab) и целевое количество реплик. Когда наступает запланированное время, CronHPA корректирует количество подов, чтобы соответствовать указанной цели, независимо от текущего использования ресурсов.

### Как работает CronHPA?

Cron horizontal pod autoscaler (CronHPA) расширяет концепцию автоматического масштабирования подов с временными контролями. CronHPA позволяет вам определить конкретные моменты времени, когда количество подов должно изменяться, что позволяет подготовиться к предсказуемым паттернам трафика или сократить использование ресурсов в нерабочие часы.

CronHPA работает, постоянно проверяя текущее время по сравнению с определенными расписаниями. Когда наступает запланированное время, контроллер корректирует количество подов, чтобы соответствовать целевому количеству реплик, указанному для этого расписания. Если несколько расписаний срабатывают одновременно, платформа будет использовать правило с более высоким приоритетом (то, которое определено раньше в конфигурации).

## Предварительные условия

Пожалуйста, убедитесь, что текущий кластер развернул компоненты мониторинга и что эти компоненты работают нормально. Вы можете проверить развертывание и состояние здоровья компонентов мониторинга, нажав в правом верхнем углу платформы <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px', verticalAlign: 'middle' }}><img src="./assets/question.png" alt="expand" style={{ verticalAlign: 'middle' }} /> <span>  > **Состояние здоровья платформы**.</span></span>.

## Создание Cron Horizontal Pod Autoscaler

### Использование CLI

Вы можете создать cron horizontal pod autoscaler, используя интерфейс командной строки, определив файл YAML и используя команду `kubectl create`. Следующий пример показывает запланированное масштабирование для объекта Deployment:

1. Создайте файл YAML с именем `cronhpa.yaml` со следующим содержимым:

```yaml
apiVersion: tkestack.io/v1 # [!code callout]
kind: CronHPA # [!code callout]
metadata:
  name: my-deployment-cronhpa # [!code callout]
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1 # [!code callout]
    kind: Deployment # [!code callout]
    name: my-deployment # [!code callout]
  crons:
  - schedule: "0 0 * * *" # [!code callout]
    targetReplicas: 0 # [!code callout]
  - schedule: "0 8 * * 1-5" # [!code callout]
    targetReplicas: 3 # [!code callout]
  - schedule: "0 18 * * 1-5" # [!code callout]
    targetReplicas: 1 # [!code callout]
```

<Callouts>
  1. Используйте API tkestack.io/v1.
  2. Имя ресурса CronHPA.
  3. Имя развертывания для масштабирования.
  4. Укажите версию API объекта для масштабирования.
  5. Укажите тип объекта. Объект должен быть Deployment, ReplicaSet или StatefulSet.
  6. Целевой ресурс, к которому применяется CronHPA.
  7. Расписание cron в стандартном формате crontab (минута час день месяц день_недели).
  8. Целевое количество реплик, к которому нужно масштабироваться, когда срабатывает расписание.
</Callouts>

Этот пример настраивает развертывание на:

- Снижение до 0 реплик в полночь каждый день
- Увеличение до 3 реплик в 8:00 утра в будние дни (понедельник-пятница)
- Снижение до 1 реплики в 18:00 в будние дни

2. Примените файл YAML для создания CronHPA:

```bash
$ kubectl create -f cronhpa.yaml
```

### Использование веб-консоли

1. Перейдите в **Контейнерную платформу**.

2. В левом боковом меню нажмите **Рабочие нагрузки** > **Развертывания**.

3. Нажмите на ***Имя развертывания***.

4. Прокрутите вниз до раздела **Эластичное масштабирование** и нажмите **Обновить** справа.

5. Выберите **Запланированное масштабирование** и настройте правила масштабирования. Когда тип **Пользовательский**, вы должны предоставить выражение Crontab для условия триггера, отформатированное как `минута час день месяц неделя`. Для подробного введения, пожалуйста, обратитесь к [Написание выражений Crontab](../../../building_application/how_to/cronjob_rules.mdx).

6. Нажмите **Обновить**.

## Пояснение правила расписания

<img src="./assets/pod_scale_schedule.png" />

1. Указывает, что начиная с 01:00 AM каждую понедельник, будет оставлен только 1 под.
2. Указывает, что начиная с 02:00 AM каждую вторник, будет оставлено только 2 пода.
3. Указывает, что начиная с 02:00 AM каждую вторник, будет оставлено только 3 пода.

**Важные примечания**:

- Когда несколько правил имеют одинаковое время триггера (Примеры 2 и 3), платформа будет выполнять автоматическое масштабирование только на основе правила, имеющего более высокий приоритет (Пример 2).
- CronHPA работает независимо от HPA. Если оба настроены для одной и той же нагрузки, они могут конфликтовать друг с другом. Тщательно продумайте свою стратегию масштабирования.
- Расписание использует формат crontab (`минута час день месяц неделя`) и следует тем же правилам, что и Kubernetes CronJobs.
- Время основано на настройках часового пояса кластера.
- Для нагрузок с критическими требованиями к доступности убедитесь, что ваше запланированное масштабирование не уменьшает емкость неожиданно в периоды высокой нагрузки.
