---
weight: 30
sourceSHA: cff8b71b4bb476ab7ace816251da3edc4cbf1b95859d4217c4b53f767b39c0a4
---

# Настройка VerticalPodAutoscaler (VPA)

Для бесполезных и состояний приложений VerticalPodAutoscaler (VPA) автоматически рекомендует и при необходимости применяет более подходящие ограничения ресурсов CPU и памяти, основываясь на ваших бизнес-потребностях, обеспечивая наличие достаточных ресурсов для подов и улучшая использование ресурсов кластера.

## Понимание VerticalPodAutoscaler

Вы можете создать VerticalPodAutoscaler, чтобы рекомендовать или автоматически обновлять запросы и ограничения ресурсов CPU и памяти для ваших подов на основе их исторических паттернов использования.

После создания VerticalPodAutoscaler платформа начинает мониторить использование ресурсов CPU и памяти подами. Когда доступно достаточное количество данных, VerticalPodAutoscaler рассчитывает рекомендуемые значения ресурсов на основе наблюдаемых паттернов использования. В зависимости от настроенного режима обновления, VPA может либо автоматически применять эти рекомендации, либо просто предоставлять их для ручного применения.

VPA работает, анализируя использование ресурсов вашими подами с течением времени и делая рекомендации на основе этого анализа. Это может помочь гарантировать, что ваши поды имеют необходимые ресурсы без избыточного выделения, что может привести к более эффективному использованию ресурсов в вашем кластере.

### Как работает VPA?

VerticalPodAutoscaler (VPA) расширяет концепцию оптимизации ресурсов подов. VPA мониторит использование ресурсов вашими подами и предоставляет рекомендации по запросам CPU и памяти на основе наблюдаемых паттернов использования.

VPA работает, постоянно мониторя использование ресурсов вашими подами и обновляя свои рекомендации по мере появления новых данных. VPA может работать в следующих режимах:

- **Выключен**: VPA только предоставляет рекомендации без автоматического их применения.
- **Ручная настройка**: Вы можете вручную настроить конфигурации ресурсов на основе рекомендаций VPA.

> **Важно**: Эластичное масштабирование может достигать горизонтального или вертикального масштабирования подов. Когда доступно достаточное количество ресурсов, эластичное масштабирование может дать хорошие результаты, но когда ресурсы кластера недостаточны, это может привести к тому, что поды окажутся в состоянии ожидания. Поэтому убедитесь, что в кластере достаточно ресурсов или разумные квоты, или вы можете настроить оповещения для мониторинга условий масштабирования.

### Поддерживаемые функции

VerticalPodAutoscaler предоставляет рекомендации по ресурсам на основе исторических паттернов использования, позволяя вам оптимизировать конфигурации CPU и памяти ваших подов.

> **Важно**: При ручном применении рекомендаций VPA произойдет пересоздание подов, что может вызвать временные перебои в работе вашего приложения. Рассмотрите возможность применения рекомендаций в окна обслуживания для производственных нагрузок.

## Предварительные условия

- Пожалуйста, убедитесь, что компоненты мониторинга развернуты в текущем кластере и работают правильно. Вы можете проверить статус развертывания и состояние здоровья компонентов мониторинга, нажав на верхний правый угол платформы <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px', verticalAlign: 'middle' }}><img src="./assets/question.png" alt="expand" style={{ verticalAlign: 'middle' }} /> <span>  > **Состояние здоровья платформы**.</span></span>.
- Плагин Vertical Pod Autoscaler для платформы Alauda Container должен быть установлен в вашем кластере.

### Установка плагина Vertical Pod Autoscaler

Перед использованием VPA вам необходимо установить плагин Vertical Pod Autoscaler для кластера:

1. Войдите в систему и перейдите на страницу **Администраторы**.

2. Нажмите **Маркетплейс** > **Плагины кластера**, чтобы получить доступ к странице списка **Плагинов кластера**.

3. Найдите плагин Vertical Pod Autoscaler для платформы Alauda Container, нажмите Установить, затем перейдите на страницу установки.

## Создание VerticalPodAutoscaler

### Использование CLI

Вы можете создать VerticalPodAutoscaler с помощью интерфейса командной строки, определив файл YAML и используя команду `kubectl create`. Следующий пример показывает вертикальное автоскалирование для объекта Deployment:

1. Создайте файл YAML с именем `vpa.yaml` со следующим содержимым:

```yaml
apiVersion: autoscaling.k8s.io/v1 # [!code callout]
kind: VerticalPodAutoscaler # [!code callout]
metadata:
  name: my-deployment-vpa # [!code callout]
  namespace: default
spec:
  targetRef:
    apiVersion: apps/v1 # [!code callout]
    kind: Deployment # [!code callout]
    name: my-deployment # [!code callout]
  updatePolicy:
    updateMode: "Off" # [!code callout]
  resourcePolicy: # [!code callout]
    containerPolicies:
    - containerName: "*" # [!code callout]
      mode: "Auto" # [!code callout]
```

<Callouts>
  1. Используйте API autoscaling.k8s.io/v1.
  2. Имя VPA
  3. Укажите целевой объект рабочей нагрузки. VPA использует селектор рабочей нагрузки для поиска подов, которым необходимо корректировать ресурсы. Поддерживаемые типы рабочих нагрузок включают DaemonSet, Deployment, ReplicaSet, StatefulSet, ReplicationController, Job и CronJob.
  4. Укажите версию API объекта для масштабирования.
  5. Укажите тип объекта.
  6. Целевой ресурс, к которому применяется VPA.
  7. Политика обновления, которая определяет, как VPA применяет рекомендации. updateMode может быть:
     - Auto: Автоматически устанавливает запросы ресурсов при создании подов и обновляет текущие поды до рекомендуемых запросов ресурсов. В настоящее время эквивалентно "Recreate". Этот режим может вызвать простои приложения. Как только поддерживаются обновления ресурсов подов на месте, режим "Auto" примет этот механизм обновления.
     - Recreate: Автоматически устанавливает запросы ресурсов при создании подов и выселяет текущие поды для обновления до рекомендуемых запросов ресурсов. Не будет использовать обновления на месте.
     - Initial: Устанавливает запросы ресурсов только при создании подов, без последующих изменений.
     - Off: Не автоматически изменяет запросы ресурсов подов, только предоставляет рекомендации в объекте VPA.
  8. Политика ресурсов, которая может установить конкретные стратегии для различных контейнеров. Например, установка режима контейнера на "Auto" означает, что он будет рассчитывать рекомендации для этого контейнера, в то время как "Off" означает, что он не будет рассчитывать рекомендации.
  9. Применить политику ко всем контейнерам в поде.
  10. Установите режим на Auto или Off. Auto означает, что для этого контейнера будут генерироваться рекомендации, Off означает, что рекомендации не будут генерироваться.
</Callouts>

2. Примените файл YAML для создания VPA:

```bash
$ kubectl create -f vpa.yaml
```

Пример вывода:

```
verticalpodautoscaler.autoscaling.k8s.io/my-deployment-vpa создан
```

3. После создания VPA вы можете просмотреть рекомендации, выполнив следующую команду:

```bash
$ kubectl describe vpa my-deployment-vpa
```

Пример вывода (частичный):

```
Статус:
  Рекомендация:
    Рекомендации контейнеров:
      Имя контейнера:  my-container
      Нижняя граница:
        Cpu:     100m
        Память:  262144k
      Цель:
        Cpu:     200m
        Память:  524288k
      Верхняя граница:
        Cpu:     300m
        Память:  786432k
```

### Использование веб-консоли

1. Войдите в **Платформу контейнеров**.

2. В левой навигационной панели нажмите **Рабочие нагрузки** > **Развертывания**.

3. Нажмите на ***Имя развертывания***.

4. Прокрутите вниз до области **Эластичное масштабирование** и нажмите **Обновить** справа.

5. Выберите **Вертикальное масштабирование** и настройте правила масштабирования.

   | Параметр            | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
   | -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
   | **Режим масштабирования**     | В настоящее время поддерживает режим **Ручного масштабирования**, который предоставляет рекомендуемые конфигурации ресурсов, анализируя прошлое использование ресурсов. Вы можете вручную скорректировать в соответствии с рекомендуемыми значениями. Изменения приведут к пересозданию и перезапуску подов, поэтому, пожалуйста, выбирайте подходящее время, чтобы избежать влияния на работающие приложения.<br />Обычно, после того как поды работают более 8 дней, рекомендуемые значения становятся точными.<br />Обратите внимание, что когда ресурсы кластера недостаточны, масштабирование может привести к тому, что поды окажутся в состоянии ожидания. Пожалуйста, убедитесь, что в кластере достаточно ресурсов или разумные квоты, или настройте оповещения для мониторинга условий масштабирования. |
   | **Целевой контейнер** | По умолчанию выбирается первый контейнер рабочей нагрузки. Вы можете выбрать возможность включить рекомендации по лимитам ресурсов для одного или нескольких контейнеров по мере необходимости.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

6. Нажмите **Обновить**.

### Расширенная конфигурация VPA

#### Опции политики обновления

- `updateMode: "Off"` - VPA только предоставляет рекомендации без автоматического применения. Вы можете вручную применять эти рекомендации по мере необходимости.
- `updateMode: "Auto"` - Автоматически устанавливает запросы ресурсов при создании подов и обновляет текущие поды до рекомендуемых значений. В настоящее время эквивалентно "Recreate".
- `updateMode: "Recreate"` - Автоматически устанавливает запросы ресурсов при создании подов и выселяет текущие поды для обновления до рекомендуемых значений.
- `updateMode: "Initial"` - Устанавливает запросы ресурсов только при создании подов, без последующих изменений.
- `minReplicas: <number>` - Минимальное количество реплик. Обеспечивает, чтобы это минимальное количество подов оставалось доступным, когда Обновитель выселяет поды.

#### Опции политики контейнера

- `containerName: "*"` - Применить политику ко всем контейнерам в поде.
- `mode: "Auto"` - Автоматически генерировать рекомендации для контейнера.
- `mode: "Off"` - Не генерировать рекомендации для контейнера.

**Примечания**:

- Рекомендации VPA основаны на исторических данных использования, поэтому может потребоваться несколько дней работы подов, прежде чем рекомендации станут точными.
- Пересоздание подов произойдет, когда рекомендации VPA применяются в режиме Auto, что может вызвать временные перебои в работе вашего приложения.

## Дальнейшие действия

После настройки VPA рекомендуемые значения для ограничений ресурсов CPU и памяти целевого контейнера можно просмотреть в области **Эластичное масштабирование**. В области **Контейнеры** выберите вкладку целевого контейнера и нажмите на значок справа от **Ограничения ресурсов**, чтобы обновить лимиты ресурсов в соответствии с рекомендуемыми значениями.
