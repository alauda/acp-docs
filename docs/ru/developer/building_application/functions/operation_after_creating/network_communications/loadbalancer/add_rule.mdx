---
weight: 30
sourceSHA: b017e5978159fe27517e626f457b623e140b782cc5bf4e21e48c03320588b89f
---

# Добавление правил

Добавьте правила пересылки для портов слушателя протоколов HTTPS, HTTP и gRPC. Балансировщик нагрузки будет соответствовать бэкенд-сервисам на основе этих правил.

**Примечание**: Правила пересылки нельзя добавлять для протоколов TCP и UDP.

## Шаги для выполнения

1. Перейдите в **Container Platform**.

2. Нажмите на **Network** > **Load Balancing** в левой панели навигации.

3. Нажмите на название балансировщика нагрузки.

4. Нажмите на название порта слушателя.

5. Нажмите **Добавить правило**.

6. Используйте следующие описания для настройки соответствующих параметров.

   | Параметр                               | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
   | ---------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Группа внутренних маршрутов**         | - Когда алгоритм балансировки нагрузки выбирает **Round Robin (RR)**, входящий трафик будет распределяться по портам внутренних маршрутов в порядке группы внутренних маршрутов.<br />- Когда алгоритм балансировки нагрузки выбирает **Weighted Round Robin (WRR)**, чем выше значение веса внутреннего маршрута, тем выше вероятность его опроса, и входящий трафик будет распределяться по портам внутренних маршрутов в соответствии с вероятностью, рассчитанной на основе заданного **веса**.<br />**Совет**: Метод расчета вероятности — это отношение текущего значения веса к сумме всех значений весов.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
   | **Правило**                              | Означает критерии, по которым балансировщик нагрузки соответствует бэкенд-сервисам, включая индикаторы правила и их значения. Связь между различными индикаторами правила «и».<br /><ul><li>Имя домена: Поддерживает добавление **Wildcard-доменов** и **точных имен доменов**. В случае равного приоритета для одного и того же правила, если существуют конфигурации правила как с Wildcard, так и с точным именем домена, то правило пересылки с точным именем домена будет иметь приоритет.</li><li>URL: **RegEx** соответствует регулярным выражениям URL, начинающимся с `/`; **StartsWith** соответствует префиксам URL, начинающимся с `/`.</li><li>IP: **Equal** соответствует определенному IP-адресу; **Range** соответствует диапазону IP-адресов.</li><li>Заголовок: Кроме ввода ключа заголовка, также необходимо установить правила соответствия. **Equal** соответствует конкретному значению заголовка; **Range** соответствует диапазону значения заголовка; **RegEx** соответствует регулярному выражению заголовка.</li><li>Cookie: Кроме ввода ключа cookie, также необходимо установить правила соответствия. **Equal** соответствует конкретному значению cookie.</li><li>URL Param: В правилах соответствия, **Equal** соответствует конкретному параметру URL; **Range** соответствует диапазону параметра URL.</li><li>Имя сервиса: Имя сервиса относится к имени сервиса, использующего протокол gRPC. При использовании протокола gRPC этот пункт можно настроить, позволяя пересылать трафик на соответствующий сервис на основе предоставленного имени сервиса, например: `/helloworld.Greeter`.</li></ul> |
   | **Сессии**                              | Всегда пересылает определенные запросы доступа к бэкенд-сервисам, соответствующим вышеуказанной группе внутренних маршрутов.<br />Определенные запросы доступа относятся к (выберите один):<ul><li>Хеш исходного адреса: Все запросы доступа, происходящие с одного IP-адреса.</li><li>Ключ cookie: Запросы доступа, сопровождающиеся указанным cookie.</li><li>Имя заголовка: Запросы доступа, сопровождающиеся указанным заголовком.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
   | **Перезапись URL**                      | Перезаписывает запрашиваемый адрес на адрес бэкенд-сервиса платформы. Эта функция требует настройки индикатора правила **StartsWith** URL, и адрес перезаписи (rewrite-target) должен начинаться с */*. <br /><br />Например: После установки имени домена на *bar.example.com* и начального пути URL на `/`, включив функциональность **Перезаписи URL** и установив адрес перезаписи на */test*, доступ к *bar.example.com* будет перезаписан на *bar.example.com/test*.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
   | **Протокол бэкенда**                    | Протокол, используемый для пересылки трафика доступа к бэкенд-сервису. Например: Если пересылаете на бэкенд-сервис Kubernetes или dex, выберите протокол HTTPS.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
   | **Перенаправление**                    | Пересылает трафик доступа на новый перенаправленный адрес, а не на бэкенд-сервисы, соответствующие группе внутренних маршрутов.<br />Например: Когда страница на исходном адресе доступа обновляется, чтобы избежать ошибки 404 или 503 для пользователей, трафик можно перенаправить на новый адрес путем настройки.<ul><li>HTTP код состояния: Код состояния, представляемый пользователю браузером перед перенаправлением на новый адрес.</li><li>Адрес перенаправления: При вводе относительного адреса (например, */index.html*) цель пересылаемого трафика будет *адрес балансировщика нагрузки/index.html*; при вводе абсолютного адреса (например, *[https://www.example.com](https://www.example.com)*), цель пересылаемого трафика будет введенный адрес.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
   | **Приоритет правила**                   | Приоритет соответствия правилу: существует 10 уровней с 1 по 10, где 1 является наивысшим приоритетом, а приоритет по умолчанию составляет 5.<br />Когда два или более правила удовлетворяются одновременно, выбирается и применяется правило с более высоким приоритетом; если приоритет одинаковый, система использует правило соответствия по умолчанию.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | **Кросс-доменные запросы (CORS)**      | CORS (Кросс-доменные запросы) — это механизм, который использует дополнительные HTTP-заголовки, чтобы инструктировать браузер о том, что веб-приложение, работающее на одном источнике (домене), может получать доступ к указанным ресурсам с другого серверного источника. Когда ресурс запрашивает другой ресурс с сервера, который имеет другой домен, протокол или порт, чем его собственный, это инициирует кросс-доменные HTTP-запросы.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
   | **Допустимые источники**                | Используется для указания источников, которым разрешен доступ. <ul><li>**\***: Разрешает запросы из любого источника.</li><li>**Имя домена**: Разрешает запросы с текущего домена.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
   | **Допустимые заголовки**                | Используется для указания заголовков HTTP-запросов, разрешенных в CORS (Кросс-доменные запросы), чтобы избежать ненужных предварительных запросов и повысить эффективность запросов. Примеры записей следующие:<br /><br />**Примечание**: Другие часто используемые или пользовательские заголовки запросов не будут перечислены здесь по отдельности; пожалуйста, заполняйте в соответствии с фактическими условиями.<br /><br /><ul><li>**Origin**: Указывает источник запроса, т.е. домен, отправляющий запрос.</li><li>**Authorization**: Используется для указания информации об авторизации для запроса, обычно для идентификации, такой как основная авторизация или токен.</li><li>**Content-Type**: Используется для указания типа контента запроса/ответа, например, application/json, application/x-www-form-urlencoded и т. д.</li><li>**Accept**: Используется для указания типов контента, которые клиент может принять, чаще всего используется, когда клиент надеется получить определенный тип ответа.</li></ul><br />**Дополнительная информация по предварительным запросам**: Предварительный запрос — это запрос, который браузер автоматически отправляет, чтобы подтвердить безопасность и целесообразность фактического запроса. Когда фактический запрос не соответствует критериям [простого запроса](#request), браузер сначала отправляет запрос OPTIONS на сервер, чтобы узнать, разрешен ли фактический запрос; только после того, как сервер подтвердит разрешение, браузер отправляет фактический запрос, и этот запрос OPTIONS является предварительным запросом.                                                                                                                          |

7. Нажмите **Добавить**.

## Связанные инструкции

### Простые запросы \{#request}

Если запрос соответствует всем следующим условиям, его можно считать простым запросом:

- Использует один из следующих методов:
  - HEAD
  - GET
  - POST

- В дополнение к заголовкам, автоматически установленным пользовательским агентом, таким как Connection, User-Agent и названия заголовков, определенные как отключенные в спецификации Fetch, другие допустимые вручную установленные заголовки, безопасные для CORS, включают:
  - Accept
  - Accept-Language
  - Content-Language
  - Content-Type (обратите внимание на дополнительные ограничения)
  - Range (разрешены только простые значения заголовка диапазона, такие как bytes=256- или bytes=127-255)

- Значение Content-Type ограничено одним из следующих:
  - text/plain
  - multipart/form-data
  - application/x-www-form-urlencoded

- В запросе нет объектов XMLHttpRequest с зарегистрированными слушателями событий.

- Объект ReadableStream не использовался в запросе.
