---
weight: 30
sourceSHA: b017e5978159fe27517e626f457b623e140b782cc5bf4e21e48c03320588b89f
---

# Добавление правил

Добавьте правила пересылки для портов слушателя протоколов HTTPS, HTTP и gRPC. Балансировщик нагрузки будет сопоставлять службы бэкенда на основе этих правил.

**Примечание**: Правила пересылки нельзя добавить для протоколов TCP и UDP.

## Шаги для выполнения

1. Перейдите в **Платформу контейнеров**.

2. Нажмите на **Сеть** > **Балансировка нагрузки** в левой навигационной панели.

3. Щелкните на имя балансировщика нагрузки.

4. Щелкните на имя порта слушателя.

5. Нажмите **Добавить правило**.

6. Ознакомьтесь с описаниями ниже для настройки соответствующих параметров.

   | Параметр                                 | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
   | ---------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Группа внутренних маршрутов**          | - Когда алгоритм балансировки нагрузки выбирает **Круговую (RR)**, трафик будет распределяться по портам внутренних маршрутов в порядке группы внутренних маршрутов.<br />- Когда алгоритм балансировки нагрузки выбирает **Взвешенную круговую (WRR)**, чем выше вес внутреннего маршрута, тем выше вероятность его выборки, и трафик будет распределяться по портам внутренних маршрутов в соответствии с вероятностью, рассчитанной на основе заданного **веса**.<br />**Совет**: Способ расчета вероятности – это соотношение текущего веса к сумме всех весов.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
   | **Правило**                              | Ссылается на критерии, по которым балансировщик нагрузки сопоставляет службы бэкенда, включая индикаторы правил и их значения. Связь между разными индикаторами правил - «и».<br /><ul><li>Имя домена: Поддерживает добавление **доменов с подстановочными знаками** и **точных доменных имен**. В случаях равного приоритета для одного и того же правила, если существуют конфигурации правила как с подстановочными знаками, так и с точным доменным именем, первый будет действовать именно точный домен.</li><li>URL: **RegEx** соответствует регулярным выражениям URL, начинающимся с `/`; **StartsWith** соответствует префиксам URL, начинающимся с `/`.</li><li>IP: **Равно** соответствует конкретному IP-адресу; **Диапазон** соответствует диапазону IP-адресов.</li><li>Заголовок: В дополнение к вводу ключа заголовка необходимо также установить правила сопоставления. **Равно** соответствует конкретному значению заголовка; **Диапазон** соответствует диапазону значения заголовка; **RegEx** соответствует регулярному выражению заголовка.</li><li>Куки: В дополнение к вводу ключа куки необходимо также установить правила сопоставления. **Равно** соответствует конкретному значению куки.</li><li>URL параметр: В правилах сопоставления **Равно** соответствует конкретному URL параметру; **Диапазон** соответствует диапазону URL параметра.</li><li>Имя службы: Имя службы относится к имени службы, использующей gRPC протокол. При использовании gRPC протокола этот элемент может быть настроен, что позволяет перенаправлять трафик на соответствующую службу на основе указанного имени службы, например: `/helloworld.Greeter`.</li></ul> |
   | **Сохранение сеанса**                   | Всегда перенаправляет конкретные запросы доступа на соответствующие службы бэкенда, относящиеся к вышеупомянутой группе внутренних маршрутов.<br />Конкретные запросы доступа означают (выберите одно):<ul><li>Хэш исходного адреса: Все запросы доступа, происходящие с одного и того же IP-адреса.</li><li>Ключ куки: Запросы доступа, несущие указанную куки.</li><li>Имя заголовка: Запросы доступа, несущие указанный заголовок.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
   | **Перезапись URL**                      | Перезаписывает запрашиваемый адрес на адрес службы бэкенда платформы. Эта функция требует настройки правила индикатора **StartsWith** URL, и адрес перезаписи (rewrite-target) должен начинаться с */*. <br /><br />Например: После установки доменного имени на *bar.example.com* и начального пути URL на `/`, включив функциональность **Перезапись URL** и установив адрес перезаписи на */test*. Доступ к *bar.example.com* изменит URL на *bar.example.com/test*.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
   | **Протокол бэкенда**                    | Протокол, используемый для пересылки трафика доступа к службе бэкенда. Например: Если пересылка на Kubernetes или dex службы бэкенда, выберите протокол HTTPS.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
   | **Перенаправление**                     | Перенаправляет трафик доступа на новый перенаправленный адрес вместо соответствующих служб бэкенда группы внутренних маршрутов.<br />Например: Когда страница по оригинальному адресу доступа обновляется или изменяется, чтобы избежать того, чтобы пользователи получали 404 или 503 ошибочную страницу, трафик может быть перенаправлен на новый адрес путем конфигурации.<ul><li>HTTP статус-код: Статус-код, представленный пользователю браузером перед перенаправлением на новый адрес.</li><li>Адрес перенаправления: При вводе относительного адреса (например, */index.html*) целью перенаправленного трафика будет *адрес балансировщика нагрузки/index.html*; при вводе абсолютного адреса (например, *[https://www.example.com](https://www.example.com)*), целью перенаправленного трафика будет введенный адрес.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
   | **Приоритет правила**                   | Приоритет сопоставления правил: 10 уровней от 1 до 10, где 1 - наивысший приоритет, а приоритет по умолчанию - 5.<br />Когда два или более правил выполняются одновременно, выбирается правило с более высоким приоритетом и применяется; если приоритет одинаковый, система использует правило сопоставления по умолчанию.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
   | **Общий доступ к ресурсам между разными источниками (CORS)** | CORS (доступ к ресурсам между разными источниками) - это механизм, который использует дополнительные HTTP заголовки, чтобы указать браузеру, что веб-приложение, работающее на одном источнике (домене), имеет разрешение на доступ к указанным ресурсам с другого источника (сервера). Когда ресурс запрашивает другой ресурс с сервера, имеющего другой домен, протокол или порт, чем у него самого, он инициирует кросс-доменный HTTP запрос.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
   | **Разрешенные источники**                | Используется для указания источников, которым разрешен доступ. <ul><li>**\***: Разрешает запросы с любого источника.</li><li>**Имя домена**: Разрешает запросы из текущего домена.</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
   | **Разрешенные заголовки**                | Используется для указания заголовков HTTP-запросов, разрешенных в CORS (доступе к ресурсам между разными источниками), чтобы избежать ненужных предзапросов и повысить эффективность запросов. Примеры записей следующие:<br /><br />**Примечание**: Другие часто используемые или пользовательские заголовки запросов не будут перечислены здесь, заполните их в соответствии с фактическими условиями.<br /><br /><ul><li>**Origin**: Указывает источник запроса, т.е. домен, отправляющий запрос.</li><li>**Authorization**: Используется для указания информации о разрешении для запроса, обычно для идентификации, такой как Basic Authentication или Token.</li><li>**Content-Type**: Используется для указания типа содержимого запроса/ответа, например application/json, application/x-www-form-urlencoded и т.д.</li><li>**Accept**: Используется для указания типов содержимого, которые клиент может принимать, обычно используется, когда клиент надеется получить ответ определенного типа.</li></ul><br />**Дополнительная примечание о предзапросах**: Предзапрос - это запрос, который браузер автоматически отправляет для подтверждения безопасности и целесообразности фактического запроса. Когда фактический запрос не удовлетворяет критериям [простого запроса](#request), браузер сначала отправляет запрос OPTIONS на сервер, чтобы уточнить, разрешен ли фактический запрос; только после того, как сервер подтвердит разрешение, браузер отправляет фактический запрос, и этот запрос OPTIONS является предзапросом.                                                                                                                        |

7. Нажмите **Добавить**.

## Связанные инструкции

### Простые запросы \{#request}

Если запрос соответствует всем следующим условиям, его можно считать простым запросом:

- Использует один из следующих методов:
  - HEAD
  - GET
  - POST

- В дополнение к заголовкам, автоматически устанавливаемым пользовательским агентом, таким как Connection, User-Agent, и именам заголовков, определенным как отключенные в спецификации Fetch, другие разрешенные вручную установленные заголовки, которые безопасны для CORS, включают:
  - Accept
  - Accept-Language
  - Content-Language
  - Content-Type (обратите внимание на дополнительные ограничения)
  - Range (разрешаются только простые значения заголовка диапазона, такие как bytes=256- или bytes=127-255)

- Значение Content-Type ограничивается одним из следующих:
  - text/plain
  - multipart/form-data
  - application/x-www-form-urlencoded

- В запросе нет объектов XMLHttpRequest с зарегистрированными обработчиками событий.

- Объект ReadableStream не использовался в запросе.
