---
weight: 10
sourceSHA: 393ce2c3df0624e82a1c8c28ca6953a1b232df705524434034a8720f3a637b5c
---

# Управление LDAP

Администраторы платформы могут добавлять, обновлять и удалять службы LDAP на платформе.

## Обзор LDAP

LDAP (Протокол легкого доступа к каталогам) — это зрелый, гибкий и хорошо поддерживаемый стандартный механизм взаимодействия с каталогами серверов. Он организует данные в иерархическую древовидную структуру для хранения информации о пользователях и организациях, используемой главным образом для реализации единого входа (SSO).

:::note

Ключевые особенности LDAP:

- Обеспечивает связь между клиентами и серверами LDAP
- Поддерживает операции хранения, извлечения и поиска данных
- Предоставляет возможности аутентификации клиентов
- Облегчает интеграцию с другими системами

:::

Для получения дополнительной информации см. [официальную документацию LDAP](https://ldap.com/?spm=a2c4g.11186623.2.12.38e87d4cjSb0uh).

## Поддерживаемые типы LDAP

### OpenLDAP

OpenLDAP — это реализация LDAP с открытым исходным кодом. Если ваша организация использует OpenLDAP с открытым исходным кодом для аутентификации пользователей, вы можете настроить платформу для взаимодействия с службой LDAP, добавив LDAP и настроив соответствующие параметры.

:::note

Интеграция OpenLDAP:

- Обеспечивает аутентификацию платформы для пользователей LDAP
- Поддерживает стандартные протоколы LDAP
- Предоставляет гибкое управление пользователями

:::

Для получения дополнительной информации об OpenLDAP см. [официальную документацию OpenLDAP](https://www.openldap.org/doc).

### Active Directory

Active Directory — это программное обеспечение Microsoft на основе LDAP для предоставления услуг хранения каталогов в системах Windows. Если ваша организация использует Microsoft Active Directory для управления пользователями, вы можете настроить платформу для взаимодействия с службой Active Directory.

:::note

Интеграция Active Directory:

- Обеспечивает аутентификацию платформы для пользователей AD
- Поддерживает интеграцию домена Windows
- Предоставляет управление пользователями на уровне предприятия

:::

## Термины LDAP

### Общие термины OpenLDAP

| Термин                           | Описание                     | Пример                               |
| ------------------------------ | ------------------------------- | ------------------------------------- |
| **dc (Компонент домена)**      | Компонент домена                | `dc=example,dc=com`                   |
| **ou (Организационная единица)**   | Организационная единица             | `ou=People,dc=example,dc=com`         |
| **cn (Общее имя)**           | Общее имя                     | `cn=admin,dc=example,dc=com`          |
| **uid (Идентификатор пользователя)**              | Идентификатор пользователя                         | `uid=example`                         |
| **objectClass (Класс объекта)** | Класс объекта                    | `objectClass=inetOrgPerson`           |
| **mail (Электронная почта)**                | Почта                            | `mail=example@126.com`                |
| **givenName (Имя)**     | Имя                      | `givenName=xq`                        |
| **sn (Фамилия)**               | Фамилия                         | `sn=ren`                              |
| **objectClass: groupOfNames**  | Группа пользователей                      | `objectClass: groupOfNames`           |
| **member (Член)**            | Атрибут члена группы          | `member=cn=admin,dc=example,dc=com`   |
| **memberOf**                   | Атрибут членства в группе | `memberOf=cn=users,dc=example,dc=com` |

### Общие термины Active Directory

| Термин                                 | Описание                     | Пример                                                 |
| ------------------------------------ | ------------------------------- | ------------------------------------------------------- |
| **dc (Компонент домена)**            | Компонент домена                | `dc=example,dc=com`                                     |
| **ou (Организационная единица)**         | Организационная единица             | `ou=People,dc=example,dc=com`                           |
| **cn (Общее имя)**                 | Общее имя                     | `cn=admin,dc=example,dc=com`                            |
| **sAMAccountName/userPrincipalName** | Идентификатор пользователя                 | `userPrincipalName=example` или `sAMAccountName=example` |
| **objectClass: user**                | Класс объекта пользователя            | `objectClass=user`                                      |
| **mail (Электронная почта)**                      | Почта                            | `mail=example@126.com`                                  |
| **displayName**                      | Отображаемое имя                    | `displayName=example`                                   |
| **givenName (Имя)**           | Имя                      | `givenName=xq`                                          |
| **sn (Фамилия)**                     | Фамилия                         | `sn=ren`                                                |
| **objectClass: group**               | Группа пользователей                      | `objectClass: group`                                    |
| **member (Член)**                  | Атрибут члена группы          | `member=CN=Admin,DC=example,DC=com`                     |
| **memberOf**                         | Атрибут членства в группе | `memberOf=CN=Users,DC=example,DC=com`                   |

## Добавить LDAP

:::tip

После успешной интеграции LDAP:

- Пользователи могут войти в систему, используя свои корпоративные учетные записи
- Множественные добавления одного и того же LDAP будут перезаписывать ранее синхронизированных пользователей

:::

### Предварительные условия

Перед добавлением LDAP подготовьте следующую информацию:

- Адрес сервера LDAP
- Имя пользователя администратора
- Пароль администратора
- Другие необходимые параметры конфигурации

### Шаги

1. В левой навигационной панели нажмите **Пользователи** > **IDPs**
2. Нажмите **Добавить LDAP**
3. Настройте следующие параметры:

#### Основная информация

| Параметр                     | Описание                                                            |
| ----------------------------- | ---------------------------------------------------------------------- |
| **Адрес сервера**            | Адрес доступа к серверу LDAP (например, `192.168.156.141:31758`)             |
| **Имя пользователя**                  | DN администратора LDAP (например, `cn=admin,dc=example,dc=com`)             |
| **Пароль**                  | Пароль учетной записи администратора LDAP                                    |
| **Сообщение для ввода имени пользователя** | Сообщение-всплывашка для ввода имени пользователя (например, "Пожалуйста, введите ваше имя пользователя") |

#### Настройки поиска

:::note

Цель настроек поиска:

- Соответствует записям пользователей LDAP на основе заданных условий
- Извлекает ключевые атрибуты пользователей и групп
- Соответствует атрибутам LDAP атрибутам пользователей платформы

:::

| Параметр                  | Описание                                                                                                                         |
| -------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| **Тип объекта**            | ObjectClass для пользователей:<br />- OpenLDAP: `inetOrgPerson`<br />- Active Directory: `organizationalPerson`<br />- Группы: `posixGroup` |
| **Поле входа**            | Атрибут, используемый в качестве имени пользователя:<br />- OpenLDAP: `mail` (адрес электронной почты)<br />- Active Directory: `userPrincipalName`              |
| **Условия фильтрации**      | Условия фильтрации LDAP для пользователей/групп<br />Пример: `(&(cn=John*)(givenName=*xq*))`                                       |
| **Точка начала поиска**  | Базовый DN для поиска пользователей/групп (например, `dc=example,dc=org`)                                                                           |
| **Область поиска**           | Область поиска:<br />- `sub`: поддерево всего каталога<br />- `one`: один уровень ниже начальной точки                                   |
| **Атрибут входа**        | Уникальный идентификатор пользователя:<br />- OpenLDAP: `uid`<br />- Active Directory: `distinguishedName`                                         |
| **Атрибут имени**         | Атрибут имени объекта (по умолчанию: `cn`)                                                                                               |
| **Атрибут электронной почты**        | Атрибут электронной почты:<br />- OpenLDAP: `mail`<br />- Active Directory: `userPrincipalName`                                               |
| **Атрибут члена группы** | Идентификатор члена группы (по умолчанию: `uid`)                                                                                            |
| **Атрибут группы**        | Атрибут отношения пользователя к группе (по умолчанию: `memberuid`)                                                                            |

4. В разделе **Проверка конфигурации службы IDP**:
   - Введите действительное имя пользователя и пароль учетной записи LDAP
   - Имя пользователя должно соответствовать настройке **Поля входа**
   - Нажмите, чтобы проверить конфигурацию

5. (Опционально) Настройте **Политику автоматической синхронизации LDAP**:
   - Включите переключатель **Авто-синхронизация пользователей**
   - Установите правила синхронизации
   - Используйте [онлайн инструмент](https://tool.lu/crontab/) для проверки выражений CRON

6. Нажмите **Добавить**

:::note

После добавления LDAP:

- Пользователи могут войти в систему до синхронизации
- Информация о пользователе автоматически синхронизируется при первом входе в систему
- Авто-синхронизация происходит на основе настроенных правил

:::

## Примеры конфигурации LDAP

### Конфигурация соединителя LDAP

Следующий пример показывает, как настроить соединитель LDAP:

```yaml
apiVersion: dex.coreos.com/v1
kind: Connector
id: ldap        # Идентификатор соединителя
name: ldap      # Отображаемое имя соединителя
type: ldap      # Тип соединителя – LDAP
metadata:
  name: ldap
  namespace: cpaas-system
spec:
  config:
    # Адрес и порт LDAP-сервера
    host: ldap.example.com:636                         
    # DN и пароль для учетной записи службы, используемой соединителем.
    # Этот DN используется для поиска пользователей и групп.
    bindDN: uid=serviceaccount,cn=users,dc=example,dc=com 
    # Пароль учетной записи службы, необходимый при создании соединителя.
    bindPW: password                         

    # Подсказка для входа. Например, имя пользователя
    usernamePrompt: SSO Username
    
    # Конфигурация поиска пользователей
    userSearch:
      # Начинайте поиск с базового DN
      baseDN: cn=users,dc=example,dc=com
      # LDAP запрос, используемый для поиска пользователей.
      # Например: "(&(objectClass=person)(uid=<username>))"
      filter: (&(objectClass=organizationalPerson))

      # Следующие поля — это прямые соответствия атрибутам записи пользователя.
      # Атрибут идентификатора пользователя
      idAttr: uid
      # Обязательно. Атрибут для сопоставления с электронной почтой                     
      emailAttr: mail
      # Обязательно. Атрибут для сопоставления с именем пользователя
      nameAttr: cn
      # Атрибут имени пользователя для входа
      # Условия фильтра будут преобразованы в "(<attr>=<username>)", такие как (uid=example).
      username: uid

      # Расширенные атрибуты
      # phoneAttr: phone

    # Конфигурация поиска групп  
    groupSearch:
      # Начинайте поиск с базового DN
      baseDN: cn=groups,dc=freeipa,dc=example,dc=com
      # Условие фильтра группы
      # "(&(objectClass=group)(member=<user uid>))".
      filter: "(objectClass=group)"
      # Поле соответствия для группы пользователей
      # Атрибут группы
      groupAttr: member
      # Атрибут члена группы пользователей
      userAttr: uid
      # 显示小组名称
      nameAttr: cn
```

### Примеры фильтров пользователей

```yaml
# 1. Основной фильтр: Найти всех пользователей
(&(objectClass=person))

# 2. Сочетание нескольких условий: Найти пользователей в определенном отделе
(&(objectClass=person)(departmentNumber=1000))

# 3. Найти включенных пользователей (Active Directory)
(&(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))

# 4. Найти пользователей с определенным доменом электронной почты
(&(objectClass=person)(mail=*@example.com))

# 5. Найти участников определенной группы
(&(objectClass=person)(memberOf=cn=developers,ou=groups,dc=example,dc=com))

# 6. Найти недавно вошедших пользователей (Active Directory)
(&(objectClass=user)(lastLogon>=20240101000000.0Z))

# 7. Исключить системные учетные записи
(&(objectClass=person)(!(uid=admin))(!(uid=system)))

# 8. Найти пользователей с определенным атрибутом
(&(objectClass=person)(mobile=*))

# 9. Найти пользователей в нескольких отделах
(&(objectClass=person)(|(ou=IT)(ou=HR)(ou=Finance)))

# 10. Пример сложного сочетания условий
(&
  (objectClass=person)
  (|(department=IT)(department=Engineering))
  (!(title=Intern))
  (manager=cn=John Doe,ou=People,dc=example,dc=com)
)
```

### Примеры конфигурации поиска групп

```yaml
# 1. Основной фильтр: Найти все группы
(objectClass=groupOfNames)

# 2. Найти группы с определенным префиксом
(&(objectClass=groupOfNames)(cn=dev-*))

# 3. Найти не пустые группы
(&(objectClass=groupOfNames)(member=*))

# 4. Найти группы с определенным членом
(&(objectClass=groupOfNames)(member=uid=john,ou=People,dc=example,dc=com))

# 5. Найти вложенные группы (Active Directory)
(&(objectClass=group)(|(groupType=-2147483646)(groupType=-2147483644)))

# 6. Найти группы с определенным описанием
(&(objectClass=groupOfNames)(description=*admin*))

# 7. Исключить системные группы
(&(objectClass=groupOfNames)(!(cn=system*)))

# 8. Найти группы с определенными членами
(&(objectClass=groupOfNames)(|(cn=admins)(cn=developers)(cn=operators)))

# 9. Найти группы в определенном OU
(&(objectClass=groupOfNames)(ou=IT))

# 10. Пример сложного сочетания условий
(&
  (objectClass=groupOfNames)
  (|(cn=prod-*)(cn=dev-*))
  (!(cn=deprecated-*))
  (owner=cn=admin,dc=example,dc=com)
)
```

### Примеры операторов AND(&) и OR(|) в фильтрах LDAP

```yaml
# Оператор AND (&) - Все условия должны быть выполнены
# Синтаксис: (&(condition1)(condition2)(condition3)...)

# Пример множественного атрибута AND
(&
  (objectClass=person)
  (mail=*@example.com)
  (title=Engineer)
  (manager=*)
)

# Оператор OR (|) - По крайней мере одно условие должно быть выполнено
# Синтаксис: (|(condition1)(condition2)(condition3)...)

# Пример множественного атрибута OR
(|
  (department=IT)
  (department=HR)
  (department=Finance)
)

# Сочетание AND и OR
(&
  (objectClass=person)
  (|
    (department=IT)
    (department=R&D)
  )
  (employeeType=FullTime)
)

# Сложное сочетание условий
(&
  (objectClass=person)
  (|
    (&
      (department=IT)
      (title=*Engineer*)
    )
    (&
      (department=R&D)
      (title=*Developer*)
    )
  )
  (!(status=Inactive))
  (|(manager=*)(isManager=TRUE))
)
```

## Синхронизация пользователей LDAP

После успешной синхронизации пользователей LDAP с платформой вы можете просмотреть синхронизированных пользователей в списке пользователей.

Вы можете настроить политику автоматической синхронизации при [добавлении LDAP](#addldap) (которая может быть обновлена позже) или вручную запустить синхронизацию после успешного добавления LDAP. Вот как вручную запустить операцию синхронизации.

**Примечания**:

- Новые пользователи в LDAP, интегрированном с платформой, могут войти в систему до выполнения операции синхронизации пользователей. Как только они успешно войдут в систему, их информация автоматически синхронизируется с платформой.

- Удаленные из LDAP пользователи будут иметь статус `Недействительный` после синхронизации.

- Стандартный срок действия для вновь синхронизированных пользователей — **Постоянный**.

- Синхронизированные пользователи с таким же именем, как у существующих пользователей (локальные пользователи, пользователи IDP), автоматически связываются. Их разрешения и срок действия будут соответствовать существующим пользователям. Они могут войти на платформу с помощью метода входа, соответствующего их источникам.

### Алгоритм действий

1. В левой навигационной панели нажмите **Пользователи** > **IDPs**.

2. Нажмите на ***имя LDAP***, которое вы хотите синхронизировать вручную.

3. Нажмите **Действия** > **Синхронизировать пользователя** в верхнем правом углу.

4. Нажмите **Синхронизировать**.

   **Примечания**: Если вы вручную закроете диалоговое окно с предложением синхронизации, появится диалог подтверждения, чтобы подтвердить закрытие. После закрытия диалогового окна с предложением синхронизации система будет продолжать синхронизацию пользователей. Если вы остаетесь на странице списка пользователей, вы получите обратную связь о результате синхронизации. Если вы покинете страницу списка пользователей, вы не получите результаты синхронизации.

## Соответствующие действия

Вы можете щелкнуть ![](/en/img/113point.png) справа на странице списка или нажать **Действия** в верхнем правом углу на странице деталей, чтобы обновить или удалить LDAP по мере необходимости.

| Операция       | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Обновить LDAP** | Обновить информацию о конфигурации добавленного LDAP или **Политику автоматической синхронизации LDAP**.<br /><br />**Примечание**: После обновления LDAP пользователи, в настоящее время синхронизированные с платформой через этот LDAP, также будут обновлены. Удаленные из LDAP пользователи станут недействительными в списке пользователей платформы. Вы можете очистить ненужные данные, выполнив операцию по очистке недействительных пользователей.                                                                                                                                           |
| **Удалить LDAP** | После удаления LDAP все пользователи, синхронизированные с платформой через этот LDAP, будут иметь статус **Недействительный** (связь между пользователями и ролями останется неизменной), и они не смогут войти в платформу. После повторной интеграции синхронизацию необходимо повторно выполнить, чтобы активировать пользователей.<br /><br />**Советы**: После удаления IDP, если вы хотите удалить пользователей и пользовательские группы, синхронизированные с платформой через LDAP, установите флажок **Очистить пользователей IDP и пользовательские группы** под диалогом. |
