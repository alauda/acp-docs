---
weight: 10
sourceSHA: 393ce2c3df0624e82a1c8c28ca6953a1b232df705524434034a8720f3a637b5c
---

# Управление LDAP

Администраторы платформы могут добавлять, обновлять и удалять службы LDAP на платформе.

## Обзор LDAP

LDAP (Протокол доступа к легковесным каталогам) – это зрелый, гибкий и хорошо поддерживаемый стандартный механизм взаимодействия с каталогами. Он организует данные в иерархической древовидной структуре для хранения информации о пользователях и организациях, в основном используемой для реализации единого входа (SSO).

:::note

Ключевые особенности LDAP:

- Обеспечивает связь между клиентами и серверами LDAP
- Поддерживает операции хранения, извлечения и поиска данных
- Предоставляет возможности аутентификации клиентов
- Облегчает интеграцию с другими системами

:::

Для получения дополнительной информации обратитесь к [официальной документации LDAP](https://ldap.com/?spm=a2c4g.11186623.2.12.38e87d4cjSb0uh).

## Поддерживаемые типы LDAP

### OpenLDAP

OpenLDAP – это реализация LDAP с открытым исходным кодом. Если ваша организация использует OpenLDAP для аутентификации пользователей, вы можете настроить платформу для взаимодействия с службой LDAP, добавив LDAP и настроив соответствующие параметры.

:::note

Интеграция OpenLDAP:

- Обеспечивает аутентификацию платформы для пользователей LDAP
- Поддерживает стандартные протоколы LDAP
- Предоставляет гибкое управление пользователями

:::

Для получения дополнительной информации об OpenLDAP обратитесь к [официальной документации OpenLDAP](https://www.openldap.org/doc).

### Active Directory

Active Directory – это программное обеспечение на основе LDAP от Microsoft для обеспечения служб хранения каталогов в системах Windows. Если ваша организация использует Microsoft Active Directory для управления пользователями, вы можете настроить платформу для взаимодействия с службой Active Directory.

:::note

Интеграция Active Directory:

- Обеспечивает аутентификацию платформы для пользователей AD
- Поддерживает интеграцию домена Windows
- Предоставляет управление пользователями на уровне предприятия

:::

## Терминология LDAP

### Общие термины OpenLDAP

| Термин                           | Описание                     | Пример                               |
| ------------------------------ | ----------------------------- | ------------------------------------- |
| **dc (Компонент домена)**      | Компонент домена              | `dc=example,dc=com`                   |
| **ou (Организационная единица)**   | Организационная единица        | `ou=People,dc=example,dc=com`         |
| **cn (Общее имя)**           | Общее имя                     | `cn=admin,dc=example,dc=com`          |
| **uid (Идентификатор пользователя)**              | Идентификатор пользователя     | `uid=example`                         |
| **objectClass (Класс объекта)** | Класс объекта                    | `objectClass=inetOrgPerson`           |
| **mail (Электронная почта)**                | Электронная почта          | `mail=example@126.com`                |
| **givenName (Имя)**     | Имя                      | `givenName=xq`                        |
| **sn (Фамилия)**               | Фамилия                         | `sn=ren`                              |
| **objectClass: groupOfNames**  | Группа пользователей                      | `objectClass: groupOfNames`           |
| **member (Член)**            | Атрибут участника группы          | `member=cn=admin,dc=example,dc=com`   |
| **memberOf**                   | Атрибут членства в группе | `memberOf=cn=users,dc=example,dc=com` |

### Общие термины Active Directory

| Термин                                 | Описание                     | Пример                                                 |
| ------------------------------------ | ----------------------------- | ------------------------------------------------------- |
| **dc (Компонент домена)**            | Компонент домена              | `dc=example,dc=com`                                     |
| **ou (Организационная единица)**         | Организационная единица        | `ou=People,dc=example,dc=com`                           |
| **cn (Общее имя)**                 | Общее имя                     | `cn=admin,dc=example,dc=com`                            |
| **sAMAccountName/userPrincipalName** | Идентификатор пользователя     | `userPrincipalName=example` или `sAMAccountName=example` |
| **objectClass: user**                | Класс объекта пользователя      | `objectClass=user`                                      |
| **mail (Электронная почта)**                      | Электронная почта          | `mail=example@126.com`                                  |
| **displayName**                      | Отображаемое имя               | `displayName=example`                                   |
| **givenName (Имя)**           | Имя                      | `givenName=xq`                                          |
| **sn (Фамилия)**                     | Фамилия                         | `sn=ren`                                                |
| **objectClass: group**               | Группа пользователей                      | `objectClass: group`                                    |
| **member (Член)**                  | Атрибут участника группы          | `member=CN=Admin,DC=example,DC=com`                     |
| **memberOf**                         | Атрибут членства в группе | `memberOf=CN=Users,DC=example,DC=com`                   |

## Добавить LDAP

:::tip

После успешной интеграции LDAP:

- Пользователи могут входить в платформу, используя свои корпоративные аккаунты
- Множественные добавления одного и того же LDAP заменят ранее синхронизированных пользователей

:::

### Предварительные требования

Перед добавлением LDAP подготовьте следующую информацию:

- Адрес сервера LDAP
- Имя пользователя администратора
- Пароль администратора
- Другие необходимые детали конфигурации

### Шаги

1. В левом навигационном меню нажмите **Пользователи** > **IDP**
2. Нажмите **Добавить LDAP**
3. Настройте следующие параметры:

#### Основная информация

| Параметр                     | Описание                                                            |
| ----------------------------- | ---------------------------------------------------------------------- |
| **Адрес сервера**            | Адрес доступа к серверу LDAP (например, `192.168.156.141:31758`)             |
| **Имя пользователя**                  | DN администратора LDAP (например, `cn=admin,dc=example,dc=com`)             |
| **Пароль**                  | Пароль учетной записи администратора LDAP                                    |
| **Подсказка для имени пользователя** | Сообщение-подсказка для ввода имени пользователя (например, "Пожалуйста, введите ваше имя пользователя") |

#### Настройки поиска

:::note

Цель настроек поиска:

- Сопоставляет записи пользователей LDAP на основе заданных условий
- Извлекает ключевые атрибуты пользователей и групп
- Отображает атрибуты LDAP на атрибуты пользователей платформы

:::

| Параметр                  | Описание                                                                                                                         |
| -------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| **Тип объекта**            | ObjectClass для пользователей:<br />- OpenLDAP: `inetOrgPerson`<br />- Active Directory: `organizationalPerson`<br />- Группы: `posixGroup` |
| **Поле для входа**            | Атрибут, используемый в качестве имени пользователя для входа:<br />- OpenLDAP: `mail` (адрес электронной почты)<br />- Active Directory: `userPrincipalName`              |
| **Условия фильтрации**      | Условия фильтрации LDAP для фильтрации пользователей/групп<br />Пример: `(&(cn=John*)(givenName=*xq*))`                                       |
| **Начальная точка поиска**  | Базовый DN для поиска пользователей/групп (например, `dc=example,dc=org`)                                                                           |
| **Область поиска**           | Область поиска:<br />- `sub`: вся поддерево директории<br />- `one`: один уровень ниже начальной точки                                   |
| **Атрибут для входа**        | Уникальный идентификатор пользователя:<br />- OpenLDAP: `uid`<br />- Active Directory: `distinguishedName`                                         |
| **Атрибут имени**         | Атрибут имени объекта (по умолчанию: `cn`)                                                                                               |
| **Атрибут электронной почты**        | Атрибут электронной почты:<br />- OpenLDAP: `mail`<br />- Active Directory: `userPrincipalName`                                               |
| **Атрибут участника группы** | Идентификатор участника группы (по умолчанию: `uid`)                                                                                            |
| **Атрибут группы**        | Атрибут отношений пользователя с группой (по умолчанию: `memberuid`)                                                                            |

4. В разделе **Проверка конфигурации службы IDP**:
   - Введите действительное имя пользователя учетной записи LDAP и пароль
   - Имя пользователя должно соответствовать настройке **Поля для входа**
   - Нажмите для подтверждения конфигурации

5. (Необязательно) Настройте **Политику автоматической синхронизации LDAP**:
   - Включите переключатель **Автосинхронизация пользователей**
   - Установите правила синхронизации
   - Используйте [онлайн- инструмент](https://tool.lu/crontab/) для проверки выражений CRON

6. Нажмите **Добавить**

:::note

После добавления LDAP:

- Пользователи могут войти в систему до синхронизации
- Информация о пользователе синхронизируется автоматически при первом входе
- Автосинхронизация происходит на основе настроенных правил

:::

## Примеры конфигурации LDAP

### Конфигурация соединителя LDAP

Следующий пример показывает, как настроить соединитель LDAP:

```yaml
apiVersion: dex.coreos.com/v1
kind: Connector
id: ldap        # Идентификатор соединителя
name: ldap      # Отображаемое имя соединителя
type: ldap      # Тип соединителя - LDAP
metadata:
  name: ldap
  namespace: cpaas-system
spec:
  config:
    # Адрес и порт сервера LDAP
    host: ldap.example.com:636                         
    # DN и пароль для служебной учетной записи, используемой соединителем.
    # Этот DN используется для поиска пользователей и групп.
    bindDN: uid=serviceaccount,cn=users,dc=example,dc=com 
    # Пароль служебной учетной записи, необходимый при создании соединителя.
    bindPW: password                         

    # Подсказка для входа в аккаунт. Например, имя пользователя
    usernamePrompt: SSO Username
    
    # Конфигурация поиска пользователей
    userSearch:
      # Начать поиск с базового DN
      baseDN: cn=users,dc=example,dc=com
      # Условие запроса LDAP, используемое для поиска пользователей.
      # Например: "(&(objectClass=person)(uid=<username>))"
      filter: (&(objectClass=organizationalPerson))

      # Следующие поля являются прямыми отображениями атрибутов записи пользователя.
      # Атрибут идентификатора пользователя
      idAttr: uid
      # Обязательно. Атрибут для отображения на электронную почту                     
      emailAttr: mail
      # Обязательно. Атрибут для отображения на имя пользователя
      nameAttr: cn
      # Атрибут имени пользователя для входа
      # Условие фильтра будет преобразовано в "(<attr>=<username>)", например (uid=example).
      username: uid

      # Расширенные атрибуты
      # phoneAttr: phone

    # Конфигурация поиска групп  
    groupSearch:
      # Начать поиск с базового DN
      baseDN: cn=groups,dc=freeipa,dc=example,dc=com
      # Условие фильтра группы
      # "(&(objectClass=group)(member=<user uid>))".
      filter: "(objectClass=group)"
      # Поле сопоставления группы пользователя
      # Атрибут группы
      groupAttr: member
      # Атрибут участника группы пользователя
      userAttr: uid
      # 组显示名称
      nameAttr: cn
```

### Примеры фильтров пользователей

```yaml
# 1. Базовый фильтр: Найти всех пользователей
(&(objectClass=person))

# 2. Сочетание нескольких условий: Найти пользователей в конкретном департаменте
(&(objectClass=person)(departmentNumber=1000))

# 3. Найти включенных пользователей (Active Directory)
(&(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))

# 4. Найти пользователей с определенным доменом электронной почты
(&(objectClass=person)(mail=*@example.com))

# 5. Найти участников конкретной группы
(&(objectClass=person)(memberOf=cn=developers,ou=groups,dc=example,dc=com))

# 6. Найти недавно вошедших пользователей (Active Directory)
(&(objectClass=user)(lastLogon>=20240101000000.0Z))

# 7. Исключить системные учетные записи
(&(objectClass=person)(!(uid=admin))(!(uid=system)))

# 8. Найти пользователей с определенным атрибутом
(&(objectClass=person)(mobile=*))

# 9. Найти пользователей в нескольких департаментах
(&(objectClass=person)(|(ou=IT)(ou=HR)(ou=Finance)))

# 10. Пример сложного сочетания условий
(&
  (objectClass=person)
  (|(department=IT)(department=Engineering))
  (!(title=Intern))
  (manager=cn=John Doe,ou=People,dc=example,dc=com)
)
```

### Примеры конфигурации поиска групп

```yaml
# 1. Базовый фильтр: Найти все группы
(objectClass=groupOfNames)

# 2. Найти группы с определенным префиксом
(&(objectClass=groupOfNames)(cn=dev-*))

# 3. Найти непустые группы
(&(objectClass=groupOfNames)(member=*))

# 4. Найти группы с определенным участником
(&(objectClass=groupOfNames)(member=uid=john,ou=People,dc=example,dc=com))

# 5. Найти вложенные группы (Active Directory)
(&(objectClass=group)(|(groupType=-2147483646)(groupType=-2147483644)))

# 6. Найти группы с определенным описанием
(&(objectClass=groupOfNames)(description=*admin*))

# 7. Исключить системные группы
(&(objectClass=groupOfNames)(!(cn=system*)))

# 8. Найти группы с определенными участниками
(&(objectClass=groupOfNames)(|(cn=admins)(cn=developers)(cn=operators)))

# 9. Найти группы в конкретном OU
(&(objectClass=groupOfNames)(ou=IT))

# 10. Пример сложного сочетания условий
(&
  (objectClass=groupOfNames)
  (|(cn=prod-*)(cn=dev-*))
  (!(cn=deprecated-*))
  (owner=cn=admin,dc=example,dc=com)
)
```

### Примеры операторов AND(&) и OR(|) в фильтрах LDAP

```yaml
# Оператор AND (&) - Все условия должны быть выполнены
# Синтаксис: (&(condition1)(condition2)(condition3)...)

# Пример нескольких атрибутов AND
(&
  (objectClass=person)
  (mail=*@example.com)
  (title=Engineer)
  (manager=*)
)

# Оператор OR (|) - Хотя бы одно условие должно быть выполнено
# Синтаксис: (|(condition1)(condition2)(condition3)...)

# Пример нескольких атрибутов OR
(|
  (department=IT)
  (department=HR)
  (department=Finance)
)

# Комбинирование AND и OR
(&
  (objectClass=person)
  (|
    (department=IT)
    (department=R&D)
  )
  (employeeType=FullTime)
)

# Сложное сочетание условий
(&
  (objectClass=person)
  (|
    (&
      (department=IT)
      (title=*Engineer*)
    )
    (&
      (department=R&D)
      (title=*Developer*)
    )
  )
  (!(status=Inactive))
  (|(manager=*)(isManager=TRUE))
)
```

## Синхронизация пользователей LDAP

После успешной синхронизации пользователей LDAP на платформе вы можете просмотреть синхронизированных пользователей в списке пользователей.

Вы можете настроить политику автоматической синхронизации при [добавлении LDAP](#addldap) (которую можно обновить позже) или вручную запустить синхронизацию после успешного добавления LDAP. Вот как запустить операцию синхронизации вручную.

**Примечания**:

- Недавно добавленные пользователи в integrated LDAP с платформой могут войти на платформу до выполнения операции синхронизации пользователей. Как только они успешно вошли в платформу, их информация будет автоматически синхронизирована с платформой.

- Удаленные пользователи из LDAP будут иметь статус `Неверный` после синхронизации.

- Стандартный срок действия для недавно синхронизированных пользователей составляет **Постоянный**.

- Синхронизированные пользователи с тем же именем, что и существующие пользователи (локальные пользователи, пользователи IDP), автоматически ассоциируются. Их разрешения и срок действия будут совпадать с существующими пользователями. Они могут войти на платформу, используя метод входа, соответствующий их источникам.

### Процедура выполнения

1. В левом навигационном меню нажмите **Пользователи** > **IDP**.

2. Нажмите на ***Имя LDAP***, которое вы хотите вручную синхронизировать.

3. Нажмите **Действия** > **Синхронизировать пользователей** в верхнем правом углу.

4. Нажмите **Синхронизировать**.

   **Примечания**: Если вы вручную закроете диалоговое окно с подсказкой о синхронизации, появится диалог для подтверждения закрытия. После закрытия диалогового окна с подсказкой о синхронизации система продолжит синхронизацию пользователей. Если вы остаетесь на странице списка пользователей, вы получите обратную связь о результате синхронизации. Если вы покинете страницу списка пользователей, вы не получите результаты синхронизации.

## Связанные операции

Вы можете нажать на ![](/en/img/113point.png) справа на странице списка или нажать **Действия** в верхнем правом углу на странице деталей, чтобы обновить или удалить LDAP по мере необходимости.

| Операция       | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Обновить LDAP** | Обновите информацию конфигурации добавленного LDAP или **Политику автосинхронизации LDAP**.<br /><br />**Примечание**: После обновления LDAP пользователи, которые в данный момент синхронизированы с платформой через этот LDAP, также будут обновлены. Пользователи, удаленные из LDAP, станут недействительными в списке пользователей платформы. Вы можете очистить ненужные данные, выполнив операцию очистки недействительных пользователей.                                                                                                                                           |
| **Удалить LDAP** | После удаления LDAP все пользователи, синхронизированные с платформой через этот LDAP, получат статус **Неверный** (связь между пользователями и ролями останется неизменной), и они не смогут войти в платформу. После повторной интеграции необходимо повторно выполнить синхронизацию, чтобы активировать пользователей.<br /><br />**Подсказки**: После удаления IDP, если вам нужно удалить пользователей и группы пользователей, синхронизированные с платформой через LDAP, установите флажок **Очистить пользователей и группы пользователей IDP** ниже при появлении предупреждающего окна. |
