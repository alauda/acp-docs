---
weight: 20
sourceSHA: 29025fc504a62e449ed0134f6d3f37c39023949f91e812481d0068330b015e0e
---

# Создание образов Windows на основе ISO с использованием KubeVirt

В этом документе обсуждается решение для виртуальной машины на основе компонента с открытым исходным кодом KubeVirt, использующее технологию виртуализации KubeVirt для создания образа операционной системы Windows через файл образа ISO.

## Предварительные требования

- Все компоненты в кластере функционируют правильно.

- Пожалуйста, заранее подготовьте образ Windows и [последние virtio-win-tools](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/).

- Пожалуйста, подготовьте репозиторий для хранения образа. В данном документе используется репозиторий build-harbor.example.cn в качестве примера; замените его в соответствии с вашей реальной средой.

## Ограничения и ограничения

- При запуске KubeVirt размер файловой системы пользовательского образа будет влиять на скорость записи образа на диск в PVC. Если файловая система слишком велика, это может привести к увеличению времени создания.

- Рекомендуется поддерживать корневой раздел Linux или диск C Windows менее 100 ГБ, чтобы минимизировать начальный размер. Последующее расширение может быть выполнено через cloud-init (для систем Windows его необходимо расширить вручную после создания).

## Процедура

<Steps>
  ### Создание образа

  Создайте образ Docker из подготовленных ISO-образов Windows и virtio-win и отправьте его в репозиторий. В данном документе в качестве примера используется Windows Server 2019.

  **Создание образа Docker из образа Windows ISO**

  1. Перейдите в каталог, где хранится ISO-образ, и выполните следующую команду в терминале, чтобы переименовать ISO-образ в win.iso.

     ```bash
     mv <ISO image name> win.iso # Замените <ISO image name> на фактическое имя изображения, например, mv en_windows_server_2019_x64_dvd_4cb967d8.iso win.iso
     ```

  2. Выполните следующую команду для создания Dockerfile.

     ```bash
     touch Dockerfile
     ```

  3. Отредактируйте Dockerfile, добавьте следующий содержимое и сохраните его.

     ```docker
     FROM scratch
     ADD --chown=107:107 win.iso /disk/
     ```

  4. Выполните следующую команду для сборки образа Docker.

     ```bash
     docker build -t build-harbor.example.cn/3rdparty/vmdisks/winiso:2019 . # Замените репозиторий в соответствии с вашей реальной средой
     ```

  5. Выполните следующую команду для отправки образа в репозиторий.

     ```bash
     docker push  build-harbor.example.cn/3rdparty/vmdisks/winiso:2019 # Замените репозиторий в соответствии с вашей реальной средой
     ```

  **Создание образа Docker из virtio-win ISO**

  1. Перейдите в каталог, где хранится ISO-образ, и выполните следующую команду в терминале для создания Dockerfile.

     ```bash
     touch Dockerfile
     ```

  2. Отредактируйте Dockerfile, добавьте следующий содержимое и сохраните его.

     ```docker
     FROM scratch
     ADD --chown=107:107 virtio-win.iso  /disk/
     ```

  3. Выполните следующую команду для сборки образа Docker.

     ```bash
     docker build -t build-harbor.example.cn/3rdparty/vmdisks/win-virtio:latest . # Замените репозиторий в соответствии с вашей реальной средой
     ```

  4. Выполните следующую команду для отправки образа в репозиторий.

     ```bash
     docker push  build-harbor.example.cn/3rdparty/vmdisks/win-virtio:latest # Замените репозиторий в соответствии с вашей реальной средой
     ```

  ### Создание виртуальной машины

  1. Получите доступ к **Container Platform**.

  2. В левой панели навигации нажмите **Виртуализация** > **Виртуальные машины**.

  3. Нажмите **Создать виртуальную машину**.

  4. Заполните необходимые параметры, такие как **Имя**, **Образ** и т. д., на странице формы. Для подробных параметров и конфигураций, пожалуйста, посмотрите [Создать виртуальную машину](/virtualization/virtualization/virtual_machine/functions/create_virtual_machine.mdx).

  5. Переключитесь на YAML.

  6. Замените конфигурацию в поле spec.template.spec.domain.devices.disks следующим содержимым.

     ```yaml
       domain:
         devices:
           disks:
             - disk:
                 bus: virtio
               name: cloudinitdisk
             - bootOrder: 1
               cdrom:
                 bus: sata
               name: containerdisk
             - cdrom:
                 bus: sata
               name: virtio
             - disk:
                 bus: sata
               name: rootfs
               bootOrder: 10
     ```

  7. Добавьте следующее содержимое в поле spec.template.spec.volumes.

     ```yaml
             - containerDisk:
                 image: registry.example.cn:60070/3rdparty/vmdisks/winiso:2019 # Замените образ в соответствии с вашей реальной средой
               name: containerdisk
             - containerDisk:
                 image: registry.example.cn:60070/3rdparty/vmdisks/win-virtio # Замените образ в соответствии с вашей реальной средой
               name: virtio
     ```

  8. Проверьте YAML-файл. Полный YAML после завершения конфигурации выглядит следующим образом.

     ```yaml
     apiVersion: kubevirt.io/v1alpha3
     kind: VirtualMachine
     metadata:
       annotations:
         cpaas.io/creator: test@example.io
         cpaas.io/display-name: ""
         cpaas.io/updated-at: 2024-09-01T14:57:55Z
         kubevirt.io/latest-observed-api-version: v1
         kubevirt.io/storage-observed-api-version: v1
       generation: 16
       labels:
         virtualization.cpaas.io/image-name: debian-2120-x86
         virtualization.cpaas.io/image-os-arch: amd64
         virtualization.cpaas.io/image-os-type: debian
         virtualization.cpaas.io/image-supply-by: public
         vm.cpaas.io/name: aa-test
       name: aa-test
       namespace: acp-service-self
     spec:
       dataVolumeTemplates:
         - metadata:
             creationTimestamp: null
             labels:
               vm.cpaas.io/reclaim-policy: Delete
               vm.cpaas.io/used-by: aa-test
             name: aa-test-rootfs
           spec:
             pvc:
               accessModes:
                 - ReadWriteOnce
               resources:
                 requests:
                   storage: 100Gi
               storageClassName: vm-cephrbd
               volumeMode: Block
             source:
               http:
                 url: http://192.168.254.12/kube-debian-12.2.0-x86-out.qcow2
       running: true
       template:
         metadata:
           annotations:
             cpaas.io/creator: test@example.io
             cpaas.io/display-name: ""
             cpaas.io/updated-at: 2024-09-01T14:55:44Z
             kubevirt.io/latest-observed-api-version: v1
             kubevirt.io/storage-observed-api-version: v1
           creationTimestamp: null
           labels:
             virtualization.cpaas.io/image-name: debian-2120-x86
             virtualization.cpaas.io/image-os-arch: amd64
             virtualization.cpaas.io/image-os-type: debian
             virtualization.cpaas.io/image-supply-by: public
             vm.cpaas.io/name: aa-test
         spec:
           affinity:
             nodeAffinity: {}
           architecture: amd64
           domain:
             devices:
               disks:
                 - disk:
                     bus: virtio
                   name: cloudinitdisk
                 - bootOrder: 1
                   cdrom:
                     bus: sata
                   name: containerdisk
                 - cdrom:
                     bus: sata
                   name: virtio
                 - disk:
                     bus: sata
                   name: rootfs
                   bootOrder: 10
                interfaces:
                 - bridge: {}
                   name: default
             machine:
               type: q35
             resources:
               limits:
                 cpu: "4"
                 memory: 8Gi
               requests:
                 cpu: "4"
                 memory: 8Gi
           networks:
             - name: default
               pod: {}
           nodeSelector:
             kubernetes.io/arch: amd64
             vm.cpaas.io/baremetal: "true"
           volumes:
             - cloudInitConfigDrive:
                 userData: >-
                   #cloud-config
      
                   disable_root: false
      
                   ssh_pwauth: true
      
                   users:
                     - default
                     - name: root
                       lock_passwd: false
                       hashed_passwd: $6$0vlhl57e$0rawYwaeu9jL6hBf3XP9lk6XXaMUS9/W6LPbWRinUoXujo39lP3l98VOcOObtr.LDoAv/ylm85FLQmxwNlWFe/
               name: cloudinitdisk
             - containerDisk:
                 image: registry.example.cn:60070/3rdparty/vmdisks/winiso:2019 # Замените образ в соответствии с вашей реальной средой
               name: containerdisk
               - containerDisk
                  image: registry.example.cn:60070/3rdparty/vmdisks/win-virtio # Замените образ в соответствии с вашей реальной средой
                name: virtio 
              - dataVolume:
                 name: aa-test-rootfs
               name: rootfs
     ```

  9. Нажмите **Создать**.

  10. Нажмите **Действия** > **VNC Вход**.

  11. Когда появится сообщение **нажмите любую клавишу для загрузки с CD или DVD**, нажмите любую клавишу, чтобы войти в программу установки Windows; если вы не видите подсказки, нажмите **Отправить удаленную команду** в верхнем левом углу страницы, затем выберите **Ctrl-Alt-Delete** из выпадающего меню, чтобы перезагрузить сервер.

      **Примечание**: Если на странице деталей виртуальной машины появляется сообщение **Текущая виртуальная машина имеет изменения конфигурации, которые требуют перезапуска для применения, пожалуйста, перезапустите**, это сообщение можно игнорировать; перезапуск не требуется.

  ### Установка операционной системы Windows

  1. Следуйте инструкциям по установке для установки системы после входа на страницу установки.

     **Примечание**: На этапе выбора разделов шина должна быть SATA, чтобы диск был правильно распознан. Поэтому вам необходимо выбрать каждый раздел по очереди и нажать **Удалить**, чтобы удалить все разделы, позволяя системе обрабатывать это автоматически.

  2. После настройки пароля администратора нажмите **Отправить удаленную команду** в верхнем левом углу страницы, затем выберите **Ctrl-Alt-Delete** из выпадающего меню.

  3. Когда появится запрос **Сочетание Ctrl+Alt+Delete перезагрузит сервер, подтвердите перезагрузку**, нажмите **OK**.

  4. Введите пароль для доступа к рабочему столу системы Windows; в этот момент установка операционной системы Windows завершена.

  ### Установка virtio-win-tools

  Этот инструмент в основном содержит необходимые драйверы.

  1. Откройте проводник файлов.

  2. Дважды щелкните **CD Drive(E:) virtio-win-\<version>**, перейдите в директорию **virtio-win-guest-tools** для входа на страницу установки и следуйте инструкциям по установке. Часть \<version> должна базироваться на реальной ситуации.

  3. После завершения установки выключите систему Windows.

  ### Экспорт пользовательского образа Windows

  Пожалуйста, обратитесь к [Экспорт образа виртуальной машины](./vm_image_export.mdx) для конкретной операции.

  ### Использование образа Windows

  1. Получите доступ к **Container Platform**.

  2. В левой панели навигации нажмите **Виртуализация** > **Виртуальные машины**.

  3. Нажмите **Создать виртуальную машину**.

  4. Заполните необходимые параметры на странице формы. Для образа выберите экспортированный образ Windows. Для подробных параметров и конфигураций, пожалуйста, посмотрите [Создать виртуальную машину](/virtualization/virtualization/virtual_machine/functions/create_virtual_machine.mdx).

  5. (Необязательно) Если вы используете более новую операционную систему, такую как Windows 11, включите такие функции, как часы, UEFI, TPM и т. д. Переключитесь на YAML и замените оригинальный YAML-файл следующим YAML-файлом.

     ```yaml
     apiVersion: kubevirt.io/v1
     kind: VirtualMachineInstance
     metadata:
       labels:
         special: vmi-windows
       name: vmi-windows
     spec:
       domain:
         clock:
           timer:
             hpet:
               present: false
             hyperv: {}
             pit:
               tickPolicy: delay
             rtc:
               tickPolicy: catchup
           utc: {}
         cpu:
           cores: 2
         devices:
           disks:
           - disk:
               bus: sata
             name: pvcdisk
           interfaces:
           - masquerade: {}
             model: e1000
             name: default
           tpm: {}
         features:
           acpi: {}
           apic: {}
           hyperv:
             relaxed: {}
             spinlocks:
               spinlocks: 8191
             vapic: {}
           smm: {}
         firmware:
           bootloader:
             efi:
               secureBoot: true
           uuid: 5d307ca9-b3ef-428c-8861-06e72d69f223
         resources:
           requests:
             memory: 4Gi
       networks:
       - name: default
         pod: {}
       terminationGracePeriodSeconds: 0
       volumes:
       - name: pvcdisk
         persistentVolumeClaim:
           claimName: disk-windows
       - name: winiso
         persistentVolumeClaim:
           claimName: win11cd-pvc
     ```

  6. Нажмите **Создать**.

  ### Добавить внутренний маршрут

  Настроив внутренний маршрут типа NodePort, откройте порт для удаленных подключений рабочего стола.

  1. Получите доступ к **Container Platform**.

  2. В левой панели навигации нажмите **Виртуализация** > **Виртуальные машины**.

  3. Нажмите на имя виртуальной машины, созданной с использованием образа Windows, в списке для перехода на страницу деталей.

  4. Нажмите на значок **Добавить** рядом с **Внутренним маршрутом** в области **Информация для входа**.

  5. Настройте параметры в соответствии со следующими инструкциями.

     | Параметр | Описание                                                                                                                                         |
     | --------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
     | **Тип**  | Выберите **NodePort**.                                                                                                                                |
     | **Порт**  | <ul><li>Протокол: Выберите TCP.</li><li>Порт службы: Используйте 3389.</li><li>Порт виртуальной машины: Используйте 3389.</li><li>Имя порта службы: Используйте rdp.</li></ul> |

  6. Нажмите **OK**, чтобы вернуться на страницу деталей.

  7. Нажмите на ссылку **Внутренний маршрут** в области **Информация для входа**.

  8. Сохраните информацию о **Виртуальном IP** в области основной информации и информацию о **Порту хоста** в области порта.
</Steps>

## Удаленный доступ

В данном документе рассматривается использование операционной системы Windows для удаленного подключения в качестве примера. Другие операционные системы могут использовать программное обеспечение, поддерживающее протокол RDP, для подключения.

1. Откройте **Подключение к удаленному рабочему столу**.

2. Введите сохраненный Виртуальный IP и Порт хоста из шага **Добавить внутренний маршрут**, отформатированный как **Виртуальный IP:Порт хоста**, например: 192.1.1.1:3389.

3. Нажмите **Подключить**.
