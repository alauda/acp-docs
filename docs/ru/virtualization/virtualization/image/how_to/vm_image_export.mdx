---
weight: 40
sourceSHA: 29bb22a97611b511eb325bda70c123399f4eb994939ffe901f8846d30b829d0a
---

# Экспорт изображений виртуальных машин

Эта функция используется для экспорта системного образа виртуальной машины и загрузки его в облачное хранилище, что позволяет добавлять файлы в облачном хранилище как источники для образов виртуальных машин на платформе.

## Процедура

**Примечание**: Все операции ниже должны выполняться на управляющем узле кластера, в котором находится виртуальная машина.

<Steps>
  ### Остановка виртуальной машины

  1. Перейдите в **Управление платформой**.

  2. В левой панели навигации нажмите **Управление виртуализацией** > **Виртуальные машины**.

  3. Нажмите на имя виртуальной машины, системный образ которой необходимо экспортировать, это перенаправит вас на страницу с деталями виртуальной машины в платформе контейнеров.

  4. Нажмите **Стоп**.

  ### Создание ресурса vmexport

  1. Откройте инструмент CLI.

  2. Выполните следующую команду для установки переменных.

     ```bash
     NAMESPACE=<namespace> 
     VM_NAME=<vm_name>
     TTL_DURATION=2h
     ```

     Пояснение параметров:

     - **NAMESPACE**: Имя пространств имен, в котором находится виртуальная машина; замените часть *\<namespace>* на это имя.
     - **VM\_NAME**: Имя виртуальной машины, системный образ которой необходимо экспортировать; замените часть *\<vm\_name>* на это имя.
     - **TTL\_DURATION**: Срок действия задачи экспорта, по умолчанию составляет 2 часа, но его можно увеличить по мере необходимости.

  3. Выполните следующую команду для создания ресурса vmexport.

     ```bash
     cat <<EOF | kubectl create -f -
     apiVersion: export.kubevirt.io/v1alpha1
     kind: VirtualMachineExport
     metadata:
       name: export-$VM_NAME
       namespace: $NAMESPACE
     spec:
       ttlDuration: $TTL_DURATION
       source:
         apiGroup: "kubevirt.io"
         kind: VirtualMachine
         name: $VM_NAME
     EOF
     ```

     Если появляется аналогичная информация об эхо, это указывает на успешное создание.

     ```bash
     virtualmachineexport.export.kubevirt.io/export-k1 created
     ```

  4. Выполните следующую команду для проверки статуса ресурса vmexport.

     ```bash
     kubectl -n $NAMESPACE get vmexport export-$VM_NAME -w
     ```

     Информация об эхо:

     ```bash
     NAME        SOURCEKIND       SOURCENAME   PHASE
     export-k1   VirtualMachine   k1           Готов
     ```

  5. Когда поле PHASE в информации об эхо изменится на Готов, введите ctrl (control) + c для остановки операции наблюдения.

  6. Выполните следующую команду для получения TOKEN.

     ```bash
     TOKEN=$(kubectl -n $NAMESPACE get secret export-token-export-$VM_NAME -o jsonpath={.data.token} | base64 -d)
     ```

  ### Скачивание файла изображения виртуальной машины

  1. Выполните следующую команду для получения IP-адреса Pod экспорта виртуальной машины в указанном пространстве имен и сохраните его в переменной окружения EXPORT\_SERVER\_IP.

     ```bash
     EXPORT_SERVER_IP=$(kubectl -n $NAMESPACE get po virt-export-export-$VM_NAME -o jsonpath='{.status.podIP}')
     ```

  2. Выполните следующую команду для установки переменной окружения URL, указывающей на файл дискового образа виртуальной машины.

     ```bash
     URL=https://$EXPORT_SERVER_IP:8443/volumes/$VM_NAME-rootfs/disk.img.gz
     ```

  3. Выполните следующую команду для скачивания файла изображения, скачанный файл будет называться disk.img.gz.

     ```bash
     curl -k -O -H "x-kubevirt-export-token: $TOKEN" $URL
     ```

  ### Загрузка файла изображения виртуальной машины в облачное хранилище

  Загрузите загруженный файл изображения в облачное хранилище. Для загрузки можно использовать любой инструмент S3, а в этом документе будет представлен, как пример, инструмент mc (minio-client).

  1. Выполните следующую команду для настройки инструмента mc и подключения к указанной службе S3.

     ```bash
     mc alias set minio <ENDPOINT> <ACCESSKEY> <SECRETKEY>
     ```

     Пояснение параметров:

     - ENDPOINT: Адрес службы хранения S3; замените часть *\<ENDPOINT>* на этот адрес.
     - ACCESSKEY, SECRETKEY: Пользовательская ak и sk службы хранения S3, используемая для аутентификации; для получения дополнительной информации, пожалуйста, обратитесь к [MinIO Object Storage](https://min.io/docs/minio/kubernetes/upstream/index.html?ref=docs-redirect).

  2. Выполните следующую команду для создания корзины для хранения файлов изображений виртуальных машин.

     ```bash
     mc mb minio/vmdisks
     ```

  3. Выполните следующую команду для загрузки экспортированного файла изображения виртуальной машины disk.img.gz в созданную корзину.

     ```bash
     mc put disk.img.gz minio/vmdisks
     ```

  ### Создание изображения виртуальной машины

  1. Перейдите в **Управление платформой**.

  2. В левой панели навигации нажмите **Управление виртуализацией** > **Изображения виртуальных машин**.

  3. Нажмите **Добавить изображение виртуальной машины**.

  4. В адресе изображения заполните *\<ENDPOINT>*/vmdisks/disk.img.gz, заменив часть \<ENDPOINT> на адрес службы хранения S3. Для других пояснений параметров, пожалуйста, обратитесь к [Добавление изображений виртуальных машин](../functions/add_image.md).

  5. Нажмите **Добавить**.
</Steps>
