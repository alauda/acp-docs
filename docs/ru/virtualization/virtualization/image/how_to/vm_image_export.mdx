---
weight: 40
sourceSHA: 29bb22a97611b511eb325bda70c123399f4eb994939ffe901f8846d30b829d0a
---

# Экспорт образов виртуальных машин

Эта функция используется для экспорта системного образа виртуальной машины и загрузки его в объектное хранилище, позволяя добавлять файлы в объектном хранилище в качестве источников для образов виртуальных машин платформы.

## Процедура

**Примечание**: Все операции, указанные ниже, необходимо выполнять на управляющем узле кластера, где находится виртуальная машина.

<Steps>
  ### Остановка виртуальной машины

  1. Перейдите в **Управление платформой**.

  2. В левой панели навигации нажмите **Управление виртуализацией** > **Виртуальные машины**.

  3. Нажмите на имя виртуальной машины, чьему системному образу требуется экспорт, что перенаправит вас на страницу деталей виртуальной машины в Контейнерной платформе.

  4. Нажмите **Остановить**.

  ### Создание ресурса vmexport

  1. Откройте инструмент CLI.

  2. Выполните следующую команду для настройки переменных.

     ```bash
     NAMESPACE=<namespace> 
     VM_NAME=<vm_name>
     TTL_DURATION=2h
     ```

     Пояснение параметров:

     - **NAMESPACE**: Имя пространства имен, в котором находится виртуальная машина; замените часть *\<namespace>* на это имя.
     - **VM\_NAME**: Имя виртуальной машины, чьему системному образу требуется экспорт; замените часть *\<vm\_name>* на это имя.
     - **TTL\_DURATION**: Время жизни задачи экспорта, по умолчанию 2 часа, но может быть увеличено по мере необходимости.

  3. Выполните следующую команду для создания ресурса vmexport.

     ```bash
     cat <<EOF | kubectl create -f -
     apiVersion: export.kubevirt.io/v1alpha1
     kind: VirtualMachineExport
     metadata:
       name: export-$VM_NAME
       namespace: $NAMESPACE
     spec:
       ttlDuration: $TTL_DURATION
       source:
         apiGroup: "kubevirt.io"
         kind: VirtualMachine
         name: $VM_NAME
     EOF
     ```

     Если появляются аналогичные эхо-сообщения, это указывает на успешное создание.

     ```bash
     virtualmachineexport.export.kubevirt.io/export-k1 created
     ```

  4. Выполните следующую команду для проверки статуса ресурса vmexport.

     ```bash
     kubectl -n $NAMESPACE get vmexport export-$VM_NAME -w
     ```

     Эхо-сообщение:

     ```bash
     NAME        SOURCEKIND       SOURCENAME   PHASE
     export-k1   VirtualMachine   k1           Ready
     ```

  5. Когда поле PHASE в эхо-сообщении изменится на Ready, нажмите ctrl (control) + c для остановки операции наблюдения.

  6. Выполните следующую команду для получения TOKEN.

     ```bash
     TOKEN=$(kubectl -n $NAMESPACE get secret export-token-export-$VM_NAME -o jsonpath={.data.token} | base64 -d)
     ```

  ### Скачивание файла образа виртуальной машины

  1. Выполните следующую команду, чтобы получить IP-адрес Pod экспорта виртуальной машины в указанном пространстве имен и сохранить его в переменной окружения EXPORT\_SERVER\_IP.

     ```bash
     EXPORT_SERVER_IP=$(kubectl -n $NAMESPACE get po virt-export-export-$VM_NAME -o jsonpath='{.status.podIP}')
     ```

  2. Выполните следующую команду для установки переменной окружения URL, которая указывает на файл образа диска виртуальной машины.

     ```bash
     URL=https://$EXPORT_SERVER_IP:8443/volumes/$VM_NAME-rootfs/disk.img.gz
     ```

  3. Выполните следующую команду для скачивания файла образа, при этом загруженный файл будет называться disk.img.gz.

     ```bash
     curl -k -O -H "x-kubevirt-export-token: $TOKEN" $URL
     ```

  ### Загрузка файла образа виртуальной машины в объектное хранилище

  Загрузите загруженный файл образа в объектное хранилище. Для загрузки можно использовать любой инструмент S3, и в этом документе будет представлен инструмент mc (minio-client) в качестве примера.

  1. Выполните следующую команду для настройки инструмента mc и подключения к указанному сервису S3.

     ```bash
     mc alias set minio <ENDPOINT> <ACCESSKEY> <SECRETKEY>
     ```

     Пояснение параметров:

     - ENDPOINT: Адрес сервиса S3; замените часть `<ENDPOINT>` на этот адрес.
     - ACCESSKEY, SECRETKEY: Пользовательские ak и sk сервиса S3, используемые для аутентификации; для получения дополнительной информации смотрите [MinIO Object Storage](https://min.io/docs/minio/kubernetes/upstream/index.html?ref=docs-redirect).

  2. Выполните следующую команду для создания бакета для хранения файлов образов виртуальных машин.

     ```bash
     mc mb minio/vmdisks
     ```

  3. Выполните следующую команду для загрузки экспортированного файла образа виртуальной машины disk.img.gz в созданный бакет.

     ```bash
     mc put disk.img.gz minio/vmdisks
     ```

  ### Создание образа виртуальной машины

  1. Перейдите в **Управление платформой**.

  2. В левой панели навигации нажмите **Управление виртуализацией** > **Образы виртуальных машин**.

  3. Нажмите **Добавить образ виртуальной машины**.

  4. В адресе изображения заполните *\<ENDPOINT>*/vmdisks/disk.img.gz, заменив часть \<ENDPOINT> на адрес сервиса S3. Для других пояснений параметров см. [Добавление образов виртуальных машин](../functions/add_image.md).

  5. Нажмите **Добавить**.
</Steps>
