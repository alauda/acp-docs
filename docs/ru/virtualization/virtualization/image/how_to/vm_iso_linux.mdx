---
weight: 30
sourceSHA: bec4285d6e9e0a9d6922a08cfe0aafb385f0d8f81a24be117c1c35252262e318
---

# Создание образов Linux на основе ISO с использованием KubeVirt

Данный документ описывает решение для виртуальной машины, реализованное на базе компонента с открытым исходным кодом KubeVirt. Он использует технологии виртуализации KubeVirt для создания образа операционной системы Linux из файла изображения ISO.

## Предварительные требования

- Все компоненты в кластере должны функционировать корректно.

- Образ Linux должен быть подготовлен заранее. В этом документе в качестве примера используется [операционная система Ubuntu](https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/).

- Репозиторий для хранения образов следует подготовить заранее. В данном документе в качестве примера используется репозиторий build-harbor.example.cn; пожалуйста, замените его в соответствии с вашей реальной средой.

## Ограничения и ограничения

- При запуске KubeVirt размер файловой системы пользовательского образа повлияет на скорость записи образа на PVC-диск. Если файловая система слишком велика, это может привести к длительному времени создания.

- Рекомендуется поддерживать размер корневого раздела Linux ниже 100G, чтобы минимизировать начальный размер. После настройки cloud-init выделите больше места для корневого раздела при создании виртуальной машины, и система автоматически его расширит.

## Процедура

<Steps>
  ### Преобразование образа ISO Linux в образ Docker

  1. Перейдите в директорию, где хранится образ ISO и выполните следующую команду в терминале, чтобы переименовать образ ISO в ubuntu.iso.

     ```bash
     mv <ISO имя изображения> ubuntu.iso # Замените <ISO имя изображения> на фактическое имя изображения, например, mv ubuntu-24.04-live-server-amd64.iso ubuntu.iso
     ```

  2. Создайте Dockerfile, выполнив следующую команду.

     ```bash
     touch Dockerfile
     ```

  3. Отредактируйте Dockerfile, добавьте следующее содержимое и сохраните его.

     ```docker
     FROM scratch
     ADD --chown=107:107 ubuntu.iso /disk/
     ```

  4. Соберите образ Docker, выполнив следующую команду.

     ```bash
     docker build -t build-harbor.example.cn/3rdparty/vmdisks/ubuntu-iso:24.04 . # Пожалуйста, замените репозиторий в соответствии с вашей реальной средой
     ```

  5. Отправьте образ в репозиторий, выполнив следующую команду.

     ```bash
     docker push build-harbor.example.cn/3rdparty/vmdisks/ubuntu-iso:24.04 # Пожалуйста, замените репозиторий в соответствии с вашей реальной средой
     ```

  ### Создание виртуальной машины

  1. Перейдите в **Платформу контейнеров**.

  2. Нажмите **Виртуализация** > **Виртуальные машины** в левой навигационной панели.

  3. Нажмите **Создать виртуальную машину**.

  4. Заполните параметры на странице формы следующим образом. Для конкретных параметров и конфигураций, пожалуйста, обратитесь к [Создать виртуальную машину](/virtualization/virtualization/virtual_machine/functions/create_virtual_machine.mdx).

     | Параметр          | Описание                                             |
     | ------------------ | --------------------------------------------------- |
     | **Выбрать образ**  | Выберите шаблон изображения для виртуальной машины.  |
     | **IP-адрес**       | Оставьте по умолчанию, он будет получен через **DHCP**.  |
     | **Сетевая конфигурация** | Используйте режим **NAT**; не используйте **мостовой** режим здесь. |

  5. Переключитесь на YAML.

  6. Замените конфигурацию в поле spec.template.spec.domain.devices.disks следующим содержимым.

     ```yaml
           domain:
             devices:
               disks:
                 - bootOrder: 1
                   cdrom:
                     bus: sata
                   name: containerdisk
                 - disk:
                     bus: virtio
                   name: cloudinitdisk
                 - disk:
                     bus: virtio
                   name: rootfs
                   bootOrder: 10
     ```

  7. Добавьте следующее содержимое в поле spec.template.spec.volumes.

     ```yaml
             - containerDisk:
                 image: registry.example.cn:60070/3rdparty/vmdisks/ubuntu-iso:24.04 # Пожалуйста, замените изображение в соответствии с вашей реальной средой
               name: containerdisk
     ```

  8. Проверьте файл YAML; полный YAML-конфигурация после завершения выглядит следующим образом.

     ```yaml
     apiVersion: kubevirt.io/v1alpha3
     kind: VirtualMachine
     metadata:
       annotations:
         kubevirt.io/latest-observed-api-version: v1
         kubevirt.io/storage-observed-api-version: v1
       labels:
         virtualization.cpaas.io/image-name: debian-2120-x86
         virtualization.cpaas.io/image-os-arch: amd64
         virtualization.cpaas.io/image-os-type: debian
         virtualization.cpaas.io/image-supply-by: public
         vm.cpaas.io/name: aa
       name: aa
     spec:
       dataVolumeTemplates:
         - metadata:
             creationTimestamp: null
             labels:
               vm.cpaas.io/reclaim-policy: Delete
               vm.cpaas.io/used-by: aa
             name: aa-rootfs
           spec:
             pvc:
               accessModes:
                 - ReadWriteOnce
               resources:
                 requests:
                   storage: 100Gi
               storageClassName: vm-cephrbd
               volumeMode: Block
             source:
               http:
                 url: http://192.168.254.12/kube-debian-12.2.0-x86-out.qcow2
       running: true
       template:
         metadata:
           annotations:
             cpaas.io/creator: test@example.io
             cpaas.io/display-name: ""
             cpaas.io/updated-at: 2024-09-09T03:49:08Z
             kubevirt.io/latest-observed-api-version: v1
             kubevirt.io/storage-observed-api-version: v1
           creationTimestamp: null
           labels:
             virtualization.cpaas.io/image-name: debian-2120-x86
             virtualization.cpaas.io/image-os-arch: amd64
             virtualization.cpaas.io/image-os-type: debian
             virtualization.cpaas.io/image-supply-by: public
             vm.cpaas.io/name: aa
         spec:
           accessCredentials:
             - sshPublicKey:
                 propagationMethod:
                   qemuGuestAgent:
                     users:
                       - root
                 source:
                   secret:
                     secretName: test-xeon
           affinity:
             nodeAffinity: {}
           architecture: amd64
           domain:
             devices:
               disks:
                 - bootOrder: 1
                   cdrom:
                     bus: sata
                   name: containerdisk
                 - disk:
                     bus: virtio
                   name: cloudinitdisk
                 - disk:
                     bus: virtio
                   name: rootfs
                   bootOrder: 10
                interfaces:
                 - bridge: {}
                   name: default
             machine:
               type: q35
             resources:
               limits:
                 cpu: "1"
                 memory: 2Gi
               requests:
                 cpu: "1"
                 memory: 2Gi
           networks:
             - name: default
               pod: {}
           nodeSelector:
             kubernetes.io/arch: amd64
             vm.cpaas.io/baremetal: "true"
           volumes:
             - containerDisk:
                 image: registry.example.cn:60070/3rdparty/vmdisks/ubuntu-iso:24.04 # Пожалуйста, замените изображение в соответствии с вашей реальной средой
               name: containerdisk
             - cloudInitConfigDrive:
                 userData: |-
                   #cloud-config
                   disable_root: false
                   ssh_pwauth: false
                   users:
                     - default
                     - name: root
                       lock_passwd: false
                       hashed_passwd: ""
               name: cloudinitdisk
             - dataVolume:
                 name: aa-rootfs
               name: rootfs
     ```

  9. Нажмите **Создать**.

  10. Нажмите **Действия** > **VNC Вход**.

  11. Когда появится запрос **нажмите любую клавишу для загрузки с CD или DVD**, нажмите любую клавишу, чтобы войти в программу установки Windows; если вы не видите запроса, нажмите **Отправить удаленную команду** в верхнем левом углу страницы, а затем выберите **Ctrl-Alt-Delete** из выпадающего меню, чтобы перезагрузить сервер.

      **Примечание**: Если на верхней части страницы деталей виртуальной машины появится сообщение **Текущая виртуальная машина имеет изменения конфигурации, которые требуют перезагрузки для применения. Пожалуйста, перезагрузите.**, можете проигнорировать это сообщение; перезагрузка не требуется.

  ### Установка операционной системы Linux

  1. После входа на страницу установки следуйте руководству по установке. В данном документе приведен пример установки операционной системы Ubuntu; параметры конфигурации в процессе установки различных операционных систем обычно схожи, поэтому не будут подробно описаны. Некоторые параметры конфигурации поясняются ниже.

     | Конфигурация             | Описание                                                                                                                                                                           |
     | ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
     | **Тип установки**         | Рекомендуется использовать минимальную установку, чтобы уменьшить размер образа.                                                                                                           |
     | **Конфигурация хранилища** | Выберите пользовательское хранилище. Отформатируйте диск в формат ext4 или xfs и смонтируйте его на корневой раздел (/).<br />**Примечание**: Не используйте LVM для разбиения диска (создавать группу томов (LVM)). |
     | **Конфигурация SSH**      | Выберите установку инструментов OpenSSH для доступа по SSH.                                                                                                                                   |

  2. Дождитесь завершения установки.

  ### Изменение файла YAML

  1. Перейдите в **Платформу контейнеров**.

  2. В левой панели навигации нажмите **Виртуализация** > **Виртуальные машины**.

  3. Нажмите на **Имя виртуальной машины** в списке, чтобы перейти на страницу деталей.

  4. Нажмите **Остановить**.

  5. В верхнем правом углу нажмите **Действия** > **Обновить**.

  6. Переключитесь на YAML.

  7. Убедитесь, что диск с именем **rootfs** под spec.template.spec.domain.devices.disks имеет bootOrder равный 1. Если это не так, измените его на 1.

  8. Удалите соответствующее содержимое для диска с именем **containerdisk** под spec.template.spec.domain.devices.disks; конкретное содержимое для удаления представлено ниже.

     ```yaml
                 - bootOrder: 1
                   cdrom:
                     bus: sata
                   name: containerdisk
     ```

  9. Удалите соответствующее содержимое для диска с именем **containerdisk** под spec.template.spec.volumes; конкретное содержимое для удаления представлено ниже.

     ```yaml
             - containerDisk:
                 image: registry.example.cn:60070/3rdparty/vmdisks/ubuntu-iso:24.04
               name: containerdisk
     ```

  10. Нажмите **Обновить**.

  11. Нажмите **Запустить**.

  ### Установка необходимого программного обеспечения и изменение конфигурации

  **Примечание**: следующие команды и конфигурационные файлы могут немного отличаться для различных операционных систем; пожалуйста, настройте в соответствии с вашей реальной средой.

  1. Введите свое имя пользователя и пароль для входа в операционную систему.

  2. Перейдите к привилегиям пользователя root.

  3. Установите пакеты программного обеспечения.

     - Для серии CentOS выполните команду:

       ```bash
       yum install cloud-utils cloud-init qemu-guest-agent vim
       ```

     - Для серии Debian выполните команду:

       ```bash
       apt install cloud-init cloud-guest-utils qemu-guest-agent vim
       ```

  4. Отредактируйте файл конфигурации SSHD.

     1. Выполните следующую команду, чтобы отредактировать файл sshd_config.

        ```bash
        vim /etc/ssh/sshd_config
        ```

     2. Добавьте следующие конфигурации.

        ```bash
        PermitRootLogin yes  # Разрешить пользователю root вход с паролем
        PubkeyAuthentication yes  # Разрешить вход по ключу
        ```

     3. Сохраните измененную конфигурацию.

  5. Выполните следующую команду, чтобы удалить пароль по умолчанию для пользователя root.

     ```bash
     passwd -d root
     ```

  6. Измените файл адресов источников.

     1. Выполните следующую команду, чтобы изменить файл адресов источников системы и заменить адрес на подходящий адрес зеркала.

        ```bash
        vim /etc/apt/sources.list.d/ubuntu.sources
        ```

     2. Сохраните конфигурацию после изменений.

  7. Измените конфигурацию cloud-init для автоматического расширения корневого каталога.

     1. Выполните следующую команду, чтобы отредактировать файл конфигурации cloud.cfg.

        ```bash
        vim /etc/cloud/cloud.cfg
        ```

     2. Добавьте следующее содержимое конфигурации.

        ```bash
        runcmd:
          - [growpart, /dev/vda, 1]  # Команда growpart используется для расширения раздела на диске, который расширит раздел /dev/vda1.
          - [xfs_growfs, /dev/vda1]  # Команда xfs_growfs используется для расширения файловой системы XFS, чтобы занять все доступное пространство на разделе. /dev/vda1 - это раздел, на котором находится расширяемая файловая система. После расширения раздела использование xfs_growfs гарантирует, что сама файловая система также расширяется до нового размера раздела.
        ```

     3. Сохраните конфигурацию после изменений.

  8. После завершения настройки, выключите операционную систему.

  ### Экспорт и использование пользовательского образа Linux

  Для конкретных операций, пожалуйста, обратитесь к [Экспорт изображения виртуальной машины](./vm_image_export.mdx).
</Steps>
