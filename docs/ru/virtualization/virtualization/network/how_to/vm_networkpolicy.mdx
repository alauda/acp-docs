---
weight: 10
sourceSHA: 91ed674e4f367ced5a3d22a9acecf0c49b8e1304894a39b4069ef8e0a183f72d
---

# Управление сетевыми запросами виртуальной машины с помощью сетевой политики

Решение виртуальной машины платформы реализовано на основе компонента с открытым исходным кодом KubeVirt, который фактически работает внутри Pods. Используя функциональность сетевых политик, можно контролировать входящие и исходящие запросы виртуальных машин.

## Процедура

1. Войдите в **Платформу контейнеров**.

2. В левом боковом меню нажмите **Сеть** > **Сетевые политики**.

3. Нажмите **Создать сетевую политику**.

4. При необходимости настройте следующие параметры.

   | Параметр               | Описание                                                                                                                                                                                                                                                 |
   |-----------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | **Метод ассоциации**  | <ul><li>**Компонент вычислений**: выберите целевой компонент вычислений по мере необходимости; рекомендуется выбрать **Все** в качестве целевого компонента вычислений.</li><li>**Выборщик меток**: сопоставьте Pods на основе их меток.</li></ul> |
   | **Направление**       | <ul><li>**Ingress**: Запросы, отправленные от внешнего к Pod.</li><li>**Egress**: Запросы, отправленные от Pod к внешнему; выберите этот вариант, если хотите запретить виртуальной машине отправлять запрос на определенный внешний адрес.</li></ul>    |
   | **Протокол**          | Выберите между TCP или UDP.<br /><br />**Примечание**: <ul><li>При использовании доменных имен в виртуальной машине для запроса внешних сервисов необходимо добавить белый список протокола UDP, так как протокол DNS использует UDP.</li><li>Форма не поддерживает настройку протокола ICMP; как только правила белого списка будут включены, протокол ICMP будет отключен, что приведет к невозможности выполнения операций Ping.</li></ul>        |
   | **Порты доступа**      | Укажите, какой трафик по портам может быть входящим или исходящим. Если это поле оставлено пустым, трафик через все порты будет разрешен по умолчанию.<br /><br />**Примечание**: Необходимо разрешить порты 1053 и 53 как для UDP, так и для TCP, чтобы разрешить исходящий трафик DNS; в противном случае разрешение доменных имен не будет выполнено.                                                                                                     |
   | **Удаленный тип**     | Укажите допустимые удаленные типы для доступа. Варианты включают: компонент вычислений, пространство имен и IP-сегменты.                                                                                                                                                                                                      |
   | **Исключить удаленный**| Когда удаленный тип **IP-сегмент**, уберите указанный IP из белого списка (т.е. запретить доступ). Один IP можно убрать, введя `IP/32`.<br /><br />**Примечание**: Это поле поддерживает только ввод IP-адресов; если соответствующий IP для доменного имени неясен, используйте команду `curl -vvv <domain>`, чтобы запросить домен и получить соответствующий IP-адрес из возвращенной информации.        |

5. Нажмите **Создать**.

## Проверка результата

В этом документе проверяется настройка с использованием виртуальной машины для доступа к [www.example.com](http://www.example.com).

### Шаг первый: Создание виртуальной машины и сетевой политики, позволяющей весь трафик через\{#one}

1. Создайте виртуальную машину, пожалуйста, обратитесь к [Создание виртуальной машины](../../virtual_machine/functions/create_virtual_machine.mdx) для получения подробных шагов.

2. Настройте сетевую политику в пространстве имен команды виртуальной машины, добавив правила белого списка как для протоколов TCP, так и для UDP, с следующими параметрами:

   - Белый список для протокола TCP:

     | Параметр                     | Описание                                                             |
     |------------------------------|---------------------------------------------------------------------|
     | **Метод ассоциации**         | Выберите **Компонент вычислений**.                                   |
     | **Целевой компонент вычислений** | Выберите **Все**.                                                  |
     | **Направление**              | Выберите **Исходящий**.                                             |
     | **Протокол**                 | Выберите **TCP**.                                                  |
     | **Удаленный тип**            | Выберите **IP-сегмент**                                            |
     | **Удаленный**                | Введите **0.0.0.0/0**, указывая, что разрешен исходящий трафик.   |

   - Правила белого списка для протокола UDP:

     | Параметр       | Описание                                                               |
     |----------------|-----------------------------------------------------------------------|
     | **Направление** | Выберите **Исходящий**.                                              |
     | **Протокол**    | Выберите **UDP**.                                                    |
     | **Удаленный тип** | Выберите **IP-сегмент**                                          |
     | **Удаленный**   | Введите **0.0.0.0/0**, указывая, что разрешен исходящий трафик.   |

3. После создания сетевой политики войдите в виртуальную машину и выполните следующую команду, чтобы запросить [www.example.com](http://www.example.com).

   ```
   curl www.example.com
   ```

4. Запрос выполнен успешно.

### Шаг второй: Обновить сетевую политику, чтобы удалить [www.example.com](http://www.example.com) из белого списка

1. Выполните следующую команду, чтобы получить IP-адрес для [www.example.com](http://www.example.com), в результате получите IP-адрес 93.184.215.14.

   ```bash
   curl -vvv www.example.com
   ```

2. Обновите сетевую политику, созданную в [шаге первом](#one), с следующими обновленными параметрами:

   | Параметр          | Описание                                                                                                                                                           |
   |------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | **Исключить удаленный** | В правилах белого списка протокола TCP заполните параметр исключения удаленного 93.184.215.14/32, указывая, что IP-адрес 93.184.215.14 удален из белого списка.  |

3. После обновления сетевой политики войдите в виртуальную машину и выполните следующую команду, чтобы запросить [www.example.com](http://www.example.com).

   ```bash
   curl www.example.com
   ```

4. Запрос завершился таймаутом, что указывает на эффект функции исключения удаленного доступа.
