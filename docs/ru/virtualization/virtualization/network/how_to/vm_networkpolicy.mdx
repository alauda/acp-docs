---
weight: 10
sourceSHA: 91ed674e4f367ced5a3d22a9acecf0c49b8e1304894a39b4069ef8e0a183f72d
---

# Управление сетевыми запросами виртуальной машины с помощью сетевой политики

Решение виртуальной машины платформы реализовано на основе компонента с открытым исходным кодом KubeVirt, который фактически работает внутри Pods. Используя функциональность сетевых политик, можно контролировать входящие и исходящие запросы виртуальных машин.

## Процедура

1. Войдите в **Container Platform**.

2. В левой навигационной панели нажмите **Сеть** > **Сетевые политики**.

3. Нажмите **Создать сетевую политику**.

4. Настройте следующие параметры по мере необходимости.

   | Параметр               | Описание                                                                                                                                                                                                                                                                                                                                                                                                                          |
   | ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Способ ассоциации**  | <ul><li>**Компонент вычислений**: Выберите целевой компонент вычислений по мере необходимости; рекомендуется выбирать **Все** в качестве целевого компонента вычислений.</li><li>**Селектор меток**: Соответствие Pods на основе их меток.</li></ul>                                                                                                                                                                                                        |
   | **Направление**        | <ul><li>**Ingress**: Запросы, отправляемые извне в Pod.</li><li>**Egress**: Запросы, отправляемые из Pod наружу; выберите этот вариант, если необходимо запретить виртуальной машине отправлять запросы на определенный внешний адрес.</li></ul>                                                                                                                                                                                      |
   | **Протокол**           | Выберите между TCP или UDP.<br /><br />**Примечание**: <ul><li>При использовании доменных имен в виртуальной машине для запроса внешних сервисов необходимо добавить в белый список протокол UDP, так как протокол DNS использует UDP.</li><li>Форма не поддерживает настройку протокола ICMP; как только правила белого списка будут активированы, протокол ICMP будет отключен, что приведет к невозможности выполнять операции Ping.</li></ul> |
   | **Порты доступа**      | Укажите, чей трафик может быть входящим или исходящим. Если это поле оставлено пустым, по умолчанию будет разрешен трафик через все порты.<br /><br />**Примечание**: Необходимо разрешить порты 1053 и 53 для протоколов UDP и TCP, чтобы разрешить исходящий трафик DNS; в противном случае разрешение доменных имен завершится неудачей.                                                                                                               |
   | **Тип удаленного**     | Укажите разрешенные удаленные типы для доступа. Опции включают: компонент вычислений, пространство имен и сегменты IP.                                                                                                                                                                                                                                                                                                           |
   | **Исключить удаленные** | Когда удаленный тип — это **Сегмент IP**, удалите указанный IP из белого списка (т.е. запретите доступ). Можно удалить отдельный IP, введя `IP/32`.<br /><br />**Примечание**: Это поле поддерживает только ввод IP-адресов; если соответствующий IP доменного имени неясен, используйте команду `curl -vvv <domain>`, чтобы запросить домен и получить соответствующий IP-адрес из возвращенной информации.                    |

5. Нажмите **Создать**.

## Проверка результата

В этом документе проверяется настройка с использованием виртуальной машины для доступа к [www.example.com](http://www.example.com).

### Шаг первый: Создание виртуальной машины и сетевой политики, позволяющей весь трафик\{#one}

1. Создайте виртуальную машину, пожалуйста, обратитесь к [Создание виртуальной машины](../../virtual_machine/functions/create_virtual_machine.mdx) для получения подробных шагов.

2. Настройте сетевую политику в пространстве имен команд виртуальной машины, добавив правила белого списка для протоколов TCP и UDP с следующими параметрами:

   - Правила белого списка для протокола TCP:

     | Параметр                    | Описание                                                                |
     | ---------------------------- | ------------------------------------------------------------------------ |
     | **Способ ассоциации**       | Выберите **Компонент вычислений**.                                     |
     | **Целевой компонент вычислений** | Выберите **Все**.                                                    |
     | **Направление**              | Выберите **Egress**.                                                  |
     | **Протокол**                 | Выберите **TCP**.                                                     |
     | **Тип удаленного**            | Выберите **Сегмент IP**                                              |
     | **Удаленный**                | Введите **0.0.0.0/0**, что указывает на то, что весь трафик разрешен для исходящего трафика. |

   - Правила белого списка для протокола UDP:

     | Параметр       | Описание                                                                |
     | --------------- | ------------------------------------------------------------------------ |
     | **Направление** | Выберите **Egress**.                                                  |
     | **Протокол**    | Выберите **UDP**.                                                     |
     | **Тип удаленного** | Выберите **Сегмент IP**                                            |
     | **Удаленный**   | Введите **0.0.0.0/0**, что указывает на то, что весь трафик разрешен для исходящего трафика. |

3. После создания сети политики войдите в виртуальную машину и выполните следующую команду, чтобы запросить [www.example.com](http://www.example.com).

   ```
   curl www.example.com
   ```

4. Запрос успешен.

### Шаг второй: Обновите сетевую политику, чтобы исключить [www.example.com](http://www.example.com) из белого списка

1. Выполните следующую команду, чтобы получить IP-адрес для [www.example.com](http://www.example.com), в результате чего получается IP-адрес 93.184.215.14.

   ```bash
   curl -vvv www.example.com
   ```

2. Обновите сетевую политику, созданную в [Шаге первом](#one), с следующими обновленными параметрами:

   | Параметр            | Описание                                                                                                                                                               |
   | ------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **Исключить удаленные** | В правилах белого списка протокола TCP заполните параметр исключения удаленных 93.184.215.14/32, что указывает на то, что IP-адрес 93.184.215.14 удален из белого списка. |

3. После обновления сетевой политики войдите в виртуальную машину и выполните следующую команду, чтобы запросить [www.example.com](http://www.example.com).

   ```bash
   curl www.example.com
   ```

4. Запрос истекает, что указывает на то, что функция исключения удаленных работает эффективно.
