---
weight: 15
sourceSHA: 026845935256b03aa3cb80c19ee84788500a3251afd6ac4b26ac7378c830fe7f
---

# Установка

Для того чтобы сотрудники проекта могли полностью использовать функции виртуализации на платформе контейнеров, администратор платформы должен выполнить следующие операции по подготовке среды виртуализации.

## Предварительные условия

- **Скачайте** пакет установки **ACP Virtualization with KubeVirt**, соответствующий архитектуре вашей платформы.
- **Загрузите** пакет установки **ACP Virtualization with KubeVirt** с помощью механизма загрузки пакетов.
- При использовании функций виртуализации необходимо заранее планировать и подготавливать сетевую и хранилищную инфраструктуру.

  **Примечание**:

  - Если вам нужно подключиться к виртуальной машине напрямую по IP, кластер должен использовать режим сети Kube-OVN Underlay. Вы можете ознакомиться с лучшими практиками [Подготовка физической сети Kube-OVN Underlay](/configure/networking/how_to/kubeovn_underlay_py.mdx).
  - Рекомендуется использовать TopoLVM в сочетании с Kubevirt, так как это может обеспечить производительность на уровне аппаратного обеспечения. Если требования к производительности не высоки, также можно использовать распределенное хранилище Ceph.

    | Продукт хранения              | Описание                                                                                                                                                                     |
    | ----------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | **TopoLVM**                   | **Преимущества**: Относительно легкий и хорошая производительность.<br />**Недостатки**: Не может использоваться между узлами, имеет низкую надежность и не может обеспечить избыточность. |
    | **Распределенное хранилище Ceph** | **Преимущества**: Может использоваться между узлами, высокая доступность и наличие избыточности.<br />**Недостатки**: Избыточные копии дисков приводят к более низкой загрузке; производительность хуже. |

    - Если используется TopoLVM и настроено несколько дисков, пожалуйста, убедитесь, что оставшаяся емкость на узлах, поддерживающих виртуализацию, соответствует общей емкости нескольких дисков; в противном случае создание виртуальной машины завершится неудачно.

    - Если используется распределенное хранилище Ceph, убедитесь, что сеть, в которой находится хранилище, и сеть, в которой находятся виртуальные машины, могут обмениваться данными.

## Процедура

<Steps>
  ### Включение виртуализации на узле

  Когда узлы самостоятельно созданного кластера являются **физическими машинами**, вы можете контролировать, разрешено ли Kubernetes планировать экземпляры виртуальных машин (VMI) на этом узле, включив или отключив переключатель виртуализации узла.

  - Когда переключатель включен, новые виртуальные машины могут планироваться на физическом узле; узлы с Windows не поддерживают включение виртуализации.

  - Когда переключатель выключен, новые виртуальные машины не могут быть запланированы на физическом узле, но это не влияет на уже работающие виртуальные машины на этом узле.

  #### Процедура

  1. Войдите в **Управление платформой**.

  2. В левом навигационном меню щелкните **Управление кластерами** > **Кластеры**.

  3. Щелкните ***Имя самостоятельно созданного кластера***.

  4. На вкладке **Узлы** щелкните ⋮ справа от узла, для которого вы хотите установить переключатель виртуализации > **Включить виртуализацию**.

  5. Щелкните **Подтвердить**.

  ### Развертывание оператора

  1. Войдите в систему, перейдите на страницу **Управление платформой**.

  2. Щелкните **Маркетплейс** > **OperatorHub**, чтобы зайти на страницу **OperatorHub**.

  3. Найдите **ACP Virtualization with KubeVirt**, щелкните **Установить** и перейдите на страницу **Установка ACP Virtualization with KubeVirt**.

     Параметры конфигурации:

     | **Параметр**          | **Рекомендованная конфигурация**                                                                                                             |
     | :--------------------- | :---------------------------------------------------------------------------------------------------------------------------------------- |
     | **Канал**            | По умолчанию канал `alpha`.                                                                                                           |
     | **Режим установки**  | `Кластер`: Все пространства имен в кластере делят один экземпляр Оператора для создания и управления, что приводит к снижению использования ресурсов. |
     | **Место установки** | Выберите `Рекомендуемое`, пространство имен поддерживает только **kubevirt**.                                                                                |
     | **Стратегия обновления**   | `Ручное`: Когда в Hub оператора появляется новая версия, требуется ручное подтверждение для обновления оператора до последней версии. |

  ### Создание экземпляра HyperConverged

  1. Войдите в **Управление платформой**.

  2. Щелкните **Маркетплейс** > **OperatorHub**.

  3. Найдите **ACP Virtualization with KubeVirt**, щелкните его, чтобы перейти на страницу сведений о **ACP Virtualization with KubeVirt**.

  4. Щелкните **Все экземпляры**

  5. Щелкните **Создать экземпляр** на карточке экземпляра **HyperConverged**.

     **Примечание**: В каждом кластере необходимо создать только один экземпляр **HyperConverged**.

  6. Переключитесь на представление YAML и замените только ***заполнитель***, указанный в поле `spec.storageImport.insecureRegistries`, на правильный **адрес репозитория образов виртуальной машины**, например: `192.168.16.214:60080`, оставив другие параметры на значениях по умолчанию.

     ```yaml
     spec:
       storageImport:
         insecureRegistries:
         - placeholder
     ```

     Результат замены:

     ```yaml
     spec:
       storageImport:
         insecureRegistries:
         - "192.168.16.214:60080"
     ```

  7. Щелкните **Создать** и дождитесь автоматического создания экземпляров типов CDI и KubeVirt в списке ресурсов, при этом убедитесь, что реализованный **status.phase** в YAML равен `deployed`, что указывает на успешное создание экземпляра HyperConverged.

  ### Настройка коэффициента превышения виртуальной машины (по желанию)

  - Настройка коэффициента превышения для кластера, в котором находятся виртуальные машины в **Управление кластерами** > **Кластеры**.
  - Или настройка коэффициента превышения для пространства имен, в котором расположены виртуальные машины, в **Управление проектами** > **Пространства имен**.

  #### Важные примечания

  - Виртуальные машины поддерживают только коэффициенты превышения ЦП, и рекомендованное значение конфигурации находится в диапазоне от 2 до 4.

  - После включения коэффициента превышения для виртуальных машин, при создании виртуальной машины запрашиваемое пользователем значение контейнера (requests) фиксируется как **указанное ограничение (limits) / коэффициент превышения ВМ**, что делает запрос пользователя, установленный через YAML, неэффективным.

    Например: Предположим, что коэффициент превышения ресурсов ЦП установлен на 4 для виртуальной машины, если пользователь указывает значение ограничения ЦП в 4c при создании виртуальной машины, то запрашиваемое значение ЦП будет 4c/4 = 1c.

  {/* ### Шаги

  1. Войдите в **Управление платформой**.

  2. В левом навигационном меню щелкните **Управление приложениями** > **Операторы**.

  3. На вкладке **Развернутые операторы** щелкните **kubevirt-operator**.

  4. Щелкните на вкладке **Экземпляры ресурсов**, обновите экземпляр ресурса **kubevirt-hyperconverged**, переключитесь на представление YAML и добавьте следующее поле в разделе **annotations**:

     ```
     kubevirt.kubevirt.io/jsonpatch: |-
       [
         {
           "op": "add",
           "path": "/spec/configuration/developerConfiguration",
           "value": {"cpuAllocationRatio": 4}  # В этом примере коэффициент превышения ЦП установлен на 4
         }
       ]
     ```

  5. Щелкните **Обновить**. */}
</Steps>

## Объяснение квоты ресурсов

Квота ресурсов памяти для виртуальных машин ограничена квотой ресурсов памяти пространства имен, в котором они находятся. Поскольку память Pod, размещающего виртуальную машину, обычно больше, чем фактически доступная память виртуальной машины, рекомендуется резервировать 20% ресурсов. Когда оставшиеся доступные ресурсы в пространстве имен опускаются ниже 20%, необходимо срочно увеличить ресурсы.
