---
weight: 15
sourceSHA: 026845935256b03aa3cb80c19ee84788500a3251afd6ac4b26ac7378c830fe7f
---

# Установка

Для того чтобы сотрудники проекта в полной мере могли использовать возможности виртуализации в рамках контейнерной платформы, администратору платформы необходимо выполнить следующие операции для подготовки виртуализированной среды.

## Предварительные условия

- **Скачайте** пакет установки **ACP Virtualization with KubeVirt**, соответствующий архитектуре вашей платформы.
- **Загрузите** пакет установки **ACP Virtualization with KubeVirt** с помощью механизма загрузки пакетов.
- При использовании функций виртуализации необходимо заранее спланировать и подготовить сети и среды хранения.

  **Примечание**:

  - Если вам нужно подключиться к виртуальной машине напрямую по IP, кластер должен использовать режим сети Kube-OVN Underlay. Вы можете ознакомиться с лучшими практиками [Подготовка физической сети Kube-OVN Underlay](/configure/networking/how_to/kubeovn_underlay_py.mdx).
  - Рекомендуется использовать TopoLVM в сочетании с KubeVirt, так как это может обеспечить производительность, близкую к аппаратной. Если требования к производительности не высоки, можно также использовать распределенное хранилище Ceph.

    | Хранилище                  | Описание                                                                                                                                                                      |
    | -------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | **TopoLVM**                | **Преимущества**: Относительно легковесное и хорошая производительность.<br />**Недостатки**: Не может использоваться между узлами, имеет низкую надежность и не может обеспечить избыточность.           |
    | **Распределенное хранилище Ceph** | **Преимущества**: Может использоваться между узлами, высокодоступное и имеет избыточность.<br />**Недостатки**: Избыточные копии дисков ведут к более низкой коэффициенту использования; производительность хуже. |

    - Если используется TopoLVM и настроено несколько дисков, пожалуйста, убедитесь, что оставшаяся емкость хранения на узлах с поддержкой виртуализации может удовлетворять общую емкость нескольких дисков; в противном случае создание виртуальной машины завершится неудачей.

    - Если используется распределенное хранилище Ceph, пожалуйста, убедитесь, что сеть, в которой располагается хранилище, и сеть, в которой располагаются виртуальные машины, могут связываться друг с другом.

## Процедура

<Steps>
  ### Включение виртуализации узлов

  Когда узлы саморазвернутого кластера являются **физическими машинами**, вы можете управлять тем, разрешить ли Kubernetes планировать экземпляры виртуальных машин (VMI) на этом узле, включив или отключив переключатель виртуализации узла.

  - Когда переключатель включен, новые виртуальные машины могут быть запланированы на узле физической машины; физические узлы Windows не поддерживают включение виртуализации.

  - Когда переключатель отключен, новые виртуальные машины не могут быть запланированы на узле физической машины, но это не влияет на виртуальные машины, которые уже работают на этом узле.

  #### Процедура

  1. Перейдите в **Управление платформой**.

  2. В левом навигационном меню выберите **Управление кластером** > **Кластеры**.

  3. Нажмите на ***Имя саморазвернутого кластера***.

  4. На вкладке **Узлы** нажмите ⋮ справа от узла, для которого вы хотите установить переключатель виртуализации > **Включить виртуализацию**.

  5. Нажмите **Подтвердить**.

  ### Развертывание оператора

  1. Войдите в систему, перейдите на страницу **Управление платформой**.

  2. Нажмите **Маркетплейс** > **OperatorHub**, чтобы войти на страницу **OperatorHub**.

  3. Найдите **ACP Virtualization with KubeVirt**, нажмите **Установить** и перейдите на страницу **Установка ACP Virtualization with KubeVirt**.

     Параметры конфигурации:

     | **Параметр**            | **Рекомендуемая конфигурация**                                                                                                             |
     | :----------------------- | :---------------------------------------------------------------------------------------------------------------------------------------- |
     | **Канал**                | Канал по умолчанию `alpha`.                                                                                                           |
     | **Режим установки**      | `Cluster`: Все пространства имен в кластере используют один экземпляр оператора для создания и управления, что снижает использование ресурсов. |
     | **Место установки**      | Выберите `Рекомендуемое`, пространство имен поддерживает только **kubevirt**.                                                                                |
     | **Стратегия обновления** | `Manual`: Когда в Operator Hub появляется новая версия, требуется ручное подтверждение для обновления оператора до последней версии. |

  ### Создание экземпляра HyperConverged

  1. Перейдите в **Управление платформой**.

  2. Нажмите **Маркетплейс** > **OperatorHub**.

  3. Найдите **ACP Virtualization with KubeVirt**, нажмите на него, чтобы перейти на страницу подробной информации о **ACP Virtualization with KubeVirt**.

  4. Нажмите **Все экземпляры**

  5. Нажмите **Создать экземпляр** на карточке экземпляра **HyperConverged**.

     **Примечание**: В каждом кластере необходимо создать только один экземпляр **HyperConverged**.

  6. Переключитесь на представление YAML и замените только ***placeholder***, указанный в поле `spec.storageImport.insecureRegistries` в примере, на правильный **адрес репозитория образов виртуальных машин**, например: `192.168.16.214:60080`, оставив другие параметры на значениях по умолчанию.

     ```yaml
     spec:
       storageImport:
         insecureRegistries:
         - placeholder
     ```

     Результат замены:

     ```yaml
     spec:
       storageImport:
         insecureRegistries:
         - "192.168.16.214:60080"
     ```

  7. Нажмите **Создать** и дождитесь автоматического создания экземпляров типа CDI и KubeVirt в списке ресурсов, при этом убедитесь, что **status.phase** в YAML отображает значение `deployed`, что означает, что экземпляр HyperConverged был успешно создан.

  ### Настройка коэффициента перерасхода виртуальных машин (по желанию)

  - Настройка коэффициента перерасхода для кластера, где располагаются виртуальные машины, в **Управлении кластером** > **Кластеры**.
  - Или настройка коэффициента перерасхода для пространства имен, в котором находятся виртуальные машины, в **Управлении проектами** > **Пространства имен**.

  #### Важные примечания

  - Виртуальные машины поддерживают только коэффициенты перерасхода ЦП, и рекомендуемое значение конфигурации находится в диапазоне от 2 до 4.

  - После активации коэффициента перерасхода для виртуальных машин, при создании виртуальной машины запрашиваемое значение контейнера (requests) фиксируется как **указанное значение предела (limits) / коэффициент перерасхода виртуальных машин**, что делает пользовательский запрос, установленный через YAML, неэффективным.

    Например: Предположим, коэффициент перерасхода ресурсов ЦП установлен на 4 для виртуальной машины, если пользователь указывает предельное значение ЦП 4c при создании виртуальной машины, запрос на ЦП составит 4c/4 = 1c.

  {/* ### Шаги

  1. Перейдите в **Управление платформой**.

  2. В левом навигационном меню выберите **Управление приложениями** > **Операторы**.

  3. На вкладке **Развернутые операторы** нажмите **kubevirt-operator**.

  4. Нажмите на вкладку **Ресурсные экземпляры**, обновите ресурсный экземпляр **kubevirt-hyperconverged**, переключитесь на представление YAML и добавьте следующее поле в раздел **annotations**:

     ```
     kubevirt.kubevirt.io/jsonpatch: |-
       [
         {
           "op": "add",
           "path": "/spec/configuration/developerConfiguration",
           "value": {"cpuAllocationRatio": 4}  # В этом примере коэффициент перерасхода ЦП установлен на 4
         }
       ]
     ```

  5. Нажмите **Обновить**. */}
</Steps>

## Объяснение квоты ресурсов

Квота ресурсов памяти для виртуальных машин ограничена квотой ресурсов памяти пространства имен, в котором они располагаются. Поскольку память Pods, в которых размещается виртуальная машина, обычно больше фактической доступной памяти виртуальной машины, рекомендуется резервировать 20% ресурсов. Когда оставшиеся доступные ресурсы в пространстве имен становятся ниже 20%, пожалуйста, незамедлительно увеличьте ресурсы.
