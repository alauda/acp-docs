---
weight: 40
sourceSHA: 326707fd138ca032ceab4f80a848be8f17660038ca716b212baea868eadbac91
---

# Восстановление виртуальной машины

В некоторых сценариях, таких как неправильные изменения в fstab или ошибки файловой системы, требующие fsck, виртуальные машины могут не запускаться должным образом. В таких случаях вы можете использовать режим восстановления для ремонта корневой файловой системы (rootfs) или извлечения данных из системы.

## Шаги для выполнения

### Получение адреса образа\{#getimage}

1. В левой панели навигации нажмите **Управление виртуализацией** > **Образы виртуальных машин**.

2. Выберите предоставленный платформой **Источник** как **Репозиторий образов**, а **Операционную систему** как **CentOS или Ubuntu**. Нажмите ⋮ > **Обновить** справа.

3. Скопируйте и сохраните **Адрес образа**. В этом документе используется `192.168.1.1:11443/3rdparty/vmdisks/centos:7.9` в качестве примера.

4. Нажмите **Отмена**.

### Изменение файла YAML виртуальной машины\{#vmyaml}

1. Получите доступ к **Платформе контейнеров**.

2. В левой панели навигации нажмите **Виртуализация** > **Виртуальные машины**.

3. Нажмите ⋮ > **Стоп** рядом с виртуальной машиной, которую необходимо отремонтировать, чтобы **Остановить** или **Принудительно остановить** её.

4. Нажмите ⋮ > **Обновить** рядом с виртуальной машиной.

5. Переключитесь на **YAML** и измените следующие поля.

   - Добавьте следующий контент под `spec.template.spec.domain.devices.disks`. Добавление параметра bootOrder позволяет контролировать, какой диск имеет приоритет во время процесса загрузки виртуальной машины; более низкое значение bootOrder означает более высокий приоритет.

     **Примечание**: Если исходное поле `spec.template.spec.domain.devices.disks` содержит `bootOrder: 1`, увеличьте первоначальное значение, чтобы ново добавленное значение bootOrder было ниже оригинала.

     ```
     disks:
       - bootOrder: 1
         disk:
           bus: virtio
         name: containerdisk
     ```

     Пример измененного YAML:

     ```
     domain:
       devices:
         disks:
           - bootOrder: 1  # Добавлено поле
             disk:
               bus: virtio
             name: containerdisk
           - disk:
               bus: virtio
             name: cloudinitdisk
           - disk:      # Увеличьте оригинальное bootOrder: 1 значение
               bus: virtio
             name: rootfs
             bootOrder: 10
           - disk:
               bus: virtio
             name: "1"
     ```

   - Добавьте следующий контент под `spec.template.spec.volumes`.

     **Примечание**: Пожалуйста, замените адрес образа в следующем поле `image` на полученный из [Получение адреса образа](#getimage).

     ```
     - containerDisk:
         image: 192.168.1.1:11443/3rdparty/vmdisks/centos:7.9
       name: containerdisk
     ```

     Пример измененного YAML:

     ```
     volumes:
       - containerDisk:  # Добавлено поле
           image: 192.168.1.1:11443/3rdparty/vmdisks/centos:7.9
         name: containerdisk
       - dataVolume:
           name: k2-rootfs
         name: rootfs
       - dataVolume:
           name: k2-1
         name: "1"
     ```

6. Нажмите **Обновить**.

   **Примечание**: После изменения файла YAML не переключайтесь на **Форму**, просто нажмите **Обновить** напрямую.

7. Нажмите ⋮ > **Запустить** рядом с виртуальной машиной.

### Смонтируйте оригинальный rootfs и выполните ремонт

1. Войдите в виртуальную машину, используя оригинальный пароль или ключ, и введите команду `df -h /`, чтобы выяснить, что файловая система rootfs была заменена. Вы можете использовать команды, связанные с монтированием, или команды fsck для проверки и ремонта оригинальной файловой системы.

2. После завершения выключите виртуальную машину.

### Восстановление файла YAML виртуальной машины

Следуйте шагам в [Изменение файла YAML виртуальной машины](#vmyaml), чтобы восстановить файл YAML виртуальной машины в его оригинальное состояние. На этом этапе виртуальная машина может запускаться нормально.
