---
weight: 20
i18n:
  title:
    en: Argo CD Troubleshooting
    zh: Argo CD 故障排查
title: Argo CD Устранение неполадок
sourceSHA: f540c9881cee23d077c230cbd3a03d85ddcbff9726745cb4e4b959fb078806d3
---

# Argo CD Устранение неполадок

## Я удалил/повредил свой репозиторий и не могу удалить свое приложение?

Argo CD не может удалить приложение, если не может сгенерировать манифесты. Вам необходимо либо:

1. Восстановить/исправить ваш репозиторий.
2. Удалить приложение, используя `--cascade=false`, а затем вручную удалить ресурсы.

## Почему мое приложение все еще `OutOfSync` сразу после успешной синхронизации??

См. [Документацию по различиям](https://argo-cd.readthedocs.io/en/stable/user-guide/diff-strategies/) для обнаружения причин, по которым ресурсы могут быть OutOfSync, и способов настроить Argo CD, чтобы игнорировать поля, когда различия ожидаемы.

## Почему мое приложение зависло в состоянии `Progressing`?

Argo CD предоставляет состояние здоровья для нескольких стандартных типов Kubernetes. Типы `Ingress`, `StatefulSet` и `SealedSecret` имеют известные проблемы, которые могут вызвать возврат состояния `Progressing` вместо `Healthy`.

- `Ingress` считается здоровым, если список status.loadBalancer.ingress не пустой и содержит хотя бы одно значение для `hostname` или `IP`. Некоторые контроллеры ingress (contour, traefik) не обновляют поле `status.loadBalancer.ingress`, что приводит к тому, что `Ingress` застревает в состоянии `Progressing` навсегда.

- `StatefulSet` считается здоровым, если значение поля `status.updatedReplicas` совпадает со значением поля `spec.replicas`. Из-за ошибки Kubernetes [kubernetes#68573](https://github.com/kubernetes/kubernetes/issues/68573) поле status.updatedReplicas не заполняется. Поэтому, если вы не используете версию Kubernetes, которая включает исправление [kubernetes#67570](https://github.com/kubernetes/kubernetes/pull/67570), StatefulSet может оставаться в состоянии Progressing.

- Ваш `StatefulSet` или `DaemonSet` использует стратегию `OnDelete`, а не `RollingUpdate`.

- Для `SealedSecret` см. [Почему ресурсы типа `SealedSecret` застревают в состоянии `Progressing`?](#sealedsecret)

В качестве обходного пути Argo CD позволяет предоставить пользовательскую [проверку здоровья](https://argo-cd.readthedocs.io/en/stable/operator-manual/health/), которая переопределяет поведение по умолчанию.

Если вы используете Traefik для вашего Ingress, вы можете обновить конфигурацию Traefik для публикации IP-адреса loadBalancer, используя [publishedservice](https://doc.traefik.io/traefik/providers/kubernetes-ingress/#publishedservice), что решит эту проблему.

```yaml
providers:
  kubernetesIngress:
    publishedService:
      enabled: true
```

## Как отключить пользователя администратора?

Добавьте `admin.enabled: "false"` в ConfigMap `argocd-cm`.

## Argo CD не может развернуть приложения, основанные на Helm Chart, без доступа в интернет. Как я могу это исправить?

Argo CD может не сгенерировать манифесты Helm chart, если у chart есть зависимости, расположенные во внешних репозиториях. Чтобы решить эту проблему, убедитесь, что `requirements.yaml` использует только внутренние репозитории Helm. Даже если chart использует только зависимости из внутренних репозиториев, Helm может решить обновить репозиторий `stable`. В качестве обходного пути переопределите URL-адрес репозитория `stable` в конфигурационной карте `argocd-cm`:

```yaml
data:
  repositories: |
    - type: helm
      url: http://<internal-helm-repo-host>:8080
      name: stable
```

## После создания моего Helm-приложения с помощью Argo CD я не могу увидеть его с помощью helm ls и других команд Helm?

При развертывании Helm-приложения Argo CD использует Helm только как механизм шаблонов. Он выполняет команду `helm template`, а затем развертывает полученные манифесты на кластере вместо выполнения `helm install`. Это означает, что вы не можете использовать никакие команды Helm для просмотра/проверки приложения. Оно полностью управляется Argo CD. Обратите внимание, что Argo CD нативно поддерживает некоторые возможности, которые вы можете не обнаружить в Helm (такие как команды истории и отката).

Это решение было принято, чтобы Argo CD был нейтральным ко всем генераторам манифестов.

## Я настроил кластерный секрет, но он не отображается в CLI/UI. Как мне это исправить?

Проверьте, есть ли у кластерного секрета метка `argocd.argoproj.io/secret-type: cluster`. Если секрет имеет метку, но кластер все равно не виден, это может быть проблемой с правами доступа. Попробуйте выполнить перечисление кластеров, используя пользователя `admin` (например: `argocd login --username admin && argocd cluster list`).

Проверьте, есть ли у кластерного секрета метка `argocd.argoproj.io/secret-type: cluster`. Если секрет имеет метку, но кластер все равно не виден, то убедитесь, что это может быть проблема с правами. Попробуйте перечислить кластеры, используя пользователя `admin` (например, `argocd login --username admin && argocd cluster list`).

## Почему мое приложение Out Of Sync, даже после синхронизации?

В некоторых случаях инструмент, который вы используете, может конфликтовать с Argo CD, добавляя метку `app.kubernetes.io/instance`. Например, используя функцию общих меток Kustomize.

Argo CD автоматически устанавливает метку `app.kubernetes.io/instance` и использует ее для определения, какие ресурсы формируют приложение. Если инструмент делает это тоже, это вызывает путаницу. Вы можете изменить эту метку, установив значение application.instanceLabelKey в `argocd-cm`. Мы рекомендуем использовать `argocd.argoproj.io/instance`.

:::info
Когда вы вносите это изменение, ваши приложения станут несинхронизированными и потребуют повторной синхронизации.
:::

## Как часто Argo CD проверяет изменения в моем Git или Helm репозитории?

Интервал опроса по умолчанию составляет 3 минуты (180 секунд) с настраиваемым джиттером. Вы можете изменить настройки, обновив значение `timeout.reconciliation` и `timeout.reconciliation.jitter` в конфигурационной карте `argocd-cm`. Если в Git произошли изменения, Argo CD будет обновлять только приложения с включенной настройкой `auto-sync`. Если вы установите его на 0, Argo CD остановит автоматическое опрос репозиториев Git, и вы сможете использовать только альтернативные методы, такие как `webhooks` и/или `ручные синхронизации`, для создания приложений.

## Как я могу исправить ошибку некорректного cookie, превышающего максимальную длину 4093?

Argo CD использует JWT в качестве токена аутентификации. Вы, вероятно, являетесь частью многих групп и превысили предел в 4 КБ, установленный для cookie. Вы можете получить список групп, открыв "инструменты разработчика -> сеть":

1. Нажмите на вход в панель управления Argo CD [Как получить информацию о доступе к Argo CD](./../how_to/argocd_info.mdx)
2. Найдите запрос к `<argocd_instance>/auth/callback?code=<random_string>`

Декодируйте токен на [jwt.io](https://jwt.io/). Это даст вам список команд, из которых вы можете удалить себя.

## Почему я получаю ошибку rpc: code = Unavailable desc = transport is closing при использовании CLI?

Может быть, вы находитесь за прокси, который не поддерживает HTTP 2? Попробуйте флаг `--grpc-web`:

```bash
argocd ... --grpc-web
```

## Почему ресурсы типа SealedSecret застревают в состоянии Progressing?<a id="sealedsecret" />

Контроллер ресурса `SealedSecret` может предоставлять условие состояния для ресурса, который он создал. Начиная с версии `v2.0.0`, Argo CD использует это состояние, чтобы определить состояние здоровья для `SealedSecret`.

Версии до `v0.15.0` контроллера `SealedSecret` подвержены проблеме с обновлением условий состояния, поэтому эта функция по умолчанию отключена в этих версиях. Обновления условий состояния могут быть включены, запустив контроллер `SealedSecret` с параметром командной строки `--update-status` или установив переменную окружения `SEALED_SECRETS_UPDATE_STATUS`.

Чтобы отключить Argo CD от проверки условия состояния ресурсов `SealedSecret`, добавьте следующую настройку ресурса в вашу конфигурационную карту `argocd-cm` через ключ `resource.customizations.health.<group_kind>`.

:::yaml
resource.customizations.health.bitnami.com\_SealedSecret: |
hs = {}
hs.status = "Healthy"
hs.message = "Контроллер не сообщает о состоянии ресурса"
return hs
:::

## Как вращать ключи Redis?

- Удалите секрет `argocd-redis` в пространстве имен, где установлен Argo CD.

```bash
kubectl delete secret argocd-redis -n <argocd namesapce>
```

- Если вы запускаете Redis в режиме HA, перезапустите Redis в HA.

```bash
kubectl rollout restart deployment argocd-redis-ha-haproxy
kubectl rollout restart statefulset argocd-redis-ha-server
```

- Если вы запускаете Redis в режиме не-HA, перезапустите Redis.

```bash
kubectl rollout restart deployment argocd-redis
```

4. Перезапустите другие компоненты.

```bash
kubectl rollout restart deployment argocd-server argocd-repo-server
kubectl rollout restart statefulset argocd-application-controller
```

## Как я могу исправить ошибку генерации манифеста (кэшированная)?

`Ошибка генерации манифеста (кэшированная)` означает, что произошла ошибка при генерации манифестов, и сообщение об ошибке было кэшировано, чтобы избежать бесконечных повторных попыток.

Жесткое обновление (игнорируя кэшированную ошибку) может решить временные проблемы. Но если есть причина, по которой генерация манифеста не удается, жесткое обновление не поможет.

Вместо этого попробуйте поискать в логах repo-server имя приложения для выявления ошибки, которая вызывает сбой генерации манифеста.
