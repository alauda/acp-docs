---
weight: 80
i18n:
  title:
    en: Устранение неполадок
    zh: 故障排查
sourceSHA: 5f23ef8a9e03040966c726d151ca2d57685f306f24c0d9242fa02104d46c033d
---

# Устранение неполадок

### Я удалил/повредил свой репозиторий и не могу удалить свое приложение?

Argo CD не может удалить приложение, если не может сгенерировать манифесты. Вам нужно:

1. Восстановить/исправить ваш репозиторий.
2. Удалить приложение с помощью `--cascade=false`, а затем вручную удалить ресурсы.

### Почему мое приложение все еще `OutOfSync` сразу после успешной синхронизации?

Смотрите [Документацию по различиям](https://argo-cd.readthedocs.io/en/stable/user-guide/diff-strategies/) для причин, по которым ресурсы могут быть OutOfSync, и способов настройки Argo CD для игнорирования полей, когда ожидаются различия.

### Почему мое приложение застряло в состоянии `Progressing`?

Argo CD предоставляет информацию о состоянии для нескольких стандартных типов Kubernetes. Типы `Ingress`, `StatefulSet` и `SealedSecret` имеют известные проблемы, которые могут привести к тому, что проверка состояния вернет состояние `Progressing` вместо `Healthy`.

- `Ingress` считается здоровым, если список status.loadBalancer.ingress не пуст, с по крайней мере одним значением для `hostname` или `IP`. Некоторые контроллеры входа (contour, traefik) не обновляют поле `status.loadBalancer.ingress`, что приводит к тому, что `Ingress` застревает в состоянии `Progressing` навсегда.

- `StatefulSet` считается здоровым, если значение поля `status.updatedReplicas` соответствует полю `spec.replicas`. Из-за ошибки Kubernetes [kubernetes#68573](https://github.com/kubernetes/kubernetes/issues/68573) поле status.updatedReplicas не заполняется. Поэтому, если вы не используете версию Kubernetes, которая включает исправление [kubernetes#67570](https://github.com/kubernetes/kubernetes/pull/67570), StatefulSet может оставаться в состоянии Progressing.

- Ваш `StatefulSet` или `DaemonSet` использует стратегию `OnDelete` вместо `RollingUpdate`.

- Для `SealedSecret` смотрите [Почему ресурсы типа `SealedSecret` застряли в состоянии `Progressing`?](#sealedsecret)

В качестве обходного пути Argo CD позволяет предоставлять [проверку состояния](https://argo-cd.readthedocs.io/en/stable/operator-manual/health/) с пользовательскими настройками, которые переопределяют поведение по умолчанию.

Если вы используете Traefik для вашего Ingress, вы можете обновить конфигурацию Traefik, чтобы опубликовать IP-адрес loadBalancer, используя [publishedservice](https://doc.traefik.io/traefik/providers/kubernetes-ingress/#publishedservice), что решит эту проблему.

```yaml
providers:
  kubernetesIngress:
    publishedService:
      enabled: true
```

### Как отключить пользователя admin?

Добавьте `admin.enabled: "false"` в ConfigMap `argocd-cm`.

### Argo CD не может развернуть приложения на основе Helm Chart без доступа в интернет, как я могу это решить?

Argo CD может не сгенерировать манифесты Helm chart, если у chart есть зависимости, расположенные во внешних репозиториях. Чтобы решить проблему, вам нужно убедиться, что `requirements.yaml` использует только внутренние репозитории Helm. Даже если chart использует только зависимости из внутренних репозиториев, Helm может решить обновить репозиторий `stable`. В качестве обходного пути переопределите URL-адрес репозитория `stable` в ConfigMap `argocd-cm`:

```yaml
data:
  repositories: |
    - type: helm
      url: http://<internal-helm-repo-host>:8080
      name: stable
```

### После создания моего приложения Helm с Argo CD я не могу увидеть его с помощью helm ls и других команд Helm?

При развертывании приложения Helm Argo CD использует Helm только как механизм шаблонов. Он выполняет `helm template`, а затем развертывает полученные манифесты в кластере вместо выполнения `helm install`. Это означает, что вы не можете использовать любую команду Helm для просмотра/проверки приложения. Оно полностью управляется Argo CD. Обратите внимание, что Argo CD нативно поддерживает некоторые возможности, которые могут отсутствовать в Helm (такие как команды истории и отката).

Это решение было принято, чтобы Argo CD был нейтрален ко всем генераторам манифестов.

### Я настроил кластерный секрет, но он не отображается в CLI/UI, как я могу это исправить?

Проверьте, имеет ли кластерный секрет метку `argocd.argoproj.io/secret-type: cluster`. Если секрет имеет метку, но кластер все еще не виден, это может быть проблемой с разрешениями. Попробуйте перечислить кластеры, используя пользователя `admin` (например: `argocd login --username admin && argocd cluster list`).

Проверьте, имеет ли кластерный секрет метку `argocd.argoproj.io/secret-type: cluster`. Если секрет имеет метку, но кластер все еще не виден, убедитесь, что это может быть проблемой с разрешениями. Попробуйте перечислить кластеры, используя пользователя `admin` (например: `argocd login --username admin && argocd cluster list`).

### Почему мое приложение Out Of Sync даже после синхронизации?

В некоторых случаях инструмент, который вы используете, может конфликтовать с Argo CD, добавляя метку `app.kubernetes.io/instance`. Например, используя общую функцию меток Kustomize.

Argo CD автоматически устанавливает метку `app.kubernetes.io/instance` и использует ее для определения того, какие ресурсы формируют приложение. Если инструмент делает это тоже, это вызывает путаницу. Вы можете изменить эту метку, установив значение application.instanceLabelKey в `argocd-cm`. Мы рекомендуем использовать `argocd.argoproj.io/instance`.

:::info
Когда вы вносите это изменение, ваши приложения станут Out of sync и потребуют повторной синхронизации.
:::

### Как часто Argo CD проверяет изменения в моем Git или Helm репозитории?

Интервал опроса по умолчанию составляет 3 минуты (180 секунд) с настраиваемым джиттером. Вы можете изменить настройку, обновив значение `timeout.reconciliation` и `timeout.reconciliation.jitter` в ConfigMap `argocd-cm`. Если есть какие-либо изменения в Git, Argo CD будет обновлять только приложения с включенной настройкой `auto-sync`. Если вы установите его в 0, Argo CD прекратит автоматическое опрос Git-репозиториев, и вы сможете использовать только альтернативные методы, такие как `webhooks` и/или `manual syncs` для создания приложений.

### Как я могу исправить ошибку генерации cookie, превышающую максимальную длину 4093?

Argo CD использует JWT в качестве токена аутентификации. Вы, вероятно, являетесь частью многих групп и превысили лимит в 4 КБ, установленный для cookie. Вы можете получить список групп, открыв "инструменты разработчика -> сеть":

1. Нажмите на вход в панель управления Argo CD [Как получить информацию о доступе к Argo CD](./how_to/argocd_info.mdx)
2. Найдите вызов к `<argocd_instance>/auth/callback?code=<random_string>`

Декодируйте токен на [jwt.io](https://jwt.io/). Это предоставит список команд, из которых вы можете удалить себя.

### Почему я получаю rpc error: code = Unavailable desc = transport is closing при использовании CLI?

Возможно, вы находитесь за прокси, который не поддерживает HTTP 2? Попробуйте флаг `--grpc-web`:

```bash
argocd ... --grpc-web
```

### Почему ресурсы типа SealedSecret застряли в состоянии Progressing?<a id="sealedsecret" />

Контроллер ресурса `SealedSecret` может раскрывать условие состояния на ресурсе, который он предоставил. Начиная с версии `v2.0.0`, Argo CD использует это условие состояния для определения состояния здоровья для `SealedSecret`.

Версии до `v0.15.0` контроллера `SealedSecret` подвержены проблеме, касающейся обновлений этих условий состояния, поэтому эта функция отключена по умолчанию в этих версиях. Обновления условий состояния могут быть включены, запустив контроллер `SealedSecret` с параметром командной строки `--update-status` или установив переменную окружения `SEALED_SECRETS_UPDATE_STATUS`.

Чтобы отключить Argo CD от проверки условия состояния на ресурсах `SealedSecret`, добавьте следующую настройку ресурса в ваш ConfigMap `argocd-cm` через ключ `resource.customizations.health.<group_kind>`.

:::yaml
resource.customizations.health.bitnami.com\_SealedSecret: |
hs = {}
hs.status = "Healthy"
hs.message = "Контроллер не сообщает о состоянии ресурса"
return hs
:::

### Как вращать ключи Redis?

- Удалите секрет `argocd-redis` в пространстве имен, где установлен Argo CD.

```bash
kubectl delete secret argocd-redis -n <argocd namesapce>
```

- Если вы запускаете Redis в режиме HA, перезапустите Redis в HA.

```bash
kubectl rollout restart deployment argocd-redis-ha-haproxy
kubectl rollout restart statefulset argocd-redis-ha-server
```

- Если вы запускаете Redis в режиме без HA, перезапустите Redis.

```bash
kubectl rollout restart deployment argocd-redis
```

4. Перезапустите другие компоненты.

```bash
kubectl rollout restart deployment argocd-server argocd-repo-server
kubectl rollout restart statefulset argocd-application-controller
```

### Как я могу исправить ошибку генерации манифеста (кэшированную)?

`Ошибка генерации манифеста (кэшированная)` означает, что произошла ошибка при генерации манифестов, и сообщение об ошибке было кэшировано, чтобы избежать бесконечных повторных попыток.

Жесткое обновление (игнорируя кэшированную ошибку) может преодолеть временные проблемы. Но если есть постоянная причина, по которой генерация манифестов не удается, жесткое обновление не поможет.

Вместо этого попробуйте поискать в журналах repo-server имя приложения, чтобы определить ошибку, которая вызывает сбой генерации манифестов.
