---
weight: 20
sourceSHA: 39e628ac5e14fba356bfd15137e9977879dda52627bb60fbbb9f4daea5ba8834
---

# Высокая загрузка ЦП в Redis

По умолчанию Redis использует модель с одним потоком для обработки запросов на чтение и запись. Высокая загрузка ЦП может привести к замедлению ответов базы данных, что влияет на работу бизнеса.

## Проверка загрузки ЦП

Вы можете проверить загрузку ЦП с точки зрения самого экземпляра или Pods.

- Используйте команду `info` Redis, чтобы получить статистику загрузки ЦП для самого экземпляра Redis. Вы также можете найти соответствующие метрики в **Информация о экземпляре Redis** > **Мониторинг**.

  | Название метрики | Значение                                                                                                        |
  | ----------------- | --------------------------------------------------------------------------------------------------------------- |
  | **Cpu User**      | used\_cpu\_user: использование ЦП в пользовательском режиме. used\_cpu\_user\_children: использование ЦП для фоновых процессов в пользовательском режиме. |
  | **Cpu Sys**       | used\_cpu\_sys: использование ЦП в системном режиме. used\_cpu\_sys\_children: использование ЦП для фоновых процессов в системном режиме.                 |

- Статистика использования ЦП для каждого Pod под Redis будет отображаться на основе каждого Pod, показывая статистику ЦП для каждого контейнера. Вы можете найти соответствующий мониторинг ЦП Pod в **Информация о экземпляре Redis** > **Реплики** > **StatefulSet** > **Pods**.

  | Название метрики  | Значение                    |
  | ----------------- | --------------------------- |
  | **Использование ЦП** | Использование ЦП для каждого Pod. |

## Как устранить высокую загрузку ЦП?

1. Проверьте журналы Redis на наличие сообщений об ошибках или предупреждениях.

2. Используйте инструменты мониторинга на уровне системы, такие как top или htop, чтобы проверить использование ЦП, использование памяти и другую информацию о процессе Redis, и определить, является ли высокая загрузка ЦП только у процесса Redis или вся система загружена.

3. Проверьте, установлен ли параметр `maxmemory` в конфигурационном файле Redis разумно. Если Redis превышает предел `maxmemory`, это может привести к высокой загрузке ЦП.

4. Убедитесь, что метод сохранения данных Redis корректен. Если конфигурация сохранения данных Redis нерациональна, например, частые операции AOF, это может вызвать высокую загрузку ЦП.

5. Проверьте наличие медленных запросов.

   В экземпларе Redis, запущенном с параметрами по умолчанию, запросы, превышающие 20 мс, считаются медленными. Время выполнения относится ко времени, затраченному на выполнение команды запроса за вычетом ответа клиента (обсуждение), отправки ответов и других операций ввода-вывода. Вы можете настроить порог медленного запроса и количество сохраненных записей с помощью параметров `slowlog-log-slower-than` и `slowlog-max-len`. Вы можете просмотреть медленные запросы с помощью команды Redis `slowlog get`.

   В общем, использование ЦП команд Redis тесно связано с их временной сложностью. Обычно считается, что сложность O(N) или выше должна рассматриваться с осторожностью при оценке трафика в процессе проектирования бизнес-кода. Для временной сложности каждой команды Redis обратитесь к [Официальной документации Redis](https://redis.io/commands).

   Наиболее распространенные медленные логи включают `KEYS`, `LRANGE`, `EVAL`, `HGETALL`, `PUBSUB` и т.д. Эти команды обычно связаны с командами, которые сканируют большие наборы данных или содержат сложную вычислительную логику в Redis. Поскольку Redis поддерживает различные типы данных, обычные типы данных, такие как хеш и список, имеют высокие ограничения по длине, что приводит к потенциальным проблемам с большими ключами на практике.

6. Проверьте, нет ли чрезмерной нагрузки на запросы клиентов к Redis. Чрезмерный объем клиентских запросов может привести к высокой загрузке ЦП.

   Если нет явных медленных запросов, подумайте, не является ли объем запросов клиентов к Redis чрезмерным. Если произошел резкий рост загрузки ЦП без изменений в бизнес-коде, следите за QPS экземпляра Redis, чтобы увидеть, не произошел ли его скачок.

   Если подтверждено, что рост загрузки ЦП вызван нормальным увеличением трафика бизнеса или горячими ключами, вы можете решить эту проблему путем архитектурных обновлений:

   - Для чрезвычайно горячих хеш-ключей рассмотрите возможность разбиения их на строковые типы и распределения по нескольким экземплярам Redis.

   - Для чрезвычайно горячих строковых ключей, если ограничение скорости невозможно в рамках вашей бизнес-архитектуры, рассмотрите возможность увеличения конфигурации многопоточности и масштабирования характеристик ЦП экземпляра.

   - Для сценариев с высокой нагрузкой на чтение вы можете рассмотреть возможность добавления экземпляров только для чтения в режиме Sentinel для обработки высококонкурентных запросов на чтение или добавления логики кэширования в бизнес-коде; в кластерном режиме вы можете рассмотреть возможность увеличения шардирования.

   - Для сценариев с высокой нагрузкой на запись и низкой на чтение рекомендуется использовать Redis в кластерном режиме.

7. Если вы используете Redis в кластерном режиме, проверьте наличие неравномерного распределения трафика. Когда в кластере возникает задержка ответа, если высокая загрузка ЦП наблюдается на всех узлах, предоставляющих внешние услуги в кластере, подумайте о том, чтобы изменить правила распределения данных или масштабировать экземпляры.

8. Если в Redis используются Lua-скрипты, проверьте скрипты на наличие проблем, которые могут привести к высокой загрузке ЦП.
