---
weight: 20
sourceSHA: 39e628ac5e14fba356bfd15137e9977879dda52627bb60fbbb9f4daea5ba8834
---

# Высокая загрузка ЦП в Redis

По умолчанию Redis использует однопоточную модель для обработки запросов на чтение и запись. Высокая загрузка ЦП может привести к более медленным ответам базы данных, что влияет на нормальные бизнес-операции.

## Проверка загрузки ЦП

Вы можете проверить использование ЦП с точки зрения самого экземпляра или Pods.

- Используйте команду Redis `info`, чтобы получить статистику загрузки ЦП для самого экземпляра Redis. Вы также можете найти соответствующие метрики в **Детали экземпляра Redis** > **Мониторинг**.

  | Название метрики | Значение                                                                                                               |
  | ---------------- | --------------------------------------------------------------------------------------------------------------------- |
  | **Cpu User**     | used\_cpu\_user: использование ЦП в пользовательском режиме. used\_cpu\_user\_children: использование ЦП фоновыми процессами в пользовательском режиме.   |
  | **Cpu Sys**      | used\_cpu\_sys: использование ЦП в системном режиме. used\_cpu\_sys\_children: использование ЦП фоновыми процессами в системном режиме. |

- Статистика использования ЦП для каждого Pod в Redis будет отображаться на основе каждого Pod, показывая статистику ЦП для каждого контейнера. Вы можете найти соответствующее мониторинг ЦП Pod в **Детали экземпляра Redis** > **Реплики** > **StatefulSet** > **Pods**.

  | Название метрики  | Значение                |
  | ----------------- | ---------------------- |
  | **Загрузка ЦП**   | Использование ЦП каждого Pod. |

## Как устранить проблему высокой загрузки ЦП?

1. Проверьте логи Redis на наличие сообщений об ошибках или предупреждениях.

2. Используйте инструменты мониторинга на уровне системы, такие как top или htop, чтобы проверить использование ЦП, использование памяти и другую информацию о процессе Redis, и определить, является ли высокой только загрузка ЦП процесса Redis или же вся система испытывает сильную нагрузку.

3. Проверьте, разумно ли установлено значение параметра `maxmemory` в конфигурационном файле Redis. Если Redis превышает предел `maxmemory`, это может привести к высокой загрузке ЦП.

4. Убедитесь, что метод постоянства Redis правильный. Если конфигурация постоянства Redis неразумна, например, частые операции AOF, это может вызвать высокую загрузку ЦП.

5. Проверьте наличие медленных запросов.

   В экземпляре Redis, запущенном с параметрами по умолчанию, запросы, которые занимают более 20 мс, считаются медленными. Время выполнения относится к времени, затраченному на выполнение команды запроса, исключая ответ клиента (общение), отправку ответов и другие операции ввода-вывода. Вы можете настроить порог медленного запроса и количество хранимых записей с помощью параметров `slowlog-log-slower-than` и `slowlog-max-len`. Вы можете просмотреть медленные запросы с помощью команды Redis `slowlog get`.

   Как правило, использование ЦП команд Redis тесно связано с их временной сложностью. Обычно считается, что сложность O(N) и выше должны рассматриваться с осторожностью в оценке трафика при разработке бизнес-кода. Для временной сложности каждой команды Redis, пожалуйста, обратитесь к [Официальной документации Redis](https://redis.io/commands).

   Наиболее распространенные медленные логи включают `KEYS`, `LRANGE`, `EVAL`, `HGETALL`, `PUBSUB` и др. Эти команды обычно связаны с командами, которые сканируют большие наборы данных или включают тяжелую вычислительную логику в Redis. Поскольку Redis поддерживает различные типы данных, общие типы данных, такие как хэш и список, имеют высокие ограничения по длине, что приводит к потенциальным проблемам с большими ключами в практическом использовании.

6. Проверьте, нет ли чрезмерного объема клиентских запросов к Redis. Чрезмерный объем клиентских запросов может привести к высокой загрузке ЦП.

   Если нет явных медленных запросов, подумайте, не является ли объем клиентских запросов к Redis чрезмерным. Если наблюдается внезапное увеличение загрузки ЦП без изменений в бизнес-коде, следите за QPS экземпляра Redis, чтобы увидеть, произошло ли резкое увеличение.

   Если подтверждено, что рост загрузки ЦП связан с нормальным ростом бизнес-трафика или горячими ключами, вы можете решить эту проблему с помощью архитектурных улучшений:

   - Для крайне горячих хэш-ключей рассмотрите возможность их разделения на строковые типы и распределения их по нескольким экземплярам Redis.

   - Для крайне горячих строковых ключей, если ограничение по скорости нецелесообразно в рамках вашей бизнес-архитектуры, рассмотрите возможность увеличения конфигурации многопоточности и масштабирования характеристик ЦП экземпляра.

   - Для сценариев с высокой нагрузкой на чтение вы можете рассмотреть возможность добавления экземпляров только для чтения в режиме Sentinel для обработки высококонкурентных запросов на чтение или добавления логики кэширования в бизнес-код; в режиме кластера вы можете рассмотреть возможность увеличения шардирования.

   - Для сценариев с высокой нагрузкой на запись и низкой нагрузкой на чтение рекомендуется использовать Redis в режиме кластера.

7. Если вы используете Redis в режиме кластера, проверьте, нет ли неравномерного распределения трафика. Если наблюдается задержка отклика в кластере и если загрузка ЦП всех узлов, предоставляющих внешние услуги в кластере, высокая, рассмотрите возможность изменения правил распределения данных или масштабирования экземпляров.

8. Если в Redis используются Lua-скрипты, проверьте скрипты на наличие проблем, которые могут привести к высокой загрузке ЦП.
