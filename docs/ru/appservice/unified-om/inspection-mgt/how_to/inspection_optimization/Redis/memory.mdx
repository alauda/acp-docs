---
weight: 30
sourceSHA: b9d7205385bfed902beb8f3be987a1e29dccbcfe850e0a423ea02bdf243cd9a9
---

# Высокое потребление памяти в Redis

Показатель использования памяти Redis является критически важной метрикой мониторинга. Недостаток памяти в экземпляре может привести к медленным ответам базы данных и значительно вызвать ошибки записи данных.

**Описание конфигурации**: После настройки параметра `maxmemory` доступный лимит памяти для Redis будет соответствовать `maxmemory`. Когда использование памяти достигает лимита, Redis принимает только команды чтения, а команды записи будут возвращать ошибки. Также можно настроить удаление ключей, чтобы обеспечить нормальную работу Redis, когда достигается максимальный предел памяти.

## Просмотр использования памяти

Использование памяти можно отслеживать как по самому экземпляру, так и по Pods.

- Вы можете проверить информацию о Redis, чтобы увидеть статистику использования памяти в разделе **Информация о экземпляре Redis** > **Мониторинг** для соответствующих метрик.

  | Название метрики         | Значение                                                                          |
  | ------------------------ | -------------------------------------------------------------------------------- |
  | **MemoryUsed**           | Общая память, выделенная распределителем памяти Redis.                           |
  | **MemFragmentationRatio**| Коэффициент фрагментации, отношение `used_memory_rss` к `used_memory`.          |
  | **MemoryUsed,Peak**      | Пиковое потребление памяти Redis.                                                |
  | **MemoryMax**            | Максимальное значение используемой памяти, установленное в конфигурации.         |

- Статистика использования памяти для каждого Pod в Redis, отображается на основе каждого Pod, будет показывать статистику памяти для каждого контейнера внутри Pod. Вы можете найти мониторинг памяти Pod в **Информация о экземпляре Redis** > **Количество реплик** > **StatefulSet** > **Pods**.

  | Название метрики         | Значение                        |
  | ------------------------ | ------------------------------- |
  | **Memory Usage Rate**    | Уровень использования памяти каждого Pod. |

## Анализ использования памяти

В большинстве случаев память в основном потребляется фактическими требованиями к хранению данных, и вы можете рассмотреть возможность масштабирования спецификаций экземпляра в соответствии с потребностями.

В конкретных сценариях, когда использование памяти Redis не соответствует ожиданиям, вы можете использовать модуль памяти Redis для соответствующего анализа.

Нажмите **Информация о экземпляре Redis** > **Терминальная консоль**, подключитесь к экземпляру Redis и введите команду `memory stats`, чтобы просмотреть информацию об использовании серверной памяти. Для получения информации смотрите [MEMORY STATS](https://redis.io/commands/memory-stats/).

Как правило, большинство памяти экземпляра Redis потребляется набором данных, но также есть и другие накладные расходы на память, такие как буфер ожидания для репликации master-slave, память, потребляемая в процессе инициализации процесса Redis, и память, используемая для поддержания связного списка ключ-значение в Redis.

- Если память, потребляемая элементами, которые не являются набором данных, незначительна, рекомендуется проигнорировать эту часть и сосредоточиться на анализе того, соответствует ли использование памяти набора данных ожиданиям.

- Если элементы, не относящиеся к набору данных, занимают большое количество памяти, необходимо проанализировать первопричину потребления памяти по элементам на основе команды `memory stats`.

## Конфигурация политики памяти

Вы также можете управлять данными в памяти, настраивая политики удаления данных или политики истечения.

### Политика удаления данных

Когда у Redis заканчивается память, если вы настроили соответствующую политику удаления данных, данные будут автоматически удалены, чтобы обеспечить нормальную работу экземпляра Redis. Вы можете обновить параметр `maxmemory-policy` через **Информация о экземпляре Redis** > **Конфигурация параметров**.

Описание значений параметров:

| Значение параметра     | Описание                                                                                                           |
| ---------------------- | ----------------------------------------------------------------------------------------------------------------- |
| **volatile-lru**       | Удаляет наименее используемые данные из набора с истечением времени (включая ключи-значения и поля в хешах).      |
| **volatile-lfu**       | Удаляет наименее часто используемые данные из набора с истечением времени (включая ключи-значения и поля в хешах).|
| **volatile-ttl**       | Удаляет только данные, которые имеют время истечения, в порядке возрастания TTL.                                 |
| **volatile-random**    | Случайным образом выбирает данные из набора с истечением времени для удаления.                                    |
| **allkeys-lru**        | Удаляет наименее используемые данные из всех наборов данных (включая ключи-значения, хеши, списки, наборы и zset).|
| **allkeys-lfu**        | Удаляет наименее часто используемые данные из всех наборов данных (включая ключи-значения, хеши, списки, наборы и zset).|
| **allkeys-random**     | Случайным образом выбирает данные из всех наборов данных (включая ключи-значения, хеши, списки, наборы и zset) для удаления.|
| **noeviction**         | Не удаляет данные; непосредственно возвращает ошибки для операций записи, когда недостаточно памяти.               |

### Политика истечения

Redis предоставляет настраиваемую стратегию истечения, известную как политика "истечения", которая позволяет автоматическое истечение ключей. Эта политика позволяет пользователю установить время истечения для ключа, и когда это время истекает, Redis удалит ключ. Эта функция особенно полезна для данных кэша, позволяя предотвратить бесполезное использование ресурсов памяти, удерживая кэшированные данные бесконечно.

## Рекомендации по лучшим практикам использования памяти

В общем, набор данных занимает подавляющее большинство памяти в Redis, поэтому оптимизация памяти в основном сосредоточена на этой части. Вы можете обратиться к лучшим практикам конфигурации ниже:

- Установите разумный максимальный лимит памяти (`maxmemory`) для Redis, который контролирует максимальное количество памяти, которое экземпляр Redis может использовать. Когда Redis достигает предела максимальной памяти, он запускает различные стратегии очистки, такие как удаление устаревших ключей или использование алгоритма LFU (наименее часто используемого) для удаления менее использованных ключей. Рекомендуется, чтобы размер maxmemory был меньше или равен 80% спецификаций экземпляра.
- Тщательно рассмотрите структуры данных и проектирование ключей в Redis. Например, использование меньших типов данных (таких как строки) или принятие более компактных структур данных (таких как тип данных хеш-таблицы Redis) может снизить потребление памяти.
- Установите разумные времена истечения и стратегии очистки для ключей.
- Избегайте создания больших ключей.

Лучшие практики могут различаться в зависимости от различных сценариев применения. Поэтому в зависимости от вашего конкретного контекста приложения и требований вам может потребоваться настроить лучшие практики использования памяти Redis.
