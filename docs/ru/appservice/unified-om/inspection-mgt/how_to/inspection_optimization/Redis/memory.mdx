---
weight: 30
sourceSHA: b9d7205385bfed902beb8f3be987a1e29dccbcfe850e0a423ea02bdf243cd9a9
---

# Высокое использование памяти в Redis

Уровень использования памяти в Redis является критически важной метрикой для мониторинга. Недостаток памяти в экземпляре может привести к медленным ответам базы данных и серьезным ошибкам записи данных.

**Описание конфигурации**: После настройки параметра `maxmemory` доступный лимит памяти для Redis будет соответствовать `maxmemory`. Когда использование памяти достигает предела, Redis принимает только команды чтения, а команды записи будут выдавать ошибки. Также можно настроить механизм вытеснения ключей, чтобы обеспечить нормальную работу Redis при достижении максимального предела памяти.

## Просмотр использования памяти

Использование памяти можно отслеживать как на самом экземпляре, так и на Pods.

- Вы можете проверить информацию о Redis, чтобы увидеть статистику использования памяти в разделе **Детали экземпляра Redis** > **Мониторинг** для соответствующих метрик.

  | Имя метрики             | Значение                                                                        |
  | ----------------------- | ------------------------------------------------------------------------------ |
  | **MemoryUsed**          | Общая память, выделенная аллокатором Redis.                                   |
  | **MemFragmentationRatio** | Коэффициент фрагментации, соотношение между `used_memory_rss` и `used_memory`. |
  | **MemoryUsed,Peak**     | Пиковое использование памяти в Redis.                                          |
  | **MemoryMax**           | Максимальное значение доступной памяти, установленное в конфигурации.        |

- Статистика использования памяти для каждого Pod под Redis, отображаемая по Pod, будет показывать статистику использования памяти для каждого контейнера внутри Pod. Вы можете найти мониторинг памяти Pod в разделе **Детали экземпляра Redis** > **Количество реплик** > **StatefulSet** > **Pods**.

  | Имя метрики            | Значение                          |
  | ---------------------- | ---------------------------------- |
  | **Memory Usage Rate**  | Уровень использования памяти для каждого Pod. |

## Анализ использования памяти

В большинстве сценариев память в первую очередь потребляется реальными требованиями к хранению данных, и вы можете рассмотреть возможность увеличения спецификаций экземпляра в зависимости от потребностей.

В специфических сценариях, когда использование памяти в Redis не соответствует ожиданиям, вы можете воспользоваться модулем памяти Redis для соответствующего анализа.

Нажмите **Детали экземпляра Redis** > **Терминальная консоль**, подключитесь к экземпляру Redis и введите команду `memory stats`, чтобы увидеть информацию о использовании памяти сервера. Для деталей смотрите [MEMORY STATS](https://redis.io/commands/memory-stats/).

Как правило, большая часть памяти экземпляра Redis расходуется на набор данных, но также существуют другие накладные расходы по памяти, такие как буфер ожидания для репликации мастер-слейв, память, потребляемая во время инициализации процесса Redis, и память, используемая для поддержания связанного списка ключ-значение в Redis.

- Если память, потребляемая элементами, не связанными с набором данных, минимальна, целесообразно игнорировать эту часть и сосредоточиться на анализе того, соответствует ли использование памяти набора данных ожиданиям.

- Если элементы, не относящиеся к набору данных, занимают большое количество памяти, вам необходимо поочередно анализировать коренную причину потребления памяти на основе команды `memory stats`.

## Конфигурация политик памяти

Вы также можете управлять данными в памяти, настраивая политики вытеснения данных или политики истечения.

### Политика вытеснения данных

Когда Redis исчерпывает память, если вы настроили соответствующую политику вытеснения данных, данные будут автоматически удалены, чтобы обеспечить нормальную работу экземпляра Redis. Вы можете обновить параметр `maxmemory-policy` через **Детали экземпляра Redis** > **Конфигурация параметров**.

Описание значения параметра:

| Значение параметра    | Описание                                                                                                           |
| --------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **volatile-lru**      | Вытесняет наименее недавно использованные данные из набора с временем истечения (включая ключи-значения и поля в хэшах).  |
| **volatile-lfu**      | Вытесняет наименее часто используемые данные из набора с временем истечения (включая ключи-значения и поля в хэшах).     |
| **volatile-ttl**      | Вытесняет только данные, имеющие время истечения, в порядке возрастания TTL.                                       |
| **volatile-random**   | Случайным образом выбирает данные из набора с временем истечения для вытеснения.                                    |
| **allkeys-lru**       | Вытесняет наименее недавно использованные данные из всех наборов данных (включая ключи-значения, хэши, списки, множества и zset). |
| **allkeys-lfu**       | Вытесняет наименее часто используемые данные из всех наборов данных (включая ключи-значения, хэши, списки, множества и zset). |
| **allkeys-random**    | Случайным образом выбирает данные из всех наборов данных (включая ключи-значения, хэши, списки, множества и zset) для вытеснения. |
| **noeviction**        | Не вытесняет данные; прямо возвращает ошибки для операций записи, когда память недостаточна.                         |

### Политика истечения

Redis предоставляет настраиваемую стратегию истечения, известную как политика "истечения", которая позволяет автоматически истекать ключам. Эта политика позволяет пользователю установить время истечения для ключа, и когда это время истечет, Redis удалит ключ. Эта функция особенно полезна для кэшированных данных, предотвращая тем самым растрату ресурсов памяти из-за бессрочного хранения кэшированных данных.

## Рекомендации по оптимизации памяти

Как правило, набор данных занимает подавляющее большинство памяти в Redis, поэтому оптимизация памяти в основном сосредоточена на этой части. Вы можете ознакомиться с наилучшими практиками конфигурации ниже:

- Установите разумный лимит максимальной памяти (`maxmemory`) для Redis, который контролирует максимальное количество памяти, которую может использовать экземпляр Redis. Когда Redis достигает максимального предела памяти, он запускает различные стратегии очистки, такие как удаление истекших ключей или использование алгоритма LFU (наименее часто используемые) для удаления менее используемых ключей. Рекомендуется, чтобы размер maxmemory был меньше или равен 80% спецификаций экземпляра.
- Тщательно обдумайте структуры данных и проектирование ключей в Redis. Например, использование более мелких типов данных (таких как строки) или применение более компактных структур данных (таких как хэш-таблица Redis) может уменьшить использование памяти.
- Установите разумные времена истечения и стратегии очистки для ключей.
- Избегайте создания больших ключей.

Наилучшие практики могут различаться в зависимости от различных сценариев применения. Поэтому в зависимости от вашего конкретного контекста приложения и требований вам может понадобиться адаптировать лучшие практики использования памяти в Redis.
