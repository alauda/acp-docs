---
weight: 30
sourceSHA: ebb22e5b509d0b31307726d79479c6c9accccd4df4baa7bcf1456aea72add281
---

# Обработка исключений базы данных RabbitMQ Mnesia

## Общие сбои базы данных Mnesia

RabbitMQ использует базу данных Mnesia для хранения информации, такой как очереди, обмены и связывания. Общие причины сбоев Mnesia можно разделить на два типа:

- Проблемы с разрешениями в директории MNESIA\_BASE, где у пользователя недостаточно прав на запись в эту директорию.
- Невозможность Mnesia прочитать таблицу.

## Проблемы с разрешениями

Когда вы сталкиваетесь с проблемами разрешений в базе данных Mnesia, просто настройте разрешения на запись для текущего пользователя в директории MNESIA\_BASE, чтобы решить проблему.

## Сбой чтения таблицы Mnesia

Mnesia создает соответствующую схему базы данных на основе имени хоста машины. Поэтому, когда имя хоста изменяется, Mnesia не может загрузить старую схему. Аналогично, если директория rabbit\@hostname переименована, Mnesia также не сможет найти старые файлы базы данных, что заставит её создать новую папку rabbit\@hostname и начать базу данных заново.

Чтобы исправить сбои чтения Mnesia, вы можете выполнить следующие шаги:

1. Сначала проверьте, были ли обновления имени хоста узла или имени директории rabbit\@hostname. Если были обновления, вы можете переименовать его в соответствии с соглашением “rabbit\@hostname”, что позволит вам увидеть старые файлы базы данных после переименования.

2. Если обновлений не обнаружено, в режиме кластера запуск может завершиться неудачей из-за неудачных соединений между репликами. Вы можете исследовать проблемы связи между репликами на основе журналов.

3. Если вышеуказанное все еще не восстанавливает данные, вы можете выбрать резервное копирование текущей конфигурации кластера, развертывание новых узлов для присоединения к оригинальному кластеру и импортировать резервную конфигурацию.

## Другие сбои, связанные с базой данных Mnesia

Если RabbitMQ не может правильно образовать новый кластер после перезапуска, в журналах могут возникнуть ошибки, подобные следующим:

```
[warning] <0.273.0> Ошибка при ожидании таблиц Mnesia: {timeout_waiting_for_tables,['rabbit@e2e-rabbitmq-server-2.e2e-rabbitmq-nodes.local-midautons','rabbit@e2e-rabbitmq-server-1.e2e-rabbitmq-nodes.local-midautons','rabbit@e2e-rabbitmq-server-0.e2e-rabbitmq-nodes.local-midautons'],[rabbit_durable_queue]}
 [info] <0.273.0> Ожидание таблиц Mnesia в течение 30000 мс, осталось 7 попыток
```

Эта проблема возникает потому, что информация о узлах кластера хранится в базе данных Mnesia, и информация о состоянии не очищается должным образом во время перезапуска RabbitMQ. В связи с последовательной политикой запуска RabbitMQ для Pods, это может привести к бесконечному ожиданию первоначально запущенных Pods завершения запуска других Pods, создавая взаимную блокировку. Рекомендуемое решение — принудительно удалить состояние кластера и перезапустить его. Вы можете выполнить следующую команду в kubectl:

```
kubectl -n {название пространства имен} exec {имя экземпляра} -- rabbitmqctl force_boot
```
