---
weight: 50
sourceSHA: 9cb1573e33cfe32afa3eb86a37e62c34fc18eb8e78a86fc807e66fd7fa421073
---

# Оптимизация блокировок строк в MySQL

Эксклюзивные блокировки (X-блокировки) и разделяемые блокировки (S-блокировки) являются концептуальными строковыми блокировками InnoDB, которые используются для обеспечения последовательности модификаций и удалений одной и той же записи, тем самым обеспечивая сильную согласованность данных. Они применяются в трех сценариях: блокировки записей, блокировки промежутков и блокировки следующего ключа. В ситуациях с высокой конкурентностью требуется правильная конфигурация, чтобы избежать чрезмерных взаимных блокировок.

## Проверка ожидания блокировок строк

Следующий SQL-запрос может быть использован для проверки ожидания блокировок строк.

```
show status like 'Innodb_row_lock_%';
```

| Параметр возврата                       | Описание                                               |
| ---------------------------------------- | ----------------------------------------------------- |
| **Innodb\_row\_lock\_current\_waits**  | Текущее количество ожиданий блокировок строк          |
| **Innodb\_row\_lock\_time**             | Общее время, затраченное на получение блокировок строк, в миллисекундах |
| **Innodb\_row\_lock\_time\_avg**        | Среднее время, затраченное на получение блокировок строк, в миллисекундах |
| **Innodb\_row\_lock\_time\_max**        | Максимальное время, затраченное на получение блокировок строк, в миллисекундах |
| **Innodb\_row\_lock\_waits**            | Количество случаев ожидания блокировок строк          |

## Рекомендации по оптимизации проблем с ожиданием блокировок строк

### Высокая конкурентность базы данных

Когда MySQL сталкивается с слишком большим количеством совместных запросов, возникают ситуации ожидания из-за конкуренции за блокировки строк. Чтобы избежать конфликтов блокировок, рекомендуется оптимизировать горячие обновления в бизнесе и использовать такие методы, как постраничные запросы или сегментированные запросы при обработке больших объемов данных. Эти методы могут предотвратить блокировку слишком большого количества строк данных в одном запросе, снижая риск конфликтов блокировок и улучшая производительность системы и скорость отклика. Кроме того, параметры `innodb_lock_wait_timeout` и `interactive_timeout` можно настроить для определения максимальной продолжительности транзакций, ожидающих получения ресурсов. Это помогает оптимизировать механизм блокировки и повысить доступность системы.

В случаях, когда взаимные блокировки редки, можно установить `innodb_print_all_deadlocks=ON`, чтобы печатать подробную информацию о каждом случае взаимной блокировки в журнал ошибок для помощи в анализе причин взаимных блокировок. Однако, если взаимные блокировки часто встречаются в бизнесе, для поддержания работы журнала ошибок и производительности сервера лучше установить `innodb_print_all_deadlocks` в значение OFF, выводя только сводную информацию о взаимных блокировках. Если требуется детальный анализ взаимных блокировок, этот параметр можно временно установить в значение ON, чтобы увидеть подробную информацию о взаимных блокировках в течение некоторого времени, а затем снова отключить, чтобы минимизировать влияние на производительность сервера.

### Отсутствие индексов

Чтобы избежать эскалации блокировок до блокировок таблицы из-за невозможности получить блокировки строк с помощью индексации, рекомендуется максимально использовать индексы для выборки данных. Кроме того, при добавлении индексов следует максимально точно подходить к этому, чтобы избежать ненужной блокировки, что может повлиять на производительность других запросов.

### Чрезмерная зона блокировки

Чтобы избежать блокировки записей, которые не должны быть заблокированы из-за избыточного извлечения (т.е. блокировки промежутков), рекомендуется минимизировать использование диапазонных запросов. Кроме того, чтобы снизить количество заблокированных ресурсов и время блокировки, следует контролировать размер транзакций. Что касается уровней изоляции транзакций, рекомендуется использовать более низкие уровни изоляции, когда это возможно, чтобы снизить затраты, связанные с обработкой изоляции транзакций MySQL.
