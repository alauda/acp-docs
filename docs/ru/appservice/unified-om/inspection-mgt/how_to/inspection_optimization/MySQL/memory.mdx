---
weight: 20
sourceSHA: 3eca2d2519d8971f8af02614ea7751ce7f257771c96dd8df306453d46ff960f3
---

# Оптимизация использования памяти MySQL

Одним из ключевых показателей для MySQL является уровень использования памяти экземпляра и коэффициент попадания в пул буфера. Высокое использование памяти увеличивает риск возникновения ошибок OOM (Out of Memory), в то время как низкий коэффициент попадания в пул буфера указывает на то, что многие страницы данных не попадают на кешированные страницы в пуле буфера, что требует чтения данных из хранилища, что увеличивает скорость ввода-вывода и задержку.

## Проверка использования памяти

### Проверка общего использования памяти

```
select * from sys.memory_global_total;
```

**Примечание**: Из-за ограничений по частоте обновления данных, кэшированию и использованию ядра (эта часть не учитывается) данное выражение предоставляет приблизительное значение использования памяти.

### Проверка 20 основных событий по использованию памяти

```
select event_name,CURRENT_NUMBER_OF_BYTES_USED/1024/1024
from performance_schema.memory_summary_global_by_event_name
order by CURRENT_NUMBER_OF_BYTES_USED desc LIMIT 20;
```

### Проверка 20 потоков по использованию памяти

```
select thread_id,event_name,CURRENT_NUMBER_OF_BYTES_USED/1024/1024
from performance_schema.memory_summary_by_thread_by_event_name
order by CURRENT_NUMBER_OF_BYTES_USED desc limit 20;
```

### Проверка текущего выделения памяти

```
select substring_index(event_name,'/',2) as code_area, format_bytes(sum(current_alloc)) as current_alloc
from sys.x$memory_global_by_current_bytes
group by substring_index(event_name,'/',2)
order by sum(current_alloc) DESC;
```

## Рекомендации по оптимизации использования памяти

### Множественные операторы

MySQL поддерживает использование символа `;` для разделения нескольких SQL операторов, отправляя их в MySQL для последовательной обработки. Однако для освобождения некоторой памяти необходимо дождаться завершения выполнения всех SQL операторов.

Если одновременно отправляется большое количество SQL операторов, например, достигая нескольких сотен мегабайт, то в процессе выполнения SQL операторов распределение и суммарное потребление различных объектов может быть очень большим, что потенциально приведет к исчерпанию памяти в процессе MySQL.

Кроме того, использование нескольких операторов для отправки SQL может привести к резкому увеличению сетевого трафика, что можно оценить с помощью мониторинга сетевого трафика и анализа SQL. Поэтому в бизнес-реализациях рекомендуется по возможности избегать использования методов отправки SQL с несколькими операторами.

### Проблемы с пулом буфера

Все страницы данных для таблиц хранятся в пуле буфера. В процессе выполнения запросов, если необходимые страницы данных попадают в пул буфера напрямую, физические операции ввода-вывода не происходят, что достигает большей эффективности выполнения SQL. Пул буфера управляет страницами данных, используя алгоритм LRU (Least Recently Used), при этом все «грязные» страницы помещаются в связанный список Flush List.

В системах с большим объемом памяти память пула InnoDB обычно является наибольшей в памяти экземпляра. Количество экземпляров пула буфера можно увеличить, изменив параметр innodb_buffer_pool_instances, что улучшает производительность при параллельной работе.

Общие проблемы, связанные с пулом буфера, и рекомендации по оптимизации представлены в следующей таблице.

| Описание проблемы                                                 | Причина или рекомендация                                                                                                                                                                                                                                                                                                       |
| --------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Недостаточный прогрев страниц данных, приводящий к высокой задержке запросов** | Обычно происходит в экземплярах после перезапуска, холодных чтений данных или низких коэффициентов попадания в пул буфера. Рекомендуется либо улучшить характеристики экземпляров, либо предварительно выполнить прогрев данных.                                                                                                                                |
| **Чрезмерное накопление грязных страниц**                       | Когда слишком много грязных страниц не сбрасываются, фоновые потоки будут инициировать синхронизацию и обновление грязных страниц, что значительно ухудшает производительность экземпляра. Решения включают в себя балансировку нагрузки на запись, избегание чрезмерной пропускной способности записей, регулировку параметров обновления грязных страниц или улучшение характеристик экземпляров. |
| **Полные сканирования таблиц загрязняют пул буфера**            | Полные сканирования таблиц следует избегать, например, не рекомендуется использовать операторы типа `select * from large_table`, чтобы уменьшить загрязнение пула буфера.                                                                                                                                                                      |

### Временные таблицы

При использовании временных таблиц в памяти в MySQL их размер ограничивается параметрами tmp_table_size и max_heap_table_size. Временные таблицы, превышающие этот лимит параметров, будут преобразованы в временные таблицы на диске. Если большое количество подключений создают множество временных таблиц в памяти за короткий период, это может привести к резкому увеличению использования памяти.

MySQL 8.0 вводит новый механизм временных таблиц. Этот механизм требует, чтобы общий размер временных таблиц в памяти, выделяемых всеми потоками, был меньше параметра temptable_max_ram, который по умолчанию составляет 1 ГБ. Когда временные таблицы в памяти превышают этот лимит, они будут преобразованы в временные таблицы на диске.

### Кэш коммуникации кластера

При использовании MGR (MySQL Group Replication) для формирования кластера необходимо также учитывать потребление кеша коммуникации XCom Cache. По умолчанию размер этого кэша составляет 1 ГБ. В средах с хорошим качеством сети можно использовать меньший параметр group_replication_message_cachesize для создания кластера, что снижает использование памяти.

### Прочее

Когда количество таблиц в экземпляре особенно велико или частота запросов очень высока, кеш таблиц может потреблять большое количество памяти. Рекомендуется избегать создания слишком большого количества таблиц в экземпляре или установить параметр table_open_cache на разумный размер.

AHI (Adaptive Hash Index) по умолчанию занимает 1/64 памяти в пуле буфера. Если запрашиваются или записываются значительные объемы больших полей, таких как BLOB, память будет динамически выделяться, что увеличивает использование памяти. Отключение AHI может более эффективно и разумно использовать ресурсы памяти сервера, освобождая больше доступной памяти для бизнес-систем, и таким образом улучшать общую производительность. Однако следует отметить, что AHI также имеет возможность ускорять определенные запросы, поэтому необходимо установить баланс между повышением производительности запросов и оптимизацией памяти при его отключении.

Если наблюдается необычное увеличение использования памяти или истощение памяти в экземпляре MySQL, рекомендуется обратиться к [официальной документации MySQL 5.7](https://dev.mysql.com/doc/refman/5.7/en/optimizing-innodb-diskio.html) или [официальной документации MySQL 8.0](https://dev.mysql.com/doc/refman/8.0/en/optimizing-innodb-diskio.html) для выяснения причин увеличения использования памяти.
