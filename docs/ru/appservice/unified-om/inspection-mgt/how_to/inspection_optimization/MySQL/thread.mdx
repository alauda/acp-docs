---
weight: 40
sourceSHA: e87c4a5ec998a62a688a8c69a3b0595caa0852b109efacba500025e6c2d0b8a1
---

# Оптимизация количества активных потоков MySQL

Количество активных потоков или активных подключений является важным показателем для оценки нагрузки на MySQL. Обычно, здоровый экземпляр должен поддерживать количество активных подключений менее 10. Для высоконагруженных и высококачественных экземпляров количество активных подключений может достигать 20-30. Если количество активных подключений превышает несколько сотен или даже тысяч, может возникнуть накопление SQL-запросов, и время отклика MySQL может ухудшиться, что потенциально приведет к сбоям экземпляра или невозможности обработать дополнительные SQL-запросы.

## Проверка количества активных подключений

Вы можете просмотреть количество активных подключений, используя следующую SQL-команду.

```
show status like 'Threads%';
```

| Возвращаемый параметр   | Описание                                                                  |
| ----------------------- | ------------------------------------------------------------------------ |
| **Threads\_connected**  | Количество открытых подключений                                           |
| **Threads\_running**    | Количество активных подключений, как правило, значительно ниже числа подключенных |

## Рекомендации по оптимизации проблем с количеством потоков

### Замедленное накопление SQL-запросов

Если вы обнаружите, что количество активных потоков увеличивается, сначала выполните команду `show processlist`, чтобы проверить, имеются ли медленные запросы. Медленные запросы, которые сканируют слишком много строк, могут привести к увеличению количества активных подключений, что вызовет проблемы с производительностью. Если необходимо решить проблемы, связанные с производительностью, рекомендуется завершить соответствующие сеансы, чтобы уменьшить влияние.

### Проблемы кэша таблиц

В условиях высокой нагрузки или с большим количеством таблиц кэш таблиц может оказаться недостаточным, что приведет к тому, что множество SQL-запросов будет находиться в состоянии "Открытие таблицы". Это значительно увеличивает задержку запросов и нагрузку на сервер, что может привести к ухудшению производительности или сбоям сервера.

Вы можете увеличить размер кэша таблиц, повысив параметр `table_open_cache`, чтобы сократить количество SQL-запросов в состоянии "Открытие таблицы" и улучшить производительность запросов. Однако следует быть осторожным, так как чрезмерное увеличение этого параметра может потреблять память сервера и потенциально привести к проблемам с производительностью. Поэтому корректировки этого параметра следует производить осторожно, чтобы достичь оптимальной производительности и стабильности.

### Проблемы с блокировкой метаданных (MDL)

Когда происходят блокировки MDL, большое количество SQL-запросов может находиться в состоянии "Ожидание блокировки метаданных таблицы". В процессе подготовки и фиксации DDL-инструкции должны получить блокировки MDL. Если существуют неподтвержденные транзакции или медленные SQL-запросы к таблице, это блокирует операции DDL. Поскольку операции DDL могут также блокировать другие SQL-операции, это может привести к увеличению количества активных потоков.

Рекомендуется завершить неподтвержденные транзакции, медленные SQL-запросы или в настоящее время выполняемые операции DDL.

### Конфликты блокировок строк

Вы можете проверить соответствующий статус с помощью следующей SQL-команды.

```
show status like 'Innodb_row_lock_%';
```

Конфликты блокировок строк проявляются в виде увеличения индикаторов статуса `Innodb_row_lock_waits` и `Innodb_row_lock_time`, что приводит к росту количества активных потоков.

Вы также можете выполнить команду `show engine innodb status`, чтобы проверить, есть ли большое количество сеансов в состоянии "Ожидание блокировки". Если их много, это указывает на серьезные конфликты блокировок строк, которые необходимо оптимизировать с помощью таких методов, как обновление горячих данных, сокращение размеров транзакций и своевременные подтверждения транзакций, чтобы избежать конфликтов блокировок строк.
