---
weight: 40
sourceSHA: e87c4a5ec998a62a688a8c69a3b0595caa0852b109efacba500025e6c2d0b8a1
---

# Оптимизация количества активных потоков MySQL

Количество активных потоков или число активных соединений является важной метрикой для оценки состояния нагрузки MySQL. В целом, здоровый экземпляр должен поддерживать количество активных соединений менее 10. Для экземпляров с высокой мощностью и высоким QPS количество активных соединений может достигать 20-30. Если количество активных соединений превышает несколько сотен или даже тысяч, может возникнуть накопление SQL-запросов в очереди, и время отклика MySQL может замедлиться, что потенциально приведет к сбоям экземпляра или невозможности обработки дополнительных SQL-запросов.

## Проверка количества активных соединений

Вы можете просмотреть количество активных соединений, используя следующий SQL-запрос.

```
show status like 'Threads%';
```

| Возвращаемый параметр   | Описание                                                                  |
| ----------------------- | ------------------------------------------------------------------------- |
| **Threads\_connected**  | Количество открытых соединений                                            |
| **Threads\_running**    | Количество активных соединений, обычно значительно меньше, чем количество подключенных |

## Рекомендации по оптимизации проблем с количеством активных потоков

### Накопление медленных SQL-запросов

Если вы обнаружите, что количество активных потоков увеличивается, вам следует сначала выполнить команду `show processlist`, чтобы проверить наличие медленных запросов. Медленные запросы, которые сканируют слишком много строк, могут привести к увеличению количества активных соединений, тем самым вызывая проблемы с производительностью. Если необходимо устранить проблемы с производительностью, рекомендуется завершить соответствующие сеансы, чтобы снизить влияние.

### Проблемы с кешем таблиц

В сценариях с высокой загрузкой или при работе с большим количеством таблиц кеш таблиц может быть недостаточным, что приводит к тому, что множество SQL-запросов находится в состоянии "Открытие таблицы". Это значительно увеличивает задержку запросов и нагрузку на сервер и может привести к деградации производительности или сбоям сервера.

Вы можете увеличить размер кеша таблиц, подняв параметр `table_open_cache`, чтобы сократить количество SQL-запросов в состоянии "Открытие таблицы" и улучшить производительность запросов. Однако следует проявлять осторожность, поскольку чрезмерное увеличение этого параметра может потреблять память сервера и потенциально привести к проблемам с производительностью. Поэтому изменения этого параметра должны производиться осторожно для достижения оптимальной производительности и стабильности.

### Проблемы с блокировкой метаданных (MDL)

Когда происходят блокировки MDL, большое количество SQL-запросов может находиться в состоянии "Ожидание блокировки метаданных таблицы". На этапах подготовки и выполнения DDL-запросов DDL-запросы должны получать блокировки MDL. Если имеются неподтвержденные транзакции или медленные SQL-запросы к таблице, это блокирует операции DDL. Поскольку операции DDL также могут блокировать другие SQL-операции, это может привести к увеличению количества активных потоков.

Рекомендуется завершить неподтвержденные транзакции, медленные SQL-запросы или текущие операции DDL.

### Конфликты блокировок строк

Вы можете проверить соответствующий статус с помощью следующего SQL-запроса.

```
show status like 'Innodb_row_lock_%';
```

Конфликты блокировок строк проявляются в виде увеличения индикаторов состояния `Innodb_row_lock_waits` и `Innodb_row_lock_time`, что приводит к росту количества активных потоков.

Вы также можете выполнить команду `show engine innodb status`, чтобы проверить большое количество сеансов в состоянии "Ожидание блокировки". Если их много, это указывает на серьезные конфликты блокировок строк, которые необходимо оптимизировать с помощью таких методов, как обновления "горячих" данных, сокращение размеров транзакций и своевременные подтверждения транзакций, чтобы избежать конфликтов блокировок строк.
