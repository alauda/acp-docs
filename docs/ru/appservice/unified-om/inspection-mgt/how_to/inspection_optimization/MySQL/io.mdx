---
weight: 10
sourceSHA: 0f4f37a2f21c9b794cc6b311529ad5a3acab1ff7fd3efb922194764a92cee0c0
---

# Оптимизация нагрузки ввода-вывода MySQL

## Введение в систему ввода-вывода InnoDB

Производительность ввода-вывода MySQL зависит от множества факторов, включая тип аппаратных средств хранения, архитектуру ядра базы данных на программном уровне, а также объем данных, читаемых или изменяемых определенными SQL-запросами.

InnoDB использует асинхронный интерфейс ввода-вывода, предоставляемый операционной системой, для реализации подсистемы ввода-вывода для асинхронного чтения и записи страниц данных, логов и логов отмены. Когда страница данных, запрашиваемая SQL-запросом, отсутствует в буферном пуле, необходимо выполнять физические операции ввода-вывода для чтения или записи данных из основного хранилища.

- Для чтения страниц данных система ввода-вывода InnoDB использует синхронный ввод-вывод. Синхронный ввод-вывод вызывает основной интерфейс чтения для получения данных. Для записи страниц данных система ввода-вывода InnoDB использует асинхронный ввод-вывод; например, фоновый поток асинхронно очищает грязные страницы и записывает их в хранилище.

- Помимо операций чтения и записи ввода-вывода для обычных файлов данных, такие операции, как запись логов повторного/отменного действия, запись логов binlog, сортировка временных таблиц и восстановление пространств таблиц при помощи DDL, также генерируют значительное количество ввода-вывода.

Для оптимизации дискового ввода-вывода обычно можно увеличить размер буферного пула, настроить метод очистки, настроить порог очистки операционной системы и использовать fdatasync, предоставленный MySQL 8.0, в качестве замены fsync. Для конкретных методов оптимизации обратитесь к разделам оптимизации в [Официальной документации MySQL 5.7](https://dev.mysql.com/doc/refman/5.7/en/optimizing-innodb-diskio.html) или [Официальной документации MySQL 8.0](https://dev.mysql.com/doc/refman/8.0/en/optimizing-innodb-diskio.html).

## Рекомендации по оптимизации для высокой нагрузки ввода-вывода

### Высокая пропускная способность записи

Рекомендуется использовать твердотельные накопители, подходящие для высокой IOPS (Операций ввода/вывода в секунду), что может эффективно снизить проблемы высокой нагрузки ввода-вывода.

Параметр `innodb_log_file_size` контролирует размер файлов логов повторного действия InnoDB. Если значение параметра слишком мало, это приведет к частой цикличности файлов журналов и очистки, увеличивая количество операций ввода-вывода и ухудшая производительность записи. Умеренное увеличение этого параметра может уменьшить частоту цикличности файлов журналов, объединяя несколько очисток буфера журналов в одну операцию записи на диск для повышения производительности записи.

Кроме того, рекомендуется снизить частоту чтения/записи или оптимизировать параметры, относящиеся к очистке грязных страниц, чтобы решить проблемы высокой нагрузки ввода-вывода. Параметры, относящиеся к очистке грязных страниц, показаны в таблице ниже.

| Имя параметра                           | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| --------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **innodb\_max\_dirty\_pages\_pct**      | Контролирует максимальную долю грязных страниц в InnoDB. Чем больше значение, тем больше грязных страниц разрешено в InnoDB, но это также увеличивает частоту и время очистки грязных данных.                                                                                                                                                                                                                                                                                                           |
| **innodb\_max\_dirty\_pages\_pct\_lwm** | Контролирует, когда начинать очистку грязных данных после достижения максимальной доли грязных страниц в InnoDB. Чем меньше значение, тем скорее InnoDB начинает очищать грязные данные, но это также увеличивает частоту и время очистки.                                                                                                                                                                                                                                                                     |
| **innodb\_io\_capacity**                | Контролирует пропускную способность ввода-вывода, которую InnoDB может обрабатывать на диске. Чем больше значение, тем выше нагрузка на диск для InnoDB, но это также может увеличить скорость очистки грязных данных.                                                                                                                                                                                                                                                                                    |
| **innodb\_io\_capacity\_max**           | Контролирует максимальную пропускную способность ввода-вывода, которую InnoDB может обрабатывать на диске, определяя верхний предел скорости очистки грязных данных.                                                                                                                                                                                                                                                                                                                                             |
| **innodb\_lru\_scan\_depth**            | Контролирует глубину буферного пула, сканируемую InnoDB при очистке грязных страниц, тем самым влияя на объем нагрузки ввода-вывода в условиях высокой пропускной способности записи. Если значение слишком велико, каждый цикл очистки требует сканирования большего количества страниц, что приводит к неэффективным операциям чтения ввода-вывода, увеличивая общую нагрузку ввода-вывода и влияя на производительность. Если значение слишком мало, это может позволить InnoDB сканировать и очищать очень малое количество грязных страниц, что может привести к неограниченному накоплению грязных страниц и серьезному конкурсу за ввод-вывод, усугубляя нагрузку ввода-вывода. |

### Большие операции ввода-вывода от временных таблиц

После входа в контейнер MySQL вы можете использовать следующую команду для проверки размера временной папки.

```
ls -lh /var/lib/mysql/#innodb_temp
```

Если временная папка велика, это может быть связано с медленной сортировкой SQL или дедупликацией, что приводит к созданию больших временных таблиц. В этом случае необходимо оптимизировать медленные SQL-запросы, чтобы уменьшить использование временных таблиц и избежать увеличения ввода-вывода из-за записи временных таблиц.

### Большие операции ввода-вывода от чтения холодных данных

Вы можете запросить коэффициент попадания в буфер с помощью следующей SQL-команды.

```
select hit_rate from information_schema.INNODB_BUFFER_POOL_STATS;
```

Когда данные, запрашиваемые или изменяемые SQL, отсутствуют в буферном пуле в памяти, их необходимо считать с диска. Если объем данных для чтения очень велик, это может привести к очень высокой пропускной способности чтения/записи диска. Чтобы избежать этого, следует минимизировать полные сканирования таблиц, например, избегая операторов, таких как `select * from large_table`, чтобы сократить загрязнение буферного пула.

Для конкретных бизнес-сценариев рассмотрите возможность переработки стратегий кэширования или обновления характеристик экземпляра для повышения производительности системы.

### Нагрузка ввода-вывода от операторов DDL

При выполнении операторов DDL могут происходить такие операции, как восстановление пространств таблиц, сканирование данных полных таблиц и сортировка индексов. Грязные страницы, созданные новыми таблицами, необходимо очищать, что приводит к значительному количеству операций ввода-вывода. Кроме того, при необходимости удаления больших таблиц операция drop table может вызвать колебания ввода-вывода. Чтобы избежать влияния на бизнес-операции, эти операции следует планировать в периоды низкой нагрузки.

### Запись больших транзакций в binlogs генерирует значительную нагрузку ввода-вывода

Рекомендуется разбивать большие транзакции на более мелкие, чтобы избежать записи больших объемов файлов binlog, тем самым снижая пропускную способность ввода-вывода. Например, если оператор delete SQL должен удалить большое количество строк, его можно разбить на несколько меньших операторов удаления для выполнения. Это может уменьшить размер файлов binlog, создаваемых каждой транзакцией, и снизить частоту очистки диска, улучшая производительность. Более того, оптимизация бизнес-логики может помочь предотвратить возникновение крупных транзакций.
