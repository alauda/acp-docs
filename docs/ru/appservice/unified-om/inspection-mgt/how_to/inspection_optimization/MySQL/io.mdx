---
weight: 10
sourceSHA: 0f4f37a2f21c9b794cc6b311529ad5a3acab1ff7fd3efb922194764a92cee0c0
---

# Оптимизация нагрузки на ввод-вывод MySQL

## Введение в систему ввода-вывода InnoDB

Производительность ввода-вывода MySQL зависит от множества факторов, включая тип аппаратных средств хранения данных, архитектуру ядра базы данных на программном уровне, а также объем данных, считываемых или изменяемых определенными SQL-запросами.

InnoDB использует асинхронный интерфейс ввода-вывода, предоставляемый операционной системой, для реализации подсистемы ввода-вывода, которая асинхронно считывает и записывает страницы данных, журналы и журналы отката. Когда страница данных, запрашиваемая SQL-запросом, отсутствует в пуле буфера, требуются физические операции ввода-вывода для чтения или записи данных из хранилища.

- Для чтения страниц данных система ввода-вывода InnoDB использует синхронный ввод-вывод. Синхронный ввод-вывод вызывает интерфейс чтения нижнего уровня для считывания данных. Для записи страниц данных система ввода-вывода InnoDB использует асинхронный ввод-вывод; например, фоновый поток асинхронно сбрасывает грязные страницы в хранилище.

- В дополнение к операциям ввода-вывода для обычных файлов данных, такие операции, как запись журналов повторного выполнения/отката, запись журнальных логов, сортировка временных таблиц и перестройка пространств таблиц DDL, также создают значительное количество операций ввода-вывода.

Для оптимизации дискового ввода-вывода можно обычно увеличить размер пула буфера, отрегулировать метод сброса, настроить порог сброса операционной системы и использовать fdatasync, предоставленный MySQL 8.0, в качестве замены fsync. Для конкретных методов оптимизации обратитесь к разделам по оптимизации в [официальной документации MySQL 5.7](https://dev.mysql.com/doc/refman/5.7/en/optimizing-innodb-diskio.html) или [официальной документации MySQL 8.0](https://dev.mysql.com/doc/refman/8.0/en/optimizing-innodb-diskio.html).

## Рекомендации по оптимизации для высокой нагрузки на ввод-вывод

### Высокая производительность записи

Рекомендуется использовать твердотельные накопители, подходящие для высокой IOPS (операций ввода-вывода в секунду), что может эффективно смягчить проблемы с высокой нагрузкой ввода-вывода.

Параметр `innodb_log_file_size` контролирует размер файлов журналов повторного выполнения InnoDB. Если значение параметра слишком мало, это приведет к частой цикличности файлов журналов и сбросам, увеличивая количество операций ввода-вывода и ухудшая производительность записи. Увеличение этого параметра может сократить частоту цикличности файлов журналов, объединяя несколько сбросов буфера журнала в одну операцию ввода-вывода на диск для повышения производительности записи.

Кроме того, целесообразно снизить частоту чтения/записи или оптимизировать параметры, связанные со сбросом грязных страниц, чтобы решить проблемы с высокой нагрузкой ввода-вывода. Параметры, связанные со сбросом грязных страниц, показаны в таблице ниже.

| Название параметра                       | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **innodb\_max\_dirty\_pages\_pct**       | Контролирует максимальную долю грязных страниц в InnoDB. Чем больше значение, тем больше грязных страниц допускается в InnoDB, но это также увеличивает частоту и время сброса грязных данных.                                                                                                                                                                                                                                                                                                                |
| **innodb\_max\_dirty\_pages\_pct\_lwm**  | Контролирует, когда начинать сброс грязных данных после достижения максимальной доли грязных страниц в InnoDB. Чем меньше значение, тем раньше InnoDB начинает сброс грязных данных, но это также увеличивает частоту и время сброса.                                                                                                                                                                                                                                                                              |
| **innodb\_io\_capacity**                 | Контролирует пропускную способность ввода-вывода, которую InnoDB может обрабатывать на диске. Чем больше значение, тем выше нагрузка на диск для InnoDB, но это также может увеличить скорость сброса грязных данных.                                                                                                                                                                                                                                                                                               |
| **innodb\_io\_capacity\_max**            | Контролирует максимальную пропускную способность ввода-вывода, которую InnoDB может обрабатывать на диске, определяя верхний предел скорости сброса грязных данных.                                                                                                                                                                                                                                                                                                                                                 |
| **innodb\_lru\_scan\_depth**             | Контролирует глубину сканирования пула буфера InnoDB при сбросе грязных страниц, что влияет на объем нагрузки ввода-вывода в условиях высокой производительности записи. Если значение слишком велико, каждый цикл сброса требует сканирования большего числа страниц, что приводит к большему количеству неэффективных операций чтения ввода-вывода, увеличивая общую нагрузку ввода-вывода и влияя на производительность. Если значение слишком маленькое, это может позволить InnoDB сканировать и очищать лишь очень небольшое количество грязных страниц, что может привести к неограниченному накоплению грязных страниц и серьезной конкуренции за ввод-вывод, усугубляя нагрузку ввода-вывода. |

### Большие операции ввода-вывода из временных таблиц

После входа в контейнер MySQL вы можете использовать следующую команду для проверки размера временного каталога файлов.

```
ls -lh /var/lib/mysql/#innodb_temp
```

Если временной каталог большой, это может быть связано с медленной сортировкой SQL или дедупликацией, что приводит к созданию больших временных таблиц. В этом случае необходимо оптимизировать медленные SQL-запросы, чтобы уменьшить использование временных таблиц, тем самым избегая увеличения нагрузки ввода-вывода от записи временных таблиц.

### Большие операции ввода-вывода из чтения холодных данных

Вы можете запросить коэффициент пополнения буфера с помощью следующей SQL-команды.

```
select hit_rate from information_schema.INNODB_BUFFER_POOL_STATS;
```

Когда данные, запрашиваемые или изменяемые SQL, отсутствуют в пуле буфера в памяти, их необходимо считывать с диска. Если объем данных для чтения очень велик, это может привести к очень высокой пропускной способности операций чтения/записи на диске. Чтобы избежать этого, следует минимизировать полные сканирования таблицы, например, избегать таких операторов, как `select * from large_table`, чтобы уменьшить загрязнение пула буфера.

Для конкретных бизнес-сценариев рассмотрите возможность переработки стратегий кэширования или обновления характеристик экземпляра, чтобы улучшить производительность системы.

### Нагрузка на ввод-вывод от операторов DDL

При выполнении операторов DDL могут происходить такие операции, как перестройка пространств таблиц, полное сканирование данных таблицы и создание сортировок индексов. Грязные страницы, сгенерированные новыми таблицами, необходимо сбросить, что приводит к значительной нагрузке ввода-вывода. Кроме того, когда необходимо удалить большие таблицы, операция удаления таблицы может вызвать колебания ввода-вывода. Чтобы избежать влияния на бизнес-операции, эти операции следует планировать в периоды низкой активности.

### Большие транзакции записи журналов binlogs создают большую нагрузку на ввод-вывод

Рекомендуется разбивать большие транзакции на более мелкие, чтобы избежать записи больших объемов файлов binlog, тем самым снижая пропускную способность ввода-вывода. Например, если оператор SQL удаления нуждается в удалении большого количества строк, его можно разбить на несколько более мелких операторов удаления для выполнения. Это может снизить объем файлов binlog, создаваемых каждой транзакцией, и уменьшить частоту сброса на диск, улучшая производительность. Кроме того, оптимизация бизнес-логики может помочь предотвратить возникновение больших транзакций.
