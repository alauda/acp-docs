---
weight: 10
sourceSHA: 8b765eefca618d7cfba8d9544b7e5dcee3eb4cd4350bc5e50ef31bf39377024d
---

# Высокая загрузка CPU в Kafka

## Контроль параллелизма

Kafka использует пул потоков для контроля параллелизма при обработке сообщений. Правильная настройка размера пула потоков позволяет полностью использовать ресурсы CPU и избегать перегрузки CPU.

| Параметр               | Описание                                                                                                                                                     |
| --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **num.network.threads** | Количество потоков для обработки сетевых запросов, значение по умолчанию - 3. Правильная настройка этого параметра может регулировать способность Kafka обрабатывать сетевые запросы. |
| **num.io.threads**      | Количество потоков для обработки операций с диском, значение по умолчанию - 8. Правильная настройка этого параметра может регулировать способность Kafka обрабатывать операции с диском.                 |

## Пакетная обработка сообщений

Kafka поддерживает пакетную обработку сообщений, которая объединяет несколько сообщений в пакеты для снижения накладных расходов на сеть и диск I/O. Пакетная обработка значительно улучшает производительность Kafka и снижает загрузку CPU.

| Параметр      | Описание                                                                                                                                               |
| -------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **batch.size** | Размер пакета сообщений, устанавливаемый на стороне производителя, в байтах, со значением по умолчанию 16384. Правильная настройка этого параметра может улучшить пропускную способность Kafka. |
| **linger.ms**  | Время ожидания сообщения, устанавливаемое на стороне производителя, в миллисекундах, со значением по умолчанию 0. Сообщения в это время будут объединены в пакет.        |

## Стратегия извлечения для потребителя

Правильная настройка стратегии извлечения для потребителя может снизить нагрузку на CPU.

| Параметр             | Описание                                                                                                  |
| --------------------- | ------------------------------------------------------------------------------------------------------------ |
| **fetch.min.bytes**   | Минимальное количество данных, требуемое, когда потребитель извлекает данные из брокера, со значением по умолчанию 1. |
| **fetch.max.wait.ms** | Максимальное время ожидания, когда потребитель извлекает данные из брокера, со значением по умолчанию 500.             |

## Отключение сжатия сообщений

Сжатие сообщений может уменьшить занимаемое место сообщений для хранения и передачи по сети, а также снизить потребление полосы пропускания, но одновременно это увеличивает нагрузку на CPU. Если ресурсы CPU ограничены, рассмотрите возможность отключения сжатия сообщений, чтобы освободить дополнительные ресурсы CPU.

| Параметр            | Описание                                                                              |
| -------------------- | ---------------------------------------------------------------------------------------- |
| **compression.type** | Допустимые значения включают `uncompressed`, `zstd`, `lz4`, `snappy`, `gzip` и `producer`. |

## Избегать частой сборки мусора

Для обеспечения производительности и стабильности Kafka следует обратить внимание на производительность сборщика мусора (GC, Garbage Collection) в JVM. Частая сборка мусора может увеличить нагрузку на CPU. Поэтому рекомендуется правильно настраивать параметры JVM брокера Kafka, чтобы оптимизировать стратегию сборки мусора, улучшить производительность и снизить частоту сборок мусора.

```yaml
spec:
   kafka:
     ...
     jvmOptions:
      '-Xms': 512m
      '-Xmx': 512m
     ...
```

## Масштабирование брокера

Для повышения пропускной способности и доступности кластера рекомендуется распределить новосозданные темы по новым брокерам, чтобы уменьшить количество соединений с одним брокером.
