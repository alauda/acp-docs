---
weight: 40
sourceSHA: d4aecf6202a2adc7ec3f476ddb8814f602f82f380fe4efcd5d46fb2c67fd2ba9
---

# Оптимизация пространства хранения в Kafka

Пользователи Kafka должны тщательно следить за использованием пространства хранения своих экземпляров Kafka, так как избыточное использование может препятствовать нормальной работе Kafka. Обычно рекомендуется поддерживать использование пространства хранения кластера Kafka в пределах 50-70%. Если уровень использования продолжает расти, следует принять соответствующие меры, чтобы избежать влияния недостаточного пространства на систему.

## Избыточные журналы

В Kafka данные сообщений хранятся в журналах. Без контроля над количеством и размером журналов значительное количество пространства хранения может быть занято. Поэтому необходимо регулярно очищать старые данные и журналы, а также соответствующим образом настраивать такие параметры, как размер журнала.

Автоматически очищая данные в Kafka, мы можем эффективно контролировать размер данных на диске, удалять ненужные данные и снижать расходы на обслуживание кластера Kafka. Такие меры могут не только оптимизировать использование пространства хранения, но и обеспечить эффективную работу Kafka.

| Параметр              | Описание                                                                                                                                                      |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **log.cleanup.policy** | **delete** (по умолчанию): Очищает данные на основе времени хранения и максимального размера журнала. **compact**: Для любого ключа в разделе его соответствующее значение является последним. |

## Нечищенные устаревшие сообщения

В Kafka эффективная продолжительность сообщений может быть настроена с помощью параметра `retention.ms`. Если устаревшие сообщения не очищаются вовремя, они будут занимать пространство хранения. Для решения этой проблемы Kafka использует механизм регулярной очистки на основе сегментов. Сегменты, которые в настоящее время используются, не будут очищаться; операции удаления будут выполняться только тогда, когда либо `log.retention.hours`, либо `log.retention.bytes` достигнет установленных требований.

| Параметр               | Описание                                                                                                                                                                               |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **log.retention.hours** | Продолжительность хранения журналов, по умолчанию 7 дней. Очищает сообщения, которые превышают указанное время.                                                                       |
| **log.retention.bytes** | Сохраняемый размер журналов. Старые сообщения будут удалены, как только указанный размер будет превышен, по умолчанию -1 (не удалять).                                                     |
| **log.segment.bytes**   | Максимальный размер файлов журналов, со значением по умолчанию 1073741824 (т.е. 1 ГБ). Когда текущий размер файла сегмента журнала превышает это значение, происходит переключение файлов журнала. |
| **log.roll.hours**      | Максимально допустимый интервал между временной меткой последнего сообщения в текущем сегменте журнала и текущей временной меткой системы, измеряемый в часах.                                     |

## Сжатие сообщений

В Kafka сжатие сообщений является распространенной стратегией оптимизации, которая может сократить использование пространства хранения и пропускной способности за счет сжатия сообщений. Kafka предлагает несколько алгоритмов сжатия на выбор, таких как zstd, LZ4, snappy и GZIP. При использовании сжатия сообщений следует учитывать следующие аспекты:

1. Выбор алгоритма сжатия

   Выбор алгоритма сжатия основан на компромиссе между коэффициентом сжатия и производительностью. Разные алгоритмы сжатия имеют свои особенности в этих аспектах. Например, алгоритм zstd обычно достигает более высокого коэффициента сжатия и большей скорости, но требует больше ресурсов ЦП. В отличие от этого, алгоритмы snappy и LZ4 предлагают большую скорость и меньшую задержку, однако имеют относительно более низкие коэффициенты сжатия. Таким образом, при выборе алгоритма сжатия необходимо учитывать реальные бизнес-потребности и доступные аппаратные ресурсы.

2. Задержка сообщений до и после сжатия

   Использование алгоритмов сжатия для сжатия и распаковки сообщений потребует определенных ресурсов ЦП и может вызвать некоторую задержку при передаче сообщений. Поэтому перед решением о включении сжатия сообщений необходимо всесторонне оценить пропускную способность кластера, пространство хранения и ресурсы ЦП. Если ресурсы пропускной способности и хранения ограничены, а ресурсы ЦП относительно избыточны, можно рассмотреть возможность включения сжатия для снижения расходов на хранение и сеть. Однако в случаях, когда ресурсы ЦП близки к насыщению, требуется тщательная оценка, чтобы определить, следует ли включать сжатие, чтобы избежать негативного влияния на производительность кластера.

3. Настройка параметров сжатия

   При использовании сжатия сообщений Kafka необходимо задать соответствующие параметры в конфигурационных файлах производителя и потребителя. Например, параметр `compression.type` используется для указания алгоритма сжатия, который будет использоваться.

   Пропускная способность: LZ4 > Snappy > zstd > GZIP.

   Коэффициент сжатия: zstd > LZ4 > GZIP > Snappy.

   | Параметр            | Описание                                                                   |
   | -------------------- | ----------------------------------------------------------------------------- |
   | **compression.type** | Опциональные значения: `uncompressed`, `zstd`, `lz4`, `snappy`, `gzip`, `producer`. |

## Мониторинг пространства хранения

Kafka предоставляет несколько метрик для мониторинга использования пространства хранения. Нам необходимо регулярно проверять эти метрики и принимать соответствующие меры при обнаружении продолжающегося увеличения использования пространства хранения. Через мониторинг и меры оптимизации пространства хранения мы можем лучше управлять пространством хранения кластера Kafka и предотвращать сбои, вызванные проблемами с пространством хранения, тем самым обеспечивая стабильную работу Kafka.

| Метрика                   | Описание                                                                                                                                                                                 |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **log.log\_end\_offset** | Смещение последнего сообщения в текущем журнале. Сравнивая `log_end_offset` разных тем и разделов, можно понять использование пространства хранения каждого раздела.                        |
| **log.segment.bytes**    | Размер каждого сегмента журнала.                                                                                                                                                               |
| **log.segment.ms**       | Временной интервал для каждого сегмента журнала. Это можно использовать для определения, нужно ли очищать старые данные и журналы.                                                               |
| **log.retention.bytes**  | Общий размерный порог сообщений, хранящихся в Kafka. Когда общий размер превышает этот порог, Kafka автоматически удаляет старые сообщения.                                               |
| **log.retention.hours**  | Продолжительность хранения сообщений в Kafka. Сообщения, превышающие этот временной лимит, будут автоматически удалены.                                                                   |
