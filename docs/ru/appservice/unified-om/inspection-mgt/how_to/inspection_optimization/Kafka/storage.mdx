---
weight: 40
sourceSHA: d4aecf6202a2adc7ec3f476ddb8814f602f82f380fe4efcd5d46fb2c67fd2ba9
---

# Оптимизация пространства хранения Kafka

Пользователи Kafka должны внимательно следить за использованием пространства хранения своих экземпляров Kafka, так как чрезмерное использование может помешать нормальной работе Kafka. Обычно рекомендуется поддерживать использование пространства хранения кластера Kafka в пределах 50-70%. Если уровень использования продолжает расти, необходимо предпринять соответствующие меры, чтобы избежать влияния недостаточного пространства на систему.

## Чрезмерные лог-файлы

В Kafka данные сообщений хранятся в лог-файлах. Без контроля за количеством и размером лог-файлов может быть занято значительное количество пространства хранения. Поэтому необходимо регулярно очищать старые данные и логи, а также правильно настраивать параметры, такие как размер лог-файла.

Автоматически очищая данные в Kafka, мы можем эффективно контролировать размер данных на диске, удалять ненужные данные и снижать затраты на обслуживание кластера Kafka. Такие меры могут не только оптимизировать использование пространства хранения, но и обеспечить эффективную работу Kafka.

| Параметр               | Описание                                                                                                                                                    |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **log.cleanup.policy** | **delete** (по умолчанию): Очищает данные на основе времени хранения и максимального размера лога. **compact**: Для любого ключа в разделе соответствующее значение — последнее. |

## Неочищенные просроченные сообщения

В Kafka эффективная продолжительность сообщений может настраиваться с помощью параметра `retention.ms`. Если просроченные сообщения не очищаются своевременно, они займут место в хранилище. Для решения этой проблемы Kafka использует механизм регулярной очистки на основе сегментов. Сегменты, находящиеся в использовании, не будут очищаться; операции удаления будут выполняться только тогда, когда либо `log.retention.hours`, либо `log.retention.bytes` достигает установленных требований.

| Параметр               | Описание                                                                                                                                                                               |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **log.retention.hours** | Длительность хранения лог-файлов, по умолчанию 7 дней. Очищает сообщения, которые превышают это указанное время.                                                                          |
| **log.retention.bytes** | Сохраненный размер лог-файлов. Старые сообщения будут удалены, как только размер превышает указанное значение, по умолчанию -1 (не удалять).                                               |
| **log.segment.bytes**   | Максимальный размер лог-файлов, по умолчанию 1073741824 (т.е. 1 ГБ). Когда текущий размер файла лог-сегмента превышает это заданное значение, это приведет к автоматическому переключению лог-файла. |
| **log.roll.hours**      | Максимально допустимый интервал между временной меткой последнего сообщения в текущем лог-сегменте и текущей системной временной меткой, измеряемый в часах.                                   |

## Сжатие сообщений

В Kafka сжатие сообщений — это широко используемая стратегия оптимизации, которая может сократить использование пространства хранения и пропускной способности за счет сжатия сообщений. Kafka предлагает несколько алгоритмов сжатия на выбор, таких как zstd, LZ4, snappy и GZIP. При использовании сжатия сообщений необходимо учитывать следующие аспекты:

1. Выбор алгоритма сжатия

   Выбор алгоритма сжатия основан на компромиссе между коэффициентом сжатия и производительностью. Разные алгоритмы сжатия имеют разные характеристики в этих аспектах. Например, алгоритм zstd обычно достигает более высокого коэффициента сжатия и большей скорости, но требует больше ресурсов процессора. Напротив, алгоритмы snappy и LZ4 предлагают более высокую скорость и меньшую задержку, но имеют относительно более низкий коэффициент сжатия. Таким образом, при выборе алгоритма сжатия необходимо учитывать фактические бизнес-потребности и доступные аппаратные ресурсы.

2. Задержка сообщений до и после сжатия

   Использование алгоритмов сжатия для сжатия и разжатия сообщений потребует определённых ресурсов CPU и может ввести некоторую задержку в доставку сообщений. Поэтому перед принятием решения о включении сжатия сообщений необходимо тщательно оценить ситуацию с пропускной способностью кластера, хранилищем и ресурсами CPU. Если пропускная способность и ресурсы хранилища ограничены, тогда можно рассмотреть возможность включения сжатия для уменьшения затрат на хранилище и сети. Однако в случаях, когда ресурсы CPU близки к насыщению, необходимо провести тщательную оценку, чтобы определить, следует ли включать сжатие, чтобы избежать негативного влияния на производительность кластера.

3. Конфигурация параметров сжатия

   При использовании сжатия сообщений Kafka необходимо настроить соответствующие параметры в конфигурационных файлах продюсера и потребителя. Например, параметр `compression.type` используется для указания используемого алгоритма сжатия.

   Пропускная способность: LZ4 > Snappy > zstd > GZIP.

   Коэффициент сжатия: zstd > LZ4 > GZIP > Snappy.

   | Параметр            | Описание                                                                       |
   | -------------------- | ------------------------------------------------------------------------------ |
   | **compression.type** | Опциональные значения: `uncompressed`, `zstd`, `lz4`, `snappy`, `gzip`, `producer`. |

## Мониторинг пространства хранения

Kafka предоставляет несколько метрик для мониторинга использования пространства хранения. Нам необходимо регулярно проверять эти метрики и принимать соответствующие меры при обнаружении роста использования пространства хранения. Через мониторинг и оптимизационные меры по пространству хранения мы можем лучше управлять пространством хранения кластера Kafka и предотвратить сбои, вызванные проблемами с пространством хранения, тем самым обеспечивая стабильную работу Kafka.

| Метрика                   | Описание                                                                                                                                                                                 |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **log.log\_end\_offset** | Смещение последнего сообщения в текущем логе. Сравнивая `log_end_offset` различных тем и разделов, можно понять использование пространства хранения каждого раздела.                       |
| **log.segment.bytes**    | Размер каждого лог-сегмента.                                                                                                                                                               |
| **log.segment.ms**       | Временной интервал каждого лог-сегмента. Это можно использовать для определения, нужно ли очищать старые данные и логи.                                                                   |
| **log.retention.bytes**  | Общий размерный порог сообщений, хранящихся в Kafka. Когда общий размер превышает этот порог, Kafka автоматически удаляет старые сообщения.                                               |
| **log.retention.hours**  | Длительность хранения сообщений в Kafka. Сообщения, превышающие этот лимит времени, будут автоматически удалены.                                                                         |
