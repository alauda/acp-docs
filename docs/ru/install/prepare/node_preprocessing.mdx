---
weight: 30
sourceSHA: 0a6ee3874afac62a7071ab0047813dd1b9c496e01ca0274257dec12d247e11e2
---

# Предварительная обработка узлов

Перед установкой `глобального` кластера все узлы (узлы управления и рабочие узлы) должны завершить предварительную обработку.

## Выполнение скрипта быстрой конфигурации

Пакет установки <Term name="productShort" /> предоставляет скрипт для быстрой конфигурации узлов.

Распакуйте пакет установки, чтобы получить файл скрипта `init.sh` в директории `res`. Скопируйте файл скрипта на узлы и убедитесь, что у вас есть права `root`.

Выполните скрипт:

```bash
bash init.sh
```

<Directive type="warning" title="WARNING">
  `init.sh` не может гарантировать, что все последующие проверки будут корректно обработаны. Вам необходимо продолжить с шагами ниже.
</Directive>

## Проверки узлов \{#node\_checks}

Ниже приведен список всех проверок, которые необходимо выполнить на узлах. В зависимости от роли узла требуемые проверки будут различаться. Например, некоторые проверки применимы только к узлам управления.

Проверки делятся на две категории:

- ✅ Указывает, что проверка должна пройти.
- ⚠️ Указывает, что проверка должна быть выполнена в определенных сценариях. Пожалуйста, определите, соответствуют ли условия инструкциям. Если да, то необходимо их устранить.

Вот список проверок:

- **ОС и ядро**
  - ✅ Конфигурация загрузки grub машины должна содержать параметр `transparent_hugepage=never`.
  - ✅ Конфигурация загрузки grub системы CentOS 7.x должна содержать параметр `cgroup.memory=nokmem`.
  - ✅ Проверьте, включены ли модули ядра `ip_vs`, `ip_vs_rr`, `ip_vs_wrr` и `ip_vs_sh`.
  - ⚠️ Если версия ядра ниже 4.19.0 (или RHEL ниже 4.18.0), проверьте, включены ли модули ядра `nf_conntrack_ipv4` и (для IPv6) `nf_conntrack_ipv6`.
  - ⚠️ Если `глобальный` кластер планирует использовать `Kube-OVN` CNI, модули ядра `geneve` и `openvswitch` должны быть включены.
  - ✅ Отключите apparmor/selinux и брандмауэр.
  - ✅ Отключите `swap`.

- **Пользователи и права**
  - ✅ SSH-пользователь узла имеет права `root` и может использовать `sudo` без пароля.
  - ✅ Параметры `UseDNS` и `UsePAM` в файле `/etc/ssh/sshd_config` должны быть установлены в `no`.
  - ✅ Выполнение `systemctl show --property=DefaultTasksMax` возвращает `infinity` или очень большое значение; в противном случае отрегулируйте `/etc/systemd/system.conf`.

- **Сеть узлов**
  - ✅ `hostname` должен соответствовать следующим правилам:
    - Не более 36 символов.
    - Начинается и заканчивается на букву или цифру.
    - Содержит только строчные буквы, цифры, `-` и `.`, но не может содержать `.-`, `..` или `-.`.
  - ✅ `localhost` в `/etc/hosts` должен разрешаться в `127.0.0.1`.
  - ✅ Файл `/etc/resolv.conf` должен существовать и содержать конфигурации `nameserver`, но не должен содержать адреса, начинающиеся на 172 (отключите systemd-resolved).
  - ⚠️ Файл `/etc/resolv.conf` не должен настраивать домены поиска (если вы должны настроить их, см. [Настройка домена поиска](#config_search)).
  - ✅ IP-адрес машины не может быть адресом обратной связи, мультидопуска, локальной ссылки, все-0 или широковещательным адресом.
  - ✅ Выполнение `ip route` должно возвращать маршрут по умолчанию или маршрут, указывающий на `0.0.0.0`.
  - ✅ Узлы не должны занимать следующие порты:
    - **Узлы управления:** `2379`, `2380`, `6443`, `10249` \~ `10256`
    - **Узел, на котором находится установщик:** `8080`, `12080`, `12443`, `16443`, `2379`, `2380`, `6443`, `10249` \~ `10256`
    - **Рабочие узлы:** `10249` \~ `10256`
  - ✅ Если `глобальный` кластер использует **Kube-OVN** или **Calico**, убедитесь, что следующие порты не заняты:
    - **Kube-OVN:** `6641`, `6642`
    - **Calico:** `179`
  - ⚠️ Убедитесь, что IP-адреса в сетевом сегменте `172.16.x.x` \~ `172.32.x.x`, необходимые Docker, не заняты. Если IP-адреса в этом сетевом сегменте заняты и не могут быть изменены, пожалуйста, обратитесь в техническую поддержку.

- **Требования к программному обеспечению и директориям:**
  - ✅ Необходимо установить следующее: `ip`, `ss`, `tar`, `swapoff`, `modprobe`, `sysctl`, `md5sum`, и `scp` или `sftp`.
  - ⚠️ Если вы планируете использовать локальное хранилище **TopoLVM** или **Rook**, вам необходимо установить `lvm2`.
  - ✅ Файл `/etc/systemd/system/kubelet.service` не должен существовать.
  - ✅ Параметры монтирования `/tmp` не должны содержать `noexec`.
  - ✅ Удалите пакеты, которые конфликтуют с компонентами `глобального` кластера (см. [Удаление конфликтующих пакетов](#remove_conflicting_packages)).
  - ✅ Следующие файлы должны быть удалены, если они существуют:
    - `/var/lib/docker`
    - `/var/lib/containerd`
    - `/var/log/pods`
    - `/var/lib/kubelet/pki`

- **Проверки между узлами**
  - ✅ Не должно быть ограничений сетевого брандмауэра между узлами в `глобальном` кластере.
  - ✅ `hostname` каждого узла в кластере должен быть уникальным.
  - ✅ Часовые пояса всех узлов должны быть унифицированы, а ошибка синхронизации времени должна составлять ≤ 10 секунд.

# Приложение

### Удаление конфликтующих пакетов \{#remove\_conflicting\_packages}

Перед установкой приложения на узлах могут уже работать приложения в среде docker/containerd или быть установлены пакеты, конфликтующие с `глобальным` кластером. Поэтому необходимо проверить и удалить конфликтующие пакеты.

<Directive type="danger" title="DANGER">
  - Чтобы избежать перерыва в работе приложения или потери данных, обязательно подтвердите наличие конфликтующих программных пакетов. При обнаружении конфликта, пожалуйста, разработайте план переключения приложений и сделайте резервное копирование данных перед удалением.
  - После удаления конфликтующих пакетов вам все равно нужно проверить наличие других потенциально конфликтующих двоичных файлов в директориях, таких как `/usr/local/bin/` (таких как программное обеспечение, связанное с docker, containerd, runc, podman, контейнерной сетью, контейнерным временем выполнения или Kubernetes).
</Directive>

Следующие команды могут быть использованы в качестве справки.

<Tabs>
  <Tab label="CentOS / RedHat">
    **Проверка:**

    ```bash
    for x in \
        docker docker-client docker-common docker-latest \
        podman-docker podman \
        runc \
        containernetworking-plugins \
        apptainer \
        kubernetes kubernetes-master kubernetes-node kubernetes-client \
        ; do
        rpm -qa | grep -F "$x"
    done
    ```

    **Удаление:**

    ```bash
    for x in \
        docker docker-client docker-common docker-latest \
        podman-docker podman \
        runc \
        containernetworking-plugins \
        apptainer \
        kubernetes kubernetes-master kubernetes-node kubernetes-client \
        ; do
        yum remove "$x"
    done
    ```
  </Tab>

  <Tab label="Ubuntu">
    **Проверка:**

    ```bash
    for x in \
        docker.io \
        podman-docker \
        containerd \
        rootlesskit \
        rkt \
        containernetworking-plugins \
        kubernetes \
        ; do
        dpkg-query -l | grep -F "$x"
    done

    for x in \
        kubernetes-worker \
        kubectl kube-proxy kube-scheduler kube-controller-manager kube-apiserver \
        k8s microk8s \
        kubeadm kubelet \
        ; do
        snap list | grep -F "$x"
    done
    ```

    **Удаление:**

    ```bash
    for x in \
        docker.io \
        podman-docker \
        containerd \
        rootlesskit \
        rkt \
        containernetworking-plugins \
        kubernetes \
        ; do
        apt-get purge "$x"
    done

    for x in \
        kubernetes-worker \
        kubectl kube-proxy kube-scheduler kube-controller-manager kube-apiserver \
        k8s microk8s \
        kubeadm kubelet \
        ; do
        snap remove --purge "$x"
    done
    ```
  </Tab>

  <Tab label="Kylin">
    **Проверка:**

    ```bash
    for x in \
        docker docker-client docker-common \
        docker-engine docker-proxy docker-runc \
        podman-docker podman \
        containernetworking-plugins \
        apptainer \
        containerd \
        kubernetes kubernetes-master kubernetes-node kubernetes-client kubernetes-kubeadm \
        ; do
        rpm -qa | grep -F "$x"
    done
    ```

    **Удаление:**

    ```bash
    for x in \
        docker docker-client docker-common \
        docker-engine docker-proxy docker-runc \
        podman-docker podman \
        containernetworking-plugins \
        apptainer \
        containerd \
        kubernetes kubernetes-master kubernetes-node kubernetes-client kubernetes-kubeadm \
        ; do
        yum remove "$x"
    done
    ```
  </Tab>
</Tabs>

### Настройка домена поиска \{#config\_search}

В операционных системах Linux файл `/etc/resolv.conf` используется для настройки параметров разрешения имен доменов DNS клиента. Строка `search` указывает путь поиска домена для запросов DNS.

**Требования к конфигурации**

- **Количество доменов:** Количество доменов в строке `search` должно быть меньше `domainCountLimit - 3` (по умолчанию `domainCountLimit` равно 32).
- **Длина одного домена:** Каждое доменное имя не должно превышать 253 символов.
- **Общая длина символов:** Общее количество символов всех доменных имен и пробелов не должно превышать `MaxDNSSearchListChar` (по умолчанию 2048).

**Пример**

```text
search domain1.com domain2.com domain3.com
```

- Общее количество доменов – 3.
- Длина одного домена, например, `domain1.com`, составляет 11 символов.
- Общая длина символов – 35, т.е. 11 + 11 + 11 + 2 (два пробела).

<Directive type="warning" title="WARNING">
  - Если строка `search` в файле `/etc/resolv.conf` не соответствует вышеуказанным ограничениям, это может привести к сбоям в запросах DNS или ухудшению производительности.
  - Перед изменением файла `/etc/resolv.conf` рекомендуется создать резервную копию файла.
</Directive>
