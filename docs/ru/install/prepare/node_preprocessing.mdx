---
weight: 30
sourceSHA: 0a6ee3874afac62a7071ab0047813dd1b9c496e01ca0274257dec12d247e11e2
---

# Предобработка узлов

Перед установкой кластера `global` все узлы (узлы управляющего плана и рабочие узлы) должны завершить предобработку.

## Выполнение скрипта быстрой конфигурации

Установочный пакет <Term name="productShort" /> предоставляет скрипт для быстрой конфигурации узлов.

Распакуйте установочный пакет, чтобы получить файл скрипта `init.sh` в директории `res`. Скопируйте файл скрипта на узлы и убедитесь, что у вас есть права `root`.

Выполните скрипт:

```bash
bash init.sh
```

<Directive type="warning" title="ПРЕДУПРЕЖДЕНИЕ">
  Скрипт `init.sh` не может гарантировать, что все последующие проверки будут корректно выполнены. Вам все равно нужно продолжить с шагами ниже.
</Directive>

## Проверки узлов \{#node\_checks}

Следующий список включает все проверки, которые должны быть выполнены на узлах. В зависимости от роли узла, необходимые проверки будут различаться. Например, некоторые проверки применяются только к узлам управляющего плана.

Проверки разделены на две категории:

- ✅ Указывает на проверку, которая должна пройти.
- ⚠️ Указывает на проверку, которая должна быть выполнена в конкретных сценариях. Пожалуйста, определите, соответствуют ли указанные условия инструкциям. Если соответствуют, вы должны их решить.

Вот список проверок:

- **ОС и ядро**
  - ✅ Конфигурация загрузки grub на машине должна содержать параметр `transparent_hugepage=never`.
  - ✅ Конфигурация загрузки grub на машине с системой CentOS 7.x должна содержать параметр `cgroup.memory=nokmem`.
  - ✅ Проверьте, включены ли модули ядра `ip_vs`, `ip_vs_rr`, `ip_vs_wrr` и `ip_vs_sh`.
  - ⚠️ Когда версия ядра ниже 4.19.0 (или RHEL ниже 4.18.0), проверьте, включены ли модули ядра `nf_conntrack_ipv4` и (для IPv6) `nf_conntrack_ipv6`.
  - ⚠️ Если кластер `global` планирует использовать `Kube-OVN` CNI, модули ядра `geneve` и `openvswitch` должны быть включены.
  - ✅ Отключите apparmor/selinux и файрвол.
  - ✅ Отключите `swap`.

- **Пользователи и разрешения**
  - ✅ SSH-пользователь узла должен иметь права `root` и может использовать `sudo` без пароля.
  - ✅ Параметры `UseDNS` и `UsePAM` в `/etc/ssh/sshd_config` должны быть установлены в `no`.
  - ✅ Выполнение `systemctl show --property=DefaultTasksMax` должно возвращать `infinity` или очень большое значение; в противном случае отрегулируйте `/etc/systemd/system.conf`.

- **Сеть узлов**
  - ✅ `hostname` должен соответствовать следующим правилам:
    - Не более 36 символов.
    - Начинается и заканчивается буквой или цифрой.
    - Содержит только строчные буквы, цифры, `-` и `.`, но не может содержать `.-`, `..` или `-.`.
  - ✅ `localhost` в `/etc/hosts` должен разрешаться в `127.0.0.1`.
  - ✅ Файл `/etc/resolv.conf` должен существовать и содержать конфигурации `nameserver`, но не должен содержать адреса, начинающиеся с 172 (отключите systemd-resolved).
  - ⚠️ Файл `/etc/resolv.conf` не должен конфигурировать поисковые домены (если вы должны их настроить, смотрите [Настройка поискового домена](#config_search)).
  - ✅ IP-адрес машины не может быть адресом обратной связи, широковещательным, локальной связи, всем-0 или широковещательным адресом.
  - ✅ Выполнение `ip route` должно возвращать маршрут по умолчанию или маршрут, указывающий на `0.0.0.0`.
  - ✅ Узлы не должны занимать следующие порты:
    - **Узлы управляющего плана:** `2379`, `2380`, `6443`, `10249` \~ `10256`
    - **Узел, на котором расположен установщик:** `8080`, `12080`, `12443`, `16443`, `2379`, `2380`, `6443`, `10249` \~ `10256`
    - **Рабочие узлы:** `10249` \~ `10256`
  - ✅ Если кластер `global` использует **Kube-OVN** или **Calico**, убедитесь, что следующие порты не заняты:
    - **Kube-OVN:** `6641`, `6642`
    - **Calico:** `179`
  - ⚠️ Убедитесь, что IP-адреса в сетевом сегменте `172.16.x.x` \~ `172.32.x.x`, требуемые Docker, не заняты. Если IP-адреса в этом сегменте заняты и их нельзя изменить, пожалуйста, свяжитесь с технической поддержкой.

- **Требования к программному обеспечению и директориям:**
  - ✅ Должны быть установлены следующие пакеты: `ip`, `ss`, `tar`, `swapoff`, `modprobe`, `sysctl`, `md5sum` и `scp` или `sftp`.
  - ⚠️ Если вы планируете использовать локальное хранилище **TopoLVM** или **Rook**, вам нужно установить `lvm2`.
  - ✅ Файл `/etc/systemd/system/kubelet.service` не должен существовать.
  - ✅ Параметры монтирования `/tmp` не должны содержать `noexec`.
  - ✅ Удалите пакеты, конфликтующие с компонентами кластера `global` (см. [Удаление конфликтующих пакетов](#remove_conflicting_packages)).
  - ✅ Следующие файлы должны быть удалены, если они существуют:
    - `/var/lib/docker`
    - `/var/lib/containerd`
    - `/var/log/pods`
    - `/var/lib/kubelet/pki`

- **Проверки между узлами**
  - ✅ Между узлами кластера `global` не должно быть сетевых ограничений файрвола.
  - ✅ `hostname` каждого узла в кластере должен быть уникальным.
  - ✅ Часовые пояса всех узлов должны быть едиными, а ошибка синхронизации времени не должна превышать 10 секунд.

# Приложение

### Удаление конфликтующих пакетов \{#remove\_conflicting\_packages}

Перед установкой некоторые приложения могут уже работать в среде docker/containerd на узлах, или может быть установлено программное обеспечение, конфликтующее с кластером `global`. Поэтому необходимо проверить и удалить конфликтующие пакеты.

<Directive type="danger" title="ОПАСНОСТЬ">
  - Чтобы избежать остановки приложений или потери данных, обязательно подтвердите наличие конфликтующих программных пакетов. Если конфликт обнаружен, пожалуйста, разработайте план переключения приложений и создайте резервную копию ваших данных перед удалением.
  - После удаления конфликтующих пакетов вам все равно нужно проверить наличие других потенциально конфликтующих бинарных файлов в директориях, таких как `/usr/local/bin/` (например, программного обеспечения, связанного с docker, containerd, runc, podman, контейнерной сетью, временем выполнения контейнеров или Kubernetes).
</Directive>

Следующие команды могут быть использованы для справки.

<Tabs>
  <Tab label="CentOS / RedHat">
    **Проверка:**

    ```bash
    for x in \
        docker docker-client docker-common docker-latest \
        podman-docker podman \
        runc \
        containernetworking-plugins \
        apptainer \
        kubernetes kubernetes-master kubernetes-node kubernetes-client \
        ; do
        rpm -qa | grep -F "$x"
    done
    ```

    **Удаление:**

    ```bash
    for x in \
        docker docker-client docker-common docker-latest \
        podman-docker podman \
        runc \
        containernetworking-plugins \
        apptainer \
        kubernetes kubernetes-master kubernetes-node kubernetes-client \
        ; do
        yum remove "$x"
    done
    ```
  </Tab>

  <Tab label="Ubuntu">
    **Проверка:**

    ```bash
    for x in \
        docker.io \
        podman-docker \
        containerd \
        rootlesskit \
        rkt \
        containernetworking-plugins \
        kubernetes \
        ; do
        dpkg-query -l | grep -F "$x"
    done

    for x in \
        kubernetes-worker \
        kubectl kube-proxy kube-scheduler kube-controller-manager kube-apiserver \
        k8s microk8s \
        kubeadm kubelet \
        ; do
        snap list | grep -F "$x"
    done
    ```

    **Удаление:**

    ```bash
    for x in \
        docker.io \
        podman-docker \
        containerd \
        rootlesskit \
        rkt \
        containernetworking-plugins \
        kubernetes \
        ; do
        apt-get purge "$x"
    done

    for x in \
        kubernetes-worker \
        kubectl kube-proxy kube-scheduler kube-controller-manager kube-apiserver \
        k8s microk8s \
        kubeadm kubelet \
        ; do
        snap remove --purge "$x"
    done
    ```
  </Tab>

  <Tab label="Kylin">
    **Проверка:**

    ```bash
    for x in \
        docker docker-client docker-common \
        docker-engine docker-proxy docker-runc \
        podman-docker podman \
        containernetworking-plugins \
        apptainer \
        containerd \
        kubernetes kubernetes-master kubernetes-node kubernetes-client kubernetes-kubeadm \
        ; do
        rpm -qa | grep -F "$x"
    done
    ```

    **Удаление:**

    ```bash
    for x in \
        docker docker-client docker-common \
        docker-engine docker-proxy docker-runc \
        podman-docker podman \
        containernetworking-plugins \
        apptainer \
        containerd \
        kubernetes kubernetes-master kubernetes-node kubernetes-client kubernetes-kubeadm \
        ; do
        yum remove "$x"
    done
    ```
  </Tab>
</Tabs>

### Настройка поискового домена \{#config\_search}

В ОС Linux файл `/etc/resolv.conf` используется для настройки параметров разрешения доменных имен DNS клиента. Строка `search` указывает путь поиска домена для DNS-запросов.

**Требования к конфигурации**

- **Количество доменов:** Количество доменов в строке `search` должно быть меньше `domainCountLimit - 3` (по умолчанию `domainCountLimit` равно 32).
- **Длина одного домена:** Каждое имя домена не должно превышать 253 символа.
- **Общая длина символов:** Общая длина всех имен доменов и пробелов не должна превышать `MaxDNSSearchListChar` (по умолчанию 2048).

**Пример**

```text
search domain1.com domain2.com domain3.com
```

- Общее количество доменов - 3.
- Длина одного домена, такого как `domain1.com`, составляет 11.
- Общая длина символов составляет 35, т.е. 11 + 11 + 11 + 2 (два пробела).

<Directive type="warning" title="ПРЕДУПРЕЖДЕНИЕ">
  - Если строка `search` в файле `/etc/resolv.conf` не соответствует указанным ограничениям, это может привести к сбоям DNS-запросов или снижению производительности.
  - Перед изменением файла `/etc/resolv.conf` рекомендуется сделать резервную копию файла.
</Directive>
