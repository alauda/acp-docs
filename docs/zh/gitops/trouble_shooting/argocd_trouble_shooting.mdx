---
weight: 20
---

# Argo CD 常见问题

## 删除/损坏了代码仓库且无法删除应用程序，该怎么办？

当 Argo CD 无法生成清单文件时，将无法删除应用程序。您需要：

1. 恢复/修复您的代码仓库
2. 使用 `--cascade=false` 参数删除应用程序，然后手动删除相关资源

## 为什么同步成功后应用程序状态仍然是 `OutOfSync`？

请参考 [Diffing 文档](https://argo-cd.readthedocs.io/en/stable/user-guide/diff-strategies/)了解资源可能处于 OutOfSync 状态的原因，以及如何配置 Argo CD 以在预期出现差异时忽略特定字段。

## 为什么应用程序一直处于 `Progressing` 状态？

Argo CD 为多个标准 Kubernetes 类型提供健康状态检查。`Ingress`、`StatefulSet` 和 `SealedSecret` 类型存在已知问题，可能导致健康检查返回 `Progressing` 状态而不是 `Healthy` 状态：

* `Ingress`: 只有当 `status.loadBalancer.ingress` 列表非空，且至少包含一个 `hostname` 或 `IP` 值时才被视为健康。某些 Ingress 控制器（如 contour、traefik）不会更新 `status.loadBalancer.ingress` 字段，这会导致 `Ingress` 永远处于 `Progressing` 状态。
* `StatefulSet`: 只有当 `status.updatedReplicas` 字段值与 `spec.replicas` 字段值匹配时才被视为健康。
* 您的 `StatefulSet` 或 `DaemonSet` 使用了 `OnDelete` 而不是 `RollingUpdate` 策略。

作为解决方案，Argo CD 允许提供健康检查自定义配置来覆盖默认行为。

如果您使用 Traefik 作为 Ingress，可以通过更新 Traefik 配置来发布 loadBalancer IP：

```yaml
providers:
  kubernetesIngress:
    publishedService:
      enabled: true
```

## 忘记了管理员密码，如何重置？

对于 Argo CD v1.8 及更早版本，初始密码设置为服务器 pod 的名称。对于 Argo CD v1.9 及更高版本，初始密码可从名为 `argocd-initial-admin-secret` 的密钥中获取。

要更改密码，请编辑 `argocd-secret` 密钥并使用新的 bcrypt 哈希更新 `admin.password` 字段。

生成 bcrypt 哈希：
```bash
argocd account bcrypt --password <您的新密码>
```

应用新的密码哈希：
```bash
# bcrypt(password)=$2a$10$rRyBsGSHK6.uc8fntPwVIuLVHgsAhAX7TcdrqW/RADU0uh7CaChLa
kubectl -n argocd patch secret argocd-secret \
  -p '{"stringData": {
    "admin.password": "$2a$10$rRyBsGSHK6.uc8fntPwVIuLVHgsAhAX7TcdrqW/RADU0uh7CaChLa",
    "admin.passwordMtime": "'$(date +%FT%T%Z)'"
  }}'
```

## 如何禁用管理员用户？

在 `argocd-cm` ConfigMap 中添加 `admin.enabled: "false"`。

## Argo CD 在无法访问互联网的情况下无法部署基于 Helm Chart 的应用程序，如何解决？

当 Chart 具有位于外部仓库的依赖项时，Argo CD 可能无法生成 Helm Chart 清单。要解决此问题，您需要确保 `requirements.yaml` 仅使用内部可用的 Helm 仓库。即使 Chart 仅使用内部仓库的依赖项，Helm 也可能决定刷新 `stable` 仓库。作为解决方案，可以在 `argocd-cm` 配置映射中覆盖 `stable` 仓库 URL：

```yaml
data:
  repositories: |
    - type: helm
      url: http://<internal-helm-repo-host>:8080
      name: stable
```

## 使用 Argo CD 部署 Helm 应用程序后，为什么我无法通过 `helm ls` 等 Helm 命令查看它？

当部署 Helm 应用程序时，Argo CD 仅将 Helm 用作模板机制。它运行 `helm template` 然后将生成的清单部署到集群，而不是执行 `helm install`。这意味着您无法使用任何 Helm 命令来查看/验证应用程序。它完全由 Argo CD 管理。请注意，Argo CD 原生支持一些您可能在 Helm 中想要使用的功能（如历史记录和回滚命令）。

## 已配置集群密钥，但它在 CLI/Argo CD Dashboard 中不可见，如何修复？

检查集群密钥是否具有 `argocd.argoproj.io/secret-type: cluster` 标签。如果密钥有标签但集群仍然不可见，则可能是权限问题。尝试使用 `admin` 用户列出集群（例如：`argocd login --username admin && argocd cluster list`）。

## 如何终止同步操作？

要终止同步，请点击"同步"然后点击"终止"。

## 为什么应用程序在同步后仍显示 `Out Of Sync`状态？

在某些情况下，您使用的工具可能会通过添加 `app.kubernetes.io/instance` 标签与 Argo CD 发生冲突。例如，使用 Kustomize 通用标签功能时。

Argo CD 自动设置 `app.kubernetes.io/instance` 标签并使用它来确定哪些资源构成应用程序。如果工具也这样做，就会造成混淆。您可以通过在 `argocd-cm` 中设置 `application.instanceLabelKey` 值来更改此标签。我们建议使用 `argocd.argoproj.io/instance`。

:::warning
注意：进行此更改时，您的应用程序将变为不同步状态，需要重新同步。
:::

## Argo CD 多久检查一次 Git 或 Helm 仓库的变更？

默认轮询间隔为 3 分钟（180 秒），可配置轮询间隔。您可以通过更新 argocd-cm 配置映射中的 `timeout.reconciliation` 值和 `timeout.reconciliation.jitter` 来更改设置。如果有任何 Git 更改，Argo CD 将仅更新启用了自动同步设置的应用程序。如果将其设置为 `0`，则 Argo CD 将停止自动轮询 Git 仓库，您只能使用其他方法（如 webhook 和/或手动同步）来部署应用程序。

## 如何修复 `invalid cookie, longer than max length 4093` 错误？

Argo CD 使用 JWT 作为身份验证令牌。您可能属于许多组，超过了为 cookie 设置的 4KB 限制。您可以通过打开"开发者工具 -> 网络"获取组列表：

1. 登录 Argo CD Dashboard [如何获取 Argo CD Dashboard 登录地址]
2. 找到对 `<argocd_instance>/auth/callback?code=<random_string>` 的调用

在 https://jwt.io/ 解码令牌。这将提供您可以退出的团队列表。

## 使用 CLI 时为什么会收到 `rpc error: code = Unavailable desc = transport is closing` 错误？

也许您在不支持 HTTP 2 的代理后面？尝试使用 `--grpc-web` 标志：

```bash
argocd ... --grpc-web
```

## 使用 CLI 时为什么会收到 `x509: certificate signed by unknown authority` 错误？

Argo CD 默认创建的证书不会被 Argo CD CLI 自动识别。要创建安全系统，您必须按照说明安装证书并配置客户端操作系统信任该证书。

如果您不是在生产系统中运行（例如，您正在测试 Argo CD），请尝试使用 `--insecure` 标志：

```bash
argocd ... --insecure
```

警告：请勿在生产环境中使用 `--insecure`。

## 如何轮换 Redis 密钥？

1. 删除 Argo CD 安装命名空间中的 `argocd-redis` 密钥：
```bash
kubectl delete secret argocd-redis -n <argocd 命名空间>
```

2. 如果您正在运行 HA 模式的 Redis，重启 HA Redis：
```bash
kubectl rollout restart deployment argocd-redis-ha-haproxy
kubectl rollout restart statefulset argocd-redis-ha-server
```

3. 如果您运行的是非 HA 模式的 Redis，重启 Redis：
```bash
kubectl rollout restart deployment argocd-redis
```

4. 重启其他组件：
```bash
kubectl rollout restart deployment argocd-server argocd-repo-server
kubectl rollout restart statefulset argocd-application-controller
```

## 如何修复 `Manifest generation error (cached)` 错误？

`Manifest generation error (cached)` 表示生成清单时出现错误，并且该错误消息已被缓存以避免无限重试。

执行硬刷新（忽略缓存的错误）可以解决临时问题。但如果清单生成失败有持续存在的原因，硬刷新将无法解决问题。

相反，请尝试在 repo-server 日志中搜索应用程序名称，以识别导致清单生成失败的错误。

## 如何修复 `field not declared in schema` 错误？

对于某些功能，Argo CD 依赖于内置 Kubernetes 资源类型的静态（硬编码）架构集。

如果您的清单使用了硬编码架构中不存在的字段，您可能会收到类似 `field not declared in schema` 的错误。

架构版本基于 Argo CD 构建所依赖的 Kubernetes 库版本。要解决此问题，您可以：

1. 升级到包含支持所需字段的静态架构的 Argo CD 版本。
2. 避免使用依赖静态架构的功能：
   - 禁用带有 `managedFieldsManagers` 的 `ignoreDifferences`
   - 禁用服务器端应用
   - 使用服务器端差异时禁用变更 webhook
``` 