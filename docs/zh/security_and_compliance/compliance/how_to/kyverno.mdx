---
weight: 10
---

# Kyverno 使用实践

## 功能简介

Kyverno 是一个基于策略引擎的 Kubernetes 原生合规管理工具。它能够帮助您对集群中的资源创建、更新和删除操作进行细粒度的控制和验证，通过预定义的安全策略和合规策略，实现对集群资源的统一管理和合规性检查。

## 使用场景

- 需要对集群资源进行安全控制和合规检查
- 想要实施自定义的资源准入策略
- 需要统一管理和执行组织的安全规范
- 需要对多集群配置进行合规性验证
- 需要实时监控和审计资源变更

## 前置条件

使用 Kyverno 前，需确保：

- 已经安装了 Kubernetes 集群
- 具有集群管理员权限
- 已经在集群中安装了 Kyverno 插件
- 了解基本的 Kubernetes 资源概念
- 已准备好用于存储合规策略的 Git 仓库

## 操作步骤

### 1. 安装 Kyverno 插件

1. **在 Customer Portal 中找到《Kyverno插件安装》文档（后面要引用到快速开始里），**
2. 按照文档指引完成插件部署


### 2. 创建合规策略

Kyverno 支持多种类型的策略，以下是一些常见的策略示例：

#### 2.1 禁止特权容器

```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-privileged-containers
spec:
  validationFailureAction: Audit
  rules:
  - name: privileged-containers
    match:
      resources:
        kinds:
        - Pod
    validate:
      message: "Privileged mode is disallowed."
      pattern:
        spec:
          containers:
          - name: "*"
            securityContext:
              privileged: false
```

#### 2.2 强制设置资源限制

```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-resource-limits
spec:
  validationFailureAction: Audit
  rules:
  - name: validate-resources
    match:
      resources:
        kinds:
        - Pod
    validate:
      message: "Resource limits are required"
      pattern:
        spec:
          containers:
          - resources:
              limits:
                memory: "?*"
                cpu: "?*"
```

#### 2.3 强制使用 HTTPS

```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-tls-ingress
spec:
  validationFailureAction: Enforce
  rules:
  - name: check-tls
    match:
      resources:
        kinds:
        - Ingress
    validate:
      message: "TLS configuration is required for Ingress"
      pattern:
        spec:
          tls:
          - hosts:
            - "?*"
```

### 3. 验证策略生效

1. 创建测试资源
   ```bash
   kubectl run test-pod --image=nginx:latest --privileged
   ```

2. 查看策略验证结果
   ```bash
   kubectl describe pod test-pod
   ```

3. 检查审计日志
   ```bash
   kubectl logs -n kyverno -l app=kyverno
   ```

参数说明如下：

| **参数** | **说明** | **示例值** |
| -------- | -------- | ---------- |
| validationFailureAction | 策略验证失败时的处理方式 | Audit（审计）/ Enforce（强制） |
| rules.match.resources.kinds | 策略适用的资源类型 | Pod, Deployment, Service |
| rules.validate.pattern | 验证规则的具体模式 | 资源配置模式 |
| securityContext.privileged | 容器特权模式设置 | true/false |
| rules.validate.message | 验证失败时的提示信息 | "Resource limits are required" |

## 操作结果

完成配置后，您可以：
- 通过创建测试资源验证策略是否生效
- 在 Kubernetes 事件中查看策略执行记录
- 通过 Kyverno 审计日志查看违规情况
- 在合规管理面板中查看策略详情和违规资源

### 策略验证方法

1. 查看策略状态
   ```bash
   kubectl get clusterpolicy
   ```

2. 检查策略详情
   ```bash
   kubectl describe clusterpolicy <policy-name>
   ```

3. 查看违规报告
   ```bash
   kubectl get policyreport -A
   ```

## 了解更多

### 常用合规策略

| 优先级 | 策略名称 | 用途 | 安全影响 |
|-------|---------|------|----------|
| P0 | disallow-privileged-containers | 禁止特权容器 | 防止容器逃逸 |
| P0 | restrict-host-namespaces | 禁止使用主机命名空间 | 确保容器隔离 |
| P1 | require-run-as-non-root | 禁止以 root 用户运行 | 降低权限滥用风险 |
| P1 | disallow-capabilities | 限制容器 Capabilities | 控制容器权限范围 |
| P2 | require-probes | 强制配置健康检查 | 确保容器健康监控 |
