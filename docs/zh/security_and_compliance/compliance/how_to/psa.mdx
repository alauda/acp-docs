---
weight: 10
---

# Kubernetes PSA 使用实践

## 功能简介

Kubernetes Pod Security Admission (PSA) 是 Kubernetes 1.23 版本引入的一个内置的准入控制器，用于在 Pod 创建和更新时强制执行 Pod 安全标准。它提供了一种原生的、简单的方式来确保集群中的 Pod 遵循预定义的安全策略，无需安装额外的第三方工具。

## 主要功能

- **三级安全配置**：提供 Privileged（特权）、Baseline（基线）和 Restricted（受限）三个级别的安全配置
- **命名空间级别的策略控制**：通过命名空间标签实现策略配置
- **多模式支持**：包括 enforce（强制执行）、audit（审计）和 warn（警告）三种模式
- **版本控制**：支持不同版本的安全标准，确保向后兼容性

## 功能优势

- **原生集成**：作为 Kubernetes 的内置功能，无需额外安装和维护
- **简单易用**：通过简单的标签配置即可实现安全策略管理
- **标准化**：提供统一的安全标准定义，便于跨集群管理
- **灵活性**：支持多种执行模式，可根据需求逐步实施
- **可扩展性**：支持未来版本的安全标准更新

## 安全级别说明

### Privileged（特权模式）

- **定义**：不对 Pod 进行任何限制
- **使用场景**：系统和基础设施级别的工作负载
- **风险等级**：高
- **配置示例**：
  ```yaml
  apiVersion: v1
  kind: Namespace
  metadata:
    name: privileged-ns
    labels:
      pod-security.kubernetes.io/enforce: privileged
  ```

### Baseline（基线模式）

- **定义**：防止已知的权限提升
- **使用场景**：常规应用工作负载
- **风险等级**：中
- **限制项目**：
  - 禁止特权容器
  - 禁止共享主机命名空间
  - 禁止特权端口
- **配置示例**：
  ```yaml
  apiVersion: v1
  kind: Namespace
  metadata:
    name: baseline-ns
    labels:
      pod-security.kubernetes.io/enforce: baseline
      pod-security.kubernetes.io/audit: baseline
      pod-security.kubernetes.io/warn: baseline
  ```

### Restricted（受限模式）

- **定义**：实施强制的安全控制
- **使用场景**：安全敏感的应用
- **风险等级**：低
- **限制项目**：
  - 包含所有 Baseline 限制
  - 必须以非 root 用户运行
  - 必须设置 seccomp 配置文件
  - 禁止使用不安全的功能
- **配置示例**：
  ```yaml
  apiVersion: v1
  kind: Namespace
  metadata:
    name: restricted-ns
    labels:
      pod-security.kubernetes.io/enforce: restricted
      pod-security.kubernetes.io/audit: restricted
      pod-security.kubernetes.io/warn: restricted
  ```

## 操作步骤

### 1. 配置命名空间安全策略

1. 创建新的命名空间并配置安全策略：
   ```bash
   kubectl create namespace secure-ns
   kubectl label namespace secure-ns \
     pod-security.kubernetes.io/enforce=restricted \
     pod-security.kubernetes.io/audit=restricted \
     pod-security.kubernetes.io/warn=restricted
   ```

2. 查看命名空间的安全策略配置：
   ```bash
   kubectl get ns secure-ns --show-labels
   ```

### 2. 验证安全策略

1. 尝试创建特权容器：
   ```bash
   kubectl run nginx --image=nginx --privileged -n secure-ns
   ```

2. 创建符合安全策略的 Pod：
   ```yaml
   apiVersion: v1
   kind: Pod
   metadata:
     name: secure-pod
     namespace: secure-ns
   spec:
     securityContext:
       runAsNonRoot: true
       seccompProfile:
         type: RuntimeDefault
     containers:
     - name: nginx
       image: nginx
       securityContext:
         allowPrivilegeEscalation: false
         capabilities:
           drop: ["ALL"]
   ```

### 3. 监控和审计

1. 查看策略违规事件：
   ```bash
   kubectl get events -n secure-ns
   ```

2. 检查 Pod 安全策略状态：
   ```bash
   kubectl describe pod <pod-name> -n secure-ns
   ```

参数说明如下：

| **标签** | **说明** | **可选值** |
|----------|----------|------------|
| pod-security.kubernetes.io/enforce | 强制执行的安全级别 | privileged/baseline/restricted |
| pod-security.kubernetes.io/audit | 审计日志的安全级别 | privileged/baseline/restricted |
| pod-security.kubernetes.io/warn | 警告信息的安全级别 | privileged/baseline/restricted |

## 操作结果

完成配置后，您可以：
- 确保新创建的 Pod 符合指定的安全标准
- 通过事件日志监控安全策略违规情况
- 在不同命名空间实施不同级别的安全策略
- 逐步提升集群的安全性