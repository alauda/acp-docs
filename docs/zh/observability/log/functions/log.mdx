---
weight: 20
---

# 日志

## 日志查询分析

在运维中心的日志查询分析面板中，可查看登录账号权限内的标准输出（stdout）日志，包括系统日志、产品日志、Kubernetes 日志、应用日志，通过日志可了解资源的运行情况。

支持通过日志查询条件筛选指定时间范围内（选择或自定义）的日志，并通过柱状图以及标准输出展示日志查询结果。

:::warning
出于性能考虑，平台一次最多可展示 10000 条日志，当一段时间内平台的日志量过大时，请缩小查询的时间范围分阶段查询日志。
:::

### 搜索日志
平台会采集并保存系统日志、产品日志、Kubernetes 日志、自定义应用日志，平台管理员或运维人员，可通过日志功能模块管理日志保留策略、查看分类日志并导出日志。

    - **系统日志**：宿节点上的日志，例如：dmesg、syslog/messages、secure 等。
    - **产品日志**：平台自身的组件以及平台集成的第三方组件的日志，例如：Container-Platform、Platform-Center、DevOps、Service-Mesh 等。
    - **Kubernetes 日志**：Kubernetes 容器编排相关组件的日志，以及 kubelet、kubeproxy 和 docker 产生的日志，如：docker、kube-apiserver，kube-controller-manager、etcd 等。
    - **应用日志**：业务应用的日志，含文件日志和标准输出日志

1. 在左侧导航栏中，单击 **运维中心** > **日志** > **日志查询分析**。  

3. 设置过滤条件（项目、集群、命名空间）、查询条件后单击 **搜索**。

:::tip
    
    - **日志类型** 不同时，可选择的日志过滤条件、查询条件不同。
    
    - 支持选择或输入多个查询条件标签，不同资源类型的查询条件之间是 and 关系，同资源类型之间的多个条件之间是 or 的关系。例如：查询条件为 `podname:pod1`、`podname:pod2`、`nodename:a1`、`search:Keyword`，搜索结果为 a1 节点上 Pod 名称为 pod1、pod2 的日志，且仅查询含有 Keyword 的日志。
    
    - 仅关键字查询条件支持模糊搜索。
   
    - 柱状图显示了当前查询时间范围内的日志总条数和不同时间节点的日志条数。单击柱状图的某个柱体，查看这个柱状图和下一个柱状图之间的时间范围内的日志。
    
:::

### 导出日志数据

页面最多展示 10000 条日志数据，当查询得到的日志条数过多时，可通过导出日志功能，查看最多 100 万条日志信息。
    
1. 单击柱状图右上角的 **导出**，在弹出的导出日志对话框中配置以下参数。

    - **范围**：日志导出的范围，可选择 **当前页** 或 **全部结果**。
        - **当前页**：仅导出当前页的查询结果，最多 1000 条。
        - **全部结果**：导出满足当前查询条件的所有日志数据，最多 100 万条。

    - **字段**：日志的显示字段，可通过单击字段名称右侧的复选框，选择在导出的日志文件中显示哪些字段信息。

        **说明**：日志类型不同，则可选的显示字段不同，请根据实际需求选择。

    - **格式**：日志文件的导出格式，支持选择 `txt` 或 `csv`，并使用 `.gzip` 压缩格式导出。

2. 单击 **导出**，浏览器会直接下载压缩文件至本机。

### 查看日志上下文
   
1. 双击日志内容区域后，当前对话框中会展示当前日志打印时间前、后各 5 条日志，便于运维人员更详细的了解资源产生当前日志的原因。

2. 支持设置日志上下文的显示字段或导出日志上下文，导出日志上下文时无需选择 **范围**，单击 **导出** 按钮后会通过浏览器将日志上下文文件直接下载至本地。

## 管理应用日志保留时间

未设置项目策略时，平台上应用日志的保留时间为应用所在集群部署 **日志采集组件** 时所选的 ***存储集群*** 上部署的 **日志存储插件** 的 `应用日志保留时间`。

您可通过添加并管理项目日志策略，差异化设置项目下 **应用日志** 在平台上的保留时间。

:::tip
项目策略仅对具体项目下的 **应用日志** 生效。设置项目策略后，项目下所有应用日志的保留时间以项目策略为准。
:::

### 平台管理员设置项目策略

1. 在左侧导航栏中，单击单击 **运维中心** > **日志** > **策略管理**。

2. 单击 **添加项目策略**。

3. 单击 **项目** 下拉选择框，选择一个项目。
        
4. 设置 **日志保留时间**。

    - 计数器左右两侧的 `-`/`+`，减少/增加保留天数，或直接在计数器中输入数值，平台支持设置的保留时间范围为 1~30 天。
    - 当输入的数值为小数时，将向上取整为整数；当输入的数值小于 1 时，取整为 1 且 `-` 不支持单击；当输入的数值大于 30 时，取整为 30 且 `+` 不支持单击。    
        
5. 单击 **添加**。

### 项目管理员自行设置项目策略

1、进入本项目的项目详情页面

2、点击日志策略字段后的修改按钮，在弹窗中开启日志策略。

3、设置 **日志保留时间**。

    - 计数器左右两侧的 `-`/`+`，减少/增加保留天数，或直接在计数器中输入数值，平台支持设置的保留时间范围为 1~30 天。
    - 当输入的数值为小数时，将向上取整为整数；当输入的数值小于 1 时，取整为 1 且 `-` 不支持单击；当输入的数值大于 30 时，取整为 30 且 `+` 不支持单击。  

### 通过 CLI 设置项目策略

1、登录 global 集群 执行以下指令：

    ```bash
    kubectl edit project <项目名称>
    ```

2、按如下示例修改 yaml 保存后提交

    ```yaml
    apiVersion: auth.alauda.io/v1
    kind: Project
    metadata:
    annotations:
        cpaas.io/creator: mschen1@alauda.io
        cpaas.io/description: ""
        cpaas.io/display-name: ""
        cpaas.io/operator: leizhuc
        cpaas.io/project.esPolicyLastEnabledTimestamp: "2025-02-18T09:53:54Z"
        cpaas.io/updated-at: "2025-02-18T09:53:54Z"
    creationTimestamp: "2025-02-13T08:19:11Z"
    finalizers:
    - namespace
    generation: 1
    labels:
        cpaas.io/project: bookinfo
        cpaas.io/project.esIndicesKeepDays: "7" # 项目下应用日志保存时长
        cpaas.io/project.esPolicyEnabled: "true" # 开启项目策略
        cpaas.io/project.id: "95447321"
        cpaas.io/project.level: "1"
        cpaas.io/project.parent: ""
    name: bookinfo
    ### 更多yaml信息不涉及修改，省略
    ```
## 配置部分应用日志不采集

当您仅需实时查看集群中某些应用的 **实时日志**，而不希望存储这些日志（采集器会丢弃相应的日志）时，您可参考本节内容，设置停止采集的应用日志的范围（集群、命名空间、Pod），实现细粒度的应用日志采集控制。

### 停止采集集群下所有应用日志

您可通过更新集群的 **日志采集组件** 的 **配置参数**，关闭 **应用日志** 采集开关，统一更新该集群的日志采集范围。当关闭某类型日志的采集开关后，将停止采集当前集群上该类型的所有日志。

### 停止采集指定命名空间下应用日志


通过为指定命名空间添加 `cpaas.io/log.mute=true` 标签，即可关闭该命名空间的应用日志采集开关，停止采集该命名空间下所有 Pod 的标准输出日志及文件日志。

可选配置方式如下：


* **命令行方式**：登录集群的任一控制节点后，执行以下命令行更新命名空间的标签。

    ```bash
    kubectl label namespace <命名空间名称> cpaas.io/log.mute=true
    ```

* **界面操作方式**：在 **项目管理** 视图，更新命名空间的标签。

    1. 在 **项目管理** 视图的项目列表中，单击命名空间所在的 ***项目名称***。
    
    1. 在左侧导航栏中，单击 **命名空间** > **命名空间**。
    
    2. 单击待更新标签的 ***命名空间名称***。

    3. 在 **详情信息** 页签下，单击 **标签** 右侧的操作按钮
    
    4. 添加标签（键：`cpaas.io/log.mute`，值：`true`）或修改已存在标签的值后，单击 **更新**。


### 停止采集 Pod 日志

通过为指定 Pod 添加 `cpaas.io/log.mute=true` 标签，即可关闭该 Pod 的日志采集开关，停止采集该 Pod 的标准输出日志及文件日志。

登录集群的任一控制节点后，执行以下命令行更新 Pod 的标签。

```bash
kubectl label pod <Pod 名称＞ -n <Namespace 名称＞ cpaas.io/log.mute=true
```

**说明**：若 Pod 属于计算组件（WorkLoad），可通过更新计算组件（**部署**、**有状态副本集**、**守护进程集**、**任务**、**定时任务**）的标签统一更新计算组件下所有 Pod 的标签，且标签不会因为 Pod 重建而丢失。

可通过以下方式更新计算组件的标签。

1. 在 **Container Platform** 产品视图中，单击顶部导航栏切换至 Pod 所在命名空间。
    
1. 在左侧导航栏中，单击 **计算组件** > ***Pod 所属计算组件类型***。
    
2. 单击待更新标签计算组件右侧的操作按钮 > **更新**。

3. 在右上角单击 **YAML**，切换至 YAML 编辑视图。

4. 在 **spec.template.labels** 字段下，增加 `cpaas.io/log.mute: 'true'` 标签。

    示例如下：
    
    ```yaml
    spec:
      template:
        metadata:
          namespace: tuhao-test
          creationTimestamp: null
          labels:
            app: spilo
            cpaas.io/log.mute: 'true'
            cluster-name: acid-minimal-cluster
            role: exporter
            middleware.instance/name: acid-minimal-cluster
            middleware.instance/type: PostgreSQL
    ```
4. 单击 **更新**。

