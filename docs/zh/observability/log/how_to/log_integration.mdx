---
weight: 20
---

# 如何对接外部 ES 存储集群

您可通过编写 YAML 的方式，对接外部的 Elasticsearch 集群或 Kafka 集群。您可以根据实际业务需要，仅对接外部的 Elasticsearch 集群（在当前集群部署 Kafka）或同时对接外部的 Elasticsearch 集群及 Kafka 集群。

:::tip

对接外部 Elasticsearch 支持的版本如下：
- Elasticsearch 6.x 支持 6.6 - 6.8；
- Elasticsearch 7.x 支持 7.0 - 7.10.2，推荐使用 7.10.2。

:::

## 资源准备

在对接前，您需准备对接所需的凭证信息。

1. 在左侧导航栏中，单击 **集群管理** > **资源管理**，切换至需要部署插件的集群。

2. 单击 **创建资源对象**，根据代码注释内容修改参数后填写至代码框中。

* 对接外部 Elasticsearch 需使用的凭据：

    ```yaml
	apiVersion: v1
	type: Opaque
	data:
	  password: dEdWQVduSX5kUW1mc21acg==  # 需经过 base64 加密，参考命令：echo -n <password_value>| base64
	  username: YWRtaW4=                  # 需经过 base64 加密，参考命令：echo -n <username_value>| base64
	kind: Secret
	metadata:
	  name: elasticsearch-basic-auth      # 凭据名称，需保证在日志存储 yaml 中 elasticsearch.basicAuthSecretName 的值与本参数一致
	  namespace: cpaas-system             # Elasticsearch 组件所在的命名空间，一般为 cpaas-system
    ```

* 若您需使用外部的 Kafka 集群，则需要同时创建用于对接外部的 Kafka 集群的凭据：

    ```yaml
	apiVersion: v1
	type: Opaque
	data:
	  password: dEdWQVduSX5kUW1mc21acg==  # 需经过 base64 加密，参考命令：echo -n <password_value>| base64
	  username: YWRtaW4=                  # 需经过 base64 加密，参考命令：echo -n <username_value>| base64
	kind: Secret
	metadata:
	  name: kafka-basic-auth              # 凭据名称，需保证在日志存储 yaml 中 kafka.basicAuthSecretName 的值与本参数一致
	  namespace: cpaas-system             # Kafka 组件所在的命名空间，一般为 cpaas-system
    ```

3. 单击 **创建**。

## 操作步骤

1. 在左侧导航栏中，单击 **应用商店** > **插件管理**。

2. 顶部导航选择待部署Log Storage with ElasticSearch 插件的 ***集群名称***。

3. 单击 **Log Storage with ElasticSearch ** 右侧的操作按钮 > **部署**。

4. 开启 **对接外部 Elasticsearch** 开关，配置 YAML 文件，对接示例及参数说明如下：

* 对接外部的 Elasticsearch 集群，并在当前集群上部署 Kafka：

    ```yaml
    elasticsearch:
      install: false
      address: http://fake:9200                # 外部 es 访问地址，例如：http://192.168.143.252:11780/es_proxy
      basicAuthSecretName: elasticsearch-basic-auth # 前提条件中创建的对接外部 Elasticsearch 需使用的凭据
    storageClassConfig:
      type: "LocalVolume"   # 默认LocalVolume，分为”LocalVolume“、”StorageClass“
    kafka:
      auth: true                               # 是否开启认证
      k8sNodes:
      - log1                                   # 节点名称，kubectl get nodes 获取的名称
      - log2
      - log3
      storageSize: 10                          # 存储大小，单位 Gi，默认 10 Gi
    ```

* 对接外部的 Elasticsearch 集群及外部的 Kafka 集群：

    ```yaml
    elasticsearch:
      install: false
      address: http://fake:9200                # 外部 es 访问地址，例如：  http://192.168.143.252:11780/es_proxy
      basicAuthSecretName: elasticsearch-basic-auth # 前提条件中创建的对接外部 Elasticsearch 需使用的凭据
    kafka:
      auth: true                               # 是否开启认证
      install: false
      basicAuthSecretName: kafka-basic-auth  # 前提条件中创建的对接外部的 Kafka 集群需使用的凭据
      address: 192.168.130.169:9092,192.168.130.187:9092,192.168.130.193:9092     # kafka 访问地址，英文逗号分割
    ```
