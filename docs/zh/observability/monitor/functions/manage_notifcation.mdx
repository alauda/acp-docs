---
weight: 30
---

# 管理通知

## 功能简介

借助通知，您可结合平台的监控告警功能，将平台的预警信息及时发送给通知对象，以提醒相关人员采取必要的措施解决问题或避免故障发生。

## 主要功能

- **通知服务器**：通知服务器用于为平台提供向通知联系组发送通知消息的服务，例如：邮箱服务器。
- **通知联系组**：通知联系组是一组具有相同逻辑特征的通知对象，是接受通知消息的一类实体，可以减轻您的维护负担。
- **通知模板**：通知模板是一个由自定义内容、内容变量和内容格式参数组成的标准化的结构体。用于为通知策略，标准化定制告警通知消息的内容及格式。例如：自定义邮件通知的主题和内容。
- **通知策略**：通知策略是一个用于定义如何向特定联系对象发送通知消息的规则集合。告警、巡检、登录认证等需要通知到外部服务的场景都需要使用通知策略发送通知

## 通知服务器

通知服务器用于为平台提供向通知对象发送通知消息的服务。平台目前支持如下通知服务器：

- **企业通讯工具服务器**：支持对接企业微信、钉钉、飞书内置应用发送到个人。
- **邮件服务器**：使用邮件服务器发送邮件进行通知。
- **Webhook 类型服务器**： 可以支持对接企业微信群机器人、钉钉群机器人、飞书群机器人、或者发送 WebHook 到您指定的服务器。

:::warning
仅支持添加一个企业通讯工具服务器。
:::

### 企业通讯工具服务器

**企业微信**

1. 按如下示例配置通知服务器参数，参数填写完成后，在 **集群管理** > **资源管理** 中，切换至 global 集群，并创建资源对象。

    ```yaml
    # 企业微信corpId、corpSecret、agentId 获取方式可参考官方文档：https://developer.work.weixin.qq.com/document/path/90665
    apiVersion: v1
    kind: Secret
    type: NotificationServer
    metadata:
      labels:
        cpaas.io/notification.server.type: CorpWeChat
        cpaas.io/notification.server.category: Corp
      name: platform-corp-wechat-server
      namespace: cpaas-system
    data:
      displayNameZh: 企业微信            # 服务器中文显示名称，默认用base64进行编码
      displayNameEn: WeChat             # 服务器英文英文显示名称，默认用base64进行编码
      corpId:                           # 企业id，默认用base64进行编码
      corpSecret:                       # 应用秘钥，默认用base64进行编码
      agentId:                          # 企业应用id，默认用base64进行编码
    ```

2. 创建完成后，您须在平台的 **用户角色管理** > **用户管理** 或者 用户的 **个人信息** 中，更新用户的 **企业微信 id**，确保用户可以正常获取消息。

**钉钉**

1. 按如下示例配置通知服务器参数，参数填写完成后，在 **集群管理** > **资源管理** 中，切换至 global 集群，并创建资源对象。

    ```yaml
    # 钉钉 appKey、appSecret、agentId 获取方式：https://open-dev.dingtalk.com/fe/app#/corp/app
    apiVersion: v1
    kind: Secret
    type: NotificationServer
    metadata:
      labels:
        cpaas.io/notification.server.type: CorpDingTalk
        cpaas.io/notification.server.category: Corp
      name: platform-corp-dingtalk-server
      namespace: cpaas-system
    data:
      displayNameZh: 钉钉                # 服务器中文显示名称，默认用base64进行编码
      displayNameEn: DingTalk           # 服务器英文英文显示名称，默认用base64进行编码
      appKey:                           # 应用key，默认用base64进行编码
      appSecret:                        # 应用秘钥，默认用base64进行编码
      agentId:                          # 应用agent_id，默认用base64进行编码
    ```

2. 创建完成后，您须在平台的 **用户角色管理** > **用户管理** 或者 用户的 **个人信息** 中，更新用户的 **钉钉 id**，确保用户可以正常获取消息。


**飞书**

1. 按如下示例配置通知服务器参数，参数填写完成后，在 **集群管理** > **资源管理** 中，切换至 global 集群，并创建资源对象。

    ```yaml
    # 飞书 appId、appSecret 获取方式：https://open.feishu.cn/app/
    apiVersion: v1
    kind: Secret
    type: NotificationServer
    metadata:
      labels:
        cpaas.io/notification.server.type: CorpFeishu
        cpaas.io/notification.server.category: Corp
      name: platform-corp-feishu-server
      namespace: cpaas-system
    data:
      displayNameZh: 飞书                 # 服务器中文显示名称，默认用base64进行编码
      displayNameEn: Feishu             # 服务器英文英文显示名称，默认用base64进行编码
      appId:                            # 应用id，默认用base64进行编码
      appSecret:                        # 应用秘钥，默认用base64进行编码
    ```

2. 创建完成后，您须在平台的 **用户角色管理** > **用户管理** 或者 用户的 **个人信息** 中，更新用户的 **飞书 id**，确保用户可以正常获取消息。

### 邮件服务器

1. 在左侧导航栏中，单击 **平台设置** > **通知服务器**。

2. 单击 **立即配置**。
    
3. 参考以下说明，配置相关参数。

    | 参数 | 描述 |
    | ---- | ---- |
    | **服务地址** | 支持 SMTP 协议的通知服务器地址。例如：`smtp.yeah.net`。|
    |**端口**|通知服务器的端口号。当勾选了 **使用 SSL** 时，端口号需要输入 SSL 端口号。|
    |**服务器配置**|**使用 SSL**：安全套接字层（SSL）是一种标准安全技术，使用 SSL 开关用来控制是否在服务器和客户端之间建立加密链接。<br />**跳过非安全验证**：非安全验证（insecureSkipVerify）开关用来控制是否校验客户端证书和服务器主机名。如果打开开关，则不会校验证书以及证书中的主机名和服务器主机名是否一致。|
    |**发送人邮箱**| 通知服务器中的发送人邮箱账号，该账号用于发送通知邮件。 |
    |**启用认证**|如需启用认证，请配置邮箱服务器的用户名和授权码。|

6. 单击 **确定**。


### Webhook 类型服务器

可以支持对接企业微信群机器人、钉钉群机器人、飞书群机器人，或者直接发送 HTTP 请求至到您指定的 Webhook 服务器。

**企业微信群机器人**

1. 在左侧导航栏中单击 **集群管理** > **集群**。

2. 单击 global 集群右侧的操作按钮> **CLI 工具**。

3. 在 global 集群的 master 节点执行如下命令：

    ```bash
    kubectl patch secret -n cpaas-system platform-wechat-server -p '{"data":{"enable":"dHJ1ZQo="}}'
    ```
    
    **提示**：`dHJ1ZQo=`是 true 的 base6 4编码值，如需关闭，替换 `dHJ1ZQo=`为`ZmFsc2UK`，`ZmFsc2UK` 是 false 的 base64 编码值。

**钉钉群机器人**

1. 在左侧导航栏中单击 **集群管理** > **集群**。

2. 单击 global 集群右侧的操作按钮> **CLI 工具**。

3. 在 global 集群的 master 节点执行如下命令：

    ```bash
    kubectl patch secret -n cpaas-system platform-dingtalk-server -p '{"data":{"enable":"dHJ1ZQo="}}'
    ```
    
    **提示**：`dHJ1ZQo=`是 true 的 base6 4编码值，如需关闭，替换 `dHJ1ZQo=`为`ZmFsc2UK`，`ZmFsc2UK` 是 false 的 base64 编码值。

**飞书群机器人**

1. 在左侧导航栏中单击 **集群管理** > **集群**。

2. 单击 global 集群右侧的操作按钮> **CLI 工具**。

3. 在 global 集群的 master 节点执行如下命令：

    ```bash
    kubectl patch secret -n cpaas-system platform-feishu-server -p '{"data":{"enable":"dHJ1ZQo="}}'
    ```
    
    **提示**：`dHJ1ZQo=`是 true 的 base6 4编码值，如需关闭，替换 `dHJ1ZQo=`为`ZmFsc2UK`，`ZmFsc2UK` 是 false 的 base64 编码值。

**Webhook 服务器**

1. 在左侧导航栏中单击 **集群管理** > **集群**。

2. 单击 global 集群右侧的操作按钮> **CLI 工具**。

3. 在 global 集群的 master 节点执行如下命令：

    ```bash
    kubectl patch secret -n cpaas-system platform-webhook-server -p '{"data":{"enable":"dHJ1ZQo="}}'
    ```
    
    **提示**：`dHJ1ZQo=`是 true 的 base6 4编码值，如需关闭，替换 `dHJ1ZQo=`为`ZmFsc2UK`，`ZmFsc2UK` 是 false 的 base64 编码值。


## 通知联系组 \{#recipient}

通知联系组是一组具有相同逻辑特征的通知对象，是接受通知消息的一类实体。例如您可以将某个运维小组设置为一个通知联系组，以方便您在配置通知策略时快速选择和管理。

:::info

1. 平台支持多种通知服务器，对应的通知类型的通知方式配置项将会随着通知服务器的配置而展示。
2. 如果您需要使用 Webhook 类型服务器作为通知对象，您必须要将相关地址配置在通知联系组上。

:::

1. 在左侧导航栏中，单击 **运维中心** > **通知**。

2. 切换至 **通知联系组** 标签页。

3. 单击 **创建通知联系组**，参考以下说明，配置相关参数。

    | 参数 | 说明 |
    | ---- | ---- |
    |**邮箱**|   为整个通知联系组添加邮箱，平台发送邮件通知时，将发送通知至该邮箱和组内所有联系人的邮箱。 |
    |**Webhook URL/微信群机器人/钉钉群机器人/飞书群机器人| 请根据已配置的通知服务器填写对应的通知方式的 URL，配置完成后，该组下的联系人将使用此方式通知进行通知。|
    |**联系人配置**|  单击 **添加联系人**，将平台已有用户添加至联系组，请确保所选联系人的联系方式（电话，邮箱，接口回调）的准确性，否则会收不到消息通知。|

4. 单击 **添加**。    

## 通知模板 \{#template}

通知模板是一个由自定义内容、内容变量和内容格式参数组成的标准化的结构体。用于为通知策略，标准化定义告警通知消息的内容及格式。

平台管理员或运维人员通过设置通知模板，可基于不同的告警通知方式自定义通知消息的内容及格式，帮助用户快速获取关键的告警信息，提升运维效率。

:::info
平台支持多种通知服务器，对应的通知类型的模版将会随着通知服务器的配置而展示，若未配置通知服务器，默认不展示对应的通知模板。
:::

### 创建通知模板

1. 在左侧导航栏中，单击 **运维中心** > **通知**。

2. 切换至 **通知模板** 标签页。

3. 单击 **创建通知模板**。

4. 在 **基本信息** 区域，配置以下参数。

    | 参数        |  说明    |
    | ------------ | -------- |
    | **消息类型**  | 根据通知的用途选择消息的类型。<br />**告警消息**：结合平台的告警功能，发送由告警规则触发的告警消息；<br />**组件异常消息**：组件异常消息提醒，发送由某些组件异常触发的通知信息。 |
    
5. 在 **模板配置** 区域，参考不同类型的模板说明配置变量、内容格式相关参数。

:::info

  1. 模板的内容仅能由平台支持的变量、变量显示名称、特殊格式标记语言组成。在符合语法规范的前提下，可自由组合变量及其他组成要素。
  2. 模板中仅能使用平台支持的变量，可修改变量的显示名称、内容格式，但不可修改变量本身，参考 [引用变量](#varibales)、邮件中支持的 [邮件特殊格式标记语言](#email)。
  3. 平台基于实际运维场景，提供了针对不同通知类型的默认通知模板内容，能够满足大部分通知消息设置需求。如无特殊需求，您可直接使用默认的模板内容。 

:::

6. 单击 **创建**。

### 引用变量 \{#varibales}  

变量是通知消息（NotificationMessage）的标签（labels）或注释（annotations）的键，格式如 `{{.标签键}}`。通常为了方便用户快速获取关键信息，可为变量自定义显示名称，例如：`告警等级：{{ .externalLabels.severity }}`。

当通知策略基于通知模板向用户发送通知消息时，模板中的变量会引用通知消息中相应标签的值（实际的监控数据）。最终将监控数据以标准化的内容形式发送给用户。

平台默认支持的基础变量如下：

| 显示名称       | 变量 | 说明 |
| ------------ | ---------------- | --------- | 
| **告警状态**        | `{{ .externalLabels.status }}`    |  例如：告警中。 |
| **告警等级**        | `{{ .externalLabels.severity }}`   | 例如：严重。 |
| **告警集群**       | `{{ .labels.alert_cluster }}`  | 发生告警的资源所在集群，例如：集群 1。 |
| **告警对象**       | `{{ .externalLabels.object }}` | 发生告警的资源的类型及名称，例如：节点192.168.16.53。 |
| **策略名称**       | `{{ .labels.alert_resource }}` | 告警策略的名称。例如：cpaas-node-rules。 |
| **告警描述**       | `{{ .externalLabels.summary }}` | 告警策略的描述信息。 |
| **触发数值**       |          `{{ .externalLabels.currentValue }}`   |   触发告警的监控数值。 |
| **告警时间**       |         `{{ dateFormatWithZone .startsAt "2006-01-02 15:04:05" "Asia/Chongqing" }}`  |   告警的开始时间。 |
| **恢复时间**       |        `{{ dateFormatWithZone .endsAt "2006-01-02 15:04:05" "Asia/Chongqing" }}` |   告警的结束时间。 |
| **指标名称**       |       `{{ .labels.alert_indicator }}`   |  监控指标的名称。 |

### 邮件特殊格式标记语言 \{#email}  

在邮箱通知中，常见的 HTML 格式标签及使用说明参见下表：

| 内容要素       | 标签 | 说明 |
| ------------ | ---------------- | --------- | 
| **文本**        | -  |  支持输入中/英文文本内容。 |
| **字体**        | `<font color="#FF0000">设置字体颜色</font>`<br />`<b>字体加粗</b>`     |  设置字体格式。 |
| **标题**        | `<h1>一级标题</h1>`，支持到 h6（六级标题）。  |  设置标题层级。 |
| **段落**        | `<p>段落</p>`    |  插入普通段落文本。 |
| **引用**        | `<q>引用</q>`     |  插入短引用内容。 |
| **超链接**       | `<a href="//www.example.com">超链接</a>` |  插入超链接。 |

## 通知策略 \{#notification}

通知策略是一个用于定义如何向特定联系对象发送通知消息的规则集合。告警、巡检、登录认证等需要通知到外部服务的场景都需要使用通知策略发送通知。

:::info

平台支持多种通知服务器，对应的通知类型的通知方式将会随着通知服务器的配置而展示，若未配置通知服务器，默认不展示对应的通知方式。

:::

### 前提条件

若需要使用 **企业通讯工具服务器** 的方式通知联系人，需要用户首先在 **个人信息** 中修改联系方式，如填写 `企业微信 id`。

### 操作步骤

1. 在左侧导航栏中，单击 **运维中心** > **通知**。

2. 单击 **创建通知策略**，参考以下说明，配置相关参数。

    | 参数 | 说明 |
    | ---- | ---- |
    |**通知联系组**|   通知联系组是一组逻辑上的通知对象，平台会将通知使用指定的通知方式告知联系人|
    |**通知联系人**|选择添加一个或多个通知联系人，平台将按照通知联系人 **个人信息** 中的联系方式发送通知。|
    |**通知方式**|  支持 **企业微信**、**钉钉**、**飞书**、**企业微信群机器人**、**钉钉群机器人**、**飞书群机器人**、**WebHook URL**多种方式，并支持多选。<br />**注意**：部分参数将在配置通知服务器后展示。|
    |**通知模板**|  选择用于展示通知信息的通知模板。  |

3. 单击 **创建**。

## 为项目设置通知策略

平台的通知策略、通知模板、通知联系组均做到了租户隔离，作为一个项目管理员，您无法查看或使用其他项目、平台管理员配置的通知策略、通知模板、通知联系组。因此您需要参考本文为自己的项目配置合适的通知策略用于使用。

### 前提条件

1. 您已经联系平台管理员完成了通知服务器的设置。

2. 若您需要通知到企业通讯工具，您还需要额外确认好需要通知到的联系人已在 **个人信息** 中正确配置了通讯工具 ID。

### 操作步骤

1. 在 **项目管理** 视图，单击 ***项目名称***。

2. 在左侧导航栏中，单击 **通知**。

3. 切换至 **通知联系组** 页签，参考[通知联系组](#recipient)创建通知联系组。
  
  :::tip
  如您不需要通过通知联系组管理通知联系人，或是不需要通知到 webhook 类型通知服务器，可跳过此步骤。
  :::

4. 切换至 **通知模板** 页签，参考[通知模板](#template)创建通知模板。

5. 奇幻至 **通知策略** 页签，参考[通知策略](#notification)创建通知策略。