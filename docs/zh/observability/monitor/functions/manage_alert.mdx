---
weight: 20
---
# 管理告警

## 功能简介

平台的告警管理功能旨在帮助用户全面监控和及时发现系统异常。通过预置的系统告警和灵活的自定义告警能力，结合标准化的告警模板和分级管理机制，为运维人员提供了一套完整的告警解决方案。

无论是平台管理员还是业务人员，都能在各自的权限范围内，便捷地配置和管理告警策略，实现对平台资源的有效监控。

## 主要功能

- **系统内置告警策略**：基于 global 集群和业务集群常见故障排查思路，预置了丰富的告警规则。
- **自定义告警规则**：支持基于多种数据源创建告警规则，包括预置监控指标、自定义监控指标、黑盒监控项、平台日志数据和平台事件数据。
- **告警模板管理**：支持创建和管理标准化的告警模板，快速应用于同类资源。
- **告警通知集成**：支持将告警信息通过多种渠道推送给运维人员。
- **告警视图隔离**：区分平台管理告警和业务告警，确保不同角色人员专注于各自的告警信息。
- **实时告警查看**：提供实时告警，将当前发生告警的资源个数及详细的告警信息进行集中展示。
- **告警历史查看**：支持查看一段时间内的告警历史记录，方便运维人员和管理员分析近期监控告警状况。

## 功能优势

- **全面的监控覆盖**：支持对集群、节点、计算组件等多种资源类型的监控，内置丰富的系统告警策略，无需额外配置即可使用。
- **高效的告警管理**：通过告警模板实现标准化配置，提升运维效率，告警视图分离，便于不同角色人员快速定位相关告警。
- **及时的问题发现**：自动触发告警通知，确保问题及时发现，支持多渠道告警推送，实现问题预防。
- **完善的权限管理**：严格的告警策略访问控制，确保告警信息安全可控。

## 通过UI创建告警策略 \{#alert_ui}

### 前提条件

- 已配置通知策略（如需配置告警自动通知）。
- 目标集群已安装监控组件（使用监控指标创建告警策略时必需）。
- 目标集群已安装日志存储组件和日志采集组件（使用日志、事件创建告警策略时必需）。

### 操作步骤

1. 导航至 **运维中心** > **告警** > **告警策略**。
2. 点击 **创建告警策略**。
3. 配置基本信息。

#### 告警类型选择

**资源类告警**
- 按资源类别划分的告警类型（如命名空间下的安装状态）
- 资源选择说明：
  - 未选择参数时默认为"任意"，支持自动关联新增资源
  - 选择"全选"时仅对当前资源有效
  - 多命名空间选择时，资源名称支持正则表达式（如 `cert.*`）

**事件类告警**
- 按具体事件划分的告警类型（如 Pod 状态异常）
- 默认选择指定资源下的全部资源，支持自动关联新增资源

#### 告警规则配置

点击 **添加告警规则**，根据告警类型配置以下参数：

**资源类告警参数**

| 参数 | 说明 |
|------|------|
| 表达式 | Prometheus 格式的监控指标算法，如 `rate(node_network_receive_bytes{instance="$server",device!~"lo"}[5m])` |
| 指标单位 | 自定义监控指标单位，可自行输入或选择平台预置单位 |
| 图例参数 | 控制图表中曲线对应的名称，使用 `{{.标签名}}` 格式，如 `{{.hostname}}` |
| 时间范围 | 日志/事件查询的时间窗口 |
| 日志内容 | 日志内容查询字段（例如 Error），多个查询字段间为 OR 关系 |
| 事件原因 | 事件原因查询字段（Reason，例如：BackOff、Pulling、Failed 等），多个查询字段间为 OR 关系 |
| 触发条件 | 由比较运算符、告警阈值、持续时间（可选）组成的判断条件。通过监控指标的实时值/日志条数/事件条数和告警阈值的比较运算结果，以及实时值在告警阈值范围内的持续时间，判断是否告警 |
| 告警等级 | 分为灾难、严重、警告、提示四个等级，您可根据告警规则对应的资源对业务的影响程度，设置合理的告警等级 |

**事件类告警参数**

| 参数 | 说明 |
|------|------|
| 时间范围 | 事件查询的时间窗口 |
| 事件监控项 | 支持监控事件等级或事件原因，多个字段间为 OR 关系 |
| 触发条件 | 基于事件条数的比较判断 |
| 告警等级 | 同资源类告警等级定义 |

#### 其他配置

1. 选择一个或多个已创建的通知策略
2. 配置告警发送间隔
   - 全局：使用平台默认配置
   - 自定义：可按告警等级设置不同的发送间隔
   - 选择"不重复"时仅在告警触发和恢复时发送通知

### 补充说明

1. 在告警规则的"更多"选项中，可以设置标签（Labels）和注解（Annotations）。
2. 配置标签和注解时，请参考 [Prometheus 告警规则文档](https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/)。
3. 注意：标签中请勿使用 `$value` 变量，可能导致告警异常。

## 通过CLI创建资源类告警策略

### 前提条件

- 已配置通知策略（如需配置告警自动通知）。
- 目标集群已安装监控组件（使用监控指标创建告警策略时必需）。
- 目标集群已安装日志存储组件和日志采集组件（使用日志、事件创建告警策略时必需）。

### 操作步骤

1. 创建一个名为 `example-alerting-rule.yaml` 的新 YAML 配置文件。
2. 向 YAML 文件添加 PrometheusRule 资源并提交该文件。以下示例创建一个名为 policy 的新告警策略：

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    alert.cpaas.io/cluster: global      # 告警所在集群名称
    alert.cpaas.io/kind: Cluster        # 资源类型，
    alert.cpaas.io/name: global         # 资源对象，支持单个、多个（|分隔）、任意（.*）
    alert.cpaas.io/namespace: cpaas-system  # 告警对象所在的命名空间，支持单个、多个（|分隔）、任意（.*）
    alert.cpaas.io/notifications: '["test"]'
    alert.cpaas.io/repeat-config: '{"Critical":"never","High":"5m","Medium":"5m","Low":"5m"}'
    alert.cpaas.io/rules.description: "{}"
    alert.cpaas.io/rules.disabled: "[]"
    alert.cpaas.io/subkind: ""
    cpaas.io/description: ""
    cpaas.io/display-name: policy      # 告警策略显示名称
  labels:
    alert.cpaas.io/owner: System
    alert.cpaas.io/project: cpaas-system
    cpaas.io/source: Platform
    prometheus: kube-prometheus
    rule.cpaas.io/cluster: global
    rule.cpaas.io/name: policy
    rule.cpaas.io/namespace: cpaas-system
  name: policy
  namespace: cpaas-system
spec:
  groups:
    - name: general #告警规则名称
      rules:
        - alert: cluster.pod.status.phase.not.running-tx1ob-e998f0b94854ee1eade5ae79279e005a
          annotations:
            alert_current_value: "{{ $value }}"  # 通知当前值，保持默认即可
          expr: (count(min by(pod)(kube_pod_container_status_ready{}) !=1) or on() vector(0))>2
          for: 30s #持续时间
          labels:
            alert_cluster: global #告警所在的集群名称
            alert_for: 30s #持续时间
            alert_indicator: cluster.pod.status.phase.not.running  #告警规则的指标名称（自定义告警指标名称为custom）
            alert_indicator_aggregate_range: "30"  #告警规则的聚合时间，单位s
            alert_indicator_blackbox_name: "" #黑盒监控项名称
            alert_indicator_comparison: ">"  #告警规则的比较方法
            alert_indicator_query: ""  #告警规则的日志告警的查询query（仅日志告警有值）
            alert_indicator_threshold: "2"  #告警规则的阈值
            alert_indicator_unit: ""  #告警规则的指标单位
            alert_involved_object_kind: Cluster   #告警规则所属的对象类型：Cluster|Node|Deployment|Daemonset|Statefulset|Middleware|Microservice|Storage|VirtualMachine
            alert_involved_object_name: global   #告警规则所属的对象名称
            alert_involved_object_namespace: ""  #告警规则所属的对象的命名空间
            alert_name: cluster.pod.status.phase.not.running-tx1ob  #告警规则的名称
            alert_namespace: cpaas-system  #告警规则所在的命名空间
            alert_project: cpaas-system  #告警规则所属的对象的项目名称
            alert_resource: policy #告警规则所在的告警策略的名称
            alert_source: Platform #告警规则所在告警策略的数据类型：Platform-平台数据 Business-业务数据
            severity: High #告警规则等级：Critical-灾难，High-严重，Medium-警告，Low-提示
```

## 通过CLI创建事件类告警策略

### 前提条件

- 已配置通知策略（如需配置告警自动通知）。
- 目标集群已安装监控组件（使用监控指标创建告警策略时必需）。
- 目标集群已安装日志存储组件和日志采集组件（使用日志、事件创建告警策略时必需）。

### 操作步骤

1. 创建一个名为 `example-alerting-rule.yaml` 的新 YAML 配置文件。
2. 向 YAML 文件添加 PrometheusRule 资源并提交该文件。以下示例创建一个名为 policy2 的新告警策略：

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    alert.cpaas.io/cluster: global
    alert.cpaas.io/events.scope: '[{"names":["argocd-gitops-redis-ha-haproxy"],"kind":"Deployment","operator":"=","namespaces":["*"]}]' 
      # names:事件告警的资源名称，name为空时operator无效。
      # kind:发生事件告警的资源类型。
      # namespace:发生事件告警的资源所属的命名空间，ns空数组时表示非ns资源；ns的值为['*']时表示全部ns。
      # operator:选择符 =, !=, =~, !~
    alert.cpaas.io/kind: Event   #告警的类型，Event(事件告警)
    alert.cpaas.io/name: "" #资源类告警使用，事件类告警保持为空
    alert.cpaas.io/namespace: cpaas-system 
    alert.cpaas.io/notifications: '["acp-qwtest"]'
    alert.cpaas.io/repeat-config: '{"Critical":"never","High":"5m","Medium":"5m","Low":"5m"}'
    alert.cpaas.io/rules.description: "{}"
    alert.cpaas.io/rules.disabled: "[]"
    cpaas.io/description: ""
    cpaas.io/display-name: policy2
  labels:
    alert.cpaas.io/owner: System
    alert.cpaas.io/project: cpaas-system
    cpaas.io/source: Platform
    prometheus: kube-prometheus
    rule.cpaas.io/cluster: global
    rule.cpaas.io/name: policy2
    rule.cpaas.io/namespace: cpaas-system
  name: policy2
  namespace: cpaas-system
spec:
  groups:
    - name: general
      rules:
        - alert: cluster.event.count-6sial-34c9a378e3b6dda8401c2d728994ce2f
          # 6sial-34c9a378e3b6dda8401c2d728994ce2f 可以自定义，确保不重复即可
          annotations:
            alert_current_value: "{{ $value }}"  # 通知当前值，保持默认即可
          expr: round(((avg
            by(kind,namespace,name,reason)(increase(cpaas_event_count{namespace=~".*",id="policy2-cluster.event.count-6sial"}[300s])))
            + (avg
            by(kind,namespace,name,reason)(abs(increase(cpaas_event_count{namespace=~".*",id="policy2-cluster.event.count-6sial"}[300s])))))
            / 2)>2
          # id中 policy2 需要是告警策略的名称，6sial需要与前面告警规则的名称一致
          for: 15s #持续时间
          labels:
            alert_cluster: global #告警所在的集群名称
            alert_for: 15s #持续时间
            alert_indicator: cluster.event.count  #告警规则的指标名称（自定义告警指标名称为custom）
            alert_indicator_aggregate_range: "300" #告警规则的聚合时间，单位s
            alert_indicator_blackbox_name: "" 
            alert_indicator_comparison: ">" #告警规则的比较方法
            alert_indicator_event_reason: ScalingReplicaSet #事件原因。
            alert_indicator_threshold: "2" #告警规则的阈值
            alert_indicator_unit: 条 #告警规则的指标单位，事件告警保持不变
            alert_involved_object_kind: Event
            alert_involved_object_options: Single
            alert_name: cluster.event.count-6sial #告警规则的名称
            alert_namespace: cpaas-system #告警规则所在的命名空间
            alert_project: cpaas-system #告警规则所属的对象的项目名称
            alert_repeat_interval: 5m
            alert_resource: policy2 #告警规则所在的告警策略的名称
            alert_source: Platform #告警规则所在告警策略的数据类型：Platform-平台数据 Business-业务数据
            severity: High #告警规则等级：Critical-灾难，High-严重，Medium-警告，Low-提示
```

## 通过告警模板创建告警策略

告警模板是一组针对同类资源的告警规则及通知策略的组合。通过告警模板，可以方便、快捷地为平台上的集群、节点或计算组件创建告警策略。

### 前提条件

- 已配置通知策略（如需配置告警自动通知）。
- 目标集群已安装监控组件（使用监控指标创建告警策略时必需）。

### 操作步骤

#### 创建告警模板

1. 在左侧导航栏中，单击 **运维中心** > **告警** > **告警模板**。
2. 单击 **创建告警模板**。
3. 配置告警模板的基本信息。
4. 在 **告警规则** 区域，单击 **添加告警规则**，并参考以下参数说明添加告警规则：

| 参数        | 说明                                                                 |
|-------------|----------------------------------------------------------------------|
| 表达式      | Prometheus 格式的监控指标算法，如 `rate(node_network_receive_bytes{instance="$server",device!~"lo"}[5m])` |
| 指标单位    | 自定义监控指标单位，可自行输入或选择平台预置单位                  |
| 图例参数    | 控制图表中曲线对应的名称，使用 `{{.标签名}}` 格式，如 `{{.hostname}}` |
| 时间范围    | 日志/事件查询的时间窗口                                            |
| 日志内容    | 日志内容查询字段（例如 Error），多个查询字段间为 OR 关系          |
| 事件原因    | 事件原因查询字段（Reason，例如：BackOff、Pulling、Failed 等），多个查询字段间为 OR 关系 |
| 触发条件    | 由比较运算符、告警阈值、持续时间（可选）组成的判断条件              |
| 告警等级    | 分为灾难、严重、警告、提示四个等级，您可根据告警规则对应的资源对业务的影响程度，设置合理的告警等级 |

5. 单击 **创建**。

#### 使用告警模板创建告警策略

1. 在左侧导航栏中，单击 **运维中心** > **告警** > **告警策略**。
   **提示**：可通过顶部导航栏，切换目标集群。
2. 单击 **创建告警策略** 按钮右侧的展开按钮 > **模板创建告警策略**。
3. 配置部分参数，参考以下说明：

| 参数        | 说明                                                                 |
|-------------|----------------------------------------------------------------------|
| **模板名称** | 要使用的告警模板的名称。模板按照集群、节点、计算组件分类排列。选中模板后，可查看告警模板中设置的告警规则、通知策略等信息。 |
| **资源类型** | 选择模板是针对 **集群**、**节点** 或 **计算组件** 的告警策略模板，资源名称会相应显示。 |

4. 单击 **创建**。

## 为告警设置静默

支持静默集群、节点、计算组件的告警。通过为指定的告警策略设置静默，可控制告警策略下的所有规则在设置的静默时间范围内触发告警时不向通知对象发送告警通知消息。支持设置永久静默和自定义时间静默。

例如：当平台升级或维护时，会有很多资源状态异常，相关的告警被触发后，运维人员在升级或维护完成之前会频繁地收到告警通知。通过为告警策略设置静默，可避免这种情况的发生。

**说明**：当静默状态持续至静默的结束时间后，静默设置会被自动清除。

### 通过UI设置

1. 在左侧导航栏中，单击 **运维中心** > **告警** > **告警策略**。
2. 单击待设置静默告警策略右侧操作按钮 > **设置静默**。
3. 单击打开 **告警静默** 开关。

   **提示**：该开关用于控制是否让静默设置生效。要取消静默时，关闭开关即可。

4. 参考以下说明，配置相关参数：

    **提示**：静默范围或资源名称不选择时，默认为 **任意**，即后续 **删除/添加** 资源时，平台将对应的 **删除静默/添加静默** 告警策略；若选择 **全选**，则仅对当前所选资源范围有效，后续 **删除/添加** 资源时将不作处理。

    | 参数        | 说明                |
    | ------------ | -------- |
    | **静默范围**       |  静默设置生效的资源范围。 |
    | **资源名称**       |  静默设置针对的资源对象名称。 |
    | **静默时间**       |  告警静默的时间范围。告警会从静默时间的开始时间进入静默状态，当告警策略在静默结束时间后仍处于告警状态或触发告警时，则会恢复告警通知。\n**永久**：静默设置后，直到告警策略被删除前，告警都处于静默状态。\n**自定义**： 自定义设置静默的开始时间和结束时间，时间间隔不小于 5 分钟。 |

5. 单击 **设置**。

   **提示**：从设置静默起，到静默开始前，告警策略的静默状态为 **静默等待**，在此期间，策略中规则触发告警时，会正常发送通知；静默开始后直到静默结束，告警策略的静默状态为 **静默中**，策略中规则触发告警时，不会发送通知。

### 通过CLI设置

1. 指定你所需要设置静默的告警策略资源名称，并执行以下指令

```bash
kubectl edit PrometheusRule <所需设置的告警策略名称>
```

2. 按照如下示例，修改资源增加静默 annotations 并提交。

```yaml
---
piVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    alert.cpaas.io/cluster: global
    alert.cpaas.io/kind: Node
    alert.cpaas.io/name: 0.0.0.0
    alert.cpaas.io/namespace: cpaas-system
    alert.cpaas.io/notifications: "[]"
    alert.cpaas.io/rules.description: "{}"
    alert.cpaas.io/rules.disabled: "[]"
    alert.cpaas.io/rules.version: "23"
    alert.cpaas.io/silence.config: '{"startsAt":"2025-02-08T08:01:37Z","endsAt":"2025-02-22T08:01:37Z","creator":"leizhu@alauda.io","resources":{"nodes":[{"name":"192.168.36.11","ip":"192.168.36.11"},{"name":"192.168.36.12","ip":"192.168.36.12"},{"name":"192.168.36.13","ip":"192.168.36.13"}]}}'
      #  节点级别告警策略的静默配置，包括开始时间、结束时间，创建人等；如果静默范围是部分节点，则参考如上示例附加resources.node信息，若需静默全部资源，则无需resrouces字段
  # alert.cpaas.io/silence.config: '{"startsAt":"2025-02-08T08:04:50Z","endsAt":"2199-12-31T00:00:00Z","creator":"leizhu@alauda.io","name":["alb-operator-ctl","apollo"],"namespace":["cpaas-system"]}'
      #  工作负载级别告警策略的静默配置，包括开始时间、结束时间，创建人等；如果静默范围是部分工作负载，则参考如上示例附加name、namespace信息，若需静默全部资源，则无需name、namesapce字段
      #  endsAt字段设置为2199-12-31T00:00:00Z 表示永久静默
    alert.cpaas.io/subkind: ""
    cpaas.io/creator: leizhu@alauda.io
    cpaas.io/description: ""
    cpaas.io/display-name: policy3
    cpaas.io/updated-at: 2025-02-08T08:01:42Z
  labels:
  ## 省略无关信息
```

## 告警规则的配置建议

 告警规则并不是越多越好，重复、繁杂的告警规则会带来告警风暴并增加您的维护负担，建议您在配置告警规则前先通读以下规则，确保自定义规则可以实现预期的目的且高效。

- **使用尽可能少的新规则**：仅创建符合您特定要求的规则。通过使用最少的规则数量，您可以在监控环境中创建更易管理且集中的警报系统。
- **专注于症状而不是原因**：创建规则来通知用户症状而不是造成症状的根本原因。这可以确保，在出现相关症状时用户可以获得警报，用户可以调查触发警报的根本原因。使用这个策略，可以显著降低您需要创建的规则的总数量。
- **在实施更改之前规划并评估您的需求**：首先，明确哪些症状是重要的，以及在出现这些症状时您希望用户执行哪些操作。然后，评估现有规则，决定是否可以通过修改这些规则来实现您的目的，而不用为每个症状都创建一个新的规则。通过修改现有规则并谨慎创建新规则，可帮助您简化警报系统。
- **提供明确的告警信息**：当您创建警报消息时，包括症状的描述、可能的原因和推荐的操作。包括的信息应该明确、简明，并包括故障排除步骤或更多相关信息的链接。这样做有助于用户快速评估情况并做出适当响应。
- **合理设置严重级别**：为您的规则分配严重性级别，以提示用户在出现症状并触发警报时如何响应。例如，将警报严重性级别定为关键（Critical）信号，代表相关人员需要马上做出响应。通过定义严重性级别，可以帮助用户决定在收到警报时应如何响应，并确保对紧急的问题马上做出响应。