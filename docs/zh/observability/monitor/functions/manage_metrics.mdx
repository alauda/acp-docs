---
weight: 10
---

# 管理指标

平台的监控体系均基于 Prometeus / VctoriaMetrics 所收集的指标来实现，本文将向您介绍如何管理这些指标。

## 查看平台组件暴露的指标

平台内集群组件的监控方式是提取通过 `ServiceMonitor` 公开的指标。平台内指标通过 `/metrics` 端点公开，您可以通过以下示例命令查看平台内指定组件的所暴露的指标：  

```bash
curl -s http://<组件IP>:8080/metrics | grep 'TYPE\|HELP'
```

输出示例：

```bash
# HELP controller_runtime_active_workers Number of currently used workers per controller
# TYPE controller_runtime_active_workers gauge
# HELP controller_runtime_max_concurrent_reconciles Maximum number of concurrent reconciles per controller
# TYPE controller_runtime_max_concurrent_reconciles gauge
# HELP controller_runtime_reconcile_errors_total Total number of reconciliation errors per controller
# TYPE controller_runtime_reconcile_errors_total counter
# HELP controller_runtime_reconcile_time_seconds Length of time per reconciliation per controller
```

## 查看 Prometheus / VictoriaMetrics 存储的所有指标

您可以查看集群中可用的指标列表，以便于您根据这些指标编写您所需的 PromQL

### 前提条件

1、您已获取您的用户 Token

2、您已获取平台地址

### 操作步骤

<Steps>

运行以下命令，通过 `curl` 命令获取指标列表：

```bash
curl -k -X 'GET' -H 'Authorization: Bearer <您的token>' 'https://<您的平台访问地址>/v2/metrics/<您的集群名>/prometheus/label/__name__/values'
``` 

输出示例：

```bash
{
  "status": "success",
  "data": [
    "ALERTS",
  "ALERTS_FOR_STATE",
  "advanced_search_cached_resources_count",
  "alb_error",
  "alertmanager_alerts",
  "alertmanager_alerts_invalid_total",
  "alertmanager_alerts_received_total",
  "alertmanager_cluster_enabled"]
}
```
</Steps>

## 查看平台定义的所有内置指标

为了简化用户使用，平台内置了大量常用的指标，您可以在配置告警或是监控面板直接使用这些指标，而无需自行定义。以下将向您介绍如何查看这些指标。

### 前提条件

1、您已获取您的用户 Token

2、您已获取平台地址

### 操作步骤

<Steps>

运行以下命令，通过 `curl` 命令获取指标列表：

```bash
curl -k -X 'GET' -H 'Authorization: Bearer <您的token>' 'https://<您的平台访问地址>/v2/metrics/<您的集群名>/indicators'
```  
输出示例：

```bash
[
  {
  "alertEnabled": true, # [!code callout]
  "annotations": {
   "cn": "计算组件下容器组的cpu使用率",
   "descriptionEN": "Cpu utilization for pods in workload",
   "descriptionZH": "计算组件下容器组的cpu使用率",
   "displayNameEN": "CPU utilization of the pods",
   "displayNameZH": "计算组件下容器组的CPU使用率",
   "en": "Cpu utilization for pods in workload",
   "features": "SupportDashboard", # [!code callout]
   "summaryEN": "CPU usage rate {{.externalLabels.comparison}}{{.externalLabels.threshold}} of Pod ({{.labels.pod}})",
   "summaryZH": "容器组({{.labels.pod}})的CPU使用率{{.externalLabels.comparison}}{{.externalLabels.threshold}}"
  },
  "displayName": "计算组件下容器组的CPU使用率",
  "kind": "workload",
  "multipleEnabled": true,  # [!code callout] 
  "name": "workload.pod.cpu.utilization",
  "query": "avg by (kind,name,namespace,pod) (avg by (kind,name,namespace,pod,container)(cpaas_advanced_container_cpu_usage_seconds_total_irate5m{kind=~\"{{.kind}}\",name=~\"{{.name}}\",namespace=~\"{{.namespace}}\",container!=\"\",container!=\"POD\"}) / avg by (kind,name,namespace,pod,container)(cpaas_advanced_kube_pod_container_resource_limits{kind=~\"{{.kind}}\",name=~\"{{.name}}\",namespace=~\"{{.namespace}}\",resource=\"cpu\"}))", # [!code callout]
  "summary": "容器组({{.labels.pod}})的CPU使用率{{.externalLabels.comparison}}{{.externalLabels.threshold}}",
  "type": "metric",
  "unit": "%",
  "legend": "{{.namespace}}/{{.pod}}",
  "variables": [ # [!code callout] 
   "namespace",
   "name",
   "kind"
  ]
 }
]

```
<Callouts>

1. 是否支持配置告警时使用该指标
2. 是否支持在监控面板中使用该指标
3. 是否支持配置告警且指定多个资源时使用该指标
4. 指标所定义的 Promql 语句 
5. 指标的 PromQL 语句中可使用的变量 

</Callouts>

</Steps>

## 接入外部指标

除了平台内置的指标，您还可以通过 `ServiceMonitor` 或是 `PodMonitor` 接入您的应用或是第三方应用所暴露的指标。 本章节以同集群的以pod形式部署的elasticsearch Exporter为例进行说明。

###  前提条件

您已部署好您的应用，并通过指定接口暴露了指标，在本文中，我们假设您的应用部署在 `cpaas-system` 命名空间下，并暴露了 `http://<elasticsearch-exporter-ip>:9200/_prometheus/metrics` 端点。

### 操作步骤

<Steps>

1、创建Exporter的Service/Endpoint，用于暴露指标

```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    chart: elasticsearch
    service_name: cpaas-elasticsearch
  name: cpaas-elasticsearch
  namespace: cpaas-system
spec:
  clusterIP: 10.105.125.99
  ports:
  - name: cpaas-elasticsearch
    port: 9200
    protocol: TCP
    targetPort: 9200
  selector:
    service_name: cpaas-elasticsearch
  sessionAffinity: None
  type: ClusterIP
```

2、创建一个 `ServiceMonitor` 对象，用于描述您的应用所暴露的指标：

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app: cpaas-monitor
    chart: cpaas-monitor
    heritage: Helm
    prometheus: kube-prometheus            # [!code callout]
    release: cpaas-monitor
  name: cpaas-elasticsearch-Exporter
  namespace: cpaas-system                  # [!code callout]
spec:
  jobLabel: service_name                   # [!code callout]
  namespaceSelector:                       # [!code callout]
    any: true
  selector:                                # [!code callout]
    matchExpressions:
    - key: service_name
      operator: Exists
  endpoints:
  - port: cpaas-elasticsearch              # [!code callout] 
    path: /_prometheus/metrics             # [!code callout] 
    interval: 60s                          # [!code callout] 
    honorLabels: true
    basicAuth:                             # [!code callout] 
      password:
        key: ES_PASSWORD
        name: acp-config-secret
      username:
        key: ES_USER
        name: acp-config-secret
```
<Callouts>
1. ServiceMonitor 要被同步到哪个Prometheus；operator会根据Prometheus CR的serviceMonitorSelector配置去监听对应的ServiceMonitor资源。如果ServiceMonitor的label中没有被Prometheus CR的serviceMonitorSelector配置匹配到，这个ServiceMonitor不会被operator监听
2. operator会根据Prometheus CR的serviceMonitorNamespaceSelector配置，监听哪些命名空间的ServiceMonitor；如果ServiceMonitor不在Prometheus CR的serviceMonitorNamespaceSelector中，这个ServiceMonitor不会被operator监听
3. 采集到Prometheus的Metrics会添加一个job的label，值为 jobLabel对应的service label的值
4. ServiceMonitor根据namespaceSelector的配置去匹配对应NS的Service
5. ServiceMonitor根据selector的配置去匹配Service
6. ServiceMonitor根据 port的配置去匹配Service的port
7. Exporter的访问路径，默认/metrics
8. Prometheus抓取Exporter metrics的间隔
9. 如果访问Exporter的路径需要认证，需要添加认证信息；同样支持bearer token、tls认证等方式
</Callouts>

3、检查ServiceMonitor是否被Prometheus监听 

访问监控组件的UI，查看是否存在 `cpaas-elasticsearch-Exporter` 的job 
- Prometheus 的 UI 地址：`https://<您的平台访问地址>/clusters/<集群名>/prometheus-0/targets`
- VictoriaMetrics 的 UI 地址：`https://<您的平台访问地址>/clusters/<集群名>/vmselect/vmui/?#/metrics`  

</Steps>
