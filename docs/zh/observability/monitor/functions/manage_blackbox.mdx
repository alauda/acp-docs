---
weight: 50
---

# 管理拨测

## 功能简介

平台的拨测功能基于 Blackbox Exporter 实现，允许用户通过 ICMP、TCP、HTTP 的方式对网络进行探测，帮助用户快速发现平台上正在发生的故障。

相比白盒监控体系（平台已有的各类监控指标），拨测（黑盒监控）重点关注结果，当白盒监控无法覆盖影响服务可用性的全部因素时，黑盒监控能够快速发现故障，并可基于发生的故障进行告警。例如：某个业务接口异常，黑盒监控能及时将此类故障暴露给用户。


## 黑盒监控

创建黑盒监控项，可选择 ICMP、TCP、HTTP 探测方式，定期对指定的目标地址的网络进行探测。

### 前提条件

集群已部署监控组件，且监控组件运行正常。

### 操作步骤

1. 在左侧导航栏中，单击 **运维中心** > **监控** > **黑盒监控**。

    **提示**：黑盒监控为集群级别功能，单击上方导航栏中集群切换入口，可切换集群。

2. 单击 **创建黑盒监控项**。

3. 参考以下说明，配置相关参数。

    | 参数        |  说明                |
    | ------------ | -------- |
    | **探测方式**       |  **ICMP**：通过对 **目标地址** 中输入的域名或 IP 地址进行 ping 探测，检测服务器的存活状态。<br />**TCP**：通过监听 **目标地址** 中输入的 `<域名:端口>` 或 `<IP:端口>` 中端口，探测主机的业务端口的存活状态。<br />**HTTP**：通过对 **目标地址** 中输入的 URL 地址进行探测，检测网站的连通性。<br />**提示**：HTTP 探测方式默认仅支持 GET 请求方式，如需使用 POST 请求方式请参考 [自定义 BlackboxExporter 监控模块](#Blackbox2)。 |
    | **探测间隙**       | 探测间隔时间。 |
    | **目标地址**       | 探测的目标地址，不超过 128 个字符。<br />不同的 **探测方式** 下，目标地址的输入格式要求不同：<br />**ICMP**：域名或 IP 地址，例如：`10.165.94.31`。<br />**TCP**：`<域名:端口>` 或 `<IP:端口>`，例如：`172.19.155.133:8765`。<br />**HTTP**：以 http 或 https 开头的网站 URL 地址，例如：`http://alauda.cn/`。 |
    
4. 单击 **创建**。
    
    创建成功后，可在列表页实时查看最近一次的探测结果，并可基于黑盒监控项 [创建告警策略](#Blackbox1)，当探测到故障时，自动触发告警通知相关人员修复故障。

:::warning

    黑盒监控项创建成功后，系统需要 5 分钟左右的时间同步配置，在同步配置期间，不会进行探测，无法查看探测结果。
    
:::

## 黑盒告警 \{#Blackbox1}

### 前提条件

  * 集群已部署监控组件，且监控组件运行正常。
 
  * 黑盒监控项已创建成功，且已等待系统同步配置完成，黑盒监控页面可查看探测结果。

### 操作步骤

1. 在左侧导航栏中，单击 **运维中心** > **告警** > **告警策略**。

    **提示**：告警策略为集群级别功能，单击上方导航栏中集群切换入口，可切换集群。请注意切换至刚刚已配置黑盒监控项的集群。

2. 单击 **创建告警策略**

3. 参考以下说明，配置相关参数，更多参数信息请参考 [创建告警策略](./manage_alert.md#alert_ui)

  * **告警类型** 请选择 **资源类告警**

  * **资源类型** 请选择 **集群**

  * 单击 **添加告警规则**

    * **告警类型** 请选择 **黑盒告警**
  
    * **黑盒监控项** 请选择您期望配置的黑盒监控项

    * **指标名称** 请选择您期望监测并告警的指标，当前平台支持的指标项有 **连通性** 和 **HTTP返回码**
    
      * **连通性**：所有黑盒监控项均可选择此项指标，触发条件中的 **“!= 1”** 代表黑盒监控项的目标地址无法联通。
    
      * **HTTP返回码**：当选择的黑盒监控项探测方式为 **HTTP** 时可选择此项指标，触发条件中的值你可填写三位正整数，例如触发条件配置为 **“> 299”** 代表返回码为 3XX、4XX、5XX 时告警。

    * **通知策略** 请选择您提前预置的策略
  
    * 单击 **添加**

4. 单击 **创建** ，告警策略提交后，您可以在告警策略列表中看到此项告警策略。
    
## 自定义 BlackboxExporter 监控模块  \{#Blackbox2}

您也可以通过为 BlackboxExporter 的配置文件添加自定义监控模块，可实现模块定义的探测方式，丰富黑盒监控的功能。例如：为配置文件添加 **http\_post_2xx** 模块后，当黑盒监控的探测方式为 `HTTP` 时，可探测 POST 请求方法的状态。    

黑盒监控的配置文件位于集群的 Prometheus 组件所在的命名空间下，名称默认为 `cpaas-monitor-prometheus-blackbox-exporter`，支持修改，请以实际名称为准。

:::tip
该配置文件是命名空间相关的 ConfigMap 资源，可通过平台管理的 **集群管理 > 资源管理** 功能快速查看、更新。
:::

### 操作步骤

1. 更新黑盒监控的配置文件，为 **key** `modules` 添加自定义监控模块。 

    以添加 **http\_post_2xx** 模块为例进行说明。

    ```yaml
      blackbox.yaml: |
        modules:           
          http_post_2xx:                    # http_post 探测模块                                  
            prober: http
            timeout: 5s
            http:
              method: POST                 # 探测的请求方法
              headers:
                Content-Type: application/json
              body: '{}'                   # 探测时携带的 body 内容
    ``` 
    
    完整的黑盒监控的配置文件 YAML 示例参见 [参考信息](#Blackbox3)。

2. 选择以下任一方式使配置生效。

    * 删除 Blackbox Exporter 组件 **cpaas-monitor-prometheus-blackbox-exporter** 的 Pod 重启 Blackbox Exporter 组件。

    * 执行以下命令调用 reload API 重新加载配置文件：
    
        ```bash
        curl -X POST -v <Pod IP>:9115/-/reload     
        ```

## 通过 CLI 创建黑盒监控项和黑盒告警

### 前提条件

- 已配置通知策略（如需配置告警自动通知）。
- 目标集群已部署监控组件。

### 操作步骤

1. 创建一个名为 `example-probe.yaml` 的新 YAML 配置文件。
2. 向 YAML 文件添加 PrometheusRule 资源并提交该文件。以下示例创建一个名为 prometheus-liveness  的新告警策略：

```yaml
apiVersion: monitoring.coreos.com/v1
kind: Probe
metadata:
  annotations:
    cpaas.io/creator: jhshi@alauda.io                    # 探测项的创建人
    cpaas.io/updated-at: "2021-05-25T08:08:45Z"          # 探测项的更新时间
    cpaas.io/display-name: "Prometheus prober"           # 探测项的描述
  creationTimestamp: "2021-05-10T02:04:33Z"              # 探测项的创建时间
  labels:
    prometheus: kube-prometheus                          # 标签的值传用prometheus的name
  name: prometheus-liveness                              # 探测项的名字
  namespace: cpaas-system                                # 命名空间用prometheus所在的namespace
spec:
  jobName: prometheus-liveness                           # 探测项的名字
  prober:
    url: cpaas-monitor-prometheus-blackbox-exporter:9115 # Blackbox的metrics的url,从features里面读取
  module: http_2xx                                       # 探测项的模块名字
  targets:
    staticConfig:
      static:
      - http://www.prometheus.io                         # 探测项的目标地址
      labels:
        module: http_2xx                                 # 探测项的模块名字
        prober: http                                     # 探测项的探测方式
  interval: 30s                                          # 探测项的探测间隔
  scrapeTimeout: 10s   
```
3. 创建一个名为 `example-alerting-rule.yaml` 的新 YAML 配置文件。
4. 向 YAML 文件添加 PrometheusRule 资源并提交该文件。以下示例创建一个名为 policy 的新告警策略：

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    alert.cpaas.io/cluster: global      # 告警所在集群名称
    alert.cpaas.io/kind: Cluster        # 资源类型，
    alert.cpaas.io/name: global         # 黑盒监控项所在的集群名称
    alert.cpaas.io/namespace: cpaas-system  # 命名空间用prometheus所在的namespace，保持默认即可
    alert.cpaas.io/notifications: '["test"]'
    alert.cpaas.io/repeat-config: '{"Critical":"never","High":"5m","Medium":"5m","Low":"5m"}'
    alert.cpaas.io/rules.description: "{}"
    alert.cpaas.io/rules.disabled: "[]"
    alert.cpaas.io/subkind: ""
    cpaas.io/description: ""
    cpaas.io/display-name: policy      # 告警策略显示名称
  labels:
    alert.cpaas.io/owner: System
    alert.cpaas.io/project: cpaas-system
    cpaas.io/source: Platform
    prometheus: kube-prometheus
    rule.cpaas.io/cluster: global
    rule.cpaas.io/name: policy
    rule.cpaas.io/namespace: cpaas-system
  name: policy
  namespace: cpaas-system
spec:
  groups:
    - name: general #告警规则名称
      rules:
        - alert: cluster.blackbox.probe.success-y97ah-9833444d918cab96c43e9ab6efc172cf
          annotations:
            alert_current_value: "{{ $value }}"  # 通知当前值，保持默认即可
          expr: max by (job, instance) (probe_success{job=~"test",
            instance=~"https://demo.at-servicecenter.com/"})!=1
            # 连通性告警场景，注意修改黑盒监控项名称和目标地址
          for: 30s #持续时间
          labels:
            alert_cluster: global #告警所在的集群名称
            alert_for: 30s #持续时间
            alert_indicator: cluster.blackbox.probe.success  #保持不变
            alert_indicator_aggregate_range: "0" #保持不变
            alert_indicator_blackbox_instance: https://demo.at-servicecenter.com/ #黑盒监控项目标地址
            alert_indicator_blackbox_name: test #黑盒监控项名称
            alert_indicator_comparison: "!="  #连通性告警保持改配置不变
            alert_indicator_query: ""  #日志告警使用，无需配置该参数
            alert_indicator_threshold: "1"  #告警规则的阈值，1表示连通，保持不变即可
            alert_indicator_unit: ""  #告警规则的指标单位
            alert_involved_object_kind: Cluster   #黑盒告警保持不变
            alert_involved_object_name: global   #黑盒监控项所在的集群
            alert_involved_object_namespace: ""  #告警规则所属的对象的命名空间
            alert_name: cluster.blackbox.probe.success-y97ah  #告警规则的名称
            alert_namespace: cpaas-system  #告警规则所在的命名空间
            alert_project: cpaas-system  #告警规则所属的对象的项目名称
            alert_resource: policy #告警规则所在的告警策略的名称
            alert_source: Platform #告警规则所在告警策略的数据类型：Platform-平台数据 Business-业务数据
            severity: High #告警规则等级：Critical-灾难，High-严重，Medium-警告，Low-提示
         - alert: cluster.blackbox.http.status.code-235el-99b0095b6b6669415043e14ae84f43bc
          annotations:
            alert_current_value: "{{ $value }}"
            alert_notifications: '["message"]'
          expr: max by(job, instance) (probe_http_status_code{job=~"test",
            instance=~"https://demo.at-servicecenter.com/"})>200
            # HTTP返回码告警场景，注意修改黑盒监控项名称和目标地址
          for: 30s
          labels:
            alert_cluster: global
            alert_for: 30s
            alert_indicator: cluster.blackbox.http.status.code
            alert_indicator_aggregate_range: "0"
            alert_indicator_blackbox_instance: https://demo.at-servicecenter.com/
            alert_indicator_blackbox_name: test
            alert_indicator_comparison: ">" 
            alert_indicator_query: ""
            alert_indicator_threshold: "299" #告警规则的阈值，HTTP返回码告警场景为三位整数，例如返回码大于299（3XX、4XX、5XX）的都表示异常
            alert_indicator_unit: ""
            alert_involved_object_kind: Cluster
            alert_involved_object_name: global
            alert_involved_object_namespace: ""
            alert_involved_object_options: Single
            alert_name: cluster.blackbox.http.status.code-235el
            alert_namespace: cpaas-system
            alert_project: cpaas-system
            alert_resource: policy33
            alert_source: Platform
            severity: High
```

## 参考信息 \{#Blackbox3}

完整的黑盒监控的配置文件 YAML 示例如下：
    
```yaml
apiVersion: v1
data:
  blackbox.yaml: |
    modules:
      http_2xx_example:               # http 探测示例
        prober: http
        timeout: 5s                   # 探测的超时时间
        http:
          valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]                   # 返回信息中的 Version，一般默认即可
          valid_status_codes: []  # Defaults to 2xx                       # 有效的返回码范围，如果请求的返回码在该范围内，视为探测成功
          method: GET                 # 请求方法
          headers:                    # 请求的头部
            Host: vhost.example.com
            Accept-Language: en-US
            Origin: example.com
          no_follow_redirects: false  # 是否允许重定向
          fail_if_ssl: false   
          fail_if_not_ssl: false
          fail_if_body_matches_regexp:
            - "Could not connect to database"
          fail_if_body_not_matches_regexp:
            - "Download the latest version here"
          fail_if_header_matches: # Verifies that no cookies are set
            - header: Set-Cookie
              allow_missing: true
              regexp: '.*'
          fail_if_header_not_matches:
            - header: Access-Control-Allow-Origin
              regexp: '(\*|example\.com)'
          tls_config:                  # 针对 https 请求的 tls 的配置
            insecure_skip_verify: false
          preferred_ip_protocol: "ip4" # defaults to "ip6"                 # 首选的 IP 协议版本
          ip_protocol_fallback: false  # no fallback to "ip6"            
      http_post_2xx:                   # 带 Body 的 http 探测的示例
        prober: http
        timeout: 5s
        http:
          method: POST                 # 探测的请求方法
          headers:
            Content-Type: application/json
          body: '{"username":"admin","password":"123456"}'                   # 探测时携带的 body
      http_basic_auth_example:         # 带用户名密码的探测的示例
        prober: http
        timeout: 5s
        http:
          method: POST
          headers:
            Host: "login.example.com"
          basic_auth:                  # 探测时要加的用户名密码
            username: "username"
            password: "mysecret"
      http_custom_ca_example:
        prober: http
        http:
          method: GET
          tls_config:                  # 指定探测时使用的根证书
            ca_file: "/certs/my_cert.crt"
      http_gzip:
        prober: http
        http:
          method: GET
          compression: gzip            # 探测时使用的压缩方法
      http_gzip_with_accept_encoding:
        prober: http
        http:
          method: GET
          compression: gzip
          headers:
            Accept-Encoding: gzip
      tls_connect:                     # TCP 探测的示例
        prober: tcp
        timeout: 5s
        tcp:
          tls: true                    # 是否使用 TLS
      tcp_connect_example:
        prober: tcp
        timeout: 5s
      imap_starttls:                   # 探测 IMAP 邮箱服务器的配置示例
        prober: tcp
        timeout: 5s
        tcp:
          query_response:
            - expect: "OK.*STARTTLS"
            - send: ". STARTTLS"
            - expect: "OK"
            - starttls: true
            - send: ". capability"
            - expect: "CAPABILITY IMAP4rev1"
      smtp_starttls:                   # 探测 SMTP 邮箱服务器的配置示例
        prober: tcp
        timeout: 5s
        tcp:
          query_response:
            - expect: "^220 ([^ ]+) ESMTP (.+)$"
            - send: "EHLO prober\r"
            - expect: "^250-STARTTLS"
            - send: "STARTTLS\r"
            - expect: "^220"
            - starttls: true
            - send: "EHLO prober\r"
            - expect: "^250-AUTH"
            - send: "QUIT\r"
      irc_banner_example:
        prober: tcp
        timeout: 5s
        tcp:
          query_response:
            - send: "NICK prober"
            - send: "USER prober prober prober :prober"
            - expect: "PING :([^ ]+)"
              send: "PONG ${1}"
            - expect: "^:[^ ]+ 001"
      icmp_example:                    # ICMP 探测配置的示例
        prober: icmp
        timeout: 5s
        icmp:
          preferred_ip_protocol: "ip4"
          source_ip_address: "127.0.0.1"
      dns_udp_example:                 # 使用 UDP 进行 DNS 查询的示例
        prober: dns
        timeout: 5s
        dns:
          query_name: "www.prometheus.io"                 # 要解析的域名
          query_type: "A"              # 该域名对应的类型
          valid_rcodes:
          - NOERROR
          validate_answer_rrs:
            fail_if_matches_regexp:
            - ".*127.0.0.1"
            fail_if_all_match_regexp:
            - ".*127.0.0.1"
            fail_if_not_matches_regexp:
            - "www.prometheus.io.\t300\tIN\tA\t127.0.0.1"
            fail_if_none_matches_regexp:
            - "127.0.0.1"
          validate_authority_rrs:
            fail_if_matches_regexp:
            - ".*127.0.0.1"
          validate_additional_rrs:
            fail_if_matches_regexp:
            - ".*127.0.0.1"
      dns_soa:
        prober: dns
        dns:
          query_name: "prometheus.io"
          query_type: "SOA"
      dns_tcp_example:               # 使用 TCP 进行 DNS 查询的示例
        prober: dns
        dns:
          transport_protocol: "tcp" # defaults to "udp"
          preferred_ip_protocol: "ip4" # defaults to "ip6"
          query_name: "www.prometheus.io"
kind: ConfigMap
metadata:
  annotations:
    skip-sync: "true"
  labels:
    app.kubernetes.io/instance: cpaas-monitor
    app.kubernetes.io/managed-by: Tiller
    app.kubernetes.io/name: prometheus-blackbox-exporter
    helm.sh/chart: prometheus-blackbox-exporter-1.6.0
  name: cpaas-monitor-prometheus-blackbox-exporter
  namespace: cpaas-system
```