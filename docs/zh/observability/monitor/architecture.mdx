---
weight: 20
---

# 架构

![](./assets/visio_for_monitor.png)

## 整体架构说明

监控系统主要由以下几个部分组成:
1. 数据采集与存储: 负责从各个来源收集监控指标并持久化
2. 数据查询与展示: 提供监控数据的查询和可视化能力
3. 告警管理: 包括告警规则配置、告警触发和通知分发
4. 实时告警状态: 提供当前系统告警状态的实时视图

## 监控数据流

### 数据采集
1. Prometheus/VM Operator 负责:
   - 加载监控采集配置
   - 加载告警规则配置
   - 同步配置到 Prometheus/VM 实例
2. 指标来源:
   - Nevermore 生成日志相关指标
   - Warlock 监听事件生成事件指标
   - Prometheus/VM 通过 ServiceMonitor 发现并采集目标 exporters 的指标

### 数据查询
1. 浏览器发起监控查询(路径为 `/platform/monitoring.alauda.io/v1beta1`)
2. 请求经由 ALB 转发至 Courier 组件
3. Courier 根据查询类型:
   - 内置指标: 通过 indicators 接口获取 PromQL,查询各集群监控组件
   - 自定义指标: 直接将 PromQL 转发给监控组件
4. 监控面板直接连接监控数据源执行查询

## 告警系统

### 告警规则管理
告警规则的管理流程如下:

1. 用户通过浏览器访问 Global 集群的 ALB(路径为 `/kubernetes/集群名`)
2. ALB 将请求转发给 Erebus 组件
3. Erebus 将请求路由到对应监控集群的 kube-apiserver
4. Prometheus/VM Operator 负责:
   - 校验规则的合法性
   - 管理 PrometheusRule CR
5. Nevermore 组件职责:
   - 监听 PrometheusRule CR 变更,生成日志告警指标
   - 监听 Event CR 变更,生成事件告警指标

### 告警触发流程
1. PrometheusRule/VMRule 作为告警策略载体
2. Prometheus/VM 定期评估规则触发告警
3. 告警信息发送至 Alertmanager
4. Alertmanager 将通知转发给 ALB
5. Courier 负责最终通知发送
6. 告警历史保存在 ElasticSearch 或 ClickHouse

### 实时告警状态
1. Global 集群的 Courier 生成两类指标:
   - cpaas_active_alerts: 从各集群 Alertmanager 获取活动告警
   - cpaas_active_silences: 从各集群 Alertmanager 获取静默配置
2. Global Prometheus 每 15s 采集一次这些指标
3. 前端通过 Courier API 查询并展示实时告警状态