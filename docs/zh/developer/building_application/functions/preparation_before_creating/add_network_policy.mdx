---
weight: 40
---

# 配置网络策略

当前平台提供了旧版及新版两种不同表单样式的网络策略，新版的网络策略相较于旧版功能更加强大，其全新的表单设计，可通过 YAML 定义网络策略，并且提供集群、命名空间两个维度的网络策略配置，实现入站、出站流量的管控。

## 旧版网络策略


网络策略（NetworkPolicy）是依赖网络插件实现的，从属于命名空间的 Kubernetes 资源。通过网络策略可以以白名单的方式，控制项目内计算组件的网络数据访问流量，实现网络隔离并降低被攻击风险。



默认情况下，计算组件间是非隔离的，可允许任何来源的入站（ingress）及出站（egress）流量。一旦添加网络策略，策略中的目标计算组件将只能接受白名单中的流量。


更多内容，请参考 [Kubernetes NetworkPolicy](https://kubernetes.io/docs/concepts/services-networking/network-policies/)。

### 注意事项

* 网络策略不适用于主机网络命名空间，启用了主机网络的 Pod 不受网络策略规则的影响。

* 配置网络策略时需考虑双向流量。例如，目标计算组件 A 允许向远端计算组件 B 的出站流量，且 B 不做任何设置，则 A 可以正常访问 B；若 B 配置了入站白名单但不包括 A，则 B 将拒绝 A 的访问。

* 网络策略是否生效，取决于集群所使用的网络插件是否支持网络策略，使用前请联系平台管理员确认。

* Kube-OVN 网络模式下本功能成熟度为 Alpha。

* 平台管理员创建集群网络策略后，各命名空间下会自动生成相关策略。不支持更新或删除此类网络策略。



### 场景一：仅对外开放网站的 Web 服务

如果您创建了一个 Web 应用，且不希望开放文件传送（FTP）、远程登录（Telnet）等服务，可设置仅允许客户端访问 Web 服务相应端口，例如 80（ HTTP）、443（HTTPS ）。

#### 操作步骤

1. 进入 **Container Platform**。

1. 在左侧导航栏中，单击 **网络** > **网络策略**。

4. 单击 **创建网络策略**。

5. 参考以下说明完成相关配置。

    |参数| 说明                       |
    | -------- | -------------------------- |
    |**目标计算组件 / 标签选择器**|  Web 应用对应的计算组件                     |
    |**方向**| 入站                       |
    |**协议**| TCP              |
    |**端口**| 80（HTTP） 及 443（HTTPS） |
    |**远端类型**| IP 段                      |
    |**远端**| 0.0.0.0/0                  |

4. 单击 **创建**。  


### 场景二：内网隔离环境中，指定实例互通


即使在有严格网络安全规范的内网环境中，有时也要考虑关联业务间的互通，例如业务实例需从 MySQL 数据库中获取信息。参考以下示例配置网络策略后，MySQL 将仅允许来自指定实例的访问请求。


|参数| 示例                     |
| -------- | -------------------------- |
|**目标计算组件 / 标签选择器**| MySQL 实例对应的计算组件                     |
|**方向**| 入站                       |
|**协议**| TCP              |
|**端口**| 6379 |
|**远端类型**| 命名空间（当前项目）                     |
|**远端**| 指定实例所在命名空间                  |


### 场景三：限制实例访问外部网站

参考以下示例配置网络策略后，实例将无法访问所配 IP 以外的网站。

|参数| 示例                     |
| -------- | -------------------------- |
|**目标计算组件 / 标签选择器**| 实例对应的计算组件                     |
|**方向**| 出站                       |
|**协议**| TCP              |
|**端口**| 80（HTTP） 及 443（HTTPS） |
|**远端类型**| IP 段                     |
|**远端**|  允许的网站 IP 地址        |



## 新版网络策略


### 前提条件

请联系平台管理员开启 **网络策略** 相关功能。


### 注意事项

* 网络策略不适用于主机网络命名空间，启用了主机网络的 Pod 不会受到网络策略规则的影响。


### 操作步骤

1. 进入 **Container Platform**。

1. 在左侧导航栏中，单击 **网络** > **网络策略**。

4. 单击 **创建网络策略**。

5. 参考以下说明完成相关配置。

    <table><thead>
      <tr>
        <th>区域</th>
        <th colSpan={2}>参数</th>
        <th>说明</th>
      </tr></thead>
    <tbody>
      <tr>
        <td rowSpan={2}>目标 Pod</td>
        <td colSpan={2}>Pod 选择器</td>
        <td>以键值对的形式输入目标 Pod 的标签，若不设置将应用到当前命名空间中的所有 Pod。</td>
      </tr>
      <tr>
        <td colSpan={2}>当前策略受影响的目标 Pod 预览</td>
        <td>单击 <b>预览</b> 即可查看此网络策略所影响的目标 Pod。</td>
      </tr>
      <tr>
        <td rowSpan={5}>入站</td>
        <td colSpan={2}>禁止所有流量入站</td>
        <td>禁止访问目标 Pod 的所有流量入站。<br /><br /><b>注意</b>：<ul><li>若在 YAML 中 spec.policyTypes 字段下增加了 Ingress，但是没有配置具体的规则，切换回表单后将自动勾选 <b>禁止所有流量入站</b>。</li><li>若在 YAML 中同时删除 spec.ingress、spec.egress 及 spec.policyTypes 三个字段，切换回表单后将自动勾选 <b>禁止所有流量入站</b>。</li></ul></td>
      </tr>
      <tr>
        <td rowSpan={3}>规则<br /><br /><b>说明</b>：若规则中同时添加多个源，则多个源之间为逻辑 <b>或</b> 的关系。</td>
        <td>当前命名空间下的 Pod</td>
        <td>匹配当前命名空间中带有指定标签的 Pod，只有被命中的 Pod 才允许访问目标 Pod，可通过单击 <b>预览</b> 查看当前规则影响的 Pod。若不配置此项，默认允许当前命名空间中所有的 Pod 访问目标 Pod。</td>
      </tr>
      <tr>
        <td>当前集群下的 Pod</td>
        <td>匹配集群中带有指定标签的命名空间或 Pod，只有被命中的 Pod 才允许访问目标 Pod，可通过单击 <b>预览</b> 查看当前规则影响的 Pod。<ul><li>若同时配置了命名空间选择器和 Pod 选择器，则取二者的交集，表示从指定命名空间中选择带有指定标签的 Pod。</li><li>若不配置此项，默认允许集群中所有命名空间的 Pod 访问目标 Pod。</li></ul></td>
      </tr>
      <tr>
        <td>IP 段</td>
        <td>输入可以访问目标 Pod 的 CIDR，可排除此 CIDR 中不允许访问目标 Pod 的 CIDR，若不配置此项，则允任意流量访问目标 Pod。<br /><br /><b>说明</b>：可通过添加 <i>exampleip</i>/32 此类形式的排除项，排除单个 IP 地址。</td>
      </tr>
      <tr>
        <td colSpan={2}>端口</td>
        <td>匹配指定协议和端口上的流量，可添加数字端口或 Pod 上的端口名称。若不配置此项，则会匹配所有端口。</td>
      </tr>
        <tr>
          <td rowSpan={5}>出站</td>
          <td colSpan={2}>禁止所有流量出站</td>
          <td>禁止目标 Pod 的所有流量出站。<br /><br /><b>注意</b>：<ul><li>若在 YAML 中 spec.policyTypes 字段下增加了 Egress，但是没有配置具体的规则，切换回表单后将自动勾选 <b>禁止所有流量出站</b>。</li></ul></td>
        </tr>
        <tr>
          <td colSpan={2}>其他参数</td>
          <td>与入站参数类似，此处不再赘述。</td>
        </tr>
    </tbody>
    </table>

6. 单击 **创建**。

### 参考文档

其他详细说明请参考官方网站文档 [网络策略](https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/)。
