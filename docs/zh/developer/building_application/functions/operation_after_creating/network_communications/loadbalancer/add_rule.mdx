---
weight: 30
sourceSHA: b017e5978159fe27517e626f457b623e140b782cc5bf4e21e48c03320588b89f
---

# 添加规则

为 HTTPS、HTTP 和 gRPC 协议的监听端口添加转发规则，负载均衡器将根据这些规则匹配后端服务。

**注意**：TCP 和 UDP 协议不支持添加转发规则。

## 操作步骤

1. 进入 **Container Platform**。

2. 在左侧导航栏中，单击 **网络** > **负载均衡**。

3. 单击负载均衡器的名称。

4. 单击监听端口的名称。

5. 单击 **添加规则**。

6. 参考以下说明，配置相关参数。

   | 参数                                    | 说明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
   | -------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | **内部路由组**                          | - 当负载均衡算法选择 **轮询(RR)** 时，访问流量将按照内部路由组的顺序依次分发至内部路由的端口。<br />- 当负载均衡算法选择 **加权轮询(WRR)** 时，权重值越高的内部路由，被轮询到的概率越高，访问流量将按照所配置 **权重** 计算出的概率分发至内部路由的端口。<br />**提示**：概率的计算方式为当前权重值与所有权重值之和的比值。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
   | **规则**                                | 指负载均衡器匹配后端服务的依据，包括规则指标及其取值。各规则指标之间为 'and' 的关系。<br /><ul><li>域名：支持添加 **泛域名** 和 **精确域名**。在相同优先级情况下，若同时存在泛域名和精确域名规则配置，精确域名的转发规则优先生效。</li><li>URL：**RegEx** 对应以 `/` 开头的 URL 正则表达式；**StartsWith** 对应以 `/` 开头的 URL 前缀。</li><li>IP：**Equal** 对应具体的 IP 地址；**Range** 对应 IP 地址范围。</li><li>Header：除了要输入 Header 的 key 外，需设置匹配规则。**Equal** 对应具体 Header 的值；**Range** 对应 Header 值的范围；**RegEx** 对应 Header 的正则表达式。</li><li>Cookie：除了要输入 Cookie 的 key 外，需设置匹配规则。**Equal** 对应具体 Cookie 的值。</li><li>URL 参数：匹配规则中，**Equal** 对应具体的 URL 参数；**Range** 对应 URL 参数范围。</li><li>服务名称：服务名称指使用 gRPC 协议的服务名称，使用 gRPC 协议时可配置此项，流量将根据填写的服务名称转发至对应的服务，例如：`/helloworld.Greeter`。</li></ul> |
   | **会话保持**                            | 始终将特定的访问请求转发至前述内部路由组对应的后端服务。<br />特定的访问请求指（任选一种）：<ul><li>源地址哈希：所有来自同一 IP 地址的访问请求。</li><li>Cookie key：携带指定 Cookie 的访问请求。</li><li>Header name：携带指定 Header 的访问请求。</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
   | **URL 重写**                            | 将用户访问的地址重写为平台后端服务的地址。此功能要求同时配置 URL 的 StartsWith 规则指标，且重写地址（rewrite-target）必须以 */* 开头。<br /><br />例如：设置域名为 *bar.example.com* 及 URL 起始路径为 `/` 的规则后，启用 **URL 重写** 功能并设置重写地址为 */test*，则访问 *bar.example.com* 时，URL 将被重写为 *bar.example.com/test*。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
   | **后端协议**                            | 用于将访问流量转发到后端服务的协议。例如：若转发到后端的 Kubernetes 或 dex 服务，需要选择 HTTPS 协议。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
   | **重定向**                              | 将访问流量转发到新的重定向地址，而不是内部路由组对应的后端服务。<br />例如：当原有访问地址页面升级或更新时，为避免用户得到 404 或 503 错误页面，可通过配置重定向将流量转发至新地址。<ul><li>HTTP 状态码：在跳转到新地址之前，浏览器呈现给用户的状态码。</li><li>重定向地址：输入相对地址时（例如 */index.html*），转发的目的地址为 *负载均衡器地址/index.html*；输入绝对地址时（例如 *https://www.example.com*），流量转发的目的地址即为输入的地址。</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
   | **规则优先级**                          | 规则匹配的优先级：共 10 个等级，范围从 1 到 10，1 为最高优先级，默认优先级为 5。<br />当同时满足两条或以上规则时，会选择优先级高的规则并应用；如果优先级相同，系统将使用默认匹配规则。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | **跨域资源共享 (CORS)**                | CORS（跨域资源共享）是一种机制，它利用额外的 HTTP 头告诉浏览器，某个在一个源（域）上运行的 Web 应用被允许访问来自不同源服务器上的特定资源。当一个资源请求另一个来自不同域、协议或端口的资源时，就会发起跨域 HTTP 请求。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
   | **允许来源**                            | 用于指定允许访问的来源。<ul><li>**\***：允许来自任意来源的请求。</li><li>**域名**：允许当前域名的请求。</li></ul>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
   | **允许标头**                            | 用于指定 CORS 中允许的 HTTP 请求头，以避免不必要的预检请求并提高请求效率。示例条目如下：<br /><br />**说明**：其他常用或自定义请求头不再一一列举，具体请根据实际情况进行填写。<br /><br /><ul><li>**Origin**: 表示请求的来源，即发送请求的域名。</li><li>**Authorization**: 用于指定请求的授权信息，通常用于身份验证，如基本身份验证（Basic Authentication）或令牌（Token）。</li><li>**Content-Type**: 用于指定请求/响应的内容类型，例如 application/json、application/x-www-form-urlencoded 等。</li><li>**Accept**: 用于指定客户端可以接受的内容类型，通常在客户端希望获取特定类型的响应时使用。</li></ul><br />**预检请求补充说明**：预检请求是浏览器自动发送的一种请求，用于确认实际请求的安全性和可行性。当实际请求不符合 [简单请求](#request) 的条件时，浏览器会先发送一个 OPTIONS 请求到服务器，询问是否允许实际请求；只有在服务器确认允许后，浏览器才会发送实际请求，而这个 OPTIONS 请求即为预检请求。|

7. 单击 **添加**。

## 相关说明

### 简单请求 \{#request}

若请求满足如下所有条件，则该请求即可视为简单请求：

- 使用下列方法之一：
  - HEAD
  - GET
  - POST

- 除了被用户代理自动设置的标头字段，例如 Connection、User-Agent，以及在 Fetch 规范中定义为禁用标头名称的标头，其他允许人为设置的对 CORS 安全的标头字段包括：
  - Accept
  - Accept-Language
  - Content-Language
  - Content-Type（需注意额外的限制）
  - Range（只允许简单的范围标头值，如 bytes=256- 或 bytes=127-255）

- Content-Type 的值限于下列内容之一：
  - text/plain
  - multipart/form-data
  - application/x-www-form-urlencoded

- 请求中的 XMLHttpRequest 对象未注册任何事件监听器。

- 请求中未使用 ReadableStream 对象。
