---
weight: 30
---

# 添加规则

为 HTTPS、HTTP 和 gRPC 协议的监听端口添加转发规则，负载均衡器将根据规则匹配后端服务。

**注意**：TCP 和 UDP 协议不支持添加转发规则。

## 操作步骤

1. 进入 **Container Platform**。

1. 在左侧导航栏中，单击 **网络** > **负载均衡**。
      
3. 单击负载均衡器的名称。

4. 单击监听端口的名称。

3. 单击 **添加规则**。

4. 参考以下说明，配置相关参数。

    |参数| 说明                                                         |
    | -------------------- | ------------------------------------------------------------ |
    |**内部路由组**| - 当均衡算法选择 **轮询（RR）** 时，访问流量将按照内部路由组的顺序依次分发至内部路由的端口中。<br/>- 当均衡算法选择 **加权轮询 (WRR）** 时，权重值越高的内部路由，被轮询到的概率越高，访问流量将按照所配置 **权重** 计算出的概率分发流量至内部路由的端口中。<br/>**提示**：概率的计算方式为：当前权重值与所有权重值之和的比值。|
    |**规则**| 指负载均衡器匹配后端服务的依据，包括规则指标及其取值。各规则指标之间为 and 的关系。 <br/><ul><li>域名：支持添加 **泛域名** 和 **精确域名**，相同规则优先级情况下，若同时存在泛域名和精确域名规则配置，精确域名的转发规则优先生效。</li><li>URL：**RegEx** 对应以 `/` 开头的 URL 正则表达式；**StartsWith** 对应以 `/` 开头的 URL 前缀。</li><li>IP：**Equal** 对应具体的 IP 地址；**Range** 对应 IP 地址范围。</li><li>Header：除了要输入 Header 的 key 外，还需设置匹配规则。**Equal** 对应具体 Header 的值；**Range** 对应 Header 值的范围；**RegEx** 对应 Header 的正则表达式。</li><li>Cookie：除了要输入 Cookie 的 key 外，还需设置匹配规则。**Equal** 对应具体 Cookie 的值。</li><li>URL Param：匹配规则中，**Equal** 对应具体的 URL 参数；**Range** 对应 URL 参数范围。</li><li>Service Name：Service Name 是使用 gRPC 协议的服务名称，使用 gRPC 协议时支持配置此项，使用该协议时可以根据填写的 Service Name，将流量转发至对应的服务上，例如填写：`/helloworld.Greeter`。</li></ul>|
    |**会话保持**| 始终转发特定的访问请求至前述内部路由组对应的后端服务。<br/>特定的访问请求指（任选一种）：<ul><li>源地址哈希：源自同一 IP 地址的所有访问请求。</li><li>Cookie key：携带指定 Cookie 的访问请求。</li><li>Header name：携带指定 Header 的访问请求。</li></ul>|
    |**URL 重写**| 重写用户访问的地址为平台后端服务的地址。此功能要求同时配置 URL 的 Startswith 规则指标，且重写地址（rewrite-target）必须以 */* 开头。  <br/><br/>例如：分别设置了域名为 *bar.example.com* 以及 URL 起始路径为 `/` 的规则后，开启 **URL 重写** 功能并设置重写地址为 */test* 。则访问 *bar.example.com* 时，URL 将被重写为 *bar.example.com/test* 。 |
    |**后端协议**| 访问流量转发到后端服务时所用的协议。例如：如需转发到后端的 Kubernetes、dex 服务，需要选择 HTTPS 协议。 |
    |**重定向**| 将访问流量转发到重定向的新地址，而非内部路由组对应的后端服务。<br/>例如：原有访问地址页面升级或更新时，为避免用户得到一个 404 或 503 错误信息页面，可通过配置重定向，将已有流量都转发到新的地址。<ul><li>HTTP 状态码：在跳转重定向地址之前，浏览器呈现给用户的状态码。</li><li>重定向地址：输入相对地址时（例如  */index.html* ），流量转发的目的地址为 *负载均衡地址/index.html* ；输入绝对地址时（例如 *https://www.example.com* ），流量转发的目的地址即为输入的地址。</li></ul>|
    |**规则优先级**| 规则匹配的优先级：从 1-10 共 10 个等级，1 为最高优先级，默认优先级为 5。<br />当同时满足两条及以上规则时，高优先级规则被选中并应用；如果优先级相同，系统使用默认匹配规则。 |
    |**跨域资源共享（CORS）**| CORS（Cross-origin resource sharing，跨域资源共享）是一种机制，它使用额外的 HTTP 头来告诉浏览器 ，让运行在一个 origin (domain) 上的 Web 应用被准许访问来自不同源服务器上的指定的资源。当一个资源从与该资源本身所在的服务器不同的域、协议或端口请求一个资源时，资源会发起一个跨域 HTTP 请求。 |
    |**允许来源**|用于指定允许访问的来源。<ul><li>**\***：允许来自任意来源的请求。</li><li>**域名**：允许当前域名的请求。</li></ul>|
    |**允许标头**|用于指定在 CORS（跨源资源共享）中允许的 HTTP 请求头，避免不必要的预检请求，提高请求效率，填写示例如下：<br/><br/>**说明**：其他常用的或自定义请求头此处不再一一列举，具体请根据实际情况进行填写。<br/><br/><ul><li>**Origin**: 表示请求的来源，即发送请求的域名。</li><li>**Authorization**: 用于指定请求的授权信息，通常用于身份验证，比如基本身份验证（Basic Authentication）或令牌（Token）。</li><li>**Content-Type**: 用于指定请求/响应的内容类型，例如 application/json、application/x-www-form-urlencoded 等。</li><li>**Accept**: 用于指定客户端可以接受的内容类型，通常在客户端希望获取特定类型的响应时使用。</li></ul><br/>**预检请求补充说明**：预检请求是浏览器自动发送的一种请求，用于确认实际请求的安全性和可行性。当实际请求不符合 [简单请求](#request) 的条件时，浏览器会先发送一个 OPTIONS 请求到服务器，询问是否允许实际请求，只有在服务器确认允许后，浏览器才会发送实际请求，这个 OPTIONS 请求即为预检请求。|


3. 单击 **添加**。

## 相关说明

### 简单请求\{#request}
若请求满足如下所有条件，则该请求即可视为简单请求：

* 使用下列方法之一：
    * HEAD
    * GET
    * POST

* 除了被用户代理自动设置的标头字段，例如 Connection，User-Agent 以及在 Fetch 规范中定义为禁用标头名称的标头，其他允许人为设置的对 CORS 安全的标头字段集合。该集合包括：
    * Accept
    * Accept-Language
    * Content-Language
    * Content-Type（需要注意额外的限制）
    * Range（只允许简单的范围标头值，如 bytes=256- 或 bytes=127-255）

* Content-Type 的值仅限于下列内容之一：
    * text/plain
    * multipart/form-data
    * application/x-www-form-urlencoded
*  请求中的任意 XMLHttpRequest 对象均未注册任何事件监听器。
*  请求中未使用 ReadableStream 对象。