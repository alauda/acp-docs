---
weight: 10
---

# 创建 Deployment

部署（Deployment）是 Kubernetes 的一种工作负载控制器（Controllers），您可以通过创建一个 Deployment 来运行一个程序。也可以在应用中创建多个 Deployment 作为应用下的工作负载来为无状态应用提供特定的服务。

## 前提条件

### 获取镜像

镜像来源包括平台管理员通过工具链集成的镜像仓库，或第三方平台的镜像仓库。

* 对于前者，平台管理员通常会将镜像仓库分配给您的项目，然后您可使用其中的镜像。如果是第三方平台的镜像仓库，需确保在当前集群可从中拉取镜像。

* 如果拉取的镜像需要凭据，需要您先在当前命名空间下创建凭据（保密字典）。

## 操作步骤 1 - 配置基本信息\{#updatepolicy}

1. 进入 **Container Platform**。

1. 在左侧导航栏中，单击 **计算组件** > **部署**。

2. 单击 **创建部署**。

3. 配置镜像，单击 **确认**。

    **说明**：仅当使用本平台集成的镜像仓库中镜像时，可以通过 **选择** 方式筛选镜像。其中，集成项目名称例如 *containers（docker-registry-projectname）* ，包括本平台中的项目名 *projectname* ，以及镜像仓库中项目名 *containers* 。
    
4. 在 **基本信息** 区域，参考以下说明配置相关信息。

    
    |参数| 说明                |
    | ------------- | -------- |
    |**实例数**| Deployment 内期望运行的 Pod 个数，默认为 1 个，请按需修改。 |
    |**更多 > 更新策略**| 滚动更新（rollingUpdate）Deployment 时，Pod 的 **最大可超出数** 和 **最多不可用数**。滚动更新 Deployment 时，自动增加或删除 Pod，实现快速滚动更新。<br/>**说明**：如不设置，最大可超出数和最多不可用数的默认值均为 1。支持输入实例数量或百分比。<br/>**最大可超出数**：滚动更新时，计算组件的 Pod 数量最大可以超出的值。输入百分比后，Kubernetes 根据当前实例数量进行计算，出现小数时，向上取整。例如：4.1 会向上取整为 5。<br/>**最多不可用数**：滚动更新时， 计算组件的 Pod 数量最多不可用的值。百分比不能超过 100%。输入百分比后，Kubernetes 根据当前实例数量进行计算，出现小数时，向下取整。例如：4.9 会向下取整为 4。<br/>处在非运行状态的 Pod，均计入不可用数。<br/>**例如**：当 Pod 数为 10 时，最大可超出数值填写了 2，最多不可用数值填写了 3，在更新的过程中，新旧版本的可用 Pod 个数加起来不会超过 10+2 个，新旧版本的可用 Pod 个数加起来不会小于 10-3 个。<br/>**说明**：最大可超出数值和最多不可用数值不能同时为 0 或 0%。<br/>当填写百分比数值时，如果最大可超出数值向上取整为 0，最多不可用数值向下取整也为 0 时，Kubernetes 会调整最多不可用数值向上取整为 1。 |


## 操作步骤 2 - 配置容器组

**注意**：当混合架构的集群需部署单架构镜像时，请为容器组添加正确的 [调度配置](#schuconf)。

1. 在 **容器组** 区域，参考以下说明配置相关信息。

    |参数| 说明                |
    | ------------- | -------- |
    |**存储卷\{#4}**|  添加特定类型的存储卷，用于在容器中挂载该存储卷。存储卷类型说明请参考 [存储卷挂载说明](#pvmount)。 |
    |**镜像凭据**|  仅当使用的是 **输入** 方式填写镜像地址，即从第三方平台的镜像仓库中拉取镜像时，才需选择凭据。<br/>**说明**：若使用的是本平台集成的镜像仓库中镜像，后台已自动绑定所需凭据。 |
    |**关闭宽限期**|  从接受到 Pod 删除请求到 Pod 被正式删除之前，允许的最长等待时间，默认为 30 秒。设置该参数以便 Pod 在被停止前先处理完请求，优雅下线应用或通知其他应用。<br/>当设置 为 0 秒时，不管待删除的 Pod 上是否正在处理请求或执行命令，都将被立即强制删除。|
    
    
2. 调度配置\{#schuconf}

    |参数| 说明                |
    | ------------- | -------- |
    |**主机选择器**|  将容器组调度到符合条件的主机上运行。例如：如果集群中同时存在 Linux 和 Windows 两类节点，为避免将 Linux 应用调度到 Windows 节点上，需参考下例选择主机。<br/><img src="./assets/nodeselector_os.png" width = "500" /> |
    |**亲和性**|  基于节点上已有的目标 Pod 的标签，将新建 Pod 调度到符合亲和要求的节点上。目标 Pod 指当前命名空间下其他计算组件的 Pod。<ul><li>亲和：新 Pod 和指定 Pod 运行在同一主机上。</li><li>反亲和：新 Pod 和指定 Pod 不会运行在同一主机上。</li></ul><br/><br/>**高级** 方式可用于实现更复杂的亲和性调度需求：<ul><li>**Required**：新 Pod 只会被调度到完全符合亲和要求的节点上。</li><li>**Preferred**：新 Pod 会被尽量调度到符合亲和要求的节点上。系统将结合亲和性权重与其它调度需求（例如计算资源需求）确定可运行 Pod 的节点。</li></ul><br/>**主机拓扑域**：用于确定可调度目标 Pod 的主机，此处应填写主机的标签，默认为 `kubernetes.io/hostname`。<br/>**匹配标签**：用于筛选与新 Pod 亲和或反亲和的目标 Pod，此处需填写目标 Pod 的标签。 |


3. 网络配置。

    
    |参数| 说明                |
    | ------------- | -------- |
    |**带宽限制（Kube-OVN）**| 用于限制 Pod 内容器的最大上行/下行网络速率，以合理利用网络资源。<br/><ul><li>**上行带宽**：Pod 内容器上传数据的速率。</li><li>**下行带宽**：Pod 内容器下载数据的速率。</li></ul> |
    |**子网（Kube-OVN）**| 默认由系统自动分配，即根据管理员为您命名空间绑定的子网自动从中分配容器组使用的 IP。<br/>您也可以根据业务需求指定子网，此时容器组仅可以使用指定子网下的 IP。 |
    |**固定 IP （Kube-OVN）**| 绑定固定 IP 地址后，即使容器状态发生变化，如升级、回滚、切换主机等，容器组的 IP 地址保持不变。否则，将随机为容器组分配子网内的可用 IP 地址。<br/>**注意**：<br/><ul><li>多个计算组件的容器组可以重复绑定同一个 IP 地址为固定 IP 地址，但每次仅允许一个容器组使用该 IP 地址，即属于不同计算组件的容器组启动时将抢占该 IP 地址。</li><li>如果计算组件中存在多个实例（容器组），请保证您输入的 **固定 IP** 个数大于或等于实例数。例如：您设置了实例数量为 *3* ，但仅输入了一个固定 IP 地址时，则只有一个实例可正常启动。</li></ul> |
    |**固定 IP （Calico）**| 绑定固定 IP 地址后，即使容器状态发生变化，如升级、回滚、切换主机等，容器组的 IP 地址保持不变。否则，将随机为容器组分配子网内的可用 IP 地址。<br/>**注意**：<br/><ul><li>每个 IP 地址都只可供单一计算组件的容器组绑定为固定 IP 地址，不可重复绑定。</li><li>如果计算组件中存在多个实例（容器组），请保证您输入的 **固定 IP** 个数大于或等于实例数。例如：您设置了实例数量为 *3* ，但仅输入了一个固定 IP 地址时，则只有一个实例可正常启动。</li></ul> |


## 操作步骤 3 - 配置容器

1. 在 **容器** 区域，参考以下说明配置相关信息。
    
    |参数| 说明                |
    | ------------- | -------- |
    |**资源请求与资源限制**| 资源请求用于指定容器运行所需的最小 CPU 容量或内存量；资源限制用于指定容器运行中允许使用的最大 CPU 容量或内存量，具体单位说明请参考 [资源单位说明](/application/overview/unit.mdx)。<ul><li>命名空间未开启超售比：<br/>-- 若所在命名空间 <b>已设置 CPU 或内存资源限额</b>：创建部署时，容器对应的资源请求或限制存在默认值且支持修改。<br/>-- 若所在命名空间 <b>未设置资源限额</b>：无默认值，可自定义设置资源请求或资源限制。</li><li>命名空间开启超售比：<br/>用户自定义设置资源限制，平台将根据超售比自动计算出资源请求，且资源请求不支持修改。其中，资源请求等于资源限制与超售比的比值。<br/><br/></li></ul><b>注意</b>:<ul><li>资源请求值需小于等于资源限制值，且容器资源请求或限制值不能大于命名空间资源限制的最大值。</li><li>更新超售比不会立刻影响正在运行的容器组资源请求值，只有当容器组重建后，才会根据最新的超售比重新计算容器组资源请求值。</li><li>当命名空间开启超售比后，资源请求等于资源限制与超售比的比值，自定义的资源请求值不再生效。</li><li>当所在命名空间未设置资源配额与资源限额，创建部署时不会限制容器的资源请求与资源限制值。</li></ul>|
    |**扩展资源**|当集群中存在可用的扩展资源时，选择并配置扩展资源。|
    |**存储卷挂载**| 配置存储信息，实现容器中数据的持久存储。存储卷类型说明请参考 [存储卷挂载说明](#pvmount)。<ul><li>如果容器组中已经添加存储卷，单击 **添加**。</li><li>如果容器组中未添加存储卷，单击 **添加存储卷并挂载**。</li></ul>通用参数说明：<ul><li>**挂载路径**：在容器文件系统中，挂载存储卷的路径。</li><li>**子路径**：已存在的，容器可以用于存储数据的文件的相对路径。<br/>当存储卷类型为 `配置字典` 或 `保密字典` 时，支持选择一个配置项的键作为子路径。挂载路径拼接子路径构成完整的存储卷挂载路径，将指向具体的文件夹或文件名称。</li><li>**只读**：存储卷的访问方式。若开启，存储卷的访问方式为只读；若关闭，存储卷的访问方式为读写。<br/>更多信息请参考 [Volumes](https://kubernetes.io/docs/concepts/storage/volumes/)。</li></ul> |
    |**端口**| 待暴露的容器端口。以下示例表示将暴露容器上的 TCP 端口 *6379* ，并将其命名为 *redis* 。<ul><li>**协议**：容器端口使用的协议，例如 TCP 协议。</li><li>**端口**：后端 Pod 中暴露的容器端口。例如 *6379* 。当通过选择镜像方式，选择了 registry 镜像仓库内的镜像时，将自动填写镜像内 Dockerfile 暴露的容器端口。</li><li>**端口名称**：建议使用便于识别的名称，例如：*redis* 。</li></ul> |
    |**启动命令、参数**| 示例一：在启动容器时，执行 *top -b* 命令。<ul><li>在 **启动命令** 区域，添加 *top -b* 。</li><li>在 **启动命令** 区域，添加 *top* ，在 **参数** 区域，添加 *-b* 。</li></ul><br/>示例二：事先定义环境变量 *MESSAGE:Welcome!* ，在启动容器时，输出 *Welcome!* 。<ul><li>在 **启动命令** 区域，添加 */bin/sh  -c  "while true ; do echo $(MESSAGE) ; sleep 10 ; done"* 。</li><li>也可参考示例一中分别设置命名和参数。</li></ul><br/>更多示例和说明可参考 [官方文档](https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container)。 |
    |**环境变量**| <ul><li>直接设置环境变量的键和对应值。</li><li>将配置字典、保密字典、fieldRef、resourcefieldRef等对象中的字段引用为环境变量的值。</li></ul><br/>**注意**：通过环境变量添加相同的引用字段，会覆盖配置文件或镜像的相关配置。 |
    |**配置引用**| 通过完整引用配置字典或保密字典，将其中的配置项作为环境变量引入容器。且仅支持引用  **Opaque** 和 **用户名/密码** 两种类型的保密字典。 |
    |**健康检查**| **存活性健康检查**：检查计算组件是否处于健康状态，如果检测结果为非正常时，会根据健康检查的配置决定是否重启实例。<br/> **可用性健康检查**：检查计算组件是否启动完成并处于正常服务状态，如果检测到容器实例的健康状态为非正常时，容器状态会被更新。 <br/> <br/>相关参数说明请参考 [健康检查参数说明](#healthcheck)。|
    |**日志文件**|用于配置希望采集的容器日志，包括标准输出 `stdout` 以及容器内的日志文本文件。例如：`/var/log/*.log`，表示除了标准输出外，还会采集容器内 `/var/log/` 路径下的所有文本日志。<br/><br/>**说明**：<ul><li>容器存储驱动为 overlay2 时，默认支持此功能；如果容器存储驱动为 devicemapper，还需要自行挂载 Emptydir 类型的存储卷（volume）到日志文件所在的目录路径。</li><li>如果日志存储在集群中的 Windows 节点上，还需确保日志文件路径或其父路径已被挂载为存储卷。例如挂载 *c:/a* 后，便可设置采集 `c:/a/b/c/*.log` 相关日志。</li></ul> |
    |**排除日志文件**|在待采集的日志范围内，声明不需要采集和保存的日志文件。例如：`/var/log/aaa.log`，表示仅会采集容器内 `/var/log/` 路径下除 `aaa.log` 之外的所有文本日志。 |
    |**停止前执行**|   即 PreStop 脚本，在容器被删除前，将触发执行指定命令。例如：可在停止容器前执行 `echo "stop"` 命令，以验证容器删除前，容器日志是否可正常打印。<br/>**注意**：若容器组的 **关闭宽限期** 小于此处命令执行完毕所需耗时，即使命令未执行完，容器也将被强制删除。|
    
2. 单击右上角的 **添加容器** 或  <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px', verticalAlign: 'middle' }}><img src="./assets/expand.png" alt="expand" style={{ verticalAlign: 'middle' }} /> <span> > **添加初始化容器**</span></span>。

    
    初始化容器说明如下，更多信息请参考 [Init Containers](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/) 。
    
    * 容器组启动时，会优先启动初始化容器，初始化容器都运行完成后才会启动普通业务容器。当容器组内有多个初始化容器时，将按照添加顺序依次启动，且下一个初始化容器启动前，必须等待上一个初始化容器运行完成。初始化容器运行完成即会释放 CPU、内存资源。
        
    * 当容器组下有超过 2 个的容器或至少有 1 个初始化容器时，支持删除容器/初始化容器；当仅有一个业务容器时，不支持删除该容器。
 
3. 单击 **确定**。

## 参考信息   ​   

### 存储卷挂载说明\{#pvmount}
    
|类型| 用途                                                         |
| ------------ | ------------------------------------------------------------ |
|**持久卷声明**| 选择一个已创建的 [持久卷声明](/application/building_application/functions/preparation_before_creating/add_pvc.mdx)，用于请求持久卷作为存储资源。<br/>**注意**：仅支持选择已绑定持久卷的持久卷声明。如果持久卷声明未绑定持久卷（PV），将会导致容器组创建失败。 |
|**配置字典**| 将整个 [配置字典](/application/building_application/functions/preparation_before_creating/add_configmap.mdx)  或其中部分数据添加到存储卷中，并将存储卷挂载到容器文件系统。此方式相比通过环境变量引用挂载配置字典，可方便进行 [配置热更新](/application/building_application/functions/operation_after_creating/hotreload.mdx) ，降低修改配置后重启容器组对业务可用性的影响。<ol><li>选择配置文件后，将使用整个配置文件作为存储路径。并根据配置文件当中的键在该路径下生成存储文件，键为存储文件的名称，对应的值为存储内容。若更新配置字典，存储路径下的文件会同步更新 ，并且会覆盖该路径下的原有文件。</li><li>您也可选择配置字典的键作为子路径，例如： `my.cnf`。如果需要使用配置字典的多个键作为挂载存储卷的子路径，可重复上述步骤。</li></ol> |
|**保密字典**| 将整个 [保密字典](/application/building_application/functions/preparation_before_creating/add_secret.mdx) 或其中的部分配置项，以存储卷的形式挂载到容器文件系统中。<br/>具体操作如下：<br/><ul><li>选择保密字典后，将使用整个保密文件作为存储路径。并根据保密文件当中的键在该路径下生成存储文件，键为存储文件的名称，对应的值为存储内容。若更新保密字典，存储路径下的文件会同步更新 ，并且会覆盖该路径下的原有文件。</li><li>您也可选择保密字典的键作为子路径。例如： `my.cnf`。 如果需要使用保密字典的多个键作为挂载存储卷的子路径，可重复此步骤。</li></ul> |
|**通用临时卷**|由集群存储驱动程序处理的卷，具有不局限于特定的存储类型或插件、可动态创建、可扩展、通过声明式的方式定义和使用临时存储、配置相对简单等特性。卷的生命周期与定义它的 Pod 绑定在一起，它将在 Pod 启动前创建，并在移除 Pod 时删除，此类型的卷适用于存储大量临时数据或其他不需要持久化保存的数据信息，具体参数说明请参考 [创建持久卷声明](/application/building_application/functions/preparation_before_creating/add_pvc.mdx)。|
|**空目录**| 如果设置了容器的存储卷类型为 **空目录**，Pod 被分配到主机上时，会创建空目录，如果容器运行在主机上，空目录会一直存在，如果容器被从主机上删除，空目录会被删除，数据丢失。空目录便于运行在同一个 Pod 下的容器共享文件，也支持单个容器短暂性的在磁盘中写入数据。 |
|**主机路径**| 将容器数据存储到主机本地文件系统路径。主机路径需以 `/` 开头，例如： `/volumepath`。 |

### 健康检查参数说明\{#healthcheck}

|参数|描述|
|---|---|
|**启动时间**| 输入启动计算组件所需要的预估秒数，即启动预估时间内的健康检查失败结果会被忽略，直到首次健康监测成功。默认数值是 `300`。|
|**间隔**| 输入每次健康检查的时间间隔秒数。范围：1 ~ 120。默认数值是 `60`。|
|**超时时长**| 输入等待 HTTP 返回值的超时秒数。超时一次记录为一次健康监测失败。范围：1 ~ 300。默认设置是 `30`。|
|**正常阈值**| 输入健康检查成功的最少连续次数。当达到这个正常阈值时，健康检查即通过。默认数值是 `0`。|
|**不正常阈值**| 输入健康检查失败的最多次数。当达到输入的最大次数后，计算组件会被重启。当输入 `0` 的时候，健康检查的失败次数被忽略，容器不会重启。默认数值是 `5`。|
|**协议**| （HTTP 协议类型）HTTP、HTTPS。|
|**端口**| （HTTP 或 TCP 协议类型）输入要监测的容器端口号。|
|**路径**| （HTTP 协议类型）输入要监测页面的协议路径。例如：```/login.html```。|
|**请求头**| （HTTP 协议类型）单击 **添加**，输入一个或多个自定义的请求 header 的 name 和 value。|
|**启动命令**| （EXEC 协议类型）输入在容器中的监测命令。可以通过 docker exec 命令执行。可以使用绝对路径。如果使用命令名称或脚本名称，需要执行 docker exec 命令测试程序是否可以正常执行。如果含有双引号，需要转义。|


