---
weight: 40
---

# 创建数据库实例

本文档将指导您如何通过命令行界面（CLI）创建 MySQL-MGR 数据库实例。通过 CLI 创建实例可以实现自动化部署，并且能够精确控制实例的各项配置参数。

## 前提条件

在创建 MySQL-MGR 实例之前，请确保您已满足以下条件：

- 已安装 kubectl 命令行工具并配置好访问权限
- 已安装 MySQL-MGR Operator
- 拥有目标命名空间的创建权限
- 了解 MySQL-MGR 的基本配置参数

## 基本创建流程

### 准备配置文件

创建一个名为 `mysql-mgr-instance.yaml` 的配置文件，包含以下内容：

```yaml
apiVersion: apps.kubeblocks.io/v1alpha1
kind: Cluster
meta
  name: mysql-mgr-instance
  namespace: default
spec:
  clusterDefinitionRef: mysql-mgr
  clusterVersionRef: mysql-8.0.30
  terminationPolicy: WipeOut
  affinity:
    podAntiAffinity: Preferred
    topologyKeys:
      - kubernetes.io/hostname
  tolerations: []
  replicas: 3
  resources:
    cpu: "2"
    memory: 4Gi
  storage:
    size: 20Gi
    storageClassName: standard
  services:
    - name: mysql
      serviceType: ClusterIP
  initializeConfig:
    rootPassword: "YourStrongPassword"
```

### 应用配置创建实例

使用以下命令应用配置文件，创建 MySQL-MGR 实例：

```bash
kubectl apply -f mysql-mgr-instance.yaml
```

### 查看创建进度

您可以使用以下命令查看实例的创建进度：

```bash
kubectl get cluster mysql-mgr-instance -n default
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default
```

实例创建完成后，您将看到 3 个 Pod 处于 Running 状态。

## 高级配置选项

### 配置高可用参数

您可以通过以下参数配置 MySQL-MGR 的高可用特性：

```yaml
spec:
  replicas: 3  # 副本数量，建议至少为 3
  affinity:
    podAntiAffinity: Required  # 强制将 Pod 分布在不同节点
    topologyKeys:
      - kubernetes.io/hostname
      - topology.kubernetes.io/zone  # 支持跨可用区部署
```

### 配置资源规格

根据业务需求配置适当的计算和存储资源：

```yaml
spec:
  resources:
    cpu: "4"        # CPU 核心数
    memory: 8Gi     # 内存大小
  storage:
    size: 100Gi     # 存储容量
    storageClassName: premium-ssd  # 存储类型
```

### 配置网络访问

配置服务类型和网络策略：

```yaml
spec:
  services:
    - name: mysql
      serviceType: ClusterIP  # 集群内部访问
    - name: mysql-external
      serviceType: LoadBalancer  # 外部访问
      annotations:
        service.beta.kubernetes.io/aws-load-balancer-type: nlb
```

### 配置参数模板

使用预定义的参数模板优化数据库配置：

```yaml
spec:
  parameterTemplate: "mysql-mgr-oltp-template"  # 指定参数模板
```

### 配置备份策略

设置自动备份策略：

```yaml
spec:
  backup:
    enabled: true
    schedule: "0 2 * * *"  # 每天凌晨 2 点执行备份
    retentionPeriod: 7d    # 保留 7 天的备份
    storageProvider:
      s3:
        bucket: mysql-backups
        region: us-west-2
```

## 创建多环境实例

### 开发环境实例

开发环境通常需要较少的资源，可以使用以下配置：

```yaml
apiVersion: apps.kubeblocks.io/v1alpha1
kind: Cluster
meta
  name: mysql-mgr-dev
  namespace: development
spec:
  clusterDefinitionRef: mysql-mgr
  clusterVersionRef: mysql-8.0.30
  terminationPolicy: Delete
  replicas: 1  # 开发环境可以只用单实例
  resources:
    cpu: "1"
    memory: 2Gi
  storage:
    size: 10Gi
  services:
    - name: mysql
      serviceType: ClusterIP
  initializeConfig:
    rootPassword: "DevPassword123"
```

### 生产环境实例

生产环境需要更高的可用性和性能，可以使用以下配置：

```yaml
apiVersion: apps.kubeblocks.io/v1alpha1
kind: Cluster
meta
  name: mysql-mgr-prod
  namespace: production
spec:
  clusterDefinitionRef: mysql-mgr
  clusterVersionRef: mysql-8.0.30
  terminationPolicy: WipeOut
  affinity:
    podAntiAffinity: Required
    topologyKeys:
      - kubernetes.io/hostname
      - topology.kubernetes.io/zone
  replicas: 5  # 生产环境使用更多副本
  resources:
    cpu: "8"
    memory: 16Gi
  storage:
    size: 500Gi
    storageClassName: premium-ssd
  services:
    - name: mysql
      serviceType: ClusterIP
    - name: mysql-external
      serviceType: LoadBalancer
  parameterTemplate: "mysql-mgr-production-template"
  backup:
    enabled: true
    schedule: "0 */6 * * *"  # 每 6 小时备份一次
    retentionPeriod: 30d     # 保留 30 天的备份
  initializeConfig:
    rootPassword: "ProdStrongPassword123"
```

## 从已有实例复制创建

您可以基于现有实例的配置创建新实例：

1. 导出现有实例的配置：

```bash
kubectl get cluster existing-mysql-mgr -n default -o yaml > existing-config.yaml
```

2. 修改配置文件，更改实例名称和其他需要调整的参数：

```bash
sed -i 's/name: existing-mysql-mgr/name: new-mysql-mgr/g' existing-config.yaml
```

3. 应用修改后的配置创建新实例：

```bash
kubectl apply -f existing-config.yaml
```

## 验证实例创建

### 检查实例状态

使用以下命令检查实例状态：

```bash
kubectl get cluster mysql-mgr-instance -n default -o wide
```

### 检查 Pod 状态

确认所有 Pod 都处于 Running 状态：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default
```

### 检查服务状态

查看创建的服务和连接信息：

```bash
kubectl get svc -l app.kubernetes.io/instance=mysql-mgr-instance -n default
```

### 测试连接

使用以下命令测试连接到数据库：

```bash
kubectl run mysql-client --rm -it --image=mysql:8.0 -- mysql -h mysql-mgr-instance-mysql -u root -p
```

系统会提示输入密码，输入创建实例时设置的 root 密码即可连接到数据库。

## 常见问题处理

### 实例创建失败

如果实例创建失败，可以查看事件和日志进行排查：

```bash
kubectl describe cluster mysql-mgr-instance -n default
kubectl logs -l app.kubernetes.io/instance=mysql-mgr-instance -n default
```

### 存储类不可用

如果遇到存储类不可用的问题，可以查看可用的存储类并修改配置：

```bash
kubectl get storageclass
```

然后修改配置文件中的 `storageClassName` 字段，使用可用的存储类。

### 资源不足

如果集群资源不足，可能导致 Pod 无法调度，可以查看节点资源状态：

```bash
kubectl describe nodes
```

然后调整配置文件中的资源请求，或者增加集群节点。

## 后续步骤

成功创建 MySQL-MGR 实例后，您可以进一步：

- [连接数据库实例](./connect_database.mdx)：了解如何连接和访问数据库
- [参数配置](./parameter_config.mdx)：优化数据库参数配置
- [管理数据库实例](../manage-database/intro.mdx)：学习实例的日常管理操作
