---
weight: 10
---

# 如何将 MySQL-PXC 数据迁移到 MySQL-MGR

## 问题描述

在企业环境中，您可能需要将现有的 MySQL-PXC 集群数据迁移到 MySQL-MGR 集群。这种迁移需求可能源于以下原因：

- 需要利用 MySQL-MGR 提供的新特性和改进的性能
- 现有 PXC 集群面临扩展性或稳定性问题
- 企业技术栈标准化，统一使用 MySQL-MGR 作为高可用数据库解决方案
- 需要更好的跨区域部署支持

迁移过程中的主要挑战包括：

- 确保数据完整性和一致性
- 最小化服务中断时间
- 处理 PXC 和 MGR 之间的架构差异
- 验证迁移后的数据和功能

## 根因分析

MySQL-PXC (Percona XtraDB Cluster) 和 MySQL-MGR (MySQL Group Replication) 是两种不同的高可用数据库解决方案，它们在架构和实现机制上存在显著差异：

1. **复制技术**：
   - PXC 使用 Galera 复制技术，采用同步复制机制
   - MGR 使用 MySQL 原生的 Group Replication 技术，支持同步或半同步复制

2. **数据一致性**：
   - PXC 提供强一致性保证，所有节点上的数据始终一致
   - MGR 在单主模式下提供强一致性，在多主模式下可能需要额外配置

3. **存储引擎**：
   - PXC 使用 XtraDB 存储引擎（InnoDB 的增强版）
   - MGR 仅支持 InnoDB 存储引擎

4. **集群通信**：
   - PXC 使用 Galera 库进行节点间通信
   - MGR 使用 MySQL 原生的组通信框架

这些差异导致直接从一个系统切换到另一个系统并不简单，需要进行数据迁移和配置调整。

## 问题排查

在开始迁移前，需要进行以下排查工作：

1. **检查数据库版本兼容性**：
   ```bash
   kubectl exec -it mysql-pxc-instance-0 -n default -- mysql -e "SELECT VERSION();"
   ```

2. **检查存储引擎**：
   ```bash
   kubectl exec -it mysql-pxc-instance-0 -n default -- mysql -e "SELECT TABLE_NAME, ENGINE FROM information_schema.TABLES WHERE TABLE_SCHEMA NOT IN ('mysql','information_schema','performance_schema');"
   ```
   确保所有表都使用 InnoDB 引擎，因为 MGR 只支持 InnoDB。

3. **检查表结构**：
   ```bash
   kubectl exec -it mysql-pxc-instance-0 -n default -- mysqldump --no-data --all-databases > schema.sql
   ```
   检查 schema.sql 文件中是否有 MGR 不支持的特性。

4. **检查数据大小**：
   ```bash
   kubectl exec -it mysql-pxc-instance-0 -n default -- mysql -e "SELECT table_schema, ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)' FROM information_schema.tables GROUP BY table_schema;"
   ```
   评估迁移所需的时间和资源。

## 解决方案

### 注意事项

在开始迁移前，请注意以下事项：

- 迁移过程会导致短暂的服务中断，请在业务低峰期进行
- 确保目标 MGR 集群有足够的存储空间和计算资源
- 备份所有数据，以防迁移过程中出现问题
- 测试迁移计划，确保能够在计划的时间窗口内完成
- 准备回滚计划，以应对迁移失败的情况

### 前提条件

- 源 MySQL-PXC 集群正常运行
- 已创建目标 MySQL-MGR 集群
- 两个集群之间网络连通
- 具有足够权限执行迁移操作
- 已准备足够的存储空间用于备份

### 操作步骤

#### 方法一：使用逻辑备份和恢复

这种方法适用于中小型数据库，通过 mysqldump 工具导出数据并导入到新集群。

1. **准备工作**：

   创建一个临时 Pod 用于执行迁移操作：

   ```bash
   kubectl apply -f - <<EOF
   apiVersion: v1
   kind: Pod
   meta
     name: mysql-migration-tool
     namespace: default
   spec:
     containers:
     - name: mysql-client
       image: mysql:8.0
       command: ["sleep", "infinity"]
       volumeMounts:
       - name: backup-volume
         mountPath: /backup
     volumes:
     - name: backup-volume
       persistentVolumeClaim:
         claimName: mysql-backup-pvc
   EOF
   ```

   创建用于存储备份的 PVC：

   ```bash
   kubectl apply -f - <<EOF
   apiVersion: v1
   kind: PersistentVolumeClaim
   meta
     name: mysql-backup-pvc
     namespace: default
   spec:
     accessModes:
     - ReadWriteOnce
     resources:
       requests:
         storage: 100Gi
   EOF
   ```

2. **停止写入操作**：

   在迁移前，停止所有对源数据库的写入操作，可以通过将应用切换到只读模式或暂停应用服务来实现。

3. **导出数据**：

   进入迁移工具 Pod 并导出数据：

   ```bash
   kubectl exec -it mysql-migration-tool -n default -- bash
   
   # 在 Pod 内执行
   mysqldump -h mysql-pxc-instance -u root -p --all-databases --single-transaction --set-gtid-purged=OFF --triggers --routines --events > /backup/full_backup.sql
   ```

4. **导入数据到 MGR 集群**：

   ```bash
   # 仍在迁移工具 Pod 内执行
   mysql -h mysql-mgr-instance-mysql -u root -p < /backup/full_backup.sql
   ```

5. **验证数据**：

   ```bash
   # 检查表数量是否一致
   mysql -h mysql-pxc-instance -u root -p -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema NOT IN ('mysql','information_schema','performance_schema');"
   
   mysql -h mysql-mgr-instance-mysql -u root -p -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema NOT IN ('mysql','information_schema','performance_schema');"
   
   # 对重要表进行数据量验证
   mysql -h mysql-pxc-instance -u root -p -e "SELECT COUNT(*) FROM important_db.important_table;"
   
   mysql -h mysql-mgr-instance-mysql -u root -p -e "SELECT COUNT(*) FROM important_db.important_table;"
   ```

6. **切换应用连接**：

   更新应用配置，将数据库连接从 PXC 集群切换到 MGR 集群。

7. **清理资源**：

   ```bash
   kubectl delete pod mysql-migration-tool -n default
   kubectl delete pvc mysql-backup-pvc -n default
   ```

#### 方法二：使用物理备份和恢复

对于大型数据库，使用物理备份工具如 Percona XtraBackup 可能更高效：

1. **安装 XtraBackup 工具**：

   ```bash
   kubectl apply -f - <<EOF
   apiVersion: v1
   kind: Pod
   meta
     name: xtrabackup-tool
     namespace: default
   spec:
     containers:
     - name: xtrabackup
       image: percona/percona-xtrabackup:8.0
       command: ["sleep", "infinity"]
       volumeMounts:
       - name: backup-volume
         mountPath: /backup
     volumes:
     - name: backup-volume
       persistentVolumeClaim:
         claimName: mysql-backup-pvc
   EOF
   ```

2. **创建物理备份**：

   ```bash
   kubectl exec -it xtrabackup-tool -n default -- bash
   
   # 在 Pod 内执行
   xtrabackup --backup --host=mysql-pxc-instance --user=root --password=your_password --target-dir=/backup/xtrabackup
   ```

3. **准备备份**：

   ```bash
   xtrabackup --prepare --target-dir=/backup/xtrabackup
   ```

4. **停止 MGR 集群**：

   ```bash
   kubectl scale statefulset mysql-mgr-instance-mysql -n default --replicas=0
   ```

5. **复制备份文件到 MGR 数据目录**：

   这一步需要创建一个特殊的 Job 来完成：

   ```bash
   kubectl apply -f - <<EOF
   apiVersion: batch/v1
   kind: Job
   meta
     name: restore-backup
     namespace: default
   spec:
     template:
       spec:
         containers:
         - name: restore
           image: percona/percona-xtrabackup:8.0
           command:
           - bash
           - -c
           - |
             cp -r /backup/xtrabackup/* /var/lib/mysql/
             chown -R 1001:1001 /var/lib/mysql/
           volumeMounts:
           - name: backup-volume
             mountPath: /backup
           - name: data-volume
             mountPath: /var/lib/mysql
         restartPolicy: Never
         volumes:
         - name: backup-volume
           persistentVolumeClaim:
             claimName: mysql-backup-pvc
         - name: data-volume
           persistentVolumeClaim:
             claimName: data-mysql-mgr-instance-mysql-0
   EOF
   ```

6. **启动 MGR 集群**：

   ```bash
   kubectl scale statefulset mysql-mgr-instance-mysql -n default --replicas=3
   ```

7. **验证数据并切换应用连接**：

   与方法一类似，验证数据完整性并更新应用配置。

#### 方法三：使用 MySQL 复制

对于需要最小停机时间的场景，可以使用 MySQL 复制机制：

1. **配置 PXC 作为主库**：

   ```bash
   kubectl exec -it mysql-pxc-instance-0 -n default -- mysql -u root -p -e "
   CREATE USER 'repl'@'%' IDENTIFIED BY 'replpass';
   GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
   FLUSH PRIVILEGES;
   "
   ```

2. **获取 PXC 二进制日志位置**：

   ```bash
   kubectl exec -it mysql-pxc-instance-0 -n default -- mysql -u root -p -e "SHOW MASTER STATUS\G"
   ```

   记录 File 和 Position 值。

3. **导出 PXC 数据**：

   ```bash
   kubectl exec -it mysql-migration-tool -n default -- bash
   
   # 在 Pod 内执行
   mysqldump -h mysql-pxc-instance -u root -p --all-databases --single-transaction --master-data=2 > /backup/full_backup.sql
   ```

4. **导入数据到 MGR 集群**：

   ```bash
   mysql -h mysql-mgr-instance-mysql -u root -p < /backup/full_backup.sql
   ```

5. **配置 MGR 作为从库**：

   ```bash
   kubectl exec -it mysql-mgr-instance-mysql-0 -n default -- mysql -u root -p -e "
   CHANGE MASTER TO
   MASTER_HOST='mysql-pxc-instance',
   MASTER_USER='repl',
   MASTER_PASSWORD='replpass',
   MASTER_LOG_FILE='recorded_log_file',
   MASTER_LOG_POS=recorded_position;
   
   START SLAVE;
   "
   ```

6. **监控复制状态**：

   ```bash
   kubectl exec -it mysql-mgr-instance-mysql-0 -n default -- mysql -u root -p -e "SHOW SLAVE STATUS\G"
   ```

7. **切换应用连接**：

   当复制延迟接近零时，停止应用写入 PXC，等待 MGR 完全同步后，将应用切换到 MGR。

8. **停止复制并启用 MGR**：

   ```bash
   kubectl exec -it mysql-mgr-instance-mysql-0 -n default -- mysql -u root -p -e "
   STOP SLAVE;
   RESET SLAVE ALL;
   "
   ```

## 预防措施

为避免未来迁移过程中的问题，建议采取以下预防措施：

1. **标准化数据库设计**：
   - 使用 InnoDB 存储引擎
   - 避免使用特定于某一技术的特性
   - 使用标准的 SQL 语法

2. **实施数据库版本控制**：
   - 使用数据库迁移工具管理架构变更
   - 记录所有架构变更的脚本

3. **定期测试迁移流程**：
   - 在非生产环境中模拟迁移过程
   - 验证迁移后的功能和性能

4. **建立监控系统**：
   - 监控数据库性能和健康状况
   - 设置告警以便及时发现问题

5. **制定灾难恢复计划**：
   - 定期备份数据
   - 测试恢复流程
   - 准备回滚方案

## 相关内容

- [MySQL 官方文档 - 使用 mysqldump 进行逻辑备份](https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html)
- [Percona XtraBackup 文档](https://www.percona.com/doc/percona-xtrabackup/8.0/index.html)
- [MySQL 复制配置指南](https://dev.mysql.com/doc/refman/8.0/en/replication-configuration.html)
- [MySQL Group Replication 文档](https://dev.mysql.com/doc/refman/8.0/en/group-replication.html)
