---
weight: 60
---

# 设置小版本升级策略

本文档将指导您如何通过命令行界面（CLI）为 MySQL-MGR 实例设置小版本升级策略。合理的升级策略可以确保数据库软件保持最新状态，同时最小化升级对业务的影响。

## 功能简介

小版本升级策略是控制 MySQL-MGR 实例如何接收补丁版本更新的机制。MySQL 版本通常遵循 X.Y.Z 格式，其中 X 是主版本号，Y 是次版本号，Z 是补丁版本号。小版本升级通常指的是补丁版本的更新（如从 8.0.28 升级到 8.0.30），这些更新主要包含错误修复和安全补丁，通常不会引入不兼容的更改。

设置小版本升级策略可以帮助您：
- 自动应用重要的安全补丁和错误修复
- 控制升级的时间和方式，最小化对业务的影响
- 根据业务需求和风险承受能力选择合适的升级策略
- 保持数据库软件的安全性和稳定性

## 主要功能

- **自动升级**：系统自动应用补丁版本更新
- **手动确认**：系统提示有可用更新，但需要手动确认
- **禁止升级**：不自动升级，需要手动触发升级操作
- **维护窗口设置**：指定执行升级的时间段

## 功能优势

- **灵活控制**：根据业务需求和风险承受能力选择合适的升级策略
- **自动化管理**：减少手动操作，提高运维效率
- **安全保障**：及时应用安全补丁，保障数据库安全
- **业务连续性**：通过维护窗口设置，最小化升级对业务的影响

## 设置小版本升级策略

### 查看当前升级策略

在设置升级策略前，先检查实例的当前升级策略：

```bash
kubectl get cluster mysql-mgr-instance -n default -o jsonpath='{.spec.upgradePolicy}'
```

如果未设置升级策略，此命令可能不返回任何结果。

### 设置自动升级策略

使用以下命令设置自动升级策略，系统将自动应用补丁版本更新：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"upgradePolicy":{"autoUpgrade":true}}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `mysql-mgr-instance` | 要设置策略的实例名称 |
| `default` | 实例所在的命名空间 |
| `{"autoUpgrade":true}` | 启用自动升级 |

### 设置手动确认策略

使用以下命令设置手动确认策略，系统将提示有可用更新，但需要手动确认：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"upgradePolicy":{"autoUpgrade":false,"manualConfirm":true}}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `{"autoUpgrade":false,"manualConfirm":true}` | 禁用自动升级，启用手动确认 |

### 设置禁止升级策略

使用以下命令设置禁止升级策略，系统不会自动升级，也不会提示有可用更新：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"upgradePolicy":{"autoUpgrade":false,"manualConfirm":false}}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `{"autoUpgrade":false,"manualConfirm":false}` | 禁用自动升级和手动确认 |

### 设置维护窗口

使用以下命令设置维护窗口，指定执行升级的时间段：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"upgradePolicy":{"autoUpgrade":true,"maintenanceWindow":{"dayOfWeek":"Sunday","startTime":"02:00","endTime":"04:00","timeZone":"Asia/Shanghai"}}}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `"dayOfWeek":"Sunday"` | 执行升级的星期几，可选值：Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday |
| `"startTime":"02:00"` | 维护窗口开始时间，24小时制 |
| `"endTime":"04:00"` | 维护窗口结束时间，24小时制 |
| `"timeZone":"Asia/Shanghai"` | 时区，使用 IANA 时区数据库格式 |

### 验证升级策略设置

使用以下命令验证升级策略是否已成功设置：

```bash
kubectl get cluster mysql-mgr-instance -n default -o jsonpath='{.spec.upgradePolicy}'
```

应返回您设置的升级策略配置。

## 手动触发小版本升级

如果您设置了手动确认或禁止升级策略，但希望手动触发升级，可以使用以下方法：

### 查看可用的版本更新

首先，检查是否有可用的版本更新：

```bash
kubectl get clusterversion -l app.kubernetes.io/name=mysql-mgr
```

这将显示所有可用的 MySQL-MGR 版本。

### 更新实例版本引用

使用以下命令更新实例的版本引用：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"clusterVersionRef":"mysql-8.0.30"}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `"clusterVersionRef":"mysql-8.0.30"` | 要升级到的目标版本 |

### 监控升级进度

升级命令发出后，您可以监控升级进度：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default -w
```

您将看到 Pod 被逐个重新创建，这是滚动升级过程的一部分。

### 验证升级结果

使用以下命令验证实例是否已成功升级到新版本：

```bash
kubectl exec -it mysql-mgr-instance-mysql-0 -n default -- mysql -u root -p -e "SELECT VERSION()"
```

应返回升级后的 MySQL 版本。

## 使用限制与注意事项

在设置小版本升级策略时，请注意以下限制和注意事项：

### 升级的影响

- **服务中断**：虽然小版本升级通常采用滚动升级方式，但仍可能导致短暂的服务中断。
- **性能影响**：升级过程可能暂时影响数据库性能。
- **兼容性问题**：虽然小版本升级通常不会引入不兼容的更改，但仍建议在升级前测试应用程序兼容性。
- **资源消耗**：升级过程会消耗额外的系统资源。

### 最佳实践

- **测试环境验证**：在生产环境升级前，先在测试环境验证升级过程和结果。
- **备份数据**：在升级前，确保有最新的备份可用。
- **选择合适的维护窗口**：将维护窗口设置在业务低峰期，最小化对业务的影响。
- **监控升级过程**：升级期间密切监控数据库状态和性能。
- **准备回滚计划**：制定升级失败时的回滚计划。
- **分阶段升级**：对于大型部署，考虑分阶段升级，先升级部分实例，验证无问题后再升级其余实例。

## 常见问题处理

### 升级失败

如果升级过程失败，可能的原因和解决方法：

1. **资源不足**：
   ```bash
   kubectl describe nodes
   ```
   检查集群资源是否充足。

2. **配置冲突**：
   ```bash
   kubectl logs mysql-mgr-instance-mysql-0 -n default
   ```
   检查数据库日志，查找可能的配置冲突。

3. **版本兼容性问题**：
   确认目标版本与当前配置兼容。

### 升级后性能下降

如果升级后发现性能下降，可能的原因和解决方法：

1. **参数配置不兼容**：
   新版本可能需要调整某些参数配置。

2. **统计信息过时**：
   ```bash
   kubectl exec -it mysql-mgr-instance-mysql-0 -n default -- mysql -u root -p -e "ANALYZE TABLE your_table"
   ```
   更新表统计信息。

3. **查询计划变化**：
   检查关键查询的执行计划是否发生变化。

### 维护窗口设置无效

如果维护窗口设置似乎不生效，可能的原因和解决方法：

1. **时区配置错误**：
   确认时区设置正确。

2. **格式错误**：
   确认时间格式正确（24小时制）。

3. **系统时间不同步**：
   确认系统时间与实际时间同步。

## 后续步骤

成功设置小版本升级策略后，您可以进一步：

- [参数配置](../config-database/parameter_config.mdx)：根据新版本特性调整参数配置
