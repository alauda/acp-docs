---
weight: 80
---

# 调度配置更新

本文档将指导您如何通过命令行界面（CLI）更新 MySQL-MGR 实例的调度配置。合理的调度配置可以优化实例在集群中的部署位置，提高资源利用率和服务可靠性。

## 功能简介

调度配置是控制 MySQL-MGR 实例在 Kubernetes 集群中的部署位置和资源分配策略的机制。通过调度配置，您可以指定实例应该部署在哪些节点上，如何与其他工作负载共存，以及如何分配资源。

调度配置功能在以下场景中特别有用：
- 将数据库实例分布在不同的物理节点上，提高可用性
- 将数据库实例与特定的应用部署在同一节点上，减少网络延迟
- 将数据库实例部署在具有特定硬件（如 SSD 存储）的节点上，提高性能
- 避免数据库实例与资源密集型应用共享节点，减少资源竞争

## 主要功能

- **节点选择器**：指定实例应该部署在哪些节点上
- **亲和性设置**：控制实例与其他工作负载的部署关系
- **反亲和性设置**：确保实例的不同副本分布在不同节点上
- **容忍度设置**：允许实例部署在带有特定污点的节点上
- **拓扑分布**：控制实例在不同拓扑域（如可用区）的分布

## 功能优势

- **提高可用性**：通过合理的调度策略，提高服务的可用性和可靠性
- **优化性能**：将实例部署在最适合的节点上，提高性能
- **资源隔离**：避免与其他工作负载的资源竞争
- **灵活部署**：根据业务需求和基础设施特点，灵活调整部署策略

## 更新节点选择器

节点选择器用于指定实例应该部署在哪些节点上，基于节点标签进行选择。

### 查看当前节点选择器

在更新节点选择器前，先检查实例的当前设置：

```bash
kubectl get cluster mysql-mgr-instance -n default -o jsonpath='{.spec.nodeSelector}'
```

### 设置节点选择器

使用以下命令设置 MySQL-MGR 实例的节点选择器：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"nodeSelector":{"disk-type":"ssd","kubernetes.io/os":"linux"}}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `mysql-mgr-instance` | 要更新的实例名称 |
| `default` | 实例所在的命名空间 |
| `{"disk-type":"ssd","kubernetes.io/os":"linux"}` | 节点选择器配置，指定节点必须有这些标签 |

### 查看可用的节点标签

要查看集群中节点的标签，可以使用以下命令：

```bash
kubectl get nodes --show-labels
```

### 验证节点选择器设置

更新节点选择器后，验证 Pod 是否被调度到符合条件的节点上：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default -o wide
```

检查 `NODE` 列，确认 Pod 被调度到具有指定标签的节点上。

## 更新亲和性设置

亲和性设置用于控制实例与其他工作负载的部署关系，包括节点亲和性和 Pod 亲和性。

### 查看当前亲和性设置

在更新亲和性设置前，先检查实例的当前设置：

```bash
kubectl get cluster mysql-mgr-instance -n default -o jsonpath='{.spec.affinity}'
```

### 设置节点亲和性

使用以下命令设置 MySQL-MGR 实例的节点亲和性：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '
{
  "spec": {
    "affinity": {
      "nodeAffinity": {
        "requiredDuringSchedulingIgnoredDuringExecution": {
          "nodeSelectorTerms": [
            {
              "matchExpressions": [
                {
                  "key": "kubernetes.io/role",
                  "operator": "In",
                  "values": ["database"]
                }
              ]
            }
          ]
        }
      }
    }
  }
}'
```

这个配置要求 Pod 必须调度到带有 `kubernetes.io/role=database` 标签的节点上。

### 设置 Pod 亲和性

使用以下命令设置 MySQL-MGR 实例的 Pod 亲和性：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '
{
  "spec": {
    "affinity": {
      "podAffinity": {
        "preferredDuringSchedulingIgnoredDuringExecution": [
          {
            "weight": 100,
            "podAffinityTerm": {
              "labelSelector": {
                "matchExpressions": [
                  {
                    "key": "app",
                    "operator": "In",
                    "values": ["web-app"]
                  }
                ]
              },
              "topologyKey": "kubernetes.io/hostname"
            }
          }
        ]
      }
    }
  }
}'
```

这个配置倾向于将 Pod 调度到与标签为 `app=web-app` 的 Pod 相同的节点上。

### 设置 Pod 反亲和性

使用以下命令设置 MySQL-MGR 实例的 Pod 反亲和性：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '
{
  "spec": {
    "affinity": {
      "podAntiAffinity": {
        "requiredDuringSchedulingIgnoredDuringExecution": [
          {
            "labelSelector": {
              "matchExpressions": [
                {
                  "key": "app.kubernetes.io/instance",
                  "operator": "In",
                  "values": ["mysql-mgr-instance"]
                }
              ]
            },
            "topologyKey": "kubernetes.io/hostname"
          }
        ]
      }
    }
  }
}'
```

这个配置要求同一实例的不同 Pod 必须调度到不同的节点上，提高可用性。

### 验证亲和性设置

更新亲和性设置后，验证 Pod 是否按照预期调度：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default -o wide
```

检查 `NODE` 列，确认 Pod 的分布符合亲和性设置。

## 更新容忍度设置

容忍度设置用于允许实例部署在带有特定污点的节点上。

### 查看当前容忍度设置

在更新容忍度设置前，先检查实例的当前设置：

```bash
kubectl get cluster mysql-mgr-instance -n default -o jsonpath='{.spec.tolerations}'
```

### 设置容忍度

使用以下命令设置 MySQL-MGR 实例的容忍度：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '
{
  "spec": {
    "tolerations": [
      {
        "key": "dedicated",
        "operator": "Equal",
        "value": "database",
        "effect": "NoSchedule"
      }
    ]
  }
}'
```

这个配置允许 Pod 调度到带有 `dedicated=database:NoSchedule` 污点的节点上。

### 查看节点污点

要查看集群中节点的污点，可以使用以下命令：

```bash
kubectl describe nodes | grep Taints
```

### 验证容忍度设置

更新容忍度设置后，验证 Pod 是否能够调度到带有污点的节点上：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default -o wide
```

检查 `NODE` 列，确认 Pod 被调度到带有指定污点的节点上。

## 更新拓扑分布设置

拓扑分布设置用于控制实例在不同拓扑域（如可用区）的分布。

### 查看当前拓扑设置

在更新拓扑设置前，先检查实例的当前设置：

```bash
kubectl get cluster mysql-mgr-instance -n default -o jsonpath='{.spec.topologySpreadConstraints}'
```

### 设置拓扑分布约束

使用以下命令设置 MySQL-MGR 实例的拓扑分布约束：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '
{
  "spec": {
    "topologySpreadConstraints": [
      {
        "maxSkew": 1,
        "topologyKey": "topology.kubernetes.io/zone",
        "whenUnsatisfiable": "ScheduleAnyway",
        "labelSelector": {
          "matchLabels": {
            "app.kubernetes.io/instance": "mysql-mgr-instance"
          }
        }
      }
    ]
  }
}'
```

这个配置尝试将 Pod 均匀分布在不同的可用区，最大偏差为 1。

### 验证拓扑分布设置

更新拓扑分布设置后，验证 Pod 是否按照预期分布在不同拓扑域：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default -o wide
```

检查 `NODE` 列，然后查看这些节点所属的拓扑域：

```bash
kubectl get nodes -o custom-columns=NAME:.metadata.name,ZONE:.metadata.labels.topology\\.kubernetes\\.io/zone
```

## 综合调度配置示例

在实际应用中，通常需要组合使用多种调度配置。以下是一个综合调度配置示例：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '
{
  "spec": {
    "nodeSelector": {
      "disk-type": "ssd"
    },
    "affinity": {
      "nodeAffinity": {
        "requiredDuringSchedulingIgnoredDuringExecution": {
          "nodeSelectorTerms": [
            {
              "matchExpressions": [
                {
                  "key": "kubernetes.io/role",
                  "operator": "In",
                  "values": ["database"]
                }
              ]
            }
          ]
        }
      },
      "podAntiAffinity": {
        "requiredDuringSchedulingIgnoredDuringExecution": [
          {
            "labelSelector": {
              "matchExpressions": [
                {
                  "key": "app.kubernetes.io/instance",
                  "operator": "In",
                  "values": ["mysql-mgr-instance"]
                }
              ]
            },
            "topologyKey": "kubernetes.io/hostname"
          }
        ]
      }
    },
    "tolerations": [
      {
        "key": "dedicated",
        "operator": "Equal",
        "value": "database",
        "effect": "NoSchedule"
      }
    ],
    "topologySpreadConstraints": [
      {
        "maxSkew": 1,
        "topologyKey": "topology.kubernetes.io/zone",
        "whenUnsatisfiable": "ScheduleAnyway",
        "labelSelector": {
          "matchLabels": {
            "app.kubernetes.io/instance": "mysql-mgr-instance"
          }
        }
      }
    ]
  }
}'
```

这个配置组合了节点选择器、节点亲和性、Pod 反亲和性、容忍度和拓扑分布约束，以实现最优的调度策略。

## 使用限制与注意事项

在更新调度配置时，请注意以下限制和注意事项：

### 调度配置的影响

- **重新调度**：更新调度配置可能导致 Pod 重新调度，暂时影响服务可用性。
- **资源约束**：过于严格的调度约束可能导致 Pod 无法调度。
- **性能影响**：调度决策可能影响数据库性能，如网络延迟和磁盘 I/O。
- **集群资源**：确保集群有足够的资源满足调度需求。

### 最佳实践

- **逐步更新**：对于生产环境，建议逐步更新调度配置，避免一次性大规模变更。
- **测试验证**：在生产环境更新前，先在测试环境验证调度配置的效果。
- **监控影响**：更新调度配置后，密切监控服务性能和可用性。
- **平衡约束**：避免过于严格的调度约束，保留一定的灵活性。
- **考虑扩展性**：设计调度配置时，考虑未来集群扩展的需求。
- **文档记录**：记录调度配置的设计理由和预期效果，便于后续维护。

## 常见问题处理

### Pod 无法调度

如果更新调度配置后 Pod 无法调度，可能的原因和解决方法：

1. **约束过严**：
   ```bash
   kubectl describe pod mysql-mgr-instance-mysql-0 -n default
   ```
   检查事件日志，查找调度失败的原因，适当放宽调度约束。

2. **资源不足**：
   ```bash
   kubectl describe nodes
   ```
   检查节点资源使用情况，确保有符合条件的节点可用。

3. **标签或污点不匹配**：
   ```bash
   kubectl get nodes --show-labels
   kubectl describe nodes | grep Taints
   ```
   检查节点标签和污点，确保与调度配置匹配。

### 性能下降

如果更新调度配置后发现性能下降，可能的原因和解决方法：

1. **网络延迟**：
   检查 Pod 是否分布在不同的网络区域，导致网络延迟增加。

2. **资源竞争**：
   检查 Pod 是否与资源密集型应用共享节点，导致资源竞争。

3. **存储性能**：
   检查 Pod 是否调度到存储性能较差的节点。

### 高可用性问题

如果更新调度配置后发现高可用性降低，可能的原因和解决方法：

1. **单点故障**：
   检查 Pod 是否集中在少数节点或单一故障域。

2. **反亲和性设置**：
   确保设置了适当的 Pod 反亲和性，避免多个 Pod 部署在同一节点。

3. **拓扑分布**：
   确保 Pod 分布在不同的拓扑域，如可用区。

## 后续步骤

成功更新 MySQL-MGR 实例的调度配置后，您可以进一步：

- [规格管理](./scale_database.mdx)：根据调度结果调整实例规格
- [参数配置](../config-database/parameter_config.mdx)：根据新的部署环境优化参数配置
