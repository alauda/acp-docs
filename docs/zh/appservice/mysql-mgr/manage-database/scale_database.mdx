---
weight: 70
---

# 规格管理

本文档将指导您如何通过命令行界面（CLI）管理 MySQL-MGR 实例的规格，包括调整副本数、CPU、内存和存储容量。合理的规格配置对于数据库性能和成本控制至关重要。

## 功能简介

规格管理是指调整 MySQL-MGR 实例的计算资源、存储容量和副本数量，以满足业务需求和性能要求。通过规格管理，您可以根据业务负载的变化灵活调整资源配置，确保数据库性能满足需求的同时，避免资源浪费。

规格管理功能在以下场景中特别有用：
- 应对业务增长，通过增加资源提高数据库性能
- 优化资源利用率，调整过度配置的实例规格
- 增强高可用性，通过增加副本数提高服务可靠性
- 扩展存储容量，满足数据增长需求

## 主要功能

- **调整副本数**：增加或减少 MySQL-MGR 集群的节点数量
- **调整计算资源**：修改 CPU 和内存配置
- **扩展存储容量**：增加数据库的存储空间
- **在线调整**：大多数规格调整操作可以在不中断服务的情况下完成

## 功能优势

- **灵活适应业务需求**：根据业务负载变化灵活调整资源配置
- **优化资源利用率**：避免资源浪费，降低运营成本
- **提高服务可靠性**：通过增加副本数提高高可用性
- **满足数据增长需求**：通过扩展存储容量应对数据增长

## 调整副本数

### 查看当前副本数

在调整副本数前，先检查实例的当前副本数：

```bash
kubectl get cluster mysql-mgr-instance -n default -o jsonpath='{.spec.replicas}'
```

### 增加副本数

使用以下命令增加 MySQL-MGR 实例的副本数：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"replicas":5}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `mysql-mgr-instance` | 要调整的实例名称 |
| `default` | 实例所在的命名空间 |
| `{"replicas":5}` | 设置副本数为 5 |

**注意**：MySQL-MGR 建议使用奇数个副本（如 3、5、7），以便在发生网络分区时能够正确选举主节点。

### 减少副本数

使用以下命令减少 MySQL-MGR 实例的副本数：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"replicas":3}}'
```

**警告**：减少副本数会导致部分节点被删除，可能暂时影响服务可用性。确保剩余的副本数足以维持服务的高可用性。

### 监控副本调整进度

副本调整命令发出后，您可以监控调整进度：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default -w
```

增加副本时，您将看到新的 Pod 被创建；减少副本时，您将看到多余的 Pod 被删除。

### 验证副本调整结果

使用以下命令验证副本数是否已成功调整：

```bash
kubectl get statefulset mysql-mgr-instance-mysql -n default
```

检查 `READY` 列，应显示为 `新副本数/新副本数`，例如 `5/5`。

您还可以检查 MySQL 复制组成员：

```bash
kubectl exec -it mysql-mgr-instance-mysql-0 -n default -- mysql -u root -p -e "SELECT * FROM performance_schema.replication_group_members"
```

应显示所有副本都是复制组的活跃成员。

## 调整计算资源

### 查看当前计算资源

在调整计算资源前，先检查实例的当前 CPU 和内存配置：

```bash
kubectl get cluster mysql-mgr-instance -n default -o jsonpath='{.spec.resources}'
```

### 调整 CPU 和内存

使用以下命令调整 MySQL-MGR 实例的 CPU 和内存配置：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"resources":{"cpu":"4","memory":"8Gi"}}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `{"cpu":"4"}` | 设置 CPU 为 4 核 |
| `{"memory":"8Gi"}` | 设置内存为 8GB |

### 仅调整 CPU

如果只需要调整 CPU，可以使用以下命令：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"resources":{"cpu":"2"}}}'
```

### 仅调整内存

如果只需要调整内存，可以使用以下命令：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"resources":{"memory":"4Gi"}}}'
```

### 监控计算资源调整进度

计算资源调整命令发出后，您可以监控调整进度：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default -w
```

您将看到 Pod 被逐个重新创建，应用新的资源配置。

### 验证计算资源调整结果

使用以下命令验证计算资源是否已成功调整：

```bash
kubectl get pods mysql-mgr-instance-mysql-0 -n default -o jsonpath='{.spec.containers[0].resources.requests}'
```

应返回调整后的资源请求值。

## 扩展存储容量

### 查看当前存储容量

在扩展存储容量前，先检查实例的当前存储配置：

```bash
kubectl get cluster mysql-mgr-instance -n default -o jsonpath='{.spec.storage}'
```

### 扩展存储容量

使用以下命令扩展 MySQL-MGR 实例的存储容量：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"storage":{"size":"100Gi"}}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `{"size":"100Gi"}` | 设置存储容量为 100GB |

**注意**：存储容量只能增加，不能减少。确保底层存储类支持卷扩展。

### 监控存储扩展进度

存储扩展命令发出后，您可以监控扩展进度：

```bash
kubectl get pvc -l app.kubernetes.io/instance=mysql-mgr-instance -n default
```

检查 `CAPACITY` 列，应显示为新的存储容量。

### 验证存储扩展结果

使用以下命令验证存储容量是否已成功扩展：

```bash
kubectl exec -it mysql-mgr-instance-mysql-0 -n default -- df -h /var/lib/mysql
```

应显示扩展后的存储容量。

## 综合规格调整

在某些情况下，您可能需要同时调整多个规格参数。使用以下命令进行综合规格调整：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"replicas":5,"resources":{"cpu":"4","memory":"8Gi"},"storage":{"size":"100Gi"}}}'
```

这将同时调整副本数、CPU、内存和存储容量。

## 使用限制与注意事项

在进行规格管理时，请注意以下限制和注意事项：

### 副本数调整的影响

- **增加副本**：增加副本会创建新的数据库节点，需要时间进行数据同步。
- **减少副本**：减少副本会删除部分节点，可能暂时影响服务可用性。
- **副本数建议**：MySQL-MGR 建议使用奇数个副本（如 3、5、7），以便在发生网络分区时能够正确选举主节点。
- **最小副本数**：为了保证高可用性，建议至少保留 3 个副本。

### 计算资源调整的影响

- **资源不足**：如果集群资源不足，调整可能会失败或导致 Pod 无法调度。
- **性能影响**：调整计算资源会导致 Pod 重启，可能暂时影响服务性能。
- **参数配置**：调整计算资源后，可能需要相应调整 MySQL 参数配置，如缓冲池大小。

### 存储扩展的影响

- **存储类支持**：确保底层存储类支持卷扩展。
- **只能增加**：存储容量只能增加，不能减少。
- **扩展时间**：存储扩展可能需要较长时间，取决于存储系统和数据量。
- **文件系统调整**：存储扩展后，可能需要调整文件系统大小。

### 最佳实践

- **计划维护窗口**：在业务低峰期执行规格调整操作。
- **逐步调整**：对于大幅度的规格调整，考虑分多次小幅度调整，降低风险。
- **监控性能**：规格调整后，密切监控数据库性能，确保满足业务需求。
- **测试验证**：在生产环境调整前，先在测试环境验证调整过程和结果。
- **备份数据**：在进行重要的规格调整前，确保有最新的备份可用。
- **调整参数配置**：规格调整后，相应调整 MySQL 参数配置，优化性能。

## 常见问题处理

### 副本调整失败

如果副本调整失败，可能的原因和解决方法：

1. **资源不足**：
   ```bash
   kubectl describe nodes
   ```
   检查集群资源是否充足。

2. **配置错误**：
   ```bash
   kubectl describe cluster mysql-mgr-instance -n default
   ```
   检查事件日志，查找可能的错误。

3. **复制组问题**：
   ```bash
   kubectl exec -it mysql-mgr-instance-mysql-0 -n default -- mysql -u root -p -e "SELECT * FROM performance_schema.replication_group_members"
   ```
   检查复制组状态，确保现有成员正常工作。

### 计算资源调整失败

如果计算资源调整失败，可能的原因和解决方法：

1. **资源请求过高**：
   请求的资源超过了集群可用资源，尝试减少资源请求。

2. **Pod 驱逐问题**：
   ```bash
   kubectl get events -n default
   ```
   检查是否有 Pod 驱逐事件。

3. **节点亲和性冲突**：
   检查节点亲和性设置是否与资源请求冲突。

### 存储扩展失败

如果存储扩展失败，可能的原因和解决方法：

1. **存储类不支持扩展**：
   ```bash
   kubectl get sc
   ```
   检查存储类是否支持卷扩展。

2. **存储系统限制**：
   检查底层存储系统是否有容量限制。

3. **PVC 状态问题**：
   ```bash
   kubectl describe pvc data-mysql-mgr-instance-mysql-0 -n default
   ```
   检查 PVC 状态和事件。

## 后续步骤

成功调整 MySQL-MGR 实例规格后，您可以进一步：

- [参数配置](../config-database/parameter_config.mdx)：根据新的规格调整参数配置
