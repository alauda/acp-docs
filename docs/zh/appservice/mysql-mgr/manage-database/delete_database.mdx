---
weight: 50
---

# 删除数据库实例

本文档将指导您如何通过命令行界面（CLI）删除 MySQL-MGR 数据库实例。删除操作是不可逆的，会永久移除实例及其数据，因此在执行此操作前需谨慎考虑。

## 功能简介

删除数据库实例是数据库生命周期管理的最后一步，它会永久移除实例及其相关资源，包括计算资源、存储资源和配置信息。根据配置的不同，删除操作可能会保留或删除持久化数据。

删除功能在以下场景中特别有用：
- 清理不再需要的测试或开发环境
- 移除过时的或不再使用的数据库实例
- 释放资源以便重新分配
- 作为环境重建或迁移的一部分

## 主要功能

- **删除单个实例**：删除指定的 MySQL-MGR 实例
- **配置数据保留策略**：决定是否保留持久化数据
- **验证删除操作**：确认删除操作已成功完成
- **资源清理**：确保所有相关资源都被正确释放

## 功能优势

- **资源释放**：释放不再需要的计算和存储资源
- **成本控制**：通过移除不必要的实例降低运营成本
- **环境清理**：保持环境整洁，避免资源浪费
- **灵活的数据处理**：根据需要选择保留或删除持久化数据

## 删除数据库实例

### 查看实例状态

在删除实例前，先检查实例的当前状态和基本信息：

```bash
kubectl get cluster mysql-mgr-instance -n default
```

确保您要删除的是正确的实例。

### 备份重要数据

删除操作是不可逆的，因此在删除前，确保已备份所有重要数据：

```bash
# 创建逻辑备份
kubectl exec -it mysql-mgr-instance-mysql-0 -n default -- mysqldump -u root -p --all-databases > backup.sql
```

### 设置终止策略

MySQL-MGR 实例的删除行为由终止策略（Termination Policy）控制，它决定了删除实例时是否保留持久化数据。在删除前，您可以查看或修改终止策略：

```bash
# 查看当前终止策略
kubectl get cluster mysql-mgr-instance -n default -o jsonpath='{.spec.terminationPolicy}'
```

常见的终止策略包括：
- `Delete`：删除实例但保留 PVC（持久卷声明）
- `WipeOut`：删除实例和所有相关资源，包括 PVC
- `Halt`：停止实例但保留所有资源

如需修改终止策略：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"terminationPolicy":"WipeOut"}}'
```

### 删除单个实例

使用以下命令删除指定的 MySQL-MGR 实例：

```bash
kubectl delete cluster mysql-mgr-instance -n default
```

参数说明：

| 参数 | 描述 |
|------|------|
| `mysql-mgr-instance` | 要删除的实例名称 |
| `default` | 实例所在的命名空间 |

### 监控删除进度

删除命令发出后，您可以监控删除进度：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default
```

您将看到 Pod 逐渐被终止。

### 验证实例已删除

使用以下命令验证实例是否已成功删除：

```bash
kubectl get cluster mysql-mgr-instance -n default
```

如果实例已成功删除，此命令应返回 "No resources found"。

### 检查资源清理

根据终止策略的不同，您可能需要检查相关资源是否已被清理：

```bash
# 检查 PVC
kubectl get pvc -l app.kubernetes.io/instance=mysql-mgr-instance -n default

# 检查 ConfigMap
kubectl get configmap -l app.kubernetes.io/instance=mysql-mgr-instance -n default

# 检查 Secret
kubectl get secret -l app.kubernetes.io/instance=mysql-mgr-instance -n default

# 检查 Service
kubectl get svc -l app.kubernetes.io/instance=mysql-mgr-instance -n default
```

## 使用限制与注意事项

在使用删除功能时，请注意以下限制和注意事项：

### 删除的影响

- **数据丢失**：根据终止策略的不同，删除操作可能导致所有数据永久丢失。
- **服务中断**：删除实例会立即终止数据库服务，所有连接到该实例的应用将无法访问数据库。
- **资源释放**：删除操作会释放与实例相关的所有计算和存储资源。
- **不可逆性**：删除操作是不可逆的，一旦完成，无法恢复（除非从备份中恢复）。

### 最佳实践

- **确认实例**：仔细确认要删除的实例，避免误删。
- **备份数据**：在删除前，确保已备份所有重要数据。
- **检查依赖**：确保没有应用程序或服务依赖于要删除的实例。
- **选择合适的终止策略**：根据需要选择合适的终止策略，如果不确定是否需要保留数据，选择 `Delete` 策略。
- **分阶段删除**：对于重要实例，考虑先停止实例，确认没有影响后再删除。
- **记录配置**：在删除前，记录实例的配置信息，以便将来需要时可以重新创建。

## 常见问题处理

### 删除操作卡住

如果删除操作长时间处于进行中状态，可能的原因和解决方法：

1. **资源终结器问题**：
   ```bash
   kubectl get cluster mysql-mgr-instance -n default -o yaml
   ```
   检查是否有 finalizers 阻止删除，如果有，可以手动移除：
   ```bash
   kubectl patch cluster mysql-mgr-instance -n default --type json -p '[{"op":"remove","path":"/metadata/finalizers"}]'
   ```

2. **依赖资源问题**：
   ```bash
   kubectl describe cluster mysql-mgr-instance -n default
   ```
   检查事件日志，查找可能的问题。

### 资源未完全清理

如果删除操作完成，但某些资源仍然存在，可能的原因和解决方法：

1. **终止策略设置**：
   如果使用了 `Delete` 或 `Halt` 策略，某些资源（如 PVC）会被保留。

2. **手动清理资源**：
   ```bash
   kubectl delete pvc -l app.kubernetes.io/instance=mysql-mgr-instance -n default
   kubectl delete configmap -l app.kubernetes.io/instance=mysql-mgr-instance -n default
   kubectl delete secret -l app.kubernetes.io/instance=mysql-mgr-instance -n default
   kubectl delete svc -l app.kubernetes.io/instance=mysql-mgr-instance -n default
   ```

### 删除后无法创建同名实例

如果删除实例后，无法创建同名的新实例，可能的原因和解决方法：

1. **资源未完全清理**：
   检查是否有同名的资源仍然存在，如 PVC、ConfigMap 等。

2. **名称保留**：
   某些 Kubernetes 资源可能有名称保留期，等待一段时间后再尝试创建。

## 后续步骤

成功删除 MySQL-MGR 实例后，您可能需要：

- **创建新实例**：如果需要，[创建新的数据库实例](../config-database/create_database.mdx)
- **资源回收**：确认所有资源已被正确释放，特别是存储资源
