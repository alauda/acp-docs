---
weight: 30
---

# 停止/启动数据库实例

本文档将指导您如何通过命令行界面（CLI）停止和启动 MySQL-MGR 数据库实例。这些操作对于计划内维护、资源优化和故障处理等场景非常重要。

## 功能简介

停止和启动数据库实例是基本的实例管理操作，它们允许您控制数据库服务的可用性。停止实例会暂时中断数据库服务，但保留所有数据和配置；启动实例则会恢复数据库服务，使其重新可用。

这些功能在以下场景中特别有用：
- 计划内维护，如操作系统补丁或硬件升级
- 资源优化，在非业务时段停止非关键实例以节省资源
- 故障排除，通过停止和启动实例解决某些临时性问题
- 成本控制，在不需要时停止开发或测试环境的实例

## 主要功能

- **停止实例**：安全地停止数据库服务，保留所有数据和配置
- **启动实例**：恢复已停止的数据库服务，使其重新可用
- **查看实例状态**：检查实例的当前运行状态
- **批量操作**：支持同时停止或启动多个实例

## 功能优势

- **灵活控制**：根据业务需求灵活控制数据库服务的可用性
- **资源优化**：在非业务时段停止实例以释放计算资源
- **成本节约**：通过停止非关键实例降低运营成本
- **简化维护**：便于执行计划内维护和故障排除

## 停止数据库实例

### 查看实例状态

在停止实例前，先检查实例的当前状态：

```bash
kubectl get cluster mysql-mgr-instance -n default
```

确保实例处于 `Running` 状态。

### 停止单个实例

使用以下命令停止指定的 MySQL-MGR 实例：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"running":false}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `mysql-mgr-instance` | 要停止的实例名称 |
| `default` | 实例所在的命名空间 |
| `{"spec":{"running":false}}` | 设置实例为停止状态的补丁 |

### 监控停止进度

停止命令发出后，您可以监控停止进度：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default
```

您将看到 Pod 数量逐渐减少，直到所有 Pod 都被终止。

### 验证实例已停止

使用以下命令验证实例是否已成功停止：

```bash
kubectl get cluster mysql-mgr-instance -n default
```

实例状态应显示为 `Stopped`。

### 批量停止实例

如果需要停止多个实例，可以使用脚本：

```bash
for instance in instance1 instance2 instance3; do
  kubectl patch cluster $instance -n default --type merge --patch '{"spec":{"running":false}}'
done
```

## 启动数据库实例

### 查看实例状态

在启动实例前，先检查实例的当前状态：

```bash
kubectl get cluster mysql-mgr-instance -n default
```

确保实例处于 `Stopped` 状态。

### 启动单个实例

使用以下命令启动指定的 MySQL-MGR 实例：

```bash
kubectl patch cluster mysql-mgr-instance -n default --type merge --patch '{"spec":{"running":true}}'
```

参数说明：

| 参数 | 描述 |
|------|------|
| `mysql-mgr-instance` | 要启动的实例名称 |
| `default` | 实例所在的命名空间 |
| `{"spec":{"running":true}}` | 设置实例为运行状态的补丁 |

### 监控启动进度

启动命令发出后，您可以监控启动进度：

```bash
kubectl get pods -l app.kubernetes.io/instance=mysql-mgr-instance -n default
```

您将看到 Pod 被创建并逐渐变为 `Running` 状态。

### 验证实例已启动

使用以下命令验证实例是否已成功启动：

```bash
kubectl get cluster mysql-mgr-instance -n default
```

实例状态应显示为 `Running`。

您还可以尝试连接到数据库，验证服务是否可用：

```bash
kubectl run mysql-client --rm -it --image=mysql:8.0 -- mysql -h mysql-mgr-instance-mysql -u root -p
```

### 批量启动实例

如果需要启动多个实例，可以使用脚本：

```bash
for instance in instance1 instance2 instance3; do
  kubectl patch cluster $instance -n default --type merge --patch '{"spec":{"running":true}}'
done
```

## 使用限制与注意事项

在使用停止和启动功能时，请注意以下限制和注意事项：

### 停止实例的影响

- **服务中断**：停止实例会导致数据库服务不可用，所有连接到该实例的应用将无法访问数据库。
- **连接处理**：停止操作会尝试优雅地关闭现有连接，但可能会强制断开长时间运行的事务。
- **资源保留**：停止实例会释放计算资源（CPU 和内存），但存储资源仍会被保留和计费。

### 启动实例的影响

- **启动时间**：实例启动可能需要几分钟时间，取决于数据量和配置复杂度。
- **数据恢复**：启动过程包括数据一致性检查，可能需要执行恢复操作。
- **连接恢复**：应用程序需要重新建立与数据库的连接。

### 最佳实践

- **计划维护窗口**：在业务低峰期执行停止和启动操作。
- **提前通知**：在执行操作前通知相关团队，以便他们做好准备。
- **验证备份**：在停止重要实例前，确保有最新的备份可用。
- **监控启动过程**：启动实例后，监控数据库日志以确保正常启动。
- **测试应用连接**：实例启动后，测试应用程序是否能够正常连接和操作。

## 常见问题处理

### 实例无法停止

如果实例长时间处于 `Stopping` 状态，可能的原因和解决方法：

1. **长时间运行的事务**：
   ```bash
   kubectl exec -it mysql-mgr-instance-mysql-0 -n default -- mysql -u root -p -e "SHOW PROCESSLIST"
   ```
   识别并终止长时间运行的事务。

2. **资源清理问题**：
   ```bash
   kubectl describe cluster mysql-mgr-instance -n default
   ```
   检查事件日志，查找可能的问题。

### 实例无法启动

如果实例长时间处于 `Starting` 状态，可能的原因和解决方法：

1. **资源不足**：
   ```bash
   kubectl describe nodes
   ```
   检查集群资源是否充足。

2. **数据一致性问题**：
   ```bash
   kubectl logs mysql-mgr-instance-mysql-0 -n default
   ```
   检查数据库日志，查找可能的错误。

3. **配置错误**：
   ```bash
   kubectl get configmap -l app.kubernetes.io/instance=mysql-mgr-instance -n default
   ```
   检查配置是否正确。

## 后续步骤

成功停止和启动 MySQL-MGR 实例后，您可以进一步：

- [重启数据库实例](./restart_database.mdx)：了解如何重启实例而不完全停止服务
- [规格管理](./scale_database.mdx)：学习如何调整实例的计算资源和存储容量
