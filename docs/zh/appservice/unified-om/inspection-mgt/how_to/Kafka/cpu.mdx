---
weight: 10
---

# Kafka CPU 使用率过高

## 并发控制

在处理消息时，Kafka 使用线程池来进行并发控制。合理配置线程池大小可充分利用 CPU 资源并避免 CPU 过载。

|参数|说明|
|---|---|
|**num.network.threads**|处理网络请求的线程数量，默认值为 3。合理设置此参数可以调整 Kafka 处理网络请求的能力。|
|**num.io.threads**|处理磁盘 IO 的线程数量，默认值为 8。合理设置此参数可以调整 Kafka 处理磁盘 IO 的能力。|

## 消息批处理

Kafka 支持消息批处理，将多条消息组合成批次，以减少网络和磁盘 I/O 开销。批处理对于提升 Kafka 性能和降低 CPU 使用率具有显著作用。

|参数|说明|
|---|---|
|**batch.size**|Producer 端设置的消息批处理大小, 单位为字节，默认值为 16384。合理设置此参数可以提高 Kafka 的吞吐量。|
|**linger.ms**|Producer 端设置的消息等待时间, 单位为毫秒，默认值为 0。在此时间内的消息会被合并成一个批次。|

## 消费者拉取策略

合理设置消费者拉取策略, 以减小 CPU 负担。

|参数|说明|
|---|---|
|**fetch.min.bytes**|设置消费者从 broker 拉取数据时, 需要达到的最小数据量，默认值为 1。|
|**fetch.max.wait.ms**|设置消费者从 broker 拉取数据时, 最长的等待时间，默认值为 500。|

## 关闭消息压缩

消息压缩可以减少消息存储和网络传输的空间占用和带宽消耗，但同时也会增加 CPU 的负载。如果 CPU 资源有限，可以考虑禁用消息压缩以释放更多的 CPU 资源。

|参数|说明|
|---|---|
|**compression.type**|可选值 `uncompressed`、`zstd`、`lz4`、`snappy`、`gzip`、`producer`。|

## 避免频繁 GC

为确保 Kafka 的性能和稳定性，需要关注 JVM 的 GC（垃圾回收，Garbage Collection）性能。频繁的 GC 会增加 CPU 负载。因此，建议合理配置 Kafka broker 的 JVM 参数，以优化垃圾回收策略，提高性能并减少 GC 的频率。

```yaml
spec:
   kafka:
     ...
     jvmOptions:
      '-Xms': 512m
      '-Xmx': 512m
     ...
```

## Broker 扩容

为了提高集群的吞吐量和可用性，建议将新创建的 topic 分布到新的 broker 上，以减少单个 broker 的连接数量。