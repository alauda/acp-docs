---
weight: 30
---

# Redis 内存使用率过高

Redis 的内存使用率是非常重要的监控指标，实例内存不足时会导致数据库响应缓慢，严重可能会导致数据写入错误。

**配置说明**：`maxmemory` 参数配置完成后，Redis 的可用内存上限将与 `maxmemory` 保持一致。当内存使用达到限制时，Redis 仅接受只读命令，写命令将会返回错误。也可以配置为在达到最大内存限制时采用 key 逐出的方式保证 Redis 的正常运行。

## 查看内存使用

可以从实例本身或 Pod 的维度查看内存使用情况。

* Redis 的 info 信息，查看 Redis 的内存使用统计，可以在 **Redis 实例详情** > **监控** 中找到对应的指标。

    |指标名称|含义|
    |---|---|
    |**MemoryUsed**|由 Redis 分配器分配的内存总量。|
    |**MemFragmentationRatio**|内存碎片率，`used_memory_rss` 和 `used_memory` 之间的比率。|
    |**MemoryUsed,Peek**|Redis 的内存消耗峰值.|
    |**MemoryMax**|配置设置的最大可使用内存值.|
    
* Redis 下各 Pod 内存资源的使用率统计，是以 Pod 为单位，会展示 Pod 下各容器的内存统计，**Redis 实例详情** > **副本数** > **有状态副本集** > **容器组** 找到对应的 Pod 内存监控。

    |指标名称|含义|
    |---|---|
    |**内存使用率**|各 Pod 的内存使用率|
    
## 内存使用分析

大部分场景下，内存为实际的数据存储需求，此时可以根据需要对实例进行规格扩容。

部分特定场景下，若 Redis 的内存使用不符合预期，此时可以利用 Redis 的 memory 模块对内存使用进行相关分析。

点击 **Redis 实例详情** > **终端控制台**，连接至 Redis 实例，输入 `memory stats` 命令，查看有关服务器内存使用情况，详情请见 [MEMORY STATS](https://redis.io/commands/memory-stats/)。

通常情况下，一个 Redis 实例内存大部分为 dataset 消耗的内存，但也有其他一些方面的内存开销，例如主备复制的积压缓冲区，Redis 进程初始化消耗的内存，Redis 内部维护 key-value 链表消耗的内存等。

* 如果非 dataset 消耗的内存不多，建议可以直接忽略此部分，重点分析 dataset 内存使用是否符合预期。

* 如果非 dataset 占据了比较大的内存，需要根据 `memory stats` 命令逐一分析内存消耗的根因。

## 内存策略配置

您也可以通过配置数据逐出策略或 expire 策略，对内存中的数据做处理。

### 数据逐出策略

当 Redis 内存不足时，如果您配置了相关的数据逐出策略，数据会做自动淘汰以保证 Redis 实例能够正常运行，您可以通过**Redis 实例详情** > **参数配置** 更新 `maxmemory-policy` 参数。

参数配置值说明：

|参数值|说明|
|---|---|
|**volatile-lru**|从已设置过期时间的数据集（包括 key-value 和 hash 中的 field），选择最近最少使用的数据进行逐出。|
|**volatile-lfu**|从已设置过期时间的数据集（包括 key-value 和 hash 中的 field），选择最近最少使用的且使用次数最少的数据进行逐出。|
|**volatile-ttl**|仅逐出设置了过期时间的数据，并且是按照 TTL 由小到大的顺序进行逐出。|
|**volatile-random**|从已设置过期时间的数据集（包括 key-value 和 hash 中的 field），随机选择数据进行逐出。|
|**allkeys-lru**|从所有数据集（包括 key-value、hash、list、set 和 zset），选择最近最少使用的数据进行逐出。|
|**allkeys-lfu**|从所有数据集（包括 key-value、hash、list、set 和 zset），选择最近最少使用的且使用次数最少的数据进行逐出。|
|**allkeys-random**|从所有数据集（包括 key-value、hash、list、set 和 zset），随机选择数据进行逐出。|
|**noeviction**|不逐出数据，当内存空间不足时，对于写入操作直接返回错误。|


### expire 策略

Redis 提供了一个可配置的过期策略，即键的自动过期功能，称为“expire”策略。expire 策略允许用户为一个键设置过期时间，当这个键过期时，Redis 会将其删除。这个功能非常实用，比如用于缓存数据，避免缓存数据一直存储在内存中，浪费内存资源。

## 内存最佳实践建议

通常情况下，dataset 的占用 Redis 的绝大部分内存，因此内存优化主要还是针对此部分，可以参考下面的最佳实践进行配置：

* 合理设置 Redis 的最大内存限制（maxmemory）参数，该参数控制 Redis 实例能够使用的最大内存数量。当 Redis 达到最大内存限制时，会触发一些清理策略，例如删除过期键或使用 LFU（最不经常使用）算法清理较少使用的键等，建议的 maxmemory 大小最好小于等于实例规格的 80%。
* 仔细考虑 Redis 的数据结构和键设计。例如，使用较小的数据类型（如字符串）或使用更紧凑的数据结构（如使用 Redis 的哈希表数据类型）可以减少内存使用。
* 给 Key 设置合理的过期时间和清理策略。
* 避免出现 bigkey。

最佳实践可能因不同的应用场景而有所不同。因此，根据您的具体应用场景和需求，可能需要定制化 Redis 内存使用的最佳实践。