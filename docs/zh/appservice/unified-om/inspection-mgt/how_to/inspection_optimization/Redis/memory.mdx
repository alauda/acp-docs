---
sourceSHA: b9d7205385bfed902beb8f3be987a1e29dccbcfe850e0a423ea02bdf243cd9a9
---

# Redis 高内存使用情况

Redis 的内存使用率是一个关键的监控指标。实例内存不足可能导致数据库响应缓慢，并可能严重导致数据写入错误。

**配置说明**：在配置 `maxmemory` 参数后，Redis 可用的内存限制将与 `maxmemory` 一致。当内存使用达到限制时，Redis 仅接受读命令，写命令将返回错误。还可以配置在达到最大内存限制时逐出键，以确保 Redis 的正常运行。

## 查看内存使用情况

内存使用情况可以从实例本身或 Pods 中进行监控。

- 您可以查看 Redis 的信息，以在 **Redis 实例详情** > **监控** 部分看到相应指标的内存使用统计数据。

  | 指标名称               | 意义                                                                           |
  | ---------------------- | ------------------------------------------------------------------------------- |
  | **MemoryUsed**        | Redis 分配的总内存。                                                          |
  | **MemFragmentationRatio** | 片段化比例，即 `used_memory_rss` 和 `used_memory` 之间的比例。            |
  | **MemoryUsed,Peak**   | Redis 的峰值内存消耗。                                                        |
  | **MemoryMax**         | 配置中设置的最大可用内存值。                                                  |

- Redis 下每个 Pod 的内存资源使用统计数据，以 Pod 为单位显示，将显示 Pod 中每个容器的内存统计信息。您可以在 **Redis 实例详情** > **副本数量** > **StatefulSet** > **Pods** 下找到 Pod 的内存监控。

  | 指标名称           | 意义                                |
  | ------------------- | ------------------------------------ |
  | **内存使用率**      | 每个 Pod 的内存使用率。              |

## 内存使用分析

在大多数情况下，内存主要由实际数据存储需求消耗，您可以根据需要考虑扩展实例规格。

在 Redis 的内存使用不符合预期的特定情况下，您可以使用 Redis 内存模块进行相关分析。

点击 **Redis 实例详情** > **终端控制台**，连接到 Redis 实例，输入 `memory stats` 命令以查看服务器内存使用情况的信息。有关详细信息，请参考 [MEMORY STATS](https://redis.io/commands/memory-stats/)。

通常，Redis 实例的大部分内存被数据集消耗，但也有其他内存开销，例如主从复制的回溯缓冲区、Redis 进程初始化期间消耗的内存，以及用于维护 Redis 中键值链表的内存。

- 如果非数据集元素消耗的内存很少，建议忽略这一部分，专注于分析数据集内存使用是否符合预期。

- 如果非数据集元素占用大量内存，则需要根据 `memory stats` 命令逐项分析内存消耗的根本原因。

## 内存策略配置

您还可以通过配置数据逐出策略或过期策略来处理内存中的数据。

### 数据逐出策略

当 Redis 内存不足时，如果您配置了相关的数据逐出策略，数据将被自动逐出，以确保 Redis 实例能够正常运行。您可以通过 **Redis 实例详情** > **参数配置** 更新 `maxmemory-policy` 参数。

参数值说明：

| 参数值             | 描述                                                                                       |
| ------------------- | ------------------------------------------------------------------------------------------ |
| **volatile-lru**    | 从设置中逐出最近最少使用的数据（包括键值和哈希中的字段）。                              |
| **volatile-lfu**    | 从设置中逐出最近最少使用的数据（包括键值和哈希中的字段）。                              |
| **volatile-ttl**    | 仅逐出有过期时间的数据，按 TTL 升序逐出。                                               |
| **volatile-random** | 从设置中随机选择带有过期时间的数据进行逐出。                                            |
| **allkeys-lru**     | 从所有数据集逐出最近最少使用的数据（包括键值、哈希、列表、集合和有序集合）。                    |
| **allkeys-lfu**     | 从所有数据集逐出最近最少使用的数据（包括键值、哈希、列表、集合和有序集合）。                 |
| **allkeys-random**  | 从所有数据集随机选择数据（包括键值、哈希、列表、集合和有序集合）进行逐出。                  |
| **noeviction**      | 不逐出数据；当内存空间不足时，直接返回写操作错误。                                        |

### 过期策略

Redis 提供了一种可配置的过期策略，称为“过期”策略，允许密钥的自动过期。此策略允许用户为一个密钥设置过期时间，当时间到达时，Redis 将删除该密钥。此功能对于缓存数据尤其有用，可以防止通过无限期保留缓存数据而浪费内存资源。

## 内存最佳实践建议

通常，数据集占据了 Redis 中绝大多数的内存，因此内存优化主要集中于这一部分。您可以参考以下配置的最佳实践：

- 为 Redis 设置合理的最大内存限制 (`maxmemory`) 参数，控制 Redis 实例可以使用的最大内存量。当 Redis 达到最大内存限制时，将触发各种清理策略，例如删除过期键或者使用 LFU（最不常用）算法来移除不常用的键。建议 maxmemory 大小不超过实例规格的 80%。
- 仔细考虑 Redis 中的数据结构和键设计。例如，使用较小的数据类型（例如字符串）或采用更紧凑的数据结构（例如 Redis 的哈希表数据类型）可以减少内存使用。
- 为键设置合理的过期时间和清理策略。
- 避免创建大键。

最佳实践可能根据不同应用场景有所不同。因此，您可能需要根据特定的应用背景和需求，自定义 Redis 内存使用的最佳实践。
