---
weight: 20
---

# Redis CPU 使用率过高

默认情况下，Redis 使用单线程模型处理读写请求，CPU 使用率过高时将会导致数据库响应变慢，影响业务正常运行。

## 查看 CPU 使用

可以从实例本身或 Pod 的维度查看 CPU 使用情况。

* 通过 Redis 的 `info` 命令，获取到 Redis 实例本身的 CPU 使用统计。也可以在 **Redis 实例详情** > **监控** 中找到对应的指标。

    | 指标名称 | 含义 |
    | --- | --- |
    | **Cpu User** |used_cpu_user：用户态的CPU 使用情况。used_cpu_user_children：后台进程占用的用户 CPU。|
    | **Cpu Sys** |used_cpu_sys：系统态的CPU 使用情况。used_cpu_sys_children：后台进程占用的系统 CPU。|

* Redis 下各 Pod CPU 的使用率统计，是以 Pod 为单位，会展示 Pod 下各容器的 CPU 统计，**Redis 实例详情** > **副本数** > **有状态副本集** > **容器组** 找到对应的 Pod CPU 监控。

    | 指标名称 | 含义 |
    | --- | --- |
    | **CPU 使用率** |各 Pod 的 CPU 使用率。|

## 如何排查 CPU 使用率过高？

1. 查看 Redis 的日志，是否有错误或警告信息。

2. 使用 top 或 htop 等系统级监控工具查看 Redis 进程的 CPU 使用率、内存使用率等信息，确定是否仅仅是 Redis 进程的 CPU 使用率过高，还是整个系统负载高。

3. 检查 Redis 配置文件中的 `maxmemory` 参数是否设置得合理，如果 Redis 内存使用超过 `maxmemory` 限制，可能会导致 CPU 使用率过高。

4. 检查 Redis 的持久化方式是否正确，如果 Redis 持久化配置不合理，例如频繁的 AOF，可能会导致 CPU 使用率过高。

5. 是否存在慢查询

    通过默认参数模板拉起的 Redis 中，执行时间超过 20ms 的称为慢查询。查询执行时间指的是不包括客户端响应（talking）、发送回复等 IO 操作，而只是执行一个查询命令所耗费的时间，您可以通过参数配置提供的参数 `slowlog-log-slower-than` 和 `slowlog-max-len` 自定义配置慢查询阈值和保存条数。您可以通过 Redis 的 `slowlog get` 指令查看慢查询。

    通常 Redis 指令的 CPU 用量与指令的时间复杂度息息相关，一般认为 O(N) 或以上的复杂度在业务代码设计时需要谨慎对待它对应的流量评估。具体每个 Redis 指令的时间复杂度请参考 [Redis 官方文档](https://redis.io/commands)。

    最常见的慢日志包括 `KEYS`、`LRANGE`、`EVAL`、`HGETALL`、`PUBSUB` 等，一般都是扫描量比较大，key 比较大，涉及到 Redis 计算逻辑的指令，由于 Redis 提供有相对较多的数据类型，而诸如 hash、list 等常见数据类型中列表长度上限较高，所以在实际使用中很容易导致 bigkey 问题。

6. 检查 Redis 的客户端请求量是否过大，过大的客户端请求量可能会导致 Redis CPU 使用率过高。

    如果没有明显的慢查询，可以考虑 Redis 的客户端请求量是否过大。如果业务代码没有任何变动的情况下，CPU 使用率突然升高，您可以通过监控观察 Redis 实例的 QPS 是否出现突然升高的情况。

    确认是因为业务的正常访问增长或存在热点 key 引发的 CPU 使用率过高，可以通过架构升级等方式来处理：

    * 针对 hash 结构的超热点 key ，可以考虑拆分成 string 类型并存放至多个 Redis 实例中。
    
    * 针对 string 类型的超热点 key，在业务架构无法限流的情况下，考虑增加多线程配置和扩大实例的 CPU 规格。
    
    * 针对读多写少的场景，哨兵模式可以考虑添加只读实例的方式承受高并发读请求，或者在业务代码中增加缓存逻辑；集群模式可以考虑增加分片。
    
    * 针对写多读少的场景，建议使用集群模式 Redis。

7. 如果您使用集群模式 Redis，请确认是否存在流量不均。当集群出现响应延迟时，若集群下所有对外提供服务的节点 CPU 使用率都过高，可以考虑更改数据分发规则或对实例的分片进行扩容。

8. 如果 Redis 使用了 Lua 脚本，检查脚本是否存在问题，可能会导致 CPU 使用率过高。