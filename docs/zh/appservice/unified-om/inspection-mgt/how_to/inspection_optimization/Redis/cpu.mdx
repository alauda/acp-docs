---
weight: 20
sourceSHA: 39e628ac5e14fba356bfd15137e9977879dda52627bb60fbbb9f4daea5ba8834
---

# Redis 中的高 CPU 使用率

默认情况下，Redis 使用单线程模型来处理读写请求。高 CPU 使用率会导致数据库响应变慢，从而影响正常的业务操作。

## 检查 CPU 使用率

您可以从实例本身或 Pods 的角度检查 CPU 使用率。

- 使用 Redis 的 `info` 命令获取 Redis 实例的 CPU 使用统计信息。您还可以在 **Redis 实例详情** > **监控** 中找到相应的指标。

  | 指标名称      | 释义                                                                                                                |
  | --------------| ------------------------------------------------------------------------------------------------------------------ |
  | **Cpu User**  | used\_cpu\_user：用户模式下的 CPU 使用率。 used\_cpu\_user\_children：子进程在用户模式下使用的 CPU。              |
  | **Cpu Sys**   | used\_cpu\_sys：系统模式下的 CPU 使用率。 used\_cpu\_sys\_children：子进程在系统模式下使用的 CPU。                |

- Redis 下每个 Pod 的 CPU 使用统计信息将按 Pod 显示，显示每个容器的 CPU 统计信息。您可以在 **Redis 实例详情** > **副本** > **有状态集** > **Pods** 中找到相应的 Pod CPU 监控。

  | 指标名称       | 释义                       |
  | ---------------| --------------------------- |
  | **CPU 使用率** | 每个 Pod 的 CPU 使用率。   |

## 如何排查高 CPU 使用率？

1. 检查 Redis 日志，查看是否有错误或警告消息。

2. 使用 top 或 htop 等系统级监控工具检查 Redis 进程的 CPU 使用率、内存使用率以及其他信息，以确定仅 Redis 进程的 CPU 使用率是否高或整个系统是否处于高负载状态。

3. 检查 Redis 配置文件中的 `maxmemory` 参数是否设置合理。如果 Redis 超过 `maxmemory` 限制，可能会导致高 CPU 使用率。

4. 验证 Redis 的持久化方法是否正确。如果 Redis 的持久化配置不合理，例如频繁的 AOF 操作，可能会导致高 CPU 使用率。

5. 检查是否存在慢查询。

   在以默认参数启动的 Redis 实例中，执行耗时超过 20ms 的查询被视为慢查询。执行时间指的是执行查询命令所需的时间，不包括客户端响应（通信）、发送回复和其他 IO 操作的时间。您可以通过参数 `slowlog-log-slower-than` 和 `slowlog-max-len` 自定义慢查询阈值和保留数量。您可以使用 Redis 的 `slowlog get` 命令查看慢查询。

   通常，Redis 命令的 CPU 使用率与其时间复杂度密切相关。通常认为在业务代码设计中，应谨慎处理 O(N) 复杂度及以上的流量评估。有关每个 Redis 命令的时间复杂度，请参考 [Redis 官方文档](https://redis.io/commands)。

   最常见的慢日志包括 `KEYS`、`LRANGE`、`EVAL`、`HGETALL`、`PUBSUB` 等。这些通常涉及到扫描大型数据集或进行复杂计算的命令。由于 Redis 支持各种数据类型，常见的数据类型如哈希和列表在长度上限制较高，因此在实际应用中容易导致大键问题。

6. 检查是否存在过多的客户端请求量导致 Redis CPU 使用率过高。如果没有明显的慢查询，则考虑是否对 Redis 的客户端请求量过大。如果 CPU 使用率突然增加而业务代码没有变化，请监控 Redis 实例的 QPS，以查看是否有激增。

   如果确认 CPU 使用率的激增是由于正常业务流量增长或热键造成的，可以通过架构升级来应对：

   - 对于极热的哈希键，考虑将其拆分为字符串类型并分布到多个 Redis 实例中。

   - 对于极热的字符串键，如果在您的业务架构中无法实现速率限制，考虑增加多线程配置并提高实例的 CPU 规格。

   - 对于读操作占优的场景，您可以考虑在 Sentinel 模式下添加只读实例以处理高并发读请求，或在业务代码中添加缓存逻辑；在集群模式下，您可以考虑增加分片。

   - 对于写操作占优而读操作较少的场景，建议在集群模式下使用 Redis。

7. 如果您在集群模式下使用 Redis，检查流量分布是否均匀。当集群中存在响应延迟时，如果提供外部服务的所有节点的 CPU 使用率较高，考虑更改数据分配规则或扩展实例。

8. 如果在 Redis 中使用 Lua 脚本，请检查脚本中是否存在导致高 CPU 使用率的问题。
