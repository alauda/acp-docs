---
sourceSHA: ebb22e5b509d0b31307726d79479c6c9accccd4df4baa7bcf1456aea72add281
---

# RabbitMQ Mnesia 数据库异常处理

## 常见的 Mnesia 数据库故障

RabbitMQ 使用 Mnesia 数据库来存储队列、交换和绑定等信息。 Mnesia 失败的常见原因可以分为两类：

- MNESIA\_BASE 目录的权限问题，用户对此目录缺乏足够的写权限。
- Mnesia 无法读取表。

## 权限问题

当您遇到 Mnesia 数据库的权限问题时，简单地配置当前用户对 MNESIA\_BASE 目录的写权限即可解决该问题。

## Mnesia 表读取失败

Mnesia 根据机器的主机名创建相应的数据库架构。因此，当主机名发生更改时，Mnesia 将无法加载旧的架构。同样，如果 rabbit\@hostname 目录被重命名，Mnesia 也将无法找到旧的数据库文件，从而促使它创建一个新的 rabbit\@hostname 文件夹并重新启动数据库。

要修复 Mnesia 读取失败，您可以按照以下步骤进行操作：

1. 首先，检查节点的主机名或 rabbit\@hostname 目录名称是否有更新。如果有更新，您可以根据“rabbit\@hostname”的约定进行重命名，这样进行重命名后，您将能够看到旧的数据库文件。

2. 如果没有发现更新，在集群模式下，启动可能会因副本之间的连接不成功而失败。您可以根据日志调查副本之间的通信问题。

3. 如果以上步骤仍无法恢复数据，您可以选择备份当前集群的配置，重新部署新的节点以加入原始集群，并导入备份的配置。

## 其他 Mnesia 数据库相关故障

如果 RabbitMQ 在重启后未能正确形成新的集群，您可能会在日志中遇到以下错误：

```
[warning] <0.273.0> 等待 Mnesia 表时出错: {timeout_waiting_for_tables,['rabbit@e2e-rabbitmq-server-2.e2e-rabbitmq-nodes.local-midautons','rabbit@e2e-rabbitmq-server-1.e2e-rabbitmq-nodes.local-midautons','rabbit@e2e-rabbitmq-server-0.e2e-rabbitmq-nodes.local-midautons'],[rabbit_durable_queue]}
 [info] <0.273.0> 等待 Mnesia 表 30000 毫秒，还有 7 次重试
```

此问题发生的原因是有关集群节点的信息存储在 Mnesia 数据库中，并且在 RabbitMQ 重启期间状态信息未被正确清除。由于 RabbitMQ 对 Pods 的顺序启动策略，这可能导致最初启动的 Pods 无法停止地等待其他 Pods 完成启动，从而产生死锁。建议的解决方案是强制删除集群状态并重新启动。您可以在 kubectl 中执行以下命令：

```
kubectl -n {命名空间名称} exec {实例名称} -- rabbitmqctl force_boot
```
