---
sourceSHA: 8b765eefca618d7cfba8d9544b7e5dcee3eb4cd4350bc5e50ef31bf39377024d
---

# Kafka 中的高 CPU 利用率

## 并发控制

Kafka 在处理消息时使用线程池进行并发控制。合理配置线程池的大小可以充分利用 CPU 资源，避免 CPU 过载。

| 参数                     | 描述                                                                                                                                                      |
| ----------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **num.network.threads** | 处理网络请求的线程数量，默认值为 3。正确设置该参数可以调整 Kafka 处理网络请求的能力。                                                                       |
| **num.io.threads**      | 处理磁盘 I/O 的线程数量，默认值为 8。正确设置该参数可以调整 Kafka 处理磁盘 I/O 的能力。                                                                     |

## 消息批处理

Kafka 支持消息批处理，将多个消息合并为批次，以减少网络和磁盘 I/O 开销。批处理显著提高了 Kafka 的性能，并降低了 CPU 利用率。

| 参数          | 描述                                                                                                                                                        |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **batch.size** | 设置在生产者端的消息批处理大小，单位为字节，默认值为 16384。正确设置该参数可以提高 Kafka 的吞吐量。                                                     |
| **linger.ms**  | 设置在生产者端的消息等待时间，单位为毫秒，默认值为 0。在此期间的消息将被合并到一个批次中。                                                               |

## 消费者拉取策略

合理配置消费者的拉取策略可以降低 CPU 负载。

| 参数                   | 描述                                                                                     |
| --------------------- | ------------------------------------------------------------------------------------------ |
| **fetch.min.bytes**   | 当消费者从代理拉取数据时所需的最小数据量，默认值为 1。                                   |
| **fetch.max.wait.ms** | 当消费者从代理拉取数据时的最大等待时间，默认值为 500。                                   |

## 禁用消息压缩

消息压缩可以减少消息在存储和网络传输时占用的空间，以及带宽消耗，但它也会增加 CPU 负载。如果 CPU 资源有限，建议考虑禁用消息压缩，以释放更多的 CPU 资源。

| 参数                  | 描述                                                                              |
| -------------------- | ---------------------------------------------------------------------------------- |
| **compression.type** | 可选值包括 `uncompressed`、`zstd`、`lz4`、`snappy`、`gzip` 和 `producer`。          |

## 避免频繁的 GC

为了确保 Kafka 的性能和稳定性，需关注 JVM 的 GC（垃圾回收）性能。频繁的 GC 会增加 CPU 负载。因此，建议合理配置 Kafka 代理的 JVM 参数，以优化垃圾回收策略，提高性能，并减少 GC 的频率。

```yaml
spec:
   kafka:
     ...
     jvmOptions:
      '-Xms': 512m
      '-Xmx': 512m
     ...
```

## 代理缩放

为了提高集群的吞吐量和可用性，建议将新创建的主题分布到新的代理上，以减少对单个代理的连接数量。
