---
weight: 30
---

# MySQL 存储空间优化

MySQL 用户需要密切关注实例的空间使用率，这是日常监控的重要指标之一。如果实例的存储空间使用完全达到上限，会严重影响实例正常运行，例如数据库写入失败、备份无法正常完成，以及存储空间扩容任务的执行耗时更长等问题。通常情况下，当 MySQL 实例的存储空间使用比例达到 80-85% 时，需要及时采取措施，可以通过降低数据库实际占用空间的大小或者对存储空间进行扩容来避免空间使用达到上限的风险。

## 存储空间问题优化建议

### binlog 文件过多

开启 MySQL 的 binlog 功能可以记录所有对数据库的修改操作，对于故障恢复和主从复制等场景有重要作用。但是，如果 binlog 文件不及时清理，可能会导致空间占用过多。为了减少空间浪费，可以定期备份数据并根据业务需求调整 binlog 文件的保留时间。这样可以确保数据库的安全性，同时减少空间占用风险。

### 索引过多

索引过多也会导致写入时的 IO 吞吐率放大，为了减少不必要的空间浪费，需要合理配置二级索引。

### 大字段

如果表结构定义中包含 blob、text、很长的 varchar 等大字段，会导致表空间占用更大。建议禁用 blob 和 text 类型，而是使用 json 类型或者其他文档数据库来存储这些数据。如果有必要，可以在插入数据之前将数据进行压缩。

### 空闲表空间过多（InnoDB 表的碎片率高）

InnoDB 是按 Page(16KB) 管理表空间的，如果 Page 写满记录，然后部分记录又被 delete SQL 删除，后续这些删除的记录位置又没有新的记录插入，就可能造成碎片化的表空间。导致 InnoDB 需要额外的 IO 操作来访问分散的碎片化页，影响数据库性能。

通过下面的 SQL 语句查看表上空闲的空间。

```
show table status like '<表名>'
```

若空闲空间特别大，可以执行以下语句整理表空间。

```
optimize table <表名>
```

### 临时表空间过大

某些操作会生成临时表，例如半连接（Semi-join）、去重（distinct）以及未使用索引的排序。如果涉及的数据量很大，则可能会导致临时表空间过大。通过检查执行计划，可以确认是否包含 Using Temporary。

此外，当的 DDL 语句重建表空间时，如果表特别大，则创建索引时产生的临时文件也会非常大。如果空间不足，则需要提前扩大存储空间。