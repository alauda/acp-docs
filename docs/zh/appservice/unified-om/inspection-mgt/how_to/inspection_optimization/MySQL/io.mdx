---
weight: 10
---

# MySQL IO 负载优化

## InnoDB IO 系统简介

MySQL 的 IO 性能受到多种因素的影响，包括硬件存储介质类型、软件层的 DB 内核架构以及具体 SQL 语句扫描或修改数据量等。

InnoDB 利用操作系统提供的异步 IO 接口，实现了一个 IO 子系统，以异步读写数据页、日志、undo 日志等内容。当 SQL 请求的数据页未在缓冲池中时，就需要进行物理 IO 操作以读写底层存储的数据。

* 对于读数据页操作，InnoDB IO 系统使用同步 IO 实现。同步 IO 调用底层的读接口来读取数据。对于写数据页操作，InnoDB IO 系统使用异步 IO 实现，例如后台线程刷脏，后台 IO 线程会异步地将脏页刷到存储中。

* 除了对普通数据文件的读写 IO 操作，还有写 redo/undo 日志、写 binlog 日志、临时表排序、DDL 重建表空间等操作也会产生大量的 IO。

为了优化磁盘 IO，一般可以通过增加缓冲池大小、调整刷新方式、配置操作系统刷新阈值以及使用 MySQL 8.0 提供的 fdatasync 替代 fsync 等方式进行优化。具体的优化方法可以参考 [MySQL 5.7 官方文档](https://dev.mysql.com/doc/refman/5.7/en/optimizing-innodb-diskio.html) 或 [MySQL 8.0 官方文档](https://dev.mysql.com/doc/refman/8.0/en/optimizing-innodb-diskio.html) 中的常见问题优化部分。

## IO 负载过高优化建议

### 高吞吐写入

推荐使用适合高 IOPS（每秒输入/输出操作数）的固态硬盘，可以有效地解决 IO 过高的问题。

innodb_log_file_size 控制 InnoDB redo log 文件大小。若参数值过小，会导致频繁的 log 文件循环写入和刷盘（flush），增加 IO 次数，影响写入性能。适当增大该参数可以减少 log 文件循环频率，合并多次 log buffer 刷新到一次磁盘 IO 来提高写入性能。

此外，建议降低读写频率或优化刷脏相关的参数来解决高 IO 问题。与刷脏相关的参数如下表。

| 参数名称 | 说明 |
| --- | --- |
| **innodb_max_dirty_pages_pct** | 控制 InnoDB 脏页的最大比例。该参数的值越大，InnoDB 允许的脏页就越多，但同时也会增加刷新脏数据的频率和时间。 |
| **innodb_max_dirty_pages_pct_lwm** | 控制 InnoDB 脏页达到最大比例后，什么时候开始刷新脏数据。该参数的值越小，InnoDB 越早开始刷新脏数据，但同时也会增加刷新的频率和时间。 |
| **innodb_io_capacity** | 控制 InnoDB 对磁盘的 I/O 吞吐量。该参数的值越大，InnoDB 对磁盘的压力就越大，但同时也能提高刷新脏数据的速度。 |
| **innodb_io_capacity_max** | 控制 InnoDB 对磁盘的 I/O 的最大吞吐量，决定刷新脏数据的速度的上限。 |
| **innodb_lru_scan_depth** | 控制 InnoDB 刷脏页时扫描 BP 的深度，从而影响高吞吐写入环境下 IO 负载的大小，过大会导致每个刷脏周期 InnoDB 需要扫描并评估更多的页框，这必然导致更多无效 IO 读取，加重整体 IO 负载，影响性能。过小会导致 InnoDB 每个刷脏周期只能扫描并清理少量脏页，脏页清理速度无法跟上脏页产生速度，这会导致脏页无限制地积累，占用更多BP，产生更严重的 IO Competition，加重 IO 负载。 |

### 临时表产生大量 IO

进入MySQL容器后，可以使用以下命令查看临时文件目录的大小。

```
ls -lh /var/lib/mysql/#innodb_temp
```

如果临时目录很大，可能是因为有慢 SQL 排序或去重，产生了很大的临时表。此时需要对慢 SQL 进行优化，减少临时表的使用，从而避免临时表写入造成 IO 增加。

### 读取冷数据产生大量 IO

通过以下 SQL 命令查询 buffer 命中率。

```
select hit_rate from information_schema.INNODB_BUFFER_POOL_STATS;
```

当 SQL 查询或修改的数据不在内存中的 buffer pool 时，就需要从磁盘读取数据。如果需要读取的数据量非常大，这可能会导致很高的磁盘读写吞吐量。为避免这种情况，应尽量避免全表扫描，例如避免使用 `select * from 大表` 的语句，以减少对 buffer pool 的污染。

针对具体的业务场景，可以重新设计缓存策略或考虑升级实例规格，以提高系统的性能。

### DDL 语句造成 IO 负担

DDL语句在执行时可能会进行重建表空间、扫描全表数据、创建索引排序等操作，新表产生的脏页需要刷脏，这些操作会产生大量的 IO 吞吐。另外，当需要删除大表时，drop table 操作会造成IO抖动。为了避免对业务的影响，需要在业务低谷时间执行该操作。

### 大事务写 binlog 产生大量 IO

建议将大事务拆分成小事务来避免写入大量的 binlog 文件，减少IO吞吐。例如，当一条 delete SQL 语句需要删除大量的行时，可以将其拆分为多条较小的 delete 语句来执行。这样可以降低每个事务产生的 binlog 文件大小，并且减少刷新磁盘的频率，从而提高性能。同时，可以通过优化业务逻辑来避免大事务的出现。
