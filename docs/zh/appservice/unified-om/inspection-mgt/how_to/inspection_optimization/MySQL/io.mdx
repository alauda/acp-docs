---
sourceSHA: 0f4f37a2f21c9b794cc6b311529ad5a3acab1ff7fd3efb922194764a92cee0c0
---

# MySQL IO负载优化

## InnoDB IO系统简介

MySQL的IO性能受到多种因素的影响，包括硬件存储介质类型、软件层面的数据库内核架构，以及特定SQL语句读取或修改的数据量。

InnoDB利用操作系统提供的异步IO接口实现IO子系统，以异步方式读取和写入数据页、日志和撤销日志。当SQL查询请求的数据页不在缓冲池中时，就需要进行物理IO操作来读取或写入数据。

- 在读取数据页时，InnoDB IO系统使用同步IO。同步IO调用底层读取接口来读取数据。在写入数据页时，InnoDB IO系统使用异步IO；例如，后台线程异步将脏页刷新到存储。

- 除了对正常数据文件进行的读写IO操作外，写入重做/撤销日志、写入binlog日志、排序临时表以及DDL重建表空间等操作也会产生大量IO。

为了优化磁盘IO，通常可以增加缓冲池的大小、调整刷新方法、配置操作系统的刷新阈值，并使用MySQL 8.0提供的fdatasync作为fsync的替代方案。有关具体的优化方法，请参见[MySQL 5.7官方文档](https://dev.mysql.com/doc/refman/5.7/en/optimizing-innodb-diskio.html)或[MySQL 8.0官方文档](https://dev.mysql.com/doc/refman/8.0/en/optimizing-innodb-diskio.html)中的优化部分。

## 高IO负载的优化建议

### 高吞吐量写入

建议使用适合高IOPS（每秒输入/输出操作）的固态硬盘，以有效缓解高IO问题。

`innodb_log_file_size`控制InnoDB重做日志文件的大小。如果参数值过小，会导致频繁的日志文件循环和刷新，从而增加IO操作的次数并影响写入性能。适当增加此参数可以减少日志文件循环的频率，将多个日志缓冲区刷新的操作合并为一次磁盘IO操作，从而提高写入性能。

此外，建议降低读写频率或优化与脏页刷新相关的参数，以解决高IO问题。与脏页刷新相关的参数如下表所示。

| 参数名称                                | 描述                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **innodb\_max\_dirty\_pages\_pct**      | 控制InnoDB中的脏页最大比例。值越大，InnoDB允许的脏页越多，但也会增加刷新脏数据的频率和时间。                                                                                                                                                                                                                                                                                                                                                                                                   |
| **innodb\_max\_dirty\_pages\_pct\_lwm** | 控制当InnoDB中的脏页达到最大比例后开始刷新脏数据的时机。值越小，InnoDB越早开始刷新脏数据，但也会增加脏数据刷新的频率和时间。                                                                                                                                                                                                                                                                                                                                                                  |
| **innodb\_io\_capacity**                | 控制InnoDB在磁盘上可以处理的I/O吞吐量。值越大，对磁盘的压力越大，但也能增加脏数据刷新的速度。                                                                                                                                                                                                                                                                                                                                                                                                   |
| **innodb\_io\_capacity\_max**           | 控制InnoDB在磁盘上可以处理的最大I/O吞吐量，决定了脏数据刷新速度的上限。                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **innodb\_lru\_scan\_depth**            | 控制InnoDB在刷新脏页时扫描的缓冲池深度，从而影响高吞吐量写入环境下的IO负载。如果设置过大，每次刷新周期需要扫描更多页面，会导致更多无效的IO读取，增加整体IO负载，影响性能。如果设置过小，则可能使InnoDB只能扫描和清理非常少量的脏页，这可能导致脏页无限积累以及严重的IO竞争，加重IO负载。 |

### 临时表的高IO

进入MySQL容器后，可以使用以下命令检查临时文件目录的大小。

```
ls -lh /var/lib/mysql/#innodb_temp
```

如果临时目录较大，可能是由于慢SQL排序或去重导致生成了较大的临时表。这种情况下，需要优化慢SQL查询，以减少临时表的使用，从而避免因临时表写入而增加IO。

### 读取冷数据的高IO

可以使用以下SQL命令查询缓冲命中率。

```
select hit_rate from information_schema.INNODB_BUFFER_POOL_STATS;
```

当SQL查询或修改的数据不在内存中的缓冲池时，必须从磁盘读取。如果要读取的数据量非常大，可能会导致非常高的磁盘读/写吞吐量。为了避免这种情况，应尽量减少全表扫描，例如避免使用`select * from large_table`这样的语句，以减少对缓冲池的污染。

对于特定业务场景，可以考虑重新设计缓存策略或升级实例规格以提高系统性能。

### DDL语句造成的IO负担

在执行DDL语句时，可能会发生重建表空间、扫描全表数据和创建索引排序等操作。新表生成的脏页需要被刷新，从而导致大量的IO吞吐量。此外，当需要删除大表时，drop table操作可能会引起IO波动。为避免对业务操作造成影响，这些操作应安排在业务低峰期进行。

### 大事务写入Binlogs产生高IO

建议将大事务拆分为多个小事务，以避免写入大量binlog文件，从而减少IO吞吐量。例如，如果删除SQL语句需要删除大量行，可以将其拆分为多个较小的删除语句进行执行。这可以降低每个事务生成的binlog文件大小，并减少磁盘刷新的频率，提高性能。此外，优化业务逻辑有助于防止发生大事务。
