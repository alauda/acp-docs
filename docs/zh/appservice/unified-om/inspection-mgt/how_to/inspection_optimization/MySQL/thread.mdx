---
weight: 40
---

# MySQL 活跃线程数优化

活跃线程数或活跃连接数是评估 MySQL 负载状况的重要指标。一般来说，健康的实例应该保持低于 10 的活跃连接数。对于高规格和高 QPS 的实例，活跃连接数可能达到 20-30。如果活跃连接数超过几百甚至上千，那么就会发生 SQL 堆积和 MySQL 响应变慢，严重情况下可能导致实例崩溃或无法处理更多的 SQL 请求。

## 查看活跃连接数

通过以下 SQL 语句查看活跃连接数。

```
show status like  'Threads%';
```

|返回参数|说明|
|---|---|
|**Threads_connected**|打开的连接数|
|**Threads_running**|激活的连接数，数值一般远低于 connected 数值|

## 活跃线程数问题优化建议

### 慢 SQL 堆积

若发现活跃线程数容易增加，应先执行 `show processlist` 命令检查是否存在慢查询。过多扫描行数的慢查询会导致活跃连接数增加，从而引起性能问题。如果需要解决相关性能问题，建议终止相关会话以降低影响。

### 表缓存（table cache）问题

在高流量或包含大量表的场景下，table cache 可能不足，导致大量的 SQL 语句处于“Opening table”状态。这会显著增加查询延迟和服务器负载，并可能导致性能下降或服务器崩溃。

可以通过提高 table_open_cache 参数来增加 table cache 的大小，从而减少“Opening table”状态的 SQL 语句数量，并提高查询性能。但需要注意，过度增加该参数的值也会占用服务器内存，并可能导致性能问题。因此，应该谨慎调整该参数的值，以达到最佳性能和稳定性。

### 元数据锁（MDL）问题

当出现 MDL 锁时，会导致大量 SQL 处于"Waiting for table metadata lock"状态。在执行 DDL prepare 和 commit 阶段时，DDL 语句需要获取 MDL 锁。如果表上存在未提交的事务或慢 SQL，就会阻塞 DDL 操作。因为 DDL 操作也会阻塞其他 SQL，所以这可能会导致活跃线程数上升。

建议中止未提交的事务、慢 SQL 或当前正在执行的 DDL。

### 行锁冲突

通过以下 SQL 语句查看相关状态。

```
show status like 'Innodb_row_lock_%';
```

行锁冲突会导致活跃线程数升高的表现为 Innodb_row_lock_waits 和 Innodb_row_lock_time 状态指标升高。

也可以通过执行 `show engine innodb status` 命令查看是否有大量处于"Lock wait"状态的会话，如果有，则说明行锁冲突比较严重，需要优化热点更新、减小事务大小、及时提交事务等方式来避免行锁冲突。