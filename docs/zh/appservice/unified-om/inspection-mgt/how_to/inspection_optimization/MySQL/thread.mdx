---
sourceSHA: e87c4a5ec998a62a688a8c69a3b0595caa0852b109efacba500025e6c2d0b8a1
---

# MySQL 活动线程数优化

活动线程数或活动连接数是评估 MySQL 负载状态的重要指标。通常，一个健康的实例应维持活动连接数在10以下。对于高规格和高 QPS 的实例，活动连接数可能达到20-30。如果活动连接数超过几百或甚至数千，可能会导致 SQL 队列积压，MySQL 的响应时间可能会变慢，进而可能导致实例崩溃或无法处理额外的 SQL 请求。

## 检查活动连接数

您可以使用以下 SQL 语句查看活动连接数。

```
show status like 'Threads%';
```

| 返回参数            | 描述                                                                    |
| ------------------ | ----------------------------------------------------------------------- |
| **Threads\_connected** | 打开的连接数量                                                          |
| **Threads\_running**   | 活动连接的数量，通常远低于连接数量                                     |

## 活动线程数问题的优化建议

### SQL 队列缓慢积压

如果您发现活动线程数在增加，首先应执行 `show processlist` 命令检查是否存在慢查询。扫描过多行的慢查询会导致活动连接增加，从而引发性能问题。如果需要解决与性能相关的问题，建议终止相关会话以减少影响。

### 表缓存问题

在高流量场景或涉及大量表的情况下，表缓存可能不足，导致许多 SQL 语句处于“打开表”状态。这显著增加了查询延迟和服务器负载，并可能导致性能下降或服务器崩溃。

您可以通过提高 `table_open_cache` 参数值来增加表缓存大小，从而减少处于“打开表”状态的 SQL 语句数量，提高查询性能。然而，需谨慎对待，因为过度增加该参数可能消耗服务器内存，并可能导致性能问题。因此，应谨慎调整该参数，以实现最佳性能和稳定性。

### 元数据锁定（MDL）问题

当发生 MDL 锁定时，可能会有大量 SQL 语句处于“等待表元数据锁”状态。在 DDL 准备和提交阶段，DDL 语句需要获取 MDL 锁定。如果表上存在未提交的事务或慢 SQL，将会阻塞 DDL 操作。由于 DDL 操作也可以阻塞其他 SQL 操作，这可能导致活动线程数增加。

建议终止未提交的事务、慢 SQL 或当前正在执行的 DDL 操作。

### 行锁冲突

您可以使用以下 SQL 语句检查相关状态。

```
show status like 'Innodb_row_lock_%';
```

行锁冲突表现为 `Innodb_row_lock_waits` 和 `Innodb_row_lock_time` 状态指标的增加，从而导致活动线程数上升。

您还可以执行 `show engine innodb status` 命令以检查是否存在大量会话处于“锁等待”状态。如果存在许多，则表示行锁冲突严重，需要通过热点更新、减少事务大小和及时提交事务等方法进行优化，以避免行锁冲突。
