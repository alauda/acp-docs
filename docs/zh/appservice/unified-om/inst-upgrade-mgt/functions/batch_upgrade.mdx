---
weight: 10
---

# 实例升级

实例升级控制功能，是为了让用户能够自行选择升级实例的时间窗口，不同的实例可以选择在不同的时间窗口进行升级，以保证业务的连续性。

## 查看实例当前版本

在实例列表页、升级管理中心页面上，用户都可以很方便的查看到每个组件的 Major 和 Minor 版本号，例如 MySQL 8.0。如果用户想要了解实例的 Patch 版本信息，可以查看对应实例的 yaml，获取诸如下列字段信息：

```yaml
apiVersion: middleware.alauda.io/v1
kind: Mysql
spec:
    upgradeOption:
      autoUpgrade: false
      crVersion: v3.15
status:
    upgradeStatus:
      crVersion: v3.12
```

::: info

- `<spec.upgradeOption.autoUpgrade>` 用来指定当前实例是否在发现有可用版本时自动升级
- `<spec.upgradeOption.crVersion>` 用来指定当前实例的目标升级版本号
- `<status.upgradeStatus.crVersion>` 用来表示当前实例的当前版本号

:::

## 查看可用新版本

当系统中升级了 Operator 之后，对应的实例可能会提示有新的可用版本。用户会在实例详情页面和升级管理中心的列表页上都会收到提示信息。用户也可以通过下列命令来查询当前集群内的可用版本信息：

```bash
> kubectl get imageversions -A

NAME                     AGE
kafka-artifact-v3.18.5   19d
mysql-mgr-3.18.10        35d
mysql-pxc-3.18.22        14d
redis-artifact-3.18.19   57d

> kubectl get imageversions mysql-mgr-3.18.10 -o yaml

apiVersion: middleware.alauda.io/v1
kind: ImageVersion
metadata:
  annotations:
    middleware.instance/crVersion: 3.18.10
    middleware.instance/type: mysql-mgr
  creationTimestamp: "2025-01-21T07:12:46Z"
  generation: 1
  labels:
    middleware.instance/crVersion: 3.18.10
    middleware.instance/latest: "true"
    middleware.instance/type: mysql-mgr
  name: mysql-mgr-3.18.10
  resourceVersion: "31869839"
  uid: c8cfe32c-cc95-408f-a231-67c35a76badf
spec:
  components:
    agent:
      versions:
      - image: build-harbor.alauda.cn/middleware/mysql-mgr-operator
        tag: v3.18.10
    exporter:
      versions:
      - image: build-harbor.alauda.cn/middleware/mgr/mysqld-exporter
        tag: 0.14.0-7b6ea551
        version: 0.14.0
    mysql:
      coreComponent: true
      versions:
      - displayVersion: "8.0"
        extensions:
          CONNECTION_CONTROL:
            version: "1.0"
          CONNECTION_CONTROL_FAILED_LOGIN_ATTEMPTS:
            version: "1.0"
          NULL_AUDIT:
            version: "0.3"
          audit_log:
            version: "0.2"
          audit_log_filter:
            version: "1"
          auth_pam:
            version: "0.1"
          auth_pam_compat:
            version: "0.1"
          auth_socket:
            version: "1.1"
          authentication_fido:
            version: "1.0"
        image: build-harbor.alauda.cn/middleware/mgr/mysql-server
        tag: 8.0.36-2d0ecb6b
        version: 8.0.36
    router:
      versions:
      - image: build-harbor.alauda.cn/middleware/mgr/mysql-router
        tag: 8.0.36-2d0ecb6b
        version: 8.0.36
    slowsql:
      versions:
      - image: build-harbor.alauda.cn/middleware/slowsql
        tag: v3.18.2
  crVersion: 3.18.10
```

在上面的 imageversion 资源中，用户不仅可以看到每个实例的可用版本信息，还可以得知具体每个组件的版本信息。

## 升级实例

当用户想要升级实例时，用户可以通过编辑指定实例的 CR 资源，在 `<spec.upgradeOption.crVersion>` 上来指定实例的目标版本。随后 Operator 会自动升级实例，实例的状态会立刻变成 `in progress`。用户可以通过观察实例的状态信息来判断实例是否完成升级，当实例的状态再次变成 `Ready` 之后，表示实例已经完成升级。
