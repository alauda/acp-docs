# 第三方存储能力标注操作指南

> **功能说明：** 通过在 `kube-public` 命名空间添加 **StorageDescription** ConfigMap，平台会自动识别各第三方存储类的快照能力以及卷模式与访问模式（含块卷专用访问模式），并在 PVC 创建等界面动态显示对应选项，帮助您轻松选择并使用合适的存储功能。

## 1. 快速上手

### 1.1 创建或更新 ConfigMap

> **注意：必须在 `kube-public` 命名空间执行以下操作，否则平台无法识别存储能力。**

直接编辑或创建名称以 `sd-` 开头的 ConfigMap，例如 `sd-capabilities-enhanced`：

```bash
kubectl -n kube-public edit configmap sd-capabilities-enhanced
```

**必须包含标签**

```yaml
metadata:
  labels:
    features.alauda.io/type: StorageDescription
```

### 1.2 填写 `data` 字段

每个 `key` 对应一个 StorageClass 的 `provisioner`，值为描述能力的 YAML 字符串。核心字段如下：

| 字段                 | 类型             | 说明                               |
| ------------------ | -------------- | -------------------------------- |
| `snapshot`         | `Boolean`      | 是否支持卷快照                          |
| `volumeMode`       | `List[String]` | 支持的卷模式，`Filesystem`、`Block` 至少一项 |
| `accessModes`      | `List[String]` | File 模式下可选的访问模式                  |
| `blockAccessModes` | `List[String]` | Block 模式下专用访问模式（可选）              |

> 若 `blockAccessModes` 省略，则 Block 模式下默认沿用 `accessModes`。

### 1.3 应用配置

```bash
kubectl apply -f sd-capabilities-enhanced.yaml
```

配置生效后，UI 会根据存储描述自动调整可选项，例如：

* 当选择 **Block** 卷模式时，访问模式下拉框使用 `blockAccessModes` 值。
* 当 `snapshot: true` 时，PVC 页面会显示快照相关操作。

## 2. 示例 ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sd-capabilities-enhanced
  namespace: kube-public
  labels:
    features.alauda.io/type: StorageDescription
data:
  storage.advanced-block-fs.com: |-
    snapshot: true
    volumeMode:
      - Filesystem
      - Block
    accessModes:
      - ReadWriteOnce
      - ReadOnlyMany
      - 
    blockAccessModes:
      - ReadWriteOnce
      - 
  storage.filesystem-basic.com: |-
    snapshot: false
    volumeMode:
      - Filesystem
    accessModes:
      - ReadWriteOnce
      - ReadWriteMany
      - 
```

## 3. 更新现有能力描述

1. 找到需要修改的 `provisioner` 键。
2. 根据实际能力调整字段值。
3. 重新执行 `kubectl apply -f` 使更改立即生效。平台会轮询并自动刷新 UI；如需立即查看，可手动刷新浏览器页面。

## 4. 兼容旧格式

* 若缺少 `blockAccessModes`，Block 卷模式将沿用 `accessModes`。
* 无需删除旧 ConfigMap，可直接追加新字段实现平滑升级。

## 5. 常见问题

| 现象                | 可能原因                                     | 处理办法                        |
| ----------------- | ---------------------------------------- | --------------------------- |
| Block 模式下访问模式列表为空 | `blockAccessModes` 未填且 `accessModes` 也为空 | 补充两者之一                      |
| UI 仍显示旧能力         | ConfigMap 未保存成功或浏览器缓存                    | 确认 `kubectl get cm` 输出，刷新页面 |
