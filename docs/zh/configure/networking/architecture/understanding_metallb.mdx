---
weight: 20
sourceSHA: b6cb973a8e9e2631d6cd12e071d884c305e0a3a63063692c57913edca2e26cd9
---

# 理解 MetalLB

## 术语

| 术语              | 描述                                                                                                                                                                                                                                                                                                                                                     |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **VIP**           | 虚拟 IP 地址（VIP）是 MetalLB 为 LoadBalancer 类型的内部路由分配的 IP 地址，为外部流量访问集群内的服务提供了一个统一的访问点。                                                                                                                                                                                                                           |
| **ARP**           | 地址解析协议（ARP）用于将网络层的 IP 地址映射到数据链路层的 MAC 地址。                                                                                                                                                                                                                                                                                     |
| **GARP**          | 免费 ARP（GARP）是一种特殊的 ARP 请求，用于通知网络中其他节点 IP 地址与 MAC 地址的绑定情况。与正常的 ARP 请求不同，GARP 不会等待响应，而是主动在网络上发送信息。                                                                                                                                                                     |
| **ARP 响应者**    | MetalLB 的一个组件，负责通过将 VIP 映射到节点的 MAC 地址来响应 ARP 请求。当一个节点需要与 VIP 通信时，它会发送 ARP 请求以检索与 VIP 对应的 MAC 地址。每个可用节点都有一个 ARP 响应者来响应这些请求，将 VIP 映射到节点的 MAC 地址。                                                            |
| **控制器**        | MetalLB 的一个组件，负责从外部地址池动态分配 VIP 用于 LoadBalancer 类型的内部路由。控制器监听集群中内部路由的创建和删除事件，以根据需要分配或释放 VIP。                                                                                                                                                                                     |
| **发言人**        | MetalLB 的一个组件，根据策略或算法决定节点是否应该托管 VIP 并发送 GARP。它确保节点之间有一定的平衡，当一个节点不可用时，其他节点可以接管 VIP 并发送 GARP，从而实现高可用性。                                                                                                                 |

## MetalLB 的高可用性原理

![](../assets/metallbfix.png)

默认情况下，该平台使用 MetalLB 的 ARP 模式，具体的实现过程和原理如下：

- MetalLB 的控制器组件从外部地址池中选择一个 IP 地址，将其分配给 LoadBalancer 类型的内部路由作为 VIP。

- MetalLB 根据 [算法](#vip) 选择一个可用节点来托管 VIP，然后转发流量。

- 该节点上的发言人组件主动发送 GARP，在所有节点之间建立 VIP 与 MAC 地址的映射关系。

  - 在同一子网内的节点在学习到 VIP 和可用节点的 MAC 地址之间的映射关系后，会直接与该节点进行通信以访问 VIP。

  - 不同子网的节点首次会将流量路由到其子网的网关，然后由网关将流量转发到托管 VIP 的节点。

- 当该节点发生故障时，MetalLB 会选择另一个可用节点来托管 VIP，从而确保高可用性。

- 流量到达节点后，Kube-Proxy 将流量转发到相应的 Pod。

## MetalLB 选择 VIP 主机节点的算法\{#vip}

MetalLB 将所有可用节点与外部地址池使用 VIP 进行哈希并按特定算法排序，选择第一个可用节点作为 VIP 的主机。

## 外部地址池和节点数量

创建外部地址池并添加可用节点。所有可用节点保持 **备份** 关系，这意味着只有托管 VIP 的节点可以转发流量，需要其处理外部地址池中 VIP 的所有流量。

### 计算公式

公式为：**外部地址池数量 = ceil(n-vip / n-node)**，其中 ceil 表示向上取整。

**注意**：如果使用虚拟机，则虚拟机数量 = 外部地址池数量 \* n。这里，n 必须大于 2，允许最多一台节点故障。

- n-vip：表示 VIP 的数量。

- n-node：表示单个节点可处理的 VIP 数量。

### 应用示例

如果一家公司有 10 个 VIP，每个可用节点可以处理 5 个 VIP，并且允许一台节点故障，公司应该如何规划外部地址池和可用节点的数量？

**分析**：

需要总共两个外部地址池和四个可用节点。

- 每个可用节点最多可以处理 5 个 VIP，这意味着一个外部地址池可以容纳 5 个 VIP，因此需要两个外部地址池来满足 10 个 VIP。

- 允许一台节点故障意味着每个地址池必须包含一个托管 VIP 的节点和一个备份节点，因此每个外部地址池需要两个可用节点。

## 其他资源

- [创建外部 IP 地址池](../functions/create_metallb.mdx)
- [创建 BGP 对等体](../functions/create_bgppeer.mdx)
