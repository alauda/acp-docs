---
weight: 15
i18n:
  title:
    en: Install
sourceSHA: e0da645183dd9801e1715275a0725aa316ccca526152224f39db4b2af0371a2b
title: Installation
---

# 安装

为了项目人员能在容器平台中完整使用虚拟化功能，平台管理员需分别进行以下操作以准备虚拟化环境。

## 前提条件

- **下载** 与平台架构相对应的 **ACP Virtualization with KubeVirt** 安装包。
- **上传** **ACP Virtualization with KubeVirt** 安装包，使用上架包机制。
- 使用虚拟化功能时，需提前规划并准备网络及存储环境。

  **注意**：

  - 如需通过 IP 直连虚拟机，集群需使用 Kube-OVN Underlay 网络模式。可参考最佳实践 [准备 Kube-OVN Underlay 物理网络](/configure/networking/how_to/kubeovn_underlay_py.mdx)。
  - 推荐使用 TopoLVM 配合 KubeVirt 使用，可提供接近硬件水平的性能。如果对性能要求不高，也可使用 Ceph 分布式存储。

    | 存储产品                     | 说明                                                                                                                                                                    |
    | ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | **TopoLVM**                  | **优点**：相对轻量，性能良好。<br />**缺点**：不能跨节点使用，可靠性较低，无法提供冗余。                                                                                 |
    | **Ceph 分布式存储**         | **优点**：可跨节点使用，高可用，具备冗余。<br />**缺点**：冗余磁盘副本导致利用率较低；性能较差。                                                                         |

  - 使用 TopoLVM 时，如果配置了多个磁盘，请确保启用虚拟化的节点剩余存储空间容量能满足多个磁盘容量总和；否则，虚拟机创建将失败。

  - 使用 Ceph 分布式存储时，请确保存储所在的网络与虚拟机所在的网络能够互通。

## 操作步骤

<Steps>
### 开启节点虚拟化

当自建集群的节点是 **物理机** 时，可以通过开启或关闭节点虚拟化开关，来控制是否允许 Kubernetes 将虚拟机实例（VMI）调度到该节点上。

- 当开关开启时，允许在物理机节点上调度新创建的虚拟机；Windows 物理节点不支持开启虚拟化。

- 当开关关闭时，禁止在物理机节点上调度新创建的虚拟机，但已在该节点上运行的虚拟机不受影响。

#### 操作步骤

1. 进入 **平台管理**。

2. 在左侧导航栏，单击 **集群管理** > **集群**。

3. 单击 ***自建集群名称***。

4. 在 **节点** 页签，单击待设置虚拟化开关的节点右侧的 ⋮ > **开启虚拟化**。

5. 单击 **确认**。

### 部署 Operator

1. 登录，进入 **平台管理** 页面。

2. 点击 **应用商店管理** > **OperatorHub** 进入 **OperatorHub** 页面。

3. 找到 **ACP Virtualization with KubeVirt**，单击 **安装**，进入 **安装 ACP Virtualization with KubeVirt** 页面。

   配置参数：

   | **参数**               | **推荐配置**                                                                                                         |
   | :--------------------- | :------------------------------------------------------------------------------------------------------------------ |
   | **频道**               | 默认频道为 `alpha`。                                                                                                 |
   | **安装模式**           | `集群`：集群下所有命名空间共享一个 Operator 实例进行创建和管理，资源使用更低。                                       |
   | **安装位置**           | 选择 `推荐`，命名空间仅支持 **kubevirt**。                                                                           |
   | **升级策略**           | `手动`：当 Operator Hub 中有新版本时，需要手动确认才能升级 Operator 到最新版本。                                   |

### 创建 HyperConverged 实例

1. 进入 **平台管理**。

2. 在左侧导航栏，单击 **应用商店管理** > **Operators**。

3. 找到 **ACP Virtualization with KubeVirt**，单击进入 **ACP Virtualization with KubeVirt** 详细信息页面。

4. 单击 **所有实例**。

5. 单击 **HyperConverged** 实例卡片上的 **创建实例**。

   **说明**：每个集群中仅需创建一个 **HyperConverged** 实例。

6. 切换到 YAML 视图，仅需将示例中 `spec.storageImport.insecureRegistries` 字段中指定的 **placeholder** 替换为正确的 **虚拟机镜像仓库地址**，例如：`192.168.16.214:60080`，其他参数保持默认即可。

   ```yaml
   spec:
     storageImport:
       insecureRegistries:
       - placeholder
   ```

   替换结果：

   ```yaml
   spec:
     storageImport:
       insecureRegistries:
       - "192.168.16.214:60080"
   ```

7. 单击 **创建**，等待资源列表中自动创建 CDI 和 KubeVirt 类型的实例，当 YAML 中显示的 **status.phase** 为 `deployed`，表示 HyperConverged 实例创建成功。

### 配置虚拟机超售比（可选）

- 在 **集群管理** > **集群** 中配置虚拟机所在集群的超售比。
- 或在 **项目管理** > **命名空间** 中配置虚拟机所在命名空间的超售比。

#### 注意事项

- 虚拟机仅支持 CPU 超售比，推荐配置值在 2 到 4 之间。

- 一旦开启虚拟机的超售比，在创建虚拟机时，容器的请求值（requests）将固定为 **指定的限制值（limits）/ 超售比**，用户通过 YAML 设置的请求值无效。

  例如：假定虚拟机的 CPU 超售比设置为 4，当用户创建虚拟机并指定 CPU 限制值为 4c 时，CPU 请求值为 4c/4 = 1c。

{/* ### 操作步骤

1. 进入 **平台管理**。

2. 在左侧导航栏中，单击 **应用商店管理** > **Operators**。

3. 在 **已部署 Operators** 页签中，单击 **kubevirt-operator**。

4. 单击 **资源实例** 页签，更新 **kubevirt-hyperconverged** 资源实例，切换至 YAML 视图，在 **annotations** 部分添加如下字段：

   ```
   kubevirt.kubevirt.io/jsonpatch: |-
     [
       {
         "op": "add",
         "path": "/spec/configuration/developerConfiguration",
         "value": {"cpuAllocationRatio": 4}  # 本例中 CPU 超售比配置为 4 
       }
     ]
   ```

5. 单击 **更新**。 */}
</Steps>

## 资源配额说明

虚拟机的内存资源配额受限于其所在命名空间的内存资源配额。由于承载虚拟机的 Pod 内存通常大于虚拟机实际可用内存，因此推荐预留 20% 的资源。当命名空间剩余可用资源不足 20% 时，请及时扩容。
