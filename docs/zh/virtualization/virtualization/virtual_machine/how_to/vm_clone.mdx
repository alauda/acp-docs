---
weight: 50
sourceSHA: 7afc258420255df124723ed9d39e35746a58874a28c7694773121d6cdc708349
---

# 虚拟机克隆

虚拟机克隆是指在特定时间点创建虚拟机副本的过程。克隆的虚拟机包含原始虚拟机的所有配置、操作系统、应用程序和数据。

## 前提条件

- 要使用虚拟机克隆功能，其磁盘必须使用支持快照功能的存储类。虚拟机快照会保存虚拟机当前的状态，以便在发生意外故障时可以将虚拟机恢复到该时间点。

- 执行脚本的节点上必须安装 jq 包。jq 是一个轻量级的命令行 JSON 处理工具，用于解析和处理 JSON 数据。

## 操作步骤

**注意**：下述所有操作必须在虚拟机所在集群的主节点上执行。

1. 打开 CLI 工具。

2. 执行以下命令以创建并打开 vm-clone.sh 文件。

   ```bash
   vi vm-clone.sh
   ```

3. 按 `i` 键并将以下内容复制到 vm-clone.sh 文件中。

   ```bash
   #!/bin/bash
    
   vm_clone() {
     NAMESPACE=$1
     VM_NAME=$2
     VM_CLONE_NAME=$3
    
     cat <<EOF | kubectl create -f -
   kind: VirtualMachineClone
   apiVersion: clone.kubevirt.io/v1alpha1
   metadata:
     name: clone-$VM_NAME
     namespace: $NAMESPACE
   spec:
     source:
       apiGroup: kubevirt.io
       kind: VirtualMachine
       name: $VM_NAME
     target:
       apiGroup: kubevirt.io
       kind: VirtualMachine
       name: $VM_CLONE_NAME
     labelFilters:
       - "*"
       - "!ovn.kubernetes.io/*"
     annotationFilters:
       - "*"
       - "!ovn.kubernetes.io/*"
     template:
       labelFilters:
         - "*"
         - "!ovn.kubernetes.io/*"
       annotationFilters:
         - "*"
         - "!ovn.kubernetes.io/*"
   EOF
    
     if [ $? -eq 0 ]; then
       echo "创建 vmclone 资源成功"
     else
       echo "创建 vmclone 资源失败"
       exit 1
     fi
    
     echo "等待 vm 克隆完成"
     while true; do
       phase=$(kubectl -n $NAMESPACE get vmclone clone-$VM_NAME -o jsonpath='{.status.phase}')
       if [ "$phase" == "Succeeded" ]; then
         break
       elif [ "$phase" == "Failed" ]; then
         echo "VirtualMachineClone 资源阶段为失败"
         exit 1
       fi
       sleep 5
     done
     echo "vm 克隆完成"
    
     dvList=$(kubectl -n $NAMESPACE get vm $VM_CLONE_NAME -o jsonpath='{.spec.template.spec.volumes}' | jq . | grep restore- | grep name | awk '{print $2}')
    
     for dv in $dvList; do
       kubectl -n $NAMESPACE label --overwrite dv $(echo $dv | sed 's/"//g') vm.cpaas.io/used-by=$VM_CLONE_NAME
       if [ $? -ne 0 ]; then
         echo "更新 DV 标签失败"
         exit 1
       fi
     done
    
     pvcList=$(kubectl -n $NAMESPACE get vm $VM_CLONE_NAME -o jsonpath='{.spec.template.spec.volumes}' | jq . | grep restore- | grep claimName | awk '{print $2}')
    
     for pvc in $pvcList; do
       kubectl -n $NAMESPACE label --overwrite pvc $(echo $pvc | sed 's/"//g') vm.cpaas.io/used-by=$VM_CLONE_NAME
       if [ $? -ne 0 ]; then
         echo "更新 PVC 标签失败"
         exit 1
       fi
     done
   }
    
   if [ $# -ne 3 ]; then
     echo "错误：参数错误"
     echo "用法：./vm-clone.sh NAMESPACE VM_NAME VM_CLONE_NAME"
     exit 1
   fi
    
   # 执行 vm 克隆
   vm_clone "$1" "$2" "$3"
   ```

4. 按 `shift+:wq` 保存文件。

5. 执行以下命令为 vm-clone.sh 文件增加执行权限。

   ```bash
   chmod +x vm-clone.sh
   ```

6. 执行以下命令以运行脚本文件。\{#clone}

   ```bash
   ./vm-clone.sh <NAMESPACE> <VM_NAME> <VM_CLONE_NAME>
   ```

   参数说明：

   - **NAMESPACE**：指定要克隆的虚拟机的命名空间，用此命名空间替换 \<NAMESPACE> 部分。
   - **VM\_NAME**：指定要克隆的虚拟机的名称，用此名称替换 \<VM\_NAME> 部分。
   - **VM\_CLONE\_NAME**：指定克隆后的虚拟机的名称，用此名称替换 \<VM\_CLONE\_NAME> 部分。

7. 当出现类似以下消息时，表示克隆已完成。

   ```bash
   virtualmachineclone.clone.kubevirt.io/clone-k1 created
   创建 vmclone 资源成功
   等待 vm 克隆完成
   vm 克隆完成
   datavolume.cdi.kubevirt.io/restore-e8ff0e7b-dc7e-4140-aec7-8556cfcf4533-rootfs 已标记
   datavolume.cdi.kubevirt.io/restore-e8ff0e7b-dc7e-4140-aec7-8556cfcf4533-1 已标记
   ```

## 相关操作

### 查看并启动克隆的虚拟机

1. 进入 **平台管理**。

2. 在左侧导航栏中，单击 **虚拟化管理** > **虚拟机镜像**。

3. 可以看到在 [运行脚本](#clone) 步骤中指定名称的克隆虚拟机，克隆后的虚拟机默认状态为 **停止**。

4. 单击此虚拟机的名称，页面将跳转至 Container Platform 的虚拟机详情页面。

5. 单击 **启动**，虚拟机启动成功。
