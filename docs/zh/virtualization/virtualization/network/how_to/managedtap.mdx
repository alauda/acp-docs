# 配置虚拟机使用网络绑定模式来支持 IPv6

网络绑定模式是对虚拟机网络的提供的一种插件扩展机制，平台默认使用一种名为 ManagedTap 的插件来让虚拟机支持 IPv6，该插件能够让虚拟机通过 CNI 的 DHCP Server 来获取 IP，所以只要 CNI 的 DHCP Server 支持 IPv6，虚拟机也能够支持 IPv6。

目前我们使用的 CNI 为 Kube-OVN，而 Kube-OVN 的 DHCP Server 有完整的 IPv6 支持，所以通过 ManagedTap + Kube-OVN，虚拟机将能够很好的支持 IPv6。

## 前置条件

- ACP 版本不低于 v4.0.0。
- CNI 使用 Kube-OVN，且虚拟机子网为 Underlay。


## 操作步骤

<Steps>

### 为虚拟机的子网添加 IPv6 配置

```bash
kubectl edit subnet <subnet-name>
```
在 spec 下添加参数
```yaml
spec:
  enableDHCP: true
  enableIPv6RA: true
  u2oInterconnection: true
```
### 在 UI 上使用网络绑定模式创建虚拟机
    创建虚拟机时，网络模式选择 **网络绑定**。
    
### 通过 VNC 进入虚拟机，配置网卡
    以 centos 为例，编辑 /etc/sysconfig/network-scripts/ifcfg-enp1s0 文件，添加以下配置
    ```bash
    IPV6INIT=yes
    DHCPV6C=yes
    IPV6_AUTOCONF=yes
    ```
    重启 network
    ```bash
    systemctl restart network
    ```

### 配置 IPv6 的默认路由
    如果交换机上配置了RA，就不用手动配置路由，可以通过交换机RA报文学到路由.
    ```bash
    ip r r default via <subnet-v6-gateway>
    ```
</Steps>