---
weight: 20
---

# KubeVirt 基于 ISO 制作 Windows 镜像

平台基于开源组件 KubeVirt 实现的虚拟机方案，本文档使用 KubeVirt 虚拟化技术，通过 ISO 镜像文件来创建一个 Windows 操作系统的镜像。


## 前提条件

* 集群中各组件运行正常。

* 请提前准备 Windows 镜像及 [最新的 virtio-win-tools](https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/)。

* 请提前准备镜像存放仓库。本文档以 build-harbor.example.cn 仓库为例进行介绍，请根据实际环境进行替换。

## 约束与限制


* 在启动 KubeVirt 时，自定义镜像的文件系统大小会影响镜像写入 PVC 中磁盘的速度。如果文件系统过大，可能会导致创建时间过长。

* 建议将 Linux 根分区或 Windows C 盘保持在 100G 以下，以尽量减小初始大小。后续可以通过 cloud-init 进行扩容（对于 Windows 系统需要在创建后自行扩容）。

## 操作步骤

### 创建镜像

将准备好的 Windows 及 virtio-win 的 ISO 镜像制作为 Docker 镜像，并推送至仓库中，本文档以 Windows Server 2019 为例进行介绍。

**将 Windows 的 ISO 镜像制作为 Docker 镜像**

1. 进入 ISO 镜像存放目录，在终端中执行下述命令将 ISO 镜像名称重命名为 win.iso。

    ```
    mv <ISO 镜像名称> win.iso # 需使用实际镜像名称替换 <ISO 镜像名称> 部分，例如：mv en_windows_server_2019_x64_dvd_4cb967d8.iso win.iso
    ```
2. 执行下述命令创建 Dockerfile 文件。

    ```
    touch Dockerfile
    ```
3. 编辑 Dockerfile 文件，添加下述内容后并保存。

    ```
    FROM scratch
    ADD --chown=107:107 win.iso /disk/
    ```
4. 执行下述命令构建 Docker 镜像。

    ```
    docker build -t build-harbor.example.cn/3rdparty/vmdisks/winiso:2019 . # 请根据实际环境替换仓库
    ```
    
5. 执行下述命令将镜像推送至仓库中。

    ```
    docker push  build-harbor.example.cn/3rdparty/vmdisks/winiso:2019 # 请根据实际环境替换仓库
    ```

**将 virtio-win 的 ISO 镜像制作为 Docker 镜像**

1. 进入 ISO 镜像存放目录，在终端中执行下述命令创建 Dockerfile 文件。

    ```
    touch Dockerfile
    ```
3. 编辑 Dockerfile 文件，添加下述内容后并保存。

    ```
    FROM scratch
    ADD --chown=107:107 virtio-win.iso  /disk/
    ```
4. 执行下述命令构建 Docker 镜像。

    ```
    docker build -t build-harbor.example.cn/3rdparty/vmdisks/win-virtio:latest . # 请根据实际环境替换仓库

    ```
    
5. 执行下述命令将镜像推送至仓库中。

    ```
    docker push  build-harbor.example.cn/3rdparty/vmdisks/win-virtio:latest # 请根据实际环境替换仓库

    ```

### 创建虚拟机

1. 进入 **Container Platform**。

1. 在左侧导航栏中，单击 **虚拟化** > **虚拟机**。

2. 单击 **创建虚拟机**。

3. 在表单页面填写 **名称**、**镜像** 等必要参数，具体参数及配置请参考 [创建虚拟机](/virtualization/virtual_machine/functions/create_virtual_machine.mdx)。

4. 切换至 YAML。

4. 将 spec.template.spec.domain.devices.disks 字段下的配置替换为下述内容。

    ```
      domain:
        devices:
          disks:
            - disk:
                bus: virtio
              name: cloudinitdisk
            - bootOrder: 1
              cdrom:
                bus: sata
              name: containerdisk
            - cdrom:
                bus: sata
              name: virtio
            - disk:
                bus: sata
              name: rootfs
              bootOrder: 10
    ```
5. 在 spec.template.spec.volumes 字段下添加下述内容。
    
    ```
            - containerDisk:
                image: registry.example.cn:60070/3rdparty/vmdisks/winiso:2019 # 请根据实际环境替换镜像
              name: containerdisk
            - containerDisk:
                image: registry.example.cn:60070/3rdparty/vmdisks/win-virtio # 请根据实际环境替换镜像
              name: virtio
    ```
    
6. 检查 YAML 文件，配置完成后的完整 YAML 如下。

    ```
    apiVersion: kubevirt.io/v1alpha3
    kind: VirtualMachine
    metadata:
      annotations:
        cpaas.io/creator: test@example.io
        cpaas.io/display-name: ""
        cpaas.io/updated-at: 2024-09-01T14:57:55Z
        kubevirt.io/latest-observed-api-version: v1
        kubevirt.io/storage-observed-api-version: v1
      generation: 16
      labels:
        virtualization.cpaas.io/image-name: debian-2120-x86
        virtualization.cpaas.io/image-os-arch: amd64
        virtualization.cpaas.io/image-os-type: debian
        virtualization.cpaas.io/image-supply-by: public
        vm.cpaas.io/name: aa-test
      name: aa-test
      namespace: acp-service-self
    spec:
      dataVolumeTemplates:
        - metadata:
            creationTimestamp: null
            labels:
              vm.cpaas.io/reclaim-policy: Delete
              vm.cpaas.io/used-by: aa-test
            name: aa-test-rootfs
          spec:
            pvc:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 100Gi
              storageClassName: vm-cephrbd
              volumeMode: Block
            source:
              http:
                url: http://192.168.254.12/kube-debian-12.2.0-x86-out.qcow2
      running: true
      template:
        metadata:
          annotations:
            cpaas.io/creator: test@example.io
            cpaas.io/display-name: ""
            cpaas.io/updated-at: 2024-09-01T14:55:44Z
            kubevirt.io/latest-observed-api-version: v1
            kubevirt.io/storage-observed-api-version: v1
          creationTimestamp: null
          labels:
            virtualization.cpaas.io/image-name: debian-2120-x86
            virtualization.cpaas.io/image-os-arch: amd64
            virtualization.cpaas.io/image-os-type: debian
            virtualization.cpaas.io/image-supply-by: public
            vm.cpaas.io/name: aa-test
        spec:
          affinity:
            nodeAffinity: {}
          architecture: amd64
          domain:
            devices:
              disks:
                - disk:
                    bus: virtio
                  name: cloudinitdisk
                - bootOrder: 1
                  cdrom:
                    bus: sata
                  name: containerdisk
                - cdrom:
                    bus: sata
                  name: virtio
                - disk:
                    bus: sata
                  name: rootfs
                  bootOrder: 10
               interfaces:
                - bridge: {}
                  name: default
            machine:
              type: q35
            resources:
              limits:
                cpu: "4"
                memory: 8Gi
              requests:
                cpu: "4"
                memory: 8Gi
          networks:
            - name: default
              pod: {}
          nodeSelector:
            kubernetes.io/arch: amd64
            vm.cpaas.io/baremetal: "true"
          volumes:
            - cloudInitConfigDrive:
                userData: >-
                  #cloud-config
     
                  disable_root: false
     
                  ssh_pwauth: true
     
                  users:
                    - default
                    - name: root
                      lock_passwd: false
                      hashed_passwd: $6$0vlhl57e$0rawYwaeu9jL6hBf3XP9lk6XXaMUS9/W6LPbWRinUoXujo39lP3l98VOcOObtr.LDoAv/ylm85FLQmxwNlWFe/
              name: cloudinitdisk
            - containerDisk:
                image: registry.example.cn:60070/3rdparty/vmdisks/winiso:2019 # 请根据实际环境替换镜像
              name: containerdisk
              - containerDisk
                 image: registry.example.cn:60070/3rdparty/vmdisks/win-virtio # 请根据实际环境替换镜像
               name: virtio 
             - dataVolume:
                name: aa-test-rootfs
              name: rootfs
    ```
    
7. 单击 **创建**。
8. 单击 **操作** > **VNC 登录**。
9. 当出现 **press any key boot from CD or DVD** 提示信息后，键入任意键，进入 Windows 安装程序；若没有看到提示信息，则单击页面左上角 **发送远程命令**，在弹出的下拉菜单中，单击 **Ctrl-Alt-Delete**，重启服务器。

    **注意**：在虚拟机详情信息页面上方出现 **当前虚拟机有配置变更，需执行重启以使配置生效，请重启** 提示信息时，请忽略此信息，无需重启。
    
### 安装 Windows 操作系统

1. 进入安装页面后，根据安装指引进行安装即可。

    **注意**：选择分区的步骤中，由于 bus 需要为 sata 才能正确识别磁盘，因此需要依次选中每个分区，并逐个单击 **Delete** 删除所有分区，让系统自动处理。

10. 管理员账号密码配置完成后，单击页面左上角 **发送远程命令**，在弹出的下拉菜单中，单击 **Ctrl-Alt-Delete**。
11. 弹出 **Ctrl+Alt+Delete 组合键将重启服务器，确定重启** 的提示信息，单击 **确定**。
12. 输入密码进入 Windows 系统桌面，至此 Windows 操作系统已安装完成。

### 安装 virtio-win-tools

此工具中主要包含了所需的驱动。

1. 打开资源管理器（File Explorer）。

2. 双击打开 **CD Drive(E:) virtio-win-\<version>**，运行目录下的 **virtio-win-guest-tools** 进入安装页面，根据安装指引进行安装即可。其中，\<version> 部分请根据实际情况确定。

12. 安装完成后，将 Windows 系统关机。

### 导出自定义 Windows 镜像

具体操作请参考 [导出虚拟机镜像](./vm_image_export.mdx)。

### 使用 Windows 镜像

1. 进入 **Container Platform**。

1. 在左侧导航栏中，单击 **虚拟化** > **虚拟机**。

2. 单击 **创建虚拟机**。
3. 在表单页面填写必要参数。其中，镜像选择导出的 Windows 镜像，具体详细的参数及配置请参考 [创建虚拟机](/virtualization/virtual_machine/functions/create_virtual_machine.mdx)。
4. （可选）若使用较新的操作系统，例如 windows 11，则需开启 clock、uefi、tpm 等特性。切换至 YAML，使用下述 YAML 文件替换原 YAML文件。
    
    ```
    apiVersion: kubevirt.io/v1
    kind: VirtualMachineInstance
    metadata:
      labels:
        special: vmi-windows
      name: vmi-windows
    spec:
      domain:
        clock:
          timer:
            hpet:
              present: false
            hyperv: {}
            pit:
              tickPolicy: delay
            rtc:
              tickPolicy: catchup
          utc: {}
        cpu:
          cores: 2
        devices:
          disks:
          - disk:
              bus: sata
            name: pvcdisk
          interfaces:
          - masquerade: {}
            model: e1000
            name: default
          tpm: {}
        features:
          acpi: {}
          apic: {}
          hyperv:
            relaxed: {}
            spinlocks:
              spinlocks: 8191
            vapic: {}
          smm: {}
        firmware:
          bootloader:
            efi:
              secureBoot: true
          uuid: 5d307ca9-b3ef-428c-8861-06e72d69f223
        resources:
          requests:
            memory: 4Gi
      networks:
      - name: default
        pod: {}
      terminationGracePeriodSeconds: 0
      volumes:
      - name: pvcdisk
        persistentVolumeClaim:
          claimName: disk-windows
      - name: winiso
        persistentVolumeClaim:
          claimName: win11cd-pvc
    ```

5. 单击 **创建**。

### 添加内部路由\{#service}

通过配置 NodePort 类型的内部路由，将远程桌面连接的端口进行暴露。

1. 进入 **Container Platform**。

1. 在左侧导航栏中，单击 **虚拟化** > **虚拟机**。

2. 单击列表中使用 Windows 镜像创建的虚拟机名称，进入详情信息页面。
3. 单击 **登录信息** 区域中 **内部路由** 右侧的 **添加** 图标。
4. 按照下述说明配置参数。

    |参数|说明|
    |---|---|
    |**类型**|选择 **NodePort**。|
    |**端口**|<ul><li>协议：选择 TCP。</li><li>服务端口：使用 3389。</li><li>虚拟机端口：使用 3389。</li><li>服务端口名称：使用 rdp。</li></ul>|

5. 单击 **确定**，返回详情信息页面。
6. 单击 **登录信息** 区域中 **内部路由** 链接。
7. 保存基本信息区域的 **虚拟 IP** 及端口区域的 **主机端口**。

## 远程访问

本文档以使用 Windows 操作系统进行远程连接为例进行介绍。其他操作系统可以使用支持 rdp 协议的软件进行连接。

1. 打开 **远程桌面连接（Remote Desktop Connection）**。

2. 输入 [添加内部路由](#service) 步骤中保存的虚拟 IP 及主机端口，形式为 **虚拟 IP:主机端口**，例如：192.1.1.1:3389。
3. 单击 **连接**。
