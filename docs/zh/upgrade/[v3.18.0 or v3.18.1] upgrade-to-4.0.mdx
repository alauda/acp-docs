---
weight: 30
sourceSHA: e0dc1d15588cdc23f21c08bafff105c8fad8260c19485a42e50addec434a4624
---

# 关键升级注意事项

- **在将 k8s 从低于 1.31 的版本升级到 1.31 时，所有节点上的 Pods 将会被重启一次。在此过程中，Pods 不会被重建或重新调度，但会发生服务中断。**
- 从 v4.0 开始，为了降低升级灾备环境的复杂性，**在升级灾备环境时，请先升级备用集群**，以避免在升级过程中发生灾备切换。
- 本升级文档适用于将 x86 和 ARM 架构版本 v3.18.0 或 v3.18.1 升级到 v4.0.0 版本。
- 升级前，请确保所有集群已升级到 v3.18.0 或 v3.18.1 版本。k8s 版本必须升级到至少 1.28 版本。
- 升级前，请检查全局集群的组件列表。如果有组件状态异常，请勿升级，除非计划通过升级来解决。
- 如果平台部署了服务网格且存在低于 Istio 1.20 的服务网格，必须在执行平台升级前先升级服务网格。
- 如果注册表使用 MinIO 作为存储后端，并且 MinIO 使用全局集群三台主节点的 /cpaas/minio 目录，请确保这三台节点的 /cpaas/minio 目录剩余空间至少为 120GB。如不足，请扩展容量。
- 安装包将被复制到全局集群的第一台主节点上，解压后将占用最多 120GB 的空间。因此，当安装包和解压目录位于同一磁盘时，磁盘需要有超过 250GB 的可用空间。
- 上传镜像大约需要两个小时，因此请提前计划您的升级时间。
- 如果在升级过程中出现问题，请先查看升级常见问题文档。

# 灾备环境 (DR) 升级过程

## 数据对比

<Directive type="warning" title="警告">
  在升级之前务必执行以下两个步骤。
</Directive>

1. 升级前，请按照维护文档为灾备环境执行数据对比脚本，以确保主全局集群和备全局集群之间没有差异。
2. 在主全局集群和备用全局集群上分别执行以下命令： `kubectl get machines.platform.tkestack.io`，确保返回的主机中没有非运行状态的节点。

## 卸载灾备数据同步程序

1. 使用备用集群的 VIP 访问 **备用集群** 页面
   1.1. 如果无法通过 IP 访问平台页面，请登录 **备用集群** 的 master1 节点并修改 prdb，添加其他平台访问地址：
   ```yaml
   spec:
     alternativeURLs:
     - https://192.168.162.10 # 用实际的备用集群 VIP 替换 IP
   ```
2. 在 **备用集群** 的插件页面，卸载灾备同步程序插件，并等待卸载完成。

## 升级备用集群

1. 请参阅 \[上传平台镜像]\(#Upload Platform Images) 段落，将平台镜像上传到 **备用集群**。
2. 请参阅 \[升级全局集群]\(#Upgrade the global cluster) 段落来升级 **备用集群** 的全局。
3. 等待 **备用集群** 的全局升级完成。
4. 此时，**备用集群** 的升级已完成。

## 升级主集群

1. 请参阅 \[上传平台镜像]\(#Upload Platform Images) 段落，将平台镜像上传到主集群。
2. 请参阅 \[升级全局集群]\(#Upgrade the global cluster) 段落来升级主集群的全局。
3. 等待主集群的全局升级完成。

## 启动同步程序

1. 启动数据同步的 pod。
   1.1. 分别检查主集群和备用集群 VIP 的 2379 端口，确认它们已转发到各自的主节点。
   1.2. 通过 **备用集群** Kubernetes VIP 访问 **备用集群** 平台页面，点击全局集群插件部署页面，然后点击部署 etcd 同步插件。根据页面提示输入参数，其中：
   1.2.1. 数据检查间隔用于生成监控数据，默认值通常可以选择。
   1.2.2. 打印详细日志的开关默认不需要开启，主要用于调试问题。
2. 等待插件部署成功。
3. 登录 **备用集群** 的全局 master1 节点，检查 etcd 同步 pod 是否正常运行。

```shell
kubectl get po -n cpaas-system -l app=etcd-sync # 确保 pod 状态为 1/1 Running

kubectl logs -n cpaas-system $(kubectl get po -n cpaas-system -l app=etcd-sync --no-headers | awk '{print $1}' | head -1) | grep -i "Start Sync update"

# 等待输出返回 "Start Sync update"

# 重新创建其中一个 pod 实例，确保所有依赖 ownerReference 的 k8s 资源都得到同步。
kubectl delete po -n cpaas-system $(kubectl get po -n cpaas-system -l app=etcd-sync --no-headers | awk '{print $1}' | head -1)
```

4. 登录备用集群的全局 master1 节点，检查数据同步是否完成。

```shell
curl "$(kubectl get svc -n cpaas-system etcd-sync-monitor -ojsonpath='{.spec.clusterIP}')/check"

# 输出的含义：
"LOCAL ETCD missed keys:" # 表示主集群具有这些键，但备用集群不具有。这通常是因为当 pod 启动时，由于资源顺序，键在同步后被 k8s 垃圾回收。在这种情况下，重新启动一个 etcd-sync pod 就足够了。

"LOCAL ETCD surplus keys:" # 表示备用集群存在但主集群不存在的键。这些键在备用集群中被视为多余。在删除备用集群中的这些键之前，请与运维人员确认。
```

## \[升级业务集群]\(#Upgrade Business Clusters)

---

# 备份

<Directive type="warning" title="警告">
  第一步必须在所有集群的每个主节点上执行，包括全局集群（主集群和备用集群）、以及所有业务集群。
</Directive>

1. 在所有集群的每个主节点上执行以下命令以备份 etcd。

```shell
tmp_dir="/cpaas/backup_$(date +%Y%m%d%H)"
mkdir -p "${tmp_dir}" && cp -r /etc/kubernetes/ "${tmp_dir}" && cp -r /var/lib/etcd/ "${tmp_dir}"
```

2. 如果 IaaS 条件允许，建议对所有机器进行快照备份。
3. 如果 IaaS 条件允许，建议对 Harbor、Jenkins、GitLab 和 Nexus 等第三方工具使用的外部存储进行快照备份；否则，可能无法回滚。
4. 如果 IaaS 无法对外部存储执行快照备份，则：通过执行命令 `cp -a` 对第三方工具中的数据目录（如 Harbor、GitLab 和 SonarQube）进行复制。

# 上传平台镜像

要上传打包在离线安装程序中的平台镜像，需将离线安装程序解压到全局集群的任一主节点上，然后在该节点执行以下命令：

1. 将工作目录更改为解压出离线安装程序的位置。
2. 如果平台镜像不打算存放在用户提供的外部镜像仓库中，请执行以下命令上传镜像。

```shell
bash upgrade.sh --only-sync-image=true
```

3. 在其他情况下，平台镜像将存放在外部镜像仓库中，请执行以下命令上传镜像。

```shell
bash upgrade.sh --registry <external registry address> --target-creds <external registry credential> --only-sync-image=true

# <external registry credential>: 通过用冒号连接用户名和密码得到的 base64 值
# 例如：
# 外部注册表地址为: registry.docker.com
# 外部注册表地址的用户名为: admin
# 外部注册表地址的密码为: password
registry_address='registry.docker.com'
registry_user='admin'
registry_passwd= 'password'
creds=$(base64 -w 0 <<< "${registry_user}:${registry_passwd}")
# bash upgrade.sh --registry "$registry_address" --target-creds "$creds" --only-sync-image=true
```

# 触发升级

<Directive type="info" title="信息">
  对于灾备集群，在触发升级之前，必须根据“上传镜像”步骤的命令先完成镜像上传。
</Directive>

1. 在全局集群的主节点上（离线安装程序已解压的位置）执行以下命令

```shell
bash upgrade.sh
```

2. 等待升级脚本完成。

# 升级全局集群

1. 访问全局页面，点击平台管理 > 集群管理 > 选择全局集群，选择功能组件，然后点击升级。
2. 升级界面将显示组件升级信息。
3. 阅读信息并确认。

<Directive type="note" title="注意">
  名为 "Kubernetes" 的组件可以不进行升级，但强烈建议在升级 <Term name="productShort" /> 时一起触发 “Kubernetes” 组件的升级。
  由于 <Term name="productShort" /> 的升级也可能导致工作负载中断，避免工作负载中断的正确方式不是不升级 "Kubernetes" 组件。
</Directive>

4. 点击升级。
5. 等待升级完成。

# 升级业务集群

## 注意

1. 必须在升级任何业务集群之前完成 \[升级全局集群]\(#Upgrade the global cluster)。
2. 本升级文档适用于将业务集群从版本 v3.18.0 或 v3.18.1 升级到 v4.0.0，适用于 x86\_64 和 arm64 架构。
3. 升级前，请检查业务集群的组件列表。如果有组件状态异常，请勿继续升级，除非计划通过升级解决问题。
4. 如果集群利用了服务网格功能，请首先参考 \[升级服务网格]\(#Upgrade Service Mesh) 部分，检查当前业务集群的 Kubernetes 版本是否满足 Istio 的升级要求。如果不满足，则需要将 Kubernetes 升级到满足 Istio 升级要求的版本。
5. 服务网格的 Sidecar 升级将执行 Pods 的滚动更新，这可能导致短暂的业务中断，尤其是对于长连接服务。
6. 随着集群升级，现有的 PostgreSQL 实例将会自动重启以进行升级更新，导致更新期间出现短暂的服务中断。
7. 随着集群升级，设置为自动更新策略的 MySQL-PXC、MySQL-MGR、Redis、Kafka 和 RabbitMQ 实例将自动重启以进行升级更新，导致更新期间出现短暂的服务中断。
8. 如果在升级过程中出现问题，请优先查看升级常见问题文档。
9. 最多支持同时升级 20 个业务集群。

## 升级业务集群的功能组件

1. 访问平台管理页面，点击“集群”，选择要升级的业务集群，点击“功能组件”，再点击“升级”。
2. 升级界面将显示组件升级信息。
3. 阅读信息并确认。

<Directive type="note" title="注意">
  名为 "Kubernetes" 的组件可以不进行升级，但强烈建议在升级 <Term name="productShort" /> 时一起触发 “Kubernetes” 组件的升级。
  由于 <Term name="productShort" /> 的升级也可能导致工作负载中断，避免工作负载中断的正确方式不是不升级 "Kubernetes" 组件。
</Directive>

4. 点击升级按钮。
5. 如果当前环境修改了配置设置，点击升级时将出现确认弹窗。请与运维团队联系以验证这些配置是否影响升级。
6. 等待升级完成。

## 升级 DevOps 工具链实例

<Directive type="note" title="注意">
  （如果没有部署 DevOps 工具链则跳过）
</Directive>

1. 访问平台管理 > 工具链管理 > 工具链集成，点击工具链名称。
2. 在集成详情页面，点击实例名称以进入实例详情页面。
3. 如果工具名称右侧出现升级图标，请点击操作 > 升级，并根据客户需求进行工具升级。点击升级信息图标以实时查看实例更新状态。
4. 如果没有升级图标，则表示该工具没有可用的升级版本。请检查其他工具。

## 升级服务网格

<Directive type="note" title="注意">
  （如果未部署服务网格则跳过）
</Directive>

有关升级过程，请参考产品用户手册：平台管理 > 服务网格 > 升级服务网格。

### Istio 升级所需的 Kubernetes 版本

<table>
  <thead>
    <tr>
      <th>升级前的 Istio 版本</th>
      <th>升级后的 Istio 版本</th>
      <th>Istio 主版本升级所需的 Kubernetes 版本</th>
      <th>对应的 ACP 升级场景</th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td>Istio 1.20</td>
      <td>Istio 1.22</td>
      <td>Kubernetes 1.27,1.28,1.29</td>

      <td>
        ACP 3.18 升级至 4.0<br />
        ACP 3.16 升级至 4.0
      </td>
    </tr>
  </tbody>
</table>

# 升级常见问题

目前没有已知问题。
