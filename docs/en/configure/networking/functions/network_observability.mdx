---
weight: 50
---

# Network Observability

## About DeepFlow

### What is DeepFlow

The DeepFlow open-source project aims to provide deep observability for complex cloud-native and AI applications.
DeepFlow implemented Zero Code data collection with eBPF for metrics, distributed tracing,
request logs and function profiling, and is further integrated with SmartEncoding to achieve Full Stack correlation
and efficient access to all observability data. With DeepFlow, cloud-native and AI applications automatically gain deep observability,
removing the heavy burden of developers continually instrumenting code and providing monitoring and diagnostic capabilities covering everything
from code to infrastructure for DevOps/SRE teams.

### Using eBPF Technology

Assuming you have a basic understanding of eBPF, it is a secure and efficient technology for extending kernel functionality
by running programs in a sandbox, a revolutionary innovation compared to traditional methods of modifying kernel source code
and writing kernel modules. eBPF programs are event-driven, and when the kernel or user programs pass through an eBPF Hook,
the corresponding eBPF program loaded at the Hook point will be executed.
The Linux kernel predefines a series of commonly used Hook points,
and you can also dynamically add custom Hook points in the kernel and applications using kprobe and uprobe technologies.
Thanks to Just-in-Time (JIT) technology, the execution efficiency of eBPF code can be comparable to native kernel code and kernel modules.
Thanks to the Verification mechanism, eBPF code will run safely without causing kernel crashes or entering infinite loops.

<img style={{display: "block", marginLeft: "auto", marginRight: "auto"}} src="../assets/deepflow-ebpf.png"/>

### Software Architecture

DeepFlow consists of two components, Agent and Server. An Agent runs in each K8s node, legacy host and cloud host,
and is responsible for AutoMetrics and AutoTracing data collection of all application processes on the host.
Server runs in a K8s cluster and provides Agent management, tag injection, data ingest and query services.

<img style={{display: "block", marginLeft: "auto", marginRight: "auto"}} src="../assets/deepflow-architecture.png"/>

## Install DeepFlow

### Introduction

#### Kernel Requirements

The eBPF capabilities \(AutoTracing, AutoProfiling\) in DeepFlow have the following kernel version requirements:

<table>
  <thead>
    <tr>
      <th>Architecture</th>
      <th>Distribution</th>
      <th>Kernel Version</th>
      <th>kprobe</th>
      <th>Golang uprobe</th>
      <th>OpenSSL uprobe</th>
      <th>perf</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowSpan={7}>X86</td>
      <td>CentOS 7.9</td>
      <td>
        <span>3.10.0</span>
        <span style={{
          color: "#fff",
          backgroundColor: "#06c",
          borderRadius: "50%",
          justifyContent: "center",
          alignItems: "center",
          width: "20px",
          height: "20px",
          marginLeft: "4px",
          display: "inline-flex",
        }}>
          1
        </span>
      </td>
      <td>Y</td>
      <td>
        <span>Y</span>
        <span style={{
          color: "#fff",
          backgroundColor: "#06c",
          borderRadius: "50%",
          justifyContent: "center",
          alignItems: "center",
          width: "20px",
          height: "20px",
          marginLeft: "4px",
          display: "inline-flex",
        }}>
          2
        </span>
      </td>
      <td>
        <span>Y</span>
        <span style={{
          color: "#fff",
          backgroundColor: "#06c",
          borderRadius: "50%",
          justifyContent: "center",
          alignItems: "center",
          width: "20px",
          height: "20px",
          marginLeft: "4px",
          display: "inline-flex",
        }}>
          2
        </span>
      </td>
      <td>Y</td>
    </tr>
    <tr>
      <td>RedHat 7.6</td>
      <td>
        <span>3.10.0</span>
        <span style={{
          color: "#fff",
          backgroundColor: "#06c",
          borderRadius: "50%",
          justifyContent: "center",
          alignItems: "center",
          width: "20px",
          height: "20px",
          marginLeft: "4px",
          display: "inline-flex",
        }}>
          1
        </span>
      </td>
      <td>Y</td>
      <td>
        <span>Y</span>
        <span style={{
          color: "#fff",
          backgroundColor: "#06c",
          borderRadius: "50%",
          justifyContent: "center",
          alignItems: "center",
          width: "20px",
          height: "20px",
          marginLeft: "4px",
          display: "inline-flex",
        }}>
          2
        </span>
      </td>
      <td>
        <span>Y</span>
        <span style={{
          color: "#fff",
          backgroundColor: "#06c",
          borderRadius: "50%",
          justifyContent: "center",
          alignItems: "center",
          width: "20px",
          height: "20px",
          marginLeft: "4px",
          display: "inline-flex",
        }}>
          2
        </span>
      </td>
      <td>Y</td>
    </tr>
    <tr>
      <td rowSpan={5}>*</td>
      <td>4.9-4.13</td>
      <td></td>
      <td></td>
      <td></td>
      <td>Y</td>
    </tr>
    <tr>
      <td>
        <span>
          <span>4.14</span>
          <span style={{
            color: "#fff",
            backgroundColor: "#06c",
            borderRadius: "50%",
            justifyContent: "center",
            alignItems: "center",
            width: "20px",
            height: "20px",
            marginLeft: "4px",
            display: "inline-flex",
          }}>
            3
          </span>
        </span>
      </td>
      <td>Y</td>
      <td>
        <span>Y</span>
        <span style={{
          color: "#fff",
          backgroundColor: "#06c",
          borderRadius: "50%",
          justifyContent: "center",
          alignItems: "center",
          width: "20px",
          height: "20px",
          marginLeft: "4px",
          display: "inline-flex",
        }}>
          2
        </span>
      </td>
      <td></td>
      <td>Y</td>
    </tr>
    <tr>
      <td>4.15</td>
      <td>Y</td>
      <td>
        <span>Y</span>
        <span style={{
          color: "#fff",
          backgroundColor: "#06c",
          borderRadius: "50%",
          justifyContent: "center",
          alignItems: "center",
          width: "20px",
          height: "20px",
          marginLeft: "4px",
          display: "inline-flex",
        }}>
          2
        </span>
      </td>
      <td></td>
      <td>Y</td>
    </tr>
    <tr>
      <td>4.16</td>
      <td>Y</td>
      <td>Y</td>
      <td></td>
      <td>Y</td>
    </tr>
    <tr>
      <td>4.17+</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
    </tr>
    <tr>
      <td rowSpan={5}>ARM</td>
      <td>CentOS 8</td>
      <td>4.18</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
    </tr>
    <tr>
      <td>EulerOS</td>
      <td>5.10+</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
    </tr>
    <tr>
      <td>KylinOS V10 SP2</td>
      <td>4.19.90-25.24+</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
    </tr>
    <tr>
      <td>KylinOS V10 SP3</td>
      <td>4.19.90-52.24+</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
    </tr>
    <tr>
      <td>Other Distributions</td>
      <td>5.8+</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
      <td>Y</td>
    </tr>
  </tbody>
</table>

Additional notes on kernel versions:

<Callouts>

1. CentOS 7.9 and RedHat 7.6 have backported some eBPF capabilities \(opens new window\)into the 3.10 kernel.
  In these two distributions, the detailed kernel versions supported by DeepFlow are as follows \(dependent hook points\):
    - 3.10.0-957.el7.x86_64
    - 3.10.0-1062.el7.x86_64
    - 3.10.0-1127.el7.x86_64
    - 3.10.0-1160.el7.x86_64
2. Golang/OpenSSL processes inside containers are not supported.
3. In kernel version 4.14, a tracepoint cannot be attached by multiple eBPF programs \(e.g., two or more deepflow-agents cannot run simultaneously\), this issue does not exist in other versions

</Callouts>

<Directive type="note" title="NOTE">
RedHat's statement:
> The eBPF in Red Hat Enterprise Linux 7.6 is provided as Tech Preview and
  thus doesn't come with full support and is not suitable for deployment in production.
  It is provided with the primary goal to gain wider exposure, and potentially move to full support in the future.
  eBPF in Red Hat Enterprise Linux 7.6 is enabled only for tracing purposes,
  which allows attaching eBPF programs to probes, tracepoints and perf events.
</Directive>

#### Deployment Topology

<img style={{display: "block", marginLeft: "auto", marginRight: "auto"}} src="../assets/deepflow-deployment-topology.svg"/>

### Preparation

#### Storage Class

We recommend using Persistent Volumes to store MySQL and ClickHouse data to avoid unnecessary maintenance costs.
You can provide a default Storage Class or add the *--set global.storageClass=\<your storageClass\>* parameter
to select a Storage Class for creating PVC.

For more information on storage configuration, please refer to the [Storage documentation](../../storage/).

#### Package

##### Download the DeepFlow package

Visit the Custom Portal to download the DeepFlow package.

If you don't have access to the Custom Portal, contact technical support.

##### Upload the package to the platform

Use the violet tool to publish the package to the platform.

For detailed instructions on using this tool, refer to the [CLI](../../../extend/upload_package/).

### Install

Create an application resource in the *cpaas-system* namespace to deploy DeepFlow. Here is an example manifest:

```yaml
apiVersion: app.k8s.io/v1beta1
kind: Application
metadata:
  name: deepflow
  namespace: cpaas-system
  annotations:
    app.cpaas.io/chart.source: public-charts/deepflow-plugin # [!code callout]
    app.cpaas.io/chart.version: v4.1.0 # [!code callout]
    app.cpaas.io/chart.values: |
      {
        "global": { [!code callout]
          "storageClass": "example-sc"
        },
        "server": {
          "service": {
            "type": "ClusterIP"
          }
        },
        "deepflow-agent": { [!code callout]
          "clusterNAME": "cluster1"
        },
        "grafana": { [!code callout]
          "adminUser": "admin", [!code callout]
          "adminPassword": "password",
          "service": {
            "type": "ClusterIP"
          },
          "grafana.ini": {
            "server": { [!code callout]
              "root_url": "%(protocol)s://%(domain)s/clusters/cluster1/deepflow",
              "serve_from_sub_path": true
            }
          }
        },
        "mysql": {
          "storageConfig": {
            "persistence": { [!code callout]
              "size": "50G"
            }
          }
        },
        "clickhouse": {
          "storageConfig": {
            "persistence": [
              {
                "accessModes": [
                  "ReadWriteOnce"
                ],
                "name": "clickhouse-path", [!code callout]
                "size": "100Gi",
                "storageClass": "{{ .Values.global.storageClass }}"
              },
              {
                "accessModes": [
                  "ReadWriteOnce"
                ],
                "name": "clickhouse-storage-path", [!code callout]
                "size": "200Gi",
                "storageClass": "{{ .Values.global.storageClass }}"
              }
            ]
          }
        }
      }
    cpaas.io/display-name: 'DeepFlow'
  labels:
    sync-from-helmrequest: 'true'
```

<Callouts>

1. Source of the DeepFlow chart. If you want to use a different chart, please contact technical support.
2. Version of the DeepFlow chart. MUST match the version of the DeepFlow package uploaded to the platform.
3. Storage Class used to create Persistent Volumes for MySQL and ClickHouse.
4. Name of the cluster where DeepFlow is deployed.
5. Username of the Grafana web UI. You can change it to your desired username.
6. Password of the Grafana web UI. It's recommended to change it to a secure password.
7. The root URL for Grafana web UI. You can change it to your desired URL.
8. Size of the persistent volume for MySQL. Please adjust it according to your needs.
9. Size of the persistent volume for ClickHouse path. Please adjust it according to your needs.
10. Size of the persistent volume for ClickHouse storage path. Please adjust it according to your needs.

</Callouts>

Wait for the application to be ready:

```bash
kubectl -n cpaas-system wait --for=jsonpath='{.spec.assemblyPhase}'=Succeeded application deepflow
kubectl -n cpaas-system rollout status statefulset deepflow-clickhouse
kubectl -n cpaas-system rollout status deployment deepflow-mysql
kubectl -n cpaas-system rollout status deployment deepflow-server
kubectl -n cpaas-system rollout status deployment deepflow-app
kubectl -n cpaas-system rollout status deployment deepflow-grafana
kubectl -n cpaas-system rollout status daemonset deepflow-agent
```

### Configure Ingress for Grafana web UI

Create an Ingress resource to access the Grafana web UI. Here is an example manifest:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: http
    nginx.ingress.kubernetes.io/enable-cors: "true"
  name: deepflow-grafana
  namespace: cpaas-system
spec:
  ingressClassName: cpaas-system # [!code callout]
  rules:
  - http:
      paths:
      - backend:
          service:
            name: deepflow-grafana
            port:
              number: 80
        path: /clusters/${CLUSTER_NAME}/deepflow($|/)(.*) # [!code callout]
        pathType: ImplementationSpecific
```

<Callouts>

1. Ingress Class name. If you are installing DeepFlow in the global cluster, set it to *global-alb2*.
  You can also set it to your custom Ingress Class name.
2. This path MUST match the root URL configured in the Application resource.

</Callouts>

### Access the Grafana web UI

You can access the Grafana web UI via the URL specified in the Ingress resource, 
and login with the username and password you set in the Application resource.

<Directive type="warning" title="NOTICE">

It's highly recommended to change the password after the first login.

</Directive>

## Additional resources

- [Instant Observability for Cloud & AI Applications](https://deepflow.io/docs/)
- [eBPF - Introduction, Tutorials & Community Resources](https://ebpf.io/)
