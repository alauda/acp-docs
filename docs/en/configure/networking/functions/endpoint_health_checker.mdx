---
weight: 400
---

# Endpoint Health Checker

## Overview

The Endpoint Health Checker is a cluster plugin designed to monitor and manage the health status of service endpoints in ALB + MetalLB environments. It automatically removes unhealthy endpoints from load balancers to ensure traffic is only routed to healthy instances, improving overall service reliability and availability.

## Key Features

- **Automatic Health Monitoring**: Continuously monitors the health status of service endpoints in ALB + MetalLB environments
- **Load Balancer Integration**: Automatically removes unhealthy endpoints from ALB and MetalLB rotation
- **Service Availability**: Ensures traffic is only directed to healthy, available endpoints
- **Rapid Failover**: Reduces endpoint switching time from 40s to 10s during node power outages

## Installation

### Install via Marketplace

1. Navigate to **Administrator** > **Marketplace** > **Cluster Plugins**.

2. Search for "**Alauda Container Platform Endpoint Health Checker**" in the plugin list.

3. Click **Install** to open the installation configuration page.

4. Wait for the plugin status to change to "**Ready**".

## How It Works

### Health Check Mechanism

The Endpoint Health Checker is a dedicated health monitoring component that ensures only healthy endpoints receive traffic in ALB + MetalLB environments. It operates by monitoring service endpoints and automatically managing their availability status.

#### Core Functionality

The Endpoint Health Checker works by:

1. **Service Discovery**: Identifies services and pods configured for health monitoring in ALB + MetalLB environments
2. **Pod Health Monitoring**: Monitors the readiness and liveness probe status of pods backing the service endpoints
3. **Active Health Checks**: Performs active health assessments using configurable criteria:
   - **TCP connectivity checks**: Establishes TCP connections to verify port accessibility
   - **HTTP/HTTPS response validation**: Sends HTTP requests and validates response codes and content
4. **Endpoint Management**: Automatically removes unhealthy endpoints from service endpoint lists to prevent traffic routing to failed instances

#### Health Check Process

The health checking process involves:

- **Probe Integration**: Leverages Kubernetes readiness and liveness probe results as initial health indicators
- **Network Connectivity**: Sends TCP or HTTP packets to target endpoint ports to verify accessibility
- **Response Validation**: Evaluates response status, timing, and content to determine endpoint health
- **Automatic Failover**: Removes unresponsive or failed endpoints from ALB and MetalLB rotation

#### Performance Improvement

- **Previous Method**: Relied on kubelet heartbeat detection with up to 40 seconds delay
- **Current Method**: Active endpoint health checking with 10 second detection and switching time
- **Improvement**: Significantly improves service availability during node failures in ALB + MetalLB environments

#### Activation Methods

Health checking can be activated through two methods:

1. **Pod-level annotation (Recommended)**:

   Add the annotation to the pod template in your Deployment:

   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: alb-pod
     namespace: cpaas-system
   spec:
     replicas: 3
     selector:
       matchLabels:
         app: alb-pod
     template:
       metadata:
         labels:
           app: alb-pod
         annotations:
           endpoint-health-checker.io/enabled: "true"
       spec:
         containers:
           - name: alb-container
             image: your-alb-image:latest
             ports:
               - containerPort: 8080
             livenessProbe:
               tcpSocket:
                 port: 8080
               initialDelaySeconds: 15
               periodSeconds: 10
             readinessProbe:
               tcpSocket:
                 port: 8080
               initialDelaySeconds: 5
               periodSeconds: 5
   ```

2. **Pod-level readinessGates (Legacy)**:

   Configure readinessGates in the pod spec for older versions:

   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: alb-pod-legacy
     namespace: cpaas-system
   spec:
     replicas: 3
     selector:
       matchLabels:
         app: alb-pod-legacy
     template:
       metadata:
         labels:
           app: alb-pod-legacy
       spec:
         readinessGates:
           - conditionType: "endpointHealthCheckSuccess"
         containers:
           - name: alb-container
             image: your-alb-image:latest
             ports:
               - containerPort: 8080
             livenessProbe:
               tcpSocket:
                 port: 8080
               initialDelaySeconds: 15
               periodSeconds: 10
             readinessProbe:
               tcpSocket:
                 port: 8080
               initialDelaySeconds: 5
               periodSeconds: 5
   ```
   
   > **Note**: The readinessGates configuration is from an older version. It's recommended to use the pod annotation `endpoint-health-checker.io/enabled: "true"` for new deployments.

## Uninstallation

To uninstall the Endpoint Health Checker:

1. Navigate to **Administrator** > **Marketplace** > **Cluster Plugins**.

2. Find the installed "**Endpoint Health Checker**" plugin.

3. Click the options menu and select **Uninstall**.

4. Confirm the uninstallation when prompted.
