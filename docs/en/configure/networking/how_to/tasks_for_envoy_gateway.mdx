# Tasks for Envoy Gateway

## Prerequisites
1. [Create EnvoyGatewayCtl](../how_to/install_envoy_gateway_via_envoy_gateway_operator.mdx)
2. [Create Gateway](../functions/configure_gatewayapi_gateway.mdx)
3. [Create Route](../functions/configure_gatewayapi_route.mdx)

## Introduction

When applying configuration changes in the Gateway API, there are three primary approaches available:

1. Direct modification of the HTTP/TCP/UDP Route or `Gateway`.
2. Modification through PolicyAttachment provided by `Gateway Api` and `Envoy Gateway`.
3. Modification on the global configuration level of the `envoy-gateway instance`.

### HTTP/TCP/UDP Route
- [HTTPRoute specification](https://gateway-api.sigs.k8s.io/reference/spec/#httproute)
- [TCPRoute specification](https://gateway-api.sigs.k8s.io/reference/spec/#tcproute)
- [UDPRoute specification](https://gateway-api.sigs.k8s.io/reference/spec/#udproute)

### PolicyAttachment Via TargetRefs

Envoy Gateway provides a rich custom policy mechanism that can be attached to gateway resources through the Gateway API's [PolicyAttachment model](https://gateway-api.sigs.k8s.io/reference/policy-attachment/).

Envoy Gateway policies are divided into multiple types, including security policies, traffic management policies and more. These policies can be applied to different levels of resources, such as Gateway, HTTPRoute, or Service.

The Gateway API's PolicyAttachment mechanism allows users to attach policies to gateway resources in a declarative way. This mechanism is implemented through the `targetRefs` field, which specifies the target resource for policy application. For example, policies can be attached to specific Gateways, HTTPRoutes, or Services.

Policy types supported by Envoy Gateway include:
| Policy Type | Description |
|-------------|-------------|
| [ClientTrafficPolicy](https://gateway.envoyproxy.io/v1.5/api/extension_types/#clienttrafficpolicy) | Configuration related to the client-to-proxy communication path, including parameters such as timeouts, retries, keepalive settings, etc. |
| [BackendTrafficPolicy](https://gateway.envoyproxy.io/v1.5/api/extension_types/#backendtrafficpolicy) | Configuration related to the proxy-to-backend communication path, including parameters such as timeouts, retries, keepalive settings, etc. |
| [SecurityPolicy](https://gateway.envoyproxy.io/v1.5/api/extension_types/#securitypolicy) | Configuration related to security mechanisms and controls, such as authentication and authorization. |

Using the PolicyAttachment mechanism, users can flexibly add, modify, or delete policies without modifying core resource definitions, achieving separation of concerns and better resource management.

### Global Configuration
The configuration related to `envoy-gateway instance` itself or global-level configuration related to all gateways belongs to this `envoy-gateway instance`, such as deployment mode or backend routing.

We recommend using [EnvoyGatewayCtl](./install_envoy_gateway_via_envoy_gateway_operator.mdx#envoygatewayctl) to manage those global configurations.

## Common Tasks For Route Config

| Feature             | CR                                                        | Description                                                                                                                                                                                                     |
| ------------------- | --------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Auth                | envoygateway:SecurityPolicy                               | [Authorization](https://gateway.envoyproxy.io/docs/tasks/security/)                                                                                                                                             |
| CORS                | gatewayapi:HTTPRoute                                      | [Cross-Origin Resource Sharing](https://gateway.envoyproxy.io/docs/tasks/security/cors/)                                                                                                                         |
| Header Modification | gatewayapi:HTTPRoute                                      | [HTTP Header Modification](https://gateway-api.sigs.k8s.io/guides/http-header-modifier/)                                                                                                                        |
| HTTP Redirect       | gatewayapi:HTTPRoute                                      | [HTTP Redirect](https://gateway-api.sigs.k8s.io/guides/http-redirect-rewrite/)                                                                                                                                  |
| L7 Timeout          | gatewayapi:HTTPRoute                                      | [Request Timeouts](https://gateway-api.sigs.k8s.io/api-types/httproute/#timeouts-optional)                                                                                                                      |
| SessionAffinity     | gatewayapi:HTTPRoute                                      | [Session Affinity/Sticky Sessions](https://gateway-api.sigs.k8s.io/reference/spec#sessionpersistence)                                                                                                            |
| L7 Keepalive        | envoygateway:ClientTrafficPolicy                          | [L7 Keepalive Timeout Settings](https://gateway.envoyproxy.io/v1.5/api/extension_types/#httptimeout)                                                                                                            |
| L4 Keepalive        | envoygateway:ClientTrafficPolicy                          | [L4 TCP Keepalive Settings](https://gateway.envoyproxy.io/v1.5/api/extension_types/#tcpkeepalive)                                                                                                               |
| UrlRewrite          | gatewayapi:HTTPRoute                                      | [URL Rewrite](https://gateway-api.sigs.k8s.io/guides/http-redirect-rewrite/)                                                                                                                                    |
| Retry               | gatewayapi:HTTPRoute or envoygateway:BackendTrafficPolicy | [Request Retries Config Via HTTPRoute](https://gateway-api.sigs.k8s.io/reference/spec/#httprouteretry)<br/>[Request Retries Config Via EnvoyGateway](https://gateway.envoyproxy.io/latest/tasks/traffic/retry/) |
| GZip                | envoygateway:BackendTrafficPolicy                         | [HTTP Compression](https://gateway.envoyproxy.io/latest/tasks/traffic/response-compression/)                                                                                                                    |

## Advanced Configuration

### OpenTelemetry(Otel)

Please follow instructions in [OpenTelemetry Integration](https://gateway.envoyproxy.io/docs/tasks/observability/gateway-observability/#enable-open-telemetry-sink-in-envoy-gateway), but use `EnvoyGatewayCtl` to modify the `envoy-gateway-config`.

### How To Attach to Listener Created In Other Namespace \{#attach_to_gateway_create_on_other_ns}

In the Gateway's listener configuration, you need to specify which namespaces are allowed to attach Routes to it.

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: example-gateway
spec:
  listeners:
    - name: http-80
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: All # without limit
    - name: http-81
      protocol: HTTP
      port: 81
      allowedRoutes:
        namespaces:
          from: Same # only allow routes in the same namespace
    - name: http-82
      protocol: HTTP
      port: 82
      allowedRoutes:
        namespaces:
          from: Selector
          selector:
            matchLabels:
              team: frontend # only allow routes in the namespace with label team=frontend
```

Please refer to [Cross-Namespace routing](https://gateway-api.sigs.k8s.io/guides/multiple-ns/) for more details.

### How To Use Cert Created In Other Namespace \{#use_secret_create_on_other_ns}

To use a certificate created in another namespace, you need to create a `ReferenceGrant` in the namespace where the certificate is created. Please follow instructions in [cross-namespace-certificate-references](https://gateway.envoyproxy.io/v1.5/tasks/security/secure-gateways/#cross-namespace-certificate-references) and [referencegrant](https://gateway-api.sigs.k8s.io/api-types/referencegrant/).
:::note
You cannot specify individual `secret` resources; you must allow the entire namespace
:::

### How To Use SSL passthrough \{#ssl_passthrough}

Please follow instructions in

- [tls](https://gateway-api.sigs.k8s.io/guides/tls/)
- [tls-passthrough](https://gateway.envoyproxy.io/docs/tasks/security/tls-passthrough/)

### How To Change SSL Cipher

Please follow instructions in [customize-gateway-tls-parameters](https://gateway.envoyproxy.io/v1.5/tasks/security/secure-gateways/#customize-gateway-tls-parameters)

```bash
cat <<EOF | kubectl apply -f -
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: ClientTrafficPolicy
metadata:
  name: enforce-tls-13
  namespace: default
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: eg
  tls:
    minVersion: "1.3"
EOF
```

the `.spec.tls` in `ClientTrafficPolicy` is [clienttlssettings](https://gateway.envoyproxy.io/v1.5/api/extension_types/#clienttlssettings)

### How To Specify NodePort When Using NodePort Service \{#specify_nodeport}
When using a NodePort service, kubernetes assigns a NodePort port number to each service port. When accessing the service through a node IP, you should use the corresponding NodePort port number rather than the service port.

There are two approaches to handle this:
Manually retrieve the NodePort assignment by following [get nodeport from svc port](../functions/configure_gatewayapi_route.mdx#get_nodeport_from_svc_port)

Manually specify the NodePort in the `EnvoyProxy` configuration instead of letting Kubernetes automatically assign it.

```yaml
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: demo
spec:
  ipFamily: DualStack
  provider:
    kubernetes:
      envoyDeployment:
        container:
          imageRepository: registry.alauda.cn:60080/acp/envoyproxy/envoy
      envoyService:
        patch: # [!code callout]
          type: StrategicMerge
          value:
            spec:
              ports:
              - nodeport: 31888
                port: 80 
        type: NodePort
    type: Kubernetes
```
<Callouts>
  1. Use patch field to patch the generated service resource to specify the NodePort
</Callouts>

:::note 
NodePort can only be within a specific range, typically `30000-32767`. If you want the Gateway listener port and NodePort to be consistent, your listener port must also be within the NodePort range.
:::

### How To Add Pod Annotation in EnvoyGateway
[add pod annotation](../functions/endpoint_health_checker.mdx#add_pod_annotation_in_envoy_gateway)


### How To Set NodeSelector And Tolerations For envoy-gateway-operator
update the `Subscription` resources 
```bash
# example of nodeSelector and tolerations
kubectl patch subscription envoy-gateway-operator  -n envoy-gateway-operator   --type='merge' -p '
{
  "spec": {
    "config": {
      "nodeSelector": {
        "node-role.kubernetes.io/infra": ""
      },
      "tolerations": [
        {
          "effect": "NoSchedule",
          "key": "node-role.kubernetes.io/infra",
          "operator": "Equal",
          "value": "reserved"
        }
      ]
    }
  }
}'
```
### How To Set NodeSelector And Tolerations For envoy-gateway
update the `EnvoyGatewayCtl` resources

```bash
# in default $NAME=cpaas-default and $NS=envoy-gateway-operator
kubectl patch envoygatewayctl $NAME -n $NS --type='merge' -p '
{
  "spec": {
    "deployment": {
      "pod": {
        "nodeSelector": {
          "node-role.kubernetes.io/infra": ""
        },
        "tolerations": [
          {
            "effect": "NoSchedule",
            "key": "node-role.kubernetes.io/infra",
            "operator": "Equal",
            "value": "reserved"
          }
        ]
      }
    }
  }
}'
```

### How To Set NodeSelector And Tolerations For envoy-proxy
update the `EnvoyProxy` resources
```bash
kubectl patch envoyproxy $NAME -n $NS --type='merge' -p '
{
  "spec": {
    "provider": {
      "kubernetes": {
        "envoyDeployment": {
          "pod": {
            "nodeSelector": {
              "node-role.kubernetes.io/infra": ""
            },
            "tolerations": [
              {
                "effect": "NoSchedule",
                "key": "node-role.kubernetes.io/infra",
                "operator": "Equal",
                "value": "reserved"
              }
            ]
          }
        }
      }
    }
  }
}'
```
## More configuration

Please refer to [EnvoyGateway Tasks](https://gateway.envoyproxy.io/v1.5/tasks)
