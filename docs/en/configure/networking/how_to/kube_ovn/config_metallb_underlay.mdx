# Kube-OVN Underlay + MetalLB LoadBalancer Service é…ç½®

---

## æ–¹æ¡ˆè¯´æ˜

è¯¥æ–¹æ¡ˆä¸»è¦ä¸ºäº†è§£å†³ MetalLB L2 æ¨¡å¼ä¸‹å’Œ Kube-OVN Underlay é€‚é…çš„åœºæ™¯ã€‚å¯ä»¥è®©ç”¨æˆ·ä½¿ç”¨ Underlay å­ç½‘ä¸‹çš„ IP ä½œä¸º MetalLB çš„ LoadBalancer Service çš„ VIPï¼Œå°†æµé‡ç›´æ¥è½¬å‘åˆ°åç«¯ Podã€‚

### æµé‡è·¯å¾„

è®¿é—® LB Service IP çš„æµé‡ä¼šç›´æ¥èµ° Underlay ç½‘ç»œåˆ°ä¸šåŠ¡ Pod

**æµé‡ç¤ºæ„å›¾**ï¼š
```mermaid
flowchart TB
    Client["ğŸ’» å®¢æˆ·ç«¯"]
    VIP["ğŸ”€ è®¿é—® underlay å­ç½‘çš„ VIP<br/>10.180.208.200"]
    Interface["underlay0.341"]
    BrProvider["br-provider"]
    LogicalSwitch["underlay<br/>logical<br/>switch"]
    BackendPod["backendpod(1...N)"]

    Client -->|"è®¿é—® underlay å­ç½‘çš„ VIP"| VIP
    VIP --> Interface
    Interface --> BrProvider
    BrProvider --> LogicalSwitch
    LogicalSwitch -->|"ç›´æ¥ DNAT åˆ°åç«¯ Pod IP"| BackendPod

    subgraph Node["èŠ‚ç‚¹1"]
        BackendPod
        LogicalSwitch
        BrProvider
        Interface
    end

    style Node fill:#f5f5f5,stroke:#333,stroke-width:2px
    style VIP fill:#e1f5ff,stroke:#0066cc
    style LogicalSwitch fill:#fff3cd,stroke:#856404
    style BackendPod fill:#d4edda,stroke:#155724
```

---

## é…ç½®æ­¥éª¤

### 1. é…ç½® ProviderNetwork å¯ç”¨ VLAN å­ç½‘å¡

**æ³¨æ„**ï¼šå¿…é¡»ä½¿ç”¨ VLAN å­ç½‘å¡ã€‚

ä¸º Kube-OVN çš„ Underlay ç½‘ç»œé…ç½®è‡ªåŠ¨åˆ›å»º VLAN å­æ¥å£ï¼š
```yaml
apiVersion: kubeovn.io/v1
kind: ProviderNetwork
metadata:
  name: provider
spec:
  defaultInterface: underlay0.341
  autoCreateVlanSubinterfaces: true

---
apiVersion: kubeovn.io/v1
kind: Vlan
metadata:
  name: ovn-vlan
spec:
  id: 0    # id å…¨éƒ¨æ”¹ä¸º0ï¼Œå› ä¸ºvlanå­ç½‘å¡ä¼šè‡ªåŠ¨æ‰“ä¸Štag
  provider: provider
status:
  subnets:
  - ovn-default
```

### 2. ä¿®æ”¹ kube-ovn-controller å‚æ•°

è°ƒæ•´ `kube-ovn-controller` çš„å¯åŠ¨å‚æ•°ï¼Œå¯ç”¨å¿…è¦çš„ç‰¹æ€§ï¼š

```bash
--ls-ct-skip-dst-lport-ips=false        # ä¸å…è®¸è·³è¿‡ conntrack
--enable-ovn-lb-prefer-local=true       # å¯ç”¨æœ¬åœ°ä¼˜å…ˆçš„è´Ÿè½½å‡è¡¡
```

### 3. é…ç½® Underlay å­ç½‘çš„å¤–éƒ¨åœ°å€åŠŸèƒ½

ç¼–è¾‘ Underlay å­ç½‘ï¼Œé¢„ç•™ä¸€æ®µ IP åœ°å€ä¾› LoadBalancer ä½¿ç”¨ï¼š

> **é‡è¦**ï¼šå¤–éƒ¨åœ°å€æ± çš„ IP å¿…é¡»åœ¨ Underlay çš„å­ç½‘ä¸‹ã€‚

ä¿®æ”¹ Underlay å­ç½‘å‚æ•° `spec.enableExternalLBAddress: true`ï¼š
```yaml
apiVersion: kubeovn.io/v1
kind: Subnet
metadata:
  name: underlay-subnet
spec:
  enableExternalLBAddress: true       # å¯ç”¨å¤–éƒ¨ LB åœ°å€åŠŸèƒ½
```

### 4. åˆ›å»º MetalLB å¤–éƒ¨åœ°å€æ± 

```yaml
# underlay-ippool.yaml
kind: IPAddressPool
apiVersion: metallb.io/v1beta1
metadata:
  name: underlay-lb-pool
  namespace: metallb-system
spec:
  addresses:
    - 10.180.208.200-10.180.208.250  # Underlay å­ç½‘ IP èŒƒå›´
  avoidBuggyIPs: true
---
kind: L2Advertisement
apiVersion: metallb.io/v1beta1
metadata:
  name: underlay-lb-pool
  namespace: metallb-system
spec:
  ipAddressPools:
    - underlay-lb-pool
```

éƒ¨ç½²åœ°å€æ± ï¼š
```shell
kubectl apply -f underlay-ippool.yaml
```

### åˆ›å»º LoadBalancer Service

```yaml
# application-with-loadbalancer.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
        - name: backend
          image: nginx:1.25
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: backend-lb-service
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local  # ä¿æŒæº IPï¼Œç›´æ¥è·¯ç”±åˆ° Pod
  selector:
    app: backend
  ports:
    - port: 80
      targetPort: 80
```

éƒ¨ç½²åº”ç”¨ï¼š
```shell
kubectl apply -f application-with-loadbalancer.yaml
```

### éªŒè¯é…ç½®

æ£€æŸ¥ Service çŠ¶æ€ï¼š
```shell
kubectl get svc backend-lb-service
```

æœŸæœ›è¾“å‡ºï¼š
```shell
NAME                TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)        AGE
backend-lb-service   LoadBalancer   10.96.123.45    10.180.208.200   80:30005/TCP   30s
```

æµ‹è¯•å¤–éƒ¨è®¿é—®ï¼š
```shell
curl http://10.180.208.200
```

### é…ç½®è¦ç‚¹

- **externalTrafficPolicy: Local**: ç¡®ä¿æº IP ä¿æŒå’Œç›´æ¥ Pod è·¯ç”±
- **åœ°å€æ± **: IP å¿…é¡»åœ¨ Underlay å­ç½‘èŒƒå›´å†…
- **enableExternalLBAddress**: å¿…é¡»åœ¨ Underlay å­ç½‘ä¸Šå¯ç”¨æ­¤åŠŸèƒ½
- **èŠ‚ç‚¹é€‰æ‹©**: ç¡®ä¿é€‰æ‹©çš„èŠ‚ç‚¹å…·æœ‰ Underlay ç½‘ç»œè¿æ¥

### 5. éªŒè¯é…ç½®

æ£€æŸ¥ Service çŠ¶æ€ï¼š
```shell
kubectl get svc backend-lb-service
```

æœŸæœ›è¾“å‡ºï¼š
```shell
NAME                TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)        AGE
backend-lb-service   LoadBalancer   10.96.123.45    10.180.208.200   80:30005/TCP   30s
```

æµ‹è¯•å¤–éƒ¨è®¿é—®ï¼š
```shell
curl http://10.180.208.200
```

### é…ç½®è¦ç‚¹

- **externalTrafficPolicy: Local**: ç¡®ä¿æº IP ä¿æŒå’Œç›´æ¥ Pod è·¯ç”±
- **åœ°å€æ± **: IP å¿…é¡»åœ¨ Underlay å­ç½‘èŒƒå›´å†…
- **enableExternalLBAddress**: å¿…é¡»åœ¨ Underlay å­ç½‘ä¸Šå¯ç”¨æ­¤åŠŸèƒ½
- **èŠ‚ç‚¹é€‰æ‹©**: ç¡®ä¿é€‰æ‹©çš„èŠ‚ç‚¹å…·æœ‰ Underlay ç½‘ç»œè¿æ¥

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šé…ç½®æ­¥éª¤ï¼Œå¯ä»¥å®ç°ï¼š
1. æµé‡ç›´æ¥èµ° Underlay ç½‘ç»œï¼Œé¿å…ç»•è·¯ç®¡ç†ç½‘ç»œ
2. ä½¿ç”¨æ ‡å‡†çš„ LoadBalancer Service ç›´æ¥æš´éœ²æœåŠ¡
3. ä¿æŒæº IP åœ°å€ï¼Œå®ç°ç›´æ¥ Pod è·¯ç”±
4. ç®€åŒ–ç½‘ç»œæ¶æ„ï¼Œæå‡æ€§èƒ½