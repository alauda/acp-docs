---
weight: 30
i18n:
  title:
    en: Node Preprocessing
---

# Node Preprocessing

在安装管理集群前，所有节点（控制节点及计算节点）必须完成预处理工作。


## 执行快速配置脚本

<ProductShortBrand /> 安装包中提供了快速配置节点的脚本。

解压安装包，获取 `res` 目录下的 `init.sh` 脚本文件。将脚本文件复制到节点上，并确保具备 `root` 权限。

执行脚本：

```bash
bash init.sh
```

**注意：** `init.sh` 不能保证以下的所有检查项都得到妥善处理，您仍然需要继续下述步骤。

## 节点检查

下文列出了所有必须在节点上完成的检查项。根据节点角色的不同，所需检查项也会有所差异，例如部分检查项仅适用于控制节点。

检查项分为两类：

- ✅ 表示必须通过的检查项。
- ⚠️ 表示在特定场景下必须满足的检查项。请根据说明判断是否符合相应条件，若符合则必须解决。

以下为检查项列表：

- **操作系统与内核**
  - ✅ 机器的 grub 启动配置必须有 `transparent_hugepage=never` 参数。
  - ✅ CentOS 7.x 系统机器的 grub 启动配置必须有 `cgroup.memory=nokmem` 参数。
  - ✅ 检查内核模块 `ip_vs`、`ip_vs_rr`、`ip_vs_wrr`、`ip_vs_sh` 是否已开启。
  - ⚠️ 内核版本低于 4.19.0（或 RHEL 低于 4.18.0）时，检查内核模块 `nf_conntrack_ipv4` 与（IPv6 时）`nf_conntrack_ipv6` 已开启。
  - ⚠️ 如果管理集群计划使用 `Kube-OVN` CNI 则必须开启内核模块 `geneve`、`openvswitch`。
  - ✅ 关闭 apparmor/selinux 以及防火墙。
  - ✅ swap 必须关闭。

- **用户与权限**
  - ✅ 节点的 SSH 用户具备 `root` 权限，并可无密码使用 `sudo`。
  - ✅ `/etc/ssh/sshd_config` 中 `UseDNS` 和 `UsePAM` 参数必须设置为 `no`。
  - ✅ 执行 `systemctl show --property=DefaultTasksMax` 返回 `infinity` 或极大数值；否则调整 `/etc/systemd/system.conf`。

- **节点网络**
  - ✅ `hostname` 必须符合以下规则：
    - 不超过36个字符。
    - 以字母或数字开头和结尾。
    - 仅包含小写字母、数字、`-` 和 `.`，但不能包含 `.-`、`..` 或 `-.`。
  - ✅ `/etc/hosts` 中 `localhost` 必须解析为 `127.0.0.1`。
  - ✅ `/etc/resolv.conf` 文件必须存在，且包含 `nameserver` 配置，但不得包含 172 开头的地址（禁用 systemd-resolved）。
  - ⚠️ `/etc/resolv.conf` 文件中不应配置 search 域（如必须配置，请参阅[配置 search 域](#config_search)）。
  - ✅ 机器的 IP 地址不能是回环、组播、链路本地、全0或广播地址。
  - ✅ 执行 `ip route` 返回必须有默认路由或指向 `0.0.0.0` 的路由。
  - ✅ 管理集群各节点不得占用以下端口：
    - **控制节点：** `2379`、`2380`、`6443`、`10249-10256`
    - **安装器所在节点：** `8080`、`12080`、`12443`、`16443`、`2379`、`2380`、`6443`、`10249-10256`
    - **计算节点：** `10249` ~ `10256`
  - ✅ 管理集群使用 **Kube-OVN** 或 **Calico**，需确保以下端口未被占用：
    - **Kube-OVN：** `6641`、`6642`
    - **Calico：** `179`
  - ⚠️ 确保 Docker 所需网段 `172.16.x.x` ~ `172.32.x.x` 的 IP 未被占用。若该网段的 IP 已被占用且无法更改，请联系技术支持。

- **软件与目录要求：**
  - ✅ 必须已安装：`ip`、`ss`、`tar`、`swapoff`、`modprobe`、`sysctl`、`md5sum`，以及 `scp` 或 `sftp`。
  - ⚠️ 如果计划使用本地存储 **TopoLVM** 或 **Rook**，需安装 `lvm2`。
  - ✅ 不允许存在 `/etc/systemd/system/kubelet.service` 文件。
  - ✅ 下列文件若存在则必须删除：
    - `/var/lib/docker`
    - `/var/lib/containerd`
    - `/var/log/pods`
    - `/var/lib/kubelet/pki`
  - ✅ 检查 `/var/lib` 可用空间是否充足。
  - ✅ `/tmp` 的挂载参数中不得含 `noexec`。
  - ✅ 移除可能与管理集群组件冲突的软件包（详见 [移除冲突软件包](#remove_conflicting_packages)）。

- **跨节点检查项**
  - ✅ 管理集群内各节点之间必须无网络防火墙限制。
  - ✅ 集群内各节点的 `hostname` 必须唯一。
  - ✅ 所有节点的时区必须统一，且时间同步误差 ≤ 10 秒。

## 附录

### 移除冲突软件包 \{#remove_conflicting_packages}

在安装之前，节点上可能已有业务在 docker/containerd 环境中运行，或已经安装了与管理集群冲突的软件。因此需要检查并卸载冲突的软件包。

<Directive type="danger" title="DANGER">
- 为避免业务中断或数据丢失，请务必先确认是否存在冲突软件。在发现冲突时，请提前制定业务切换方案并做好数据备份，然后再进行卸载操作。
- 卸载冲突软件包后，仍需检查 `/usr/local/bin/` 等目录中是否存在其他可能引起冲突的二进制文件（例如与 docker、containerd、runc、podman、容器网络、容器运行时或 Kubernetes 相关的软件）。
</Directive>

以下命令可供参考使用。

<Tabs>
  <Tab label="CentOS / RedHat">
  **检查：**
  ```bash
  for x in \
      docker docker-client docker-common docker-latest \
      podman-docker podman \
      runc \
      containernetworking-plugins \
      apptainer \
      kubernetes kubernetes-master kubernetes-node kubernetes-client \
      ; do
      rpm -qa | grep -F "$x"
  done
  ```

  **卸载：**
  ```bash
  for x in \
      docker docker-client docker-common docker-latest \
      podman-docker podman \
      runc \
      containernetworking-plugins \
      apptainer \
      kubernetes kubernetes-master kubernetes-node kubernetes-client \
      ; do
      yum remove "$x"
  done
  ```
  </Tab>

  <Tab label="Ubuntu">
  **检查：**
  ```bash
  for x in \
      docker.io \
      podman-docker \
      containerd \
      rootlesskit \
      rkt \
      containernetworking-plugins \
      kubernetes \
      ; do
      dpkg-query -l | grep -F "$x"
  done

  for x in \
      kubernetes-worker \
      kubectl kube-proxy kube-scheduler kube-controller-manager kube-apiserver \
      k8s microk8s \
      kubeadm kubelet \
      ; do
      snap list | grep -F "$x"
  done
  ```

  **卸载：**
  ```bash
  for x in \
      docker.io \
      podman-docker \
      containerd \
      rootlesskit \
      rkt \
      containernetworking-plugins \
      kubernetes \
      ; do
      apt-get purge "$x"
  done

  for x in \
      kubernetes-worker \
      kubectl kube-proxy kube-scheduler kube-controller-manager kube-apiserver \
      k8s microk8s \
      kubeadm kubelet \
      ; do
      snap remove --purge "$x"
  done
  ```
  </Tab>

  <Tab label="Kylin">
  **检查：**
  ```bash
  for x in \
      docker docker-client docker-common \
      docker-engine docker-proxy docker-runc \
      podman-docker podman \
      containernetworking-plugins \
      apptainer \
      containerd \
      kubernetes kubernetes-master kubernetes-node kubernetes-client kubernetes-kubeadm \
      ; do
      rpm -qa | grep -F "$x"
  done
  ```

  **卸载：**
  ```bash
  for x in \
      docker docker-client docker-common \
      docker-engine docker-proxy docker-runc \
      podman-docker podman \
      containernetworking-plugins \
      apptainer \
      containerd \
      kubernetes kubernetes-master kubernetes-node kubernetes-client kubernetes-kubeadm \
      ; do
      yum remove "$x"
  done
  ```
  </Tab>
</Tabs>

### 配置 Search 域 \{#config_search}

在 `/etc/resolv.conf` 文件中，`search` 行指定 DNS 查询搜索路径，其配置要求如下：

- **域名数量**：`search` 行中的域名数量应小于 `domainCountLimit - 3`（默认 `domainCountLimit` 为 32）。
- **总字符长度**：所有域名及空格总字符数不得超过 `MaxDNSSearchListChar`（通常为 2048）。
- **单个域名长度**：每个域名不得超过 253 个字符。

如不符合要求，可能导致 DNS 查询失败或性能下降。
